<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › wusbcore › cbaf.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cbaf.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Wireless USB - Cable Based Association</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Intel Corporation</span>
<span class="cm"> * Inaky Perez-Gonzalez &lt;inaky.perez-gonzalez@intel.com&gt;</span>
<span class="cm"> * Copyright (C) 2008 Cambridge Silicon Radio Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version</span>
<span class="cm"> * 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * WUSB devices have to be paired (associated in WUSB lingo) so</span>
<span class="cm"> * that they can connect to the system.</span>
<span class="cm"> *</span>
<span class="cm"> * One way of pairing is using CBA-Cable Based Association. First</span>
<span class="cm"> * time you plug the device with a cable, association is done between</span>
<span class="cm"> * host and device and subsequent times, you can connect wirelessly</span>
<span class="cm"> * without having to associate again. That&#39;s the idea.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver does nothing Earth shattering. It just provides an</span>
<span class="cm"> * interface to chat with the wire-connected device so we can get a</span>
<span class="cm"> * CDID (device ID) that might have been previously associated to a</span>
<span class="cm"> * CHID (host ID) and to set up a new &lt;CHID,CDID,CK&gt; triplet</span>
<span class="cm"> * (connection context), with the CK being the secret, or connection</span>
<span class="cm"> * key. This is the pairing data.</span>
<span class="cm"> *</span>
<span class="cm"> * When a device with the CBA capability connects, the probe routine</span>
<span class="cm"> * just creates a bunch of sysfs files that a user space enumeration</span>
<span class="cm"> * manager uses to allow it to connect wirelessly to the system or not.</span>
<span class="cm"> *</span>
<span class="cm"> * The process goes like this:</span>
<span class="cm"> *</span>
<span class="cm"> * 1. Device plugs, cbaf is loaded, notifications happen.</span>
<span class="cm"> *</span>
<span class="cm"> * 2. The connection manager (CM) sees a device with CBAF capability</span>
<span class="cm"> *    (the wusb_chid etc. files in /sys/devices/blah/OURDEVICE).</span>
<span class="cm"> *</span>
<span class="cm"> * 3. The CM writes the host name, supported band groups, and the CHID</span>
<span class="cm"> *    (host ID) into the wusb_host_name, wusb_host_band_groups and</span>
<span class="cm"> *    wusb_chid files. These get sent to the device and the CDID (if</span>
<span class="cm"> *    any) for this host is requested.</span>
<span class="cm"> *</span>
<span class="cm"> * 4. The CM can verify that the device&#39;s supported band groups</span>
<span class="cm"> *    (wusb_device_band_groups) are compatible with the host.</span>
<span class="cm"> *</span>
<span class="cm"> * 5. The CM reads the wusb_cdid file.</span>
<span class="cm"> *</span>
<span class="cm"> * 6. The CM looks up its database</span>
<span class="cm"> *</span>
<span class="cm"> * 6.1 If it has a matching CHID,CDID entry, the device has been</span>
<span class="cm"> *     authorized before (paired) and nothing further needs to be</span>
<span class="cm"> *     done.</span>
<span class="cm"> *</span>
<span class="cm"> * 6.2 If the CDID is zero (or the CM doesn&#39;t find a matching CDID in</span>
<span class="cm"> *     its database), the device is assumed to be not known.  The CM</span>
<span class="cm"> *     may associate the host with device by: writing a randomly</span>
<span class="cm"> *     generated CDID to wusb_cdid and then a random CK to wusb_ck</span>
<span class="cm"> *     (this uploads the new CC to the device).</span>
<span class="cm"> *</span>
<span class="cm"> *     CMD may choose to prompt the user before associating with a new</span>
<span class="cm"> *     device.</span>
<span class="cm"> *</span>
<span class="cm"> * 7. Device is unplugged.</span>
<span class="cm"> *</span>
<span class="cm"> * When the device tries to connect wirelessly, it will present its</span>
<span class="cm"> * CDID to the WUSB host controller.  The CM will query the</span>
<span class="cm"> * database. If the CHID/CDID pair found, it will (with a 4-way</span>
<span class="cm"> * handshake) challenge the device to demonstrate it has the CK secret</span>
<span class="cm"> * key (from our database) without actually exchanging it. Once</span>
<span class="cm"> * satisfied, crypto keys are derived from the CK, the device is</span>
<span class="cm"> * connected and all communication is encrypted.</span>
<span class="cm"> *</span>
<span class="cm"> * References:</span>
<span class="cm"> *   [WUSB-AM] Association Models Supplement to the Certified Wireless</span>
<span class="cm"> *             Universal Serial Bus Specification, version 1.0.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/uwb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/wusb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/association.h&gt;</span>

<span class="cp">#define CBA_NAME_LEN 0x40 </span><span class="cm">/* [WUSB-AM] table 4-7 */</span><span class="cp"></span>

<span class="cm">/* An instance of a Cable-Based-Association-Framework device */</span>
<span class="k">struct</span> <span class="n">cbaf</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">usb_iface</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">buffer_size</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">wusb_ckhdid</span> <span class="n">chid</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">host_name</span><span class="p">[</span><span class="n">CBA_NAME_LEN</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">host_band_groups</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">wusb_ckhdid</span> <span class="n">cdid</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">device_name</span><span class="p">[</span><span class="n">CBA_NAME_LEN</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">device_band_groups</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">wusb_ckhdid</span> <span class="n">ck</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Verify that a CBAF USB-interface has what we need</span>
<span class="cm"> *</span>
<span class="cm"> * According to [WUSB-AM], CBA devices should provide at least two</span>
<span class="cm"> * interfaces:</span>
<span class="cm"> *  - RETRIEVE_HOST_INFO</span>
<span class="cm"> *  - ASSOCIATE</span>
<span class="cm"> *</span>
<span class="cm"> * If the device doesn&#39;t provide these interfaces, we do not know how</span>
<span class="cm"> * to deal with it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbaf_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wusb_cbaf_assoc_info</span> <span class="o">*</span><span class="n">assoc_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wusb_cbaf_assoc_request</span> <span class="o">*</span><span class="n">assoc_request</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">assoc_size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">itr</span><span class="p">,</span> <span class="o">*</span><span class="n">top</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ar_rhi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ar_assoc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span>
		<span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">CBAF_REQ_GET_ASSOCIATION_INFORMATION</span><span class="p">,</span>
		<span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span>
		<span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">,</span> <span class="mi">1000</span> <span class="cm">/* FIXME: arbitrary */</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot get available association types: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">result</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">assoc_info</span> <span class="o">=</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">assoc_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not enough data to decode association info &quot;</span>
			<span class="s">&quot;header (%zu vs %zu bytes required)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">result</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">assoc_info</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">assoc_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">assoc_info</span><span class="o">-&gt;</span><span class="n">Length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="n">assoc_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not enough data to decode association info &quot;</span>
			<span class="s">&quot;(%zu vs %zu bytes required)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">assoc_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">assoc_info</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * From now on, we just verify, but won&#39;t error out unless we</span>
<span class="cm">	 * don&#39;t find the AR_TYPE_WUSB_{RETRIEVE_HOST_INFO,ASSOCIATE}</span>
<span class="cm">	 * types.</span>
<span class="cm">	 */</span>
	<span class="n">itr</span> <span class="o">=</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">assoc_info</span><span class="p">);</span>
	<span class="n">top</span> <span class="o">=</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">assoc_size</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Found %u association requests (%zu bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">assoc_info</span><span class="o">-&gt;</span><span class="n">NumAssociationRequests</span><span class="p">,</span> <span class="n">assoc_size</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">itr</span> <span class="o">&lt;</span> <span class="n">top</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ar_type</span><span class="p">,</span> <span class="n">ar_subtype</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">ar_size</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ar_name</span><span class="p">;</span>

		<span class="n">assoc_request</span> <span class="o">=</span> <span class="n">itr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">top</span> <span class="o">-</span> <span class="n">itr</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">assoc_request</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not enough data to decode associaton &quot;</span>
				<span class="s">&quot;request (%zu vs %zu bytes needed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">top</span> <span class="o">-</span> <span class="n">itr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">assoc_request</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ar_type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">assoc_request</span><span class="o">-&gt;</span><span class="n">AssociationTypeId</span><span class="p">);</span>
		<span class="n">ar_subtype</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">assoc_request</span><span class="o">-&gt;</span><span class="n">AssociationSubTypeId</span><span class="p">);</span>
		<span class="n">ar_size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">assoc_request</span><span class="o">-&gt;</span><span class="n">AssociationTypeInfoSize</span><span class="p">);</span>
		<span class="n">ar_name</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ar_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AR_TYPE_WUSB</span>:
			<span class="cm">/* Verify we have what is mandated by [WUSB-AM]. */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ar_subtype</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">AR_TYPE_WUSB_RETRIEVE_HOST_INFO</span>:
				<span class="n">ar_name</span> <span class="o">=</span> <span class="s">&quot;RETRIEVE_HOST_INFO&quot;</span><span class="p">;</span>
				<span class="n">ar_rhi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AR_TYPE_WUSB_ASSOCIATE</span>:
				<span class="cm">/* send assoc data */</span>
				<span class="n">ar_name</span> <span class="o">=</span> <span class="s">&quot;ASSOCIATE&quot;</span><span class="p">;</span>
				<span class="n">ar_assoc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">};</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Association request #%02u: 0x%04x/%04x &quot;</span>
			 <span class="s">&quot;(%zu bytes): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">assoc_request</span><span class="o">-&gt;</span><span class="n">AssociationDataIndex</span><span class="p">,</span> <span class="n">ar_type</span><span class="p">,</span>
			 <span class="n">ar_subtype</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">ar_size</span><span class="p">,</span> <span class="n">ar_name</span><span class="p">);</span>

		<span class="n">itr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">assoc_request</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar_rhi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Missing RETRIEVE_HOST_INFO association &quot;</span>
			<span class="s">&quot;request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar_assoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Missing ASSOCIATE association request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">wusb_cbaf_host_info</span> <span class="n">cbaf_host_info_defaults</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">AssociationTypeId_hdr</span>    <span class="o">=</span> <span class="n">WUSB_AR_AssociationTypeId</span><span class="p">,</span>
	<span class="p">.</span><span class="n">AssociationTypeId</span>    	  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR_TYPE_WUSB</span><span class="p">),</span>
	<span class="p">.</span><span class="n">AssociationSubTypeId_hdr</span> <span class="o">=</span> <span class="n">WUSB_AR_AssociationSubTypeId</span><span class="p">,</span>
	<span class="p">.</span><span class="n">AssociationSubTypeId</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR_TYPE_WUSB_RETRIEVE_HOST_INFO</span><span class="p">),</span>
	<span class="p">.</span><span class="n">CHID_hdr</span>                 <span class="o">=</span> <span class="n">WUSB_AR_CHID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">LangID_hdr</span>               <span class="o">=</span> <span class="n">WUSB_AR_LangID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">HostFriendlyName_hdr</span>     <span class="o">=</span> <span class="n">WUSB_AR_HostFriendlyName</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Send WUSB host information (CHID and name) to a CBAF device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbaf_send_host_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wusb_cbaf_host_info</span> <span class="o">*</span><span class="n">hi</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">hi_size</span><span class="p">;</span>

	<span class="n">hi</span> <span class="o">=</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hi</span><span class="p">));</span>
	<span class="o">*</span><span class="n">hi</span> <span class="o">=</span> <span class="n">cbaf_host_info_defaults</span><span class="p">;</span>
	<span class="n">hi</span><span class="o">-&gt;</span><span class="n">CHID</span> <span class="o">=</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">;</span>
	<span class="n">hi</span><span class="o">-&gt;</span><span class="n">LangID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* FIXME: I guess... */</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">hi</span><span class="o">-&gt;</span><span class="n">HostFriendlyName</span><span class="p">,</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">,</span> <span class="n">CBA_NAME_LEN</span><span class="p">);</span>
	<span class="n">name_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">);</span>
	<span class="n">hi</span><span class="o">-&gt;</span><span class="n">HostFriendlyName_hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">name_len</span><span class="p">);</span>
	<span class="n">hi_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hi</span><span class="p">)</span> <span class="o">+</span> <span class="n">name_len</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">CBAF_REQ_SET_ASSOCIATION_RESPONSE</span><span class="p">,</span>
			<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			<span class="mh">0x0101</span><span class="p">,</span>
			<span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span>
			<span class="n">hi</span><span class="p">,</span> <span class="n">hi_size</span><span class="p">,</span> <span class="mi">1000</span> <span class="cm">/* FIXME: arbitrary */</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get device&#39;s information (CDID) associated to CHID</span>
<span class="cm"> *</span>
<span class="cm"> * The device will return it&#39;s information (CDID, name, bandgroups)</span>
<span class="cm"> * associated to the CHID we have set before, or 0 CDID and default</span>
<span class="cm"> * name and bandgroup if no CHID set or unknown.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbaf_cdid_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wusb_cbaf_device_info</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">needed</span><span class="p">;</span>

	<span class="n">di</span> <span class="o">=</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span>
		<span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">CBAF_REQ_GET_ASSOCIATION_REQUEST</span><span class="p">,</span>
		<span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
		<span class="mh">0x0200</span><span class="p">,</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span>
		<span class="n">di</span><span class="p">,</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">,</span> <span class="mi">1000</span> <span class="cm">/* FIXME: arbitrary */</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot request device information: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">needed</span> <span class="o">=</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">di</span><span class="p">)</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">di</span><span class="p">)</span> <span class="o">:</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">Length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="n">needed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not enough data in DEVICE_INFO reply (%zu vs &quot;</span>
			<span class="s">&quot;%zu bytes needed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">result</span><span class="p">,</span> <span class="n">needed</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">DeviceFriendlyName</span><span class="p">,</span> <span class="n">CBA_NAME_LEN</span><span class="p">);</span>
	<span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">cdid</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">CDID</span><span class="p">;</span>
	<span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">device_band_groups</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">BandGroups</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cbaf_wusb_chid_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">pr_chid</span><span class="p">[</span><span class="n">WUSB_CKHDID_STRSIZE</span><span class="p">];</span>

	<span class="n">ckhdid_printf</span><span class="p">(</span><span class="n">pr_chid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pr_chid</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pr_chid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cbaf_wusb_chid_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
			<span class="s">&quot;%02hhx %02hhx %02hhx %02hhx &quot;</span>
			<span class="s">&quot;%02hhx %02hhx %02hhx %02hhx &quot;</span>
			<span class="s">&quot;%02hhx %02hhx %02hhx %02hhx &quot;</span>
			<span class="s">&quot;%02hhx %02hhx %02hhx %02hhx&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">cbaf_send_host_info</span><span class="p">(</span><span class="n">cbaf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">cbaf_cdid_get</span><span class="p">(</span><span class="n">cbaf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wusb_chid</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">cbaf_wusb_chid_show</span><span class="p">,</span> <span class="n">cbaf_wusb_chid_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cbaf_wusb_host_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cbaf_wusb_host_name_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%63s&quot;</span><span class="p">,</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">host_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wusb_host_name</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">cbaf_wusb_host_name_show</span><span class="p">,</span>
					 <span class="n">cbaf_wusb_host_name_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cbaf_wusb_host_band_groups_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">host_band_groups</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cbaf_wusb_host_band_groups_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">band_groups</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%04hx&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">band_groups</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">host_band_groups</span> <span class="o">=</span> <span class="n">band_groups</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wusb_host_band_groups</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span>
		   <span class="n">cbaf_wusb_host_band_groups_show</span><span class="p">,</span>
		   <span class="n">cbaf_wusb_host_band_groups_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">wusb_cbaf_device_info</span> <span class="n">cbaf_device_info_defaults</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">Length_hdr</span>               <span class="o">=</span> <span class="n">WUSB_AR_Length</span><span class="p">,</span>
	<span class="p">.</span><span class="n">CDID_hdr</span>                 <span class="o">=</span> <span class="n">WUSB_AR_CDID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">BandGroups_hdr</span>           <span class="o">=</span> <span class="n">WUSB_AR_BandGroups</span><span class="p">,</span>
	<span class="p">.</span><span class="n">LangID_hdr</span>               <span class="o">=</span> <span class="n">WUSB_AR_LangID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">DeviceFriendlyName_hdr</span>   <span class="o">=</span> <span class="n">WUSB_AR_DeviceFriendlyName</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cbaf_wusb_cdid_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">pr_cdid</span><span class="p">[</span><span class="n">WUSB_CKHDID_STRSIZE</span><span class="p">];</span>

	<span class="n">ckhdid_printf</span><span class="p">(</span><span class="n">pr_cdid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pr_cdid</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">cdid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pr_cdid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cbaf_wusb_cdid_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wusb_ckhdid</span> <span class="n">cdid</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
			<span class="s">&quot;%02hhx %02hhx %02hhx %02hhx &quot;</span>
			<span class="s">&quot;%02hhx %02hhx %02hhx %02hhx &quot;</span>
			<span class="s">&quot;%02hhx %02hhx %02hhx %02hhx &quot;</span>
			<span class="s">&quot;%02hhx %02hhx %02hhx %02hhx&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cdid</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">cdid</span> <span class="o">=</span> <span class="n">cdid</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wusb_cdid</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">cbaf_wusb_cdid_show</span><span class="p">,</span> <span class="n">cbaf_wusb_cdid_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cbaf_wusb_device_band_groups_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
						 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">device_band_groups</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wusb_device_band_groups</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span>
		   <span class="n">cbaf_wusb_device_band_groups_show</span><span class="p">,</span>
		   <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cbaf_wusb_device_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">device_name</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wusb_device_name</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">cbaf_wusb_device_name_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">wusb_cbaf_cc_data</span> <span class="n">cbaf_cc_data_defaults</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">AssociationTypeId_hdr</span>    <span class="o">=</span> <span class="n">WUSB_AR_AssociationTypeId</span><span class="p">,</span>
	<span class="p">.</span><span class="n">AssociationTypeId</span>    	  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR_TYPE_WUSB</span><span class="p">),</span>
	<span class="p">.</span><span class="n">AssociationSubTypeId_hdr</span> <span class="o">=</span> <span class="n">WUSB_AR_AssociationSubTypeId</span><span class="p">,</span>
	<span class="p">.</span><span class="n">AssociationSubTypeId</span>     <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR_TYPE_WUSB_ASSOCIATE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">Length_hdr</span>               <span class="o">=</span> <span class="n">WUSB_AR_Length</span><span class="p">,</span>
	<span class="p">.</span><span class="n">Length</span>               	  <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wusb_cbaf_cc_data</span><span class="p">)),</span>
	<span class="p">.</span><span class="n">ConnectionContext_hdr</span>    <span class="o">=</span> <span class="n">WUSB_AR_ConnectionContext</span><span class="p">,</span>
	<span class="p">.</span><span class="n">BandGroups_hdr</span>           <span class="o">=</span> <span class="n">WUSB_AR_BandGroups</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">wusb_cbaf_cc_data_fail</span> <span class="n">cbaf_cc_data_fail_defaults</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">AssociationTypeId_hdr</span>    <span class="o">=</span> <span class="n">WUSB_AR_AssociationTypeId</span><span class="p">,</span>
	<span class="p">.</span><span class="n">AssociationSubTypeId_hdr</span> <span class="o">=</span> <span class="n">WUSB_AR_AssociationSubTypeId</span><span class="p">,</span>
	<span class="p">.</span><span class="n">Length_hdr</span>               <span class="o">=</span> <span class="n">WUSB_AR_Length</span><span class="p">,</span>
	<span class="p">.</span><span class="n">AssociationStatus_hdr</span>    <span class="o">=</span> <span class="n">WUSB_AR_AssociationStatus</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Send a new CC to the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbaf_cc_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wusb_cbaf_cc_data</span> <span class="o">*</span><span class="n">ccd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">pr_cdid</span><span class="p">[</span><span class="n">WUSB_CKHDID_STRSIZE</span><span class="p">];</span>

	<span class="n">ccd</span> <span class="o">=</span>  <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ccd</span> <span class="o">=</span> <span class="n">cbaf_cc_data_defaults</span><span class="p">;</span>
	<span class="n">ccd</span><span class="o">-&gt;</span><span class="n">CHID</span> <span class="o">=</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">;</span>
	<span class="n">ccd</span><span class="o">-&gt;</span><span class="n">CDID</span> <span class="o">=</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">cdid</span><span class="p">;</span>
	<span class="n">ccd</span><span class="o">-&gt;</span><span class="n">CK</span> <span class="o">=</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">;</span>
	<span class="n">ccd</span><span class="o">-&gt;</span><span class="n">BandGroups</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">host_band_groups</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Trying to upload CC:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ckhdid_printf</span><span class="p">(</span><span class="n">pr_cdid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pr_cdid</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ccd</span><span class="o">-&gt;</span><span class="n">CHID</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  CHID       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pr_cdid</span><span class="p">);</span>
	<span class="n">ckhdid_printf</span><span class="p">(</span><span class="n">pr_cdid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pr_cdid</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ccd</span><span class="o">-&gt;</span><span class="n">CDID</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  CDID       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pr_cdid</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  Bandgroups 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">host_band_groups</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span>
		<span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">CBAF_REQ_SET_ASSOCIATION_RESPONSE</span><span class="p">,</span>
		<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
		<span class="mh">0x0201</span><span class="p">,</span> <span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span>
		<span class="n">ccd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ccd</span><span class="p">),</span> <span class="mi">1000</span> <span class="cm">/* FIXME: arbitrary */</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cbaf_wusb_ck_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
			<span class="s">&quot;%02hhx %02hhx %02hhx %02hhx &quot;</span>
			<span class="s">&quot;%02hhx %02hhx %02hhx %02hhx &quot;</span>
			<span class="s">&quot;%02hhx %02hhx %02hhx %02hhx &quot;</span>
			<span class="s">&quot;%02hhx %02hhx %02hhx %02hhx&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">ck</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">cbaf_cc_upload</span><span class="p">(</span><span class="n">cbaf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wusb_ck</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cbaf_wusb_ck_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">cbaf_dev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wusb_host_name</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wusb_host_band_groups</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wusb_chid</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wusb_cdid</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wusb_device_name</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wusb_device_band_groups</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wusb_ck</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">cbaf_dev_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="cm">/* we want them in the same directory */</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">cbaf_dev_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbaf_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cbaf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cbaf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cbaf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_kzalloc</span><span class="p">;</span>
	<span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_kmalloc_buffer</span><span class="p">;</span>

	<span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">usb_get_dev</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">iface</span><span class="p">));</span>
	<span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">usb_iface</span> <span class="o">=</span> <span class="n">usb_get_intf</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">cbaf_check</span><span class="p">(</span><span class="n">cbaf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;This device is not WUSB-CBAF compliant&quot;</span>
			<span class="s">&quot;and is not supported yet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_check</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cbaf_dev_attr_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t register sysfs attr group: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_create_group</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">,</span> <span class="n">cbaf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_create_group:</span>
<span class="nl">error_check:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
<span class="nl">error_kmalloc_buffer:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cbaf</span><span class="p">);</span>
<span class="nl">error_kzalloc:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbaf_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cbaf</span> <span class="o">*</span><span class="n">cbaf</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cbaf_dev_attr_group</span><span class="p">);</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">usb_put_intf</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cbaf</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="cm">/* paranoia: clean up crypto keys */</span>
	<span class="n">kzfree</span><span class="p">(</span><span class="n">cbaf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">cbaf_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">),</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">cbaf_id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">cbaf_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;wusb-cbaf&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">cbaf_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">cbaf_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span>	<span class="n">cbaf_disconnect</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">cbaf_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Inaky Perez-Gonzalez &lt;inaky.perez-gonzalez@intel.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Wireless USB Cable Based Association&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
