<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › storage › isd200.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>isd200.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Transport &amp; Protocol Driver for In-System Design, Inc. ISD200 ASIC</span>
<span class="cm"> *</span>
<span class="cm"> * Current development and maintenance:</span>
<span class="cm"> *   (C) 2001-2002 Björn Stenberg (bjorn@haxx.se)</span>
<span class="cm"> *</span>
<span class="cm"> * Developed with the assistance of:</span>
<span class="cm"> *   (C) 2002 Alan Stern &lt;stern@rowland.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Initial work:</span>
<span class="cm"> *   (C) 2000 In-System Design, Inc. (support@in-system.com)</span>
<span class="cm"> *</span>
<span class="cm"> * The ISD200 ASIC does not natively support ATA devices.  The chip</span>
<span class="cm"> * does implement an interface, the ATA Command Block (ATACB) which provides</span>
<span class="cm"> * a means of passing ATA commands and ATA register accesses to a device.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2, or (at your option) any</span>
<span class="cm"> * later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * History:</span>
<span class="cm"> *</span>
<span class="cm"> *  2002-10-19: Removed the specialized transfer routines.</span>
<span class="cm"> *		(Alan Stern &lt;stern@rowland.harvard.edu&gt;)</span>
<span class="cm"> *  2001-02-24: Removed lots of duplicate code and simplified the structure.</span>
<span class="cm"> *	      (bjorn@haxx.se)</span>
<span class="cm"> *  2002-01-16: Fixed endianness bug so it works on the ppc arch.</span>
<span class="cm"> *	      (Luc Saillard &lt;luc@saillard.org&gt;)</span>
<span class="cm"> *  2002-01-17: All bitfields removed.</span>
<span class="cm"> *	      (bjorn@haxx.se)</span>
<span class="cm"> */</span>


<span class="cm">/* Include files */</span>

<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/ata.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>

<span class="cp">#include &quot;usb.h&quot;</span>
<span class="cp">#include &quot;transport.h&quot;</span>
<span class="cp">#include &quot;protocol.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;scsiglue.h&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for In-System Design, Inc. ISD200 ASIC&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Björn Stenberg &lt;bjorn@haxx.se&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">isd200_Initialization</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * The table of devices</span>
<span class="cm"> */</span>
<span class="cp">#define UNUSUAL_DEV(id_vendor, id_product, bcdDeviceMin, bcdDeviceMax, \</span>
<span class="cp">		    vendorName, productName, useProtocol, useTransport, \</span>
<span class="cp">		    initFunction, flags) \</span>
<span class="cp">{ USB_DEVICE_VER(id_vendor, id_product, bcdDeviceMin, bcdDeviceMax), \</span>
<span class="cp">  .driver_info = (flags)|(USB_US_TYPE_STOR&lt;&lt;24) }</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">isd200_usb_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#	include &quot;unusual_isd200.h&quot;</span>
	<span class="p">{</span> <span class="p">}</span>		<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">isd200_usb_ids</span><span class="p">);</span>

<span class="cp">#undef UNUSUAL_DEV</span>
<span class="cp">#undef USUAL_DEV</span>

<span class="cm">/*</span>
<span class="cm"> * The flags table</span>
<span class="cm"> */</span>
<span class="cp">#define UNUSUAL_DEV(idVendor, idProduct, bcdDeviceMin, bcdDeviceMax, \</span>
<span class="cp">		    vendor_name, product_name, use_protocol, use_transport, \</span>
<span class="cp">		    init_function, Flags) \</span>
<span class="cp">{ \</span>
<span class="cp">	.vendorName = vendor_name,	\</span>
<span class="cp">	.productName = product_name,	\</span>
<span class="cp">	.useProtocol = use_protocol,	\</span>
<span class="cp">	.useTransport = use_transport,	\</span>
<span class="cp">	.initFunction = init_function,	\</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">us_unusual_dev</span> <span class="n">isd200_unusual_dev_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#	include &quot;unusual_isd200.h&quot;</span>
	<span class="p">{</span> <span class="p">}</span>		<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="cp">#undef UNUSUAL_DEV</span>
<span class="cp">#undef USUAL_DEV</span>


<span class="cm">/* Timeout defines (in Seconds) */</span>

<span class="cp">#define ISD200_ENUM_BSY_TIMEOUT		35</span>
<span class="cp">#define ISD200_ENUM_DETECT_TIMEOUT      30</span>
<span class="cp">#define ISD200_DEFAULT_TIMEOUT		30</span>

<span class="cm">/* device flags */</span>
<span class="cp">#define DF_ATA_DEVICE		0x0001</span>
<span class="cp">#define DF_MEDIA_STATUS_ENABLED	0x0002</span>
<span class="cp">#define DF_REMOVABLE_MEDIA	0x0004</span>

<span class="cm">/* capability bit definitions */</span>
<span class="cp">#define CAPABILITY_DMA		0x01</span>
<span class="cp">#define CAPABILITY_LBA		0x02</span>

<span class="cm">/* command_setX bit definitions */</span>
<span class="cp">#define COMMANDSET_REMOVABLE	0x02</span>
<span class="cp">#define COMMANDSET_MEDIA_STATUS 0x10</span>

<span class="cm">/* ATA Vendor Specific defines */</span>
<span class="cp">#define ATA_ADDRESS_DEVHEAD_STD      0xa0</span>
<span class="cp">#define ATA_ADDRESS_DEVHEAD_LBA_MODE 0x40    </span>
<span class="cp">#define ATA_ADDRESS_DEVHEAD_SLAVE    0x10</span>

<span class="cm">/* Action Select bits */</span>
<span class="cp">#define ACTION_SELECT_0	     0x01</span>
<span class="cp">#define ACTION_SELECT_1	     0x02</span>
<span class="cp">#define ACTION_SELECT_2	     0x04</span>
<span class="cp">#define ACTION_SELECT_3	     0x08</span>
<span class="cp">#define ACTION_SELECT_4	     0x10</span>
<span class="cp">#define ACTION_SELECT_5	     0x20</span>
<span class="cp">#define ACTION_SELECT_6	     0x40</span>
<span class="cp">#define ACTION_SELECT_7	     0x80</span>

<span class="cm">/* Register Select bits */</span>
<span class="cp">#define REG_ALTERNATE_STATUS	0x01</span>
<span class="cp">#define REG_DEVICE_CONTROL	0x01</span>
<span class="cp">#define REG_ERROR		0x02</span>
<span class="cp">#define REG_FEATURES		0x02</span>
<span class="cp">#define REG_SECTOR_COUNT	0x04</span>
<span class="cp">#define REG_SECTOR_NUMBER	0x08</span>
<span class="cp">#define REG_CYLINDER_LOW	0x10</span>
<span class="cp">#define REG_CYLINDER_HIGH	0x20</span>
<span class="cp">#define REG_DEVICE_HEAD		0x40</span>
<span class="cp">#define REG_STATUS		0x80</span>
<span class="cp">#define REG_COMMAND		0x80</span>

<span class="cm">/* ATA registers offset definitions */</span>
<span class="cp">#define ATA_REG_ERROR_OFFSET		1</span>
<span class="cp">#define ATA_REG_LCYL_OFFSET		4</span>
<span class="cp">#define ATA_REG_HCYL_OFFSET		5</span>
<span class="cp">#define ATA_REG_STATUS_OFFSET		7</span>

<span class="cm">/* ATA error definitions not in &lt;linux/hdreg.h&gt; */</span>
<span class="cp">#define ATA_ERROR_MEDIA_CHANGE		0x20</span>

<span class="cm">/* ATA command definitions not in &lt;linux/hdreg.h&gt; */</span>
<span class="cp">#define ATA_COMMAND_GET_MEDIA_STATUS	0xDA</span>
<span class="cp">#define ATA_COMMAND_MEDIA_EJECT		0xED</span>

<span class="cm">/* ATA drive control definitions */</span>
<span class="cp">#define ATA_DC_DISABLE_INTERRUPTS	0x02</span>
<span class="cp">#define ATA_DC_RESET_CONTROLLER		0x04</span>
<span class="cp">#define ATA_DC_REENABLE_CONTROLLER	0x00</span>

<span class="cm">/*</span>
<span class="cm"> *  General purpose return codes</span>
<span class="cm"> */</span> 

<span class="cp">#define ISD200_ERROR		-1</span>
<span class="cp">#define ISD200_GOOD		 0</span>

<span class="cm">/*</span>
<span class="cm"> * Transport return codes</span>
<span class="cm"> */</span>

<span class="cp">#define ISD200_TRANSPORT_GOOD       0   </span><span class="cm">/* Transport good, command good     */</span><span class="cp"></span>
<span class="cp">#define ISD200_TRANSPORT_FAILED     1   </span><span class="cm">/* Transport good, command failed   */</span><span class="cp"></span>
<span class="cp">#define ISD200_TRANSPORT_ERROR      2   </span><span class="cm">/* Transport bad (i.e. device dead) */</span><span class="cp"></span>

<span class="cm">/* driver action codes */</span>
<span class="cp">#define	ACTION_READ_STATUS	0</span>
<span class="cp">#define	ACTION_RESET		1</span>
<span class="cp">#define	ACTION_REENABLE		2</span>
<span class="cp">#define	ACTION_SOFT_RESET	3</span>
<span class="cp">#define	ACTION_ENUM		4</span>
<span class="cp">#define	ACTION_IDENTIFY		5</span>


<span class="cm">/*</span>
<span class="cm"> * ata_cdb struct</span>
<span class="cm"> */</span>


<span class="k">union</span> <span class="n">ata_cdb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SignatureByte0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SignatureByte1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ActionSelect</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RegisterSelect</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TransferBlockSize</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">WriteData3F6</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">WriteData1F1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">WriteData1F2</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">WriteData1F3</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">WriteData1F4</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">WriteData1F5</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">WriteData1F6</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">WriteData1F7</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Reserved</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">generic</span><span class="p">;</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SignatureByte0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SignatureByte1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ActionSelect</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RegisterSelect</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TransferBlockSize</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">AlternateStatusByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ErrorByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SectorCountByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SectorNumberByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">CylinderLowByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">CylinderHighByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">DeviceHeadByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">StatusByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Reserved</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">read</span><span class="p">;</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SignatureByte0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SignatureByte1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ActionSelect</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RegisterSelect</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TransferBlockSize</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">DeviceControlByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FeaturesByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SectorCountByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SectorNumberByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">CylinderLowByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">CylinderHighByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">DeviceHeadByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">CommandByte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Reserved</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">write</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Inquiry data structure. This is the data returned from the target</span>
<span class="cm"> * after it receives an inquiry.</span>
<span class="cm"> *</span>
<span class="cm"> * This structure may be extended by the number of bytes specified</span>
<span class="cm"> * in the field AdditionalLength. The defined size constant only</span>
<span class="cm"> * includes fields through ProductRevisionLevel.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * DeviceType field</span>
<span class="cm"> */</span>
<span class="cp">#define DIRECT_ACCESS_DEVICE	    0x00    </span><span class="cm">/* disks */</span><span class="cp"></span>
<span class="cp">#define DEVICE_REMOVABLE		0x80</span>

<span class="k">struct</span> <span class="n">inquiry_data</span> <span class="p">{</span>
   	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">DeviceType</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">DeviceTypeModifier</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Versions</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Format</span><span class="p">;</span> 
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">AdditionalLength</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Reserved</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Capability</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">VendorId</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ProductId</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ProductRevisionLevel</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">VendorSpecific</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Reserved3</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * INQUIRY data buffer size</span>
<span class="cm"> */</span>

<span class="cp">#define INQUIRYDATABUFFERSIZE 36</span>


<span class="cm">/*</span>
<span class="cm"> * ISD200 CONFIG data struct</span>
<span class="cm"> */</span>

<span class="cp">#define ATACFG_TIMING	  0x0f</span>
<span class="cp">#define ATACFG_ATAPI_RESET     0x10</span>
<span class="cp">#define ATACFG_MASTER	  0x20</span>
<span class="cp">#define ATACFG_BLOCKSIZE       0xa0</span>

<span class="cp">#define ATACFGE_LAST_LUN       0x07</span>
<span class="cp">#define ATACFGE_DESC_OVERRIDE  0x08</span>
<span class="cp">#define ATACFGE_STATE_SUSPEND  0x10</span>
<span class="cp">#define ATACFGE_SKIP_BOOT      0x20</span>
<span class="cp">#define ATACFGE_CONF_DESC2     0x40</span>
<span class="cp">#define ATACFGE_INIT_STATUS    0x80</span>

<span class="cp">#define CFG_CAPABILITY_SRST    0x01</span>

<span class="k">struct</span> <span class="n">isd200_config</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">EventNotification</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ExternalClock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ATAInitTimeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ATAConfig</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ATAMajorCommand</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ATAMinorCommand</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ATAExtraConfig</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Capability</span><span class="p">;</span>
<span class="p">}</span><span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>


<span class="cm">/*</span>
<span class="cm"> * ISD200 driver information struct</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">isd200_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">inquiry_data</span> <span class="n">InquiryData</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isd200_config</span> <span class="n">ConfigData</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">RegsBuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ATARegs</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">DeviceHead</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">DeviceFlags</span><span class="p">;</span>

	<span class="cm">/* maximum number of LUNs supported */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">MaxLUNs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmnd</span><span class="p">[</span><span class="n">BLK_MAX_CDB</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="n">srb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Read Capacity Data - returned in Big Endian format</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">read_capacity_data</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">LogicalBlockAddress</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">BytesPerBlock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Read Block Limits Data - returned in Big Endian format</span>
<span class="cm"> * This structure returns the maximum and minimum block</span>
<span class="cm"> * size for a TAPE device.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">read_block_limits</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Reserved</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BlockMaximumSize</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BlockMinimumSize</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Sense Data Format</span>
<span class="cm"> */</span>

<span class="cp">#define SENSE_ERRCODE	   0x7f</span>
<span class="cp">#define SENSE_ERRCODE_VALID     0x80</span>
<span class="cp">#define SENSE_FLAG_SENSE_KEY    0x0f</span>
<span class="cp">#define SENSE_FLAG_BAD_LENGTH   0x20</span>
<span class="cp">#define SENSE_FLAG_END_OF_MEDIA 0x40</span>
<span class="cp">#define SENSE_FLAG_FILE_MARK    0x80</span>
<span class="k">struct</span> <span class="n">sense_data</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ErrorCode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SegmentNumber</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Information</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">AdditionalSenseLength</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">CommandSpecificInformation</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">AdditionalSenseCode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">AdditionalSenseCodeQualifier</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FieldReplaceableUnitCode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SenseKeySpecific</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * Default request sense buffer size</span>
<span class="cm"> */</span>

<span class="cp">#define SENSE_BUFFER_SIZE 18</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * Helper routines</span>
<span class="cm"> ***********************************************************************/</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * isd200_build_sense</span>
<span class="cm"> *									 </span>
<span class="cm"> *  Builds an artificial sense buffer to report the results of a </span>
<span class="cm"> *  failed command.</span>
<span class="cm"> *								       </span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> *    void</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isd200_build_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="p">)</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sense_data</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sense_data</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">error</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ATARegs</span><span class="p">[</span><span class="n">ATA_REG_ERROR_OFFSET</span><span class="p">];</span>

	<span class="k">if</span><span class="p">(</span><span class="n">error</span> <span class="o">&amp;</span> <span class="n">ATA_ERROR_MEDIA_CHANGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">ErrorCode</span> <span class="o">=</span> <span class="mh">0x70</span> <span class="o">|</span> <span class="n">SENSE_ERRCODE_VALID</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">AdditionalSenseLength</span> <span class="o">=</span> <span class="mh">0xb</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">UNIT_ATTENTION</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCodeQualifier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;</span> <span class="n">ATA_MCR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">ErrorCode</span> <span class="o">=</span> <span class="mh">0x70</span> <span class="o">|</span> <span class="n">SENSE_ERRCODE_VALID</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">AdditionalSenseLength</span> <span class="o">=</span> <span class="mh">0xb</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span>  <span class="n">UNIT_ATTENTION</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCodeQualifier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;</span> <span class="n">ATA_TRK0NF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">ErrorCode</span> <span class="o">=</span> <span class="mh">0x70</span> <span class="o">|</span> <span class="n">SENSE_ERRCODE_VALID</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">AdditionalSenseLength</span> <span class="o">=</span> <span class="mh">0xb</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span>  <span class="n">NOT_READY</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCodeQualifier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;</span> <span class="n">ATA_UNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">ErrorCode</span> <span class="o">=</span> <span class="mh">0x70</span> <span class="o">|</span> <span class="n">SENSE_ERRCODE_VALID</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">AdditionalSenseLength</span> <span class="o">=</span> <span class="mh">0xb</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span>  <span class="n">DATA_PROTECT</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCodeQualifier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">ErrorCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">AdditionalSenseLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCodeQualifier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/***********************************************************************</span>
<span class="cm"> * Transport routines</span>
<span class="cm"> ***********************************************************************/</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> *  isd200_set_srb(), isd200_srb_set_bufflen()</span>
<span class="cm"> *</span>
<span class="cm"> * Two helpers to facilitate in initialization of scsi_cmnd structure</span>
<span class="cm"> * Will need to change when struct scsi_cmnd changes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isd200_set_srb</span><span class="p">(</span><span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">buff</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">bufflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buff</span><span class="p">)</span>
		<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">bufflen</span><span class="p">);</span>

	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">sdb</span><span class="p">.</span><span class="n">table</span><span class="p">.</span><span class="n">sgl</span> <span class="o">=</span> <span class="n">buff</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">sdb</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">bufflen</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">sdb</span><span class="p">.</span><span class="n">table</span><span class="p">.</span><span class="n">nents</span> <span class="o">=</span> <span class="n">buff</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isd200_srb_set_bufflen</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">bufflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">sdb</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">bufflen</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**************************************************************************</span>
<span class="cm"> *  isd200_action</span>
<span class="cm"> *</span>
<span class="cm"> * Routine for sending commands to the isd200</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> *    ISD status code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isd200_action</span><span class="p">(</span> <span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="kt">int</span> <span class="n">action</span><span class="p">,</span> 
			  <span class="kt">void</span><span class="o">*</span> <span class="n">pointer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ata_cdb</span> <span class="n">ata</span><span class="p">;</span>
	<span class="cm">/* static to prevent this large struct being placed on the valuable stack */</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_device</span> <span class="n">srb_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="p">)</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ata</span><span class="p">));</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">srb_dev</span><span class="p">;</span>

	<span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte0</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMajorCommand</span><span class="p">;</span>
	<span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte1</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMinorCommand</span><span class="p">;</span>
	<span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">TransferBlockSize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span> <span class="n">action</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACTION_READ_STATUS</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   isd200_action(READ_STATUS)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">ActionSelect</span> <span class="o">=</span> <span class="n">ACTION_SELECT_0</span><span class="o">|</span><span class="n">ACTION_SELECT_2</span><span class="p">;</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">RegisterSelect</span> <span class="o">=</span>
		  <span class="n">REG_CYLINDER_LOW</span> <span class="o">|</span> <span class="n">REG_CYLINDER_HIGH</span> <span class="o">|</span>
		  <span class="n">REG_STATUS</span> <span class="o">|</span> <span class="n">REG_ERROR</span><span class="p">;</span>
		<span class="n">isd200_set_srb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span> <span class="n">pointer</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTION_ENUM</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   isd200_action(ENUM,0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">ActionSelect</span> <span class="o">=</span> <span class="n">ACTION_SELECT_1</span><span class="o">|</span><span class="n">ACTION_SELECT_2</span><span class="o">|</span>
					   <span class="n">ACTION_SELECT_3</span><span class="o">|</span><span class="n">ACTION_SELECT_4</span><span class="o">|</span>
					   <span class="n">ACTION_SELECT_5</span><span class="p">;</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">RegisterSelect</span> <span class="o">=</span> <span class="n">REG_DEVICE_HEAD</span><span class="p">;</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">DeviceHeadByte</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">isd200_set_srb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTION_RESET</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   isd200_action(RESET)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">ActionSelect</span> <span class="o">=</span> <span class="n">ACTION_SELECT_1</span><span class="o">|</span><span class="n">ACTION_SELECT_2</span><span class="o">|</span>
					   <span class="n">ACTION_SELECT_3</span><span class="o">|</span><span class="n">ACTION_SELECT_4</span><span class="p">;</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">RegisterSelect</span> <span class="o">=</span> <span class="n">REG_DEVICE_CONTROL</span><span class="p">;</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">DeviceControlByte</span> <span class="o">=</span> <span class="n">ATA_DC_RESET_CONTROLLER</span><span class="p">;</span>
		<span class="n">isd200_set_srb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTION_REENABLE</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   isd200_action(REENABLE)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">ActionSelect</span> <span class="o">=</span> <span class="n">ACTION_SELECT_1</span><span class="o">|</span><span class="n">ACTION_SELECT_2</span><span class="o">|</span>
					   <span class="n">ACTION_SELECT_3</span><span class="o">|</span><span class="n">ACTION_SELECT_4</span><span class="p">;</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">RegisterSelect</span> <span class="o">=</span> <span class="n">REG_DEVICE_CONTROL</span><span class="p">;</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">DeviceControlByte</span> <span class="o">=</span> <span class="n">ATA_DC_REENABLE_CONTROLLER</span><span class="p">;</span>
		<span class="n">isd200_set_srb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTION_SOFT_RESET</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   isd200_action(SOFT_RESET)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">ActionSelect</span> <span class="o">=</span> <span class="n">ACTION_SELECT_1</span><span class="o">|</span><span class="n">ACTION_SELECT_5</span><span class="p">;</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">RegisterSelect</span> <span class="o">=</span> <span class="n">REG_DEVICE_HEAD</span> <span class="o">|</span> <span class="n">REG_COMMAND</span><span class="p">;</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">DeviceHeadByte</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceHead</span><span class="p">;</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">CommandByte</span> <span class="o">=</span> <span class="n">ATA_CMD_DEV_RESET</span><span class="p">;</span>
		<span class="n">isd200_set_srb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTION_IDENTIFY</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   isd200_action(IDENTIFY)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">.</span><span class="n">RegisterSelect</span> <span class="o">=</span> <span class="n">REG_COMMAND</span><span class="p">;</span>
		<span class="n">ata</span><span class="p">.</span><span class="n">write</span><span class="p">.</span><span class="n">CommandByte</span> <span class="o">=</span> <span class="n">ATA_CMD_ID_ATA</span><span class="p">;</span>
		<span class="n">isd200_set_srb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				<span class="n">ATA_ID_WORDS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Error: Undefined action %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">action</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ISD200_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">));</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ata</span><span class="p">.</span><span class="n">generic</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_stor_Bulk_transport</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">us</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">USB_STOR_TRANSPORT_GOOD</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ISD200_GOOD</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   isd200_action(0x%02x) error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">action</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ISD200_ERROR</span><span class="p">;</span>
		<span class="cm">/* need to reset device here */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * isd200_read_regs</span>
<span class="cm"> *									 </span>
<span class="cm"> * Read ATA Registers</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> *    ISD status code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isd200_read_regs</span><span class="p">(</span> <span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="p">)</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_GOOD</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">transferStatus</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Entering isd200_IssueATAReadRegs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">transferStatus</span> <span class="o">=</span> <span class="n">isd200_action</span><span class="p">(</span> <span class="n">us</span><span class="p">,</span> <span class="n">ACTION_READ_STATUS</span><span class="p">,</span>
				    <span class="n">info</span><span class="o">-&gt;</span><span class="n">RegsBuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ATARegs</span><span class="p">)</span> <span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">transferStatus</span> <span class="o">!=</span> <span class="n">ISD200_TRANSPORT_GOOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Error reading ATA registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_ERROR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ATARegs</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">RegsBuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ATARegs</span><span class="p">));</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Got ATA Register[ATA_REG_ERROR_OFFSET] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ATARegs</span><span class="p">[</span><span class="n">ATA_REG_ERROR_OFFSET</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retStatus</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**************************************************************************</span>
<span class="cm"> * Invoke the transport and basic error-handling/recovery methods</span>
<span class="cm"> *</span>
<span class="cm"> * This is used by the protocol layers to actually send the message to</span>
<span class="cm"> * the device and receive the response.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isd200_invoke_transport</span><span class="p">(</span> <span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> 
			      <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> 
			      <span class="k">union</span> <span class="n">ata_cdb</span> <span class="o">*</span><span class="n">ataCdb</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">need_auto_sense</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">transferStatus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* send the command to the transport layer */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">ataCdb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">));</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">);</span>
	<span class="n">transferStatus</span> <span class="o">=</span> <span class="n">usb_stor_Bulk_transport</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">us</span><span class="p">);</span>

	<span class="cm">/* if the command gets aborted by the higher layers, we need to</span>
<span class="cm">	 * short-circuit all other processing</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">US_FLIDX_TIMED_OUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;-- command was aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">Handle_Abort</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">transferStatus</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">USB_STOR_TRANSPORT_GOOD</span>:
		<span class="cm">/* Indicate a good result */</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_STOR_TRANSPORT_NO_SENSE</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;-- transport indicates protocol failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_STOR_TRANSPORT_FAILED</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;-- transport indicates command failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">need_auto_sense</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_STOR_TRANSPORT_ERROR</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;-- transport indicates transport error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="cm">/* Need reset here */</span>
		<span class="k">return</span><span class="p">;</span>
    
	<span class="nl">default:</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;-- transport indicates unknown error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>   
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="cm">/* Need reset here */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scsi_get_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">REQUEST_SENSE</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INQUIRY</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODE_SENSE</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">LOG_SENSE</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODE_SENSE_10</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;-- unexpectedly short transfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">need_auto_sense</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_auto_sense</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">isd200_read_regs</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">US_FLIDX_TIMED_OUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;-- auto-sense aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">Handle_Abort</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">ISD200_GOOD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isd200_build_sense</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>

			<span class="cm">/* If things are really okay, then let&#39;s show that */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span>
				<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="cm">/* Need reset here */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Regardless of auto-sense, if we _know_ we have an error</span>
<span class="cm">	 * condition, show that in the result code</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">transferStatus</span> <span class="o">==</span> <span class="n">USB_STOR_TRANSPORT_FAILED</span><span class="p">)</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* abort processing: the bulk-only transport requires a reset</span>
<span class="cm">	 * following an abort */</span>
	<span class="nl">Handle_Abort:</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* permit the reset transfer to take place */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">US_FLIDX_ABORTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">);</span>
	<span class="cm">/* Need reset here */</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_USB_STORAGE_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isd200_log_config</span><span class="p">(</span> <span class="k">struct</span> <span class="n">isd200_info</span><span class="o">*</span> <span class="n">info</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      Event Notification: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">EventNotification</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      External Clock: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ExternalClock</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      ATA Init Timeout: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAInitTimeout</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      ATAPI Command Block Size: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		  <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAConfig</span> <span class="o">&amp;</span> <span class="n">ATACFG_BLOCKSIZE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      Master/Slave Selection: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAConfig</span> <span class="o">&amp;</span> <span class="n">ATACFG_MASTER</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      ATAPI Reset: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAConfig</span> <span class="o">&amp;</span> <span class="n">ATACFG_ATAPI_RESET</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      ATA Timing: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAConfig</span> <span class="o">&amp;</span> <span class="n">ATACFG_TIMING</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      ATA Major Command: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMajorCommand</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      ATA Minor Command: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMinorCommand</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      Init Status: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAExtraConfig</span> <span class="o">&amp;</span> <span class="n">ATACFGE_INIT_STATUS</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      Config Descriptor 2: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAExtraConfig</span> <span class="o">&amp;</span> <span class="n">ATACFGE_CONF_DESC2</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      Skip Device Boot: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAExtraConfig</span> <span class="o">&amp;</span> <span class="n">ATACFGE_SKIP_BOOT</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      ATA 3 State Supsend: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAExtraConfig</span> <span class="o">&amp;</span> <span class="n">ATACFGE_STATE_SUSPEND</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      Descriptor Override: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAExtraConfig</span> <span class="o">&amp;</span> <span class="n">ATACFGE_DESC_OVERRIDE</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      Last LUN Identifier: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAExtraConfig</span> <span class="o">&amp;</span> <span class="n">ATACFGE_LAST_LUN</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      SRST Enable: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAExtraConfig</span> <span class="o">&amp;</span> <span class="n">CFG_CAPABILITY_SRST</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * isd200_write_config</span>
<span class="cm"> *									 </span>
<span class="cm"> * Write the ISD200 Configuration data</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> *    ISD status code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isd200_write_config</span><span class="p">(</span> <span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="p">)</span> 
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="p">)</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_GOOD</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_USB_STORAGE_DEBUG</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Entering isd200_write_config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Writing the following ISD200 Config Data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">isd200_log_config</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* let&#39;s send the command via the control pipe */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_stor_ctrl_transfer</span><span class="p">(</span>
		<span class="n">us</span><span class="p">,</span> 
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">send_ctrl_pipe</span><span class="p">,</span>
		<span class="mh">0x01</span><span class="p">,</span> 
		<span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span><span class="p">,</span>
		<span class="mh">0x0000</span><span class="p">,</span> 
		<span class="mh">0x0002</span><span class="p">,</span> 
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">,</span> 
		<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   ISD200 Config Data was written successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Request to write ISD200 Config Data failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Leaving isd200_write_config %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retStatus</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retStatus</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**************************************************************************</span>
<span class="cm"> * isd200_read_config</span>
<span class="cm"> *									 </span>
<span class="cm"> * Reads the ISD200 Configuration data</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> *    ISD status code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isd200_read_config</span><span class="p">(</span> <span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="p">)</span> 
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="p">)</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_GOOD</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Entering isd200_read_config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* read the configuration information from ISD200.  Use this to */</span>
	<span class="cm">/* determine what the special ATA CDB bytes are.		*/</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_stor_ctrl_transfer</span><span class="p">(</span>
		<span class="n">us</span><span class="p">,</span> 
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">recv_ctrl_pipe</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span> 
		<span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span><span class="p">,</span>
		<span class="mh">0x0000</span><span class="p">,</span> 
		<span class="mh">0x0002</span><span class="p">,</span> 
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">,</span> 
		<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">));</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Retrieved the following ISD200 Config Data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_USB_STORAGE_DEBUG</span>
		<span class="n">isd200_log_config</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Request to get ISD200 Config Data failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Leaving isd200_read_config %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retStatus</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retStatus</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**************************************************************************</span>
<span class="cm"> * isd200_atapi_soft_reset</span>
<span class="cm"> *									 </span>
<span class="cm"> * Perform an Atapi Soft Reset on the device</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> *    NT status code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isd200_atapi_soft_reset</span><span class="p">(</span> <span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_GOOD</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">transferStatus</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Entering isd200_atapi_soft_reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">transferStatus</span> <span class="o">=</span> <span class="n">isd200_action</span><span class="p">(</span> <span class="n">us</span><span class="p">,</span> <span class="n">ACTION_SOFT_RESET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">transferStatus</span> <span class="o">!=</span> <span class="n">ISD200_TRANSPORT_GOOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Error issuing Atapi Soft Reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Leaving isd200_atapi_soft_reset %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retStatus</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retStatus</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**************************************************************************</span>
<span class="cm"> * isd200_srst</span>
<span class="cm"> *									 </span>
<span class="cm"> * Perform an SRST on the device</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> *    ISD status code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isd200_srst</span><span class="p">(</span> <span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_GOOD</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">transferStatus</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Entering isd200_SRST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">transferStatus</span> <span class="o">=</span> <span class="n">isd200_action</span><span class="p">(</span> <span class="n">us</span><span class="p">,</span> <span class="n">ACTION_RESET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

	<span class="cm">/* check to see if this request failed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">transferStatus</span> <span class="o">!=</span> <span class="n">ISD200_TRANSPORT_GOOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Error issuing SRST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_ERROR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* delay 10ms to give the drive a chance to see it */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">transferStatus</span> <span class="o">=</span> <span class="n">isd200_action</span><span class="p">(</span> <span class="n">us</span><span class="p">,</span> <span class="n">ACTION_REENABLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">transferStatus</span> <span class="o">!=</span> <span class="n">ISD200_TRANSPORT_GOOD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Error taking drive out of reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_ERROR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* delay 50ms to give the drive a chance to recover after SRST */</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Leaving isd200_srst %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retStatus</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retStatus</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**************************************************************************</span>
<span class="cm"> * isd200_try_enum</span>
<span class="cm"> *									 </span>
<span class="cm"> * Helper function for isd200_manual_enum(). Does ENUM and READ_STATUS</span>
<span class="cm"> * and tries to analyze the status registers</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> *    ISD status code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isd200_try_enum</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">master_slave</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">detect</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ISD200_GOOD</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">endTime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="p">)</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">RegsBuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recheckAsMaster</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">detect</span> <span class="p">)</span>
		<span class="n">endTime</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ISD200_ENUM_DETECT_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">endTime</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ISD200_ENUM_BSY_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="cm">/* loop until we detect !BSY or timeout */</span>
	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_USB_STORAGE_DEBUG</span>
		<span class="kt">char</span><span class="o">*</span> <span class="n">mstr</span> <span class="o">=</span> <span class="n">master_slave</span> <span class="o">==</span> <span class="n">ATA_ADDRESS_DEVHEAD_STD</span> <span class="o">?</span>
			<span class="s">&quot;Master&quot;</span> <span class="o">:</span> <span class="s">&quot;Slave&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">isd200_action</span><span class="p">(</span> <span class="n">us</span><span class="p">,</span> <span class="n">ACTION_ENUM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">master_slave</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">ISD200_GOOD</span> <span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">isd200_action</span><span class="p">(</span> <span class="n">us</span><span class="p">,</span> <span class="n">ACTION_READ_STATUS</span><span class="p">,</span> 
					<span class="n">regs</span><span class="p">,</span> <span class="mi">8</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">ISD200_GOOD</span> <span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">detect</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="n">ATA_REG_STATUS_OFFSET</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ATA_BUSY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   %s status is still BSY, try again...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mstr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   %s status !BSY, continue with next operation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mstr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* check for ATA_BUSY and */</span>
		<span class="cm">/* ATA_DF (workaround ATA Zip drive) and */</span>
		<span class="cm">/* ATA_ERR (workaround for Archos CD-ROM) */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="n">ATA_REG_STATUS_OFFSET</span><span class="p">]</span> <span class="o">&amp;</span>
			 <span class="p">(</span><span class="n">ATA_BUSY</span> <span class="o">|</span> <span class="n">ATA_DF</span> <span class="o">|</span> <span class="n">ATA_ERR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Status indicates it is not ready, try again...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* check for DRDY, ATA devices set DRDY after SRST */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="n">ATA_REG_STATUS_OFFSET</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ATA_DRDY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Identified ATA device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceFlags</span> <span class="o">|=</span> <span class="n">DF_ATA_DEVICE</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceHead</span> <span class="o">=</span> <span class="n">master_slave</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> 
		<span class="cm">/* check Cylinder High/Low to</span>
<span class="cm">		   determine if it is an ATAPI device</span>
<span class="cm">		*/</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="n">ATA_REG_HCYL_OFFSET</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xEB</span> <span class="o">&amp;&amp;</span>
			 <span class="n">regs</span><span class="p">[</span><span class="n">ATA_REG_LCYL_OFFSET</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x14</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* It seems that the RICOH </span>
<span class="cm">			   MP6200A CD/RW drive will </span>
<span class="cm">			   report itself okay as a</span>
<span class="cm">			   slave when it is really a</span>
<span class="cm">			   master. So this check again</span>
<span class="cm">			   as a master device just to</span>
<span class="cm">			   make sure it doesn&#39;t report</span>
<span class="cm">			   itself okay as a master also</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">master_slave</span> <span class="o">&amp;</span> <span class="n">ATA_ADDRESS_DEVHEAD_SLAVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">recheckAsMaster</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Identified ATAPI device as slave.  Rechecking again as master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">recheckAsMaster</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">master_slave</span> <span class="o">=</span> <span class="n">ATA_ADDRESS_DEVHEAD_STD</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Identified ATAPI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceHead</span> <span class="o">=</span> <span class="n">master_slave</span><span class="p">;</span>
			      
				<span class="n">status</span> <span class="o">=</span> <span class="n">isd200_atapi_soft_reset</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Not ATA, not ATAPI. Weird.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check for timeout on this request */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">endTime</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">detect</span><span class="p">)</span>
				<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   BSY check timeout, just continue with next operation...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Device detect timeout!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * isd200_manual_enum</span>
<span class="cm"> *									 </span>
<span class="cm"> * Determines if the drive attached is an ATA or ATAPI and if it is a</span>
<span class="cm"> * master or slave.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> *    ISD status code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isd200_manual_enum</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="p">)</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_GOOD</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Entering isd200_manual_enum</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">retStatus</span> <span class="o">=</span> <span class="n">isd200_read_config</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retStatus</span> <span class="o">==</span> <span class="n">ISD200_GOOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">isslave</span><span class="p">;</span>
		<span class="cm">/* master or slave? */</span>
		<span class="n">retStatus</span> <span class="o">=</span> <span class="n">isd200_try_enum</span><span class="p">(</span> <span class="n">us</span><span class="p">,</span> <span class="n">ATA_ADDRESS_DEVHEAD_STD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retStatus</span> <span class="o">==</span> <span class="n">ISD200_GOOD</span><span class="p">)</span>
			<span class="n">retStatus</span> <span class="o">=</span> <span class="n">isd200_try_enum</span><span class="p">(</span> <span class="n">us</span><span class="p">,</span> <span class="n">ATA_ADDRESS_DEVHEAD_SLAVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retStatus</span> <span class="o">==</span> <span class="n">ISD200_GOOD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retStatus</span> <span class="o">=</span> <span class="n">isd200_srst</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retStatus</span> <span class="o">==</span> <span class="n">ISD200_GOOD</span><span class="p">)</span>
				<span class="cm">/* ata or atapi? */</span>
				<span class="n">retStatus</span> <span class="o">=</span> <span class="n">isd200_try_enum</span><span class="p">(</span> <span class="n">us</span><span class="p">,</span> <span class="n">ATA_ADDRESS_DEVHEAD_STD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">isslave</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceHead</span> <span class="o">&amp;</span> <span class="n">ATA_ADDRESS_DEVHEAD_SLAVE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAConfig</span> <span class="o">&amp;</span> <span class="n">ATACFG_MASTER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Setting Master/Slave selection to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">isslave</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAConfig</span> <span class="o">&amp;=</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAConfig</span> <span class="o">|=</span> <span class="p">(</span><span class="n">isslave</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">);</span>
			<span class="n">retStatus</span> <span class="o">=</span> <span class="n">isd200_write_config</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Leaving isd200_manual_enum %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retStatus</span><span class="p">);</span>
	<span class="k">return</span><span class="p">(</span><span class="n">retStatus</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isd200_fix_driveid</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef __LITTLE_ENDIAN</span>
<span class="cp"># ifdef __BIG_ENDIAN</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATA_ID_WORDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp"># else</span>
<span class="cp">#  error &quot;Please fix &lt;asm/byteorder.h&gt;&quot;</span>
<span class="cp"># endif</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isd200_dump_driveid</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Identify Data Structure:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      config = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CONFIG</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      cyls = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CYLS</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      heads = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HEADS</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      track_bytes = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      sector_bytes = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">id</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      sectors = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTORS</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      serial_no[0] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SERNO</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      buf_type = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="mi">20</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      buf_size = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_BUF_SIZE</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      ecc_bytes = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="mi">22</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      fw_rev[0] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_FW_REV</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      model[0] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      max_multsect = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_MAX_MULTSECT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      dword_io = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_DWORD_IO</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      capability = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CAPABILITY</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      tPIO = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_OLD_PIO_MODES</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      tDMA = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_OLD_DMA_MODES</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      field_valid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_FIELD_VALID</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      cur_cyls = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CUR_CYLS</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      cur_heads = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CUR_HEADS</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      cur_sectors = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CUR_SECTORS</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      cur_capacity = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">ata_id_u32</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mi">57</span><span class="p">));</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      multsect = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	  <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_MULTSECT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      lba_capacity = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">ata_id_u32</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">ATA_ID_LBA_CAPACITY</span><span class="p">));</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      command_set_1 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_1</span><span class="p">]);</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;      command_set_2 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_2</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * isd200_get_inquiry_data</span>
<span class="cm"> *</span>
<span class="cm"> * Get inquiry data</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> *    ISD status code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isd200_get_inquiry_data</span><span class="p">(</span> <span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="p">)</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_GOOD</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Entering isd200_get_inquiry_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* set default to Master */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceHead</span> <span class="o">=</span> <span class="n">ATA_ADDRESS_DEVHEAD_STD</span><span class="p">;</span>

	<span class="cm">/* attempt to manually enumerate this device */</span>
	<span class="n">retStatus</span> <span class="o">=</span> <span class="n">isd200_manual_enum</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retStatus</span> <span class="o">==</span> <span class="n">ISD200_GOOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">transferStatus</span><span class="p">;</span>

		<span class="cm">/* check for an ATA device */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceFlags</span> <span class="o">&amp;</span> <span class="n">DF_ATA_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* this must be an ATA device */</span>
			<span class="cm">/* perform an ATA Command Identify */</span>
			<span class="n">transferStatus</span> <span class="o">=</span> <span class="n">isd200_action</span><span class="p">(</span> <span class="n">us</span><span class="p">,</span> <span class="n">ACTION_IDENTIFY</span><span class="p">,</span>
							<span class="n">id</span><span class="p">,</span> <span class="n">ATA_ID_WORDS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">transferStatus</span> <span class="o">!=</span> <span class="n">ISD200_TRANSPORT_GOOD</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Error issuing ATA Command Identify */</span>
				<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Error issuing ATA Command Identify</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_ERROR</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* ATA Command Identify successful */</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">__be16</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
				<span class="n">__u16</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>

				<span class="n">isd200_fix_driveid</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
				<span class="n">isd200_dump_driveid</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">InquiryData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">InquiryData</span><span class="p">));</span>

				<span class="cm">/* Standard IDE interface only supports disks */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">InquiryData</span><span class="p">.</span><span class="n">DeviceType</span> <span class="o">=</span> <span class="n">DIRECT_ACCESS_DEVICE</span><span class="p">;</span>

				<span class="cm">/* The length must be at least 36 (5 + 31) */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">InquiryData</span><span class="p">.</span><span class="n">AdditionalLength</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">COMMANDSET_MEDIA_STATUS</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* set the removable bit */</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">InquiryData</span><span class="p">.</span><span class="n">DeviceTypeModifier</span> <span class="o">=</span> <span class="n">DEVICE_REMOVABLE</span><span class="p">;</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceFlags</span> <span class="o">|=</span> <span class="n">DF_REMOVABLE_MEDIA</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* Fill in vendor identification fields */</span>
				<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span><span class="p">];</span>
				<span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">InquiryData</span><span class="p">.</span><span class="n">VendorId</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">dest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

				<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_PROD</span> <span class="o">+</span> <span class="mi">8</span><span class="o">/</span><span class="mi">2</span><span class="p">];</span>
				<span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">InquiryData</span><span class="p">.</span><span class="n">ProductId</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">dest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

				<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_FW_REV</span><span class="p">];</span>
				<span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">InquiryData</span><span class="p">.</span><span class="n">ProductRevisionLevel</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">dest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

				<span class="cm">/* determine if it supports Media Status Notification */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_COMMAND_SET_2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">COMMANDSET_MEDIA_STATUS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Device supports Media Status Notification</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

					<span class="cm">/* Indicate that it is enabled, even though it is not</span>
<span class="cm">					 * This allows the lock/unlock of the media to work</span>
<span class="cm">					 * correctly.</span>
<span class="cm">					 */</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceFlags</span> <span class="o">|=</span> <span class="n">DF_MEDIA_STATUS_ENABLED</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceFlags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DF_MEDIA_STATUS_ENABLED</span><span class="p">;</span>

			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* </span>
<span class="cm">			 * this must be an ATAPI device </span>
<span class="cm">			 * use an ATAPI protocol (Transparent SCSI)</span>
<span class="cm">			 */</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">protocol_name</span> <span class="o">=</span> <span class="s">&quot;Transparent SCSI&quot;</span><span class="p">;</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">proto_handler</span> <span class="o">=</span> <span class="n">usb_stor_transparent_scsi_command</span><span class="p">;</span>

			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Protocol changed to: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">protocol_name</span><span class="p">);</span>
	    
			<span class="cm">/* Free driver structure */</span>	    
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">extra_destructor</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">us</span><span class="o">-&gt;</span><span class="n">extra_destructor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Leaving isd200_get_inquiry_data %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retStatus</span><span class="p">);</span>

	<span class="k">return</span><span class="p">(</span><span class="n">retStatus</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * isd200_scsi_to_ata</span>
<span class="cm"> *									 </span>
<span class="cm"> * Translate SCSI commands to ATA commands.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> *    1 if the command needs to be sent to the transport layer</span>
<span class="cm"> *    0 otherwise</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isd200_scsi_to_ata</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">ata_cdb</span> <span class="o">*</span> <span class="n">ataCdb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="p">)</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sendToTransport</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sectnum</span><span class="p">,</span> <span class="n">head</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cylinder</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lba</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">blockCount</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">senseData</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ataCdb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ata_cdb</span><span class="p">));</span>

	<span class="cm">/* SCSI Command */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INQUIRY</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   ATA OUT - INQUIRY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* copy InquiryData */</span>
		<span class="n">usb_stor_set_xfer_buf</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">InquiryData</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">InquiryData</span><span class="p">),</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="n">sendToTransport</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MODE_SENSE</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   ATA OUT - SCSIOP_MODE_SENSE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Initialize the return buffer */</span>
		<span class="n">usb_stor_set_xfer_buf</span><span class="p">(</span><span class="n">senseData</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">senseData</span><span class="p">),</span> <span class="n">srb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceFlags</span> <span class="o">&amp;</span> <span class="n">DF_MEDIA_STATUS_ENABLED</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte0</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMajorCommand</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte1</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMinorCommand</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">TransferBlockSize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">RegisterSelect</span> <span class="o">=</span> <span class="n">REG_COMMAND</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">CommandByte</span> <span class="o">=</span> <span class="n">ATA_COMMAND_GET_MEDIA_STATUS</span><span class="p">;</span>
			<span class="n">isd200_srb_set_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Media Status not supported, just report okay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
			<span class="n">sendToTransport</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   ATA OUT - SCSIOP_TEST_UNIT_READY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceFlags</span> <span class="o">&amp;</span> <span class="n">DF_MEDIA_STATUS_ENABLED</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte0</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMajorCommand</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte1</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMinorCommand</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">TransferBlockSize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">RegisterSelect</span> <span class="o">=</span> <span class="n">REG_COMMAND</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">CommandByte</span> <span class="o">=</span> <span class="n">ATA_COMMAND_GET_MEDIA_STATUS</span><span class="p">;</span>
			<span class="n">isd200_srb_set_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Media Status not supported, just report okay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
			<span class="n">sendToTransport</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">READ_CAPACITY</span>:
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">capacity</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">read_capacity_data</span> <span class="n">readCapacityData</span><span class="p">;</span>

		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   ATA OUT - SCSIOP_READ_CAPACITY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_has_lba</span><span class="p">(</span><span class="n">id</span><span class="p">))</span>
			<span class="n">capacity</span> <span class="o">=</span> <span class="n">ata_id_u32</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">ATA_ID_LBA_CAPACITY</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">capacity</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HEADS</span><span class="p">]</span> <span class="o">*</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_CYLS</span><span class="p">]</span> <span class="o">*</span>
				    <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTORS</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">readCapacityData</span><span class="p">.</span><span class="n">LogicalBlockAddress</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">capacity</span><span class="p">);</span>
		<span class="n">readCapacityData</span><span class="p">.</span><span class="n">BytesPerBlock</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mh">0x200</span><span class="p">);</span>

		<span class="n">usb_stor_set_xfer_buf</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">readCapacityData</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">readCapacityData</span><span class="p">),</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="n">sendToTransport</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">READ_10</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   ATA OUT - SCSIOP_READ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">lba</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">blockCount</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_has_lba</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sectnum</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">lba</span><span class="p">);</span>
			<span class="n">cylinder</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">lba</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>
			<span class="n">head</span> <span class="o">=</span> <span class="n">ATA_ADDRESS_DEVHEAD_LBA_MODE</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">lba</span><span class="o">&gt;&gt;</span><span class="mi">24</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sectnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">lba</span> <span class="o">%</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTORS</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cylinder</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">lba</span> <span class="o">/</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTORS</span><span class="p">]</span> <span class="o">*</span>
					<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HEADS</span><span class="p">]));</span>
			<span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">lba</span> <span class="o">/</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTORS</span><span class="p">])</span> <span class="o">%</span>
					<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HEADS</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte0</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMajorCommand</span><span class="p">;</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte1</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMinorCommand</span><span class="p">;</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">TransferBlockSize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">RegisterSelect</span> <span class="o">=</span>
		  <span class="n">REG_SECTOR_COUNT</span> <span class="o">|</span> <span class="n">REG_SECTOR_NUMBER</span> <span class="o">|</span>
		  <span class="n">REG_CYLINDER_LOW</span> <span class="o">|</span> <span class="n">REG_CYLINDER_HIGH</span> <span class="o">|</span>
		  <span class="n">REG_DEVICE_HEAD</span>  <span class="o">|</span> <span class="n">REG_COMMAND</span><span class="p">;</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">SectorCountByte</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">blockCount</span><span class="p">;</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">SectorNumberByte</span> <span class="o">=</span> <span class="n">sectnum</span><span class="p">;</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">CylinderHighByte</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">cylinder</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">CylinderLowByte</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">cylinder</span><span class="p">;</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">DeviceHeadByte</span> <span class="o">=</span> <span class="p">(</span><span class="n">head</span> <span class="o">|</span> <span class="n">ATA_ADDRESS_DEVHEAD_STD</span><span class="p">);</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">CommandByte</span> <span class="o">=</span> <span class="n">ATA_CMD_PIO_READ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WRITE_10</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   ATA OUT - SCSIOP_WRITE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">lba</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">blockCount</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ata_id_has_lba</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sectnum</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">lba</span><span class="p">);</span>
			<span class="n">cylinder</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">lba</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>
			<span class="n">head</span> <span class="o">=</span> <span class="n">ATA_ADDRESS_DEVHEAD_LBA_MODE</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">lba</span><span class="o">&gt;&gt;</span><span class="mi">24</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sectnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">lba</span> <span class="o">%</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTORS</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cylinder</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">lba</span> <span class="o">/</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTORS</span><span class="p">]</span> <span class="o">*</span>
					<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HEADS</span><span class="p">]));</span>
			<span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">lba</span> <span class="o">/</span> <span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_SECTORS</span><span class="p">])</span> <span class="o">%</span>
					<span class="n">id</span><span class="p">[</span><span class="n">ATA_ID_HEADS</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte0</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMajorCommand</span><span class="p">;</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte1</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMinorCommand</span><span class="p">;</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">TransferBlockSize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">RegisterSelect</span> <span class="o">=</span>
		  <span class="n">REG_SECTOR_COUNT</span> <span class="o">|</span> <span class="n">REG_SECTOR_NUMBER</span> <span class="o">|</span>
		  <span class="n">REG_CYLINDER_LOW</span> <span class="o">|</span> <span class="n">REG_CYLINDER_HIGH</span> <span class="o">|</span>
		  <span class="n">REG_DEVICE_HEAD</span>  <span class="o">|</span> <span class="n">REG_COMMAND</span><span class="p">;</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">SectorCountByte</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">blockCount</span><span class="p">;</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">SectorNumberByte</span> <span class="o">=</span> <span class="n">sectnum</span><span class="p">;</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">CylinderHighByte</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">cylinder</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">CylinderLowByte</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">cylinder</span><span class="p">;</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">DeviceHeadByte</span> <span class="o">=</span> <span class="p">(</span><span class="n">head</span> <span class="o">|</span> <span class="n">ATA_ADDRESS_DEVHEAD_STD</span><span class="p">);</span>
		<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">CommandByte</span> <span class="o">=</span> <span class="n">ATA_CMD_PIO_WRITE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ALLOW_MEDIUM_REMOVAL</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   ATA OUT - SCSIOP_MEDIUM_REMOVAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">DeviceFlags</span> <span class="o">&amp;</span> <span class="n">DF_REMOVABLE_MEDIA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   srb-&gt;cmnd[4] = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	    
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte0</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMajorCommand</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte1</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMinorCommand</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">TransferBlockSize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">RegisterSelect</span> <span class="o">=</span> <span class="n">REG_COMMAND</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">CommandByte</span> <span class="o">=</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">ATA_CMD_MEDIA_LOCK</span> <span class="o">:</span> <span class="n">ATA_CMD_MEDIA_UNLOCK</span><span class="p">;</span>
			<span class="n">isd200_srb_set_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Not removeable media, just report okay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
			<span class="n">sendToTransport</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">START_STOP</span>:    
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   ATA OUT - SCSIOP_START_STOP_UNIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   srb-&gt;cmnd[4] = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Media Eject</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte0</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMajorCommand</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte1</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMinorCommand</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">TransferBlockSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">RegisterSelect</span> <span class="o">=</span> <span class="n">REG_COMMAND</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">CommandByte</span> <span class="o">=</span> <span class="n">ATA_COMMAND_MEDIA_EJECT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Get Media Status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte0</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMajorCommand</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">SignatureByte1</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ConfigData</span><span class="p">.</span><span class="n">ATAMinorCommand</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">TransferBlockSize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">RegisterSelect</span> <span class="o">=</span> <span class="n">REG_COMMAND</span><span class="p">;</span>
			<span class="n">ataCdb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">.</span><span class="n">CommandByte</span> <span class="o">=</span> <span class="n">ATA_COMMAND_GET_MEDIA_STATUS</span><span class="p">;</span>
			<span class="n">isd200_srb_set_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;   Nothing to do, just report okay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
			<span class="n">sendToTransport</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Unsupported SCSI command - 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">sendToTransport</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">(</span><span class="n">sendToTransport</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**************************************************************************</span>
<span class="cm"> * isd200_free_info</span>
<span class="cm"> *</span>
<span class="cm"> * Frees the driver structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isd200_free_info_ptrs</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info_</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">info_</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">RegsBuf</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">.</span><span class="n">sense_buffer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * isd200_init_info</span>
<span class="cm"> *									 </span>
<span class="cm"> * Allocates (if necessary) and initializes the driver structure.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> *    ISD status code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isd200_init_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_GOOD</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isd200_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">isd200_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_ERROR</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ATA_ID_WORDS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">RegsBuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ATARegs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">.</span><span class="n">sense_buffer</span> <span class="o">=</span>
				<span class="n">kmalloc</span><span class="p">(</span><span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">RegsBuf</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">.</span><span class="n">sense_buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isd200_free_info_ptrs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">retStatus</span> <span class="o">=</span> <span class="n">ISD200_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retStatus</span> <span class="o">==</span> <span class="n">ISD200_GOOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">extra_destructor</span> <span class="o">=</span> <span class="n">isd200_free_info_ptrs</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;ERROR - kmalloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * Initialization for the ISD200 </span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isd200_Initialization</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;ISD200 Initialization...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Initialize ISD200 info struct */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isd200_init_info</span><span class="p">(</span><span class="n">us</span><span class="p">)</span> <span class="o">==</span> <span class="n">ISD200_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;ERROR Initializing ISD200 Info struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Get device specific data */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isd200_get_inquiry_data</span><span class="p">(</span><span class="n">us</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ISD200_GOOD</span><span class="p">)</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;ISD200 Initialization Failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;ISD200 Initialization complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**************************************************************************</span>
<span class="cm"> * Protocol and Transport for the ISD200 ASIC</span>
<span class="cm"> *</span>
<span class="cm"> * This protocol and transport are for ATA devices connected to an ISD200</span>
<span class="cm"> * ASIC.  An ATAPI device that is connected as a slave device will be</span>
<span class="cm"> * detected in the driver initialization function and the protocol will</span>
<span class="cm"> * be changed to an ATAPI protocol (Transparent SCSI).</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isd200_ata_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sendToTransport</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">orig_bufflen</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ata_cdb</span> <span class="n">ataCdb</span><span class="p">;</span>

	<span class="cm">/* Make sure driver was initialized */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;ERROR Driver not initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* scsi_bufflen might change in protocol translation to ata */</span>
	<span class="n">orig_bufflen</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">sendToTransport</span> <span class="o">=</span> <span class="n">isd200_scsi_to_ata</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ataCdb</span><span class="p">);</span>

	<span class="cm">/* send the command to the transport layer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sendToTransport</span><span class="p">)</span>
		<span class="n">isd200_invoke_transport</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">srb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ataCdb</span><span class="p">);</span>

	<span class="n">isd200_srb_set_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">orig_bufflen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isd200_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_stor_probe1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span>
			<span class="p">(</span><span class="n">id</span> <span class="o">-</span> <span class="n">isd200_usb_ids</span><span class="p">)</span> <span class="o">+</span> <span class="n">isd200_unusual_dev_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">us</span><span class="o">-&gt;</span><span class="n">protocol_name</span> <span class="o">=</span> <span class="s">&quot;ISD200 ATA/ATAPI&quot;</span><span class="p">;</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">proto_handler</span> <span class="o">=</span> <span class="n">isd200_ata_command</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_stor_probe2</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">isd200_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;ums-isd200&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">isd200_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span>	<span class="n">usb_stor_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>	<span class="n">usb_stor_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span>	<span class="n">usb_stor_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_resume</span> <span class="o">=</span>	<span class="n">usb_stor_reset_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pre_reset</span> <span class="o">=</span>	<span class="n">usb_stor_pre_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">post_reset</span> <span class="o">=</span>	<span class="n">usb_stor_post_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">isd200_usb_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">soft_unbind</span> <span class="o">=</span>	<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">no_dynamic_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">isd200_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
