<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › storage › realtek_cr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>realtek_cr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Driver for Realtek RTS51xx USB card reader</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2009 Realtek Semiconductor Corp. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2, or (at your option) any</span>
<span class="cm"> * later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:</span>
<span class="cm"> *   wwang (wei_wang@realsil.com.cn)</span>
<span class="cm"> *   No. 450, Shenhu Road, Suzhou Industry Park, Suzhou, China</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;linux/cdrom.h&gt;</span>

<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/usb_usual.h&gt;</span>

<span class="cp">#include &quot;usb.h&quot;</span>
<span class="cp">#include &quot;transport.h&quot;</span>
<span class="cp">#include &quot;protocol.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for Realtek USB Card Reader&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;wwang &lt;wei_wang@realsil.com.cn&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;1.03&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">auto_delink_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">auto_delink_en</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">auto_delink_en</span><span class="p">,</span> <span class="s">&quot;enable auto delink&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_REALTEK_AUTOPM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ss_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ss_en</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ss_en</span><span class="p">,</span> <span class="s">&quot;enable selective suspend&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ss_delay</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ss_delay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ss_delay</span><span class="p">,</span>
		 <span class="s">&quot;seconds to delay before entering selective suspend&quot;</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">RTS51X_STAT</span> <span class="p">{</span>
	<span class="n">RTS51X_STAT_INIT</span><span class="p">,</span>
	<span class="n">RTS51X_STAT_IDLE</span><span class="p">,</span>
	<span class="n">RTS51X_STAT_RUN</span><span class="p">,</span>
	<span class="n">RTS51X_STAT_SS</span>
<span class="p">};</span>

<span class="cp">#define POLLING_INTERVAL	50</span>

<span class="cp">#define rts51x_set_stat(chip, stat)	\</span>
<span class="cp">	((chip)-&gt;state = (enum RTS51X_STAT)(stat))</span>
<span class="cp">#define rts51x_get_stat(chip)		((chip)-&gt;state)</span>

<span class="cp">#define SET_LUN_READY(chip, lun)	((chip)-&gt;lun_ready |= ((u8)1 &lt;&lt; (lun)))</span>
<span class="cp">#define CLR_LUN_READY(chip, lun)	((chip)-&gt;lun_ready &amp;= ~((u8)1 &lt;&lt; (lun)))</span>
<span class="cp">#define TST_LUN_READY(chip, lun)	((chip)-&gt;lun_ready &amp; ((u8)1 &lt;&lt; (lun)))</span>

<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">rts51x_status</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">vid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cur_lun</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">card_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">total_lun</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fw_ver</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_exist</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">multi_flag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">multi_card</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">log_exist</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">detailed_type1</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">detailed_type2</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">detailed_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">vendor_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">product_id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">max_lun</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rts51x_status</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status_len</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">flag</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_REALTEK_AUTOPM</span>
	<span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">rts51x_suspend_timer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timer_expires</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pwr_state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lun_ready</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">RTS51X_STAT</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">support_auto_delink</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* used to back up the protocal choosen in probe1 phase */</span>
	<span class="n">proto_cmnd</span> <span class="n">proto_handler_backup</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* flag definition */</span>
<span class="cp">#define FLIDX_AUTO_DELINK		0x01</span>

<span class="cp">#define SCSI_LUN(srb)			((srb)-&gt;device-&gt;lun)</span>

<span class="cm">/* Bit Operation */</span>
<span class="cp">#define SET_BIT(data, idx)		((data) |= 1 &lt;&lt; (idx))</span>
<span class="cp">#define CLR_BIT(data, idx)		((data) &amp;= ~(1 &lt;&lt; (idx)))</span>
<span class="cp">#define CHK_BIT(data, idx)		((data) &amp; (1 &lt;&lt; (idx)))</span>

<span class="cp">#define SET_AUTO_DELINK(chip)		((chip)-&gt;flag |= FLIDX_AUTO_DELINK)</span>
<span class="cp">#define CLR_AUTO_DELINK(chip)		((chip)-&gt;flag &amp;= ~FLIDX_AUTO_DELINK)</span>
<span class="cp">#define CHK_AUTO_DELINK(chip)		((chip)-&gt;flag &amp; FLIDX_AUTO_DELINK)</span>

<span class="cp">#define RTS51X_GET_VID(chip)		((chip)-&gt;vendor_id)</span>
<span class="cp">#define RTS51X_GET_PID(chip)		((chip)-&gt;product_id)</span>

<span class="cp">#define VENDOR_ID(chip)			((chip)-&gt;status[0].vid)</span>
<span class="cp">#define PRODUCT_ID(chip)		((chip)-&gt;status[0].pid)</span>
<span class="cp">#define FW_VERSION(chip)		((chip)-&gt;status[0].fw_ver)</span>
<span class="cp">#define STATUS_LEN(chip)		((chip)-&gt;status_len)</span>

<span class="cp">#define STATUS_SUCCESS		0</span>
<span class="cp">#define STATUS_FAIL		1</span>

<span class="cm">/* Check card reader function */</span>
<span class="cp">#define SUPPORT_DETAILED_TYPE1(chip)	\</span>
<span class="cp">		CHK_BIT((chip)-&gt;status[0].function[0], 1)</span>
<span class="cp">#define SUPPORT_OT(chip)		\</span>
<span class="cp">		CHK_BIT((chip)-&gt;status[0].function[0], 2)</span>
<span class="cp">#define SUPPORT_OC(chip)		\</span>
<span class="cp">		CHK_BIT((chip)-&gt;status[0].function[0], 3)</span>
<span class="cp">#define SUPPORT_AUTO_DELINK(chip)	\</span>
<span class="cp">		CHK_BIT((chip)-&gt;status[0].function[0], 4)</span>
<span class="cp">#define SUPPORT_SDIO(chip)		\</span>
<span class="cp">		CHK_BIT((chip)-&gt;status[0].function[1], 0)</span>
<span class="cp">#define SUPPORT_DETAILED_TYPE2(chip)	\</span>
<span class="cp">		CHK_BIT((chip)-&gt;status[0].function[1], 1)</span>

<span class="cp">#define CHECK_PID(chip, pid)		(RTS51X_GET_PID(chip) == (pid))</span>
<span class="cp">#define CHECK_FW_VER(chip, fw_ver)	(FW_VERSION(chip) == (fw_ver))</span>
<span class="cp">#define CHECK_ID(chip, pid, fw_ver)	\</span>
<span class="cp">		(CHECK_PID((chip), (pid)) &amp;&amp; CHECK_FW_VER((chip), (fw_ver)))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">init_realtek_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The table of devices</span>
<span class="cm"> */</span>
<span class="cp">#define UNUSUAL_DEV(id_vendor, id_product, bcdDeviceMin, bcdDeviceMax, \</span>
<span class="cp">		    vendorName, productName, useProtocol, useTransport, \</span>
<span class="cp">		    initFunction, flags) \</span>
<span class="cp">{\</span>
<span class="cp">	USB_DEVICE_VER(id_vendor, id_product, bcdDeviceMin, bcdDeviceMax), \</span>
<span class="cp">	.driver_info = (flags)|(USB_US_TYPE_STOR&lt;&lt;24)\</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">realtek_cr_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#	include &quot;unusual_realtek.h&quot;</span>
	<span class="p">{}</span>			<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">realtek_cr_ids</span><span class="p">);</span>

<span class="cp">#undef UNUSUAL_DEV</span>

<span class="cm">/*</span>
<span class="cm"> * The flags table</span>
<span class="cm"> */</span>
<span class="cp">#define UNUSUAL_DEV(idVendor, idProduct, bcdDeviceMin, bcdDeviceMax, \</span>
<span class="cp">		    vendor_name, product_name, use_protocol, use_transport, \</span>
<span class="cp">		    init_function, Flags) \</span>
<span class="cp">{ \</span>
<span class="cp">	.vendorName = vendor_name,	\</span>
<span class="cp">	.productName = product_name,	\</span>
<span class="cp">	.useProtocol = use_protocol,	\</span>
<span class="cp">	.useTransport = use_transport,	\</span>
<span class="cp">	.initFunction = init_function,	\</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">us_unusual_dev</span> <span class="n">realtek_cr_unusual_dev_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#	include &quot;unusual_realtek.h&quot;</span>
	<span class="p">{}</span>			<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="cp">#undef UNUSUAL_DEV</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rts51x_bulk_transport</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lun</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">act_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bulk_cb_wrap</span> <span class="o">*</span><span class="n">bcb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bulk_cb_wrap</span> <span class="o">*</span><span class="p">)</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bulk_cs_wrap</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bulk_cs_wrap</span> <span class="o">*</span><span class="p">)</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">residue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cswlen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbwlen</span> <span class="o">=</span> <span class="n">US_BULK_CB_WRAP_LEN</span><span class="p">;</span>

	<span class="cm">/* set up the command wrapper */</span>
	<span class="n">bcb</span><span class="o">-&gt;</span><span class="n">Signature</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">US_BULK_CB_SIGN</span><span class="p">);</span>
	<span class="n">bcb</span><span class="o">-&gt;</span><span class="n">DataTransferLength</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">buf_len</span><span class="p">);</span>
	<span class="n">bcb</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="o">?</span> <span class="n">US_BULK_FLAG_IN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bcb</span><span class="o">-&gt;</span><span class="n">Tag</span> <span class="o">=</span> <span class="o">++</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
	<span class="n">bcb</span><span class="o">-&gt;</span><span class="n">Lun</span> <span class="o">=</span> <span class="n">lun</span><span class="p">;</span>
	<span class="n">bcb</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">=</span> <span class="n">cmd_len</span><span class="p">;</span>

	<span class="cm">/* copy the command payload */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">bcb</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bcb</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bcb</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">bcb</span><span class="o">-&gt;</span><span class="n">Length</span><span class="p">);</span>

	<span class="cm">/* send it to out endpoint */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_stor_bulk_transfer_buf</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">send_bulk_pipe</span><span class="p">,</span>
					    <span class="n">bcb</span><span class="p">,</span> <span class="n">cbwlen</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">USB_STOR_XFER_GOOD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">USB_STOR_TRANSPORT_ERROR</span><span class="p">;</span>

	<span class="cm">/* DATA STAGE */</span>
	<span class="cm">/* send/receive data payload, if there is any */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">us</span><span class="o">-&gt;</span><span class="n">recv_bulk_pipe</span> <span class="o">:</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">send_bulk_pipe</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">usb_stor_bulk_transfer_buf</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span>
						    <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">USB_STOR_XFER_ERROR</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">USB_STOR_TRANSPORT_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get CSW for device status */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_stor_bulk_transfer_buf</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">recv_bulk_pipe</span><span class="p">,</span>
					    <span class="n">bcs</span><span class="p">,</span> <span class="n">US_BULK_CS_WRAP_LEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cswlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">USB_STOR_XFER_GOOD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">USB_STOR_TRANSPORT_ERROR</span><span class="p">;</span>

	<span class="cm">/* check bulk status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Signature</span> <span class="o">!=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">US_BULK_CS_SIGN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Signature mismatch: got %08X, expecting %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">),</span> <span class="n">US_BULK_CS_SIGN</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">USB_STOR_TRANSPORT_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">residue</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Residue</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Tag</span> <span class="o">!=</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">USB_STOR_TRANSPORT_ERROR</span><span class="p">;</span>

	<span class="cm">/* try to compute the actual residue, based on how much data</span>
<span class="cm">	 * was really transferred and what the device tells us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">residue</span><span class="p">)</span>
		<span class="n">residue</span> <span class="o">=</span> <span class="n">residue</span> <span class="o">&lt;</span> <span class="n">buf_len</span> <span class="o">?</span> <span class="n">residue</span> <span class="o">:</span> <span class="n">buf_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">act_len</span><span class="p">)</span>
		<span class="o">*</span><span class="n">act_len</span> <span class="o">=</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">residue</span><span class="p">;</span>

	<span class="cm">/* based on the status code, we report good or bad */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">US_BULK_STAT_OK</span>:
		<span class="cm">/* command good -- note that data could be short */</span>
		<span class="k">return</span> <span class="n">USB_STOR_TRANSPORT_GOOD</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">US_BULK_STAT_FAIL</span>:
		<span class="cm">/* command failed */</span>
		<span class="k">return</span> <span class="n">USB_STOR_TRANSPORT_FAILED</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">US_BULK_STAT_PHASE</span>:
		<span class="cm">/* phase error -- note that a transport reset will be</span>
<span class="cm">		 * invoked by the invoke_transport() function</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">USB_STOR_TRANSPORT_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we should never get here, but if we do, we&#39;re in trouble */</span>
	<span class="k">return</span> <span class="n">USB_STOR_TRANSPORT_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rts51x_bulk_transport_special</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lun</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">act_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bulk_cb_wrap</span> <span class="o">*</span><span class="n">bcb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bulk_cb_wrap</span> <span class="o">*</span><span class="p">)</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bulk_cs_wrap</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bulk_cs_wrap</span> <span class="o">*</span><span class="p">)</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cswlen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbwlen</span> <span class="o">=</span> <span class="n">US_BULK_CB_WRAP_LEN</span><span class="p">;</span>

	<span class="cm">/* set up the command wrapper */</span>
	<span class="n">bcb</span><span class="o">-&gt;</span><span class="n">Signature</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">US_BULK_CB_SIGN</span><span class="p">);</span>
	<span class="n">bcb</span><span class="o">-&gt;</span><span class="n">DataTransferLength</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">buf_len</span><span class="p">);</span>
	<span class="n">bcb</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="o">?</span> <span class="n">US_BULK_FLAG_IN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bcb</span><span class="o">-&gt;</span><span class="n">Tag</span> <span class="o">=</span> <span class="o">++</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
	<span class="n">bcb</span><span class="o">-&gt;</span><span class="n">Lun</span> <span class="o">=</span> <span class="n">lun</span><span class="p">;</span>
	<span class="n">bcb</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">=</span> <span class="n">cmd_len</span><span class="p">;</span>

	<span class="cm">/* copy the command payload */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">bcb</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bcb</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bcb</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">bcb</span><span class="o">-&gt;</span><span class="n">Length</span><span class="p">);</span>

	<span class="cm">/* send it to out endpoint */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_stor_bulk_transfer_buf</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">send_bulk_pipe</span><span class="p">,</span>
				<span class="n">bcb</span><span class="p">,</span> <span class="n">cbwlen</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">USB_STOR_XFER_GOOD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">USB_STOR_TRANSPORT_ERROR</span><span class="p">;</span>

	<span class="cm">/* DATA STAGE */</span>
	<span class="cm">/* send/receive data payload, if there is any */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">us</span><span class="o">-&gt;</span><span class="n">recv_bulk_pipe</span> <span class="o">:</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">send_bulk_pipe</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">usb_stor_bulk_transfer_buf</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span>
				<span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">USB_STOR_XFER_ERROR</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">USB_STOR_TRANSPORT_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get CSW for device status */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">recv_bulk_pipe</span><span class="p">,</span> <span class="n">bcs</span><span class="p">,</span>
			<span class="n">US_BULK_CS_WRAP_LEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cswlen</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Determine what the maximum LUN supported is */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rts51x_get_max_lun</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* issue the command */</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_stor_control_msg</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">recv_ctrl_pipe</span><span class="p">,</span>
				      <span class="n">US_BULK_GET_MAX_LUN</span><span class="p">,</span>
				      <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span>
				      <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
				      <span class="mi">0</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">ifnum</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;GetMaxLUN command result is %d, data is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">result</span><span class="p">,</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* if we have a successful request, return the result */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">iobuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rts51x_read_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmnd</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">USB_STOR_TRANSPORT_ERROR</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s, addr = 0x%x, len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF0</span><span class="p">;</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0D</span><span class="p">;</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_bulk_transport</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>
				       <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">USB_STOR_TRANSPORT_GOOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rts51x_write_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmnd</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">USB_STOR_TRANSPORT_ERROR</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s, addr = 0x%x, len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF0</span><span class="p">;</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0E</span><span class="p">;</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_bulk_transport</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>
				       <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">USB_STOR_TRANSPORT_GOOD</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rts51x_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">lun</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">actlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmnd</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">USB_STOR_TRANSPORT_ERROR</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s, lun = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>

	<span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF0</span><span class="p">;</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_bulk_transport</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>
				       <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span> <span class="n">actlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">USB_STOR_TRANSPORT_GOOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rts51x_check_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="p">)(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_read_status</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">status_len</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;status_len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">status_len</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">lun</span><span class="p">].</span><span class="n">vid</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">lun</span><span class="p">].</span><span class="n">pid</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">lun</span><span class="p">].</span><span class="n">cur_lun</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">lun</span><span class="p">].</span><span class="n">card_type</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">lun</span><span class="p">].</span><span class="n">total_lun</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">lun</span><span class="p">].</span><span class="n">fw_ver</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">lun</span><span class="p">].</span><span class="n">phy_exist</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">lun</span><span class="p">].</span><span class="n">multi_flag</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">lun</span><span class="p">].</span><span class="n">multi_card</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">lun</span><span class="p">].</span><span class="n">log_exist</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">status_len</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">lun</span><span class="p">].</span><span class="n">detailed_type</span><span class="p">.</span><span class="n">detailed_type1</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">lun</span><span class="p">].</span><span class="n">function</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="n">lun</span><span class="p">].</span><span class="n">function</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enable_oscillator</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_read_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xFE77</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_write_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xFE77</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_read_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xFE77</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__do_config_autodelink</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmnd</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s, addr = 0xfe47, len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">USB_STOR_TRANSPORT_ERROR</span><span class="p">;</span>

	<span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF0</span><span class="p">;</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0E</span><span class="p">;</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x47</span><span class="p">;</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">len</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_bulk_transport_special</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">USB_STOR_TRANSPORT_GOOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_config_autodelink</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_read_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xFE47</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">force</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;In %s,set 0xfe47 to 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* retval = rts51x_write_mem(us, 0xFE47, &amp;value, 1); */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">__do_config_autodelink</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">config_autodelink_after_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="p">)(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: &lt;---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHK_AUTO_DELINK</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_read_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xFE47</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">auto_delink_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CLR_BIT</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">CLR_BIT</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">SET_BIT</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0138</span><span class="p">,</span> <span class="mh">0x3882</span><span class="p">))</span>
			<span class="n">CLR_BIT</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">SET_BIT</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

		<span class="cm">/* retval = rts51x_write_mem(us, 0xFE47, &amp;value, 1); */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">__do_config_autodelink</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">enable_oscillator</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">do_config_autodelink</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Autodelink controlled by firmware */</span>

		<span class="n">SET_BIT</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0138</span><span class="p">,</span> <span class="mh">0x3882</span><span class="p">))</span>
			<span class="n">CLR_BIT</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0159</span><span class="p">,</span> <span class="mh">0x5889</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">CHECK_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0138</span><span class="p">,</span> <span class="mh">0x3880</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">CLR_BIT</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">CLR_BIT</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* retval = rts51x_write_mem(us, 0xFE47, &amp;value, 1); */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">__do_config_autodelink</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0159</span><span class="p">,</span> <span class="mh">0x5888</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_write_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xFE79</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

			<span class="n">value</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_write_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: ---&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">config_autodelink_before_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="p">)(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: &lt;---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHK_AUTO_DELINK</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">auto_delink_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_read_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xFE77</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">SET_BIT</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_write_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xFE77</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0159</span><span class="p">,</span> <span class="mh">0x5888</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_write_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_read_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xFE47</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">SET_BIT</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0138</span><span class="p">,</span> <span class="mh">0x3882</span><span class="p">))</span>
			<span class="n">SET_BIT</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_write_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xFE77</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0159</span><span class="p">,</span> <span class="mh">0x5889</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">CHECK_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0138</span><span class="p">,</span> <span class="mh">0x3880</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">CHECK_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0138</span><span class="p">,</span> <span class="mh">0x3882</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_read_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xFE47</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0159</span><span class="p">,</span> <span class="mh">0x5889</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">CHECK_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0138</span><span class="p">,</span> <span class="mh">0x3880</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">SET_BIT</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">SET_BIT</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0138</span><span class="p">,</span> <span class="mh">0x3882</span><span class="p">))</span>
				<span class="n">SET_BIT</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

			<span class="cm">/* retval = rts51x_write_mem(us, 0xFE47, &amp;value, 1); */</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">__do_config_autodelink</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0159</span><span class="p">,</span> <span class="mh">0x5888</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_write_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: ---&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fw5895_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="p">)(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: &lt;---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">PRODUCT_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0158</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">FW_VERSION</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x5895</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Not the specified device, return immediately!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_read_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xFD6F</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_write_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xFD70</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Write memory fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Read memory fail, OR (val &amp; 0x1F) != 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: ---&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_REALTEK_AUTOPM</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fw5895_set_mmc_wp</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="p">)(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: &lt;---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">PRODUCT_ID</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0158</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">FW_VERSION</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x5895</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Not the specified device, return immediately!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_read_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xFD6F</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x24</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x24</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* SD Exist and SD WP */</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_read_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xD04E</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_write_mem</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mh">0xFD70</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
					<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Write memory fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Read memory fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Read memory fail, OR (buf[0]&amp;0x24)!=0x24</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: ---&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rts51x_modi_suspend_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: &lt;---, state:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rts51x_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer_expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">ss_delay</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rts51x_suspend_timer</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer_expires</span><span class="p">);</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: ---&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rts51x_suspend_timer_fn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">us</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: &lt;---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rts51x_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTS51X_STAT_INIT</span>:
	<span class="k">case</span> <span class="n">RTS51X_STAT_RUN</span>:
		<span class="n">rts51x_modi_suspend_timer</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTS51X_STAT_IDLE</span>:
	<span class="k">case</span> <span class="n">RTS51X_STAT_SS</span>:
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: RTS51X_STAT_SS, intf-&gt;pm_usage_cnt:%d,&quot;</span>
			<span class="s">&quot;power.usage:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_intf</span><span class="o">-&gt;</span><span class="n">pm_usage_cnt</span><span class="p">),</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_intf</span><span class="o">-&gt;</span><span class="n">pm_usage_cnt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: Ready to enter SS state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">);</span>
			<span class="n">rts51x_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTS51X_STAT_SS</span><span class="p">);</span>
			<span class="cm">/* ignore mass storage interface&#39;s children */</span>
			<span class="n">pm_suspend_ignore_children</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">usb_autopm_put_interface_async</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_intf</span><span class="p">);</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: RTS51X_STAT_SS 01,&quot;</span>
				<span class="s">&quot;intf-&gt;pm_usage_cnt:%d, power.usage:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_intf</span><span class="o">-&gt;</span><span class="n">pm_usage_cnt</span><span class="p">),</span>
				<span class="n">atomic_read</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: Unknonwn state !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: ---&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">working_scsi</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">TEST_UNIT_READY</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ALLOW_MEDIUM_REMOVAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rts51x_invoke_transport</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="p">)(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">card_first_show</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">media_not_present</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">invalid_cmd_field</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: &lt;---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">working_scsi</span><span class="p">(</span><span class="n">srb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: working scsi, intf-&gt;pm_usage_cnt:%d,&quot;</span>
			<span class="s">&quot;power.usage:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_intf</span><span class="o">-&gt;</span><span class="n">pm_usage_cnt</span><span class="p">),</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_intf</span><span class="o">-&gt;</span><span class="n">pm_usage_cnt</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_autopm_get_interface</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_intf</span><span class="p">);</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: working scsi, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rts51x_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">!=</span> <span class="n">RTS51X_STAT_RUN</span><span class="p">)</span>
			<span class="n">rts51x_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTS51X_STAT_RUN</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">proto_handler_backup</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">us</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rts51x_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTS51X_STAT_SS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: NOT working scsi</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">TEST_UNIT_READY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pwr_state</span> <span class="o">==</span> <span class="n">US_SUSPEND</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">TST_LUN_READY</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span>
					       <span class="n">media_not_present</span><span class="p">,</span>
					       <span class="n">US_SENSE_SIZE</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: TEST_UNIT_READY---&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ALLOW_MEDIUM_REMOVAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">prevent</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">prevent</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span>
					       <span class="n">invalid_cmd_field</span><span class="p">,</span>
					       <span class="n">US_SENSE_SIZE</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: ALLOW_MEDIUM_REMOVAL---&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: NOT working scsi, not SS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">proto_handler_backup</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">us</span><span class="p">);</span>
			<span class="cm">/* Check wether card is plugged in */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">TEST_UNIT_READY</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">==</span> <span class="n">SAM_STAT_GOOD</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">SET_LUN_READY</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">card_first_show</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">card_first_show</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">fw5895_set_mmc_wp</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">CLR_LUN_READY</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
					<span class="n">card_first_show</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rts51x_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">!=</span> <span class="n">RTS51X_STAT_IDLE</span><span class="p">)</span>
				<span class="n">rts51x_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTS51X_STAT_IDLE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: state:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rts51x_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rts51x_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTS51X_STAT_RUN</span><span class="p">)</span>
		<span class="n">rts51x_modi_suspend_timer</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: ---&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">realtek_cr_autosuspend_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rts51x_status</span> <span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="p">)</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">support_auto_delink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pwr_state</span> <span class="o">=</span> <span class="n">US_RESUME</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rts51x_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTS51X_STAT_INIT</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_read_status</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">status_len</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Read status fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">vid</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">cur_lun</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">total_lun</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">phy_exist</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">multi_flag</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">multi_card</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">log_exist</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">status_len</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">detailed_type</span><span class="p">.</span><span class="n">detailed_type1</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* back up the proto_handler in us-&gt;extra */</span>
	<span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="p">)(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">proto_handler_backup</span> <span class="o">=</span> <span class="n">us</span><span class="o">-&gt;</span><span class="n">proto_handler</span><span class="p">;</span>
	<span class="cm">/* Set the autosuspend_delay to 0 */</span>
	<span class="n">pm_runtime_set_autosuspend_delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* override us-&gt;proto_handler setted in get_protocol() */</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">proto_handler</span> <span class="o">=</span> <span class="n">rts51x_invoke_transport</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer_expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rts51x_suspend_timer</span><span class="p">,</span> <span class="n">rts51x_suspend_timer_fn</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">fw5895_init</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>

	<span class="cm">/* enable autosuspend funciton of the usb device */</span>
	<span class="n">usb_enable_autosuspend</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">pusb_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">realtek_cr_destructor</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: &lt;---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_REALTEK_AUTOPM</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ss_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rts51x_suspend_timer</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer_expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">realtek_cr_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: &lt;---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* wait until no command is running */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dev_mutex</span><span class="p">);</span>

	<span class="n">config_autodelink_before_power_down</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">dev_mutex</span><span class="p">);</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: ---&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">realtek_cr_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: &lt;---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">fw5895_init</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="n">config_autodelink_after_power_on</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s: ---&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define realtek_cr_suspend	NULL</span>
<span class="cp">#define realtek_cr_resume	NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_realtek_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">extra_destructor</span> <span class="o">=</span> <span class="n">realtek_cr_destructor</span><span class="p">;</span>
	<span class="n">us</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">rts51x_get_max_lun</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;max_lun = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_lun</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_status</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">INIT_FAIL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_lun</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_check_status</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">INIT_FAIL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_FW_VER</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5888</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHECK_FW_VER</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5889</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">CHECK_FW_VER</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5901</span><span class="p">))</span>
		<span class="n">SET_AUTO_DELINK</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">STATUS_LEN</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SUPPORT_AUTO_DELINK</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
			<span class="n">SET_AUTO_DELINK</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_REALTEK_AUTOPM</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ss_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">us</span> <span class="o">=</span> <span class="n">us</span><span class="p">;</span>
		<span class="n">realtek_cr_autosuspend_setup</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;flag = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">config_autodelink_after_power_on</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">INIT_FAIL:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>
		<span class="n">us</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">realtek_cr_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">us_data</span> <span class="o">*</span><span class="n">us</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">US_DEBUGP</span><span class="p">(</span><span class="s">&quot;Probe Realtek Card Reader!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_stor_probe1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">us</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">id</span> <span class="o">-</span> <span class="n">realtek_cr_ids</span><span class="p">)</span> <span class="o">+</span>
				 <span class="n">realtek_cr_unusual_dev_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_stor_probe2</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">realtek_cr_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ums-realtek&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">realtek_cr_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">usb_stor_disconnect</span><span class="p">,</span>
	<span class="cm">/* .suspend =      usb_stor_suspend, */</span>
	<span class="cm">/* .resume =       usb_stor_resume, */</span>
	<span class="p">.</span><span class="n">reset_resume</span> <span class="o">=</span> <span class="n">usb_stor_reset_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">realtek_cr_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">realtek_cr_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pre_reset</span> <span class="o">=</span> <span class="n">usb_stor_pre_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">post_reset</span> <span class="o">=</span> <span class="n">usb_stor_post_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">realtek_cr_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">soft_unbind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supports_autosuspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">no_dynamic_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">realtek_cr_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
