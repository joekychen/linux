<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › atm › ueagle-atm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ueagle-atm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*-</span>
<span class="cm"> * Copyright (c) 2003, 2004</span>
<span class="cm"> *	Damien Bergamini &lt;damien.bergamini@free.fr&gt;. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2005-2007 Matthieu Castet &lt;castet.matthieu@free.fr&gt;</span>
<span class="cm"> * Copyright (c) 2005-2007 Stanislaw Gruszka &lt;stf_xl@wp.pl&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses. You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the</span>
<span class="cm"> * BSD license below:</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice unmodified, this list of conditions, and the following</span>
<span class="cm"> *    disclaimer.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *    documentation and/or other materials provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&#39;&#39; AND</span>
<span class="cm"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE</span>
<span class="cm"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<span class="cm"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<span class="cm"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<span class="cm"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<span class="cm"> * SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> * GPL license :</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * HISTORY : some part of the code was base on ueagle 1.3 BSD driver,</span>
<span class="cm"> * Damien Bergamini agree to put his code under a DUAL GPL/BSD license.</span>
<span class="cm"> *</span>
<span class="cm"> * The rest of the code was was rewritten from scratch.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>

<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;usbatm.h&quot;</span>

<span class="cp">#define EAGLEUSBVERSION &quot;ueagle 1.4&quot;</span>


<span class="cm">/*</span>
<span class="cm"> * Debug macros</span>
<span class="cm"> */</span>
<span class="cp">#define uea_dbg(usb_dev, format, args...)	\</span>
<span class="cp">	do { \</span>
<span class="cp">		if (debug &gt;= 1) \</span>
<span class="cp">			dev_dbg(&amp;(usb_dev)-&gt;dev, \</span>
<span class="cp">				&quot;[ueagle-atm dbg] %s: &quot; format, \</span>
<span class="cp">					__func__, ##args); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define uea_vdbg(usb_dev, format, args...)	\</span>
<span class="cp">	do { \</span>
<span class="cp">		if (debug &gt;= 2) \</span>
<span class="cp">			dev_dbg(&amp;(usb_dev)-&gt;dev, \</span>
<span class="cp">				&quot;[ueagle-atm vdbg]  &quot; format, ##args); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define uea_enters(usb_dev) \</span>
<span class="cp">	uea_vdbg(usb_dev, &quot;entering %s\n&quot; , __func__)</span>

<span class="cp">#define uea_leaves(usb_dev) \</span>
<span class="cp">	uea_vdbg(usb_dev, &quot;leaving  %s\n&quot; , __func__)</span>

<span class="cp">#define uea_err(usb_dev, format, args...) \</span>
<span class="cp">	dev_err(&amp;(usb_dev)-&gt;dev , &quot;[UEAGLE-ATM] &quot; format , ##args)</span>

<span class="cp">#define uea_warn(usb_dev, format, args...) \</span>
<span class="cp">	dev_warn(&amp;(usb_dev)-&gt;dev , &quot;[Ueagle-atm] &quot; format, ##args)</span>

<span class="cp">#define uea_info(usb_dev, format, args...) \</span>
<span class="cp">	dev_info(&amp;(usb_dev)-&gt;dev , &quot;[ueagle-atm] &quot; format, ##args)</span>

<span class="k">struct</span> <span class="n">intr_pkt</span><span class="p">;</span>

<span class="cm">/* cmv&#39;s from firmware */</span>
<span class="k">struct</span> <span class="n">uea_cmvs_v1</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">uea_cmvs_v2</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">group</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* information about currently processed cmv */</span>
<span class="k">struct</span> <span class="n">cmv_dsc_e1</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cmv_dsc_e4</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">function</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">group</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">cmv_dsc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmv_dsc_e1</span> <span class="n">e1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmv_dsc_e4</span> <span class="n">e4</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">uea_softc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">modem_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">driver_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">annex</span><span class="p">;</span>
<span class="cp">#define ANNEXA 0</span>
<span class="cp">#define ANNEXB 1</span>

	<span class="kt">int</span> <span class="n">booting</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reset</span><span class="p">;</span>

	<span class="n">wait_queue_head_t</span> <span class="n">sync_q</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">kthread</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data1</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">cmv_ack</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">cmv_dsc</span> <span class="n">cmv_dsc</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">task</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pageno</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ovl</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">dsp_firm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb_int</span><span class="p">;</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">dispatch_cmv</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">intr_pkt</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">schedule_load_page</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">intr_pkt</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">stat</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">send_cmvs</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="p">);</span>

	<span class="cm">/* keep in sync with eaglectl */</span>
	<span class="k">struct</span> <span class="n">uea_stats</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">mflags</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">vidcpe</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">vidco</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">dsrate</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">usrate</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">dsunc</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">usunc</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">dscorr</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">uscorr</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">txflow</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">rxflow</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">usattenuation</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">dsattenuation</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">dsmargin</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">usmargin</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">firmid</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">phy</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Elsa IDs</span>
<span class="cm"> */</span>
<span class="cp">#define ELSA_VID		0x05CC</span>
<span class="cp">#define ELSA_PID_PSTFIRM	0x3350</span>
<span class="cp">#define ELSA_PID_PREFIRM	0x3351</span>

<span class="cp">#define ELSA_PID_A_PREFIRM	0x3352</span>
<span class="cp">#define ELSA_PID_A_PSTFIRM	0x3353</span>
<span class="cp">#define ELSA_PID_B_PREFIRM	0x3362</span>
<span class="cp">#define ELSA_PID_B_PSTFIRM	0x3363</span>

<span class="cm">/*</span>
<span class="cm"> * Devolo IDs : pots if (pid &amp; 0x10)</span>
<span class="cm"> */</span>
<span class="cp">#define DEVOLO_VID			0x1039</span>
<span class="cp">#define DEVOLO_EAGLE_I_A_PID_PSTFIRM	0x2110</span>
<span class="cp">#define DEVOLO_EAGLE_I_A_PID_PREFIRM	0x2111</span>

<span class="cp">#define DEVOLO_EAGLE_I_B_PID_PSTFIRM	0x2100</span>
<span class="cp">#define DEVOLO_EAGLE_I_B_PID_PREFIRM	0x2101</span>

<span class="cp">#define DEVOLO_EAGLE_II_A_PID_PSTFIRM	0x2130</span>
<span class="cp">#define DEVOLO_EAGLE_II_A_PID_PREFIRM	0x2131</span>

<span class="cp">#define DEVOLO_EAGLE_II_B_PID_PSTFIRM	0x2120</span>
<span class="cp">#define DEVOLO_EAGLE_II_B_PID_PREFIRM	0x2121</span>

<span class="cm">/*</span>
<span class="cm"> * Reference design USB IDs</span>
<span class="cm"> */</span>
<span class="cp">#define ANALOG_VID		0x1110</span>
<span class="cp">#define ADI930_PID_PREFIRM	0x9001</span>
<span class="cp">#define ADI930_PID_PSTFIRM	0x9000</span>

<span class="cp">#define EAGLE_I_PID_PREFIRM	0x9010	</span><span class="cm">/* Eagle I */</span><span class="cp"></span>
<span class="cp">#define EAGLE_I_PID_PSTFIRM	0x900F	</span><span class="cm">/* Eagle I */</span><span class="cp"></span>

<span class="cp">#define EAGLE_IIC_PID_PREFIRM	0x9024	</span><span class="cm">/* Eagle IIC */</span><span class="cp"></span>
<span class="cp">#define EAGLE_IIC_PID_PSTFIRM	0x9023	</span><span class="cm">/* Eagle IIC */</span><span class="cp"></span>

<span class="cp">#define EAGLE_II_PID_PREFIRM	0x9022	</span><span class="cm">/* Eagle II */</span><span class="cp"></span>
<span class="cp">#define EAGLE_II_PID_PSTFIRM	0x9021	</span><span class="cm">/* Eagle II */</span><span class="cp"></span>

<span class="cp">#define EAGLE_III_PID_PREFIRM	0x9032	</span><span class="cm">/* Eagle III */</span><span class="cp"></span>
<span class="cp">#define EAGLE_III_PID_PSTFIRM	0x9031	</span><span class="cm">/* Eagle III */</span><span class="cp"></span>

<span class="cp">#define EAGLE_IV_PID_PREFIRM	0x9042  </span><span class="cm">/* Eagle IV */</span><span class="cp"></span>
<span class="cp">#define EAGLE_IV_PID_PSTFIRM	0x9041  </span><span class="cm">/* Eagle IV */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * USR USB IDs</span>
<span class="cm"> */</span>
<span class="cp">#define USR_VID			0x0BAF</span>
<span class="cp">#define MILLER_A_PID_PREFIRM	0x00F2</span>
<span class="cp">#define MILLER_A_PID_PSTFIRM	0x00F1</span>
<span class="cp">#define MILLER_B_PID_PREFIRM	0x00FA</span>
<span class="cp">#define MILLER_B_PID_PSTFIRM	0x00F9</span>
<span class="cp">#define HEINEKEN_A_PID_PREFIRM	0x00F6</span>
<span class="cp">#define HEINEKEN_A_PID_PSTFIRM	0x00F5</span>
<span class="cp">#define HEINEKEN_B_PID_PREFIRM	0x00F8</span>
<span class="cp">#define HEINEKEN_B_PID_PSTFIRM	0x00F7</span>

<span class="cp">#define PREFIRM 0</span>
<span class="cp">#define PSTFIRM (1&lt;&lt;7)</span>
<span class="cp">#define AUTO_ANNEX_A (1&lt;&lt;8)</span>
<span class="cp">#define AUTO_ANNEX_B (1&lt;&lt;9)</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">ADI930</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">EAGLE_I</span><span class="p">,</span>
	<span class="n">EAGLE_II</span><span class="p">,</span>
	<span class="n">EAGLE_III</span><span class="p">,</span>
	<span class="n">EAGLE_IV</span>
<span class="p">};</span>

<span class="cm">/* macros for both struct usb_device_id and struct uea_softc */</span>
<span class="cp">#define UEA_IS_PREFIRM(x) \</span>
<span class="cp">	(!((x)-&gt;driver_info &amp; PSTFIRM))</span>
<span class="cp">#define UEA_CHIP_VERSION(x) \</span>
<span class="cp">	((x)-&gt;driver_info &amp; 0xf)</span>

<span class="cp">#define IS_ISDN(x) \</span>
<span class="cp">	((x)-&gt;annex &amp; ANNEXB)</span>

<span class="cp">#define INS_TO_USBDEV(ins) (ins-&gt;usb_dev)</span>

<span class="cp">#define GET_STATUS(data) \</span>
<span class="cp">	((data &gt;&gt; 8) &amp; 0xf)</span>

<span class="cp">#define IS_OPERATIONAL(sc) \</span>
<span class="cp">	((UEA_CHIP_VERSION(sc) != EAGLE_IV) ? \</span>
<span class="cp">	(GET_STATUS(sc-&gt;stats.phy.state) == 2) : \</span>
<span class="cp">	(sc-&gt;stats.phy.state == 7))</span>

<span class="cm">/*</span>
<span class="cm"> * Set of macros to handle unaligned data in the firmware blob.</span>
<span class="cm"> * The FW_GET_BYTE() macro is provided only for consistency.</span>
<span class="cm"> */</span>

<span class="cp">#define FW_GET_BYTE(p) (*((__u8 *) (p)))</span>

<span class="cp">#define FW_DIR &quot;ueagle-atm/&quot;</span>
<span class="cp">#define UEA_FW_NAME_MAX 30</span>
<span class="cp">#define NB_MODEM 4</span>

<span class="cp">#define BULK_TIMEOUT 300</span>
<span class="cp">#define CTRL_TIMEOUT 1000</span>

<span class="cp">#define ACK_TIMEOUT msecs_to_jiffies(3000)</span>

<span class="cp">#define UEA_INTR_IFACE_NO	0</span>
<span class="cp">#define UEA_US_IFACE_NO		1</span>
<span class="cp">#define UEA_DS_IFACE_NO		2</span>

<span class="cp">#define FASTEST_ISO_INTF	8</span>

<span class="cp">#define UEA_BULK_DATA_PIPE	0x02</span>
<span class="cp">#define UEA_IDMA_PIPE		0x04</span>
<span class="cp">#define UEA_INTR_PIPE		0x04</span>
<span class="cp">#define UEA_ISO_DATA_PIPE	0x08</span>

<span class="cp">#define UEA_E1_SET_BLOCK	0x0001</span>
<span class="cp">#define UEA_E4_SET_BLOCK	0x002c</span>
<span class="cp">#define UEA_SET_MODE		0x0003</span>
<span class="cp">#define UEA_SET_2183_DATA	0x0004</span>
<span class="cp">#define UEA_SET_TIMEOUT		0x0011</span>

<span class="cp">#define UEA_LOOPBACK_OFF	0x0002</span>
<span class="cp">#define UEA_LOOPBACK_ON		0x0003</span>
<span class="cp">#define UEA_BOOT_IDMA		0x0006</span>
<span class="cp">#define UEA_START_RESET		0x0007</span>
<span class="cp">#define UEA_END_RESET		0x0008</span>

<span class="cp">#define UEA_SWAP_MAILBOX	(0x3fcd | 0x4000)</span>
<span class="cp">#define UEA_MPTX_START		(0x3fce | 0x4000)</span>
<span class="cp">#define UEA_MPTX_MAILBOX	(0x3fd6 | 0x4000)</span>
<span class="cp">#define UEA_MPRX_MAILBOX	(0x3fdf | 0x4000)</span>

<span class="cm">/* block information in eagle4 dsp firmware  */</span>
<span class="k">struct</span> <span class="n">block_index</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">PageOffset</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">NotLastBlock</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">dummy</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">PageSize</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">PageAddress</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">dummy1</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">PageNumber</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define E4_IS_BOOT_PAGE(PageSize) ((le32_to_cpu(PageSize)) &amp; 0x80000000)</span>
<span class="cp">#define E4_PAGE_BYTES(PageSize) ((le32_to_cpu(PageSize) &amp; 0x7fffffff) * 4)</span>

<span class="cp">#define E4_L1_STRING_HEADER 0x10</span>
<span class="cp">#define E4_MAX_PAGE_NUMBER 0x58</span>
<span class="cp">#define E4_NO_SWAPPAGE_HEADERS 0x31</span>

<span class="cm">/* l1_code is eagle4 dsp firmware format */</span>
<span class="k">struct</span> <span class="n">l1_code</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">string_header</span><span class="p">[</span><span class="n">E4_L1_STRING_HEADER</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">page_number_to_block_index</span><span class="p">[</span><span class="n">E4_MAX_PAGE_NUMBER</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">block_index</span> <span class="n">page_header</span><span class="p">[</span><span class="n">E4_NO_SWAPPAGE_HEADERS</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* structures describing a block within a DSP page */</span>
<span class="k">struct</span> <span class="n">block_info_e1</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">wHdr</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">wAddress</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">wSize</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">wOvlOffset</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">wOvl</span><span class="p">;</span>		<span class="cm">/* overlay */</span>
	<span class="n">__le16</span> <span class="n">wLast</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
<span class="cp">#define E1_BLOCK_INFO_SIZE 12</span>

<span class="k">struct</span> <span class="n">block_info_e4</span> <span class="p">{</span>
	<span class="n">__be16</span> <span class="n">wHdr</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">bBootPage</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">bPageNumber</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">dwSize</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">dwAddress</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">wReserved</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
<span class="cp">#define E4_BLOCK_INFO_SIZE 14</span>

<span class="cp">#define UEA_BIHDR 0xabcd</span>
<span class="cp">#define UEA_RESERVED 0xffff</span>

<span class="cm">/* constants describing cmv type */</span>
<span class="cp">#define E1_PREAMBLE 0x535c</span>
<span class="cp">#define E1_MODEMTOHOST 0x01</span>
<span class="cp">#define E1_HOSTTOMODEM 0x10</span>

<span class="cp">#define E1_MEMACCESS 0x1</span>
<span class="cp">#define E1_ADSLDIRECTIVE 0x7</span>
<span class="cp">#define E1_FUNCTION_TYPE(f) ((f) &gt;&gt; 4)</span>
<span class="cp">#define E1_FUNCTION_SUBTYPE(f) ((f) &amp; 0x0f)</span>

<span class="cp">#define E4_MEMACCESS 0</span>
<span class="cp">#define E4_ADSLDIRECTIVE 0xf</span>
<span class="cp">#define E4_FUNCTION_TYPE(f) ((f) &gt;&gt; 8)</span>
<span class="cp">#define E4_FUNCTION_SIZE(f) ((f) &amp; 0x0f)</span>
<span class="cp">#define E4_FUNCTION_SUBTYPE(f) (((f) &gt;&gt; 4) &amp; 0x0f)</span>

<span class="cm">/* for MEMACCESS */</span>
<span class="cp">#define E1_REQUESTREAD	0x0</span>
<span class="cp">#define E1_REQUESTWRITE	0x1</span>
<span class="cp">#define E1_REPLYREAD	0x2</span>
<span class="cp">#define E1_REPLYWRITE	0x3</span>

<span class="cp">#define E4_REQUESTREAD	0x0</span>
<span class="cp">#define E4_REQUESTWRITE	0x4</span>
<span class="cp">#define E4_REPLYREAD	(E4_REQUESTREAD | 1)</span>
<span class="cp">#define E4_REPLYWRITE	(E4_REQUESTWRITE | 1)</span>

<span class="cm">/* for ADSLDIRECTIVE */</span>
<span class="cp">#define E1_KERNELREADY 0x0</span>
<span class="cp">#define E1_MODEMREADY  0x1</span>

<span class="cp">#define E4_KERNELREADY 0x0</span>
<span class="cp">#define E4_MODEMREADY  0x1</span>

<span class="cp">#define E1_MAKEFUNCTION(t, s) (((t) &amp; 0xf) &lt;&lt; 4 | ((s) &amp; 0xf))</span>
<span class="cp">#define E4_MAKEFUNCTION(t, st, s) (((t) &amp; 0xf) &lt;&lt; 8 | \</span>
<span class="cp">	((st) &amp; 0xf) &lt;&lt; 4 | ((s) &amp; 0xf))</span>

<span class="cp">#define E1_MAKESA(a, b, c, d)						\</span>
<span class="cp">	(((c) &amp; 0xff) &lt;&lt; 24 |						\</span>
<span class="cp">	 ((d) &amp; 0xff) &lt;&lt; 16 |						\</span>
<span class="cp">	 ((a) &amp; 0xff) &lt;&lt; 8  |						\</span>
<span class="cp">	 ((b) &amp; 0xff))</span>

<span class="cp">#define E1_GETSA1(a) ((a &gt;&gt; 8) &amp; 0xff)</span>
<span class="cp">#define E1_GETSA2(a) (a &amp; 0xff)</span>
<span class="cp">#define E1_GETSA3(a) ((a &gt;&gt; 24) &amp; 0xff)</span>
<span class="cp">#define E1_GETSA4(a) ((a &gt;&gt; 16) &amp; 0xff)</span>

<span class="cp">#define E1_SA_CNTL E1_MAKESA(&#39;C&#39;, &#39;N&#39;, &#39;T&#39;, &#39;L&#39;)</span>
<span class="cp">#define E1_SA_DIAG E1_MAKESA(&#39;D&#39;, &#39;I&#39;, &#39;A&#39;, &#39;G&#39;)</span>
<span class="cp">#define E1_SA_INFO E1_MAKESA(&#39;I&#39;, &#39;N&#39;, &#39;F&#39;, &#39;O&#39;)</span>
<span class="cp">#define E1_SA_OPTN E1_MAKESA(&#39;O&#39;, &#39;P&#39;, &#39;T&#39;, &#39;N&#39;)</span>
<span class="cp">#define E1_SA_RATE E1_MAKESA(&#39;R&#39;, &#39;A&#39;, &#39;T&#39;, &#39;E&#39;)</span>
<span class="cp">#define E1_SA_STAT E1_MAKESA(&#39;S&#39;, &#39;T&#39;, &#39;A&#39;, &#39;T&#39;)</span>

<span class="cp">#define E4_SA_CNTL 1</span>
<span class="cp">#define E4_SA_STAT 2</span>
<span class="cp">#define E4_SA_INFO 3</span>
<span class="cp">#define E4_SA_TEST 4</span>
<span class="cp">#define E4_SA_OPTN 5</span>
<span class="cp">#define E4_SA_RATE 6</span>
<span class="cp">#define E4_SA_DIAG 7</span>
<span class="cp">#define E4_SA_CNFG 8</span>

<span class="cm">/* structures representing a CMV (Configuration and Management Variable) */</span>
<span class="k">struct</span> <span class="n">cmv_e1</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">wPreamble</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">bDirection</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">bFunction</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">wIndex</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">dwSymbolicAddress</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">wOffsetAddress</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">dwData</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">cmv_e4</span> <span class="p">{</span>
	<span class="n">__be16</span> <span class="n">wGroup</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">wFunction</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">wOffset</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">wAddress</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">dwData</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* structures representing swap information */</span>
<span class="k">struct</span> <span class="n">swap_info_e1</span> <span class="p">{</span>
	<span class="n">__u8</span> <span class="n">bSwapPageNo</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">bOvl</span><span class="p">;</span>		<span class="cm">/* overlay */</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">swap_info_e4</span> <span class="p">{</span>
	<span class="n">__u8</span> <span class="n">bSwapPageNo</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* structures representing interrupt data */</span>
<span class="cp">#define e1_bSwapPageNo	u.e1.s1.swapinfo.bSwapPageNo</span>
<span class="cp">#define e1_bOvl		u.e1.s1.swapinfo.bOvl</span>
<span class="cp">#define e4_bSwapPageNo  u.e4.s1.swapinfo.bSwapPageNo</span>

<span class="cp">#define INT_LOADSWAPPAGE 0x0001</span>
<span class="cp">#define INT_INCOMINGCMV  0x0002</span>

<span class="k">union</span> <span class="n">intr_data_e1</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">swap_info_e1</span> <span class="n">swapinfo</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">wDataSize</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__packed</span> <span class="n">s1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cmv_e1</span> <span class="n">cmv</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">wDataSize</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__packed</span> <span class="n">s2</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">union</span> <span class="n">intr_data_e4</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">swap_info_e4</span> <span class="n">swapinfo</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">wDataSize</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__packed</span> <span class="n">s1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cmv_e4</span> <span class="n">cmv</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">wDataSize</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__packed</span> <span class="n">s2</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">intr_pkt</span> <span class="p">{</span>
	<span class="n">__u8</span> <span class="n">bType</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">bNotification</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">wValue</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">wIndex</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">wLength</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">wInterrupt</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">intr_data_e1</span> <span class="n">e1</span><span class="p">;</span>
		<span class="k">union</span> <span class="n">intr_data_e4</span> <span class="n">e4</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define E1_INTR_PKT_SIZE 28</span>
<span class="cp">#define E4_INTR_PKT_SIZE 64</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">uea_driver</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">uea_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">chip_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;ADI930&quot;</span><span class="p">,</span> <span class="s">&quot;Eagle I&quot;</span><span class="p">,</span> <span class="s">&quot;Eagle II&quot;</span><span class="p">,</span> <span class="s">&quot;Eagle III&quot;</span><span class="p">,</span> <span class="s">&quot;Eagle IV&quot;</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modem_index</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">altsetting</span><span class="p">[</span><span class="n">NB_MODEM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">NB_MODEM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">FASTEST_ISO_INTF</span><span class="p">};</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">sync_wait</span><span class="p">[</span><span class="n">NB_MODEM</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmv_file</span><span class="p">[</span><span class="n">NB_MODEM</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">annex</span><span class="p">[</span><span class="n">NB_MODEM</span><span class="p">];</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;module debug level (0=off,1=on,2=verbose)&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">altsetting</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">altsetting</span><span class="p">,</span> <span class="s">&quot;alternate setting for incoming traffic: 0=bulk, &quot;</span>
			     <span class="s">&quot;1=isoc slowest, ... , 8=isoc fastest (default)&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">sync_wait</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sync_wait</span><span class="p">,</span> <span class="s">&quot;wait the synchronisation before starting ATM&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">cmv_file</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cmv_file</span><span class="p">,</span>
		<span class="s">&quot;file name with configuration and management variables&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">annex</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">annex</span><span class="p">,</span>
		<span class="s">&quot;manually set annex a/b (0=auto, 1=annex a, 2=annex b)&quot;</span><span class="p">);</span>

<span class="cp">#define uea_wait(sc, cond, timeo) \</span>
<span class="cp">({ \</span>
<span class="cp">	int _r = wait_event_interruptible_timeout(sc-&gt;sync_q, \</span>
<span class="cp">			(cond) || kthread_should_stop(), timeo); \</span>
<span class="cp">	if (kthread_should_stop()) \</span>
<span class="cp">		_r = -ENODEV; \</span>
<span class="cp">	_r; \</span>
<span class="cp">})</span>

<span class="cp">#define UPDATE_ATM_STAT(type, val) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (sc-&gt;usbatm-&gt;atm_dev) \</span>
<span class="cp">			sc-&gt;usbatm-&gt;atm_dev-&gt;type = val; \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define UPDATE_ATM_SIGNAL(val) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (sc-&gt;usbatm-&gt;atm_dev) \</span>
<span class="cp">			atm_dev_signal_change(sc-&gt;usbatm-&gt;atm_dev, val); \</span>
<span class="cp">	} while (0)</span>


<span class="cm">/* Firmware loading */</span>
<span class="cp">#define LOAD_INTERNAL     0xA0</span>
<span class="cp">#define F8051_USBCS       0x7f92</span>

<span class="cm">/**</span>
<span class="cm"> * uea_send_modem_cmd - Send a command for pre-firmware devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_send_modem_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">xfer_buff</span><span class="p">;</span>

	<span class="n">xfer_buff</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfer_buff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span>
				      <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				      <span class="n">LOAD_INTERNAL</span><span class="p">,</span>
				      <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span>
				      <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xfer_buff</span><span class="p">,</span>
				      <span class="n">size</span><span class="p">,</span> <span class="n">CTRL_TIMEOUT</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">xfer_buff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uea_upload_pre_firmware</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_entry</span><span class="p">,</span>
								<span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pfw</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">uea_enters</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="s">&quot;firmware is not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pfw</span> <span class="o">=</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_fw_corrupted</span><span class="p">;</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">pfw</span><span class="p">);</span>
	<span class="n">pfw</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crc32_be</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pfw</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">crc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_fw_corrupted</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start to upload firmware : send reset</span>
<span class="cm">	 */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_send_modem_cmd</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">F8051_USBCS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="s">&quot;modem reset failed with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">len</span> <span class="o">=</span> <span class="n">FW_GET_BYTE</span><span class="p">(</span><span class="n">pfw</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">add</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">pfw</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">size</span> <span class="o">-=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_fw_corrupted</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_send_modem_cmd</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">pfw</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uea_err</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="s">&quot;uploading firmware data failed &quot;</span>
					<span class="s">&quot;with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pfw</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_fw_corrupted</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tell the modem we finish : de-assert reset</span>
<span class="cm">	 */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_send_modem_cmd</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">F8051_USBCS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="s">&quot;modem de-assert failed with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">uea_info</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="s">&quot;firmware uploaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_fw_corrupted:</span>
	<span class="n">uea_err</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="s">&quot;firmware is corrupted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>
	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * uea_load_firmware - Load usb firmware for pre-firmware devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span> <span class="o">=</span> <span class="n">FW_DIR</span> <span class="s">&quot;eagle.fw&quot;</span><span class="p">;</span>

	<span class="n">uea_enters</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>
	<span class="n">uea_info</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="s">&quot;pre-firmware device, uploading firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ver</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ADI930</span>:
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">FW_DIR</span> <span class="s">&quot;adi930.fw&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EAGLE_I</span>:
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">FW_DIR</span> <span class="s">&quot;eagleI.fw&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EAGLE_II</span>:
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">FW_DIR</span> <span class="s">&quot;eagleII.fw&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EAGLE_III</span>:
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">FW_DIR</span> <span class="s">&quot;eagleIII.fw&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EAGLE_IV</span>:
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">FW_DIR</span> <span class="s">&quot;eagleIV.fw&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware_nowait</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">usb</span><span class="p">,</span>
					<span class="n">uea_upload_pre_firmware</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="s">&quot;firmware %s is not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">uea_info</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="s">&quot;loading firmware %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>

	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* modem management : dsp firmware, send/read CMV, monitoring statistic</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Make sure that the DSP code provided is safe to use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_dsp_e1</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dsp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pagecount</span><span class="p">,</span> <span class="n">blockcount</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pageoffset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">pp</span><span class="p">;</span>

	<span class="n">pagecount</span> <span class="o">=</span> <span class="n">FW_GET_BYTE</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* enough space for page offsets? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pagecount</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pagecount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pageoffset</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">dsp</span> <span class="o">+</span> <span class="n">p</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pageoffset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* enough space for blockcount? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pageoffset</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">pp</span> <span class="o">=</span> <span class="n">pageoffset</span><span class="p">;</span>
		<span class="n">blockcount</span> <span class="o">=</span> <span class="n">FW_GET_BYTE</span><span class="p">(</span><span class="n">dsp</span> <span class="o">+</span> <span class="n">pp</span><span class="p">);</span>
		<span class="n">pp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">blockcount</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* enough space for block header? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">pp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* skip blockaddr */</span>
			<span class="n">blocksize</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">dsp</span> <span class="o">+</span> <span class="n">pp</span><span class="p">);</span>
			<span class="n">pp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="cm">/* enough space for block data? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">+</span> <span class="n">blocksize</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">pp</span> <span class="o">+=</span> <span class="n">blocksize</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_dsp_e4</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l1_code</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l1_code</span> <span class="o">*</span><span class="p">)</span> <span class="n">dsp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">-</span> <span class="n">dsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">sum</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;STRATIPHY ANEXA&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">string_header</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;STRATIPHY ANEXB&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">string_header</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E4_MAX_PAGE_NUMBER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">block_index</span> <span class="o">*</span><span class="n">blockidx</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">blockno</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">page_number_to_block_index</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blockno</span> <span class="o">&gt;=</span> <span class="n">E4_NO_SWAPPAGE_HEADERS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">l</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">blockno</span> <span class="o">&gt;=</span> <span class="n">E4_NO_SWAPPAGE_HEADERS</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">blockidx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">page_header</span><span class="p">[</span><span class="n">blockno</span><span class="o">++</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">blockidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">dsp</span>  <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">blockidx</span><span class="o">-&gt;</span><span class="n">PageNumber</span><span class="p">)</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">l</span> <span class="o">=</span> <span class="n">E4_PAGE_BYTES</span><span class="p">(</span><span class="n">blockidx</span><span class="o">-&gt;</span><span class="n">PageSize</span><span class="p">);</span>
			<span class="n">sum</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
			<span class="n">l</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">blockidx</span><span class="o">-&gt;</span><span class="n">PageOffset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* zero is zero regardless endianes */</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">blockidx</span><span class="o">-&gt;</span><span class="n">NotLastBlock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">sum</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send data to the idma pipe</span>
<span class="cm"> * */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_idma_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">xfer_buff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_read</span><span class="p">;</span>

	<span class="n">xfer_buff</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfer_buff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;can&#39;t allocate xfer_buff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span>
			 <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">UEA_IDMA_PIPE</span><span class="p">),</span>
			 <span class="n">xfer_buff</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_read</span><span class="p">,</span> <span class="n">BULK_TIMEOUT</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">xfer_buff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="n">bytes_read</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;size != bytes_read %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
		       <span class="n">bytes_read</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dsp_name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">==</span> <span class="n">EAGLE_IV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ISDN</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span>
			<span class="n">dsp_name</span> <span class="o">=</span> <span class="n">FW_DIR</span> <span class="s">&quot;DSP4i.bin&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dsp_name</span> <span class="o">=</span> <span class="n">FW_DIR</span> <span class="s">&quot;DSP4p.bin&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">==</span> <span class="n">ADI930</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ISDN</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span>
			<span class="n">dsp_name</span> <span class="o">=</span> <span class="n">FW_DIR</span> <span class="s">&quot;DSP9i.bin&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dsp_name</span> <span class="o">=</span> <span class="n">FW_DIR</span> <span class="s">&quot;DSP9p.bin&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ISDN</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span>
			<span class="n">dsp_name</span> <span class="o">=</span> <span class="n">FW_DIR</span> <span class="s">&quot;DSPei.bin&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dsp_name</span> <span class="o">=</span> <span class="n">FW_DIR</span> <span class="s">&quot;DSPep.bin&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="p">,</span> <span class="n">dsp_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
		       <span class="s">&quot;requesting firmware %s failed with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dsp_name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">==</span> <span class="n">EAGLE_IV</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">check_dsp_e4</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">check_dsp_e1</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;firmware %s is corrupted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dsp_name</span><span class="p">);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The uea_load_page() function must be called within a process context</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uea_load_page_e1</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uea_softc</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">pageno</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">pageno</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ovl</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">ovl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_info_e1</span> <span class="n">bi</span><span class="p">;</span>

	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pagecount</span><span class="p">,</span> <span class="n">blockcount</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">blockaddr</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pageoffset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* reload firmware when reboot start and it&#39;s loaded already */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ovl</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pageno</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">request_dsp</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">pagecount</span> <span class="o">=</span> <span class="n">FW_GET_BYTE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pageno</span> <span class="o">&gt;=</span> <span class="n">pagecount</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad1</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pageno</span><span class="p">;</span>
	<span class="n">pageoffset</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pageoffset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad1</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">pageoffset</span><span class="p">;</span>
	<span class="n">blockcount</span> <span class="o">=</span> <span class="n">FW_GET_BYTE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">uea_dbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
	       <span class="s">&quot;sending %u blocks for DSP page %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blockcount</span><span class="p">,</span> <span class="n">pageno</span><span class="p">);</span>

	<span class="n">bi</span><span class="p">.</span><span class="n">wHdr</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">UEA_BIHDR</span><span class="p">);</span>
	<span class="n">bi</span><span class="p">.</span><span class="n">wOvl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ovl</span><span class="p">);</span>
	<span class="n">bi</span><span class="p">.</span><span class="n">wOvlOffset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ovl</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">blockcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blockaddr</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">blocksize</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">bi</span><span class="p">.</span><span class="n">wSize</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">blocksize</span><span class="p">);</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">wAddress</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">blockaddr</span><span class="p">);</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">wLast</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="n">blockcount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* send block info through the IDMA pipe */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uea_idma_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="p">,</span> <span class="n">E1_BLOCK_INFO_SIZE</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">bad2</span><span class="p">;</span>

		<span class="cm">/* send block data through the IDMA pipe */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uea_idma_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">bad2</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">bad2:</span>
	<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;sending DSP block %u failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">bad1:</span>
	<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;invalid DSP page %u requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pageno</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__uea_load_page_e4</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pageno</span><span class="p">,</span> <span class="kt">int</span> <span class="n">boot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">block_info_e4</span> <span class="n">bi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_index</span> <span class="o">*</span><span class="n">blockidx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l1_code</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l1_code</span> <span class="o">*</span><span class="p">)</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">blockno</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">page_number_to_block_index</span><span class="p">[</span><span class="n">pageno</span><span class="p">];</span>

	<span class="n">bi</span><span class="p">.</span><span class="n">wHdr</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">UEA_BIHDR</span><span class="p">);</span>
	<span class="n">bi</span><span class="p">.</span><span class="n">bBootPage</span> <span class="o">=</span> <span class="n">boot</span><span class="p">;</span>
	<span class="n">bi</span><span class="p">.</span><span class="n">bPageNumber</span> <span class="o">=</span> <span class="n">pageno</span><span class="p">;</span>
	<span class="n">bi</span><span class="p">.</span><span class="n">wReserved</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">UEA_RESERVED</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">blockoffset</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blocksize</span><span class="p">;</span>

		<span class="n">blockidx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">page_header</span><span class="p">[</span><span class="n">blockno</span><span class="p">];</span>
		<span class="n">blocksize</span> <span class="o">=</span> <span class="n">E4_PAGE_BYTES</span><span class="p">(</span><span class="n">blockidx</span><span class="o">-&gt;</span><span class="n">PageSize</span><span class="p">);</span>
		<span class="n">blockoffset</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span>
							<span class="n">blockidx</span><span class="o">-&gt;</span><span class="n">PageOffset</span><span class="p">);</span>

		<span class="n">bi</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">blocksize</span><span class="p">);</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">dwAddress</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">blockidx</span><span class="o">-&gt;</span><span class="n">PageAddress</span><span class="p">));</span>

		<span class="n">uea_dbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
			<span class="s">&quot;sending block %u for DSP page &quot;</span>
			<span class="s">&quot;%u size %u address %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">blockno</span><span class="p">,</span> <span class="n">pageno</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">blockidx</span><span class="o">-&gt;</span><span class="n">PageAddress</span><span class="p">));</span>

		<span class="cm">/* send block info through the IDMA pipe */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uea_idma_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="p">,</span> <span class="n">E4_BLOCK_INFO_SIZE</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

		<span class="cm">/* send block data through the IDMA pipe */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uea_idma_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">blockoffset</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

		<span class="n">blockno</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">blockidx</span><span class="o">-&gt;</span><span class="n">NotLastBlock</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">bad:</span>
	<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;sending DSP block %u failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blockno</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uea_load_page_e4</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uea_softc</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">pageno</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">pageno</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_info_e4</span> <span class="n">bi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l1_code</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">uea_dbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;sending DSP page %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pageno</span><span class="p">);</span>

	<span class="cm">/* reload firmware when reboot start and it&#39;s loaded already */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pageno</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">request_dsp</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l1_code</span> <span class="o">*</span><span class="p">)</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pageno</span> <span class="o">&gt;=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">page_header</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PageNumber</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;invalid DSP &quot;</span>
						<span class="s">&quot;page %u requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pageno</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pageno</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__uea_load_page_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">pageno</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">uea_dbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
	       <span class="s">&quot;sending Main DSP page %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">page_header</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PageNumber</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">page_header</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PageNumber</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">E4_IS_BOOT_PAGE</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">page_header</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PageSize</span><span class="p">))</span>
			<span class="n">__uea_load_page_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">uea_dbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="p">,</span> <span class="s">&quot;sending start bi</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">bi</span><span class="p">.</span><span class="n">wHdr</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">UEA_BIHDR</span><span class="p">);</span>
	<span class="n">bi</span><span class="p">.</span><span class="n">bBootPage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bi</span><span class="p">.</span><span class="n">bPageNumber</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">bi</span><span class="p">.</span><span class="n">wReserved</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">UEA_RESERVED</span><span class="p">);</span>
	<span class="n">bi</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">E4_PAGE_BYTES</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">page_header</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PageSize</span><span class="p">));</span>
	<span class="n">bi</span><span class="p">.</span><span class="n">dwAddress</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">page_header</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PageAddress</span><span class="p">));</span>

	<span class="cm">/* send block info through the IDMA pipe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uea_idma_write</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="p">,</span> <span class="n">E4_BLOCK_INFO_SIZE</span><span class="p">))</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;sending DSP start bi failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wake_up_cmv_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_ack</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sync_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wait_cmv_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">uea_wait</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_ack</span> <span class="p">,</span> <span class="n">ACK_TIMEOUT</span><span class="p">);</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">uea_dbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;wait_event_timeout : %d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ETIMEDOUT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define UCDC_SEND_ENCAPSULATED_COMMAND 0x00</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">xfer_buff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">xfer_buff</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfer_buff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;can&#39;t allocate xfer_buff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="n">UCDC_SEND_ENCAPSULATED_COMMAND</span><span class="p">,</span>
			      <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			      <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">xfer_buff</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">CTRL_TIMEOUT</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">xfer_buff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;usb_control_msg error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
		       <span class="s">&quot;usb_control_msg send only %d bytes (instead of %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ret</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_cmv_e1</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">function</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmv_e1</span> <span class="n">cmv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">uea_enters</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="n">uea_vdbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;Function : %d-%d, Address : %c%c%c%c, &quot;</span>
			<span class="s">&quot;offset : 0x%04x, data : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">E1_FUNCTION_TYPE</span><span class="p">(</span><span class="n">function</span><span class="p">),</span>
			<span class="n">E1_FUNCTION_SUBTYPE</span><span class="p">(</span><span class="n">function</span><span class="p">),</span>
			<span class="n">E1_GETSA1</span><span class="p">(</span><span class="n">address</span><span class="p">),</span> <span class="n">E1_GETSA2</span><span class="p">(</span><span class="n">address</span><span class="p">),</span>
			<span class="n">E1_GETSA3</span><span class="p">(</span><span class="n">address</span><span class="p">),</span>
			<span class="n">E1_GETSA4</span><span class="p">(</span><span class="n">address</span><span class="p">),</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* we send a request, but we expect a reply */</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_dsc</span><span class="p">.</span><span class="n">e1</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_dsc</span><span class="p">.</span><span class="n">e1</span><span class="p">.</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_dsc</span><span class="p">.</span><span class="n">e1</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_dsc</span><span class="p">.</span><span class="n">e1</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">cmv</span><span class="p">.</span><span class="n">wPreamble</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">E1_PREAMBLE</span><span class="p">);</span>
	<span class="n">cmv</span><span class="p">.</span><span class="n">bDirection</span> <span class="o">=</span> <span class="n">E1_HOSTTOMODEM</span><span class="p">;</span>
	<span class="n">cmv</span><span class="p">.</span><span class="n">bFunction</span> <span class="o">=</span> <span class="n">function</span><span class="p">;</span>
	<span class="n">cmv</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_dsc</span><span class="p">.</span><span class="n">e1</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
	<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmv</span><span class="p">.</span><span class="n">dwSymbolicAddress</span><span class="p">);</span>
	<span class="n">cmv</span><span class="p">.</span><span class="n">wOffsetAddress</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmv</span><span class="p">.</span><span class="n">dwData</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_request</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">UEA_E1_SET_BLOCK</span><span class="p">,</span> <span class="n">UEA_MPTX_START</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">cmv</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cmv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_cmv_ack</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_cmv_e4</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">function</span><span class="p">,</span> <span class="n">u16</span> <span class="n">group</span><span class="p">,</span> <span class="n">u16</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmv_e4</span> <span class="n">cmv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">uea_enters</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmv</span><span class="p">));</span>

	<span class="n">uea_vdbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;Function : %d-%d, Group : 0x%04x, &quot;</span>
		 <span class="s">&quot;Address : 0x%04x, offset : 0x%04x, data : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">E4_FUNCTION_TYPE</span><span class="p">(</span><span class="n">function</span><span class="p">),</span> <span class="n">E4_FUNCTION_SUBTYPE</span><span class="p">(</span><span class="n">function</span><span class="p">),</span>
		 <span class="n">group</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* we send a request, but we expect a reply */</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_dsc</span><span class="p">.</span><span class="n">e4</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_dsc</span><span class="p">.</span><span class="n">e4</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_dsc</span><span class="p">.</span><span class="n">e4</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_dsc</span><span class="p">.</span><span class="n">e4</span><span class="p">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="p">;</span>

	<span class="n">cmv</span><span class="p">.</span><span class="n">wFunction</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">function</span><span class="p">);</span>
	<span class="n">cmv</span><span class="p">.</span><span class="n">wGroup</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">group</span><span class="p">);</span>
	<span class="n">cmv</span><span class="p">.</span><span class="n">wAddress</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
	<span class="n">cmv</span><span class="p">.</span><span class="n">wOffset</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">cmv</span><span class="p">.</span><span class="n">dwData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_request</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">UEA_E4_SET_BLOCK</span><span class="p">,</span> <span class="n">UEA_MPTX_START</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">cmv</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cmv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_cmv_ack</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">uea_read_cmv_e1</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">uea_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_MAKEFUNCTION</span><span class="p">(</span><span class="n">E1_MEMACCESS</span><span class="p">,</span> <span class="n">E1_REQUESTREAD</span><span class="p">),</span>
			  <span class="n">address</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
			<span class="s">&quot;reading cmv failed with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">uea_read_cmv_e4</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">size</span><span class="p">,</span> <span class="n">u16</span> <span class="n">group</span><span class="p">,</span> <span class="n">u16</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">uea_cmv_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E4_MAKEFUNCTION</span><span class="p">(</span><span class="n">E4_MEMACCESS</span><span class="p">,</span>
							<span class="n">E4_REQUESTREAD</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span>
			  <span class="n">group</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
			<span class="s">&quot;reading cmv failed with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="cm">/* size is in 16-bit word quantities */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">data1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">uea_write_cmv_e1</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">uea_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_MAKEFUNCTION</span><span class="p">(</span><span class="n">E1_MEMACCESS</span><span class="p">,</span> <span class="n">E1_REQUESTWRITE</span><span class="p">),</span>
			  <span class="n">address</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
			<span class="s">&quot;writing cmv failed with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">uea_write_cmv_e4</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">size</span><span class="p">,</span> <span class="n">u16</span> <span class="n">group</span><span class="p">,</span> <span class="n">u16</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">uea_cmv_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E4_MAKEFUNCTION</span><span class="p">(</span><span class="n">E4_MEMACCESS</span><span class="p">,</span>
							<span class="n">E4_REQUESTWRITE</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span>
			  <span class="n">group</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
			<span class="s">&quot;writing cmv failed with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uea_set_bulk_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dsrate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="cm">/* in bulk mode the modem have problem with high rate</span>
<span class="cm">	 * changing internal timing could improve things, but the</span>
<span class="cm">	 * value is mysterious.</span>
<span class="cm">	 * ADI930 don&#39;t support it (-EPIPE error).</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">==</span> <span class="n">ADI930</span> <span class="o">||</span>
	    <span class="n">altsetting</span><span class="p">[</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">modem_index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">dsrate</span> <span class="o">==</span> <span class="n">dsrate</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Original timming (1Mbit/s) from ADI (used in windows driver) */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsrate</span> <span class="o">&lt;=</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_request</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">UEA_SET_TIMEOUT</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">uea_info</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;setting new timeout %d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">timeout</span><span class="p">,</span>  <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot; failed&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Monitor the modem and update the stat</span>
<span class="cm"> * return 0 if everything is ok</span>
<span class="cm"> * return &lt; 0 if an error occurs (-EAGAIN reboot needed)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_stat_e1</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">uea_enters</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_STAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">GET_STATUS</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* not yet synchronized */</span>
		<span class="n">uea_dbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
		       <span class="s">&quot;modem not yet synchronized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/* initialization */</span>
		<span class="n">uea_dbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;modem initializing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:		<span class="cm">/* operational */</span>
		<span class="n">uea_vdbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;modem operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>:		<span class="cm">/* fail ... */</span>
		<span class="n">uea_info</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;modem synchronization failed&quot;</span>
					<span class="s">&quot; (may be try other cmv/dsp)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span> <span class="p">...</span> <span class="mi">6</span>:	<span class="cm">/* test state */</span>
		<span class="n">uea_warn</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
				<span class="s">&quot;modem in test mode - not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">7</span>:		<span class="cm">/* fast-retain ... */</span>
		<span class="n">uea_info</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;modem in fast-retain mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;modem invalid SW mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">GET_STATUS</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_STATUS</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_request</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">UEA_SET_MODE</span><span class="p">,</span> <span class="n">UEA_LOOPBACK_OFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">uea_info</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;modem operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* release the dsp firmware as it is not needed until</span>
<span class="cm">		 * the next failure</span>
<span class="cm">		 */</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* always update it as atm layer could not be init when we switch to</span>
<span class="cm">	 * operational state</span>
<span class="cm">	 */</span>
	<span class="n">UPDATE_ATM_SIGNAL</span><span class="p">(</span><span class="n">ATM_PHY_SIG_FOUND</span><span class="p">);</span>

	<span class="cm">/* wake up processes waiting for synchronization */</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sync_q</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_DIAG</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">mflags</span> <span class="o">|=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* in case of a flags ( for example delineation LOSS (&amp; 0x10)),</span>
<span class="cm">	 * we check the status again in order to detect the failure earlier</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_dbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;Stat flag = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_RATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">uea_set_bulk_timeout</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">dsrate</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">usrate</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">UPDATE_ATM_STAT</span><span class="p">(</span><span class="n">link_rate</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">dsrate</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">424</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_DIAG</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">dsattenuation</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_DIAG</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">usattenuation</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_DIAG</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">dsmargin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_DIAG</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">usmargin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_DIAG</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">rxflow</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_DIAG</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">txflow</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_DIAG</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">dsunc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* only for atu-c */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_DIAG</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">usunc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_DIAG</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">dscorr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* only for atu-c */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_DIAG</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">uscorr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_INFO</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">vidco</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_INFO</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">vidcpe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_stat_e4</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">uea_enters</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>

	<span class="cm">/* XXX only need to be done before operationnal... */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E4_SA_STAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x0</span>:	<span class="cm">/* not yet synchronized */</span>
	<span class="k">case</span> <span class="mh">0x1</span>:
	<span class="k">case</span> <span class="mh">0x3</span>:
	<span class="k">case</span> <span class="mh">0x4</span>:
		<span class="n">uea_dbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;modem not yet &quot;</span>
						<span class="s">&quot;synchronized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x5</span>:	<span class="cm">/* initialization */</span>
	<span class="k">case</span> <span class="mh">0x6</span>:
	<span class="k">case</span> <span class="mh">0x9</span>:
	<span class="k">case</span> <span class="mh">0xa</span>:
		<span class="n">uea_dbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;modem initializing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2</span>:	<span class="cm">/* fail ... */</span>
		<span class="n">uea_info</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;modem synchronization &quot;</span>
				<span class="s">&quot;failed (may be try other cmv/dsp)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x7</span>:	<span class="cm">/* operational */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">uea_warn</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;unknown state: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_request</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">UEA_SET_MODE</span><span class="p">,</span> <span class="n">UEA_LOOPBACK_OFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">uea_info</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;modem operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* release the dsp firmware as it is not needed until</span>
<span class="cm">		 * the next failure</span>
<span class="cm">		 */</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* always update it as atm layer could not be init when we switch to</span>
<span class="cm">	 * operational state</span>
<span class="cm">	 */</span>
	<span class="n">UPDATE_ATM_SIGNAL</span><span class="p">(</span><span class="n">ATM_PHY_SIG_FOUND</span><span class="p">);</span>

	<span class="cm">/* wake up processes waiting for synchronization */</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sync_q</span><span class="p">);</span>

	<span class="cm">/* TODO improve this state machine :</span>
<span class="cm">	 * we need some CMV info : what they do and their unit</span>
<span class="cm">	 * we should find the equivalent of eagle3- CMV</span>
<span class="cm">	 */</span>
	<span class="cm">/* check flags */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E4_SA_DIAG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">mflags</span> <span class="o">|=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* in case of a flags ( for example delineation LOSS (&amp; 0x10)),</span>
<span class="cm">	 * we check the status again in order to detect the failure earlier</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_dbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;Stat flag = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="cm">/* delineation LOSS */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="cm">/* Reset Flag */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* rate data may be in upper or lower half of 64 bit word, strange */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">E4_SA_RATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp_arr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="n">tmp_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="n">tmp_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">usrate</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">E4_SA_RATE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp_arr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="n">tmp_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="n">tmp_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">uea_set_bulk_timeout</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">data</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">dsrate</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">UPDATE_ATM_STAT</span><span class="p">(</span><span class="n">link_rate</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">dsrate</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">424</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E4_SA_INFO</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">dsattenuation</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E4_SA_INFO</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">usattenuation</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E4_SA_INFO</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">dsmargin</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E4_SA_INFO</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">usmargin</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cmvs_file_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">cmv_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">file_arr</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;CMVxy.bin&quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>

	<span class="n">kparam_block_sysfs_write</span><span class="p">(</span><span class="n">cmv_file</span><span class="p">);</span>
	<span class="cm">/* set proper name corresponding modem version and line type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmv_file</span><span class="p">[</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">modem_index</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">==</span> <span class="n">ADI930</span><span class="p">)</span>
			<span class="n">file_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;9&#39;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">==</span> <span class="n">EAGLE_IV</span><span class="p">)</span>
			<span class="n">file_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;4&#39;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">file_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;e&#39;</span><span class="p">;</span>

		<span class="n">file_arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">IS_ISDN</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;i&#39;</span> <span class="o">:</span> <span class="sc">&#39;p&#39;</span><span class="p">;</span>
		<span class="n">file</span> <span class="o">=</span> <span class="n">file_arr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">file</span> <span class="o">=</span> <span class="n">cmv_file</span><span class="p">[</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">modem_index</span><span class="p">];</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">cmv_name</span><span class="p">,</span> <span class="n">FW_DIR</span><span class="p">);</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">cmv_name</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">UEA_FW_NAME_MAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ver</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">cmv_name</span><span class="p">,</span> <span class="s">&quot;.v2&quot;</span><span class="p">,</span> <span class="n">UEA_FW_NAME_MAX</span><span class="p">);</span>
	<span class="n">kparam_unblock_sysfs_write</span><span class="p">(</span><span class="n">cmv_file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_cmvs_old</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
		 <span class="kt">void</span> <span class="o">**</span><span class="n">cmvs</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">**</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cmv_name</span><span class="p">[</span><span class="n">UEA_FW_NAME_MAX</span><span class="p">];</span> <span class="cm">/* 30 bytes stack variable */</span>

	<span class="n">cmvs_file_name</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">cmv_name</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">cmv_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
		       <span class="s">&quot;requesting firmware %s failed with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmv_name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">fw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">fw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_fw_corrupted</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="o">*</span><span class="n">data</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_cmvs_v1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_fw_corrupted</span><span class="p">;</span>

	<span class="o">*</span><span class="n">cmvs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

<span class="nl">err_fw_corrupted:</span>
	<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;firmware %s is corrupted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmv_name</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="o">*</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_cmvs</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
		 <span class="kt">void</span> <span class="o">**</span><span class="n">cmvs</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">**</span><span class="n">fw</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cmv_name</span><span class="p">[</span><span class="n">UEA_FW_NAME_MAX</span><span class="p">];</span> <span class="cm">/* 30 bytes stack variable */</span>

	<span class="n">cmvs_file_name</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">cmv_name</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">cmv_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if caller can handle old version, try to provide it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ver</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uea_warn</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;requesting &quot;</span>
							<span class="s">&quot;firmware %s failed, &quot;</span>
				<span class="s">&quot;try to get older cmvs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmv_name</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">request_cmvs_old</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">cmvs</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
		       <span class="s">&quot;requesting firmware %s failed with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmv_name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">fw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">fw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;cmv2&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ver</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uea_warn</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;firmware %s is corrupted,&quot;</span>
				<span class="s">&quot; try to get older cmvs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmv_name</span><span class="p">);</span>
			<span class="n">release_firmware</span><span class="p">(</span><span class="o">*</span><span class="n">fw</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">request_cmvs_old</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">cmvs</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">err_fw_corrupted</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">ver</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_fw_corrupted</span><span class="p">;</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crc32_be</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">crc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_fw_corrupted</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="o">*</span><span class="n">data</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_cmvs_v2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_fw_corrupted</span><span class="p">;</span>

	<span class="o">*</span><span class="n">cmvs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

<span class="nl">err_fw_corrupted:</span>
	<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;firmware %s is corrupted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmv_name</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="o">*</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_send_cmvs_e1</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cmvs_ptr</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">cmvs_fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ver</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* we can handle v1 cmv firmware version; */</span>

	<span class="cm">/* Enter in R-IDLE (cmv) until instructed otherwise */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_write_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Dump firmware version */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_INFO</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">firmid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">uea_info</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;ATU-R firmware version : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">firmid</span><span class="p">);</span>

	<span class="cm">/* get options */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">len</span> <span class="o">=</span> <span class="n">request_cmvs</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmvs_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmvs_fw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* send options */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ver</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uea_cmvs_v1</span> <span class="o">*</span><span class="n">cmvs_v1</span> <span class="o">=</span> <span class="n">cmvs_ptr</span><span class="p">;</span>

		<span class="n">uea_warn</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;use deprecated cmvs version, &quot;</span>
			<span class="s">&quot;please update your firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_write_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span>
				<span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmvs_v1</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">),</span>
				<span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmvs_v1</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">),</span>
				<span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmvs_v1</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ver</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uea_cmvs_v2</span> <span class="o">*</span><span class="n">cmvs_v2</span> <span class="o">=</span> <span class="n">cmvs_ptr</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_write_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span>
				<span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmvs_v2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">),</span>
				<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmvs_v2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">),</span>
				<span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmvs_v2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* This really should not happen */</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;bad cmvs version %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enter in R-ACT-REQ */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_write_cmv_e1</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">E1_SA_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">uea_vdbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;Entering in R-ACT-REQ state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">uea_info</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;modem started, waiting &quot;</span>
						<span class="s">&quot;synchronization...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">cmvs_fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_send_cmvs_e4</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cmvs_ptr</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">cmvs_fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ver</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* we can only handle v2 cmv firmware version; */</span>

	<span class="cm">/* Enter in R-IDLE (cmv) until instructed otherwise */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_write_cmv_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E4_SA_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Dump firmware version */</span>
	<span class="cm">/* XXX don&#39;t read the 3th byte as it is always 6 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_read_cmv_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">E4_SA_INFO</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">firmid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">uea_info</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;ATU-R firmware version : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">firmid</span><span class="p">);</span>


	<span class="cm">/* get options */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">len</span> <span class="o">=</span> <span class="n">request_cmvs</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmvs_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmvs_fw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* send options */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ver</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uea_cmvs_v2</span> <span class="o">*</span><span class="n">cmvs_v2</span> <span class="o">=</span> <span class="n">cmvs_ptr</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_write_cmv_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmvs_v2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">group</span><span class="p">),</span>
				<span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmvs_v2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">),</span>
				<span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmvs_v2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">),</span>
				<span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmvs_v2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* This really should not happen */</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;bad cmvs version %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enter in R-ACT-REQ */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_write_cmv_e4</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E4_SA_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">uea_vdbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;Entering in R-ACT-REQ state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">uea_info</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;modem started, waiting &quot;</span>
						<span class="s">&quot;synchronization...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">cmvs_fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Start boot post firmware modem:</span>
<span class="cm"> * - send reset commands through usb control pipe</span>
<span class="cm"> * - start workqueue for DSP loading</span>
<span class="cm"> * - send CMV options to modem</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_start_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* ;-) */</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">uea_enters</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="n">uea_info</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;(re)booting started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* mask interrupt */</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">booting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* We need to set this here because, a ack timeout could have occurred,</span>
<span class="cm">	 * but before we start the reboot, the ack occurs and set this to 1.</span>
<span class="cm">	 * So we will failed to wait Ready CMV.</span>
<span class="cm">	 */</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">UPDATE_ATM_SIGNAL</span><span class="p">(</span><span class="n">ATM_PHY_SIG_LOST</span><span class="p">);</span>

	<span class="cm">/* reset statistics */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_stats</span><span class="p">));</span>

	<span class="cm">/* tell the modem that we want to boot in IDMA mode */</span>
	<span class="n">uea_request</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">UEA_SET_MODE</span><span class="p">,</span> <span class="n">UEA_LOOPBACK_ON</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">uea_request</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">UEA_SET_MODE</span><span class="p">,</span> <span class="n">UEA_BOOT_IDMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* enter reset mode */</span>
	<span class="n">uea_request</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">UEA_SET_MODE</span><span class="p">,</span> <span class="n">UEA_START_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* original driver use 200ms, but windows driver use 100ms */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_wait</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* leave reset mode */</span>
	<span class="n">uea_request</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">UEA_SET_MODE</span><span class="p">,</span> <span class="n">UEA_END_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EAGLE_IV</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clear tx and rx mailboxes */</span>
		<span class="n">uea_request</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">UEA_SET_2183_DATA</span><span class="p">,</span> <span class="n">UEA_MPTX_MAILBOX</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">);</span>
		<span class="n">uea_request</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">UEA_SET_2183_DATA</span><span class="p">,</span> <span class="n">UEA_MPRX_MAILBOX</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">);</span>
		<span class="n">uea_request</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">UEA_SET_2183_DATA</span><span class="p">,</span> <span class="n">UEA_SWAP_MAILBOX</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_wait</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">==</span> <span class="n">EAGLE_IV</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_dsc</span><span class="p">.</span><span class="n">e4</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">E4_MAKEFUNCTION</span><span class="p">(</span><span class="n">E4_ADSLDIRECTIVE</span><span class="p">,</span>
							<span class="n">E4_MODEMREADY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_dsc</span><span class="p">.</span><span class="n">e1</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">E1_MAKEFUNCTION</span><span class="p">(</span><span class="n">E1_ADSLDIRECTIVE</span><span class="p">,</span>
							<span class="n">E1_MODEMREADY</span><span class="p">);</span>

	<span class="cm">/* demask interrupt */</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">booting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* start loading DSP */</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">pageno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ovl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>

	<span class="cm">/* wait for modem ready CMV */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_cmv_ack</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">uea_vdbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;Ready CMV received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">send_cmvs</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * In case of an error wait 1s before rebooting the modem</span>
<span class="cm"> * if the modem don&#39;t request reboot (-EAGAIN).</span>
<span class="cm"> * Monitor the modem every 1s.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_kthread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">set_freezable</span><span class="p">();</span>
	<span class="n">uea_enters</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_start_reset</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
			<span class="n">uea_wait</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>
		<span class="n">try_to_freeze</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load second usb firmware for ADI930 chip */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_XILINX_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ln</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pfw</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span> <span class="o">=</span> <span class="n">FW_DIR</span> <span class="s">&quot;930-fpga.bin&quot;</span><span class="p">;</span>

	<span class="n">uea_enters</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_entry</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;firmware %s is not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fw_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pfw</span> <span class="o">=</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mh">0x577B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;firmware %s is corrupted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fw_name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">u</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">u</span> <span class="o">+=</span> <span class="n">ln</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ln</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">u</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_request</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">pfw</span> <span class="o">+</span> <span class="n">u</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
			       <span class="s">&quot;elsa download data failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* finish to send the fpga */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_request</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
				<span class="s">&quot;elsa download data failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Tell the modem we finish : de-assert reset */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_send_modem_cmd</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="s">&quot;elsa de-assert failed with error&quot;</span>
								<span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

<span class="nl">err1:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>
<span class="nl">err0:</span>
	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The modem send us an ack. First with check if it right */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uea_dispatch_cmv_e1</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">intr_pkt</span> <span class="o">*</span><span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmv_dsc_e1</span> <span class="o">*</span><span class="n">dsc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_dsc</span><span class="p">.</span><span class="n">e1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmv_e1</span> <span class="o">*</span><span class="n">cmv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e1</span><span class="p">.</span><span class="n">s2</span><span class="p">.</span><span class="n">cmv</span><span class="p">;</span>

	<span class="n">uea_enters</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wPreamble</span><span class="p">)</span> <span class="o">!=</span> <span class="n">E1_PREAMBLE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">bDirection</span> <span class="o">!=</span> <span class="n">E1_MODEMTOHOST</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad1</span><span class="p">;</span>

	<span class="cm">/* FIXME : ADI930 reply wrong preambule (func = 2, sub = 2) to</span>
<span class="cm">	 * the first MEMACCESS cmv. Ignore it...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">bFunction</span> <span class="o">!=</span> <span class="n">dsc</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">==</span> <span class="n">ADI930</span>
				<span class="o">&amp;&amp;</span> <span class="n">cmv</span><span class="o">-&gt;</span><span class="n">bFunction</span> <span class="o">==</span>  <span class="n">E1_MAKEFUNCTION</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wIndex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dsc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
			<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">dsc</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">dwSymbolicAddress</span><span class="p">);</span>
			<span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wOffsetAddress</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dsc</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">bad2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">bFunction</span> <span class="o">==</span> <span class="n">E1_MAKEFUNCTION</span><span class="p">(</span><span class="n">E1_ADSLDIRECTIVE</span><span class="p">,</span>
							<span class="n">E1_MODEMREADY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wake_up_cmv_ack</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">uea_leaves</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* in case of MEMACCESS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dsc</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">||</span>
	    <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">dwSymbolicAddress</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dsc</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">||</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wOffsetAddress</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dsc</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad2</span><span class="p">;</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">dwData</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">wake_up_cmv_ack</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">bad2:</span>
	<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;unexpected cmv received, &quot;</span>
			<span class="s">&quot;Function : %d, Subfunction : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">E1_FUNCTION_TYPE</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">bFunction</span><span class="p">),</span>
			<span class="n">E1_FUNCTION_SUBTYPE</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">bFunction</span><span class="p">));</span>
	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">bad1:</span>
	<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;invalid cmv received, &quot;</span>
			<span class="s">&quot;wPreamble %d, bDirection %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wPreamble</span><span class="p">),</span> <span class="n">cmv</span><span class="o">-&gt;</span><span class="n">bDirection</span><span class="p">);</span>
	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* The modem send us an ack. First with check if it right */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uea_dispatch_cmv_e4</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">intr_pkt</span> <span class="o">*</span><span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmv_dsc_e4</span> <span class="o">*</span><span class="n">dsc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">cmv_dsc</span><span class="p">.</span><span class="n">e4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmv_e4</span> <span class="o">*</span><span class="n">cmv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e4</span><span class="p">.</span><span class="n">s2</span><span class="p">.</span><span class="n">cmv</span><span class="p">;</span>

	<span class="n">uea_enters</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="n">uea_dbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;cmv %x %x %x %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wGroup</span><span class="p">),</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wFunction</span><span class="p">),</span>
		<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wOffset</span><span class="p">),</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wAddress</span><span class="p">),</span>
		<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">dwData</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">dwData</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wFunction</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dsc</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wFunction</span><span class="p">)</span> <span class="o">==</span> <span class="n">E4_MAKEFUNCTION</span><span class="p">(</span><span class="n">E4_ADSLDIRECTIVE</span><span class="p">,</span>
						<span class="n">E4_MODEMREADY</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wake_up_cmv_ack</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">uea_leaves</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* in case of MEMACCESS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wOffset</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dsc</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">||</span>
	    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wGroup</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dsc</span><span class="o">-&gt;</span><span class="n">group</span> <span class="o">||</span>
	    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wAddress</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dsc</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad2</span><span class="p">;</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">dwData</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">data1</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">dwData</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">wake_up_cmv_ack</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">bad2:</span>
	<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;unexpected cmv received, &quot;</span>
			<span class="s">&quot;Function : %d, Subfunction : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">E4_FUNCTION_TYPE</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wFunction</span><span class="p">),</span>
			<span class="n">E4_FUNCTION_SUBTYPE</span><span class="p">(</span><span class="n">cmv</span><span class="o">-&gt;</span><span class="n">wFunction</span><span class="p">));</span>
	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uea_schedule_load_page_e1</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">intr_pkt</span> <span class="o">*</span><span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">pageno</span> <span class="o">=</span> <span class="n">intr</span><span class="o">-&gt;</span><span class="n">e1_bSwapPageNo</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ovl</span> <span class="o">=</span> <span class="n">intr</span><span class="o">-&gt;</span><span class="n">e1_bOvl</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">intr</span><span class="o">-&gt;</span><span class="n">e1_bOvl</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uea_schedule_load_page_e4</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">intr_pkt</span> <span class="o">*</span><span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">pageno</span> <span class="o">=</span> <span class="n">intr</span><span class="o">-&gt;</span><span class="n">e4_bSwapPageNo</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * interrupt handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uea_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intr_pkt</span> <span class="o">*</span><span class="n">intr</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">uea_enters</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;uea_intr() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* device-to-host interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">bType</span> <span class="o">!=</span> <span class="mh">0x08</span> <span class="o">||</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">booting</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;wrong interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">resubmit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">wInterrupt</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INT_LOADSWAPPAGE</span>:
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">schedule_load_page</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">intr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">INT_INCOMINGCMV</span>:
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">dispatch_cmv</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">intr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;unknown interrupt %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">wInterrupt</span><span class="p">));</span>
	<span class="p">}</span>

<span class="nl">resubmit:</span>
	<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">urb_int</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start the modem : init the data and start kernel thread</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_boot</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intr_pkt</span> <span class="o">*</span><span class="n">intr</span><span class="p">;</span>

	<span class="n">uea_enters</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">==</span> <span class="n">EAGLE_IV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">E4_INTR_PKT_SIZE</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">dispatch_cmv</span> <span class="o">=</span> <span class="n">uea_dispatch_cmv_e4</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">schedule_load_page</span> <span class="o">=</span> <span class="n">uea_schedule_load_page_e4</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">uea_stat_e4</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">send_cmvs</span> <span class="o">=</span> <span class="n">uea_send_cmvs_e4</span><span class="p">;</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span> <span class="n">uea_load_page_e4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">E1_INTR_PKT_SIZE</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">dispatch_cmv</span> <span class="o">=</span> <span class="n">uea_dispatch_cmv_e1</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">schedule_load_page</span> <span class="o">=</span> <span class="n">uea_schedule_load_page_e1</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">uea_stat_e1</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">send_cmvs</span> <span class="o">=</span> <span class="n">uea_send_cmvs_e1</span><span class="p">;</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span> <span class="n">uea_load_page_e1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sync_q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">==</span> <span class="n">ADI930</span><span class="p">)</span>
		<span class="n">load_XILINX_firmware</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">intr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
		       <span class="s">&quot;cannot allocate interrupt package</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">urb_int</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">urb_int</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;cannot allocate interrupt URB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">urb_int</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span>
			 <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">UEA_INTR_PIPE</span><span class="p">),</span>
			 <span class="n">intr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">uea_intr</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span>
			 <span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span>
			 <span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterval</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">urb_int</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
		       <span class="s">&quot;urb submition failed with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create worker thread, but don&#39;t start it here.  Start it after</span>
<span class="cm">	 * all usbatm generic initialization is done.</span>
<span class="cm">	 */</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">kthread</span> <span class="o">=</span> <span class="n">kthread_create</span><span class="p">(</span><span class="n">uea_kthread</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="s">&quot;ueagle-atm&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">kthread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;failed to create thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err2:</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">urb_int</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">urb_int</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">urb_int</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">intr</span><span class="p">);</span>
<span class="nl">err0:</span>
	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stop the modem : kill kernel thread and free data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uea_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">uea_enters</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">kthread_stop</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">kthread</span><span class="p">);</span>
	<span class="n">uea_dbg</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="s">&quot;kthread finish with status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">uea_request</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">UEA_SET_MODE</span><span class="p">,</span> <span class="n">UEA_LOOPBACK_ON</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">urb_int</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">urb_int</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">urb_int</span><span class="p">);</span>

	<span class="cm">/* flush the work item, when no one can schedule it */</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dsp_firm</span><span class="p">);</span>
	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">INS_TO_USBDEV</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* syfs interface */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="nf">dev_to_uea</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm</span><span class="p">;</span>

	<span class="n">intf</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intf</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">usbatm</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbatm</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">usbatm</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uea_mutex</span><span class="p">);</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">dev_to_uea</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s">&quot;%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uea_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">reboot</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uea_mutex</span><span class="p">);</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">dev_to_uea</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uea_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">stat_status</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">read_status</span><span class="p">,</span> <span class="n">reboot</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">read_human_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">modem_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uea_mutex</span><span class="p">);</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">dev_to_uea</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">==</span> <span class="n">EAGLE_IV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x0</span>:	<span class="cm">/* not yet synchronized */</span>
		<span class="k">case</span> <span class="mh">0x1</span>:
		<span class="k">case</span> <span class="mh">0x3</span>:
		<span class="k">case</span> <span class="mh">0x4</span>:
			<span class="n">modem_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x5</span>:	<span class="cm">/* initialization */</span>
		<span class="k">case</span> <span class="mh">0x6</span>:
		<span class="k">case</span> <span class="mh">0x9</span>:
		<span class="k">case</span> <span class="mh">0xa</span>:
			<span class="n">modem_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x7</span>:	<span class="cm">/* operational */</span>
			<span class="n">modem_state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x2</span>:	<span class="cm">/* fail ... */</span>
			<span class="n">modem_state</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="cm">/* unknown */</span>
			<span class="n">modem_state</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">modem_state</span> <span class="o">=</span> <span class="n">GET_STATUS</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">modem_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Modem is booting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Modem is initializing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Modem is operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Modem synchronization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Modem state is unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uea_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">stat_human_status</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">read_human_status</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">read_delin</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">delin</span> <span class="o">=</span> <span class="s">&quot;GOOD&quot;</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uea_mutex</span><span class="p">);</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">dev_to_uea</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">==</span> <span class="n">EAGLE_IV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span>
			<span class="n">delin</span> <span class="o">=</span> <span class="s">&quot;RESET&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span>
			<span class="n">delin</span> <span class="o">=</span> <span class="s">&quot;LOSS&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x0C00</span><span class="p">)</span>
			<span class="n">delin</span> <span class="o">=</span> <span class="s">&quot;ERROR&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x0030</span><span class="p">)</span>
			<span class="n">delin</span> <span class="o">=</span> <span class="s">&quot;LOSS&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">delin</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uea_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">stat_delin</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">read_delin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cp">#define UEA_ATTR(name, reset)					\</span>
<span class="cp">								\</span>
<span class="cp">static ssize_t read_##name(struct device *dev,			\</span>
<span class="cp">		struct device_attribute *attr, char *buf)	\</span>
<span class="cp">{								\</span>
<span class="cp">	int ret = -ENODEV;					\</span>
<span class="cp">	struct uea_softc *sc;					\</span>
<span class="cp">								\</span>
<span class="cp">	mutex_lock(&amp;uea_mutex);					\</span>
<span class="cp">	sc = dev_to_uea(dev);					\</span>
<span class="cp">	if (!sc)						\</span>
<span class="cp">		goto out;					\</span>
<span class="cp">	ret = snprintf(buf, 10, &quot;%08x\n&quot;, sc-&gt;stats.phy.name);	\</span>
<span class="cp">	if (reset)						\</span>
<span class="cp">		sc-&gt;stats.phy.name = 0;				\</span>
<span class="cp">out:								\</span>
<span class="cp">	mutex_unlock(&amp;uea_mutex);				\</span>
<span class="cp">	return ret;						\</span>
<span class="cp">}								\</span>
<span class="cp">								\</span>
<span class="cp">static DEVICE_ATTR(stat_##name, S_IRUGO, read_##name, NULL)</span>

<span class="n">UEA_ATTR</span><span class="p">(</span><span class="n">mflags</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">UEA_ATTR</span><span class="p">(</span><span class="n">vidcpe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">UEA_ATTR</span><span class="p">(</span><span class="n">usrate</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">UEA_ATTR</span><span class="p">(</span><span class="n">dsrate</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">UEA_ATTR</span><span class="p">(</span><span class="n">usattenuation</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">UEA_ATTR</span><span class="p">(</span><span class="n">dsattenuation</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">UEA_ATTR</span><span class="p">(</span><span class="n">usmargin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">UEA_ATTR</span><span class="p">(</span><span class="n">dsmargin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">UEA_ATTR</span><span class="p">(</span><span class="n">txflow</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">UEA_ATTR</span><span class="p">(</span><span class="n">rxflow</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">UEA_ATTR</span><span class="p">(</span><span class="n">uscorr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">UEA_ATTR</span><span class="p">(</span><span class="n">dscorr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">UEA_ATTR</span><span class="p">(</span><span class="n">usunc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">UEA_ATTR</span><span class="p">(</span><span class="n">dsunc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">UEA_ATTR</span><span class="p">(</span><span class="n">firmid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* Retrieve the device End System Identifier (MAC) */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_getesi</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span> <span class="n">esi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mac_str</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ETH_ALEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_string</span>
	    <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">iSerialNumber</span><span class="p">,</span> <span class="n">mac_str</span><span class="p">,</span>
	     <span class="k">sizeof</span><span class="p">(</span><span class="n">mac_str</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">esi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">mac_str</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span>
			 <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">mac_str</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ATM stuff */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_atm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">atm_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">usbatm</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">uea_getesi</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_heavy</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">usbatm</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sync_q</span><span class="p">,</span> <span class="n">IS_OPERATIONAL</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">claim_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ifnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">ifnum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="s">&quot;interface %d not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_driver_claim_interface</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uea_driver</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">usbatm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t claim interface %d, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifnum</span><span class="p">,</span>
		       <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_mflags</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_human_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_delin</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_vidcpe</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_usrate</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_dsrate</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_usattenuation</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_dsattenuation</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_usmargin</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_dsmargin</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_txflow</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_rxflow</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_uscorr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_dscorr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_usunc</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_dsunc</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stat_firmid</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">attr_grp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">ifnum</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alt</span><span class="p">;</span>

	<span class="n">uea_enters</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>

	<span class="cm">/* interface 0 is for firmware/monitoring */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifnum</span> <span class="o">!=</span> <span class="n">UEA_INTR_IFACE_NO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">usbatm</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">sync_wait</span><span class="p">[</span><span class="n">modem_index</span><span class="p">]</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">UDSL_SKIP_HEAVY_INIT</span><span class="p">);</span>

	<span class="cm">/* interface 1 is for outbound traffic */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">claim_interface</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">usbatm</span><span class="p">,</span> <span class="n">UEA_US_IFACE_NO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* ADI930 has only 2 interfaces and inbound traffic is on interface 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ADI930</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* interface 2 is for inbound traffic */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">claim_interface</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">usbatm</span><span class="p">,</span> <span class="n">UEA_DS_IFACE_NO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">uea_softc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uea_err</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="s">&quot;uea_init: not enough memory !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">usb</span><span class="p">;</span>
	<span class="n">usbatm</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">sc</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">usbatm</span> <span class="o">=</span> <span class="n">usbatm</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">modem_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">modem_index</span> <span class="o">&lt;</span> <span class="n">NB_MODEM</span><span class="p">)</span> <span class="o">?</span> <span class="n">modem_index</span><span class="o">++</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">;</span>

	<span class="cm">/* first try to use module parameter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">annex</span><span class="p">[</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">modem_index</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">annex</span> <span class="o">=</span> <span class="n">ANNEXA</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">annex</span><span class="p">[</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">modem_index</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">annex</span> <span class="o">=</span> <span class="n">ANNEXB</span><span class="p">;</span>
	<span class="cm">/* try to autodetect annex */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">driver_info</span> <span class="o">&amp;</span> <span class="n">AUTO_ANNEX_A</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">annex</span> <span class="o">=</span> <span class="n">ANNEXA</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">driver_info</span> <span class="o">&amp;</span> <span class="n">AUTO_ANNEX_B</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">annex</span> <span class="o">=</span> <span class="n">ANNEXB</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">annex</span> <span class="o">=</span> <span class="p">(</span><span class="n">le16_to_cpu</span>
		<span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bcdDevice</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="n">ANNEXB</span> <span class="o">:</span> <span class="n">ANNEXA</span><span class="p">;</span>

	<span class="n">alt</span> <span class="o">=</span> <span class="n">altsetting</span><span class="p">[</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">modem_index</span><span class="p">];</span>
	<span class="cm">/* ADI930 don&#39;t support iso */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ADI930</span> <span class="o">&amp;&amp;</span> <span class="n">alt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alt</span> <span class="o">&lt;=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
			<span class="n">usb_set_interface</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">UEA_DS_IFACE_NO</span><span class="p">,</span> <span class="n">alt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uea_dbg</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="s">&quot;set alternate %u for 2 interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">alt</span><span class="p">);</span>
			<span class="n">uea_info</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="s">&quot;using iso mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">usbatm</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">UDSL_USE_ISOC</span> <span class="o">|</span> <span class="n">UDSL_IGNORE_EILSEQ</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">uea_err</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="s">&quot;setting alternate %u failed for &quot;</span>
					<span class="s">&quot;2 interface, using bulk mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">alt</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr_grp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uea_boot</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_rm_grp</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_rm_grp:</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr_grp</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uea_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">usbatm</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr_grp</span><span class="p">);</span>
	<span class="n">uea_stop</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usbatm_driver</span> <span class="n">uea_usbatm_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;ueagle-atm&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">uea_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">atm_start</span> <span class="o">=</span> <span class="n">uea_atm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind</span> <span class="o">=</span> <span class="n">uea_unbind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">heavy_init</span> <span class="o">=</span> <span class="n">uea_heavy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bulk_in</span> <span class="o">=</span> <span class="n">UEA_BULK_DATA_PIPE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bulk_out</span> <span class="o">=</span> <span class="n">UEA_BULK_DATA_PIPE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">isoc_in</span> <span class="o">=</span> <span class="n">UEA_ISO_DATA_PIPE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uea_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">uea_enters</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>
	<span class="n">uea_info</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="s">&quot;ADSL device founded vid (%#X) pid (%#X) Rev (%#X): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">),</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">),</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bcdDevice</span><span class="p">),</span>
		<span class="n">chip_name</span><span class="p">[</span><span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">id</span><span class="p">)]);</span>

	<span class="n">usb_reset_device</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UEA_IS_PREFIRM</span><span class="p">(</span><span class="n">id</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">uea_load_firmware</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">UEA_CHIP_VERSION</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbatm_usb_probe</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uea_usbatm_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">uea_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">usbatm</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

		<span class="cm">/* Ensure carrier is initialized to off as early as possible */</span>
		<span class="n">UPDATE_ATM_SIGNAL</span><span class="p">(</span><span class="n">ATM_PHY_SIG_LOST</span><span class="p">);</span>

		<span class="cm">/* Only start the worker thread when all init is done */</span>
		<span class="n">wake_up_process</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">kthread</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uea_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ifnum</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="n">uea_enters</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>

	<span class="cm">/* ADI930 has 2 interfaces and eagle 3 interfaces.</span>
<span class="cm">	 * Pre-firmware device has one interface</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumInterfaces</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ifnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uea_mutex</span><span class="p">);</span>
		<span class="n">usbatm_usb_disconnect</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uea_mutex</span><span class="p">);</span>
		<span class="n">uea_info</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="s">&quot;ADSL device removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">uea_leaves</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * List of supported VID/PID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">uea_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ANALOG_VID</span><span class="p">,</span>	<span class="n">ADI930_PID_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">ADI930</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ANALOG_VID</span><span class="p">,</span>	<span class="n">ADI930_PID_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">ADI930</span> <span class="o">|</span> <span class="n">PSTFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ANALOG_VID</span><span class="p">,</span>	<span class="n">EAGLE_I_PID_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_I</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ANALOG_VID</span><span class="p">,</span>	<span class="n">EAGLE_I_PID_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_I</span> <span class="o">|</span> <span class="n">PSTFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ANALOG_VID</span><span class="p">,</span>	<span class="n">EAGLE_II_PID_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_II</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ANALOG_VID</span><span class="p">,</span>	<span class="n">EAGLE_II_PID_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_II</span> <span class="o">|</span> <span class="n">PSTFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ANALOG_VID</span><span class="p">,</span>	<span class="n">EAGLE_IIC_PID_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_II</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ANALOG_VID</span><span class="p">,</span>	<span class="n">EAGLE_IIC_PID_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_II</span> <span class="o">|</span> <span class="n">PSTFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ANALOG_VID</span><span class="p">,</span>	<span class="n">EAGLE_III_PID_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_III</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ANALOG_VID</span><span class="p">,</span>	<span class="n">EAGLE_III_PID_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_III</span> <span class="o">|</span> <span class="n">PSTFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ANALOG_VID</span><span class="p">,</span>	<span class="n">EAGLE_IV_PID_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_IV</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ANALOG_VID</span><span class="p">,</span>	<span class="n">EAGLE_IV_PID_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_IV</span> <span class="o">|</span> <span class="n">PSTFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">DEVOLO_VID</span><span class="p">,</span>	<span class="n">DEVOLO_EAGLE_I_A_PID_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_I</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">DEVOLO_VID</span><span class="p">,</span>	<span class="n">DEVOLO_EAGLE_I_A_PID_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_I</span> <span class="o">|</span> <span class="n">PSTFIRM</span> <span class="o">|</span> <span class="n">AUTO_ANNEX_A</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">DEVOLO_VID</span><span class="p">,</span>	<span class="n">DEVOLO_EAGLE_I_B_PID_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_I</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">DEVOLO_VID</span><span class="p">,</span>	<span class="n">DEVOLO_EAGLE_I_B_PID_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_I</span> <span class="o">|</span> <span class="n">PSTFIRM</span> <span class="o">|</span> <span class="n">AUTO_ANNEX_B</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">DEVOLO_VID</span><span class="p">,</span>	<span class="n">DEVOLO_EAGLE_II_A_PID_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_II</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">DEVOLO_VID</span><span class="p">,</span>	<span class="n">DEVOLO_EAGLE_II_A_PID_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_II</span> <span class="o">|</span> <span class="n">PSTFIRM</span> <span class="o">|</span> <span class="n">AUTO_ANNEX_A</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">DEVOLO_VID</span><span class="p">,</span>	<span class="n">DEVOLO_EAGLE_II_B_PID_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_II</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">DEVOLO_VID</span><span class="p">,</span>	<span class="n">DEVOLO_EAGLE_II_B_PID_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_II</span> <span class="o">|</span> <span class="n">PSTFIRM</span> <span class="o">|</span> <span class="n">AUTO_ANNEX_B</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ELSA_VID</span><span class="p">,</span>	<span class="n">ELSA_PID_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">ADI930</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ELSA_VID</span><span class="p">,</span>	<span class="n">ELSA_PID_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">ADI930</span> <span class="o">|</span> <span class="n">PSTFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ELSA_VID</span><span class="p">,</span>	<span class="n">ELSA_PID_A_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">ADI930</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ELSA_VID</span><span class="p">,</span>	<span class="n">ELSA_PID_A_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">ADI930</span> <span class="o">|</span> <span class="n">PSTFIRM</span> <span class="o">|</span> <span class="n">AUTO_ANNEX_A</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ELSA_VID</span><span class="p">,</span>	<span class="n">ELSA_PID_B_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">ADI930</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">ELSA_VID</span><span class="p">,</span>	<span class="n">ELSA_PID_B_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">ADI930</span> <span class="o">|</span> <span class="n">PSTFIRM</span> <span class="o">|</span> <span class="n">AUTO_ANNEX_B</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USR_VID</span><span class="p">,</span>	<span class="n">MILLER_A_PID_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_I</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USR_VID</span><span class="p">,</span>	<span class="n">MILLER_A_PID_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_I</span> <span class="o">|</span> <span class="n">PSTFIRM</span>  <span class="o">|</span> <span class="n">AUTO_ANNEX_A</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USR_VID</span><span class="p">,</span>	<span class="n">MILLER_B_PID_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_I</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USR_VID</span><span class="p">,</span>	<span class="n">MILLER_B_PID_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_I</span> <span class="o">|</span> <span class="n">PSTFIRM</span>  <span class="o">|</span> <span class="n">AUTO_ANNEX_B</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USR_VID</span><span class="p">,</span>	<span class="n">HEINEKEN_A_PID_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_I</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USR_VID</span><span class="p">,</span>	<span class="n">HEINEKEN_A_PID_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_I</span> <span class="o">|</span> <span class="n">PSTFIRM</span> <span class="o">|</span> <span class="n">AUTO_ANNEX_A</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USR_VID</span><span class="p">,</span>	<span class="n">HEINEKEN_B_PID_PREFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_I</span> <span class="o">|</span> <span class="n">PREFIRM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USR_VID</span><span class="p">,</span>	<span class="n">HEINEKEN_B_PID_PSTFIRM</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">EAGLE_I</span> <span class="o">|</span> <span class="n">PSTFIRM</span> <span class="o">|</span> <span class="n">AUTO_ANNEX_B</span><span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * USB driver descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">uea_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ueagle-atm&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">uea_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">uea_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">uea_disconnect</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">uea_ids</span><span class="p">);</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">uea_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Damien Bergamini/Matthieu Castet/Stanislaw W. Gruszka&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ADI 930/Eagle USB ADSL Modem driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
