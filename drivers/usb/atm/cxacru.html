<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › atm › cxacru.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cxacru.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *  cxacru.c  -  driver for USB ADSL modems based on</span>
<span class="cm"> *               Conexant AccessRunner chipset</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2004 David Woodhouse, Duncan Sands, Roman Kagan</span>
<span class="cm"> *  Copyright (C) 2005 Duncan Sands, Roman Kagan (rkagan % mail ! ru)</span>
<span class="cm"> *  Copyright (C) 2007 Simon Arlott</span>
<span class="cm"> *  Copyright (C) 2009 Simon Arlott</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> *  under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> *  Software Foundation; either version 2 of the License, or (at your option)</span>
<span class="cm"> *  any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> *  more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> *  this program; if not, write to the Free Software Foundation, Inc., 59</span>
<span class="cm"> *  Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> *  Credit is due for Josep Comas, who created the original patch to speedtch.c</span>
<span class="cm"> *  to support the different padding used by the AccessRunner (now generalized</span>
<span class="cm"> *  into usbatm), and the userspace firmware loading utility.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;usbatm.h&quot;</span>

<span class="cp">#define DRIVER_AUTHOR	&quot;Roman Kagan, David Woodhouse, Duncan Sands, Simon Arlott&quot;</span>
<span class="cp">#define DRIVER_VERSION	&quot;0.4&quot;</span>
<span class="cp">#define DRIVER_DESC	&quot;Conexant AccessRunner ADSL USB modem driver&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cxacru_driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;cxacru&quot;</span><span class="p">;</span>

<span class="cp">#define CXACRU_EP_CMD		0x01	</span><span class="cm">/* Bulk/interrupt in/out */</span><span class="cp"></span>
<span class="cp">#define CXACRU_EP_DATA		0x02	</span><span class="cm">/* Bulk in/out */</span><span class="cp"></span>

<span class="cp">#define CMD_PACKET_SIZE		64	</span><span class="cm">/* Should be maxpacket(ep)? */</span><span class="cp"></span>
<span class="cp">#define CMD_MAX_CONFIG		((CMD_PACKET_SIZE / 4 - 1) / 2)</span>

<span class="cm">/* Addresses */</span>
<span class="cp">#define PLLFCLK_ADDR	0x00350068</span>
<span class="cp">#define PLLBCLK_ADDR	0x0035006c</span>
<span class="cp">#define SDRAMEN_ADDR	0x00350010</span>
<span class="cp">#define FW_ADDR		0x00801000</span>
<span class="cp">#define BR_ADDR		0x00180600</span>
<span class="cp">#define SIG_ADDR	0x00180500</span>
<span class="cp">#define BR_STACK_ADDR	0x00187f10</span>

<span class="cm">/* Values */</span>
<span class="cp">#define SDRAM_ENA	0x1</span>

<span class="cp">#define CMD_TIMEOUT	2000	</span><span class="cm">/* msecs */</span><span class="cp"></span>
<span class="cp">#define POLL_INTERVAL	1	</span><span class="cm">/* secs */</span><span class="cp"></span>

<span class="cm">/* commands for interaction with the modem through the control channel before</span>
<span class="cm"> * firmware is loaded  */</span>
<span class="k">enum</span> <span class="n">cxacru_fw_request</span> <span class="p">{</span>
	<span class="n">FW_CMD_ERR</span><span class="p">,</span>
	<span class="n">FW_GET_VER</span><span class="p">,</span>
	<span class="n">FW_READ_MEM</span><span class="p">,</span>
	<span class="n">FW_WRITE_MEM</span><span class="p">,</span>
	<span class="n">FW_RMW_MEM</span><span class="p">,</span>
	<span class="n">FW_CHECKSUM_MEM</span><span class="p">,</span>
	<span class="n">FW_GOTO_MEM</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* commands for interaction with the modem through the control channel once</span>
<span class="cm"> * firmware is loaded  */</span>
<span class="k">enum</span> <span class="n">cxacru_cm_request</span> <span class="p">{</span>
	<span class="n">CM_REQUEST_UNDEFINED</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">CM_REQUEST_TEST</span><span class="p">,</span>
	<span class="n">CM_REQUEST_CHIP_GET_MAC_ADDRESS</span><span class="p">,</span>
	<span class="n">CM_REQUEST_CHIP_GET_DP_VERSIONS</span><span class="p">,</span>
	<span class="n">CM_REQUEST_CHIP_ADSL_LINE_START</span><span class="p">,</span>
	<span class="n">CM_REQUEST_CHIP_ADSL_LINE_STOP</span><span class="p">,</span>
	<span class="n">CM_REQUEST_CHIP_ADSL_LINE_GET_STATUS</span><span class="p">,</span>
	<span class="n">CM_REQUEST_CHIP_ADSL_LINE_GET_SPEED</span><span class="p">,</span>
	<span class="n">CM_REQUEST_CARD_INFO_GET</span><span class="p">,</span>
	<span class="n">CM_REQUEST_CARD_DATA_GET</span><span class="p">,</span>
	<span class="n">CM_REQUEST_CARD_DATA_SET</span><span class="p">,</span>
	<span class="n">CM_REQUEST_COMMAND_HW_IO</span><span class="p">,</span>
	<span class="n">CM_REQUEST_INTERFACE_HW_IO</span><span class="p">,</span>
	<span class="n">CM_REQUEST_CARD_SERIAL_DATA_PATH_GET</span><span class="p">,</span>
	<span class="n">CM_REQUEST_CARD_SERIAL_DATA_PATH_SET</span><span class="p">,</span>
	<span class="n">CM_REQUEST_CARD_CONTROLLER_VERSION_GET</span><span class="p">,</span>
	<span class="n">CM_REQUEST_CARD_GET_STATUS</span><span class="p">,</span>
	<span class="n">CM_REQUEST_CARD_GET_MAC_ADDRESS</span><span class="p">,</span>
	<span class="n">CM_REQUEST_CARD_GET_DATA_LINK_STATUS</span><span class="p">,</span>
	<span class="n">CM_REQUEST_MAX</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* commands for interaction with the flash memory</span>
<span class="cm"> *</span>
<span class="cm"> * read:  response is the contents of the first 60 bytes of flash memory</span>
<span class="cm"> * write: request contains the 60 bytes of data to write to flash memory</span>
<span class="cm"> *        response is the contents of the first 60 bytes of flash memory</span>
<span class="cm"> *</span>
<span class="cm"> * layout: PP PP VV VV  MM MM MM MM  MM MM ?? ??  SS SS SS SS  SS SS SS SS</span>
<span class="cm"> *         SS SS SS SS  SS SS SS SS  00 00 00 00  00 00 00 00  00 00 00 00</span>
<span class="cm"> *         00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00</span>
<span class="cm"> *</span>
<span class="cm"> *   P: le16  USB Product ID</span>
<span class="cm"> *   V: le16  USB Vendor ID</span>
<span class="cm"> *   M: be48  MAC Address</span>
<span class="cm"> *   S: le16  ASCII Serial Number</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">cxacru_cm_flash</span> <span class="p">{</span>
	<span class="n">CM_FLASH_READ</span> <span class="o">=</span> <span class="mh">0xa1</span><span class="p">,</span>
	<span class="n">CM_FLASH_WRITE</span> <span class="o">=</span> <span class="mh">0xa2</span>
<span class="p">};</span>

<span class="cm">/* reply codes to the commands above */</span>
<span class="k">enum</span> <span class="n">cxacru_cm_status</span> <span class="p">{</span>
	<span class="n">CM_STATUS_UNDEFINED</span><span class="p">,</span>
	<span class="n">CM_STATUS_SUCCESS</span><span class="p">,</span>
	<span class="n">CM_STATUS_ERROR</span><span class="p">,</span>
	<span class="n">CM_STATUS_UNSUPPORTED</span><span class="p">,</span>
	<span class="n">CM_STATUS_UNIMPLEMENTED</span><span class="p">,</span>
	<span class="n">CM_STATUS_PARAMETER_ERROR</span><span class="p">,</span>
	<span class="n">CM_STATUS_DBG_LOOPBACK</span><span class="p">,</span>
	<span class="n">CM_STATUS_MAX</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* indices into CARD_INFO_GET return array */</span>
<span class="k">enum</span> <span class="n">cxacru_info_idx</span> <span class="p">{</span>
	<span class="n">CXINF_DOWNSTREAM_RATE</span><span class="p">,</span>
	<span class="n">CXINF_UPSTREAM_RATE</span><span class="p">,</span>
	<span class="n">CXINF_LINK_STATUS</span><span class="p">,</span>
	<span class="n">CXINF_LINE_STATUS</span><span class="p">,</span>
	<span class="n">CXINF_MAC_ADDRESS_HIGH</span><span class="p">,</span>
	<span class="n">CXINF_MAC_ADDRESS_LOW</span><span class="p">,</span>
	<span class="n">CXINF_UPSTREAM_SNR_MARGIN</span><span class="p">,</span>
	<span class="n">CXINF_DOWNSTREAM_SNR_MARGIN</span><span class="p">,</span>
	<span class="n">CXINF_UPSTREAM_ATTENUATION</span><span class="p">,</span>
	<span class="n">CXINF_DOWNSTREAM_ATTENUATION</span><span class="p">,</span>
	<span class="n">CXINF_TRANSMITTER_POWER</span><span class="p">,</span>
	<span class="n">CXINF_UPSTREAM_BITS_PER_FRAME</span><span class="p">,</span>
	<span class="n">CXINF_DOWNSTREAM_BITS_PER_FRAME</span><span class="p">,</span>
	<span class="n">CXINF_STARTUP_ATTEMPTS</span><span class="p">,</span>
	<span class="n">CXINF_UPSTREAM_CRC_ERRORS</span><span class="p">,</span>
	<span class="n">CXINF_DOWNSTREAM_CRC_ERRORS</span><span class="p">,</span>
	<span class="n">CXINF_UPSTREAM_FEC_ERRORS</span><span class="p">,</span>
	<span class="n">CXINF_DOWNSTREAM_FEC_ERRORS</span><span class="p">,</span>
	<span class="n">CXINF_UPSTREAM_HEC_ERRORS</span><span class="p">,</span>
	<span class="n">CXINF_DOWNSTREAM_HEC_ERRORS</span><span class="p">,</span>
	<span class="n">CXINF_LINE_STARTABLE</span><span class="p">,</span>
	<span class="n">CXINF_MODULATION</span><span class="p">,</span>
	<span class="n">CXINF_ADSL_HEADEND</span><span class="p">,</span>
	<span class="n">CXINF_ADSL_HEADEND_ENVIRONMENT</span><span class="p">,</span>
	<span class="n">CXINF_CONTROLLER_VERSION</span><span class="p">,</span>
	<span class="cm">/* dunno what the missing two mean */</span>
	<span class="n">CXINF_MAX</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">cxacru_poll_state</span> <span class="p">{</span>
	<span class="n">CXPOLL_STOPPING</span><span class="p">,</span>
	<span class="n">CXPOLL_STOPPED</span><span class="p">,</span>
	<span class="n">CXPOLL_POLLING</span><span class="p">,</span>
	<span class="n">CXPOLL_SHUTDOWN</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cxacru_modem_type</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">pll_f_clk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pll_b_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">boot_rom_patch</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cxacru_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">cxacru_modem_type</span> <span class="o">*</span><span class="n">modem_type</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">line_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">adsl_state_serialize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">adsl_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">poll_work</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">card_info</span><span class="p">[</span><span class="n">CXINF_MAX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">poll_state_serialize</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">cxacru_poll_state</span> <span class="n">poll_state</span><span class="p">;</span>

	<span class="cm">/* contol handles */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">cm_serialize</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rcv_buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">snd_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">rcv_urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">snd_urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">rcv_done</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">snd_done</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cxacru_cm</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxacru_data</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="k">enum</span> <span class="n">cxacru_cm_request</span> <span class="n">cm</span><span class="p">,</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">wdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wsize</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rsize</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cxacru_poll_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="cm">/* Card info exported through sysfs */</span>
<span class="cp">#define CXACRU__ATTR_INIT(_name) \</span>
<span class="cp">static DEVICE_ATTR(_name, S_IRUGO, cxacru_sysfs_show_##_name, NULL)</span>

<span class="cp">#define CXACRU_CMD_INIT(_name) \</span>
<span class="cp">static DEVICE_ATTR(_name, S_IWUSR | S_IRUGO, \</span>
<span class="cp">	cxacru_sysfs_show_##_name, cxacru_sysfs_store_##_name)</span>

<span class="cp">#define CXACRU_SET_INIT(_name) \</span>
<span class="cp">static DEVICE_ATTR(_name, S_IWUSR, \</span>
<span class="cp">	NULL, cxacru_sysfs_store_##_name)</span>

<span class="cp">#define CXACRU_ATTR_INIT(_value, _type, _name) \</span>
<span class="cp">static ssize_t cxacru_sysfs_show_##_name(struct device *dev, \</span>
<span class="cp">	struct device_attribute *attr, char *buf) \</span>
<span class="cp">{ \</span>
<span class="cp">	struct cxacru_data *instance = to_usbatm_driver_data(\</span>
<span class="cp">		to_usb_interface(dev)); \</span>
<span class="cp">\</span>
<span class="cp">	if (instance == NULL) \</span>
<span class="cp">		return -ENODEV; \</span>
<span class="cp">\</span>
<span class="cp">	return cxacru_sysfs_showattr_##_type(instance-&gt;card_info[_value], buf); \</span>
<span class="cp">} \</span>
<span class="cp">CXACRU__ATTR_INIT(_name)</span>

<span class="cp">#define CXACRU_ATTR_CREATE(_v, _t, _name) CXACRU_DEVICE_CREATE_FILE(_name)</span>
<span class="cp">#define CXACRU_CMD_CREATE(_name)          CXACRU_DEVICE_CREATE_FILE(_name)</span>
<span class="cp">#define CXACRU_SET_CREATE(_name)          CXACRU_DEVICE_CREATE_FILE(_name)</span>
<span class="cp">#define CXACRU__ATTR_CREATE(_name)        CXACRU_DEVICE_CREATE_FILE(_name)</span>

<span class="cp">#define CXACRU_ATTR_REMOVE(_v, _t, _name) CXACRU_DEVICE_REMOVE_FILE(_name)</span>
<span class="cp">#define CXACRU_CMD_REMOVE(_name)          CXACRU_DEVICE_REMOVE_FILE(_name)</span>
<span class="cp">#define CXACRU_SET_REMOVE(_name)          CXACRU_DEVICE_REMOVE_FILE(_name)</span>
<span class="cp">#define CXACRU__ATTR_REMOVE(_name)        CXACRU_DEVICE_REMOVE_FILE(_name)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cxacru_sysfs_showattr_u32</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cxacru_sysfs_showattr_s8</span><span class="p">(</span><span class="n">s8</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cxacru_sysfs_showattr_dB</span><span class="p">(</span><span class="n">s16</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u.%02u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">value</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="n">value</span> <span class="o">%</span> <span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">value</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;-%u.%02u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">value</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="n">value</span> <span class="o">%</span> <span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cxacru_sysfs_showattr_bool</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;no&quot;</span><span class="p">,</span> <span class="s">&quot;yes&quot;</span> <span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">str</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">[</span><span class="n">value</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cxacru_sysfs_showattr_LINK</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;not connected&quot;</span><span class="p">,</span> <span class="s">&quot;connected&quot;</span><span class="p">,</span> <span class="s">&quot;lost&quot;</span> <span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="o">||</span> <span class="n">str</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">[</span><span class="n">value</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cxacru_sysfs_showattr_LINE</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;down&quot;</span><span class="p">,</span> <span class="s">&quot;attempting to activate&quot;</span><span class="p">,</span>
		<span class="s">&quot;training&quot;</span><span class="p">,</span> <span class="s">&quot;channel analysis&quot;</span><span class="p">,</span> <span class="s">&quot;exchange&quot;</span><span class="p">,</span> <span class="s">&quot;up&quot;</span><span class="p">,</span>
		<span class="s">&quot;waiting&quot;</span><span class="p">,</span> <span class="s">&quot;initialising&quot;</span>
	<span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">str</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">[</span><span class="n">value</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cxacru_sysfs_showattr_MODU</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="s">&quot;ANSI T1.413&quot;</span><span class="p">,</span>
			<span class="s">&quot;ITU-T G.992.1 (G.DMT)&quot;</span><span class="p">,</span>
			<span class="s">&quot;ITU-T G.992.2 (G.LITE)&quot;</span>
	<span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">str</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">[</span><span class="n">value</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This could use MAC_ADDRESS_HIGH and MAC_ADDRESS_LOW, but since</span>
<span class="cm"> * this data is already in atm_dev there&#39;s no point.</span>
<span class="cm"> *</span>
<span class="cm"> * MAC_ADDRESS_HIGH = 0x????5544</span>
<span class="cm"> * MAC_ADDRESS_LOW  = 0x33221100</span>
<span class="cm"> * Where 00-55 are bytes 0-5 of the MAC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cxacru_sysfs_show_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxacru_data</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span> <span class="n">to_usbatm_driver_data</span><span class="p">(</span>
			<span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="o">-&gt;</span><span class="n">atm_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cxacru_sysfs_show_adsl_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;running&quot;</span><span class="p">,</span> <span class="s">&quot;stopped&quot;</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">cxacru_data</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span> <span class="n">to_usbatm_driver_data</span><span class="p">(</span>
			<span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">card_info</span><span class="p">[</span><span class="n">CXINF_LINE_STARTABLE</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">str</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">[</span><span class="n">value</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cxacru_sysfs_store_adsl_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxacru_data</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span> <span class="n">to_usbatm_driver_data</span><span class="p">(</span>
			<span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">poll</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">str_cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%7s&quot;</span><span class="p">,</span> <span class="n">str_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">adsl_state_serialize</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str_cmd</span><span class="p">,</span> <span class="s">&quot;stop&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str_cmd</span><span class="p">,</span> <span class="s">&quot;restart&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_cm</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">CM_REQUEST_CHIP_ADSL_LINE_STOP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atm_err</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;change adsl state:&quot;</span>
				<span class="s">&quot; CHIP_ADSL_LINE_STOP returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">poll</span> <span class="o">=</span> <span class="n">CXPOLL_STOPPED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Line status is only updated every second</span>
<span class="cm">	 * and the device appears to only react to</span>
<span class="cm">	 * START/STOP every second too. Wait 1.5s to</span>
<span class="cm">	 * be sure that restart will have an effect. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str_cmd</span><span class="p">,</span> <span class="s">&quot;restart&quot;</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1500</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str_cmd</span><span class="p">,</span> <span class="s">&quot;start&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str_cmd</span><span class="p">,</span> <span class="s">&quot;restart&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_cm</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">CM_REQUEST_CHIP_ADSL_LINE_START</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atm_err</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;change adsl state:&quot;</span>
				<span class="s">&quot; CHIP_ADSL_LINE_START returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">poll</span> <span class="o">=</span> <span class="n">CXPOLL_POLLING</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str_cmd</span><span class="p">,</span> <span class="s">&quot;poll&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">poll</span> <span class="o">=</span> <span class="n">CXPOLL_POLLING</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">poll</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">poll</span> <span class="o">==</span> <span class="n">CXPOLL_POLLING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state_serialize</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CXPOLL_STOPPED</span>:
			<span class="cm">/* start polling */</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span> <span class="o">=</span> <span class="n">CXPOLL_POLLING</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CXPOLL_STOPPING</span>:
			<span class="cm">/* abort stop request */</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span> <span class="o">=</span> <span class="n">CXPOLL_POLLING</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CXPOLL_POLLING</span>:
		<span class="k">case</span> <span class="n">CXPOLL_SHUTDOWN</span>:
			<span class="cm">/* don&#39;t start polling */</span>
			<span class="n">poll</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state_serialize</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">poll</span> <span class="o">==</span> <span class="n">CXPOLL_STOPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state_serialize</span><span class="p">);</span>
		<span class="cm">/* request stop */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span> <span class="o">==</span> <span class="n">CXPOLL_POLLING</span><span class="p">)</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span> <span class="o">=</span> <span class="n">CXPOLL_STOPPING</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state_serialize</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">adsl_state_serialize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">poll</span> <span class="o">==</span> <span class="n">CXPOLL_POLLING</span><span class="p">)</span>
		<span class="n">cxacru_poll_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* CM_REQUEST_CARD_DATA_GET times out, so no show attribute */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cxacru_sysfs_store_adsl_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxacru_data</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span> <span class="n">to_usbatm_driver_data</span><span class="p">(</span>
			<span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">data</span><span class="p">[</span><span class="n">CMD_PACKET_SIZE</span> <span class="o">/</span> <span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="s">&quot;%x=%x%n&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="cm">/* skip trailing newline */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">==</span> <span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">pos</span><span class="o">++</span><span class="p">;</span>

		<span class="n">data</span><span class="p">[</span><span class="n">num</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="n">num</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
		<span class="n">num</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* send config values when data buffer is full</span>
<span class="cm">		 * or no more data</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">len</span> <span class="o">||</span> <span class="n">num</span> <span class="o">&gt;=</span> <span class="n">CMD_MAX_CONFIG</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">log</span><span class="p">[</span><span class="n">CMD_MAX_CONFIG</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="cm">/* %02x=%08x */</span>

			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_cm</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">CM_REQUEST_CARD_DATA_SET</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">num</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atm_err</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span>
					<span class="s">&quot;set card data returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">log</span> <span class="o">+</span> <span class="n">tmp</span><span class="o">*</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="s">&quot; %02x=%08x&quot;</span><span class="p">,</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">tmp</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">tmp</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]));</span>
			<span class="n">atm_info</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;config%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">log</span><span class="p">);</span>
			<span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * All device attributes are included in CXACRU_ALL_FILES</span>
<span class="cm"> * so that the same list can be used multiple times:</span>
<span class="cm"> *     INIT   (define the device attributes)</span>
<span class="cm"> *     CREATE (create all the device files)</span>
<span class="cm"> *     REMOVE (remove all the device files)</span>
<span class="cm"> *</span>
<span class="cm"> * With the last two being defined as needed in the functions</span>
<span class="cm"> * they are used in before calling CXACRU_ALL_FILES()</span>
<span class="cm"> */</span>
<span class="cp">#define CXACRU_ALL_FILES(_action) \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_DOWNSTREAM_RATE,           u32,  downstream_rate); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_UPSTREAM_RATE,             u32,  upstream_rate); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_LINK_STATUS,               LINK, link_status); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_LINE_STATUS,               LINE, line_status); \</span>
<span class="cp">CXACRU__ATTR_##_action(                                      mac_address); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_UPSTREAM_SNR_MARGIN,       dB,   upstream_snr_margin); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_DOWNSTREAM_SNR_MARGIN,     dB,   downstream_snr_margin); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_UPSTREAM_ATTENUATION,      dB,   upstream_attenuation); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_DOWNSTREAM_ATTENUATION,    dB,   downstream_attenuation); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_TRANSMITTER_POWER,         s8,   transmitter_power); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_UPSTREAM_BITS_PER_FRAME,   u32,  upstream_bits_per_frame); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_DOWNSTREAM_BITS_PER_FRAME, u32,  downstream_bits_per_frame); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_STARTUP_ATTEMPTS,          u32,  startup_attempts); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_UPSTREAM_CRC_ERRORS,       u32,  upstream_crc_errors); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_DOWNSTREAM_CRC_ERRORS,     u32,  downstream_crc_errors); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_UPSTREAM_FEC_ERRORS,       u32,  upstream_fec_errors); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_DOWNSTREAM_FEC_ERRORS,     u32,  downstream_fec_errors); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_UPSTREAM_HEC_ERRORS,       u32,  upstream_hec_errors); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_DOWNSTREAM_HEC_ERRORS,     u32,  downstream_hec_errors); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_LINE_STARTABLE,            bool, line_startable); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_MODULATION,                MODU, modulation); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_ADSL_HEADEND,              u32,  adsl_headend); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_ADSL_HEADEND_ENVIRONMENT,  u32,  adsl_headend_environment); \</span>
<span class="cp">CXACRU_ATTR_##_action(CXINF_CONTROLLER_VERSION,        u32,  adsl_controller_version); \</span>
<span class="cp">CXACRU_CMD_##_action(                                        adsl_state); \</span>
<span class="cp">CXACRU_SET_##_action(                                        adsl_config);</span>

<span class="n">CXACRU_ALL_FILES</span><span class="p">(</span><span class="n">INIT</span><span class="p">);</span>

<span class="cm">/* the following three functions are stolen from drivers/usb/core/message.c */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cxacru_blocking_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">complete</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cxacru_timeout_kill</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_unlink_urb</span><span class="p">((</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxacru_start_wait_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">done</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="o">*</span><span class="n">actual_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">CMD_TIMEOUT</span><span class="p">);</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">urb</span><span class="p">;</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">cxacru_timeout_kill</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">actual_length</span><span class="p">)</span>
		<span class="o">*</span><span class="n">actual_length</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span> <span class="cm">/* must read status after completion */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxacru_cm</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxacru_data</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="k">enum</span> <span class="n">cxacru_cm_request</span> <span class="n">cm</span><span class="p">,</span>
		     <span class="n">u8</span> <span class="o">*</span><span class="n">wdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wsize</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">actlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offb</span><span class="p">,</span> <span class="n">offd</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">stride</span> <span class="o">=</span> <span class="n">CMD_PACKET_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">wbuf</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rbuf</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wbuflen</span> <span class="o">=</span> <span class="p">((</span><span class="n">wsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">CMD_PACKET_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rbuflen</span> <span class="o">=</span> <span class="p">((</span><span class="n">rsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">CMD_PACKET_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wbuflen</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span> <span class="o">||</span> <span class="n">rbuflen</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">usb_err</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;requested transfer size too large (%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">wbuflen</span><span class="p">,</span> <span class="n">rbuflen</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">cm_serialize</span><span class="p">);</span>

	<span class="cm">/* submit reading urb before the writing one */</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_done</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">usb_err</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;submit of read urb for cm %#x failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cm</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">wbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wbuflen</span><span class="p">);</span>
	<span class="cm">/* handle wsize == 0 */</span>
	<span class="n">wbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offb</span> <span class="o">=</span> <span class="n">offd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offd</span> <span class="o">&lt;</span> <span class="n">wsize</span><span class="p">;</span> <span class="n">offd</span> <span class="o">+=</span> <span class="n">stride</span><span class="p">,</span> <span class="n">offb</span> <span class="o">+=</span> <span class="n">CMD_PACKET_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wbuf</span><span class="p">[</span><span class="n">offb</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wbuf</span> <span class="o">+</span> <span class="n">offb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wdata</span> <span class="o">+</span> <span class="n">offd</span><span class="p">,</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">wsize</span> <span class="o">-</span> <span class="n">offd</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="n">wbuflen</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_done</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">usb_err</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;submit of write urb for cm %#x failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cm</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_start_wait_urb</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_done</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">usb_err</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;send of cm %#x failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_start_wait_urb</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_done</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">actlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">usb_err</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;receive of cm %#x failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">actlen</span> <span class="o">%</span> <span class="n">CMD_PACKET_SIZE</span> <span class="o">||</span> <span class="o">!</span><span class="n">actlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">usb_err</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;invalid response length to cm %#x: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cm</span><span class="p">,</span> <span class="n">actlen</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check the return status and copy the data to the output buffer, if needed */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offb</span> <span class="o">=</span> <span class="n">offd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offd</span> <span class="o">&lt;</span> <span class="n">rsize</span> <span class="o">&amp;&amp;</span> <span class="n">offb</span> <span class="o">&lt;</span> <span class="n">actlen</span><span class="p">;</span> <span class="n">offb</span> <span class="o">+=</span> <span class="n">CMD_PACKET_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rbuf</span><span class="p">[</span><span class="n">offb</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cm</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
				<span class="n">usb_err</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;wrong cm %#x in response to cm %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rbuf</span><span class="p">[</span><span class="n">offb</span><span class="p">],</span> <span class="n">cm</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rbuf</span><span class="p">[</span><span class="n">offb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">CM_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
				<span class="n">usb_err</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;response to cm %#x failed: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cm</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">[</span><span class="n">offb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offd</span> <span class="o">&gt;=</span> <span class="n">rsize</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rdata</span> <span class="o">+</span> <span class="n">offd</span><span class="p">,</span> <span class="n">rbuf</span> <span class="o">+</span> <span class="n">offb</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">rsize</span> <span class="o">-</span> <span class="n">offd</span><span class="p">));</span>
		<span class="n">offd</span> <span class="o">+=</span> <span class="n">stride</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">offd</span><span class="p">;</span>
	<span class="n">usb_dbg</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;cm %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">cm_serialize</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxacru_cm_get_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxacru_data</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="k">enum</span> <span class="n">cxacru_cm_request</span> <span class="n">cm</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offb</span><span class="p">,</span> <span class="n">offd</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">stride</span> <span class="o">=</span> <span class="n">CMD_PACKET_SIZE</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buflen</span> <span class="o">=</span>  <span class="p">((</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">stride</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buflen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_cm</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="cm">/* len &gt; 0 &amp;&amp; len % 4 == 0 guaranteed by cxacru_cm() */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offb</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">offb</span><span class="o">++</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">stride</span> <span class="o">||</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="n">offb</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
				<span class="n">usb_err</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;invalid data length from cm %#x: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cm</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">l</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">offd</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">offb</span><span class="o">++</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offd</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
					<span class="n">usb_err</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;wrong index %#x in response to cm %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">offd</span><span class="p">,</span> <span class="n">cm</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">data</span><span class="p">[</span><span class="n">offd</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">offb</span><span class="o">++</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxacru_card_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxacru_data</span> <span class="o">*</span><span class="n">instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_cm</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">CM_REQUEST_CARD_GET_STATUS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* firmware not loaded */</span>
		<span class="n">usb_dbg</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;cxacru_adsl_start: CARD_GET_STATUS returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cxacru_remove_device_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm_instance</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">atm_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">usbatm_instance</span><span class="o">-&gt;</span><span class="n">usb_intf</span><span class="p">;</span>

	<span class="cp">#define CXACRU_DEVICE_REMOVE_FILE(_name) \</span>
<span class="cp">		device_remove_file(&amp;intf-&gt;dev, &amp;dev_attr_##_name);</span>
	<span class="n">CXACRU_ALL_FILES</span><span class="p">(</span><span class="n">REMOVE</span><span class="p">);</span>
	<span class="cp">#undef CXACRU_DEVICE_REMOVE_FILE</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxacru_atm_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm_instance</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">atm_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxacru_data</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span> <span class="n">usbatm_instance</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">usbatm_instance</span><span class="o">-&gt;</span><span class="n">usb_intf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start_polling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Read MAC address */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_cm</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">CM_REQUEST_CARD_GET_MAC_ADDRESS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atm_err</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="s">&quot;cxacru_atm_start: CARD_GET_MAC_ADDRESS returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cp">#define CXACRU_DEVICE_CREATE_FILE(_name) \</span>
<span class="cp">		ret = device_create_file(&amp;intf-&gt;dev, &amp;dev_attr_##_name); \</span>
<span class="cp">		if (unlikely(ret)) \</span>
<span class="cp">			goto fail_sysfs;</span>
	<span class="n">CXACRU_ALL_FILES</span><span class="p">(</span><span class="n">CREATE</span><span class="p">);</span>
	<span class="cp">#undef CXACRU_DEVICE_CREATE_FILE</span>

	<span class="cm">/* start ADSL */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">adsl_state_serialize</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_cm</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">CM_REQUEST_CHIP_ADSL_LINE_START</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">atm_err</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="s">&quot;cxacru_atm_start: CHIP_ADSL_LINE_START returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* Start status polling */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state_serialize</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CXPOLL_STOPPED</span>:
		<span class="cm">/* start polling */</span>
		<span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span> <span class="o">=</span> <span class="n">CXPOLL_POLLING</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CXPOLL_STOPPING</span>:
		<span class="cm">/* abort stop request */</span>
		<span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span> <span class="o">=</span> <span class="n">CXPOLL_POLLING</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CXPOLL_POLLING</span>:
	<span class="k">case</span> <span class="n">CXPOLL_SHUTDOWN</span>:
		<span class="cm">/* don&#39;t start polling */</span>
		<span class="n">start_polling</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state_serialize</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">adsl_state_serialize</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%d: %s %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			<span class="n">usbatm_instance</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_polling</span><span class="p">)</span>
		<span class="n">cxacru_poll_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_sysfs:</span>
	<span class="n">usb_err</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="s">&quot;cxacru_atm_start: device_create_file failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">cxacru_remove_device_files</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="n">atm_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cxacru_poll_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxacru_data</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cxacru_data</span><span class="p">,</span> <span class="n">poll_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">buf</span><span class="p">[</span><span class="n">CXINF_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">atm_dev</span> <span class="o">=</span> <span class="n">usbatm</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">keep_polling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_cm_get_array</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">CM_REQUEST_CARD_INFO_GET</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">CXINF_MAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
			<span class="n">atm_warn</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;poll status: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state_serialize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span> <span class="o">!=</span> <span class="n">CXPOLL_SHUTDOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span> <span class="o">=</span> <span class="n">CXPOLL_STOPPED</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
				<span class="n">atm_warn</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;polling disabled, set adsl_state&quot;</span>
						<span class="s">&quot; to &#39;start&#39; or &#39;poll&#39; to resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state_serialize</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">reschedule</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">card_info</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">card_info</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">adsl_status</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">[</span><span class="n">CXINF_LINE_STARTABLE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">instance</span><span class="o">-&gt;</span><span class="n">adsl_status</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">CXINF_LINE_STARTABLE</span><span class="p">];</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">adsl_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">atm_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;ADSL state: running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">atm_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;ADSL state: stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">atm_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;Unknown adsl status %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">adsl_status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">line_status</span> <span class="o">==</span> <span class="n">buf</span><span class="p">[</span><span class="n">CXINF_LINE_STATUS</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">reschedule</span><span class="p">;</span>

	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">line_status</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">CXINF_LINE_STATUS</span><span class="p">];</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">line_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">atm_dev_signal_change</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">,</span> <span class="n">ATM_PHY_SIG_LOST</span><span class="p">);</span>
		<span class="n">atm_info</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;ADSL line: down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">atm_dev_signal_change</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">,</span> <span class="n">ATM_PHY_SIG_LOST</span><span class="p">);</span>
		<span class="n">atm_info</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;ADSL line: attempting to activate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">atm_dev_signal_change</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">,</span> <span class="n">ATM_PHY_SIG_LOST</span><span class="p">);</span>
		<span class="n">atm_info</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;ADSL line: training</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">atm_dev_signal_change</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">,</span> <span class="n">ATM_PHY_SIG_LOST</span><span class="p">);</span>
		<span class="n">atm_info</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;ADSL line: channel analysis</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">atm_dev_signal_change</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">,</span> <span class="n">ATM_PHY_SIG_LOST</span><span class="p">);</span>
		<span class="n">atm_info</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;ADSL line: exchange</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">CXINF_DOWNSTREAM_RATE</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">424</span><span class="p">;</span>
		<span class="n">atm_dev_signal_change</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">,</span> <span class="n">ATM_PHY_SIG_FOUND</span><span class="p">);</span>

		<span class="n">atm_info</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;ADSL line: up (%d kb/s down | %d kb/s up)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">buf</span><span class="p">[</span><span class="n">CXINF_DOWNSTREAM_RATE</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="n">CXINF_UPSTREAM_RATE</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">atm_dev_signal_change</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">,</span> <span class="n">ATM_PHY_SIG_LOST</span><span class="p">);</span>
		<span class="n">atm_info</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;ADSL line: waiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">atm_dev_signal_change</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">,</span> <span class="n">ATM_PHY_SIG_LOST</span><span class="p">);</span>
		<span class="n">atm_info</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;ADSL line: initializing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">atm_dev_signal_change</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">,</span> <span class="n">ATM_PHY_SIG_UNKNOWN</span><span class="p">);</span>
		<span class="n">atm_info</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;Unknown line state %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">line_status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">reschedule:</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state_serialize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span> <span class="o">==</span> <span class="n">CXPOLL_STOPPING</span> <span class="o">&amp;&amp;</span>
				<span class="n">instance</span><span class="o">-&gt;</span><span class="n">adsl_status</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="cm">/* stopped */</span>
				<span class="n">instance</span><span class="o">-&gt;</span><span class="n">line_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* down */</span>
		<span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span> <span class="o">=</span> <span class="n">CXPOLL_STOPPED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span> <span class="o">==</span> <span class="n">CXPOLL_STOPPED</span><span class="p">)</span>
		<span class="n">keep_polling</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state_serialize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">keep_polling</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_work</span><span class="p">,</span>
				<span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">POLL_INTERVAL</span><span class="o">*</span><span class="n">HZ</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxacru_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">cxacru_fw_request</span> <span class="n">fw</span><span class="p">,</span>
		     <span class="n">u8</span> <span class="n">code1</span><span class="p">,</span> <span class="n">u8</span> <span class="n">code2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offd</span><span class="p">,</span> <span class="n">offb</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">stride</span> <span class="o">=</span> <span class="n">CMD_PACKET_SIZE</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">offb</span> <span class="o">=</span> <span class="n">offd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">offd</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">offb</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">offb</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">offb</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">code1</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">offb</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">code2</span><span class="p">;</span>
		<span class="n">put_unaligned</span><span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offb</span><span class="p">));</span>
		<span class="n">offb</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offb</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">offd</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="n">stride</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offb</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stride</span> <span class="o">-</span> <span class="n">l</span><span class="p">);</span>
		<span class="n">offb</span> <span class="o">+=</span> <span class="n">stride</span><span class="p">;</span>
		<span class="n">offd</span> <span class="o">+=</span> <span class="n">stride</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">offb</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">offd</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">CXACRU_EP_CMD</span><span class="p">),</span>
					   <span class="n">buf</span><span class="p">,</span> <span class="n">offb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CMD_TIMEOUT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sending fw %#x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">offd</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sent fw %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cxacru_upload_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxacru_data</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">usbatm</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">signature</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">,</span>
			       <span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span> <span class="p">};</span>
	<span class="n">__le32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">usb_dbg</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* FirmwarePllFClkValue */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">modem_type</span><span class="o">-&gt;</span><span class="n">pll_f_clk</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_fw</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">FW_WRITE_MEM</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">PLLFCLK_ADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_err</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;FirmwarePllFClkValue failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FirmwarePllBClkValue */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">modem_type</span><span class="o">-&gt;</span><span class="n">pll_b_clk</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_fw</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">FW_WRITE_MEM</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">PLLBCLK_ADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_err</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;FirmwarePllBClkValue failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable SDRAM */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SDRAM_ENA</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_fw</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">FW_WRITE_MEM</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">SDRAMEN_ADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_err</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;Enable SDRAM failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Firmware */</span>
	<span class="n">usb_info</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;loading firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_fw</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">FW_WRITE_MEM</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">FW_ADDR</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_err</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;Firmware upload failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Boot ROM patch */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">modem_type</span><span class="o">-&gt;</span><span class="n">boot_rom_patch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_info</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;loading boot ROM patch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_fw</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">FW_WRITE_MEM</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">BR_ADDR</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb_err</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;Boot ROM patching failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Signature */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_fw</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">FW_WRITE_MEM</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">SIG_ADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">signature</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_err</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;Signature storing failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_info</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;starting device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">modem_type</span><span class="o">-&gt;</span><span class="n">boot_rom_patch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BR_ADDR</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_fw</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">FW_WRITE_MEM</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">BR_STACK_ADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_fw</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">FW_GOTO_MEM</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">FW_ADDR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_err</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;Passing control to firmware failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Delay to allow firmware to start up. */</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">CXACRU_EP_CMD</span><span class="p">));</span>
	<span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">CXACRU_EP_CMD</span><span class="p">));</span>
	<span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">CXACRU_EP_DATA</span><span class="p">));</span>
	<span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">CXACRU_EP_DATA</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_cm</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">CM_REQUEST_CARD_GET_STATUS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_err</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;modem failed to initialize: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxacru_find_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">cxacru_data</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">phase</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">**</span><span class="n">fw_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm</span> <span class="o">=</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usbatm</span><span class="o">-&gt;</span><span class="n">usb_intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;cxacru-%s.bin&quot;</span><span class="p">,</span> <span class="n">phase</span><span class="p">);</span>
	<span class="n">usb_dbg</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;cxacru_find_firmware: looking for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_firmware</span><span class="p">(</span><span class="n">fw_p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usb_dbg</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;no stage %s firmware found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phase</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_info</span><span class="p">(</span><span class="n">usbatm</span><span class="p">,</span> <span class="s">&quot;found firmware %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxacru_heavy_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm_instance</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">usb_intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">,</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cxacru_data</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span> <span class="n">usbatm_instance</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_find_firmware</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&quot;fw&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_warn</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="s">&quot;firmware (cxacru-fw.bin) unavailable (system misconfigured?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">modem_type</span><span class="o">-&gt;</span><span class="n">boot_rom_patch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_find_firmware</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&quot;bp&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb_warn</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="s">&quot;boot ROM patch (cxacru-bp.bin) unavailable (system misconfigured?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cxacru_upload_firmware</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">fw</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">modem_type</span><span class="o">-&gt;</span><span class="n">boot_rom_patch</span><span class="p">)</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cxacru_card_status</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">usb_dbg</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="s">&quot;modem initialisation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">usb_dbg</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="s">&quot;done setting up the modem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxacru_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm_instance</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxacru_data</span> <span class="o">*</span><span class="n">instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">cmd_ep</span> <span class="o">=</span> <span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">ep_in</span><span class="p">[</span><span class="n">CXACRU_EP_CMD</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* instance init */</span>
	<span class="n">instance</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">instance</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">instance</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_dbg</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="s">&quot;cxacru_bind: no memory for instance data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">usbatm</span> <span class="o">=</span> <span class="n">usbatm_instance</span><span class="p">;</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">modem_type</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cxacru_modem_type</span> <span class="o">*</span><span class="p">)</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state_serialize</span><span class="p">);</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span> <span class="o">=</span> <span class="n">CXPOLL_STOPPED</span><span class="p">;</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">line_status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">adsl_status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">adsl_state_serialize</span><span class="p">);</span>

	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_dbg</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="s">&quot;cxacru_bind: no memory for rcv_buf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_dbg</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="s">&quot;cxacru_bind: no memory for snd_buf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_dbg</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="s">&quot;cxacru_bind: no memory for rcv_urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_dbg</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="s">&quot;cxacru_bind: no memory for snd_urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_dbg</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="s">&quot;cxacru_bind: no command endpoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd_ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_XFERTYPE_MASK</span><span class="p">)</span>
			<span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_urb</span><span class="p">,</span>
			<span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">CXACRU_EP_CMD</span><span class="p">),</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
			<span class="n">cxacru_blocking_completion</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_done</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_urb</span><span class="p">,</span>
			<span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndintpipe</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">CXACRU_EP_CMD</span><span class="p">),</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
			<span class="n">cxacru_blocking_completion</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_done</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_urb</span><span class="p">,</span>
			<span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">CXACRU_EP_CMD</span><span class="p">),</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
			<span class="n">cxacru_blocking_completion</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_done</span><span class="p">);</span>

		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_urb</span><span class="p">,</span>
			<span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">CXACRU_EP_CMD</span><span class="p">),</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
			<span class="n">cxacru_blocking_completion</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_done</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">cm_serialize</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_work</span><span class="p">,</span> <span class="n">cxacru_poll_status</span><span class="p">);</span>

	<span class="n">usbatm_instance</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">instance</span><span class="p">;</span>

	<span class="n">usbatm_instance</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">cxacru_card_status</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">UDSL_SKIP_HEAVY_INIT</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">);</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_urb</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_urb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cxacru_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbatm_data</span> <span class="o">*</span><span class="n">usbatm_instance</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cxacru_data</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span> <span class="n">usbatm_instance</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_polling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">usb_dbg</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="s">&quot;cxacru_unbind entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">instance</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_dbg</span><span class="p">(</span><span class="n">usbatm_instance</span><span class="p">,</span> <span class="s">&quot;cxacru_unbind: NULL instance!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state_serialize</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span> <span class="o">==</span> <span class="n">CXPOLL_SHUTDOWN</span><span class="p">);</span>

	<span class="cm">/* ensure that status polling continues unless</span>
<span class="cm">	 * it has already stopped */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span> <span class="o">==</span> <span class="n">CXPOLL_STOPPED</span><span class="p">)</span>
		<span class="n">is_polling</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* stop polling from being stopped or started */</span>
	<span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state</span> <span class="o">=</span> <span class="n">CXPOLL_SHUTDOWN</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_state_serialize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_polling</span><span class="p">)</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">poll_work</span><span class="p">);</span>

	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_urb</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_urb</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_urb</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_urb</span><span class="p">);</span>

	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">);</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">instance</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>

	<span class="n">usbatm_instance</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cxacru_modem_type</span> <span class="n">cxacru_cafe</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pll_f_clk</span> <span class="o">=</span> <span class="mh">0x02d874df</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pll_b_clk</span> <span class="o">=</span> <span class="mh">0x0196a51a</span><span class="p">,</span>
	<span class="p">.</span><span class="n">boot_rom_patch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cxacru_modem_type</span> <span class="n">cxacru_cb00</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pll_f_clk</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pll_b_clk</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">boot_rom_patch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">cxacru_usb_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="cm">/* V = Conexant			P = ADSL modem (Euphrates project)	*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0572</span><span class="p">,</span> <span class="mh">0xcafe</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cafe</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Conexant			P = ADSL modem (Hasbani project)	*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0572</span><span class="p">,</span> <span class="mh">0xcb00</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cb00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Conexant			P = ADSL modem				*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0572</span><span class="p">,</span> <span class="mh">0xcb01</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cb00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Conexant			P = ADSL modem (Well PTI-800) */</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0572</span><span class="p">,</span> <span class="mh">0xcb02</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cb00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Conexant			P = ADSL modem				*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0572</span><span class="p">,</span> <span class="mh">0xcb06</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cb00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Conexant			P = ADSL modem (ZTE ZXDSL 852)		*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0572</span><span class="p">,</span> <span class="mh">0xcb07</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cb00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Olitec				P = ADSL modem version 2		*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x08e3</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cafe</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Olitec				P = ADSL modem version 3		*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x08e3</span><span class="p">,</span> <span class="mh">0x0102</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cb00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Trust/Amigo Technology Co.	P = AMX-CA86U				*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0eb0</span><span class="p">,</span> <span class="mh">0x3457</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cafe</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Zoom				P = 5510				*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1803</span><span class="p">,</span> <span class="mh">0x5510</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cb00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Draytek			P = Vigor 318				*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0675</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cb00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Zyxel				P = 630-C1 aka OMNI ADSL USB (Annex A)	*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0586</span><span class="p">,</span> <span class="mh">0x330a</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cb00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Zyxel				P = 630-C3 aka OMNI ADSL USB (Annex B)	*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0586</span><span class="p">,</span> <span class="mh">0x330b</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cb00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Aethra				P = Starmodem UM1020			*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0659</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cb00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Aztech Systems			P = ? AKA Pirelli AUA-010		*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0509</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cb00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Netopia			P = Cayman 3341(Annex A)/3351(Annex B)	*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x100d</span><span class="p">,</span> <span class="mh">0xcb01</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cb00</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* V = Netopia			P = Cayman 3342(Annex A)/3352(Annex B)	*/</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x100d</span><span class="p">,</span> <span class="mh">0x3342</span><span class="p">),</span>	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cxacru_cb00</span>
	<span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">cxacru_usb_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usbatm_driver</span> <span class="n">cxacru_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="n">cxacru_driver_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span>		<span class="o">=</span> <span class="n">cxacru_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">heavy_init</span>	<span class="o">=</span> <span class="n">cxacru_heavy_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind</span>		<span class="o">=</span> <span class="n">cxacru_unbind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">atm_start</span>	<span class="o">=</span> <span class="n">cxacru_atm_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">atm_stop</span>	<span class="o">=</span> <span class="n">cxacru_remove_device_files</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bulk_in</span>	<span class="o">=</span> <span class="n">CXACRU_EP_DATA</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bulk_out</span>	<span class="o">=</span> <span class="n">CXACRU_EP_DATA</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_padding</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_padding</span>	<span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cxacru_usb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>

	<span class="cm">/* Avoid ADSL routers (cx82310_eth).</span>
<span class="cm">	 * Abort if bDeviceClass is 0xff and iProduct is &quot;USB NET CARD&quot;.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bDeviceClass</span> <span class="o">==</span> <span class="n">USB_CLASS_VENDOR_SPEC</span>
			<span class="o">&amp;&amp;</span> <span class="n">usb_string</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">iProduct</span><span class="p">,</span>
				<span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;USB NET CARD&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ignoring cx82310_eth device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">usbatm_usb_probe</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cxacru_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">cxacru_usb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">cxacru_driver_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">cxacru_usb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">usbatm_usb_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">cxacru_usb_ids</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">cxacru_usb_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRIVER_VERSION</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
