<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › host › ohci-pxa27x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ohci-pxa27x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * OHCI HCD (Host Controller Driver) for USB.</span>
<span class="cm"> *</span>
<span class="cm"> * (C) Copyright 1999 Roman Weissgaerber &lt;weissg@vienna.at&gt;</span>
<span class="cm"> * (C) Copyright 2000-2002 David Brownell &lt;dbrownell@users.sourceforge.net&gt;</span>
<span class="cm"> * (C) Copyright 2002 Hewlett-Packard Company</span>
<span class="cm"> *</span>
<span class="cm"> * Bus Glue for pxa27x</span>
<span class="cm"> *</span>
<span class="cm"> * Written by Christopher Hoover &lt;ch@hpl.hp.com&gt;</span>
<span class="cm"> * Based on fragments of previous driver by Russell King et al.</span>
<span class="cm"> *</span>
<span class="cm"> * Modified for LH7A404 from ohci-sa1111.c</span>
<span class="cm"> *  by Durgesh Pattamatta &lt;pattamattad@sharpsec.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Modified for pxa27x from ohci-lh7a404.c</span>
<span class="cm"> *  by Nick Bane &lt;nick@cecomputing.co.uk&gt; 26-8-2004</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licenced under the GPL.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;mach/ohci.h&gt;</span>
<span class="cp">#include &lt;mach/pxa3xx-u2d.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * UHC: USB Host Controller (OHCI-like) register definitions</span>
<span class="cm"> */</span>
<span class="cp">#define UHCREV		(0x0000) </span><span class="cm">/* UHC HCI Spec Revision */</span><span class="cp"></span>
<span class="cp">#define UHCHCON		(0x0004) </span><span class="cm">/* UHC Host Control Register */</span><span class="cp"></span>
<span class="cp">#define UHCCOMS		(0x0008) </span><span class="cm">/* UHC Command Status Register */</span><span class="cp"></span>
<span class="cp">#define UHCINTS		(0x000C) </span><span class="cm">/* UHC Interrupt Status Register */</span><span class="cp"></span>
<span class="cp">#define UHCINTE		(0x0010) </span><span class="cm">/* UHC Interrupt Enable */</span><span class="cp"></span>
<span class="cp">#define UHCINTD		(0x0014) </span><span class="cm">/* UHC Interrupt Disable */</span><span class="cp"></span>
<span class="cp">#define UHCHCCA		(0x0018) </span><span class="cm">/* UHC Host Controller Comm. Area */</span><span class="cp"></span>
<span class="cp">#define UHCPCED		(0x001C) </span><span class="cm">/* UHC Period Current Endpt Descr */</span><span class="cp"></span>
<span class="cp">#define UHCCHED		(0x0020) </span><span class="cm">/* UHC Control Head Endpt Descr */</span><span class="cp"></span>
<span class="cp">#define UHCCCED		(0x0024) </span><span class="cm">/* UHC Control Current Endpt Descr */</span><span class="cp"></span>
<span class="cp">#define UHCBHED		(0x0028) </span><span class="cm">/* UHC Bulk Head Endpt Descr */</span><span class="cp"></span>
<span class="cp">#define UHCBCED		(0x002C) </span><span class="cm">/* UHC Bulk Current Endpt Descr */</span><span class="cp"></span>
<span class="cp">#define UHCDHEAD	(0x0030) </span><span class="cm">/* UHC Done Head */</span><span class="cp"></span>
<span class="cp">#define UHCFMI		(0x0034) </span><span class="cm">/* UHC Frame Interval */</span><span class="cp"></span>
<span class="cp">#define UHCFMR		(0x0038) </span><span class="cm">/* UHC Frame Remaining */</span><span class="cp"></span>
<span class="cp">#define UHCFMN		(0x003C) </span><span class="cm">/* UHC Frame Number */</span><span class="cp"></span>
<span class="cp">#define UHCPERS		(0x0040) </span><span class="cm">/* UHC Periodic Start */</span><span class="cp"></span>
<span class="cp">#define UHCLS		(0x0044) </span><span class="cm">/* UHC Low Speed Threshold */</span><span class="cp"></span>

<span class="cp">#define UHCRHDA		(0x0048) </span><span class="cm">/* UHC Root Hub Descriptor A */</span><span class="cp"></span>
<span class="cp">#define UHCRHDA_NOCP	(1 &lt;&lt; 12)	</span><span class="cm">/* No over current protection */</span><span class="cp"></span>
<span class="cp">#define UHCRHDA_OCPM	(1 &lt;&lt; 11)	</span><span class="cm">/* Over Current Protection Mode */</span><span class="cp"></span>
<span class="cp">#define UHCRHDA_POTPGT(x) \</span>
<span class="cp">			(((x) &amp; 0xff) &lt;&lt; 24) </span><span class="cm">/* Power On To Power Good Time */</span><span class="cp"></span>

<span class="cp">#define UHCRHDB		(0x004C) </span><span class="cm">/* UHC Root Hub Descriptor B */</span><span class="cp"></span>
<span class="cp">#define UHCRHS		(0x0050) </span><span class="cm">/* UHC Root Hub Status */</span><span class="cp"></span>
<span class="cp">#define UHCRHPS1	(0x0054) </span><span class="cm">/* UHC Root Hub Port 1 Status */</span><span class="cp"></span>
<span class="cp">#define UHCRHPS2	(0x0058) </span><span class="cm">/* UHC Root Hub Port 2 Status */</span><span class="cp"></span>
<span class="cp">#define UHCRHPS3	(0x005C) </span><span class="cm">/* UHC Root Hub Port 3 Status */</span><span class="cp"></span>

<span class="cp">#define UHCSTAT		(0x0060) </span><span class="cm">/* UHC Status Register */</span><span class="cp"></span>
<span class="cp">#define UHCSTAT_UPS3	(1 &lt;&lt; 16)	</span><span class="cm">/* USB Power Sense Port3 */</span><span class="cp"></span>
<span class="cp">#define UHCSTAT_SBMAI	(1 &lt;&lt; 15)	</span><span class="cm">/* System Bus Master Abort Interrupt*/</span><span class="cp"></span>
<span class="cp">#define UHCSTAT_SBTAI	(1 &lt;&lt; 14)	</span><span class="cm">/* System Bus Target Abort Interrupt*/</span><span class="cp"></span>
<span class="cp">#define UHCSTAT_UPRI	(1 &lt;&lt; 13)	</span><span class="cm">/* USB Port Resume Interrupt */</span><span class="cp"></span>
<span class="cp">#define UHCSTAT_UPS2	(1 &lt;&lt; 12)	</span><span class="cm">/* USB Power Sense Port 2 */</span><span class="cp"></span>
<span class="cp">#define UHCSTAT_UPS1	(1 &lt;&lt; 11)	</span><span class="cm">/* USB Power Sense Port 1 */</span><span class="cp"></span>
<span class="cp">#define UHCSTAT_HTA	(1 &lt;&lt; 10)	</span><span class="cm">/* HCI Target Abort */</span><span class="cp"></span>
<span class="cp">#define UHCSTAT_HBA	(1 &lt;&lt; 8)	</span><span class="cm">/* HCI Buffer Active */</span><span class="cp"></span>
<span class="cp">#define UHCSTAT_RWUE	(1 &lt;&lt; 7)	</span><span class="cm">/* HCI Remote Wake Up Event */</span><span class="cp"></span>

<span class="cp">#define UHCHR           (0x0064) </span><span class="cm">/* UHC Reset Register */</span><span class="cp"></span>
<span class="cp">#define UHCHR_SSEP3	(1 &lt;&lt; 11)	</span><span class="cm">/* Sleep Standby Enable for Port3 */</span><span class="cp"></span>
<span class="cp">#define UHCHR_SSEP2	(1 &lt;&lt; 10)	</span><span class="cm">/* Sleep Standby Enable for Port2 */</span><span class="cp"></span>
<span class="cp">#define UHCHR_SSEP1	(1 &lt;&lt; 9)	</span><span class="cm">/* Sleep Standby Enable for Port1 */</span><span class="cp"></span>
<span class="cp">#define UHCHR_PCPL	(1 &lt;&lt; 7)	</span><span class="cm">/* Power control polarity low */</span><span class="cp"></span>
<span class="cp">#define UHCHR_PSPL	(1 &lt;&lt; 6)	</span><span class="cm">/* Power sense polarity low */</span><span class="cp"></span>
<span class="cp">#define UHCHR_SSE	(1 &lt;&lt; 5)	</span><span class="cm">/* Sleep Standby Enable */</span><span class="cp"></span>
<span class="cp">#define UHCHR_UIT	(1 &lt;&lt; 4)	</span><span class="cm">/* USB Interrupt Test */</span><span class="cp"></span>
<span class="cp">#define UHCHR_SSDC	(1 &lt;&lt; 3)	</span><span class="cm">/* Simulation Scale Down Clock */</span><span class="cp"></span>
<span class="cp">#define UHCHR_CGR	(1 &lt;&lt; 2)	</span><span class="cm">/* Clock Generation Reset */</span><span class="cp"></span>
<span class="cp">#define UHCHR_FHR	(1 &lt;&lt; 1)	</span><span class="cm">/* Force Host Controller Reset */</span><span class="cp"></span>
<span class="cp">#define UHCHR_FSBIR	(1 &lt;&lt; 0)	</span><span class="cm">/* Force System Bus Iface Reset */</span><span class="cp"></span>

<span class="cp">#define UHCHIE          (0x0068) </span><span class="cm">/* UHC Interrupt Enable Register*/</span><span class="cp"></span>
<span class="cp">#define UHCHIE_UPS3IE	(1 &lt;&lt; 14)	</span><span class="cm">/* Power Sense Port3 IntEn */</span><span class="cp"></span>
<span class="cp">#define UHCHIE_UPRIE	(1 &lt;&lt; 13)	</span><span class="cm">/* Port Resume IntEn */</span><span class="cp"></span>
<span class="cp">#define UHCHIE_UPS2IE	(1 &lt;&lt; 12)	</span><span class="cm">/* Power Sense Port2 IntEn */</span><span class="cp"></span>
<span class="cp">#define UHCHIE_UPS1IE	(1 &lt;&lt; 11)	</span><span class="cm">/* Power Sense Port1 IntEn */</span><span class="cp"></span>
<span class="cp">#define UHCHIE_TAIE	(1 &lt;&lt; 10)	</span><span class="cm">/* HCI Interface Transfer Abort</span>
<span class="cm">					   Interrupt Enable*/</span><span class="cp"></span>
<span class="cp">#define UHCHIE_HBAIE	(1 &lt;&lt; 8)	</span><span class="cm">/* HCI Buffer Active IntEn */</span><span class="cp"></span>
<span class="cp">#define UHCHIE_RWIE	(1 &lt;&lt; 7)	</span><span class="cm">/* Remote Wake-up IntEn */</span><span class="cp"></span>

<span class="cp">#define UHCHIT          (0x006C) </span><span class="cm">/* UHC Interrupt Test register */</span><span class="cp"></span>

<span class="cp">#define PXA_UHC_MAX_PORTNUM    3</span>

<span class="k">struct</span> <span class="n">pxa27x_ohci</span> <span class="p">{</span>
	<span class="cm">/* must be 1st member here for hcd_to_ohci() to work */</span>
	<span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="n">ohci</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>	<span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">mmio_base</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define to_pxa27x_ohci(hcd)	(struct pxa27x_ohci *)hcd_to_ohci(hcd)</span>

<span class="cm">/*</span>
<span class="cm">  PMM_NPS_MODE -- PMM Non-power switching mode</span>
<span class="cm">      Ports are powered continuously.</span>

<span class="cm">  PMM_GLOBAL_MODE -- PMM global switching mode</span>
<span class="cm">      All ports are powered at the same time.</span>

<span class="cm">  PMM_PERPORT_MODE -- PMM per port switching mode</span>
<span class="cm">      Ports are powered individually.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa27x_ohci_select_pmm</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa27x_ohci</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">uhcrhda</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCRHDA</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">uhcrhdb</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCRHDB</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PMM_NPS_MODE</span>:
		<span class="n">uhcrhda</span> <span class="o">|=</span> <span class="n">RH_A_NPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PMM_GLOBAL_MODE</span>:
		<span class="n">uhcrhda</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RH_A_NPS</span> <span class="o">&amp;</span> <span class="n">RH_A_PSM</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PMM_PERPORT_MODE</span>:
		<span class="n">uhcrhda</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RH_A_NPS</span><span class="p">);</span>
		<span class="n">uhcrhda</span> <span class="o">|=</span> <span class="n">RH_A_PSM</span><span class="p">;</span>

		<span class="cm">/* Set port power control mask bits, only 3 ports. */</span>
		<span class="n">uhcrhdb</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x7</span><span class="o">&lt;&lt;</span><span class="mi">17</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span> <span class="n">KERN_ERR</span>
			<span class="s">&quot;Invalid mode %d, set to non-power switch mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mode</span> <span class="p">);</span>

		<span class="n">uhcrhda</span> <span class="o">|=</span> <span class="n">RH_A_NPS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">uhcrhda</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCRHDA</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">uhcrhdb</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCRHDB</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">usb_disabled</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pxa27x_setup_hc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa27x_ohci</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">pxaohci_platform_data</span> <span class="o">*</span><span class="n">inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">uhchr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCHR</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">uhcrhda</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCRHDA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ENABLE_PORT1</span><span class="p">)</span>
		<span class="n">uhchr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UHCHR_SSEP1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ENABLE_PORT2</span><span class="p">)</span>
		<span class="n">uhchr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UHCHR_SSEP2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ENABLE_PORT3</span><span class="p">)</span>
		<span class="n">uhchr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UHCHR_SSEP3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">POWER_CONTROL_LOW</span><span class="p">)</span>
		<span class="n">uhchr</span> <span class="o">|=</span> <span class="n">UHCHR_PCPL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">POWER_SENSE_LOW</span><span class="p">)</span>
		<span class="n">uhchr</span> <span class="o">|=</span> <span class="n">UHCHR_PSPL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NO_OC_PROTECTION</span><span class="p">)</span>
		<span class="n">uhcrhda</span> <span class="o">|=</span> <span class="n">UHCRHDA_NOCP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">uhcrhda</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UHCRHDA_NOCP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OC_MODE_PERPORT</span><span class="p">)</span>
		<span class="n">uhcrhda</span> <span class="o">|=</span> <span class="n">UHCRHDA_OCPM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">uhcrhda</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UHCRHDA_OCPM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">power_on_delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uhcrhda</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UHCRHDA_POTPGT</span><span class="p">(</span><span class="mh">0xff</span><span class="p">);</span>
		<span class="n">uhcrhda</span> <span class="o">|=</span> <span class="n">UHCRHDA_POTPGT</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">power_on_delay</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">uhchr</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCHR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">uhcrhda</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCRHDA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pxa27x_reset_hc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa27x_ohci</span> <span class="o">*</span><span class="n">ohci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">uhchr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCHR</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">uhchr</span> <span class="o">|</span> <span class="n">UHCHR_FHR</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCHR</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">uhchr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UHCHR_FHR</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCHR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PXA27x</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">pxa27x_clear_otgph</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define pxa27x_clear_otgph()	do {} while (0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa27x_start_hc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa27x_ohci</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxaohci_platform_data</span> <span class="o">*</span><span class="n">inf</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">uhchr</span><span class="p">;</span>

	<span class="n">inf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">pxa27x_reset_hc</span><span class="p">(</span><span class="n">ohci</span><span class="p">);</span>

	<span class="n">uhchr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCHR</span><span class="p">)</span> <span class="o">|</span> <span class="n">UHCHR_FSBIR</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">uhchr</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCHR</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCHR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UHCHR_FSBIR</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">pxa27x_setup_hc</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">inf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_pxa3xx</span><span class="p">())</span>
		<span class="n">pxa3xx_u2d_start_hc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ohci_to_hcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">);</span>

	<span class="n">uhchr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCHR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UHCHR_SSE</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">uhchr</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCHR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">UHCHIE_UPRIE</span> <span class="o">|</span> <span class="n">UHCHIE_RWIE</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCHIE</span><span class="p">);</span>

	<span class="cm">/* Clear any OTG Pin Hold */</span>
	<span class="n">pxa27x_clear_otgph</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxa27x_stop_hc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa27x_ohci</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxaohci_platform_data</span> <span class="o">*</span><span class="n">inf</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">uhccoms</span><span class="p">;</span>

	<span class="n">inf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_pxa3xx</span><span class="p">())</span>
		<span class="n">pxa3xx_u2d_stop_hc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ohci_to_hcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">)</span>
		<span class="n">inf</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pxa27x_reset_hc</span><span class="p">(</span><span class="n">ohci</span><span class="p">);</span>

	<span class="cm">/* Host Controller Reset */</span>
	<span class="n">uhccoms</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCCOMS</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">uhccoms</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">UHCCOMS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">clk_disable_unprepare</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* configure so an HC device and id are always provided */</span>
<span class="cm">/* always called with process context; sleeping is OK */</span>


<span class="cm">/**</span>
<span class="cm"> * usb_hcd_pxa27x_probe - initialize pxa27x-based HCDs</span>
<span class="cm"> * Context: !in_interrupt()</span>
<span class="cm"> *</span>
<span class="cm"> * Allocates basic resources for this USB host controller, and</span>
<span class="cm"> * then invokes the start() method for the HCD associated with it</span>
<span class="cm"> * through the hotplug entry&#39;s driver_data.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usb_hcd_pxa27x_probe</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">hc_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxaohci_platform_data</span> <span class="o">*</span><span class="n">inf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxa27x_ohci</span> <span class="o">*</span><span class="n">ohci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">usb_clk</span><span class="p">;</span>

	<span class="n">inf</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no resource of IORESOURCE_IRQ&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">usb_clk</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">usb_clk</span><span class="p">);</span>

	<span class="n">hcd</span> <span class="o">=</span> <span class="n">usb_create_hcd</span> <span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pxa27x&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hcd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no resource of IORESOURCE_MEM&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_start</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_len</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_start</span><span class="p">,</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_len</span><span class="p">,</span> <span class="n">hcd_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;request_mem_region failed&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_start</span><span class="p">,</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ioremap failed&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize &quot;struct pxa27x_ohci&quot; */</span>
	<span class="n">ohci</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pxa27x_ohci</span> <span class="o">*</span><span class="p">)</span><span class="n">hcd_to_ohci</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">usb_clk</span><span class="p">;</span>
	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">pxa27x_start_hc</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pxa27x_start_hc failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Select Power Management Mode */</span>
	<span class="n">pxa27x_ohci_select_pmm</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">port_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">power_budget</span><span class="p">)</span>
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">power_budget</span> <span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">power_budget</span><span class="p">;</span>

	<span class="n">ohci_hcd_init</span><span class="p">(</span><span class="n">hcd_to_ohci</span><span class="p">(</span><span class="n">hcd</span><span class="p">));</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_add_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">pxa27x_stop_hc</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">err3:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
 <span class="nl">err2:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_start</span><span class="p">,</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_len</span><span class="p">);</span>
 <span class="nl">err1:</span>
	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
 <span class="nl">err0:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">usb_clk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* may be called without controller electrically present */</span>
<span class="cm">/* may be called with controller, bus, and devices active */</span>

<span class="cm">/**</span>
<span class="cm"> * usb_hcd_pxa27x_remove - shutdown processing for pxa27x-based HCDs</span>
<span class="cm"> * @dev: USB Host Controller being removed</span>
<span class="cm"> * Context: !in_interrupt()</span>
<span class="cm"> *</span>
<span class="cm"> * Reverses the effect of usb_hcd_pxa27x_probe(), first invoking</span>
<span class="cm"> * the HCD&#39;s stop() method.  It is always called from a thread</span>
<span class="cm"> * context, normally &quot;rmmod&quot;, &quot;apmd&quot;, or something similar.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">usb_hcd_pxa27x_remove</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa27x_ohci</span> <span class="o">*</span><span class="n">ohci</span> <span class="o">=</span> <span class="n">to_pxa27x_ohci</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="n">usb_remove_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">pxa27x_stop_hc</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_start</span><span class="p">,</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_len</span><span class="p">);</span>
	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">ohci_pxa27x_start</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ohci_hcd</span>	<span class="o">*</span><span class="n">ohci</span> <span class="o">=</span> <span class="n">hcd_to_ohci</span> <span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">ret</span><span class="p">;</span>

	<span class="n">ohci_dbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;ohci_pxa27x_start, ohci:%p&quot;</span><span class="p">,</span> <span class="n">ohci</span><span class="p">);</span>

	<span class="cm">/* The value of NDP in roothub_a is incorrect on this hardware */</span>
	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ohci_init</span><span class="p">(</span><span class="n">ohci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ohci_run</span> <span class="p">(</span><span class="n">ohci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;can&#39;t start %s&quot;</span><span class="p">,</span>
			<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bus_name</span><span class="p">);</span>
		<span class="n">ohci_stop</span> <span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hc_driver</span> <span class="n">ohci_pxa27x_hc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span>		<span class="n">hcd_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">product_desc</span> <span class="o">=</span>		<span class="s">&quot;PXA27x OHCI&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hcd_priv_size</span> <span class="o">=</span>	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa27x_ohci</span><span class="p">),</span>

	<span class="cm">/*</span>
<span class="cm">	 * generic hardware linkage</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span>			<span class="n">ohci_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span>		<span class="n">HCD_USB11</span> <span class="o">|</span> <span class="n">HCD_MEMORY</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * basic lifecycle operations</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span>		<span class="n">ohci_pxa27x_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span>			<span class="n">ohci_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span>		<span class="n">ohci_shutdown</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * managing i/o requests and associated device resources</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">urb_enqueue</span> <span class="o">=</span>		<span class="n">ohci_urb_enqueue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">urb_dequeue</span> <span class="o">=</span>		<span class="n">ohci_urb_dequeue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">endpoint_disable</span> <span class="o">=</span>	<span class="n">ohci_endpoint_disable</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * scheduling support</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">get_frame_number</span> <span class="o">=</span>	<span class="n">ohci_get_frame</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * root hub support</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">hub_status_data</span> <span class="o">=</span>	<span class="n">ohci_hub_status_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hub_control</span> <span class="o">=</span>		<span class="n">ohci_hub_control</span><span class="p">,</span>
<span class="cp">#ifdef  CONFIG_PM</span>
	<span class="p">.</span><span class="n">bus_suspend</span> <span class="o">=</span>		<span class="n">ohci_bus_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_resume</span> <span class="o">=</span>		<span class="n">ohci_bus_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">start_port_reset</span> <span class="o">=</span>	<span class="n">ohci_start_port_reset</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ohci_hcd_pxa27x_drv_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span> <span class="p">(</span><span class="s">&quot;In ohci_hcd_pxa27x_drv_probe&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_disabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">usb_hcd_pxa27x_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ohci_pxa27x_hc_driver</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ohci_hcd_pxa27x_drv_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">usb_hcd_pxa27x_remove</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ohci_hcd_pxa27x_drv_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pxa27x_ohci</span> <span class="o">*</span><span class="n">ohci</span> <span class="o">=</span> <span class="n">to_pxa27x_ohci</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ohci</span><span class="p">.</span><span class="n">next_statechange</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ohci</span><span class="p">.</span><span class="n">next_statechange</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">pxa27x_stop_hc</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ohci_hcd_pxa27x_drv_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pxa27x_ohci</span> <span class="o">*</span><span class="n">ohci</span> <span class="o">=</span> <span class="n">to_pxa27x_ohci</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pxaohci_platform_data</span> <span class="o">*</span><span class="n">inf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ohci</span><span class="p">.</span><span class="n">next_statechange</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ohci</span><span class="p">.</span><span class="n">next_statechange</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">pxa27x_start_hc</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Select Power Management Mode */</span>
	<span class="n">pxa27x_ohci_select_pmm</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">port_mode</span><span class="p">);</span>

	<span class="n">ohci_finish_controller_resume</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">ohci_hcd_pxa27x_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">ohci_hcd_pxa27x_drv_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">ohci_hcd_pxa27x_drv_resume</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/* work with hotplug and coldplug */</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:pxa27x-ohci&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ohci_hcd_pxa27x_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ohci_hcd_pxa27x_drv_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">ohci_hcd_pxa27x_drv_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">usb_hcd_platform_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;pxa27x-ohci&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ohci_hcd_pxa27x_pm_ops</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">},</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
