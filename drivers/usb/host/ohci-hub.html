<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › host › ohci-hub.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ohci-hub.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * OHCI HCD (Host Controller Driver) for USB.</span>
<span class="cm"> *</span>
<span class="cm"> * (C) Copyright 1999 Roman Weissgaerber &lt;weissg@vienna.at&gt;</span>
<span class="cm"> * (C) Copyright 2000-2004 David Brownell &lt;dbrownell@users.sourceforge.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licenced under GPL</span>
<span class="cm"> */</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * OHCI Root Hub ... the nonsharable stuff</span>
<span class="cm"> */</span>

<span class="cp">#define dbg_port(hc,label,num,value) \</span>
<span class="cp">	ohci_dbg (hc, \</span>
<span class="cp">		&quot;%s roothub.portstatus [%d] &quot; \</span>
<span class="cp">		&quot;= 0x%08x%s%s%s%s%s%s%s%s%s%s%s%s\n&quot;, \</span>
<span class="cp">		label, num, temp, \</span>
<span class="cp">		(temp &amp; RH_PS_PRSC) ? &quot; PRSC&quot; : &quot;&quot;, \</span>
<span class="cp">		(temp &amp; RH_PS_OCIC) ? &quot; OCIC&quot; : &quot;&quot;, \</span>
<span class="cp">		(temp &amp; RH_PS_PSSC) ? &quot; PSSC&quot; : &quot;&quot;, \</span>
<span class="cp">		(temp &amp; RH_PS_PESC) ? &quot; PESC&quot; : &quot;&quot;, \</span>
<span class="cp">		(temp &amp; RH_PS_CSC) ? &quot; CSC&quot; : &quot;&quot;, \</span>
<span class="cp">		\</span>
<span class="cp">		(temp &amp; RH_PS_LSDA) ? &quot; LSDA&quot; : &quot;&quot;, \</span>
<span class="cp">		(temp &amp; RH_PS_PPS) ? &quot; PPS&quot; : &quot;&quot;, \</span>
<span class="cp">		(temp &amp; RH_PS_PRS) ? &quot; PRS&quot; : &quot;&quot;, \</span>
<span class="cp">		(temp &amp; RH_PS_POCI) ? &quot; POCI&quot; : &quot;&quot;, \</span>
<span class="cp">		(temp &amp; RH_PS_PSS) ? &quot; PSS&quot; : &quot;&quot;, \</span>
<span class="cp">		\</span>
<span class="cp">		(temp &amp; RH_PS_PES) ? &quot; PES&quot; : &quot;&quot;, \</span>
<span class="cp">		(temp &amp; RH_PS_CCS) ? &quot; CCS&quot; : &quot;&quot; \</span>
<span class="cp">		);</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#define OHCI_SCHED_ENABLES \</span>
<span class="cp">	(OHCI_CTRL_CLE|OHCI_CTRL_BLE|OHCI_CTRL_PLE|OHCI_CTRL_IE)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">dl_done_list</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">finish_unlinks</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">);</span>

<span class="cp">#ifdef	CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ohci_rh_suspend</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autostop</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">=</span> <span class="n">ohci_readl</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;</span> <span class="n">OHCI_CTRL_HCFS</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OHCI_USB_RESUME</span>:
		<span class="n">ohci_dbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;resume/suspend?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OHCI_CTRL_HCFS</span><span class="p">;</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">|=</span> <span class="n">OHCI_USB_RESET</span><span class="p">;</span>
		<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ohci_readl</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
		<span class="cm">/* FALL THROUGH */</span>
	<span class="k">case</span> <span class="n">OHCI_USB_RESET</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">ohci_dbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;needs reinit!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OHCI_USB_SUSPEND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">autostop</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ohci_dbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;already suspended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ohci_dbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;%s root hub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">autostop</span> <span class="o">?</span> <span class="s">&quot;auto-stop&quot;</span> <span class="o">:</span> <span class="s">&quot;suspend&quot;</span><span class="p">);</span>

	<span class="cm">/* First stop any processing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">autostop</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;</span> <span class="n">OHCI_SCHED_ENABLES</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OHCI_SCHED_ENABLES</span><span class="p">;</span>
		<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">=</span> <span class="n">ohci_readl</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
		<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">OHCI_INTR_SF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intrstatus</span><span class="p">);</span>

		<span class="cm">/* sched disables take effect on the next frame,</span>
<span class="cm">		 * then the last WDH could take 6+ msec</span>
<span class="cm">		 */</span>
		<span class="n">ohci_dbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;stopping schedules ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">autostop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">msleep</span> <span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dl_done_list</span> <span class="p">(</span><span class="n">ohci</span><span class="p">);</span>
	<span class="n">finish_unlinks</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ohci_frame_no</span><span class="p">(</span><span class="n">ohci</span><span class="p">));</span>

	<span class="cm">/* maybe resume can wake root hub */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span><span class="n">do_remote_wakeup</span> <span class="o">||</span> <span class="n">autostop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">|=</span> <span class="n">OHCI_CTRL_RWE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ohci_writel</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">OHCI_INTR_RHSC</span> <span class="o">|</span> <span class="n">OHCI_INTR_RD</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intrdisable</span><span class="p">);</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OHCI_CTRL_RWE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Suspend hub ... this is the &quot;global (to this bus) suspend&quot; mode,</span>
<span class="cm">	 * which doesn&#39;t imply ports will first be individually suspended.</span>
<span class="cm">	 */</span>
	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OHCI_CTRL_HCFS</span><span class="p">;</span>
	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">|=</span> <span class="n">OHCI_USB_SUSPEND</span><span class="p">;</span>
	<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ohci_readl</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>

	<span class="cm">/* no resumes until devices finish suspending */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">autostop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">next_statechange</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span> <span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">autostop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">=</span> <span class="n">OHCI_RH_SUSPENDED</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ed</span> <span class="o">*</span><span class="nf">find_head</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ed</span> <span class="o">*</span><span class="n">ed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* for bulk and control lists */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span><span class="p">)</span>
		<span class="n">ed</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* caller has locked the root hub */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ohci_rh_resume</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>		<span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">ohci_to_hcd</span> <span class="p">(</span><span class="n">ohci</span><span class="p">);</span>
	<span class="n">u32</span>			<span class="n">temp</span><span class="p">,</span> <span class="n">enables</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">autostopped</span> <span class="o">=</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">autostop</span><span class="p">;</span>

	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">autostop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">=</span> <span class="n">ohci_readl</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">OHCI_CTRL_IR</span> <span class="o">|</span> <span class="n">OHCI_SCHED_ENABLES</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* this can happen after resuming a swsusp snapshot */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">!=</span> <span class="n">OHCI_RH_RUNNING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ohci_dbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;BIOS/SMM active, control %03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="cm">/* this happens when pmcore resumes HC then root */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ohci_dbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;duplicate resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">switch</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;</span> <span class="n">OHCI_CTRL_HCFS</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OHCI_USB_SUSPEND</span>:
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">OHCI_CTRL_HCFS</span><span class="o">|</span><span class="n">OHCI_SCHED_ENABLES</span><span class="p">);</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">|=</span> <span class="n">OHCI_USB_RESUME</span><span class="p">;</span>
		<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ohci_readl</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
		<span class="n">ohci_dbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;%s root hub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">autostopped</span> <span class="o">?</span> <span class="s">&quot;auto-start&quot;</span> <span class="o">:</span> <span class="s">&quot;resume&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OHCI_USB_RESUME</span>:
		<span class="cm">/* HCFS changes sometime after INTR_RD */</span>
		<span class="n">ohci_dbg</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;%swakeup root hub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">autostopped</span> <span class="o">?</span> <span class="s">&quot;auto-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OHCI_USB_OPER</span>:
		<span class="cm">/* this can happen after resuming a swsusp snapshot */</span>
		<span class="n">ohci_dbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;snapshot resume? reinit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* RESET, we lost power */</span>
		<span class="n">ohci_dbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;lost power</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">autostopped</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ohci_init</span> <span class="p">(</span><span class="n">ohci</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ohci_restart</span> <span class="p">(</span><span class="n">ohci</span><span class="p">);</span>

			<span class="n">usb_root_hub_lost_power</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="p">);</span>

			<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">autostopped</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_resume</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Some controllers (lucent erratum) need extra-long delays */</span>
	<span class="n">msleep</span> <span class="p">(</span><span class="mi">20</span> <span class="cm">/* usb 11.5.1.10 */</span> <span class="o">+</span> <span class="mi">12</span> <span class="cm">/* 32 msec counter */</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">ohci_readl</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="n">OHCI_CTRL_HCFS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">OHCI_USB_RESUME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ohci_err</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;controller won&#39;t resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* disable old schedule state, reinit from scratch */</span>
	<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ed_controlhead</span><span class="p">);</span>
	<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ed_controlcurrent</span><span class="p">);</span>
	<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ed_bulkhead</span><span class="p">);</span>
	<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ed_bulkcurrent</span><span class="p">);</span>
	<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ed_periodcurrent</span><span class="p">);</span>
	<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hcca_dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">hcca</span><span class="p">);</span>

	<span class="cm">/* Sometimes PCI D3 suspend trashes frame timings ... */</span>
	<span class="n">periodic_reinit</span> <span class="p">(</span><span class="n">ohci</span><span class="p">);</span>

	<span class="cm">/* the following code is executed with ohci-&gt;lock held and</span>
<span class="cm">	 * irqs disabled if and only if autostopped is true</span>
<span class="cm">	 */</span>

<span class="nl">skip_resume:</span>
	<span class="cm">/* interrupts might have been disabled */</span>
	<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">OHCI_INTR_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intrenable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_rm_list</span><span class="p">)</span>
		<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">OHCI_INTR_SF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intrenable</span><span class="p">);</span>

	<span class="cm">/* Then re-enable operations */</span>
	<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">OHCI_USB_OPER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ohci_readl</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">autostopped</span><span class="p">)</span>
		<span class="n">msleep</span> <span class="p">(</span><span class="mi">3</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="n">OHCI_CTRL_RWC</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">OHCI_CONTROL_INIT</span> <span class="o">|</span> <span class="n">OHCI_USB_OPER</span><span class="p">;</span>
	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ohci_readl</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>

	<span class="cm">/* TRSMRCY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">autostopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span> <span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* now ohci-&gt;lock is always held and irqs are always disabled */</span>

	<span class="cm">/* keep it alive for more than ~5x suspend + resume costs */</span>
	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">next_statechange</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">STATECHANGE_DELAY</span><span class="p">;</span>

	<span class="cm">/* maybe turn schedules back on */</span>
	<span class="n">enables</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_rm_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_controltail</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span>
					<span class="n">find_head</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_controltail</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ed_controlhead</span><span class="p">);</span>
			<span class="n">enables</span> <span class="o">|=</span> <span class="n">OHCI_CTRL_CLE</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">OHCI_CLF</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_bulktail</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">find_head</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_bulktail</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ed_bulkhead</span><span class="p">);</span>
			<span class="n">enables</span> <span class="o">|=</span> <span class="n">OHCI_CTRL_BLE</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">OHCI_BLF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_isoc_reqs</span> <span class="o">||</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_int_reqs</span><span class="p">)</span>
		<span class="n">enables</span> <span class="o">|=</span> <span class="n">OHCI_CTRL_PLE</span><span class="o">|</span><span class="n">OHCI_CTRL_IE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enables</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ohci_dbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;restarting schedules ... %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enables</span><span class="p">);</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">|=</span> <span class="n">enables</span><span class="p">;</span>
		<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span>
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cmdstatus</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ohci_readl</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">=</span> <span class="n">OHCI_RH_RUNNING</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ohci_bus_suspend</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ohci_hcd</span>		<span class="o">*</span><span class="n">ohci</span> <span class="o">=</span> <span class="n">hcd_to_ohci</span> <span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">HCD_HW_ACCESSIBLE</span><span class="p">(</span><span class="n">hcd</span><span class="p">)))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ohci_rh_suspend</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ohci_bus_resume</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ohci_hcd</span>		<span class="o">*</span><span class="n">ohci</span> <span class="o">=</span> <span class="n">hcd_to_ohci</span> <span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span> <span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">next_statechange</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">HCD_HW_ACCESSIBLE</span><span class="p">(</span><span class="n">hcd</span><span class="p">)))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ohci_rh_resume</span> <span class="p">(</span><span class="n">ohci</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* poll until we know a device is connected or we autostop */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">usb_hcd_poll_rh_status</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Carry out the final steps of resuming the controller device */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__maybe_unused</span> <span class="nf">ohci_finish_controller_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ohci_hcd</span>		<span class="o">*</span><span class="n">ohci</span> <span class="o">=</span> <span class="n">hcd_to_ohci</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">port</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">need_reinit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* See if the controller is already running or has been reset */</span>
	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">=</span> <span class="n">ohci_readl</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">OHCI_CTRL_IR</span> <span class="o">|</span> <span class="n">OHCI_SCHED_ENABLES</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">need_reinit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;</span> <span class="n">OHCI_CTRL_HCFS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OHCI_USB_OPER</span>:
		<span class="k">case</span> <span class="n">OHCI_USB_RESET</span>:
			<span class="n">need_reinit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If needed, reinitialize and suspend the root hub */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_reinit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ohci_rh_resume</span><span class="p">(</span><span class="n">ohci</span><span class="p">);</span>
		<span class="n">ohci_rh_suspend</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Normally just turn on port power and enable interrupts */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ohci_dbg</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;powerup ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ohci_writel</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">RH_PS_PPS</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">roothub</span><span class="p">.</span><span class="n">portstatus</span><span class="p">[</span><span class="n">port</span><span class="p">]);</span>

		<span class="n">ohci_writel</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">OHCI_INTR_MIE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intrenable</span><span class="p">);</span>
		<span class="n">ohci_readl</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intrenable</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">usb_hcd_resume_root_hub</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Carry out polling-, autostop-, and autoresume-related state changes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ohci_root_hub_state_changes</span><span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">changed</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">any_connected</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rhsc_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">poll_rh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">rhsc_enable</span><span class="p">;</span>

	<span class="cm">/* Some broken controllers never turn off RHSC in the interrupt</span>
<span class="cm">	 * status register.  For their sake we won&#39;t re-enable RHSC</span>
<span class="cm">	 * interrupts if the interrupt bit is already active.</span>
<span class="cm">	 */</span>
	<span class="n">rhsc_enable</span> <span class="o">=</span> <span class="n">ohci_readl</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intrenable</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">OHCI_INTR_RHSC</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;</span> <span class="n">OHCI_CTRL_HCFS</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OHCI_USB_OPER</span>:
		<span class="cm">/* If no status changes are pending, enable RHSC interrupts. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rhsc_enable</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rhsc_status</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rhsc_enable</span> <span class="o">=</span> <span class="n">OHCI_INTR_RHSC</span><span class="p">;</span>
			<span class="n">ohci_writel</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">rhsc_enable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intrenable</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Keep on polling until we know a device is connected</span>
<span class="cm">		 * and RHSC is enabled, or until we autostop.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">autostop</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">any_connected</span> <span class="o">||</span>
					<span class="o">!</span><span class="n">device_may_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span>
						<span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rhsc_enable</span><span class="p">)</span>
					<span class="n">poll_rh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">autostop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">next_statechange</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="cm">/* if no devices have been attached for one second, autostop */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">||</span> <span class="n">any_connected</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">autostop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">next_statechange</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
						<span class="n">STATECHANGE_DELAY</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span>
						<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">next_statechange</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_rm_list</span>
					<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;</span>
						<span class="n">OHCI_SCHED_ENABLES</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ohci_rh_suspend</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rhsc_enable</span><span class="p">)</span>
					<span class="n">poll_rh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OHCI_USB_SUSPEND</span>:
	<span class="k">case</span> <span class="n">OHCI_USB_RESUME</span>:
		<span class="cm">/* if there is a port change, autostart or ask to be resumed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">autostop</span><span class="p">)</span>
				<span class="n">ohci_rh_resume</span><span class="p">(</span><span class="n">ohci</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">usb_hcd_resume_root_hub</span><span class="p">(</span><span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">));</span>

		<span class="cm">/* If remote wakeup is disabled, stop polling */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">autostop</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span>
					<span class="n">do_remote_wakeup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">poll_rh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* If no status changes are pending,</span>
<span class="cm">			 * enable RHSC interrupts</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rhsc_enable</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rhsc_status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rhsc_enable</span> <span class="o">=</span> <span class="n">OHCI_INTR_RHSC</span><span class="p">;</span>
				<span class="n">ohci_writel</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">rhsc_enable</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intrenable</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* Keep polling until RHSC is enabled */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rhsc_enable</span><span class="p">)</span>
				<span class="n">poll_rh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">poll_rh</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else	</span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ohci_rh_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Carry out polling-related state changes.</span>
<span class="cm"> * autostop isn&#39;t used when CONFIG_PM is turned off.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ohci_root_hub_state_changes</span><span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">changed</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">any_connected</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rhsc_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If RHSC is enabled, don&#39;t poll */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ohci_readl</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intrenable</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OHCI_INTR_RHSC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If status changes are pending, continue polling.</span>
<span class="cm">	 * Conversely, if no status changes are pending but the RHSC</span>
<span class="cm">	 * status bit was set, then RHSC may be broken so continue polling.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">||</span> <span class="n">rhsc_status</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* It&#39;s safe to re-enable RHSC interrupts */</span>
	<span class="n">ohci_writel</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">OHCI_INTR_RHSC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intrenable</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif	</span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* build &quot;status change&quot; packet (one or two bytes) from HC registers */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ohci_hub_status_data</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ohci_hcd</span>	<span class="o">*</span><span class="n">ohci</span> <span class="o">=</span> <span class="n">hcd_to_ohci</span> <span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">,</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">any_connected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">rhsc_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HCD_HW_ACCESSIBLE</span><span class="p">(</span><span class="n">hcd</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* undocumented erratum seen on at least rev D */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OHCI_QUIRK_AMD756</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">roothub_a</span> <span class="p">(</span><span class="n">ohci</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RH_A_NDP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_ROOT_PORTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ohci_warn</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;bogus NDP, rereads as NDP=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ohci_readl</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">roothub</span><span class="p">.</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RH_A_NDP</span><span class="p">);</span>
		<span class="cm">/* retry later; &quot;should not happen&quot; */</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* init status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">roothub_status</span> <span class="p">(</span><span class="n">ohci</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RH_HS_LPSC</span> <span class="o">|</span> <span class="n">RH_HS_OCIC</span><span class="p">))</span>
		<span class="n">buf</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">buf</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">length</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear the RHSC status flag before reading the port statuses */</span>
	<span class="n">ohci_writel</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">OHCI_INTR_RHSC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intrstatus</span><span class="p">);</span>
	<span class="n">rhsc_status</span> <span class="o">=</span> <span class="n">ohci_readl</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intrstatus</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">OHCI_INTR_RHSC</span><span class="p">;</span>

	<span class="cm">/* look at each port */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span>	<span class="n">status</span> <span class="o">=</span> <span class="n">roothub_portstatus</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="cm">/* can&#39;t autostop if ports are connected */</span>
		<span class="n">any_connected</span> <span class="o">|=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RH_PS_CCS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RH_PS_CSC</span> <span class="o">|</span> <span class="n">RH_PS_PESC</span> <span class="o">|</span> <span class="n">RH_PS_PSSC</span>
				<span class="o">|</span> <span class="n">RH_PS_OCIC</span> <span class="o">|</span> <span class="n">RH_PS_PRSC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span>
			    <span class="n">buf</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
			    <span class="n">buf</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">7</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ohci_root_hub_state_changes</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span>
			<span class="n">any_connected</span><span class="p">,</span> <span class="n">rhsc_status</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">HCD_FLAG_POLL_RH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">HCD_FLAG_POLL_RH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>


<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">changed</span> <span class="o">?</span> <span class="n">length</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ohci_hub_descriptor</span> <span class="p">(</span>
	<span class="k">struct</span> <span class="n">ohci_hcd</span>			<span class="o">*</span><span class="n">ohci</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">usb_hub_descriptor</span>	<span class="o">*</span><span class="n">desc</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="n">u32</span>		<span class="n">rh</span> <span class="o">=</span> <span class="n">roothub_a</span> <span class="p">(</span><span class="n">ohci</span><span class="p">);</span>
	<span class="n">u16</span>		<span class="n">temp</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bPwrOn2PwrGood</span> <span class="o">=</span> <span class="p">(</span><span class="n">rh</span> <span class="o">&amp;</span> <span class="n">RH_A_POTPGT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bHubContrCurrent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bNbrPorts</span> <span class="o">=</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescLength</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rh</span> <span class="o">&amp;</span> <span class="n">RH_A_NPS</span><span class="p">)</span>		<span class="cm">/* no power switching? */</span>
	    <span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x0002</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rh</span> <span class="o">&amp;</span> <span class="n">RH_A_PSM</span><span class="p">)</span>		<span class="cm">/* per-port power switching? */</span>
	    <span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x0001</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rh</span> <span class="o">&amp;</span> <span class="n">RH_A_NOCP</span><span class="p">)</span>		<span class="cm">/* no overcurrent reporting? */</span>
	    <span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x0010</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rh</span> <span class="o">&amp;</span> <span class="n">RH_A_OCPM</span><span class="p">)</span>	<span class="cm">/* per-port overcurrent reporting? */</span>
	    <span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x0008</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">wHubCharacteristics</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__u16</span><span class="p">)</span><span class="n">cpu_to_hc16</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="cm">/* ports removable, and usb 1.0 legacy PortPwrCtrlMask */</span>
	<span class="n">rh</span> <span class="o">=</span> <span class="n">roothub_b</span> <span class="p">(</span><span class="n">ohci</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">));</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rh</span> <span class="o">&amp;</span> <span class="n">RH_B_DR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rh</span> <span class="o">&amp;</span> <span class="n">RH_B_DR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef	CONFIG_USB_OTG</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ohci_start_port_reset</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ohci_hcd</span>	<span class="o">*</span><span class="n">ohci</span> <span class="o">=</span> <span class="n">hcd_to_ohci</span> <span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">u32</span>			<span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">port</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/* start port reset before HNP protocol times out */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ohci_readl</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">roothub</span><span class="p">.</span><span class="n">portstatus</span> <span class="p">[</span><span class="n">port</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RH_PS_CCS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* khubd will finish the reset later */</span>
	<span class="n">ohci_writel</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">RH_PS_PRS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">roothub</span><span class="p">.</span><span class="n">portstatus</span> <span class="p">[</span><span class="n">port</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define	ohci_start_port_reset		NULL</span>

<span class="cp">#endif</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>


<span class="cm">/* See usb 7.1.7.5:  root hubs must issue at least 50 msec reset signaling,</span>
<span class="cm"> * not necessarily continuous ... to guard against resume signaling.</span>
<span class="cm"> * The short timeout is safe for non-root hubs, and is backward-compatible</span>
<span class="cm"> * with earlier Linux hosts.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef	CONFIG_USB_SUSPEND</span>
<span class="cp">#define	PORT_RESET_MSEC		50</span>
<span class="cp">#else</span>
<span class="cp">#define	PORT_RESET_MSEC		10</span>
<span class="cp">#endif</span>

<span class="cm">/* this timer value might be vendor-specific ... */</span>
<span class="cp">#define	PORT_RESET_HW_MSEC	10</span>

<span class="cm">/* wrap-aware logic morphed from &lt;linux/jiffies.h&gt; */</span>
<span class="cp">#define tick_before(t1,t2) ((s16)(((s16)(t1))-((s16)(t2))) &lt; 0)</span>

<span class="cm">/* called from some task, normally khubd */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">root_port_reset</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__hc32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">portstat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">roothub</span><span class="p">.</span><span class="n">portstatus</span> <span class="p">[</span><span class="n">port</span><span class="p">];</span>
	<span class="n">u32</span>	<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">now</span> <span class="o">=</span> <span class="n">ohci_readl</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">fmnumber</span><span class="p">);</span>
	<span class="n">u16</span>	<span class="n">reset_done</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">PORT_RESET_MSEC</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">limit_1</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">PORT_RESET_MSEC</span><span class="p">,</span> <span class="n">PORT_RESET_HW_MSEC</span><span class="p">);</span>

	<span class="cm">/* build a &quot;continuous enough&quot; reset signal, with up to</span>
<span class="cm">	 * 3msec gap between pulses.  scheduler HZ==100 must work;</span>
<span class="cm">	 * this might need to be deadline-scheduled.</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">limit_2</span><span class="p">;</span>

		<span class="cm">/* spin until any current reset finishes */</span>
		<span class="n">limit_2</span> <span class="o">=</span> <span class="n">PORT_RESET_HW_MSEC</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">limit_2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">ohci_readl</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">portstat</span><span class="p">);</span>
			<span class="cm">/* handle e.g. CardBus eject */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="o">~</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">RH_PS_PRS</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span> <span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* timeout (a hardware error) has been observed when</span>
<span class="cm">		 * EHCI sets CF while this driver is resetting a port;</span>
<span class="cm">		 * presumably other disconnect paths might do it too.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">limit_2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ohci_dbg</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span>
				<span class="s">&quot;port[%d] reset timeout, stat %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">port</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">RH_PS_CCS</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">RH_PS_PRSC</span><span class="p">)</span>
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">RH_PS_PRSC</span><span class="p">,</span> <span class="n">portstat</span><span class="p">);</span>

		<span class="cm">/* start the next reset, sleep till it&#39;s probably done */</span>
		<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">RH_PS_PRS</span><span class="p">,</span> <span class="n">portstat</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">PORT_RESET_HW_MSEC</span><span class="p">);</span>
		<span class="n">now</span> <span class="o">=</span> <span class="n">ohci_readl</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">fmnumber</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tick_before</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">reset_done</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">limit_1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* caller synchronizes using PRSC ... and handles PRS</span>
<span class="cm">	 * still being set when this returns.</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ohci_hub_control</span> <span class="p">(</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>	<span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">typeReq</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">wValue</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">wIndex</span><span class="p">,</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">wLength</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ohci_hcd</span>	<span class="o">*</span><span class="n">ohci</span> <span class="o">=</span> <span class="n">hcd_to_ohci</span> <span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">ports</span> <span class="o">=</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">num_ports</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">HCD_HW_ACCESSIBLE</span><span class="p">(</span><span class="n">hcd</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">typeReq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ClearHubFeature</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">C_HUB_OVER_CURRENT</span>:
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">RH_HS_OCIC</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">roothub</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">C_HUB_LOCAL_POWER</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ClearPortFeature</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wIndex</span> <span class="o">||</span> <span class="n">wIndex</span> <span class="o">&gt;</span> <span class="n">ports</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">wIndex</span><span class="o">--</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_ENABLE</span>:
			<span class="n">temp</span> <span class="o">=</span> <span class="n">RH_PS_CCS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_ENABLE</span>:
			<span class="n">temp</span> <span class="o">=</span> <span class="n">RH_PS_PESC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_SUSPEND</span>:
			<span class="n">temp</span> <span class="o">=</span> <span class="n">RH_PS_POCI</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_SUSPEND</span>:
			<span class="n">temp</span> <span class="o">=</span> <span class="n">RH_PS_PSSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_POWER</span>:
			<span class="n">temp</span> <span class="o">=</span> <span class="n">RH_PS_LSDA</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_CONNECTION</span>:
			<span class="n">temp</span> <span class="o">=</span> <span class="n">RH_PS_CSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_OVER_CURRENT</span>:
			<span class="n">temp</span> <span class="o">=</span> <span class="n">RH_PS_OCIC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_RESET</span>:
			<span class="n">temp</span> <span class="o">=</span> <span class="n">RH_PS_PRSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">roothub</span><span class="p">.</span><span class="n">portstatus</span> <span class="p">[</span><span class="n">wIndex</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>ohci_readl (ohci, &amp;ohci->regs->roothub.portstatus [wIndex]);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetHubDescriptor</span>:
		<span class="n">ohci_hub_descriptor</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_hub_descriptor</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetHubStatus</span>:
		<span class="n">temp</span> <span class="o">=</span> <span class="n">roothub_status</span> <span class="p">(</span><span class="n">ohci</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">RH_HS_CRWE</span> <span class="o">|</span> <span class="n">RH_HS_DRWE</span><span class="p">);</span>
		<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetPortStatus</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wIndex</span> <span class="o">||</span> <span class="n">wIndex</span> <span class="o">&gt;</span> <span class="n">ports</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">wIndex</span><span class="o">--</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">roothub_portstatus</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">wIndex</span><span class="p">);</span>
		<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

<span class="cp">#ifndef	OHCI_VERBOSE_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>	<span class="cm">/* only if wPortChange is interesting */</span>
<span class="cp">#endif</span>
		<span class="n">dbg_port</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;GetStatus&quot;</span><span class="p">,</span> <span class="n">wIndex</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SetHubFeature</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">C_HUB_OVER_CURRENT</span>:</pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>FIXME:  this can be cleared, yes?</p></td><td class="code"><div class="highlight"><pre>		<span class="k">case</span> <span class="n">C_HUB_LOCAL_POWER</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SetPortFeature</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wIndex</span> <span class="o">||</span> <span class="n">wIndex</span> <span class="o">&gt;</span> <span class="n">ports</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">wIndex</span><span class="o">--</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_SUSPEND</span>:
<span class="cp">#ifdef	CONFIG_USB_OTG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">otg_port</span> <span class="o">==</span> <span class="p">(</span><span class="n">wIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">b_hnp_enable</span><span class="p">)</span>
				<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">start_hnp</span><span class="p">(</span><span class="n">ohci</span><span class="p">);</span>
			<span class="k">else</span>
<span class="cp">#endif</span>
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">RH_PS_PSS</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">roothub</span><span class="p">.</span><span class="n">portstatus</span> <span class="p">[</span><span class="n">wIndex</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_POWER</span>:
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">RH_PS_PPS</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">roothub</span><span class="p">.</span><span class="n">portstatus</span> <span class="p">[</span><span class="n">wIndex</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_RESET</span>:
			<span class="n">retval</span> <span class="o">=</span> <span class="n">root_port_reset</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">wIndex</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
<span class="nl">error:</span>
		<span class="cm">/* &quot;protocol stall&quot; on error */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
