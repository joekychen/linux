<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › host › ehci-hub.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ehci-hub.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2001-2004 by David Brownell</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2 of the License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class="cm"> * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software Foundation,</span>
<span class="cm"> * Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cm">/* this file is part of ehci-hcd.c */</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * EHCI Root Hub ... the nonsharable stuff</span>
<span class="cm"> *</span>
<span class="cm"> * Registers don&#39;t need cpu_to_le32, that happens transparently</span>
<span class="cm"> */</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>
<span class="cp">#include &lt;linux/usb/otg.h&gt;</span>

<span class="cp">#define	PORT_WAKE_BITS	(PORT_WKOC_E|PORT_WKDISC_E|PORT_WKCONN_E)</span>

<span class="cp">#ifdef	CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ehci_hub_control</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>	<span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">typeReq</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">wValue</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">wIndex</span><span class="p">,</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">wLength</span>
<span class="p">);</span>

<span class="cm">/* After a power loss, ports that were owned by the companion must be</span>
<span class="cm"> * reset so that the companion can still own them.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ehci_handover_companion_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">port</span><span class="p">;</span>
	<span class="n">__le32</span>		<span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>	<span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">ehci_to_hcd</span><span class="p">(</span><span class="n">ehci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">owned_ports</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Give the connections some time to appear */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">HCS_N_PORTS</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">port</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">owned_ports</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_RWC_BITS</span><span class="p">;</span>

			<span class="cm">/* Port already owned by companion? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_OWNER</span><span class="p">)</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">owned_ports</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">companion_ports</span><span class="p">))</span>
				<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_PE</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ehci_hub_control</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">SetPortFeature</span><span class="p">,</span>
						<span class="n">USB_PORT_FEAT_RESET</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">owned_ports</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">90</span><span class="p">);</span>		<span class="cm">/* Wait for resets to complete */</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">HCS_N_PORTS</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">port</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">owned_ports</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ehci_hub_control</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">GetPortStatus</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

			<span class="cm">/* The companion should now own the port,</span>
<span class="cm">			 * but if something went wrong the port must not</span>
<span class="cm">			 * remain enabled.</span>
<span class="cm">			 */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_RWC_BITS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_OWNER</span><span class="p">)</span>
				<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">status</span> <span class="o">|</span> <span class="n">PORT_CSC</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">ehci_dbg</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;failed handover port %d: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_PE</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">owned_ports</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__maybe_unused</span> <span class="nf">ehci_port_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">HCS_N_PORTS</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>

	<span class="cm">/* First check if the controller indicates a change event */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STS_PCD</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Not all controllers appear to update this while going from D3 to D0,</span>
<span class="cm">	 * so check the individual port status registers as well</span>
<span class="cm">	 */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">PORT_CSC</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__maybe_unused</span> <span class="kt">void</span> <span class="nf">ehci_adjust_port_wakeup_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">suspending</span><span class="p">,</span> <span class="n">bool</span> <span class="n">do_wakeup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">temp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* If remote wakeup is enabled for the root hub but disabled</span>
<span class="cm">	 * for the controller, we must adjust all the port wakeup flags</span>
<span class="cm">	 * when the controller is suspended or resumed.  In all other</span>
<span class="cm">	 * cases they don&#39;t need to be changed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehci_to_hcd</span><span class="p">(</span><span class="n">ehci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span><span class="n">do_remote_wakeup</span> <span class="o">||</span> <span class="n">do_wakeup</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* clear phy low-power mode before changing wakeup flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">has_hostpc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">HCS_N_PORTS</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">port</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">hostpc_reg</span><span class="p">;</span>

			<span class="n">hostpc_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span>
					<span class="o">+</span> <span class="n">HOSTPC0</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">port</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">hostpc_reg</span><span class="p">);</span>
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HOSTPC_PHCD</span><span class="p">,</span> <span class="n">hostpc_reg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">HCS_N_PORTS</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">port</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
		<span class="n">u32</span>		<span class="n">t1</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_RWC_BITS</span><span class="p">;</span>
		<span class="n">u32</span>		<span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_WAKE_BITS</span><span class="p">;</span>

		<span class="cm">/* If we are suspending the controller, clear the flags.</span>
<span class="cm">		 * If we are resuming the controller, set the wakeup flags.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">suspending</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&amp;</span> <span class="n">PORT_CONNECT</span><span class="p">)</span>
				<span class="n">t2</span> <span class="o">|=</span> <span class="n">PORT_WKOC_E</span> <span class="o">|</span> <span class="n">PORT_WKDISC_E</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">t2</span> <span class="o">|=</span> <span class="n">PORT_WKOC_E</span> <span class="o">|</span> <span class="n">PORT_WKCONN_E</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ehci_vdbg</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;port %d, %08x -&gt; %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">);</span>
		<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* enter phy low-power mode again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">has_hostpc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">HCS_N_PORTS</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">port</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">hostpc_reg</span><span class="p">;</span>

			<span class="n">hostpc_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span>
					<span class="o">+</span> <span class="n">HOSTPC0</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">port</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">hostpc_reg</span><span class="p">);</span>
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">HOSTPC_PHCD</span><span class="p">,</span> <span class="n">hostpc_reg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Does the root hub have a port wakeup pending? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">suspending</span> <span class="o">&amp;&amp;</span> <span class="n">ehci_port_change</span><span class="p">(</span><span class="n">ehci</span><span class="p">))</span>
		<span class="n">usb_hcd_resume_root_hub</span><span class="p">(</span><span class="n">ehci_to_hcd</span><span class="p">(</span><span class="n">ehci</span><span class="p">));</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehci_bus_suspend</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehci_hcd</span>		<span class="o">*</span><span class="n">ehci</span> <span class="o">=</span> <span class="n">hcd_to_ehci</span> <span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">changed</span><span class="p">;</span>

	<span class="n">ehci_dbg</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;suspend root hub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span> <span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">next_statechange</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">iaa_watchdog</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Once the controller is stopped, port resumes that are already</span>
<span class="cm">	 * in progress won&#39;t complete.  Hence if remote wakeup is enabled</span>
<span class="cm">	 * for the root hub and any ports are in the middle of a resume or</span>
<span class="cm">	 * remote wakeup, we must fail the suspend.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span><span class="n">do_remote_wakeup</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">resuming_ports</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">ehci_dbg</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;suspend failed because a port is resuming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* stop schedules, clean any completed work */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">==</span> <span class="n">EHCI_RH_RUNNING</span><span class="p">)</span>
		<span class="n">ehci_quiesce</span> <span class="p">(</span><span class="n">ehci</span><span class="p">);</span>
	<span class="n">ehci_work</span><span class="p">(</span><span class="n">ehci</span><span class="p">);</span>

	<span class="cm">/* Unlike other USB host controller types, EHCI doesn&#39;t have</span>
<span class="cm">	 * any notion of &quot;global&quot; or bus-wide suspend.  The driver has</span>
<span class="cm">	 * to manually suspend all the active unsuspended ports, and</span>
<span class="cm">	 * then manually resume them in the bus_resume() routine.</span>
<span class="cm">	 */</span>
	<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">bus_suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">owned_ports</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">HCS_N_PORTS</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">port</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="p">[</span><span class="n">port</span><span class="p">];</span>
		<span class="n">u32</span>		<span class="n">t1</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_RWC_BITS</span><span class="p">;</span>
		<span class="n">u32</span>		<span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_WAKE_BITS</span><span class="p">;</span>

		<span class="cm">/* keep track of which ports we suspend */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&amp;</span> <span class="n">PORT_OWNER</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">owned_ports</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">t1</span> <span class="o">&amp;</span> <span class="n">PORT_PE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">t1</span> <span class="o">&amp;</span> <span class="n">PORT_SUSPEND</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">t2</span> <span class="o">|=</span> <span class="n">PORT_SUSPEND</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">bus_suspended</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* enable remote wakeup on all ports, if told to do so */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span><span class="n">do_remote_wakeup</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* only enable appropriate wake bits, otherwise the</span>
<span class="cm">			 * hardware can not go phy low power mode. If a race</span>
<span class="cm">			 * condition happens here(connection change during bits</span>
<span class="cm">			 * set), the port change detection will finally fix it.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&amp;</span> <span class="n">PORT_CONNECT</span><span class="p">)</span>
				<span class="n">t2</span> <span class="o">|=</span> <span class="n">PORT_WKOC_E</span> <span class="o">|</span> <span class="n">PORT_WKDISC_E</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">t2</span> <span class="o">|=</span> <span class="n">PORT_WKOC_E</span> <span class="o">|</span> <span class="n">PORT_WKCONN_E</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t1</span> <span class="o">!=</span> <span class="n">t2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehci_vdbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;port %d, %08x -&gt; %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">);</span>
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;&amp;</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">has_hostpc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>	<span class="cm">/* 5 ms for HCD to enter low-power mode */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">port</span> <span class="o">=</span> <span class="n">HCS_N_PORTS</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">port</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">hostpc_reg</span><span class="p">;</span>
			<span class="n">u32</span>		<span class="n">t3</span><span class="p">;</span>

			<span class="n">hostpc_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span>
					<span class="o">+</span> <span class="n">HOSTPC0</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">port</span><span class="p">);</span>
			<span class="n">t3</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">hostpc_reg</span><span class="p">);</span>
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">t3</span> <span class="o">|</span> <span class="n">HOSTPC_PHCD</span><span class="p">,</span> <span class="n">hostpc_reg</span><span class="p">);</span>
			<span class="n">t3</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">hostpc_reg</span><span class="p">);</span>
			<span class="n">ehci_dbg</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;Port %d phy low-power mode %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="n">t3</span> <span class="o">&amp;</span> <span class="n">HOSTPC_PHCD</span><span class="p">)</span> <span class="o">?</span>
					<span class="s">&quot;succeeded&quot;</span> <span class="o">:</span> <span class="s">&quot;failed&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Apparently some devices need a &gt;= 1-uframe delay here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">bus_suspended</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="cm">/* turn off now-idle HC */</span>
	<span class="n">ehci_halt</span> <span class="p">(</span><span class="n">ehci</span><span class="p">);</span>
	<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">=</span> <span class="n">EHCI_RH_SUSPENDED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reclaim</span><span class="p">)</span>
		<span class="n">end_unlink_async</span><span class="p">(</span><span class="n">ehci</span><span class="p">);</span>

	<span class="cm">/* allow remote wakeup */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">INTR_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span><span class="n">do_remote_wakeup</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STS_PCD</span><span class="p">;</span>
	<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">);</span>
	<span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">);</span>

	<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">next_statechange</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* ehci_work() may have re-enabled the watchdog timer, which we do not</span>
<span class="cm">	 * want, and so we must delete any pending watchdog timer events.</span>
<span class="cm">	 */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* caller has locked the root hub, and should reset/reinit on error */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehci_bus_resume</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehci_hcd</span>		<span class="o">*</span><span class="n">ehci</span> <span class="o">=</span> <span class="n">hcd_to_ehci</span> <span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">u32</span>			<span class="n">temp</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">power_okay</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">resume_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span> <span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">next_statechange</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HCD_HW_ACCESSIBLE</span><span class="p">(</span><span class="n">hcd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dbgp_reset_prep</span><span class="p">())</span>
			<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dbgp_external_startup</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Ideally and we&#39;ve got a real resume here, and no port&#39;s power</span>
<span class="cm">	 * was lost.  (For PCI, that means Vaux was maintained.)  But we</span>
<span class="cm">	 * could instead be restoring a swsusp snapshot -- so that BIOS was</span>
<span class="cm">	 * the last user of the controller, not reset/pm hardware keeping</span>
<span class="cm">	 * state we gave to it.</span>
<span class="cm">	 */</span>
	<span class="n">power_okay</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">);</span>
	<span class="n">ehci_dbg</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;resume root hub%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">power_okay</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; after power loss&quot;</span><span class="p">);</span>

	<span class="cm">/* at least some APM implementations will try to deliver</span>
<span class="cm">	 * IRQs right away, so delay them until we&#39;re ready.</span>
<span class="cm">	 */</span>
	<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">);</span>

	<span class="cm">/* re-init operational registers */</span>
	<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">);</span>
	<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">periodic_dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">frame_list</span><span class="p">);</span>
	<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">qh_dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">async_next</span><span class="p">);</span>

	<span class="cm">/* restore CMD_RUN, framelist size, and irq threshold */</span>
	<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">|=</span> <span class="n">CMD_RUN</span><span class="p">;</span>
	<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>
	<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">=</span> <span class="n">EHCI_RH_RUNNING</span><span class="p">;</span>

	<span class="cm">/* Some controller/firmware combinations need a delay during which</span>
<span class="cm">	 * they set up the port statuses.  See Bugzilla #8190. */</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* clear phy low-power mode before resume */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">bus_suspended</span> <span class="o">&amp;&amp;</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">has_hostpc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">HCS_N_PORTS</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">bus_suspended</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">hostpc_reg</span><span class="p">;</span>

				<span class="n">hostpc_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span>
						<span class="o">+</span> <span class="n">HOSTPC0</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">hostpc_reg</span><span class="p">);</span>
				<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HOSTPC_PHCD</span><span class="p">,</span>
						<span class="n">hostpc_reg</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* manually resume the ports we suspended during bus_suspend() */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">HCS_N_PORTS</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PORT_RWC_BITS</span> <span class="o">|</span> <span class="n">PORT_WAKE_BITS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">bus_suspended</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_SUSPEND</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">PORT_RESUME</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resume_needed</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* msleep for 20ms only if code is trying to resume port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resume_needed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">HCS_N_PORTS</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resume_needed</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PORT_RWC_BITS</span> <span class="o">|</span> <span class="n">PORT_RESUME</span><span class="p">);</span>
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">ehci_vdbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;resumed port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>

	<span class="cm">/* maybe re-activate the schedule(s) */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">qh_next</span><span class="p">.</span><span class="n">qh</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">CMD_ASE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">periodic_sched</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">CMD_PSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">|=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">next_statechange</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Now we can safely re-enable irqs */</span>
	<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">INTR_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ehci_handover_companion_ports</span><span class="p">(</span><span class="n">ehci</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define ehci_bus_suspend	NULL</span>
<span class="cp">#define ehci_bus_resume		NULL</span>

<span class="cp">#endif	</span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * Sets the owner of a port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_owner</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portnum</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_owner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">status_reg</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">port_status</span><span class="p">;</span>
	<span class="kt">int</span> 			<span class="n">try</span><span class="p">;</span>

	<span class="n">status_reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span><span class="p">[</span><span class="n">portnum</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * The controller won&#39;t set the OWNER bit if the port is</span>
<span class="cm">	 * enabled, so this loop will sometimes require at least two</span>
<span class="cm">	 * iterations: one to disable the port and one to set OWNER.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">try</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">try</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">try</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">port_status</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">PORT_OWNER</span><span class="p">)</span> <span class="o">==</span> <span class="n">new_owner</span>
				<span class="o">||</span> <span class="p">(</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PORT_OWNER</span> <span class="o">|</span> <span class="n">PORT_CONNECT</span><span class="p">))</span>
					<span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">try</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">port_status</span> <span class="o">^=</span> <span class="n">PORT_OWNER</span><span class="p">;</span>
			<span class="n">port_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PORT_PE</span> <span class="o">|</span> <span class="n">PORT_RWC_BITS</span><span class="p">);</span>
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">port_status</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">try</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_reset_complete</span> <span class="p">(</span>
	<span class="k">struct</span> <span class="n">ehci_hcd</span>	<span class="o">*</span><span class="n">ehci</span><span class="p">,</span>
	<span class="kt">int</span>		<span class="n">index</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">status_reg</span><span class="p">,</span>
	<span class="kt">int</span>		<span class="n">port_status</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">PORT_CONNECT</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">port_status</span><span class="p">;</span>

	<span class="cm">/* if reset finished and it&#39;s still not enabled -- handoff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">PORT_PE</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* with integrated TT, there&#39;s nobody to hand it to! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehci_is_TDI</span><span class="p">(</span><span class="n">ehci</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ehci_dbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
				<span class="s">&quot;Failed to enable port %d on root hub TT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">port_status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ehci_dbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;port %d full speed --&gt; companion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>what happens if HCS<em>N</em>CC(params) == 0 ?</p></td><td class="code"><div class="highlight"><pre>		<span class="n">port_status</span> <span class="o">|=</span> <span class="n">PORT_OWNER</span><span class="p">;</span>
		<span class="n">port_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_RWC_BITS</span><span class="p">;</span>
		<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">port_status</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>

		<span class="cm">/* ensure 440EPX ohci controller state is operational */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">has_amcc_usb23</span><span class="p">)</span>
			<span class="n">set_ohci_hcfs</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ehci_dbg</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;port %d reset complete, port enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* ensure 440EPx ohci controller state is suspended */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">has_amcc_usb23</span><span class="p">)</span>
			<span class="n">set_ohci_hcfs</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">port_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>


<span class="cm">/* build &quot;status change&quot; packet (one or two bytes) from HC registers */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ehci_hub_status_data</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehci_hcd</span>	<span class="o">*</span><span class="n">ehci</span> <span class="o">=</span> <span class="n">hcd_to_ehci</span> <span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">u32</span>		<span class="n">temp</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ports</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">ppcd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* init status to no-changes */</span>
	<span class="n">buf</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ports</span> <span class="o">=</span> <span class="n">HCS_N_PORTS</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ports</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">retval</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Inform the core about resumes-in-progress by returning</span>
<span class="cm">	 * a non-zero value even if there are no status changes.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">resuming_ports</span><span class="p">;</span>

	<span class="cm">/* Some boards (mostly VIA?) report bogus overcurrent indications,</span>
<span class="cm">	 * causing massive log spam unless we completely ignore them.  It</span>
<span class="cm">	 * may be relevant that VIA VT8235 controllers, where PORT_POWER is</span>
<span class="cm">	 * always set, seem to clear PORT_OCC and PORT_CSC when writing to</span>
<span class="cm">	 * PORT_POWER; that&#39;s surprising, but maybe within-spec.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ignore_oc</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">PORT_CSC</span> <span class="o">|</span> <span class="n">PORT_PEC</span> <span class="o">|</span> <span class="n">PORT_OCC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">PORT_CSC</span> <span class="o">|</span> <span class="n">PORT_PEC</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>PORT<em>RESUME from hardware ~= PORT</em>STAT<em>C</em>SUSPEND</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* no hub change reports (bit 0) for now (power, ...) */</span>

	<span class="cm">/* port N changes (bit N)? */</span>
	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* get per-port change detect bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">has_ppcd</span><span class="p">)</span>
		<span class="n">ppcd</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* leverage per-port change bits feature */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">has_ppcd</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ppcd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Return status information even for ports with OWNER set.</span>
<span class="cm">		 * Otherwise khubd wouldn&#39;t see the disconnect event when a</span>
<span class="cm">		 * high-speed device is switched over to the companion</span>
<span class="cm">		 * controller by the user.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">port_c_suspend</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reset_done</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">time_after_eq</span><span class="p">(</span>
					<span class="n">jiffies</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reset_done</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span>
			    <span class="n">buf</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
			    <span class="n">buf</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">7</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">STS_PCD</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* FIXME autosuspend idle root hubs */</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span> <span class="o">?</span> <span class="n">retval</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ehci_hub_descriptor</span> <span class="p">(</span>
	<span class="k">struct</span> <span class="n">ehci_hcd</span>			<span class="o">*</span><span class="n">ehci</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">usb_hub_descriptor</span>	<span class="o">*</span><span class="n">desc</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span>		<span class="n">ports</span> <span class="o">=</span> <span class="n">HCS_N_PORTS</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
	<span class="n">u16</span>		<span class="n">temp</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bPwrOn2PwrGood</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* ehci 1.0, 2.3.9 says 20ms max */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bHubContrCurrent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bNbrPorts</span> <span class="o">=</span> <span class="n">ports</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">ports</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescLength</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* two bitmaps:  ports removable, and usb 1.0 legacy PortPwrCtrlMask */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="n">temp</span><span class="p">],</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="mh">0x0008</span><span class="p">;</span>			<span class="cm">/* per-port overcurrent reporting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HCS_PPC</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">))</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x0001</span><span class="p">;</span>		<span class="cm">/* per-port power control */</span>
	<span class="k">else</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x0002</span><span class="p">;</span>		<span class="cm">/* no power switching */</span>
<span class="cp">#if 0</span><span class="c"></span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>re-enable when we support USB<em>PORT</em>FEAT_INDICATOR below.</p></td><td class="code"><div class="highlight"><pre><span class="c">	if (HCS_INDICATOR (ehci-&gt;hcs_params))</span>
<span class="c">		temp |= 0x0080;		/* per-port indicators (LEDs) */</span>
<span class="cp">#endif</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">wHubCharacteristics</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehci_hub_control</span> <span class="p">(</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>	<span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">typeReq</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">wValue</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">wIndex</span><span class="p">,</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">wLength</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehci_hcd</span>	<span class="o">*</span><span class="n">ehci</span> <span class="o">=</span> <span class="n">hcd_to_ehci</span> <span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">ports</span> <span class="o">=</span> <span class="n">HCS_N_PORTS</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">status_reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span><span class="p">[</span>
				<span class="p">(</span><span class="n">wIndex</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">hostpc_reg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">temp</span><span class="p">,</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">selector</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME:  support SetPortFeatures USB_PORT_FEAT_INDICATOR.</span>
<span class="cm">	 * HCS_INDICATOR may say we can change LEDs to off/amber/green.</span>
<span class="cm">	 * (track current state ourselves) ... blink for diagnostics,</span>
<span class="cm">	 * power, &quot;this is the one&quot;, etc.  EHCI spec supports this.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">has_hostpc</span><span class="p">)</span>
		<span class="n">hostpc_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span>
				<span class="o">+</span> <span class="n">HOSTPC0</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">((</span><span class="n">wIndex</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">typeReq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ClearHubFeature</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">C_HUB_LOCAL_POWER</span>:
		<span class="k">case</span> <span class="n">C_HUB_OVER_CURRENT</span>:
			<span class="cm">/* no hub-wide feature/status flags */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ClearPortFeature</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wIndex</span> <span class="o">||</span> <span class="n">wIndex</span> <span class="o">&gt;</span> <span class="n">ports</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">wIndex</span><span class="o">--</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_RWC_BITS</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Even if OWNER is set, so the port is owned by the</span>
<span class="cm">		 * companion controller, khubd needs to be able to clear</span>
<span class="cm">		 * the port-change status bits (especially</span>
<span class="cm">		 * USB_PORT_STAT_C_CONNECTION).</span>
<span class="cm">		 */</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_ENABLE</span>:
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_PE</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_ENABLE</span>:
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">PORT_PEC</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_SUSPEND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_RESET</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">no_selective_suspend</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_USB_OTG</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">otg_port</span> <span class="o">==</span> <span class="p">(</span><span class="n">wIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			    <span class="o">&amp;&amp;</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">b_hnp_enable</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">otg_start_hnp</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_SUSPEND</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_PE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="cm">/* clear phy low-power mode before resume */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hostpc_reg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">temp1</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">hostpc_reg</span><span class="p">);</span>
				<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HOSTPC_PHCD</span><span class="p">,</span>
						<span class="n">hostpc_reg</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="cm">/* wait to leave low-power mode */</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* resume signaling for 20 msec */</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_WAKE_BITS</span><span class="p">;</span>
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">PORT_RESUME</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
			<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reset_done</span><span class="p">[</span><span class="n">wIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span>
					<span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_SUSPEND</span>:
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">wIndex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">port_c_suspend</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_POWER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">HCS_PPC</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">))</span>
				<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_POWER</span><span class="p">,</span>
						<span class="n">status_reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_CONNECTION</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">has_lpm</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* clear PORTSC bits on disconnect */</span>
				<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_LPM</span><span class="p">;</span>
				<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_DEV_ADDR</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">PORT_CSC</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_OVER_CURRENT</span>:
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">PORT_OCC</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_RESET</span>:
			<span class="cm">/* GetPortStatus clears reset */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>	<span class="cm">/* unblock posted write */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetHubDescriptor</span>:
		<span class="n">ehci_hub_descriptor</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_hub_descriptor</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetHubStatus</span>:
		<span class="cm">/* no hub-wide feature/status flags */</span>
		<span class="n">memset</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>cpu<em>to</em>le32s ((u32 *) buf);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetPortStatus</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wIndex</span> <span class="o">||</span> <span class="n">wIndex</span> <span class="o">&gt;</span> <span class="n">ports</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">wIndex</span><span class="o">--</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>wPortChange bits</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_CSC</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_C_CONNECTION</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_PEC</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_C_ENABLE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_OCC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ignore_oc</span><span class="p">){</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_C_OVERCURRENT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Hubs should disable port power on over-current.</span>
<span class="cm">			 * However, not all EHCI implementations do this</span>
<span class="cm">			 * automatically, even if they _do_ support per-port</span>
<span class="cm">			 * power switching; they&#39;re allowed to just limit the</span>
<span class="cm">			 * current.  khubd will turn the power back on.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_OC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">HCS_PPC</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
					<span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PORT_RWC_BITS</span> <span class="o">|</span> <span class="n">PORT_POWER</span><span class="p">),</span>
					<span class="n">status_reg</span><span class="p">);</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* whoever resumes must GetPortStatus to complete it!! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_RESUME</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* Remote Wakeup received? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reset_done</span><span class="p">[</span><span class="n">wIndex</span><span class="p">])</span> <span class="p">{</span>
				<span class="cm">/* resume signaling for 20 msec */</span>
				<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reset_done</span><span class="p">[</span><span class="n">wIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span>
						<span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
				<span class="cm">/* check the port again */</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci_to_hcd</span><span class="p">(</span><span class="n">ehci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rh_timer</span><span class="p">,</span>
						<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reset_done</span><span class="p">[</span><span class="n">wIndex</span><span class="p">]);</span>
			<span class="p">}</span>

			<span class="cm">/* resume completed? */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span>
					<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reset_done</span><span class="p">[</span><span class="n">wIndex</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">wIndex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">suspended_ports</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">wIndex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">port_c_suspend</span><span class="p">);</span>
				<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reset_done</span><span class="p">[</span><span class="n">wIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* stop resume signaling */</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
				<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
					<span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PORT_RWC_BITS</span> <span class="o">|</span> <span class="n">PORT_RESUME</span><span class="p">),</span>
					<span class="n">status_reg</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">wIndex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">resuming_ports</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">handshake</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">,</span>
					   <span class="n">PORT_RESUME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2000</span> <span class="cm">/* 2msec */</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ehci_err</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
						<span class="s">&quot;port %d resume error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">wIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PORT_SUSPEND</span><span class="o">|</span><span class="n">PORT_RESUME</span><span class="o">|</span><span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* whoever resets must GetPortStatus to complete it!! */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_RESET</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span>
					<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reset_done</span><span class="p">[</span><span class="n">wIndex</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_C_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reset_done</span> <span class="p">[</span><span class="n">wIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">wIndex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">resuming_ports</span><span class="p">);</span>

			<span class="cm">/* force reset to complete */</span>
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PORT_RWC_BITS</span> <span class="o">|</span> <span class="n">PORT_RESET</span><span class="p">),</span>
					<span class="n">status_reg</span><span class="p">);</span>
			<span class="cm">/* REVISIT:  some hardware needs 550+ usec to clear</span>
<span class="cm">			 * this bit; seems too long to spin routinely...</span>
<span class="cm">			 */</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">handshake</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">,</span>
					<span class="n">PORT_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ehci_err</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;port %d reset error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">wIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* see what we found out */</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">check_reset_complete</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">wIndex</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">,</span>
					<span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PORT_RESUME</span><span class="o">|</span><span class="n">PORT_RESET</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reset_done</span><span class="p">[</span><span class="n">wIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">wIndex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">resuming_ports</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* transfer dedicated ports to the companion hc */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_CONNECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">test_bit</span><span class="p">(</span><span class="n">wIndex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">companion_ports</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_RWC_BITS</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">PORT_OWNER</span><span class="p">;</span>
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
			<span class="n">ehci_dbg</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;port %d --&gt; companion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Even if OWNER is set, there&#39;s no harm letting khubd</span>
<span class="cm">		 * see the wPortStatus values (they should all be 0 except</span>
<span class="cm">		 * for PORT_POWER anyway).</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_CONNECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>status may be from integrated TT</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">has_hostpc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">temp1</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">hostpc_reg</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">ehci_port_speed</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">ehci_port_speed</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_PE</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_ENABLE</span><span class="p">;</span>

		<span class="cm">/* maybe the port was unsuspended without our knowledge */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PORT_SUSPEND</span><span class="o">|</span><span class="n">PORT_RESUME</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">wIndex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">suspended_ports</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">wIndex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">suspended_ports</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">wIndex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">resuming_ports</span><span class="p">);</span>
			<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reset_done</span><span class="p">[</span><span class="n">wIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_PE</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">wIndex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">port_c_suspend</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_OC</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_OVERCURRENT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_RESET</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_RESET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_POWER</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_POWER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">wIndex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">port_c_suspend</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_C_SUSPEND</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

<span class="cp">#ifndef	VERBOSE_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xffff</span><span class="p">)</span>	<span class="cm">/* only if wPortChange is interesting */</span>
<span class="cp">#endif</span>
		<span class="n">dbg_port</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;GetStatus&quot;</span><span class="p">,</span> <span class="n">wIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SetHubFeature</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">C_HUB_LOCAL_POWER</span>:
		<span class="k">case</span> <span class="n">C_HUB_OVER_CURRENT</span>:
			<span class="cm">/* no hub-wide feature/status flags */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SetPortFeature</span>:
		<span class="n">selector</span> <span class="o">=</span> <span class="n">wIndex</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">wIndex</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* If the debug port is active any port</span>
<span class="cm">			 * feature requests should get denied */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wIndex</span> <span class="o">==</span> <span class="n">HCS_DEBUG_PORT</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DBGP_ENABLED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error_exit</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wIndex</span> <span class="o">||</span> <span class="n">wIndex</span> <span class="o">&gt;</span> <span class="n">ports</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">wIndex</span><span class="o">--</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_OWNER</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_RWC_BITS</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_SUSPEND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">no_selective_suspend</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_PE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
					<span class="o">||</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_RESET</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="cm">/* After above check the port must be connected.</span>
<span class="cm">			 * Set appropriate bit thus could put phy into low power</span>
<span class="cm">			 * mode if we have hostpc feature</span>
<span class="cm">			 */</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_WKCONN_E</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">PORT_WKDISC_E</span> <span class="o">|</span> <span class="n">PORT_WKOC_E</span><span class="p">;</span>
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">PORT_SUSPEND</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hostpc_reg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="cm">/* 5ms for HCD enter low pwr mode */</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">temp1</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">hostpc_reg</span><span class="p">);</span>
				<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp1</span> <span class="o">|</span> <span class="n">HOSTPC_PHCD</span><span class="p">,</span>
					<span class="n">hostpc_reg</span><span class="p">);</span>
				<span class="n">temp1</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">hostpc_reg</span><span class="p">);</span>
				<span class="n">ehci_dbg</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;Port%d phy low pwr mode %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">wIndex</span><span class="p">,</span> <span class="p">(</span><span class="n">temp1</span> <span class="o">&amp;</span> <span class="n">HOSTPC_PHCD</span><span class="p">)</span> <span class="o">?</span>
					<span class="s">&quot;succeeded&quot;</span> <span class="o">:</span> <span class="s">&quot;failed&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">wIndex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">suspended_ports</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_POWER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">HCS_PPC</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">))</span>
				<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">PORT_POWER</span><span class="p">,</span>
						<span class="n">status_reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_RESET</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_RESUME</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="cm">/* line status bits may report this as low speed,</span>
<span class="cm">			 * which can be fine if this root hub has a</span>
<span class="cm">			 * transaction translator built in.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PORT_PE</span><span class="o">|</span><span class="n">PORT_CONNECT</span><span class="p">))</span> <span class="o">==</span> <span class="n">PORT_CONNECT</span>
					<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ehci_is_TDI</span><span class="p">(</span><span class="n">ehci</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="n">PORT_USB11</span> <span class="p">(</span><span class="n">temp</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ehci_dbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
					<span class="s">&quot;port %d low speed --&gt; companion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">wIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">temp</span> <span class="o">|=</span> <span class="n">PORT_OWNER</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ehci_vdbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;port %d reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">temp</span> <span class="o">|=</span> <span class="n">PORT_RESET</span><span class="p">;</span>
				<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_PE</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * caller must wait, then call GetPortStatus</span>
<span class="cm">				 * usb 2.0 spec says 50 ms resets on root</span>
<span class="cm">				 */</span>
				<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reset_done</span> <span class="p">[</span><span class="n">wIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span>
						<span class="o">+</span> <span class="n">msecs_to_jiffies</span> <span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* For downstream facing ports (these):  one hub port is put</span>
<span class="cm">		 * into test mode according to USB2 11.24.2.13, then the hub</span>
<span class="cm">		 * must be reset (which for root hub now means rmmod+modprobe,</span>
<span class="cm">		 * or else system reboot).  See EHCI 2.3.9 and 4.14 for info</span>
<span class="cm">		 * about the EHCI-specific stuff.</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_TEST</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">selector</span> <span class="o">||</span> <span class="n">selector</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">ehci_quiesce</span><span class="p">(</span><span class="n">ehci</span><span class="p">);</span>

			<span class="cm">/* Put all enabled ports into suspend */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">ports</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sreg</span> <span class="o">=</span>
						<span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span><span class="p">[</span><span class="n">ports</span><span class="p">];</span>

				<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">sreg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_RWC_BITS</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_PE</span><span class="p">)</span>
					<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">PORT_SUSPEND</span><span class="p">,</span>
							<span class="n">sreg</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ehci_halt</span><span class="p">(</span><span class="n">ehci</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">selector</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>	<span class="cm">/* unblock posted writes */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
<span class="nl">error:</span>
		<span class="cm">/* &quot;stall&quot; on error */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">error_exit:</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__maybe_unused</span> <span class="nf">ehci_relinquish_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">portnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehci_hcd</span>		<span class="o">*</span><span class="n">ehci</span> <span class="o">=</span> <span class="n">hcd_to_ehci</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehci_is_TDI</span><span class="p">(</span><span class="n">ehci</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">set_owner</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">--</span><span class="n">portnum</span><span class="p">,</span> <span class="n">PORT_OWNER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__maybe_unused</span> <span class="nf">ehci_port_handed_over</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">portnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehci_hcd</span>		<span class="o">*</span><span class="n">ehci</span> <span class="o">=</span> <span class="n">hcd_to_ehci</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehci_is_TDI</span><span class="p">(</span><span class="n">ehci</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span><span class="p">[</span><span class="n">portnum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PORT_OWNER</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
