<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › host › hwa-hc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hwa-hc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Host Wire Adapter:</span>
<span class="cm"> * Driver glue, HWA-specific functions, bridges to WAHC and WUSBHC</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Intel Corporation</span>
<span class="cm"> * Inaky Perez-Gonzalez &lt;inaky.perez-gonzalez@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version</span>
<span class="cm"> * 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * The HWA driver is a simple layer that forwards requests to the WAHC</span>
<span class="cm"> * (Wire Adater Host Controller) or WUSBHC (Wireless USB Host</span>
<span class="cm"> * Controller) layers.</span>
<span class="cm"> *</span>
<span class="cm"> * Host Wire Adapter is the &#39;WUSB 1.0 standard&#39; name for Wireless-USB</span>
<span class="cm"> * Host Controller that is connected to your system via USB (a USB</span>
<span class="cm"> * dongle that implements a USB host...). There is also a Device Wired</span>
<span class="cm"> * Adaptor, DWA (Wireless USB hub) that uses the same mechanism for</span>
<span class="cm"> * transferring data (it is after all a USB host connected via</span>
<span class="cm"> * Wireless USB), we have a common layer called Wire Adapter Host</span>
<span class="cm"> * Controller that does all the hard work. The WUSBHC (Wireless USB</span>
<span class="cm"> * Host Controller) is the part common to WUSB Host Controllers, the</span>
<span class="cm"> * HWA and the PCI-based one, that is implemented following the WHCI</span>
<span class="cm"> * spec. All these layers are implemented in ../wusbcore.</span>
<span class="cm"> *</span>
<span class="cm"> * The main functions are hwahc_op_urb_{en,de}queue(), that pass the</span>
<span class="cm"> * job of converting a URB to a Wire Adapter</span>
<span class="cm"> *</span>
<span class="cm"> * Entry points:</span>
<span class="cm"> *</span>
<span class="cm"> *   hwahc_driver_*()   Driver initialization, registration and</span>
<span class="cm"> *                      teardown.</span>
<span class="cm"> *</span>
<span class="cm"> *   hwahc_probe()	New device came up, create an instance for</span>
<span class="cm"> *                      it [from device enumeration].</span>
<span class="cm"> *</span>
<span class="cm"> *   hwahc_disconnect()	Remove device instance [from device</span>
<span class="cm"> *                      enumeration].</span>
<span class="cm"> *</span>
<span class="cm"> *   [__]hwahc_op_*()   Host-Wire-Adaptor specific functions for</span>
<span class="cm"> *                      starting/stopping/etc (some might be made also</span>
<span class="cm"> *                      DWA).</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &quot;../wusbcore/wa-hc.h&quot;</span>
<span class="cp">#include &quot;../wusbcore/wusbhc.h&quot;</span>

<span class="k">struct</span> <span class="n">hwahc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">wusbhc</span> <span class="n">wusbhc</span><span class="p">;</span>	<span class="cm">/* has to be 1st */</span>
	<span class="k">struct</span> <span class="n">wahc</span> <span class="n">wa</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * FIXME should be wusbhc</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: we need to cache the Cluster ID because later...there is no</span>
<span class="cm"> *       way to get it :)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__hwahc_set_cluster_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cluster_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wusbhc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wahc</span> <span class="o">*</span><span class="n">wa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">WUSB_REQ_SET_CLUSTER_ID</span><span class="p">,</span>
			<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			<span class="n">cluster_id</span><span class="p">,</span>
			<span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span> <span class="cm">/* FIXME: arbitrary */</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot set WUSB Cluster ID to 0x%02x: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cluster_id</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">cluster_id</span> <span class="o">=</span> <span class="n">cluster_id</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Wireless USB Cluster ID set to 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cluster_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__hwahc_op_set_num_dnts</span><span class="p">(</span><span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">interval</span><span class="p">,</span> <span class="n">u8</span> <span class="n">slots</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wahc</span> <span class="o">*</span><span class="n">wa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">WUSB_REQ_SET_NUM_DNTS</span><span class="p">,</span>
			<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			<span class="n">interval</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">slots</span><span class="p">,</span>
			<span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span> <span class="cm">/* FIXME: arbitrary */</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset a WUSB host controller and wait for it to complete doing it.</span>
<span class="cm"> *</span>
<span class="cm"> * @usb_hcd:	Pointer to WUSB Host Controller instance.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hwahc_op_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">usb_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span> <span class="o">=</span> <span class="n">usb_hcd_to_wusbhc</span><span class="p">(</span><span class="n">usb_hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">.</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wa_nep_disarm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">__wa_set_feature</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">,</span> <span class="n">WA_RESET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error commanding HC to reset: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">__wa_wait_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">,</span> <span class="n">WA_STATUS_RESETTING</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error waiting for HC to reset: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_unlock</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">error_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FIXME: break this function up</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hwahc_op_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">usb_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span> <span class="o">=</span> <span class="n">usb_hcd_to_wusbhc</span><span class="p">(</span><span class="n">usb_hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">wusb_cluster_id_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_cluster_id_get</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">__hwahc_set_cluster_id</span><span class="p">(</span><span class="n">hwahc</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_set_cluster_id</span><span class="p">;</span>

	<span class="n">usb_hcd</span><span class="o">-&gt;</span><span class="n">uses_new_polling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">HCD_FLAG_POLL_RH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usb_hcd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">usb_hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_RUNNING</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="nl">error_set_cluster_id:</span>
	<span class="n">wusb_cluster_id_put</span><span class="p">(</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">cluster_id</span><span class="p">);</span>
<span class="nl">error_cluster_id_get:</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * No need to abort pipes, as when this is called, all the children</span>
<span class="cm"> * has been disconnected and that has done it [through</span>
<span class="cm"> * usb_disable_interface() -&gt; usb_disable_endpoint() -&gt;</span>
<span class="cm"> * hwahc_op_ep_disable() - &gt;rpipe_ep_disable()].</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwahc_op_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">usb_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span> <span class="o">=</span> <span class="n">usb_hcd_to_wusbhc</span><span class="p">(</span><span class="n">usb_hcd</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wusb_cluster_id_put</span><span class="p">(</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">cluster_id</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hwahc_op_get_frame_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">usb_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span> <span class="o">=</span> <span class="n">usb_hcd_to_wusbhc</span><span class="p">(</span><span class="n">usb_hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s (%p [%p]) UNIMPLEMENTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">usb_hcd</span><span class="p">,</span> <span class="n">hwahc</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hwahc_op_urb_enqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">usb_hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
				<span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span> <span class="o">=</span> <span class="n">usb_hcd_to_wusbhc</span><span class="p">(</span><span class="n">usb_hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wa_urb_enqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hwahc_op_urb_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">usb_hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span> <span class="o">=</span> <span class="n">usb_hcd_to_wusbhc</span><span class="p">(</span><span class="n">usb_hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wa_urb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release resources allocated for an endpoint</span>
<span class="cm"> *</span>
<span class="cm"> * If there is an associated rpipe to this endpoint, go ahead and put it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwahc_op_endpoint_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">usb_hcd</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span> <span class="o">=</span> <span class="n">usb_hcd_to_wusbhc</span><span class="p">(</span><span class="n">usb_hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>

	<span class="n">rpipe_ep_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__hwahc_op_wusbhc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">.</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">__wa_set_feature</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">,</span> <span class="n">WA_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error commanding HC to start: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_stop</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">__wa_wait_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">,</span> <span class="n">WA_ENABLE</span><span class="p">,</span> <span class="n">WA_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error waiting for HC to start: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_stop</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">wa_nep_arm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot listen to notifications: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_stop</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="nl">error_stop:</span>
	<span class="n">__wa_clear_feature</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">,</span> <span class="n">WA_ENABLE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__hwahc_op_wusbhc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wahc</span> <span class="o">*</span><span class="n">wa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iface_no</span> <span class="o">=</span> <span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="n">WUSB_REQ_CHAN_STOP</span><span class="p">,</span>
			      <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			      <span class="n">delay</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
			      <span class="n">iface_no</span><span class="p">,</span>
			      <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span> <span class="cm">/* FIXME: arbitrary */</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>

	<span class="n">wa_nep_disarm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">);</span>
	<span class="n">__wa_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the UWB MAS allocation for the WUSB cluster</span>
<span class="cm"> *</span>
<span class="cm"> * @stream_index: stream to use (-1 for cancelling the allocation)</span>
<span class="cm"> * @mas: mas bitmap to use</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__hwahc_op_bwa_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span><span class="p">,</span> <span class="n">s8</span> <span class="n">stream_index</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">uwb_mas_bm</span> <span class="o">*</span><span class="n">mas</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wahc</span> <span class="o">*</span><span class="n">wa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mas_le</span><span class="p">[</span><span class="n">UWB_NUM_MAS</span><span class="o">/</span><span class="mi">8</span><span class="p">];</span>

	<span class="cm">/* Set the stream index */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">WUSB_REQ_SET_STREAM_IDX</span><span class="p">,</span>
			<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			<span class="n">stream_index</span><span class="p">,</span>
			<span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span> <span class="cm">/* FIXME: arbitrary */</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot set WUSB stream index: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">uwb_mas_bm_copy_le</span><span class="p">(</span><span class="n">mas_le</span><span class="p">,</span> <span class="n">mas</span><span class="p">);</span>
	<span class="cm">/* Set the MAS allocation */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">WUSB_REQ_SET_WUSB_MAS</span><span class="p">,</span>
			<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span>
			<span class="n">mas_le</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1000</span> <span class="cm">/* FIXME: arbitrary */</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot set WUSB MAS allocation: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add an IE to the host&#39;s MMC</span>
<span class="cm"> *</span>
<span class="cm"> * @interval:    See WUSB1.0[8.5.3.1]</span>
<span class="cm"> * @repeat_cnt:  See WUSB1.0[8.5.3.1]</span>
<span class="cm"> * @handle:      See WUSB1.0[8.5.3.1]</span>
<span class="cm"> * @wuie:        Pointer to the header of the WUSB IE data to add.</span>
<span class="cm"> *               MUST BE allocated in a kmalloc buffer (no stack or</span>
<span class="cm"> *               vmalloc).</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: the format of the WUSB IEs for MMCs are different to the</span>
<span class="cm"> *       normal MBOA MAC IEs (IE Id + Length in MBOA MAC vs. Length +</span>
<span class="cm"> *       Id in WUSB IEs). Standards...you gotta love&#39;em.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__hwahc_op_mmcie_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">interval</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">repeat_cnt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">handle</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">wuie_hdr</span> <span class="o">*</span><span class="n">wuie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wahc</span> <span class="o">*</span><span class="n">wa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iface_no</span> <span class="o">=</span> <span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">WUSB_REQ_ADD_MMC_IE</span><span class="p">,</span>
			<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			<span class="n">interval</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">repeat_cnt</span><span class="p">,</span>
			<span class="n">handle</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">iface_no</span><span class="p">,</span>
			<span class="n">wuie</span><span class="p">,</span> <span class="n">wuie</span><span class="o">-&gt;</span><span class="n">bLength</span><span class="p">,</span> <span class="mi">1000</span> <span class="cm">/* FIXME: arbitrary */</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove an IE to the host&#39;s MMC</span>
<span class="cm"> *</span>
<span class="cm"> * @handle:      See WUSB1.0[8.5.3.1]</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__hwahc_op_mmcie_rm</span><span class="p">(</span><span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wahc</span> <span class="o">*</span><span class="n">wa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iface_no</span> <span class="o">=</span> <span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">WUSB_REQ_REMOVE_MMC_IE</span><span class="p">,</span>
			<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">handle</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">iface_no</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span> <span class="cm">/* FIXME: arbitrary */</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update device information for a given fake port</span>
<span class="cm"> *</span>
<span class="cm"> * @port_idx: Fake port to which device is connected (wusbhc index, not</span>
<span class="cm"> *            USB port number).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__hwahc_op_dev_info_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">wusb_dev</span> <span class="o">*</span><span class="n">wusb_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wahc</span> <span class="o">*</span><span class="n">wa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iface_no</span> <span class="o">=</span> <span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwa_dev_info</span> <span class="o">*</span><span class="n">dev_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* fill out the Device Info buffer and send it */</span>
	<span class="n">dev_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwa_dev_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">uwb_mas_bm_copy_le</span><span class="p">(</span><span class="n">dev_info</span><span class="o">-&gt;</span><span class="n">bmDeviceAvailability</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">wusb_dev</span><span class="o">-&gt;</span><span class="n">availability</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="o">-&gt;</span><span class="n">bDeviceAddress</span> <span class="o">=</span> <span class="n">wusb_dev</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the descriptors haven&#39;t been read yet, use a default PHY</span>
<span class="cm">	 * rate of 53.3 Mbit/s only.  The correct value will be used</span>
<span class="cm">	 * when this will be called again as part of the</span>
<span class="cm">	 * authentication process (which occurs after the descriptors</span>
<span class="cm">	 * have been read).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wusb_dev</span><span class="o">-&gt;</span><span class="n">wusb_cap_descr</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="o">-&gt;</span><span class="n">wPHYRates</span> <span class="o">=</span> <span class="n">wusb_dev</span><span class="o">-&gt;</span><span class="n">wusb_cap_descr</span><span class="o">-&gt;</span><span class="n">wPHYRates</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_info</span><span class="o">-&gt;</span><span class="n">wPHYRates</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">USB_WIRELESS_PHY_53</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">WUSB_REQ_SET_DEV_INFO</span><span class="p">,</span>
			<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">wusb_dev</span><span class="o">-&gt;</span><span class="n">port_idx</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">iface_no</span><span class="p">,</span>
			<span class="n">dev_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwa_dev_info</span><span class="p">),</span>
			<span class="mi">1000</span> <span class="cm">/* FIXME: arbitrary */</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set host&#39;s idea of which encryption (and key) method to use when</span>
<span class="cm"> * talking to ad evice on a given port.</span>
<span class="cm"> *</span>
<span class="cm"> * If key is NULL, it means disable encryption for that &quot;virtual port&quot;</span>
<span class="cm"> * (used when we disconnect).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__hwahc_dev_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tkid</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_size</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="n">key_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wahc</span> <span class="o">*</span><span class="n">wa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iface_no</span> <span class="o">=</span> <span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_key_descriptor</span> <span class="o">*</span><span class="n">keyd</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">keyd_len</span><span class="p">;</span>

	<span class="n">keyd_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">keyd</span><span class="p">)</span> <span class="o">+</span> <span class="n">key_size</span><span class="p">;</span>
	<span class="n">keyd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">keyd_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">keyd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">keyd</span><span class="o">-&gt;</span><span class="n">bLength</span> <span class="o">=</span> <span class="n">keyd_len</span><span class="p">;</span>
	<span class="n">keyd</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_KEY</span><span class="p">;</span>
	<span class="n">keyd</span><span class="o">-&gt;</span><span class="n">tTKID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tkid</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">keyd</span><span class="o">-&gt;</span><span class="n">tTKID</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tkid</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">keyd</span><span class="o">-&gt;</span><span class="n">tTKID</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tkid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">keyd</span><span class="o">-&gt;</span><span class="n">bKeyData</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_size</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">USB_REQ_SET_DESCRIPTOR</span><span class="p">,</span>
			<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			<span class="n">USB_DT_KEY</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">key_idx</span><span class="p">,</span>
			<span class="n">port_idx</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">iface_no</span><span class="p">,</span>
			<span class="n">keyd</span><span class="p">,</span> <span class="n">keyd_len</span><span class="p">,</span> <span class="mi">1000</span> <span class="cm">/* FIXME: arbitrary */</span><span class="p">);</span>

	<span class="n">kzfree</span><span class="p">(</span><span class="n">keyd</span><span class="p">);</span> <span class="cm">/* clear keys etc. */</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set host&#39;s idea of which encryption (and key) method to use when</span>
<span class="cm"> * talking to ad evice on a given port.</span>
<span class="cm"> *</span>
<span class="cm"> * If key is NULL, it means disable encryption for that &quot;virtual port&quot;</span>
<span class="cm"> * (used when we disconnect).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__hwahc_op_set_ptk</span><span class="p">(</span><span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tkid</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wahc</span> <span class="o">*</span><span class="n">wa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iface_no</span> <span class="o">=</span> <span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">encryption_value</span><span class="p">;</span>

	<span class="cm">/* Tell the host which key to use to talk to the device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">key_idx</span> <span class="o">=</span> <span class="n">wusb_key_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">WUSB_KEY_INDEX_TYPE_PTK</span><span class="p">,</span>
					    <span class="n">WUSB_KEY_INDEX_ORIGINATOR_HOST</span><span class="p">);</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">__hwahc_dev_set_key</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="n">port_idx</span><span class="p">,</span> <span class="n">tkid</span><span class="p">,</span>
					     <span class="n">key</span><span class="p">,</span> <span class="n">key_size</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_set_key</span><span class="p">;</span>
		<span class="n">encryption_value</span> <span class="o">=</span> <span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">ccm1_etd</span><span class="o">-&gt;</span><span class="n">bEncryptionValue</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* FIXME: this should come from wusbhc-&gt;etd[UNSECURE].value */</span>
		<span class="n">encryption_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the encryption type for communicating with the device */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">USB_REQ_SET_ENCRYPTION</span><span class="p">,</span>
			<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			<span class="n">encryption_value</span><span class="p">,</span> <span class="n">port_idx</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">iface_no</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span> <span class="cm">/* FIXME: arbitrary */</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t set host&#39;s WUSB encryption for &quot;</span>
			<span class="s">&quot;port index %u to %s (value %d): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port_idx</span><span class="p">,</span>
			<span class="n">wusb_et_name</span><span class="p">(</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">ccm1_etd</span><span class="o">-&gt;</span><span class="n">bEncryptionType</span><span class="p">),</span>
			<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">ccm1_etd</span><span class="o">-&gt;</span><span class="n">bEncryptionValue</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="nl">error_set_key:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set host&#39;s GTK key</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__hwahc_op_set_gtk</span><span class="p">(</span><span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tkid</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">key_idx</span> <span class="o">=</span> <span class="n">wusb_key_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">WUSB_KEY_INDEX_TYPE_GTK</span><span class="p">,</span>
				    <span class="n">WUSB_KEY_INDEX_ORIGINATOR_HOST</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">__hwahc_dev_set_key</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tkid</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_size</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the Wire Adapter class-specific descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: this descriptor comes with the big bundled configuration</span>
<span class="cm"> *       descriptor that includes the interfaces&#39; and endpoints&#39;, so</span>
<span class="cm"> *       we just look for it in the cached copy kept by the USB stack.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE2: We convert LE fields to CPU order.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wa_fill_descr</span><span class="p">(</span><span class="k">struct</span> <span class="n">wahc</span> <span class="o">*</span><span class="n">wa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_wa_descriptor</span> <span class="o">*</span><span class="n">wa_descr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">itr_size</span><span class="p">,</span> <span class="n">actconfig_idx</span><span class="p">;</span>

	<span class="n">actconfig_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">actconfig</span> <span class="o">-</span> <span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span> <span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">itr</span> <span class="o">=</span> <span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">rawdescriptors</span><span class="p">[</span><span class="n">actconfig_idx</span><span class="p">];</span>
	<span class="n">itr_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wTotalLength</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">itr_size</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_descriptor_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">itr</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Extra device descriptor: &quot;</span>
			<span class="s">&quot;type %02x/%u bytes @ %zu (%zu left)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bLength</span><span class="p">,</span>
			<span class="p">(</span><span class="n">itr</span> <span class="o">-</span> <span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">rawdescriptors</span><span class="p">[</span><span class="n">actconfig_idx</span><span class="p">]),</span>
			<span class="n">itr_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">==</span> <span class="n">USB_DT_WIRE_ADAPTER</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="n">itr</span> <span class="o">+=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bLength</span><span class="p">;</span>
		<span class="n">itr_size</span> <span class="o">-=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bLength</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot find Wire Adapter Class descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="nl">found:</span>
	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bLength</span> <span class="o">&gt;</span> <span class="n">itr_size</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* is it available? */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;incomplete Wire Adapter Class descriptor &quot;</span>
			<span class="s">&quot;(%zu bytes left, %u needed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">itr_size</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bLength</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bLength</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">wa_descr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;short Wire Adapter Class descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wa</span><span class="o">-&gt;</span><span class="n">wa_descr</span> <span class="o">=</span> <span class="n">wa_descr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_wa_descriptor</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="cm">/* Make LE fields CPU order */</span>
	<span class="n">wa_descr</span><span class="o">-&gt;</span><span class="n">bcdWAVersion</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">wa_descr</span><span class="o">-&gt;</span><span class="n">bcdWAVersion</span><span class="p">);</span>
	<span class="n">wa_descr</span><span class="o">-&gt;</span><span class="n">wNumRPipes</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">wa_descr</span><span class="o">-&gt;</span><span class="n">wNumRPipes</span><span class="p">);</span>
	<span class="n">wa_descr</span><span class="o">-&gt;</span><span class="n">wRPipeMaxBlock</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">wa_descr</span><span class="o">-&gt;</span><span class="n">wRPipeMaxBlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wa_descr</span><span class="o">-&gt;</span><span class="n">bcdWAVersion</span> <span class="o">&gt;</span> <span class="mh">0x0100</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Wire Adapter v%d.%d newer than groked v1.0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">wa_descr</span><span class="o">-&gt;</span><span class="n">bcdWAVersion</span> <span class="o">&amp;</span> <span class="mh">0xff00</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
			 <span class="n">wa_descr</span><span class="o">-&gt;</span><span class="n">bcdWAVersion</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hc_driver</span> <span class="n">hwahc_hc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="s">&quot;hwa-hcd&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">product_desc</span> <span class="o">=</span> <span class="s">&quot;Wireless USB HWA host controller&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hcd_priv_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwahc</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span><span class="p">),</span>
	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* FIXME */</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">HCD_USB2</span><span class="p">,</span>		<span class="cm">/* FIXME */</span>
	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">hwahc_op_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">hwahc_op_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">hwahc_op_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frame_number</span> <span class="o">=</span> <span class="n">hwahc_op_get_frame_number</span><span class="p">,</span>
	<span class="p">.</span><span class="n">urb_enqueue</span> <span class="o">=</span> <span class="n">hwahc_op_urb_enqueue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">urb_dequeue</span> <span class="o">=</span> <span class="n">hwahc_op_urb_dequeue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">endpoint_disable</span> <span class="o">=</span> <span class="n">hwahc_op_endpoint_disable</span><span class="p">,</span>

	<span class="p">.</span><span class="n">hub_status_data</span> <span class="o">=</span> <span class="n">wusbhc_rh_status_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hub_control</span> <span class="o">=</span> <span class="n">wusbhc_rh_control</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_suspend</span> <span class="o">=</span> <span class="n">wusbhc_rh_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_resume</span> <span class="o">=</span> <span class="n">wusbhc_rh_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_port_reset</span> <span class="o">=</span> <span class="n">wusbhc_rh_start_port_reset</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hwahc_security_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wusbhc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">.</span><span class="n">usb_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_security_descriptor</span> <span class="o">*</span><span class="n">secd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_encryption_descriptor</span> <span class="o">*</span><span class="n">etd</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">itr</span><span class="p">,</span> <span class="o">*</span><span class="n">top</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">itr_size</span><span class="p">,</span> <span class="n">needed</span><span class="p">,</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="cm">/* Find the host&#39;s security descriptors in the config descr bundle */</span>
	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">actconfig</span> <span class="o">-</span> <span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span> <span class="o">/</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">itr</span> <span class="o">=</span> <span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">rawdescriptors</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">itr_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wTotalLength</span><span class="p">);</span>
	<span class="n">top</span> <span class="o">=</span> <span class="n">itr</span> <span class="o">+</span> <span class="n">itr_size</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">__usb_get_extra_descriptor</span><span class="p">(</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">rawdescriptors</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wTotalLength</span><span class="p">),</span>
			<span class="n">USB_DT_SECURITY</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">secd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BUG? WUSB host has no security descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">needed</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">secd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">top</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">secd</span> <span class="o">&lt;</span> <span class="n">needed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BUG? Not enough data to process security &quot;</span>
			<span class="s">&quot;descriptor header (%zu bytes left vs %zu needed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">top</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">secd</span><span class="p">,</span> <span class="n">needed</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">needed</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">secd</span><span class="o">-&gt;</span><span class="n">wTotalLength</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">top</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">secd</span> <span class="o">&lt;</span> <span class="n">needed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BUG? Not enough data to process security &quot;</span>
			<span class="s">&quot;descriptors (%zu bytes left vs %zu needed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">top</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">secd</span><span class="p">,</span> <span class="n">needed</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Walk over the sec descriptors and store CCM1&#39;s on wusbhc */</span>
	<span class="n">itr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">secd</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">secd</span><span class="p">);</span>
	<span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">secd</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">secd</span><span class="o">-&gt;</span><span class="n">wTotalLength</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">itr</span> <span class="o">&lt;</span> <span class="n">top</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">etd</span> <span class="o">=</span> <span class="n">itr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">top</span> <span class="o">-</span> <span class="n">itr</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">etd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BUG: bad host security descriptor; &quot;</span>
				<span class="s">&quot;not enough data (%zu vs %zu left)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">top</span> <span class="o">-</span> <span class="n">itr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">etd</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">etd</span><span class="o">-&gt;</span><span class="n">bLength</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">etd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BUG: bad host encryption descriptor; &quot;</span>
				<span class="s">&quot;descriptor is too short &quot;</span>
				<span class="s">&quot;(%zu vs %zu needed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">etd</span><span class="o">-&gt;</span><span class="n">bLength</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">etd</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">itr</span> <span class="o">+=</span> <span class="n">etd</span><span class="o">-&gt;</span><span class="n">bLength</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">bytes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="n">bytes</span><span class="p">,</span>
				  <span class="s">&quot;%s (0x%02x) &quot;</span><span class="p">,</span>
				  <span class="n">wusb_et_name</span><span class="p">(</span><span class="n">etd</span><span class="o">-&gt;</span><span class="n">bEncryptionType</span><span class="p">),</span>
				  <span class="n">etd</span><span class="o">-&gt;</span><span class="n">bEncryptionValue</span><span class="p">);</span>
		<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">ccm1_etd</span> <span class="o">=</span> <span class="n">etd</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;supported encryption types: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">ccm1_etd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;E: host doesn&#39;t support CCM-1 crypto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Pretty print what we support */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwahc_security_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* nothing to do here so far... */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hwahc_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wusbhc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wahc</span> <span class="o">*</span><span class="n">wa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

	<span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">usb_get_dev</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">);</span>	<span class="cm">/* bind the USB device */</span>
	<span class="n">wa</span><span class="o">-&gt;</span><span class="n">usb_iface</span> <span class="o">=</span> <span class="n">usb_get_intf</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
	<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">uwb_rc</span> <span class="o">=</span> <span class="n">uwb_rc_get_by_grandpa</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">uwb_rc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot get associated UWB Host Controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_rc_get</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">wa_fill_descr</span><span class="p">(</span><span class="n">wa</span><span class="p">);</span>	<span class="cm">/* Get the device descriptor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_fill_descriptor</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wa</span><span class="o">-&gt;</span><span class="n">wa_descr</span><span class="o">-&gt;</span><span class="n">bNumPorts</span> <span class="o">&gt;</span> <span class="n">USB_MAXCHILDREN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FIXME: USB_MAXCHILDREN too low for WUSB &quot;</span>
			<span class="s">&quot;adapter (%u ports)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wa</span><span class="o">-&gt;</span><span class="n">wa_descr</span><span class="o">-&gt;</span><span class="n">bNumPorts</span><span class="p">);</span>
		<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">ports_max</span> <span class="o">=</span> <span class="n">USB_MAXCHILDREN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">ports_max</span> <span class="o">=</span> <span class="n">wa</span><span class="o">-&gt;</span><span class="n">wa_descr</span><span class="o">-&gt;</span><span class="n">bNumPorts</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">mmcies_max</span> <span class="o">=</span> <span class="n">wa</span><span class="o">-&gt;</span><span class="n">wa_descr</span><span class="o">-&gt;</span><span class="n">bNumMMCIEs</span><span class="p">;</span>
	<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">__hwahc_op_wusbhc_start</span><span class="p">;</span>
	<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="n">__hwahc_op_wusbhc_stop</span><span class="p">;</span>
	<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">mmcie_add</span> <span class="o">=</span> <span class="n">__hwahc_op_mmcie_add</span><span class="p">;</span>
	<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">mmcie_rm</span> <span class="o">=</span> <span class="n">__hwahc_op_mmcie_rm</span><span class="p">;</span>
	<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">dev_info_set</span> <span class="o">=</span> <span class="n">__hwahc_op_dev_info_set</span><span class="p">;</span>
	<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">bwa_set</span> <span class="o">=</span> <span class="n">__hwahc_op_bwa_set</span><span class="p">;</span>
	<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">set_num_dnts</span> <span class="o">=</span> <span class="n">__hwahc_op_set_num_dnts</span><span class="p">;</span>
	<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">set_ptk</span> <span class="o">=</span> <span class="n">__hwahc_op_set_ptk</span><span class="p">;</span>
	<span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">set_gtk</span> <span class="o">=</span> <span class="n">__hwahc_op_set_gtk</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hwahc_security_create</span><span class="p">(</span><span class="n">hwahc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t initialize security: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_security_create</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wa</span><span class="o">-&gt;</span><span class="n">wusb</span> <span class="o">=</span> <span class="n">wusbhc</span><span class="p">;</span>	<span class="cm">/* FIXME: ugly, need to fix */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">wusbhc_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wusbhc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t create WUSB HC structures: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_wusbhc_create</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">wa_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">,</span> <span class="n">iface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_wa_create</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_wa_create:</span>
	<span class="n">wusbhc_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wusbhc</span><span class="p">);</span>
<span class="nl">error_wusbhc_create:</span>
	<span class="cm">/* WA Descr fill allocs no resources */</span>
<span class="nl">error_security_create:</span>
<span class="nl">error_fill_descriptor:</span>
	<span class="n">uwb_rc_put</span><span class="p">(</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">uwb_rc</span><span class="p">);</span>
<span class="nl">error_rc_get:</span>
	<span class="n">usb_put_intf</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwahc_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wusbhc</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">__wa_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">);</span>
	<span class="n">wusbhc_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wusbhc</span><span class="p">);</span>
	<span class="n">hwahc_security_release</span><span class="p">(</span><span class="n">hwahc</span><span class="p">);</span>
	<span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wusbhc</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">uwb_rc_put</span><span class="p">(</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">uwb_rc</span><span class="p">);</span>
	<span class="n">usb_put_intf</span><span class="p">(</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">.</span><span class="n">usb_iface</span><span class="p">);</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">.</span><span class="n">usb_dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wusbhc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwahc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wa_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hwahc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">usb_iface</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">usb_hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">usb_hcd</span> <span class="o">=</span> <span class="n">usb_create_hcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc_hc_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usb_iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wusb-hwa&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_hcd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to allocate instance</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_alloc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usb_hcd</span><span class="o">-&gt;</span><span class="n">wireless</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wusbhc</span> <span class="o">=</span> <span class="n">usb_hcd_to_wusbhc</span><span class="p">(</span><span class="n">usb_hcd</span><span class="p">);</span>
	<span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>
	<span class="n">hwahc_init</span><span class="p">(</span><span class="n">hwahc</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hwahc_create</span><span class="p">(</span><span class="n">hwahc</span><span class="p">,</span> <span class="n">usb_iface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot initialize internals: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_hwahc_create</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_add_hcd</span><span class="p">(</span><span class="n">usb_hcd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot add HCD: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_add_hcd</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">wusbhc_b_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wusbhc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot setup phase B of WUSBHC: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_wusbhc_b_create</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_wusbhc_b_create:</span>
	<span class="n">usb_remove_hcd</span><span class="p">(</span><span class="n">usb_hcd</span><span class="p">);</span>
<span class="nl">error_add_hcd:</span>
	<span class="n">hwahc_destroy</span><span class="p">(</span><span class="n">hwahc</span><span class="p">);</span>
<span class="nl">error_hwahc_create:</span>
	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">usb_hcd</span><span class="p">);</span>
<span class="nl">error_alloc:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwahc_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">usb_iface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">usb_hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wusbhc</span> <span class="o">*</span><span class="n">wusbhc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwahc</span> <span class="o">*</span><span class="n">hwahc</span><span class="p">;</span>

	<span class="n">usb_hcd</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">usb_iface</span><span class="p">);</span>
	<span class="n">wusbhc</span> <span class="o">=</span> <span class="n">usb_hcd_to_wusbhc</span><span class="p">(</span><span class="n">usb_hcd</span><span class="p">);</span>
	<span class="n">hwahc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wusbhc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwahc</span><span class="p">,</span> <span class="n">wusbhc</span><span class="p">);</span>

	<span class="n">wusbhc_b_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwahc</span><span class="o">-&gt;</span><span class="n">wusbhc</span><span class="p">);</span>
	<span class="n">usb_remove_hcd</span><span class="p">(</span><span class="n">usb_hcd</span><span class="p">);</span>
	<span class="n">hwahc_destroy</span><span class="p">(</span><span class="n">hwahc</span><span class="p">);</span>
	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">usb_hcd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">hwahc_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* FIXME: use class labels for this */</span>
	<span class="p">{</span> <span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">),</span> <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">hwahc_id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">hwahc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;hwa-hc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">hwahc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span>	<span class="n">hwahc_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">hwahc_id_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">hwahc_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Inaky Perez-Gonzalez &lt;inaky.perez-gonzalez@intel.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Host Wired Adapter USB Host Control Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
