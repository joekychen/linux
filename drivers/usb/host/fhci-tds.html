<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › host › fhci-tds.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fhci-tds.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Freescale QUICC Engine USB Host Controller Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) Freescale Semicondutor, Inc. 2006.</span>
<span class="cm"> *               Shlomi Gridish &lt;gridish@freescale.com&gt;</span>
<span class="cm"> *               Jerry Huang &lt;Chang-Ming.Huang@freescale.com&gt;</span>
<span class="cm"> * Copyright (c) Logic Product Development, Inc. 2007</span>
<span class="cm"> *               Peter Barada &lt;peterb@logicpd.com&gt;</span>
<span class="cm"> * Copyright (c) MontaVista Software, Inc. 2008.</span>
<span class="cm"> *               Anton Vorontsov &lt;avorontsov@ru.mvista.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> * under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> * Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/hcd.h&gt;</span>
<span class="cp">#include &quot;fhci.h&quot;</span>

<span class="cp">#define DUMMY_BD_BUFFER  0xdeadbeef</span>
<span class="cp">#define DUMMY2_BD_BUFFER 0xbaadf00d</span>

<span class="cm">/* Transaction Descriptors bits */</span>
<span class="cp">#define TD_R		0x8000 </span><span class="cm">/* ready bit */</span><span class="cp"></span>
<span class="cp">#define TD_W		0x2000 </span><span class="cm">/* wrap bit */</span><span class="cp"></span>
<span class="cp">#define TD_I		0x1000 </span><span class="cm">/* interrupt on completion */</span><span class="cp"></span>
<span class="cp">#define TD_L		0x0800 </span><span class="cm">/* last */</span><span class="cp"></span>
<span class="cp">#define TD_TC		0x0400 </span><span class="cm">/* transmit CRC */</span><span class="cp"></span>
<span class="cp">#define TD_CNF		0x0200 </span><span class="cm">/* CNF - Must be always 1 */</span><span class="cp"></span>
<span class="cp">#define TD_LSP		0x0100 </span><span class="cm">/* Low-speed transaction */</span><span class="cp"></span>
<span class="cp">#define TD_PID		0x00c0 </span><span class="cm">/* packet id */</span><span class="cp"></span>
<span class="cp">#define TD_RXER		0x0020 </span><span class="cm">/* Rx error or not */</span><span class="cp"></span>

<span class="cp">#define TD_NAK		0x0010 </span><span class="cm">/* No ack. */</span><span class="cp"></span>
<span class="cp">#define TD_STAL		0x0008 </span><span class="cm">/* Stall received */</span><span class="cp"></span>
<span class="cp">#define TD_TO		0x0004 </span><span class="cm">/* time out */</span><span class="cp"></span>
<span class="cp">#define TD_UN		0x0002 </span><span class="cm">/* underrun */</span><span class="cp"></span>
<span class="cp">#define TD_NO		0x0010 </span><span class="cm">/* Rx Non Octet Aligned Packet */</span><span class="cp"></span>
<span class="cp">#define TD_AB		0x0008 </span><span class="cm">/* Frame Aborted */</span><span class="cp"></span>
<span class="cp">#define TD_CR		0x0004 </span><span class="cm">/* CRC Error */</span><span class="cp"></span>
<span class="cp">#define TD_OV		0x0002 </span><span class="cm">/* Overrun */</span><span class="cp"></span>
<span class="cp">#define TD_BOV		0x0001 </span><span class="cm">/* Buffer Overrun */</span><span class="cp"></span>

<span class="cp">#define TD_ERRORS	(TD_NAK | TD_STAL | TD_TO | TD_UN | \</span>
<span class="cp">			 TD_NO | TD_AB | TD_CR | TD_OV | TD_BOV)</span>

<span class="cp">#define TD_PID_DATA0	0x0080 </span><span class="cm">/* Data 0 toggle */</span><span class="cp"></span>
<span class="cp">#define TD_PID_DATA1	0x00c0 </span><span class="cm">/* Data 1 toggle */</span><span class="cp"></span>
<span class="cp">#define TD_PID_TOGGLE	0x00c0 </span><span class="cm">/* Data 0/1 toggle mask */</span><span class="cp"></span>

<span class="cp">#define TD_TOK_SETUP	0x0000</span>
<span class="cp">#define TD_TOK_OUT	0x4000</span>
<span class="cp">#define TD_TOK_IN	0x8000</span>
<span class="cp">#define TD_ISO		0x1000</span>
<span class="cp">#define TD_ENDP		0x0780</span>
<span class="cp">#define TD_ADDR		0x007f</span>

<span class="cp">#define TD_ENDP_SHIFT 7</span>

<span class="k">struct</span> <span class="n">usb_td</span> <span class="p">{</span>
	<span class="n">__be16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">buf_ptr</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">extra</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">reserved</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_td</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">next_bd</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_td</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">usb_td</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">td</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TD_W</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">base</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">++</span><span class="n">td</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fhci_push_dummy_bd</span><span class="p">(</span><span class="k">struct</span> <span class="n">endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">already_pushed_dummy_bd</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">td_status</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">,</span> <span class="n">DUMMY_BD_BUFFER</span><span class="p">);</span>
		<span class="cm">/* get the next TD in the ring */</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_td</span> <span class="o">=</span> <span class="n">next_bd</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_td</span><span class="p">,</span> <span class="n">td_status</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">already_pushed_dummy_bd</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* destroy an USB endpoint */</span>
<span class="kt">void</span> <span class="nf">fhci_ep0_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">fhci_usb</span> <span class="o">*</span><span class="n">usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">usb</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">)</span>
			<span class="n">cpm_muram_free</span><span class="p">(</span><span class="n">cpm_muram_offset</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_initialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_frame_Q</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">cq_howmany</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_frame_Q</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">size</span><span class="p">;</span> <span class="n">size</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">packet</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">cq_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_frame_Q</span><span class="p">);</span>

				<span class="n">kfree</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">cq_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_frame_Q</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_initialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_frame_Q</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">cq_howmany</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_frame_Q</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">size</span><span class="p">;</span> <span class="n">size</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">packet</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">cq_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_frame_Q</span><span class="p">);</span>

				<span class="n">kfree</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">cq_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_frame_Q</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_initialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dummy_packets_Q</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">cq_howmany</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dummy_packets_Q</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">size</span><span class="p">;</span> <span class="n">size</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="n">cq_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dummy_packets_Q</span><span class="p">);</span>

				<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">cq_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dummy_packets_Q</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">usb</span><span class="o">-&gt;</span><span class="n">ep0</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create the endpoint structure</span>
<span class="cm"> *</span>
<span class="cm"> * arguments:</span>
<span class="cm"> * usb		A pointer to the data structure of the USB</span>
<span class="cm"> * data_mem	The data memory partition(BUS)</span>
<span class="cm"> * ring_len	TD ring length</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">fhci_create_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">fhci_usb</span> <span class="o">*</span><span class="n">usb</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fhci_mem_alloc</span> <span class="n">data_mem</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">ring_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_td</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ep_offset</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">err_for</span> <span class="o">=</span> <span class="s">&quot;endpoint PRAM&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ep_mem_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* we need at least 3 TDs in the ring */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ring_len</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fhci_err</span><span class="p">(</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">fhci</span><span class="p">,</span> <span class="s">&quot;illegal TD ring length parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ep</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ep_mem_size</span> <span class="o">=</span> <span class="n">ring_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">td</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fhci_ep_pram</span><span class="p">);</span>
	<span class="n">ep_offset</span> <span class="o">=</span> <span class="n">cpm_muram_alloc</span><span class="p">(</span><span class="n">ep_mem_size</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">ep_offset</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span> <span class="o">=</span> <span class="n">cpm_muram_addr</span><span class="p">(</span><span class="n">ep_offset</span><span class="p">);</span>

	<span class="cm">/* zero all queue pointers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cq_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_frame_Q</span><span class="p">,</span> <span class="n">ring_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">cq_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_frame_Q</span><span class="p">,</span> <span class="n">ring_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">cq_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dummy_packets_Q</span><span class="p">,</span> <span class="n">ring_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err_for</span> <span class="o">=</span> <span class="s">&quot;frame_queues&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ring_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buff</span><span class="p">;</span>

		<span class="n">pkt</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pkt</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err_for</span> <span class="o">=</span> <span class="s">&quot;frame&quot;</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1028</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">buff</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
			<span class="n">err_for</span> <span class="o">=</span> <span class="s">&quot;buffer&quot;</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cq_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_frame_Q</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="n">cq_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dummy_packets_Q</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* we put the endpoint parameter RAM right behind the TD ring */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">td</span><span class="p">)</span> <span class="o">*</span> <span class="n">ring_len</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_td</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_td</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">already_pushed_dummy_bd</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* initialize tds */</span>
	<span class="n">td</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ring_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">td</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">td</span><span class="o">--</span><span class="p">;</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">TD_W</span><span class="p">);</span> <span class="cm">/* for last TD set Wrap bit */</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* endpoint structure has been created */</span>
	<span class="n">usb</span><span class="o">-&gt;</span><span class="n">ep0</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">fhci_ep0_free</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">fhci_err</span><span class="p">(</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">fhci</span><span class="p">,</span> <span class="s">&quot;no memory for the %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_for</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialize the endpoint register according to the given parameters</span>
<span class="cm"> *</span>
<span class="cm"> * artuments:</span>
<span class="cm"> * usb		A pointer to the data strucutre of the USB</span>
<span class="cm"> * ep		A pointer to the endpoint structre</span>
<span class="cm"> * data_mem	The data memory partition(BUS)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fhci_init_ep_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">fhci_usb</span> <span class="o">*</span><span class="n">usb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">fhci_mem_alloc</span> <span class="n">data_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rt</span><span class="p">;</span>

	<span class="cm">/* set the endpoint registers according to the endpoint */</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">fhci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">usb_ep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		 <span class="n">USB_TRANS_CTR</span> <span class="o">|</span> <span class="n">USB_EP_MF</span> <span class="o">|</span> <span class="n">USB_EP_RTE</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">fhci</span><span class="o">-&gt;</span><span class="n">pram</span><span class="o">-&gt;</span><span class="n">ep_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		 <span class="n">cpm_muram_offset</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="p">));</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="n">BUS_MODE_BO_BE</span> <span class="o">|</span> <span class="n">BUS_MODE_GBL</span><span class="p">);</span>
<span class="cp">#ifdef MULTI_DATA_BUS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_mem</span> <span class="o">==</span> <span class="n">MEM_SECONDARY</span><span class="p">)</span>
		<span class="n">rt</span> <span class="o">|=</span> <span class="n">BUS_MODE_DTB</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">rx_func_code</span><span class="p">,</span> <span class="n">rt</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">tx_func_code</span><span class="p">,</span> <span class="n">rt</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">rx_buff_len</span><span class="p">,</span> <span class="mi">1028</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">rx_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">tx_base</span><span class="p">,</span> <span class="n">cpm_muram_offset</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">));</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">rx_bd_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">tx_bd_ptr</span><span class="p">,</span> <span class="n">cpm_muram_offset</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">));</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">tx_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Collect the submitted frames and inform the application about them</span>
<span class="cm"> * It is also preparing the TDs for new frames. If the Tx interrupts</span>
<span class="cm"> * are disabled, the application should call that routine to get</span>
<span class="cm"> * confirmation about the submitted frames. Otherwise, the routine is</span>
<span class="cm"> * called from the interrupt service routine during the Tx interrupt.</span>
<span class="cm"> * In that case the application is informed by calling the application</span>
<span class="cm"> * specific &#39;fhci_transaction_confirm&#39; routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fhci_td_transaction_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">fhci_usb</span> <span class="o">*</span><span class="n">usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">usb</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_td</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">extra_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">td_status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">td_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * collect transmitted BDs from the chip. The routine clears all BDs</span>
<span class="cm">	 * with R bit = 0 and the pointer to data buffer is not NULL, that is</span>
<span class="cm">	 * BDs which point to the transmitted data buffer</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_td</span><span class="p">;</span>
		<span class="n">td_status</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">td_length</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">);</span>
		<span class="n">extra_data</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>

		<span class="cm">/* check if the TD is empty */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_R</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TD_W</span><span class="p">)</span> <span class="o">||</span> <span class="n">buf</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* check if it is a dummy buffer */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">buf</span> <span class="o">==</span> <span class="n">DUMMY_BD_BUFFER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TD_W</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* mark TD as empty */</span>
		<span class="n">clrbits16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="o">~</span><span class="n">TD_W</span><span class="p">);</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* advance the TD pointer */</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_td</span> <span class="o">=</span> <span class="n">next_bd</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_td</span><span class="p">,</span> <span class="n">td_status</span><span class="p">);</span>

		<span class="cm">/* check if it is a dummy buffer(type2) */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buf</span> <span class="o">==</span> <span class="n">DUMMY2_BD_BUFFER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TD_W</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">pkt</span> <span class="o">=</span> <span class="n">cq_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_frame_Q</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="p">)</span>
			<span class="n">fhci_err</span><span class="p">(</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">fhci</span><span class="p">,</span> <span class="s">&quot;no frame to confirm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_ERRORS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_RXER</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_CR</span><span class="p">)</span>
					<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">USB_TD_RX_ER_CRC</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_AB</span><span class="p">)</span>
					<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">USB_TD_RX_ER_BITSTUFF</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_OV</span><span class="p">)</span>
					<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">USB_TD_RX_ER_OVERUN</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_BOV</span><span class="p">)</span>
					<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">USB_TD_RX_DATA_OVERUN</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_NO</span><span class="p">)</span>
					<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">USB_TD_RX_ER_NONOCT</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">fhci_err</span><span class="p">(</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">fhci</span><span class="p">,</span> <span class="s">&quot;illegal error &quot;</span>
						 <span class="s">&quot;occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_NAK</span><span class="p">)</span>
				<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">USB_TD_TX_ER_NAK</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_TO</span><span class="p">)</span>
				<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">USB_TD_TX_ER_TIMEOUT</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_UN</span><span class="p">)</span>
				<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">USB_TD_TX_ER_UNDERUN</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_STAL</span><span class="p">)</span>
				<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">USB_TD_TX_ER_STALL</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fhci_err</span><span class="p">(</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">fhci</span><span class="p">,</span> <span class="s">&quot;illegal error occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">extra_data</span> <span class="o">&amp;</span> <span class="n">TD_TOK_IN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">td_length</span> <span class="o">-</span> <span class="n">CRC_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">USB_TD_RX_DATA_UNDERUN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">extra_data</span> <span class="o">&amp;</span> <span class="n">TD_TOK_IN</span><span class="p">)</span>
			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">td_length</span> <span class="o">-</span> <span class="n">CRC_SIZE</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">&amp;</span> <span class="n">PKT_ZLP</span><span class="p">)</span>
			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">td_length</span><span class="p">;</span>

		<span class="n">fhci_transaction_confirm</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Submitting a data frame to a specified endpoint of a USB device</span>
<span class="cm"> * The frame is put in the driver&#39;s transmit queue for this endpoint</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:</span>
<span class="cm"> * usb          A pointer to the USB structure</span>
<span class="cm"> * pkt          A pointer to the user frame structure</span>
<span class="cm"> * trans_type   Transaction tyep - IN,OUT or SETUP</span>
<span class="cm"> * dest_addr    Device address - 0~127</span>
<span class="cm"> * dest_ep      Endpoint number of the device - 0~16</span>
<span class="cm"> * trans_mode   Pipe type - ISO,Interrupt,bulk or control</span>
<span class="cm"> * dest_speed   USB speed - Low speed or FULL speed</span>
<span class="cm"> * data_toggle  Data sequence toggle - 0 or 1</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">fhci_host_transaction</span><span class="p">(</span><span class="k">struct</span> <span class="n">fhci_usb</span> <span class="o">*</span><span class="n">usb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">fhci_ta_type</span> <span class="n">trans_type</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">dest_addr</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">dest_ep</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">fhci_tf_mode</span> <span class="n">trans_mode</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">fhci_speed</span> <span class="n">dest_speed</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data_toggle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">usb</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_td</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">extra_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">td_status</span><span class="p">;</span>

	<span class="n">fhci_usb_disable_interrupt</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>
	<span class="cm">/* start from the next BD that should be filled */</span>
	<span class="n">td</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_td</span><span class="p">;</span>
	<span class="n">td_status</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_R</span> <span class="o">&amp;&amp;</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* if the TD is not free */</span>
		<span class="n">fhci_usb_enable_interrupt</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get the next TD in the ring */</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_td</span> <span class="o">=</span> <span class="n">next_bd</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_td</span><span class="p">,</span> <span class="n">td_status</span><span class="p">);</span>
	<span class="n">fhci_usb_enable_interrupt</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">priv_data</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">,</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
	<span class="cm">/* sets up transaction parameters - addr,endp,dir,and type */</span>
	<span class="n">extra_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">dest_ep</span> <span class="o">&lt;&lt;</span> <span class="n">TD_ENDP_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">dest_addr</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">trans_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FHCI_TA_IN</span>:
		<span class="n">extra_data</span> <span class="o">|=</span> <span class="n">TD_TOK_IN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FHCI_TA_OUT</span>:
		<span class="n">extra_data</span> <span class="o">|=</span> <span class="n">TD_TOK_OUT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FHCI_TA_SETUP</span>:
		<span class="n">extra_data</span> <span class="o">|=</span> <span class="n">TD_TOK_SETUP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trans_mode</span> <span class="o">==</span> <span class="n">FHCI_TF_ISO</span><span class="p">)</span>
		<span class="n">extra_data</span> <span class="o">|=</span> <span class="n">TD_ISO</span><span class="p">;</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">,</span> <span class="n">extra_data</span><span class="p">);</span>

	<span class="cm">/* sets up the buffer descriptor */</span>
	<span class="n">td_status</span> <span class="o">=</span> <span class="p">((</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_W</span><span class="p">)</span> <span class="o">|</span> <span class="n">TD_R</span> <span class="o">|</span> <span class="n">TD_L</span> <span class="o">|</span> <span class="n">TD_I</span> <span class="o">|</span> <span class="n">TD_CNF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">&amp;</span> <span class="n">PKT_NO_CRC</span><span class="p">))</span>
		<span class="n">td_status</span> <span class="o">|=</span> <span class="n">TD_TC</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">trans_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FHCI_TA_IN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">data_toggle</span><span class="p">)</span>
			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">|=</span> <span class="n">PKT_PID_DATA1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">|=</span> <span class="n">PKT_PID_DATA0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_toggle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">td_status</span> <span class="o">|=</span> <span class="n">TD_PID_DATA1</span><span class="p">;</span>
			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">|=</span> <span class="n">PKT_PID_DATA1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">td_status</span> <span class="o">|=</span> <span class="n">TD_PID_DATA0</span><span class="p">;</span>
			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">|=</span> <span class="n">PKT_PID_DATA0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dest_speed</span> <span class="o">==</span> <span class="n">FHCI_LOW_SPEED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">port_status</span> <span class="o">==</span> <span class="n">FHCI_PORT_FULL</span><span class="p">))</span>
		<span class="n">td_status</span> <span class="o">|=</span> <span class="n">TD_LSP</span><span class="p">;</span>

	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">td_status</span><span class="p">);</span>

	<span class="cm">/* set up buffer length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trans_type</span> <span class="o">==</span> <span class="n">FHCI_TA_IN</span><span class="p">)</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">CRC_SIZE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* put the frame to the confirmation queue */</span>
	<span class="n">cq_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_frame_Q</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cq_howmany</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_frame_Q</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">fhci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">usb_comm</span><span class="p">,</span> <span class="n">USB_CMD_STR_FIFO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reset the Tx BD ring */</span>
<span class="kt">void</span> <span class="nf">fhci_flush_bds</span><span class="p">(</span><span class="k">struct</span> <span class="n">fhci_usb</span> <span class="o">*</span><span class="n">usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">extra_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">td_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_td</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">usb</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">;</span>

	<span class="n">td</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">td_status</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">);</span>
		<span class="n">extra_data</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>

		<span class="cm">/* if the TD is not empty - we&#39;ll confirm it as Timeout */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_R</span><span class="p">)</span>
			<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TD_R</span><span class="p">)</span> <span class="o">|</span> <span class="n">TD_TO</span><span class="p">);</span>
		<span class="cm">/* if this TD is dummy - let&#39;s skip this TD */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">)</span> <span class="o">==</span> <span class="n">DUMMY_BD_BUFFER</span><span class="p">)</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">,</span> <span class="n">DUMMY2_BD_BUFFER</span><span class="p">);</span>
		<span class="cm">/* if this is the last TD - break */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_W</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">td</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fhci_td_transaction_confirm</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>

	<span class="n">td</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">td</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TD_W</span><span class="p">));</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">TD_W</span><span class="p">);</span> <span class="cm">/* for last TD set Wrap bit */</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">tx_bd_ptr</span><span class="p">,</span>
		 <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">tx_base</span><span class="p">));</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">tx_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_td</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_td</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Flush all transmitted packets from TDs in the actual frame.</span>
<span class="cm"> * This routine is called when something wrong with the controller and</span>
<span class="cm"> * we want to get rid of the actual frame and start again next frame</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fhci_flush_actual_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">fhci_usb</span> <span class="o">*</span><span class="n">usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tb_ptr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">extra_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">td_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_td</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">usb</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">;</span>

	<span class="cm">/* disable the USB controller */</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">fhci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">usb_mod</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">fhci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">usb_mod</span><span class="p">,</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">USB_MODE_EN</span><span class="p">);</span>

	<span class="n">tb_ptr</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">tx_bd_ptr</span><span class="p">);</span>
	<span class="n">td</span> <span class="o">=</span> <span class="n">cpm_muram_addr</span><span class="p">(</span><span class="n">tb_ptr</span><span class="p">);</span>
	<span class="n">td_status</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">buf_ptr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">);</span>
	<span class="n">extra_data</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_R</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="p">(</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TD_R</span><span class="p">)</span> <span class="o">|</span> <span class="n">TD_TO</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">already_pushed_dummy_bd</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* advance the TD pointer */</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">next_bd</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">td_status</span><span class="p">);</span>
		<span class="n">td_status</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">buf_ptr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">);</span>
		<span class="n">extra_data</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">td_status</span> <span class="o">&amp;</span> <span class="n">TD_R</span><span class="p">)</span> <span class="o">||</span> <span class="n">buf_ptr</span><span class="p">);</span>

	<span class="n">fhci_td_transaction_confirm</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>

	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">tx_bd_ptr</span><span class="p">,</span>
		 <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">tx_base</span><span class="p">));</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">tx_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">empty_td</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_td</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">;</span>

	<span class="n">usb</span><span class="o">-&gt;</span><span class="n">actual_frame</span><span class="o">-&gt;</span><span class="n">frame_status</span> <span class="o">=</span> <span class="n">FRAME_TIMER_END_TRANSMISSION</span><span class="p">;</span>

	<span class="cm">/* reset the event register */</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">fhci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">usb_event</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="cm">/* enable the USB controller */</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">fhci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">usb_mod</span><span class="p">,</span> <span class="n">mode</span> <span class="o">|</span> <span class="n">USB_MODE_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* handles Tx confirm and Tx error interrupt */</span>
<span class="kt">void</span> <span class="nf">fhci_tx_conf_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">fhci_usb</span> <span class="o">*</span><span class="n">usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fhci_td_transaction_confirm</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Schedule another transaction to this frame only if we have</span>
<span class="cm">	 * already confirmed all transaction in the frame.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">fhci_get_sof_timer_count</span><span class="p">(</span><span class="n">usb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">usb</span><span class="o">-&gt;</span><span class="n">max_frame_usage</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">actual_frame</span><span class="o">-&gt;</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">FRAME_END_TRANSMISSION</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">actual_frame</span><span class="o">-&gt;</span><span class="n">tds_list</span><span class="p">)))</span>
		<span class="n">fhci_schedule_transactions</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fhci_host_transmit_actual_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">fhci_usb</span> <span class="o">*</span><span class="n">usb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tb_ptr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">td_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_td</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">usb</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">;</span>

	<span class="n">tb_ptr</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">tx_bd_ptr</span><span class="p">);</span>
	<span class="n">td</span> <span class="o">=</span> <span class="n">cpm_muram_addr</span><span class="p">(</span><span class="n">tb_ptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">)</span> <span class="o">==</span> <span class="n">DUMMY_BD_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_td</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">old_td</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">already_pushed_dummy_bd</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">td_status</span> <span class="o">=</span> <span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="cm">/* gets the next TD in the ring */</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">next_bd</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">td_status</span><span class="p">);</span>
		<span class="n">tb_ptr</span> <span class="o">=</span> <span class="n">cpm_muram_offset</span><span class="p">(</span><span class="n">td</span><span class="p">);</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_pram_ptr</span><span class="o">-&gt;</span><span class="n">tx_bd_ptr</span><span class="p">,</span> <span class="n">tb_ptr</span><span class="p">);</span>

		<span class="cm">/* start transmit only if we have something in the TDs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TD_R</span><span class="p">)</span>
			<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">fhci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">usb_comm</span><span class="p">,</span> <span class="n">USB_CMD_STR_FIFO</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">)</span> <span class="o">==</span> <span class="n">DUMMY_BD_BUFFER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_td</span> <span class="o">=</span> <span class="n">next_bd</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">td_base</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">conf_td</span><span class="p">,</span>
					      <span class="n">td_status</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_td</span><span class="o">-&gt;</span><span class="n">buf_ptr</span><span class="p">,</span> <span class="n">DUMMY2_BD_BUFFER</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
