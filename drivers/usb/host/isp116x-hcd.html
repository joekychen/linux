<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › host › isp116x-hcd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>isp116x-hcd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ISP116x HCD (Host Controller Driver) for USB.</span>
<span class="cm"> *</span>
<span class="cm"> * Derived from the SL811 HCD, rewritten for ISP116x.</span>
<span class="cm"> * Copyright (C) 2005 Olav Kongas &lt;ok@artecdesign.ee&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Portions:</span>
<span class="cm"> * Copyright (C) 2004 Psion Teklogix (for NetBook PRO)</span>
<span class="cm"> * Copyright (C) 2004 David Brownell</span>
<span class="cm"> *</span>
<span class="cm"> * Periodic scheduling is based on Roman&#39;s OHCI code</span>
<span class="cm"> * Copyright (C) 1999 Roman Weissgaerber</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The driver basically works. A number of people have used it with a range</span>
<span class="cm"> * of devices.</span>
<span class="cm"> *</span>
<span class="cm"> * The driver passes all usbtests 1-14.</span>
<span class="cm"> *</span>
<span class="cm"> * Suspending/resuming of root hub via sysfs works. Remote wakeup works too.</span>
<span class="cm"> * And suspending/resuming of platform device works too. Suspend/resume</span>
<span class="cm"> * via HCD operations vector is not implemented.</span>
<span class="cm"> *</span>
<span class="cm"> * Iso transfer support is not implemented. Adding this would include</span>
<span class="cm"> * implementing recovery from the failure to service the processed ITL</span>
<span class="cm"> * fifo ram in time, which will involve chip reset.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> + More testing of suspend/resume.</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">  ISP116x chips require certain delays between accesses to its</span>
<span class="cm">  registers. The following timing options exist.</span>

<span class="cm">  1. Configure your memory controller (the best)</span>
<span class="cm">  2. Implement platform-specific delay function possibly</span>
<span class="cm">  combined with configuring the memory controller; see</span>
<span class="cm">  include/linux/usb-isp116x.h for more info. Some broken</span>
<span class="cm">  memory controllers line LH7A400 SMC need this. Also,</span>
<span class="cm">  uncomment for that to work the following</span>
<span class="cm">  USE_PLATFORM_DELAY macro.</span>
<span class="cm">  3. Use ndelay (easiest, poorest). For that, uncomment</span>
<span class="cm">  the following USE_NDELAY macro.</span>
<span class="cm">*/</span>
<span class="cp">#define USE_PLATFORM_DELAY</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define USE_NDELAY</h1></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><h1>define DEBUG</h1>

<h1>define VERBOSE</h1></td><td class="code"><div class="highlight"><pre><span class="cm">/* Transfer descriptors. See dump_ptd() for printout format  */</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><h1>define PTD_TRACE</h1></td><td class="code"><div class="highlight"><pre><span class="cm">/* enqueuing/finishing log of urbs */</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><h1>define URB_TRACE</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/isp116x.h&gt;</span>
<span class="cp">#include &lt;linux/usb/hcd.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#include &quot;isp116x.h&quot;</span>

<span class="cp">#define DRIVER_VERSION	&quot;03 Nov 2005&quot;</span>
<span class="cp">#define DRIVER_DESC	&quot;ISP116x USB Host Controller Driver&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">hcd_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;isp116x-hcd&quot;</span><span class="p">;</span>

<span class="cm">/*-----------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm">  Write len bytes to fifo, pad till 32-bit boundary</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_ptddata_to_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">dp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quot</span> <span class="o">=</span> <span class="n">len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* buffer is already in &#39;usb data order&#39;, which is LE. */</span>
	<span class="cm">/* When reading buffer as u16, we have to take care byte order */</span>
	<span class="cm">/* doesn&#39;t get mixed up */</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dp2</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* not aligned */</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w</span> <span class="o">=</span> <span class="o">*</span><span class="n">dp</span><span class="o">++</span><span class="p">;</span>
			<span class="n">w</span> <span class="o">|=</span> <span class="o">*</span><span class="n">dp</span><span class="o">++</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">isp116x_raw_write_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
			<span class="n">isp116x_write_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="n">dp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* aligned */</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Keep byte order ! */</span>
			<span class="n">isp116x_raw_write_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="n">dp2</span><span class="o">++</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
			<span class="n">isp116x_write_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">dp2</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quot</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">quot</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">isp116x_raw_write_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Read len bytes from fifo and then read till 32-bit boundary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_ptddata_from_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">dp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quot</span> <span class="o">=</span> <span class="n">len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* buffer is already in &#39;usb data order&#39;, which is LE. */</span>
	<span class="cm">/* When reading buffer as u16, we have to take care byte order */</span>
	<span class="cm">/* doesn&#39;t get mixed up */</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dp2</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* not aligned */</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w</span> <span class="o">=</span> <span class="n">isp116x_raw_read_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
			<span class="o">*</span><span class="n">dp</span><span class="o">++</span> <span class="o">=</span> <span class="n">w</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dp</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
			<span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">isp116x_read_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* aligned */</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Keep byte order! */</span>
			<span class="o">*</span><span class="n">dp2</span><span class="o">++</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">isp116x_raw_read_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">dp2</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">isp116x_read_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quot</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">quot</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">isp116x_raw_read_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Write ptd&#39;s and data for scheduled transfers into</span>
<span class="cm">  the fifo ram. Fifo must be empty and ready.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pack_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ptd</span> <span class="o">*</span><span class="n">ptd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buflen</span> <span class="o">=</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_last_dir</span> <span class="o">==</span> <span class="n">PTD_DIR_IN</span>
	    <span class="o">?</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_bufshrt</span> <span class="o">:</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_buflen</span><span class="p">;</span>

	<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">,</span> <span class="n">HCuPINT_AIIEOT</span><span class="p">);</span>
	<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCXFERCTR</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">isp116x_write_addr</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCATLPORT</span> <span class="o">|</span> <span class="n">ISP116x_WRITE_OFFSET</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ep</span> <span class="o">=</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_active</span><span class="p">;</span> <span class="n">ep</span><span class="p">;</span> <span class="n">ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd</span><span class="p">;</span>
		<span class="n">dump_ptd</span><span class="p">(</span><span class="n">ptd</span><span class="p">);</span>
		<span class="n">dump_ptd_out_data</span><span class="p">(</span><span class="n">ptd</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">isp116x_write_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">ptd</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">isp116x_write_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">ptd</span><span class="o">-&gt;</span><span class="n">mps</span><span class="p">);</span>
		<span class="n">isp116x_write_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">ptd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">isp116x_write_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">ptd</span><span class="o">-&gt;</span><span class="n">faddr</span><span class="p">);</span>
		<span class="n">buflen</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ptd</span><span class="p">);</span>
		<span class="cm">/* Skip writing data for last IN PTD */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">||</span> <span class="p">(</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_last_dir</span> <span class="o">!=</span> <span class="n">PTD_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">write_ptddata_to_fifo</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">buflen</span> <span class="o">-=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">buflen</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Read the processed ptd&#39;s and data from fifo ram back to</span>
<span class="cm">  URBs&#39; buffers. Fifo must be full and done</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">unpack_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ptd</span> <span class="o">*</span><span class="n">ptd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buflen</span> <span class="o">=</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_last_dir</span> <span class="o">==</span> <span class="n">PTD_DIR_IN</span>
	    <span class="o">?</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_buflen</span> <span class="o">:</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_bufshrt</span><span class="p">;</span>

	<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">,</span> <span class="n">HCuPINT_AIIEOT</span><span class="p">);</span>
	<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCXFERCTR</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">isp116x_write_addr</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCATLPORT</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ep</span> <span class="o">=</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_active</span><span class="p">;</span> <span class="n">ep</span><span class="p">;</span> <span class="n">ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd</span><span class="p">;</span>
		<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">isp116x_read_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
		<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">mps</span> <span class="o">=</span> <span class="n">isp116x_read_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
		<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">isp116x_read_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
		<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">faddr</span> <span class="o">=</span> <span class="n">isp116x_read_data16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
		<span class="n">buflen</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ptd</span><span class="p">);</span>
		<span class="cm">/* Skip reading data for last Setup or Out PTD */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">||</span> <span class="p">(</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_last_dir</span> <span class="o">==</span> <span class="n">PTD_DIR_IN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">read_ptddata_from_fifo</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">buflen</span> <span class="o">-=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dump_ptd</span><span class="p">(</span><span class="n">ptd</span><span class="p">);</span>
		<span class="n">dump_ptd_in_data</span><span class="p">(</span><span class="n">ptd</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">buflen</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm">  Set up PTD&#39;s.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">preproc_atl_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ptd</span> <span class="o">*</span><span class="n">ptd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ep</span> <span class="o">=</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_active</span><span class="p">;</span> <span class="n">ep</span><span class="p">;</span> <span class="n">ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">toggle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">PTD_DIR_SETUP</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">));</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">urb</span><span class="p">,</span> <span class="n">urb_list</span><span class="p">);</span>
		<span class="n">ptd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span>
		    <span class="o">+</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PID_IN</span>:
			<span class="n">toggle</span> <span class="o">=</span> <span class="n">usb_gettoggle</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dir</span> <span class="o">=</span> <span class="n">PTD_DIR_IN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PID_OUT</span>:
			<span class="n">toggle</span> <span class="o">=</span> <span class="n">usb_gettoggle</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">dir</span> <span class="o">=</span> <span class="n">PTD_DIR_OUT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PID_SETUP</span>:
			<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ctrlrequest</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">setup_packet</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PID_ACK</span>:
			<span class="n">toggle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span>
			       <span class="o">&amp;&amp;</span> <span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
			    <span class="o">?</span> <span class="n">PTD_DIR_OUT</span> <span class="o">:</span> <span class="n">PTD_DIR_IN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;%s %d: ep-&gt;nextpid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">PTD_CC_MSK</span> <span class="o">|</span> <span class="n">PTD_ACTIVE_MSK</span> <span class="o">|</span> <span class="n">PTD_TOGGLE</span><span class="p">(</span><span class="n">toggle</span><span class="p">);</span>
		<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">mps</span> <span class="o">=</span> <span class="n">PTD_MPS</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">)</span>
		    <span class="o">|</span> <span class="n">PTD_SPD</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_LOW</span><span class="p">)</span>
		    <span class="o">|</span> <span class="n">PTD_EP</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">);</span>
		<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">PTD_LEN</span><span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="o">|</span> <span class="n">PTD_DIR</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
		<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">faddr</span> <span class="o">=</span> <span class="n">PTD_FA</span><span class="p">(</span><span class="n">usb_pipedevice</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">mps</span> <span class="o">|=</span> <span class="n">PTD_LAST_MSK</span><span class="p">;</span>
			<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_last_dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_bufshrt</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ptd</span><span class="p">)</span> <span class="o">+</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_buflen</span><span class="p">;</span>
		<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_buflen</span> <span class="o">=</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_bufshrt</span> <span class="o">+</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Take done or failed requests out of schedule. Give back</span>
<span class="cm">  processed urbs.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">finish_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp116x_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="n">__acquires</span><span class="p">(</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_SETUP</span><span class="p">;</span>

	<span class="n">urb_dbg</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="s">&quot;Finish&quot;</span><span class="p">);</span>

	<span class="n">usb_hcd_unlink_urb_from_ep</span><span class="p">(</span><span class="n">isp116x_to_hcd</span><span class="p">(</span><span class="n">isp116x</span><span class="p">),</span> <span class="n">urb</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">usb_hcd_giveback_urb</span><span class="p">(</span><span class="n">isp116x_to_hcd</span><span class="p">(</span><span class="n">isp116x</span><span class="p">),</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* take idle endpoints out of the schedule */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* async deschedule */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* periodic deschedule */</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;deschedule qh%d/%p branch %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">isp116x_ep</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">isp116x_ep</span> <span class="o">**</span><span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">prev</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">temp</span> <span class="o">=</span> <span class="o">*</span><span class="n">prev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ep</span><span class="p">))</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">prev</span><span class="p">)</span>
			<span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span> <span class="o">=</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span>
	<span class="n">isp116x_to_hcd</span><span class="p">(</span><span class="n">isp116x</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_allocated</span> <span class="o">-=</span>
	    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span> <span class="o">/</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">;</span>

	<span class="cm">/* switch irq type? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">periodic_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">irqenb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_SOF</span><span class="p">;</span>
		<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">irqenb</span> <span class="o">|=</span> <span class="n">HCuPINT_ATL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Analyze transfer results, handle partial transfers and errors</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">postproc_atl_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ptd</span> <span class="o">*</span><span class="n">ptd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">short_not_ok</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ep</span> <span class="o">=</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_active</span><span class="p">;</span> <span class="n">ep</span><span class="p">;</span> <span class="n">ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">));</span>
		<span class="n">urb</span> <span class="o">=</span>
		    <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span><span class="p">,</span> <span class="n">urb_list</span><span class="p">);</span>
		<span class="n">udev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">ptd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd</span><span class="p">;</span>
		<span class="n">cc</span> <span class="o">=</span> <span class="n">PTD_GET_CC</span><span class="p">(</span><span class="n">ptd</span><span class="p">);</span>
		<span class="n">short_not_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

		<span class="cm">/* Data underrun is special. For allowed underrun</span>
<span class="cm">		   we clear the error and continue as normal. For</span>
<span class="cm">		   forbidden underrun we finish the DATA stage</span>
<span class="cm">		   immediately while for control transfer,</span>
<span class="cm">		   we do a STATUS stage. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">==</span> <span class="n">TD_DATAUNDERRUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">&amp;</span> <span class="n">URB_SHORT_NOT_OK</span><span class="p">)</span> <span class="o">||</span>
					<span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Allowed or control data underrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">cc</span> <span class="o">=</span> <span class="n">TD_CC_NOERROR</span><span class="p">;</span>
				<span class="n">short_not_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span>
					      <span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">==</span> <span class="n">USB_PID_OUT</span><span class="p">,</span>
					      <span class="n">PTD_GET_TOGGLE</span><span class="p">(</span><span class="n">ptd</span><span class="p">));</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">PTD_GET_COUNT</span><span class="p">(</span><span class="n">ptd</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">cc_to_error</span><span class="p">[</span><span class="n">TD_DATAUNDERRUN</span><span class="p">];</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">!=</span> <span class="n">TD_CC_NOERROR</span> <span class="o">&amp;&amp;</span> <span class="n">cc</span> <span class="o">!=</span> <span class="n">TD_NOTACCESSED</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">++</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">cc</span> <span class="o">==</span> <span class="n">TD_CC_STALL</span>
			<span class="o">||</span> <span class="n">cc</span> <span class="o">==</span> <span class="n">TD_DATAOVERRUN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cc_to_error</span><span class="p">[</span><span class="n">cc</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">==</span> <span class="n">USB_PID_ACK</span><span class="p">)</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* According to usb spec, zero-length Int transfer signals</span>
<span class="cm">		   finishing of the urb. Hey, does this apply only</span>
<span class="cm">		   for IN endpoints? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeint</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">PTD_GET_LEN</span><span class="p">(</span><span class="n">ptd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Relax after previously failed, but later succeeded</span>
<span class="cm">		   or correctly NAK&#39;ed retransmission attempt */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cc</span> <span class="o">==</span> <span class="n">TD_CC_NOERROR</span> <span class="o">||</span> <span class="n">cc</span> <span class="o">==</span> <span class="n">TD_NOTACCESSED</span><span class="p">))</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Take into account idiosyncracies of the isp116x chip</span>
<span class="cm">		   regarding toggle bit for failed transfers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">==</span> <span class="n">USB_PID_OUT</span><span class="p">)</span>
			<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PTD_GET_TOGGLE</span><span class="p">(</span><span class="n">ptd</span><span class="p">)</span>
				      <span class="o">^</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">==</span> <span class="n">USB_PID_IN</span><span class="p">)</span>
			<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PTD_GET_TOGGLE</span><span class="p">(</span><span class="n">ptd</span><span class="p">)</span>
				      <span class="o">^</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PID_IN</span>:
		<span class="k">case</span> <span class="n">USB_PID_OUT</span>:
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">PTD_GET_COUNT</span><span class="p">(</span><span class="n">ptd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">PTD_GET_ACTIVE</span><span class="p">(</span><span class="n">ptd</span><span class="p">)</span>
			    <span class="o">||</span> <span class="p">(</span><span class="n">cc</span> <span class="o">!=</span> <span class="n">TD_CC_NOERROR</span> <span class="o">&amp;&amp;</span> <span class="n">cc</span> <span class="o">&lt;</span> <span class="mh">0x0E</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">!=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">short_not_ok</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">&amp;</span> <span class="n">URB_ZERO_PACKET</span>
				    <span class="o">&amp;&amp;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">==</span> <span class="n">USB_PID_OUT</span>
				    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">PTD_GET_COUNT</span><span class="p">(</span><span class="n">ptd</span><span class="p">)</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Zero packet requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* All data for this URB is transferred, let&#39;s finish */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_ACK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PID_SETUP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">PTD_GET_ACTIVE</span><span class="p">(</span><span class="n">ptd</span><span class="p">)</span>
			    <span class="o">||</span> <span class="p">(</span><span class="n">cc</span> <span class="o">!=</span> <span class="n">TD_CC_NOERROR</span> <span class="o">&amp;&amp;</span> <span class="n">cc</span> <span class="o">&lt;</span> <span class="mh">0x0E</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">==</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_ACK</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeout</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_OUT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_IN</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PID_ACK</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">PTD_GET_ACTIVE</span><span class="p">(</span><span class="n">ptd</span><span class="p">)</span>
			    <span class="o">||</span> <span class="p">(</span><span class="n">cc</span> <span class="o">!=</span> <span class="n">TD_CC_NOERROR</span> <span class="o">&amp;&amp;</span> <span class="n">cc</span> <span class="o">&lt;</span> <span class="mh">0x0E</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>

 <span class="nl">done:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINPROGRESS</span> <span class="o">||</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">unlinked</span><span class="p">)</span>
			<span class="n">finish_request</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Scan transfer lists, schedule transfers, send data off</span>
<span class="cm">  to chip.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_atl_transfers</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x_ep</span> <span class="o">*</span><span class="n">last_ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">load</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">byte_time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_finishing</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HC_IS_RUNNING</span><span class="p">(</span><span class="n">isp116x_to_hcd</span><span class="p">(</span><span class="n">isp116x</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* FIFO not empty? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp116x_read_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCBUFSTAT_ATL_FULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_buflen</span> <span class="o">=</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_bufshrt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Schedule int transfers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">periodic_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">fmindex</span> <span class="o">=</span> <span class="n">index</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">fmindex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PERIODIC_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">load</span> <span class="o">=</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span> <span class="p">{</span>
			<span class="cm">/* Bring all int transfers for this frame</span>
<span class="cm">			   into the active queue */</span>
			<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_active</span> <span class="o">=</span> <span class="n">last_ep</span> <span class="o">=</span>
			    <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">last_ep</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
				<span class="n">last_ep</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_ep</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">last_ep</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
			<span class="n">last_ep</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Schedule control/bulk transfers */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">urb</span><span class="p">,</span> <span class="n">urb_list</span><span class="p">);</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
		<span class="n">byte_time</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_LOW</span>
		    <span class="o">?</span> <span class="n">BYTE_TIME_LOWSPEED</span> <span class="o">:</span> <span class="n">BYTE_TIME_FULLSPEED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">==</span> <span class="n">USB_PID_SETUP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ctrlrequest</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">==</span> <span class="n">USB_PID_ACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Find current free length ... */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX_LOAD_LIMIT</span> <span class="o">-</span> <span class="n">load</span><span class="p">)</span> <span class="o">/</span> <span class="n">byte_time</span><span class="p">;</span>

			<span class="cm">/* ... then limit it to configured max size ... */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_LOW</span> <span class="o">?</span>
				  <span class="n">MAX_TRANSFER_SIZE_LOWSPEED</span> <span class="o">:</span>
				  <span class="n">MAX_TRANSFER_SIZE_FULLSPEED</span><span class="p">);</span>

			<span class="cm">/* ... and finally cut to the multiple of MaxPacketSize,</span>
<span class="cm">			   or to the real length if there&#39;s enough room. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span>
			    <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">-</span>
			     <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">-=</span> <span class="n">len</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">-</span>
				    <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">load</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">*</span> <span class="n">byte_time</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">load</span> <span class="o">&gt;</span> <span class="n">MAX_LOAD_LIMIT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_ep</span><span class="p">)</span>
			<span class="n">last_ep</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_active</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
		<span class="n">last_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Avoid starving of endpoints */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">)</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">preproc_atl_queue</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
		<span class="n">pack_fifo</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Finish the processed transfers</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">finish_atl_transfers</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_active</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Fifo not ready? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp116x_read_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCBUFSTAT_ATL_DONE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_finishing</span><span class="p">);</span>
	<span class="n">unpack_fifo</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
	<span class="n">postproc_atl_queue</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_finishing</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">isp116x_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span> <span class="o">=</span> <span class="n">hcd_to_isp116x</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">irqstat</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irqstat</span> <span class="o">=</span> <span class="n">isp116x_read_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">);</span>
	<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">,</span> <span class="n">irqstat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HCuPINT_ATL</span> <span class="o">|</span> <span class="n">HCuPINT_SOF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="n">finish_atl_transfers</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">HCuPINT_OPR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">intstat</span> <span class="o">=</span> <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCINTSTAT</span><span class="p">);</span>
		<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCINTSTAT</span><span class="p">,</span> <span class="n">intstat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">HCINT_UE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;Unrecoverable error, HC is dead!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* IRQ&#39;s are off, we do no DMA,</span>
<span class="cm">			   perfectly ready to die ... */</span>
			<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_HALT</span><span class="p">;</span>
			<span class="n">usb_hc_died</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">HCINT_RHSC</span><span class="p">)</span>
			<span class="cm">/* When root hub or any of its ports is going</span>
<span class="cm">			   to come out of suspend, it may take more</span>
<span class="cm">			   than 10ms for status bits to stabilize. */</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rh_timer</span><span class="p">,</span> <span class="n">jiffies</span>
				  <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">HCINT_RD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;---- remote wakeup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">usb_hcd_resume_root_hub</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">irqstat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_OPR</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HCuPINT_ATL</span> <span class="o">|</span> <span class="n">HCuPINT_SOF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">start_atl_transfers</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">,</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">irqenb</span><span class="p">);</span>
      <span class="nl">done:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------*/</span>

<span class="cm">/* usb 1.1 says max 90% of a frame is available for periodic transfers.</span>
<span class="cm"> * this driver doesn&#39;t promise that much since it&#39;s got to handle an</span>
<span class="cm"> * IRQ per packet; irq handling latencies also use up that time.</span>
<span class="cm"> */</span>

<span class="cm">/* out of 1000 us */</span>
<span class="cp">#define	MAX_PERIODIC_LOAD	600</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">balance</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">u16</span> <span class="n">period</span><span class="p">,</span> <span class="n">u16</span> <span class="n">load</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">branch</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="cm">/* search for the least loaded schedule branch of that period</span>
<span class="cm">	   which has enough bandwidth left unreserved. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">period</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">branch</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="n">period</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">load</span><span class="p">)</span>
				    <span class="o">&gt;</span> <span class="n">MAX_PERIODIC_LOAD</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">branch</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">branch</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* NB! ALL the code above this point runs with isp116x-&gt;lock</span>
<span class="cm">   held, irqs off</span>
<span class="cm">*/</span>

<span class="cm">/*-----------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp116x_urb_enqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
			       <span class="n">gfp_t</span> <span class="n">mem_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span> <span class="o">=</span> <span class="n">hcd_to_isp116x</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_out</span> <span class="o">=</span> <span class="o">!</span><span class="n">usb_pipein</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">usb_pipetype</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">epnum</span> <span class="o">=</span> <span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">hep</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp116x_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">urb_dbg</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="s">&quot;Enqueue&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_ISOCHRONOUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;Isochronous transfers not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">urb_dbg</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="s">&quot;Refused to enqueue&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* avoid all allocations within spinlocks: request or endpoint */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">mem_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HC_IS_RUNNING</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_not_linked</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_hcd_link_urb_to_ep</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_not_linked</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">)</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">=</span> <span class="n">epnum</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">usb_maxpacket</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="n">is_out</span><span class="p">);</span>
		<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">epnum</span><span class="p">,</span> <span class="n">is_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_CONTROL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_SETUP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_out</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_OUT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_IN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			   With INT URBs submitted, the driver works with SOF</span>
<span class="cm">			   interrupt enabled and ATL interrupt disabled. After</span>
<span class="cm">			   the PTDs are written to fifo ram, the chip starts</span>
<span class="cm">			   fifo processing and usb transfers after the next</span>
<span class="cm">			   SOF and continues until the transfers are finished</span>
<span class="cm">			   (succeeded or failed) or the frame ends. Therefore,</span>
<span class="cm">			   the transfers occur only in every second frame,</span>
<span class="cm">			   while fifo reading/writing and data processing</span>
<span class="cm">			   occur in every other second frame. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PERIODIC_SIZE</span><span class="p">)</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span> <span class="o">=</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span> <span class="o">=</span> <span class="n">usb_calc_bus_time</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span>
						     <span class="o">!</span><span class="n">is_out</span><span class="p">,</span>
						     <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_ISOCHRONOUS</span><span class="p">),</span>
						     <span class="n">usb_maxpacket</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span>
								   <span class="n">is_out</span><span class="p">))</span> <span class="o">/</span>
			    <span class="mi">1000</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span> <span class="o">=</span> <span class="n">hep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* maybe put endpoint into schedule */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PIPE_CONTROL</span>:
	<span class="k">case</span> <span class="n">PIPE_BULK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">))</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIPE_INTERRUPT</span>:
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span>
				 <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">);</span>

		<span class="cm">/* urb submitted for already existing endpoint */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span> <span class="o">&lt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">balance</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">start_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">fmindex</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PERIODIC_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		    <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">;</span>

		<span class="cm">/* sort each schedule branch by period (slow before fast)</span>
<span class="cm">		   to share the faster parts of the tree without needing</span>
<span class="cm">		   dummy/placeholder nodes */</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;schedule qh%d/%p branch %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">isp116x_ep</span> <span class="o">**</span><span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">isp116x_ep</span> <span class="o">*</span><span class="n">here</span> <span class="o">=</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">here</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span> <span class="o">!=</span> <span class="n">here</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span> <span class="o">&gt;</span> <span class="n">here</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">here</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">here</span> <span class="o">=</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">!=</span> <span class="n">here</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">here</span><span class="p">;</span>
				<span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_allocated</span> <span class="o">+=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span> <span class="o">/</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">;</span>

		<span class="cm">/* switch over to SOFint */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">periodic_count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">irqenb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_ATL</span><span class="p">;</span>
			<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">irqenb</span> <span class="o">|=</span> <span class="n">HCuPINT_SOF</span><span class="p">;</span>
			<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">,</span>
					    <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">irqenb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="n">hep</span><span class="p">;</span>
	<span class="n">start_atl_transfers</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>

      <span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">usb_hcd_unlink_urb_from_ep</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
      <span class="nl">fail_not_linked:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   Dequeue URBs.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp116x_urb_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span> <span class="o">=</span> <span class="n">hcd_to_isp116x</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">hep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp116x_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">ep_act</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_hcd_check_unlink_urb</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">hep</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">hep</span> <span class="o">!=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="p">);</span>

	<span class="cm">/* In front of queue? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">)</span>
		<span class="cm">/* active? */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ep_act</span> <span class="o">=</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">atl_active</span><span class="p">;</span> <span class="n">ep_act</span><span class="p">;</span>
		     <span class="n">ep_act</span> <span class="o">=</span> <span class="n">ep_act</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep_act</span> <span class="o">==</span> <span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;dequeue, urb %p active; wait for irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">urb</span><span class="p">);</span>
				<span class="n">urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="p">)</span>
		<span class="n">finish_request</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
 <span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp116x_endpoint_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">hep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp116x_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* assume we&#39;d just wait for the irq */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">))</span>
		<span class="n">WARNING</span><span class="p">(</span><span class="s">&quot;ep %p not empty?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp116x_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span> <span class="o">=</span> <span class="n">hcd_to_isp116x</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">fmnum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fmnum</span> <span class="o">=</span> <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCFMNUM</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">fmnum</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Adapted from ohci-hub.c. Currently we don&#39;t support autosuspend.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp116x_hub_status_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span> <span class="o">=</span> <span class="n">hcd_to_isp116x</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ports</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HC_IS_RUNNING</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="cm">/* Report no status change now, if we are scheduled to be</span>
<span class="cm">	   called later */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rh_timer</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ports</span> <span class="o">=</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">rhdesca</span> <span class="o">&amp;</span> <span class="n">RH_A_NDP</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">rhstatus</span> <span class="o">=</span> <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCRHSTATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">rhstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RH_HS_LPSC</span> <span class="o">|</span> <span class="n">RH_HS_OCIC</span><span class="p">))</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="n">HCRHPORT2</span> <span class="o">:</span> <span class="n">HCRHPORT1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RH_PS_CSC</span> <span class="o">|</span> <span class="n">RH_PS_PESC</span> <span class="o">|</span> <span class="n">RH_PS_PSSC</span>
			      <span class="o">|</span> <span class="n">RH_PS_OCIC</span> <span class="o">|</span> <span class="n">RH_PS_PRSC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp116x_hub_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">usb_hub_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">rhdesca</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescLength</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bHubContrCurrent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bNbrPorts</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="cm">/* Power switching, device type, overcurrent. */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">wHubCharacteristics</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">));</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bPwrOn2PwrGood</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="cm">/* ports removable, and legacy PortPwrCtrlMask */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Perform reset of a given port.</span>
<span class="cm">   It would be great to just start the reset and let the</span>
<span class="cm">   USB core to clear the reset in due time. However,</span>
<span class="cm">   root hub ports should be reset for at least 50 ms, while</span>
<span class="cm">   our chip stays in reset for about 10 ms. I.e., we must</span>
<span class="cm">   repeatedly reset it ourself here.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">root_port_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>

	<span class="cm">/* Root hub reset should be 50 ms, but some devices</span>
<span class="cm">	   want it even longer. */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* spin until any current reset finishes */</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">port</span> <span class="o">?</span>
						 <span class="n">HCRHPORT2</span> <span class="o">:</span> <span class="n">HCRHPORT1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">RH_PS_PRS</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Don&#39;t reset a disconnected port */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">RH_PS_CCS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Reset lasts 10ms (claims datasheet) */</span>
		<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">port</span> <span class="o">?</span> <span class="n">HCRHPORT2</span> <span class="o">:</span>
				    <span class="n">HCRHPORT1</span><span class="p">,</span> <span class="p">(</span><span class="n">RH_PS_PRS</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Adapted from ohci-hub.c */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp116x_hub_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">typeReq</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">wValue</span><span class="p">,</span> <span class="n">u16</span> <span class="n">wIndex</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">wLength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span> <span class="o">=</span> <span class="n">hcd_to_isp116x</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ports</span> <span class="o">=</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">rhdesca</span> <span class="o">&amp;</span> <span class="n">RH_A_NDP</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">typeReq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ClearHubFeature</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;ClearHubFeature: &quot;</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">C_HUB_OVER_CURRENT</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;C_HUB_OVER_CURRENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCRHSTATUS</span><span class="p">,</span> <span class="n">RH_HS_OCIC</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">C_HUB_LOCAL_POWER</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;C_HUB_LOCAL_POWER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SetHubFeature</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;SetHubFeature: &quot;</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">C_HUB_OVER_CURRENT</span>:
		<span class="k">case</span> <span class="n">C_HUB_LOCAL_POWER</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;C_HUB_OVER_CURRENT or C_HUB_LOCAL_POWER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetHubDescriptor</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;GetHubDescriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">isp116x_hub_descriptor</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span>
				       <span class="p">(</span><span class="k">struct</span> <span class="n">usb_hub_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetHubStatus</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;GetHubStatus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetPortStatus</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;GetPortStatus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wIndex</span> <span class="o">||</span> <span class="n">wIndex</span> <span class="o">&gt;</span> <span class="n">ports</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="p">(</span><span class="o">--</span><span class="n">wIndex</span><span class="p">)</span> <span class="o">?</span> <span class="n">HCRHPORT2</span> <span class="o">:</span> <span class="n">HCRHPORT1</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;GetPortStatus: port[%d]  %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ClearPortFeature</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;ClearPortFeature: &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wIndex</span> <span class="o">||</span> <span class="n">wIndex</span> <span class="o">&gt;</span> <span class="n">ports</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">wIndex</span><span class="o">--</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_ENABLE</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;USB_PORT_FEAT_ENABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_CCS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_ENABLE</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;USB_PORT_FEAT_C_ENABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_PESC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_SUSPEND</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;USB_PORT_FEAT_SUSPEND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_POCI</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_SUSPEND</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;USB_PORT_FEAT_C_SUSPEND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_PSSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_POWER</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;USB_PORT_FEAT_POWER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_LSDA</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_CONNECTION</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;USB_PORT_FEAT_C_CONNECTION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_CSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_OVER_CURRENT</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;USB_PORT_FEAT_C_OVER_CURRENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_OCIC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_RESET</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;USB_PORT_FEAT_C_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_PRSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">wIndex</span>
				    <span class="o">?</span> <span class="n">HCRHPORT2</span> <span class="o">:</span> <span class="n">HCRHPORT1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SetPortFeature</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;SetPortFeature: &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wIndex</span> <span class="o">||</span> <span class="n">wIndex</span> <span class="o">&gt;</span> <span class="n">ports</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">wIndex</span><span class="o">--</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_SUSPEND</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;USB_PORT_FEAT_SUSPEND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">wIndex</span>
					    <span class="o">?</span> <span class="n">HCRHPORT2</span> <span class="o">:</span> <span class="n">HCRHPORT1</span><span class="p">,</span> <span class="n">RH_PS_PSS</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_POWER</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;USB_PORT_FEAT_POWER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">wIndex</span>
					    <span class="o">?</span> <span class="n">HCRHPORT2</span> <span class="o">:</span> <span class="n">HCRHPORT1</span><span class="p">,</span> <span class="n">RH_PS_PPS</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_RESET</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;USB_PORT_FEAT_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">root_port_reset</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">wIndex</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
	      <span class="nl">error:</span>
		<span class="cm">/* &quot;protocol stall&quot; on error */</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;PROTOCOL STALL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------*/</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s %04x%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCuPINT_CLKRDY</span> <span class="o">?</span> <span class="s">&quot; clkrdy&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCuPINT_SUSP</span> <span class="o">?</span> <span class="s">&quot; susp&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCuPINT_OPR</span> <span class="o">?</span> <span class="s">&quot; opr&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCuPINT_AIIEOT</span> <span class="o">?</span> <span class="s">&quot; eot&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCuPINT_ATL</span> <span class="o">?</span> <span class="s">&quot; atl&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCuPINT_SOF</span> <span class="o">?</span> <span class="s">&quot; sof&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s %08x%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCINT_MIE</span> <span class="o">?</span> <span class="s">&quot; MIE&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCINT_RHSC</span> <span class="o">?</span> <span class="s">&quot; rhsc&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCINT_FNO</span> <span class="o">?</span> <span class="s">&quot; fno&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCINT_UE</span> <span class="o">?</span> <span class="s">&quot; ue&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCINT_RD</span> <span class="o">?</span> <span class="s">&quot; rd&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCINT_SF</span> <span class="o">?</span> <span class="s">&quot; sof&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCINT_SO</span> <span class="o">?</span> <span class="s">&quot; so&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp116x_show_dbg</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">%s version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">isp116x_to_hcd</span><span class="p">(</span><span class="n">isp116x</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">product_desc</span><span class="p">,</span> <span class="n">hcd_name</span><span class="p">,</span>
		   <span class="n">DRIVER_VERSION</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HC_IS_SUSPENDED</span><span class="p">(</span><span class="n">isp116x_to_hcd</span><span class="p">(</span><span class="n">isp116x</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCD is suspended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HC_IS_RUNNING</span><span class="p">(</span><span class="n">isp116x_to_hcd</span><span class="p">(</span><span class="n">isp116x</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCD not running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dump_irq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;hc_irq_enable&quot;</span><span class="p">,</span> <span class="n">isp116x_read_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">));</span>
	<span class="n">dump_irq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;hc_irq_status&quot;</span><span class="p">,</span> <span class="n">isp116x_read_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">));</span>
	<span class="n">dump_int</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;hc_int_enable&quot;</span><span class="p">,</span> <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCINTENB</span><span class="p">));</span>
	<span class="n">dump_int</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;hc_int_status&quot;</span><span class="p">,</span> <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCINTSTAT</span><span class="p">));</span>
	<span class="n">isp116x_show_regs_seq</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp116x_open_seq</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">isp116x_show_dbg</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">isp116x_debug_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">isp116x_open_seq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_debug_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">dentry</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">hcd_name</span><span class="p">,</span>
					      <span class="n">S_IRUGO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">isp116x</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">isp116x_debug_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_debug_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define	create_debug_file(d)	0</span>
<span class="cp">#define	remove_debug_file(d)	do{}while(0)</span>

<span class="cp">#endif				</span><span class="cm">/* CONFIG_DEBUG_FS */</span><span class="cp"></span>

<span class="cm">/*-----------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm">  Software reset - can be called from any contect.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp116x_sw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCSWRES</span><span class="p">,</span> <span class="n">HCSWRES_MAGIC</span><span class="p">);</span>
	<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCCMDSTAT</span><span class="p">,</span> <span class="n">HCCMDSTAT_HCR</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* It usually resets within 1 ms */</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCCMDSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCCMDSTAT_HCR</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;Software reset timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp116x_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span> <span class="o">=</span> <span class="n">hcd_to_isp116x</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">clkrdy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">15</span> <span class="cm">/* ms */</span> <span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">isp116x_sw_reset</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">clkrdy</span> <span class="o">=</span> <span class="n">isp116x_read_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCuPINT_CLKRDY</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clkrdy</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clkrdy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;Clock not ready after %dms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="cm">/* After sw_reset the clock won&#39;t report to be ready, if</span>
<span class="cm">		   H_WAKEUP pin is high. */</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;Please make sure that the H_WAKEUP pin is pulled low!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp116x_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span> <span class="o">=</span> <span class="n">hcd_to_isp116x</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Switch off ports&#39; power, some devices don&#39;t come up</span>
<span class="cm">	   after next &#39;insmod&#39; without this */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCRHDESCA</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RH_A_NPS</span> <span class="o">|</span> <span class="n">RH_A_PSM</span><span class="p">);</span>
	<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCRHDESCA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCRHSTATUS</span><span class="p">,</span> <span class="n">RH_HS_LPS</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">isp116x_sw_reset</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Configure the chip. The chip must be successfully reset by now.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp116x_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span> <span class="o">=</span> <span class="n">hcd_to_isp116x</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp116x_platform_data</span> <span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* clear interrupt status and disable all interrupt sources */</span>
	<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">isp116x_read_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCCHIPID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HCCHIPID_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HCCHIPID_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;Invalid chip ID %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* To be removed in future */</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">uses_new_polling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCITLBUFLEN</span><span class="p">,</span> <span class="n">ISP116x_ITL_BUFSIZE</span><span class="p">);</span>
	<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCATLBUFLEN</span><span class="p">,</span> <span class="n">ISP116x_ATL_BUFSIZE</span><span class="p">);</span>

	<span class="cm">/* ----- HW conf */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">HCHWCFG_INT_ENABLE</span> <span class="o">|</span> <span class="n">HCHWCFG_DBWIDTH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">sel15Kres</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">HCHWCFG_15KRSEL</span><span class="p">;</span>
	<span class="cm">/* Remote wakeup won&#39;t work without working clock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">remote_wakeup_enable</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">HCHWCFG_CLKNOTSTOP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">oc_enable</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">HCHWCFG_ANALOG_OC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">int_act_high</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">HCHWCFG_INT_POL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">int_edge_triggered</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">HCHWCFG_INT_TRIGGER</span><span class="p">;</span>
	<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCHWCFG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* ----- Root hub conf */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RH_A_POTPGT</span><span class="p">;</span>
	<span class="cm">/* AN10003_1.pdf recommends RH_A_NPS (no power switching) to</span>
<span class="cm">	   be always set. Yet, instead, we request individual port</span>
<span class="cm">	   power switching. */</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">RH_A_PSM</span><span class="p">;</span>
	<span class="cm">/* Report overcurrent per port */</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">RH_A_OCPM</span><span class="p">;</span>
	<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCRHDESCA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">rhdesca</span> <span class="o">=</span> <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCRHDESCA</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">RH_B_PPCM</span><span class="p">;</span>
	<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCRHDESCB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">rhdescb</span> <span class="o">=</span> <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCRHDESCB</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">remote_wakeup_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_can_wakeup</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">))</span>
			<span class="n">device_init_wakeup</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">RH_HS_DRWE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCRHSTATUS</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">rhstatus</span> <span class="o">=</span> <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCRHSTATUS</span><span class="p">);</span>

	<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCFMINTVL</span><span class="p">,</span> <span class="mh">0x27782edf</span><span class="p">);</span>

	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_RUNNING</span><span class="p">;</span>

	<span class="cm">/* Set up interrupts */</span>
	<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">intenb</span> <span class="o">=</span> <span class="n">HCINT_MIE</span> <span class="o">|</span> <span class="n">HCINT_RHSC</span> <span class="o">|</span> <span class="n">HCINT_UE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">remote_wakeup_enable</span><span class="p">)</span>
		<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">intenb</span> <span class="o">|=</span> <span class="n">HCINT_RD</span><span class="p">;</span>
	<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">irqenb</span> <span class="o">=</span> <span class="n">HCuPINT_ATL</span> <span class="o">|</span> <span class="n">HCuPINT_OPR</span><span class="p">;</span>	<span class="cm">/* | HCuPINT_SUSP; */</span>
	<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCINTENB</span><span class="p">,</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">intenb</span><span class="p">);</span>
	<span class="n">isp116x_write_reg16</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">,</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">irqenb</span><span class="p">);</span>

	<span class="cm">/* Go operational */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">HCCONTROL_USB_OPER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">remote_wakeup_enable</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">HCCONTROL_RWE</span><span class="p">;</span>
	<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Disable ports to avoid race in device enumeration */</span>
	<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCRHPORT1</span><span class="p">,</span> <span class="n">RH_PS_CCS</span><span class="p">);</span>
	<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCRHPORT2</span><span class="p">,</span> <span class="n">RH_PS_CCS</span><span class="p">);</span>

	<span class="n">isp116x_show_regs_log</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef	CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp116x_bus_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span> <span class="o">=</span> <span class="n">hcd_to_isp116x</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HCCONTROL_HCFS</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HCCONTROL_USB_OPER</span>:
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">HCCONTROL_HCFS</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HCCONTROL_RWE</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">HCCONTROL_USB_SUSPEND</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span><span class="n">do_remote_wakeup</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">HCCONTROL_RWE</span><span class="p">;</span>
		<span class="cm">/* Wait for usb transfers to finish */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* Wait for devices to suspend */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HCCONTROL_USB_RESUME</span>:
		<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HCCONTROL_HCFS</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">HCCONTROL_USB_RESET</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">HCCONTROL_USB_RESET</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* HCCONTROL_USB_SUSPEND */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp116x_bus_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span> <span class="o">=</span> <span class="n">hcd_to_isp116x</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HCCONTROL_HCFS</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HCCONTROL_USB_SUSPEND</span>:
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCCONTROL_HCFS</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">HCCONTROL_USB_RESUME</span><span class="p">;</span>
		<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">HCCONTROL_USB_RESUME</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HCCONTROL_USB_OPER</span>:
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* HCCONTROL_USB_RESET: this may happen, when during</span>
<span class="cm">		   suspension the HC lost power. Reinitialize completely */</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Chip has been reset while suspended. Reinit from scratch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">isp116x_reset</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
		<span class="n">isp116x_start</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
		<span class="n">isp116x_hub_control</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">SetPortFeature</span><span class="p">,</span>
				    <span class="n">USB_PORT_FEAT_POWER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">rhdesca</span> <span class="o">&amp;</span> <span class="n">RH_A_NDP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">isp116x_hub_control</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">SetPortFeature</span><span class="p">,</span>
					    <span class="n">USB_PORT_FEAT_POWER</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">rhdesca</span> <span class="o">&amp;</span> <span class="n">RH_A_NDP</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">val</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">stat</span> <span class="o">=</span>
		    <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">val</span> <span class="o">?</span> <span class="n">HCRHPORT2</span> <span class="o">:</span> <span class="n">HCRHPORT1</span><span class="p">);</span>
		<span class="cm">/* force global, not selective, resume */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RH_PS_PSS</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: Resuming port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">RH_PS_POCI</span><span class="p">,</span> <span class="n">val</span>
				    <span class="o">?</span> <span class="n">HCRHPORT2</span> <span class="o">:</span> <span class="n">HCRHPORT1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_RESUMING</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* Go operational */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">isp116x_read_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">);</span>
	<span class="n">isp116x_write_reg32</span><span class="p">(</span><span class="n">isp116x</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HCCONTROL_HCFS</span><span class="p">)</span> <span class="o">|</span> <span class="n">HCCONTROL_USB_OPER</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_RUNNING</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define	isp116x_bus_suspend	NULL</span>
<span class="cp">#define	isp116x_bus_resume	NULL</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hc_driver</span> <span class="n">isp116x_hc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">hcd_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">product_desc</span> <span class="o">=</span> <span class="s">&quot;ISP116x Host Controller&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hcd_priv_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp116x</span><span class="p">),</span>

	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">isp116x_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">HCD_USB11</span><span class="p">,</span>

	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">isp116x_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">isp116x_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">isp116x_stop</span><span class="p">,</span>

	<span class="p">.</span><span class="n">urb_enqueue</span> <span class="o">=</span> <span class="n">isp116x_urb_enqueue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">urb_dequeue</span> <span class="o">=</span> <span class="n">isp116x_urb_dequeue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">endpoint_disable</span> <span class="o">=</span> <span class="n">isp116x_endpoint_disable</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_frame_number</span> <span class="o">=</span> <span class="n">isp116x_get_frame</span><span class="p">,</span>

	<span class="p">.</span><span class="n">hub_status_data</span> <span class="o">=</span> <span class="n">isp116x_hub_status_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hub_control</span> <span class="o">=</span> <span class="n">isp116x_hub_control</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_suspend</span> <span class="o">=</span> <span class="n">isp116x_bus_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_resume</span> <span class="o">=</span> <span class="n">isp116x_bus_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*----------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp116x_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hcd</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">isp116x</span> <span class="o">=</span> <span class="n">hcd_to_isp116x</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">remove_debug_file</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
	<span class="n">usb_remove_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">addr_reg</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">isp116x_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp116x</span> <span class="o">*</span><span class="n">isp116x</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">ires</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr_reg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">data_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_disabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">num_resources</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ires</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span> <span class="o">||</span> <span class="o">!</span><span class="n">ires</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">ires</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">irqflags</span> <span class="o">=</span> <span class="n">ires</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IRQF_TRIGGER_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;DMA not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hcd_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr_reg</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr_reg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hcd_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data_reg</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_reg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate and initialize hcd */</span>
	<span class="n">hcd</span> <span class="o">=</span> <span class="n">usb_create_hcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x_hc_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hcd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err5</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* this rsrc_start is bogus */</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_start</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">isp116x</span> <span class="o">=</span> <span class="n">hcd_to_isp116x</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">data_reg</span> <span class="o">=</span> <span class="n">data_reg</span><span class="p">;</span>
	<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">addr_reg</span> <span class="o">=</span> <span class="n">addr_reg</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
	<span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isp116x</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;Platform data structure not initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err6</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp116x_check_platform_delay</span><span class="p">(</span><span class="n">isp116x</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;USE_PLATFORM_DELAY defined, but delay function not &quot;</span>
		    <span class="s">&quot;implemented.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;See comments in drivers/usb/host/isp116x-hcd.c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err6</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_add_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err6</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">create_debug_file</span><span class="p">(</span><span class="n">isp116x</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t create debugfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err7</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">err7:</span>
	<span class="n">usb_remove_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
      <span class="nl">err6:</span>
	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
      <span class="nl">err5:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">data_reg</span><span class="p">);</span>
      <span class="nl">err4:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
      <span class="nl">err3:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">addr_reg</span><span class="p">);</span>
      <span class="nl">err2:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
      <span class="nl">err1:</span>
	<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;init error, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef	CONFIG_PM</span>
<span class="cm">/*</span>
<span class="cm">  Suspend of platform device</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp116x_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;%s: state %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Resume platform device</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp116x_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define	isp116x_suspend    NULL</span>
<span class="cp">#define	isp116x_resume     NULL</span>

<span class="cp">#endif</span>

<span class="cm">/* work with hotplug and coldplug */</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:isp116x-hcd&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">isp116x_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">isp116x_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">isp116x_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">isp116x_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">isp116x_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hcd_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">isp116x_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
