<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › host › ohci-q.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ohci-q.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * OHCI HCD (Host Controller Driver) for USB.</span>
<span class="cm"> *</span>
<span class="cm"> * (C) Copyright 1999 Roman Weissgaerber &lt;weissg@vienna.at&gt;</span>
<span class="cm"> * (C) Copyright 2000-2002 David Brownell &lt;dbrownell@users.sourceforge.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licenced under the GPL.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">urb_free_priv</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">urb_priv_t</span> <span class="o">*</span><span class="n">urb_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">last</span> <span class="o">=</span> <span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">td</span>	<span class="o">*</span><span class="n">td</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">td</span> <span class="o">=</span> <span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">td</span> <span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="p">)</span>
				<span class="n">td_free</span> <span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_del</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">urb_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * URB goes back to driver, and isn&#39;t reissued.</span>
<span class="cm"> * It&#39;s completely gone from HC data structures.</span>
<span class="cm"> * PRECONDITION:  ohci lock held, irqs blocked.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">finish_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>ASSERT (urb->hcpriv != 0);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">urb_free_priv</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">usb_pipetype</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PIPE_ISOCHRONOUS</span>:
		<span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_isoc_reqs</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_isoc_reqs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">quirk_amdiso</span><span class="p">(</span><span class="n">ohci</span><span class="p">))</span>
				<span class="n">usb_amd_quirk_pll_enable</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">quirk_amdprefetch</span><span class="p">(</span><span class="n">ohci</span><span class="p">))</span>
				<span class="n">sb800_prefetch</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIPE_INTERRUPT</span>:
		<span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_int_reqs</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef OHCI_VERBOSE_DEBUG</span>
	<span class="n">urb_print</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="s">&quot;RET&quot;</span><span class="p">,</span> <span class="n">usb_pipeout</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span> <span class="n">status</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* urb-&gt;complete() can reenter this HCD */</span>
	<span class="n">usb_hcd_unlink_urb_from_ep</span><span class="p">(</span><span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">),</span> <span class="n">urb</span><span class="p">);</span>
	<span class="n">spin_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">usb_hcd_giveback_urb</span><span class="p">(</span><span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">),</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">spin_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* stop periodic dma if it&#39;s not needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_isoc_reqs</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">&amp;&amp;</span> <span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_int_reqs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">OHCI_CTRL_PLE</span><span class="o">|</span><span class="n">OHCI_CTRL_IE</span><span class="p">);</span>
		<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------------------------*</span>
<span class="cm"> * ED handling functions</span>
<span class="cm"> *-------------------------------------------------------------------------*/</span>

<span class="cm">/* search for the right schedule branch to use for a periodic ed.</span>
<span class="cm"> * does some load balancing; returns the branch, or negative errno.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">balance</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">interval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">load</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">branch</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="cm">/* iso periods can be huge; iso tds specify frame numbers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="n">NUM_INTS</span><span class="p">)</span>
		<span class="n">interval</span> <span class="o">=</span> <span class="n">NUM_INTS</span><span class="p">;</span>

	<span class="cm">/* search for the least loaded schedule branch of that period</span>
<span class="cm">	 * that has enough bandwidth left unreserved.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">interval</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">branch</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">load</span> <span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">load</span> <span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="kt">int</span>	<span class="n">j</span><span class="p">;</span>

			<span class="cm">/* usb 1.1 says 90% of one frame */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NUM_INTS</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="n">interval</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">load</span> <span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">load</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">900</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">NUM_INTS</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">branch</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">branch</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* both iso and interrupt requests have periods; this routine puts them</span>
<span class="cm"> * into the schedule tree in the apppropriate place.  most iso devices use</span>
<span class="cm"> * 1msec periods, but that&#39;s not required.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">periodic_link</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ed</span> <span class="o">*</span><span class="n">ed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>	<span class="n">i</span><span class="p">;</span>

	<span class="n">ohci_vdbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;link %sed %p branch %d [%dus.], interval %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwINFO</span> <span class="o">&amp;</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_ISO</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;iso &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">ed</span><span class="p">,</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">,</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">,</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_INTS</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ed</span>	<span class="o">**</span><span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">periodic</span> <span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">__hc32</span>		<span class="o">*</span><span class="n">prev_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hcca</span><span class="o">-&gt;</span><span class="n">int_table</span> <span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">ed</span>	<span class="o">*</span><span class="n">here</span> <span class="o">=</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>

		<span class="cm">/* sorting each branch by period (slow before fast)</span>
<span class="cm">		 * lets us share the faster parts of the tree.</span>
<span class="cm">		 * (plus maybe: put interrupt eds before iso)</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">here</span> <span class="o">&amp;&amp;</span> <span class="n">ed</span> <span class="o">!=</span> <span class="n">here</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="n">here</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">here</span><span class="o">-&gt;</span><span class="n">ed_next</span><span class="p">;</span>
			<span class="n">prev_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">here</span><span class="o">-&gt;</span><span class="n">hwNextED</span><span class="p">;</span>
			<span class="n">here</span> <span class="o">=</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ed</span> <span class="o">!=</span> <span class="n">here</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_next</span> <span class="o">=</span> <span class="n">here</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">here</span><span class="p">)</span>
				<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwNextED</span> <span class="o">=</span> <span class="o">*</span><span class="n">prev_p</span><span class="p">;</span>
			<span class="n">wmb</span> <span class="p">();</span>
			<span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="n">ed</span><span class="p">;</span>
			<span class="o">*</span><span class="n">prev_p</span> <span class="o">=</span> <span class="n">cpu_to_hc32</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">load</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_allocated</span> <span class="o">+=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">load</span> <span class="o">/</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* link an ed into one of the HC chains */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ed_schedule</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ed</span> <span class="o">*</span><span class="n">ed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">branch</span><span class="p">;</span>

	<span class="n">ed</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ED_OPER</span><span class="p">;</span>
	<span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwNextED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quirk_zfmicro</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_INTERRUPT</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">eds_scheduled</span><span class="o">++</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">unlink_watchdog</span><span class="p">,</span> <span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">));</span>
	<span class="n">wmb</span> <span class="p">();</span>

	<span class="cm">/* we care about rm_list when setting CLE/BLE in case the HC was at</span>
<span class="cm">	 * work on some TD when CLE/BLE was turned off, and isn&#39;t quiesced</span>
<span class="cm">	 * yet.  finish_unlinks() restarts as needed, some upcoming INTR_SF.</span>
<span class="cm">	 *</span>
<span class="cm">	 * control and bulk EDs are doubly linked (ed_next, ed_prev), but</span>
<span class="cm">	 * periodic ones are singly linked (ed_next). that&#39;s because the</span>
<span class="cm">	 * periodic schedule encodes a tree like figure 3-5 in the ohci</span>
<span class="cm">	 * spec:  each qh can have several &quot;previous&quot; nodes, and the tree</span>
<span class="cm">	 * doesn&#39;t have unused/idle descriptors.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PIPE_CONTROL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_controltail</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;</span> <span class="n">OHCI_CTRL_CLE</span><span class="p">);</span>
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ed_controlhead</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_controltail</span><span class="o">-&gt;</span><span class="n">ed_next</span> <span class="o">=</span> <span class="n">ed</span><span class="p">;</span>
			<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_controltail</span><span class="o">-&gt;</span><span class="n">hwNextED</span> <span class="o">=</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span>
								<span class="n">ed</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span> <span class="o">=</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_controltail</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_controltail</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_rm_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">|=</span> <span class="n">OHCI_CTRL_CLE</span><span class="p">;</span>
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ed_controlcurrent</span><span class="p">);</span>
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_controltail</span> <span class="o">=</span> <span class="n">ed</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PIPE_BULK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_bulktail</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;</span> <span class="n">OHCI_CTRL_BLE</span><span class="p">);</span>
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ed_bulkhead</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_bulktail</span><span class="o">-&gt;</span><span class="n">ed_next</span> <span class="o">=</span> <span class="n">ed</span><span class="p">;</span>
			<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_bulktail</span><span class="o">-&gt;</span><span class="n">hwNextED</span> <span class="o">=</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span>
								<span class="n">ed</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span> <span class="o">=</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_bulktail</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_bulktail</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_rm_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">|=</span> <span class="n">OHCI_CTRL_BLE</span><span class="p">;</span>
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ed_bulkcurrent</span><span class="p">);</span>
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_bulktail</span> <span class="o">=</span> <span class="n">ed</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>case PIPE<em>INTERRUPT:
case PIPE</em>ISOCHRONOUS:</p></td><td class="code"><div class="highlight"><pre>	<span class="nl">default:</span>
		<span class="n">branch</span> <span class="o">=</span> <span class="n">balance</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">,</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">branch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ohci_dbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span>
				<span class="s">&quot;ERR %d, interval %d msecs, load %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">branch</span><span class="p">,</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">,</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>FIXME if there are TDs queued, fail them!</p></td><td class="code"><div class="highlight"><pre>			<span class="k">return</span> <span class="n">branch</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ed</span><span class="o">-&gt;</span><span class="n">branch</span> <span class="o">=</span> <span class="n">branch</span><span class="p">;</span>
		<span class="n">periodic_link</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* the HC may not see the schedule updates yet, but if it does</span>
<span class="cm">	 * then they&#39;ll be properly ordered.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* scan the periodic table to find and unlink this ED */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">periodic_unlink</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ed</span> <span class="o">*</span><span class="n">ed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_INTS</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ed</span>	<span class="o">*</span><span class="n">temp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ed</span>	<span class="o">**</span><span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">periodic</span> <span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">__hc32</span>		<span class="o">*</span><span class="n">prev_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hcca</span><span class="o">-&gt;</span><span class="n">int_table</span> <span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">prev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="o">*</span><span class="n">prev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prev_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">hwNextED</span><span class="p">;</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">ed_next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">prev_p</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwNextED</span><span class="p">;</span>
			<span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">load</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_allocated</span> <span class="o">-=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">load</span> <span class="o">/</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">;</span>

	<span class="n">ohci_vdbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;unlink %sed %p branch %d [%dus.], interval %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwINFO</span> <span class="o">&amp;</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_ISO</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;iso &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">ed</span><span class="p">,</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">,</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">,</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* unlink an ed from one of the HC chains.</span>
<span class="cm"> * just the link to the ed is unlinked.</span>
<span class="cm"> * the link from the ed still points to another operational ed or 0</span>
<span class="cm"> * so the HC can eventually finish the processing of the unlinked ed</span>
<span class="cm"> * (assuming it already started that, which needn&#39;t be true).</span>
<span class="cm"> *</span>
<span class="cm"> * ED_UNLINK is a transient state: the HC may still see this ED, but soon</span>
<span class="cm"> * it won&#39;t.  ED_SKIP means the HC will finish its current transaction,</span>
<span class="cm"> * but won&#39;t start anything new.  The TD queue may still grow; device</span>
<span class="cm"> * drivers don&#39;t know about this HCD-internal state.</span>
<span class="cm"> *</span>
<span class="cm"> * When the HC can&#39;t see the ED, something changes ED_UNLINK to one of:</span>
<span class="cm"> *</span>
<span class="cm"> *  - ED_OPER: when there&#39;s any request queued, the ED gets rescheduled</span>
<span class="cm"> *    immediately.  HC should be working on them.</span>
<span class="cm"> *</span>
<span class="cm"> *  - ED_IDLE:  when there&#39;s no TD queue. there&#39;s no reason for the HC</span>
<span class="cm"> *    to care about this ED; safe to disable the endpoint.</span>
<span class="cm"> *</span>
<span class="cm"> * When finish_unlinks() runs later, after SOF interrupt, it will often</span>
<span class="cm"> * complete one or more URB unlinks before making that state change.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ed_deschedule</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ed</span> <span class="o">*</span><span class="n">ed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwINFO</span> <span class="o">|=</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_SKIP</span><span class="p">);</span>
	<span class="n">wmb</span> <span class="p">();</span>
	<span class="n">ed</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ED_UNLINK</span><span class="p">;</span>

	<span class="cm">/* To deschedule something from the control or bulk list, just</span>
<span class="cm">	 * clear CLE/BLE and wait.  There&#39;s no safe way to scrub out list</span>
<span class="cm">	 * head/current registers until later, and &quot;later&quot; isn&#39;t very</span>
<span class="cm">	 * tightly specified.  Figure 6-5 and Section 6.4.2.2 show how</span>
<span class="cm">	 * the HC is reading the ED queues (while we modify them).</span>
<span class="cm">	 *</span>
<span class="cm">	 * For now, ed_schedule() is &quot;later&quot;.  It might be good paranoia</span>
<span class="cm">	 * to scrub those registers in finish_unlinks(), in case of bugs</span>
<span class="cm">	 * that make the HC try to use them.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PIPE_CONTROL</span>:
		<span class="cm">/* remove ED from the HC&#39;s list: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwNextED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OHCI_CTRL_CLE</span><span class="p">;</span>
				<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>a ohci_readl() later syncs CLE with the HC</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span>
					<span class="n">hc32_to_cpup</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwNextED</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ed_controlhead</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span><span class="o">-&gt;</span><span class="n">ed_next</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_next</span><span class="p">;</span>
			<span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span><span class="o">-&gt;</span><span class="n">hwNextED</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwNextED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* remove ED from the HCD&#39;s list: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_controltail</span> <span class="o">==</span> <span class="n">ed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_controltail</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_controltail</span><span class="p">)</span>
				<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_controltail</span><span class="o">-&gt;</span><span class="n">ed_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_next</span><span class="o">-&gt;</span><span class="n">ed_prev</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PIPE_BULK</span>:
		<span class="cm">/* remove ED from the HC&#39;s list: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwNextED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OHCI_CTRL_BLE</span><span class="p">;</span>
				<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>a ohci_readl() later syncs BLE with the HC</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span>
					<span class="n">hc32_to_cpup</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwNextED</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ed_bulkhead</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span><span class="o">-&gt;</span><span class="n">ed_next</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_next</span><span class="p">;</span>
			<span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span><span class="o">-&gt;</span><span class="n">hwNextED</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwNextED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* remove ED from the HCD&#39;s list: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_bulktail</span> <span class="o">==</span> <span class="n">ed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_bulktail</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_bulktail</span><span class="p">)</span>
				<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_bulktail</span><span class="o">-&gt;</span><span class="n">ed_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_next</span><span class="o">-&gt;</span><span class="n">ed_prev</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>case PIPE<em>INTERRUPT:
case PIPE</em>ISOCHRONOUS:</p></td><td class="code"><div class="highlight"><pre>	<span class="nl">default:</span>
		<span class="n">periodic_unlink</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* get and maybe (re)init an endpoint. init _should_ be done only as part</span>
<span class="cm"> * of enumeration, usb_set_configuration() or usb_set_interface().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ed</span> <span class="o">*</span><span class="nf">ed_get</span> <span class="p">(</span>
	<span class="k">struct</span> <span class="n">ohci_hcd</span>		<span class="o">*</span><span class="n">ohci</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">usb_device</span>	<span class="o">*</span><span class="n">udev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">pipe</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">interval</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ed</span>		<span class="o">*</span><span class="n">ed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ed</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">td</span>	<span class="o">*</span><span class="n">td</span><span class="p">;</span>
		<span class="kt">int</span>		<span class="n">is_out</span><span class="p">;</span>
		<span class="n">u32</span>		<span class="n">info</span><span class="p">;</span>

		<span class="n">ed</span> <span class="o">=</span> <span class="n">ed_alloc</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ed</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* out of memory */</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* dummy td; end of td list for ed */</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">td_alloc</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* out of memory */</span>
			<span class="n">ed_free</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ed</span><span class="p">);</span>
			<span class="n">ed</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ed</span><span class="o">-&gt;</span><span class="n">dummy</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
		<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwTailP</span> <span class="o">=</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">td_dma</span><span class="p">);</span>
		<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwHeadP</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwTailP</span><span class="p">;</span>	<span class="cm">/* ED_C, ED_H zeroed */</span>
		<span class="n">ed</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ED_IDLE</span><span class="p">;</span>

		<span class="n">is_out</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">);</span>

		<span class="cm">/* FIXME usbcore changes dev-&gt;devnum before SET_ADDRESS</span>
<span class="cm">		 * succeeds ... otherwise we wouldn&#39;t need &quot;pipe&quot;.</span>
<span class="cm">		 */</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">usb_pipedevice</span> <span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">ed</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">usb_pipetype</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

		<span class="n">info</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">info</span> <span class="o">|=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_LOW</span><span class="p">)</span>
			<span class="n">info</span> <span class="o">|=</span> <span class="n">ED_LOWSPEED</span><span class="p">;</span>
		<span class="cm">/* only control transfers store pids in tds */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PIPE_CONTROL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span> <span class="o">|=</span> <span class="n">is_out</span> <span class="o">?</span> <span class="n">ED_OUT</span> <span class="o">:</span> <span class="n">ED_IN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PIPE_BULK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* periodic transfers... */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_ISOCHRONOUS</span><span class="p">)</span>
					<span class="n">info</span> <span class="o">|=</span> <span class="n">ED_ISO</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>	<span class="cm">/* iso can be bigger */</span>
					<span class="n">interval</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
				<span class="n">ed</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
				<span class="n">ed</span><span class="o">-&gt;</span><span class="n">load</span> <span class="o">=</span> <span class="n">usb_calc_bus_time</span> <span class="p">(</span>
					<span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="o">!</span><span class="n">is_out</span><span class="p">,</span>
					<span class="n">ed</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_ISOCHRONOUS</span><span class="p">,</span>
					<span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">))</span>
						<span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwINFO</span> <span class="o">=</span> <span class="n">cpu_to_hc32</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="n">ed</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* request unlinking of an endpoint from an operational HC.</span>
<span class="cm"> * put the ep on the rm_list</span>
<span class="cm"> * real work is done at the next start frame (SF) hardware interrupt</span>
<span class="cm"> * caller guarantees HCD is running, so hardware access is safe,</span>
<span class="cm"> * and that ed-&gt;state is ED_OPER</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_ed_unlink</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ed</span> <span class="o">*</span><span class="n">ed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwINFO</span> <span class="o">|=</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_DEQUEUE</span><span class="p">);</span>
	<span class="n">ed_deschedule</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ed</span><span class="p">);</span>

	<span class="cm">/* rm_list is just singly linked, for simplicity */</span>
	<span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_next</span> <span class="o">=</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_rm_list</span><span class="p">;</span>
	<span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_rm_list</span> <span class="o">=</span> <span class="n">ed</span><span class="p">;</span>

	<span class="cm">/* enable SOF interrupt */</span>
	<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">OHCI_INTR_SF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intrstatus</span><span class="p">);</span>
	<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">OHCI_INTR_SF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intrenable</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>flush those writes, and get latest HCCA contents</p></td><td class="code"><div class="highlight"><pre>	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ohci_readl</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>

	<span class="cm">/* SF interrupt might get delayed; record the frame counter value that</span>
<span class="cm">	 * indicates when the HC isn&#39;t looking at it, so concurrent unlinks</span>
<span class="cm">	 * behave.  frame_no wraps every 2^16 msec, and changes right before</span>
<span class="cm">	 * SF is triggered.</span>
<span class="cm">	 */</span>
	<span class="n">ed</span><span class="o">-&gt;</span><span class="n">tick</span> <span class="o">=</span> <span class="n">ohci_frame_no</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*</span>
<span class="cm"> * TD handling functions</span>
<span class="cm"> *-------------------------------------------------------------------------*/</span>

<span class="cm">/* enqueue next TD for this URB (OHCI spec 5.2.8.2) */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">td_fill</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="n">u32</span> <span class="n">info</span><span class="p">,</span>
	<span class="n">dma_addr_t</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">td</span>		<span class="o">*</span><span class="n">td</span><span class="p">,</span> <span class="o">*</span><span class="n">td_pt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb_priv</span>		<span class="o">*</span><span class="n">urb_priv</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">is_iso</span> <span class="o">=</span> <span class="n">info</span> <span class="o">&amp;</span> <span class="n">TD_ISO</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">hash</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>ASSERT (index &lt; urb_priv->length);</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* aim for only one interrupt per urb.  mostly applies to control</span>
<span class="cm">	 * and iso; other urbs rarely need more than one TD per urb.</span>
<span class="cm">	 * this way, only final tds (or ones with an error) cause IRQs.</span>
<span class="cm">	 * at least immediately; use DI=6 in case any control request is</span>
<span class="cm">	 * tempted to die part way through.  (and to force the hc to flush</span>
<span class="cm">	 * its donelist soonish, even on unlink paths.)</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: could delay interrupts even for the last TD, and get fewer</span>
<span class="cm">	 * interrupts ... increasing per-urb latency by sharing interrupts.</span>
<span class="cm">	 * Drivers that queue bulk urbs may request that behavior.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="p">(</span><span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">&amp;</span> <span class="n">URB_NO_INTERRUPT</span><span class="p">))</span>
		<span class="n">info</span> <span class="o">|=</span> <span class="n">TD_DI_SET</span> <span class="p">(</span><span class="mi">6</span><span class="p">);</span>

	<span class="cm">/* use this td as the next dummy */</span>
	<span class="n">td_pt</span> <span class="o">=</span> <span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">td</span> <span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="cm">/* fill the old dummy TD */</span>
	<span class="n">td</span> <span class="o">=</span> <span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">td</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">dummy</span><span class="p">;</span>
	<span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">dummy</span> <span class="o">=</span> <span class="n">td_pt</span><span class="p">;</span>

	<span class="n">td</span><span class="o">-&gt;</span><span class="n">ed</span> <span class="o">=</span> <span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">ed</span><span class="p">;</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">next_dl_td</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span> <span class="o">=</span> <span class="n">urb</span><span class="p">;</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">data_dma</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">td</span><span class="o">-&gt;</span><span class="n">hwINFO</span> <span class="o">=</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_iso</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">hwCBP</span> <span class="o">=</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xFFFFF000</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ohci_hwPSWp</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_hc16</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span>
						<span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x0FFF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xE000</span><span class="p">);</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">last_iso</span> <span class="o">=</span> <span class="n">info</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">hwCBP</span> <span class="o">=</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">hwBE</span> <span class="o">=</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">hwBE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">hwNextTD</span> <span class="o">=</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">td_pt</span><span class="o">-&gt;</span><span class="n">td_dma</span><span class="p">);</span>

	<span class="cm">/* append to queue */</span>
	<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">td_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">td_list</span><span class="p">);</span>

	<span class="cm">/* hash it for later reverse mapping */</span>
	<span class="n">hash</span> <span class="o">=</span> <span class="n">TD_HASH_FUNC</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">td_dma</span><span class="p">);</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">td_hash</span> <span class="o">=</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">td_hash</span> <span class="p">[</span><span class="n">hash</span><span class="p">];</span>
	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">td_hash</span> <span class="p">[</span><span class="n">hash</span><span class="p">]</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>

	<span class="cm">/* HC might read the TD (or cachelines) right away ... */</span>
	<span class="n">wmb</span> <span class="p">();</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwTailP</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">hwNextTD</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* Prepare all TDs of a transfer, and queue them onto the ED.</span>
<span class="cm"> * Caller guarantees HC is active.</span>
<span class="cm"> * Usually the ED is already on the schedule, so TDs might be</span>
<span class="cm"> * processed as soon as they&#39;re queued.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">td_submit_urb</span> <span class="p">(</span>
	<span class="k">struct</span> <span class="n">ohci_hcd</span>	<span class="o">*</span><span class="n">ohci</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">urb</span>	<span class="o">*</span><span class="n">urb</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb_priv</span>	<span class="o">*</span><span class="n">urb_priv</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">data_len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">is_out</span> <span class="o">=</span> <span class="n">usb_pipeout</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">periodic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* OHCI handles the bulk/interrupt data toggles itself.  We just</span>
<span class="cm">	 * use the device toggle bits for resetting, and rely on the fact</span>
<span class="cm">	 * that resetting toggle is meaningless if the endpoint is active.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_gettoggle</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_pipeendpoint</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span> <span class="n">is_out</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usb_settoggle</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_pipeendpoint</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span>
			<span class="n">is_out</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwHeadP</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_C</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">td_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_add</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* NOTE:  TD_CC is set so we can tell which TDs the HC processed by</span>
<span class="cm">	 * using TD_CC_GET, as well as by seeing them on the done list.</span>
<span class="cm">	 * (CC = NotAccessed ... 0x0F, or 0x0E in PSWs for ISO.)</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>

	<span class="cm">/* Bulk and interrupt are identical except for where in the schedule</span>
<span class="cm">	 * their EDs live.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">PIPE_INTERRUPT</span>:
		<span class="cm">/* ... and periodic urbs have extra accounting */</span>
		<span class="n">periodic</span> <span class="o">=</span> <span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_int_reqs</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">&amp;&amp;</span> <span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_isoc_reqs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* FALLTHROUGH */</span>
	<span class="k">case</span> <span class="n">PIPE_BULK</span>:
		<span class="n">info</span> <span class="o">=</span> <span class="n">is_out</span>
			<span class="o">?</span> <span class="n">TD_T_TOGGLE</span> <span class="o">|</span> <span class="n">TD_CC</span> <span class="o">|</span> <span class="n">TD_DP_OUT</span>
			<span class="o">:</span> <span class="n">TD_T_TOGGLE</span> <span class="o">|</span> <span class="n">TD_CC</span> <span class="o">|</span> <span class="n">TD_DP_IN</span><span class="p">;</span>
		<span class="cm">/* TDs _could_ transfer up to 8K each */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">td_fill</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="mi">4096</span><span class="p">;</span>
			<span class="n">data_len</span> <span class="o">-=</span> <span class="mi">4096</span><span class="p">;</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* maybe avoid ED halt on final TD short read */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">&amp;</span> <span class="n">URB_SHORT_NOT_OK</span><span class="p">))</span>
			<span class="n">info</span> <span class="o">|=</span> <span class="n">TD_R</span><span class="p">;</span>
		<span class="n">td_fill</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">&amp;</span> <span class="n">URB_ZERO_PACKET</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">td_fill</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* maybe kickstart bulk list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_BULK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wmb</span> <span class="p">();</span>
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">OHCI_BLF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cmdstatus</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* control manages DATA0/DATA1 toggle per-request; SETUP resets it,</span>
<span class="cm">	 * any DATA phase works normally, and the STATUS ack is special.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">PIPE_CONTROL</span>:
		<span class="n">info</span> <span class="o">=</span> <span class="n">TD_CC</span> <span class="o">|</span> <span class="n">TD_DP_SETUP</span> <span class="o">|</span> <span class="n">TD_T_DATA0</span><span class="p">;</span>
		<span class="n">td_fill</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">setup_dma</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">cnt</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span> <span class="o">=</span> <span class="n">TD_CC</span> <span class="o">|</span> <span class="n">TD_R</span> <span class="o">|</span> <span class="n">TD_T_DATA1</span><span class="p">;</span>
			<span class="n">info</span> <span class="o">|=</span> <span class="n">is_out</span> <span class="o">?</span> <span class="n">TD_DP_OUT</span> <span class="o">:</span> <span class="n">TD_DP_IN</span><span class="p">;</span>
			<span class="cm">/* NOTE:  mishandles transfers &gt;8K, some &gt;4K */</span>
			<span class="n">td_fill</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">cnt</span><span class="o">++</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_out</span> <span class="o">||</span> <span class="n">data_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">?</span> <span class="n">TD_CC</span> <span class="o">|</span> <span class="n">TD_DP_IN</span> <span class="o">|</span> <span class="n">TD_T_DATA1</span>
			<span class="o">:</span> <span class="n">TD_CC</span> <span class="o">|</span> <span class="n">TD_DP_OUT</span> <span class="o">|</span> <span class="n">TD_T_DATA1</span><span class="p">;</span>
		<span class="n">td_fill</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">cnt</span><span class="o">++</span><span class="p">);</span>
		<span class="cm">/* maybe kickstart control list */</span>
		<span class="n">wmb</span> <span class="p">();</span>
		<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">OHCI_CLF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cmdstatus</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* ISO has no retransmit, so no toggle; and it uses special TDs.</span>
<span class="cm">	 * Each TD could handle multiple consecutive frames (interval 1);</span>
<span class="cm">	 * we could often reduce the number of TDs here.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">PIPE_ISOCHRONOUS</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span>	<span class="n">frame</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">start_frame</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>FIXME scheduling should handle frame counter
roll-around ... exotic case (and OHCI has
a 2^16 iso range, vs other HCs max of 2^10)</p></td><td class="code"><div class="highlight"><pre>			<span class="n">frame</span> <span class="o">+=</span> <span class="n">cnt</span> <span class="o">*</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">;</span>
			<span class="n">frame</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">td_fill</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">TD_CC</span> <span class="o">|</span> <span class="n">TD_ISO</span> <span class="o">|</span> <span class="n">frame</span><span class="p">,</span>
				<span class="n">data</span> <span class="o">+</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span> <span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span> <span class="p">[</span><span class="n">cnt</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_isoc_reqs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">quirk_amdiso</span><span class="p">(</span><span class="n">ohci</span><span class="p">))</span>
				<span class="n">usb_amd_quirk_pll_disable</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">quirk_amdprefetch</span><span class="p">(</span><span class="n">ohci</span><span class="p">))</span>
				<span class="n">sb800_prefetch</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">periodic</span> <span class="o">=</span> <span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_isoc_reqs</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">&amp;&amp;</span> <span class="n">ohci_to_hcd</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_int_reqs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* start periodic dma if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">periodic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wmb</span> <span class="p">();</span>
		<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">|=</span> <span class="n">OHCI_CTRL_PLE</span><span class="o">|</span><span class="n">OHCI_CTRL_IE</span><span class="p">;</span>
		<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>ASSERT (urb_priv->length == cnt);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*</span>
<span class="cm"> * Done List handling functions</span>
<span class="cm"> *-------------------------------------------------------------------------*/</span>

<span class="cm">/* calculate transfer length/status and update the urb */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">td_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">td</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">tdINFO</span> <span class="o">=</span> <span class="n">hc32_to_cpup</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">hwINFO</span><span class="p">);</span>
	<span class="kt">int</span>	<span class="n">cc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="n">list_del</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">td_list</span><span class="p">);</span>

	<span class="cm">/* ISO ... drivers see per-TD length/status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tdINFO</span> <span class="o">&amp;</span> <span class="n">TD_ISO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span>	<span class="n">tdPSW</span> <span class="o">=</span> <span class="n">ohci_hwPSW</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="kt">int</span>	<span class="n">dlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* NOTE:  assumes FC in tdINFO == 0, and that</span>
<span class="cm">		 * only the first of 0..MAXPSW psws is used.</span>
<span class="cm">		 */</span>

		<span class="n">cc</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdPSW</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tdINFO</span> <span class="o">&amp;</span> <span class="n">TD_CC</span><span class="p">)</span>	<span class="cm">/* hc didn&#39;t touch? */</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeout</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
			<span class="n">dlen</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span> <span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* short reads are always OK for ISO */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">==</span> <span class="n">TD_DATAUNDERRUN</span><span class="p">)</span>
				<span class="n">cc</span> <span class="o">=</span> <span class="n">TD_CC_NOERROR</span><span class="p">;</span>
			<span class="n">dlen</span> <span class="o">=</span> <span class="n">tdPSW</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">dlen</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span> <span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">actual_length</span> <span class="o">=</span> <span class="n">dlen</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span> <span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">cc_to_error</span> <span class="p">[</span><span class="n">cc</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">!=</span> <span class="n">TD_CC_NOERROR</span><span class="p">)</span>
			<span class="n">ohci_vdbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span>
				<span class="s">&quot;urb %p iso td %p (%d) len %d cc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">urb</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">cc</span><span class="p">);</span>

	<span class="cm">/* BULK, INT, CONTROL ... drivers see aggregate length/status,</span>
<span class="cm">	 * except that &quot;setup&quot; bytes aren&#39;t counted and &quot;short&quot; transfers</span>
<span class="cm">	 * might not be reported as errors.</span>
<span class="cm">	 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">type</span> <span class="o">=</span> <span class="n">usb_pipetype</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">u32</span>	<span class="n">tdBE</span> <span class="o">=</span> <span class="n">hc32_to_cpup</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">hwBE</span><span class="p">);</span>

		<span class="n">cc</span> <span class="o">=</span> <span class="n">TD_CC_GET</span> <span class="p">(</span><span class="n">tdINFO</span><span class="p">);</span>

		<span class="cm">/* update packet status if needed (short is normally ok) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">==</span> <span class="n">TD_DATAUNDERRUN</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">&amp;</span> <span class="n">URB_SHORT_NOT_OK</span><span class="p">))</span>
			<span class="n">cc</span> <span class="o">=</span> <span class="n">TD_CC_NOERROR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">!=</span> <span class="n">TD_CC_NOERROR</span> <span class="o">&amp;&amp;</span> <span class="n">cc</span> <span class="o">&lt;</span> <span class="mh">0x0E</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cc_to_error</span><span class="p">[</span><span class="n">cc</span><span class="p">];</span>

		<span class="cm">/* count all non-empty packets except control SETUP packet */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PIPE_CONTROL</span> <span class="o">||</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tdBE</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">hwCBP</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">tdBE</span> <span class="o">-</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">data_dma</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span>
					  <span class="n">hc32_to_cpup</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">hwCBP</span><span class="p">)</span>
					<span class="o">-</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">data_dma</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">!=</span> <span class="n">TD_CC_NOERROR</span> <span class="o">&amp;&amp;</span> <span class="n">cc</span> <span class="o">&lt;</span> <span class="mh">0x0E</span><span class="p">)</span>
			<span class="n">ohci_vdbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span>
				<span class="s">&quot;urb %p td %p (%d) cc %d, len=%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">urb</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ed_halted</span><span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">td</span> <span class="o">*</span><span class="n">td</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">;</span>
	<span class="n">urb_priv_t</span>		<span class="o">*</span><span class="n">urb_priv</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ed</span>		<span class="o">*</span><span class="n">ed</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">ed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">td_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="n">__hc32</span>			<span class="n">toggle</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwHeadP</span> <span class="o">&amp;</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_C</span><span class="p">);</span>

	<span class="cm">/* clear ed halt; this is the td that caused it, but keep it inactive</span>
<span class="cm">	 * until its urb-&gt;complete() has a chance to clean up.</span>
<span class="cm">	 */</span>
	<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwINFO</span> <span class="o">|=</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_SKIP</span><span class="p">);</span>
	<span class="n">wmb</span> <span class="p">();</span>
	<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwHeadP</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_H</span><span class="p">);</span>

	<span class="cm">/* Get rid of all later tds from this urb.  We don&#39;t have</span>
<span class="cm">	 * to be careful: no errors and nothing was transferred.</span>
<span class="cm">	 * Also patch the ed so it looks as if those tds completed normally.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">td_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">td</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>

		<span class="n">next</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">td</span><span class="p">,</span> <span class="n">td_list</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">td_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">urb</span> <span class="o">!=</span> <span class="n">urb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* NOTE: if multi-td control DATA segments get supported,</span>
<span class="cm">		 * this urb had one of them, this td wasn&#39;t the last td</span>
<span class="cm">		 * in that segment (TD_R clear), this ed halted because</span>
<span class="cm">		 * of a short read, _and_ URB_SHORT_NOT_OK is clear ...</span>
<span class="cm">		 * then we need to leave the control STATUS packet queued</span>
<span class="cm">		 * and clear ED_SKIP.</span>
<span class="cm">		 */</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">td_list</span><span class="p">);</span>
		<span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">td_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwHeadP</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">hwNextTD</span> <span class="o">|</span> <span class="n">toggle</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* help for troubleshooting:  report anything that</span>
<span class="cm">	 * looks odd ... that doesn&#39;t include protocol stalls</span>
<span class="cm">	 * (or maybe some other things)</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TD_DATAUNDERRUN</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">&amp;</span> <span class="n">URB_SHORT_NOT_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">TD_CC_STALL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* fallthrough */</span>
	<span class="nl">default:</span>
		<span class="n">ohci_dbg</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span>
			<span class="s">&quot;urb %p path %s ep%d%s %08x cc %d --&gt; status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">urb</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devpath</span><span class="p">,</span>
			<span class="n">usb_pipeendpoint</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span>
			<span class="n">usb_pipein</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">,</span>
			<span class="n">hc32_to_cpu</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">hwINFO</span><span class="p">),</span>
			<span class="n">cc</span><span class="p">,</span> <span class="n">cc_to_error</span> <span class="p">[</span><span class="n">cc</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* replies to the request have to be on a FIFO basis so</span>
<span class="cm"> * we unreverse the hc-reversed done-list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">td</span> <span class="o">*</span><span class="nf">dl_reverse_done_list</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>		<span class="n">td_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">td</span>	<span class="o">*</span><span class="n">td_rev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">td</span>	<span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">td_dma</span> <span class="o">=</span> <span class="n">hc32_to_cpup</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hcca</span><span class="o">-&gt;</span><span class="n">done_head</span><span class="p">);</span>
	<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hcca</span><span class="o">-&gt;</span><span class="n">done_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* get TD from hc&#39;s singly linked list, and</span>
<span class="cm">	 * prepend to ours.  ed-&gt;td_list changes later.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">td_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>		<span class="n">cc</span><span class="p">;</span>

		<span class="n">td</span> <span class="o">=</span> <span class="n">dma_to_td</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">td_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ohci_err</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="s">&quot;bad entry %8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">td_dma</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">td</span><span class="o">-&gt;</span><span class="n">hwINFO</span> <span class="o">|=</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">TD_DONE</span><span class="p">);</span>
		<span class="n">cc</span> <span class="o">=</span> <span class="n">TD_CC_GET</span> <span class="p">(</span><span class="n">hc32_to_cpup</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">hwINFO</span><span class="p">));</span>

		<span class="cm">/* Non-iso endpoints can halt on error; un-halt,</span>
<span class="cm">		 * and dequeue any other TDs from this urb.</span>
<span class="cm">		 * No other TD could have caused the halt.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">!=</span> <span class="n">TD_CC_NOERROR</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwHeadP</span> <span class="o">&amp;</span> <span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_H</span><span class="p">)))</span>
			<span class="n">ed_halted</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">cc</span><span class="p">);</span>

		<span class="n">td</span><span class="o">-&gt;</span><span class="n">next_dl_td</span> <span class="o">=</span> <span class="n">td_rev</span><span class="p">;</span>
		<span class="n">td_rev</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
		<span class="n">td_dma</span> <span class="o">=</span> <span class="n">hc32_to_cpup</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">hwNextTD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">td_rev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* there are some urbs/eds to unlink; called in_irq(), with HCD locked */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">finish_unlinks</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tick</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ed</span>	<span class="o">*</span><span class="n">ed</span><span class="p">,</span> <span class="o">**</span><span class="n">last</span><span class="p">;</span>

<span class="nl">rescan_all:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">last</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_rm_list</span><span class="p">,</span> <span class="n">ed</span> <span class="o">=</span> <span class="o">*</span><span class="n">last</span><span class="p">;</span> <span class="n">ed</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">ed</span> <span class="o">=</span> <span class="o">*</span><span class="n">last</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
		<span class="kt">int</span>			<span class="n">completed</span><span class="p">,</span> <span class="n">modified</span><span class="p">;</span>
		<span class="n">__hc32</span>			<span class="o">*</span><span class="n">prev</span><span class="p">;</span>

		<span class="cm">/* only take off EDs that the HC isn&#39;t using, accounting for</span>
<span class="cm">		 * frame counter wraps and EDs with partially retired TDs</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">==</span> <span class="n">OHCI_RH_RUNNING</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tick_before</span> <span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">tick</span><span class="p">))</span> <span class="p">{</span>
<span class="nl">skip_ed:</span>
				<span class="n">last</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_next</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">td_list</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">td</span>	<span class="o">*</span><span class="n">td</span><span class="p">;</span>
				<span class="n">u32</span>		<span class="n">head</span><span class="p">;</span>

				<span class="n">td</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">td_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">td</span><span class="p">,</span>
							<span class="n">td_list</span><span class="p">);</span>
				<span class="n">head</span> <span class="o">=</span> <span class="n">hc32_to_cpu</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwHeadP</span><span class="p">)</span> <span class="o">&amp;</span>
								<span class="n">TD_MASK</span><span class="p">;</span>

				<span class="cm">/* INTR_WDH may need to clean up first */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">td_dma</span> <span class="o">!=</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ed</span> <span class="o">==</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_to_check</span><span class="p">)</span>
						<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_to_check</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="k">goto</span> <span class="n">skip_ed</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* reentrancy:  if we drop the schedule lock, someone might</span>
<span class="cm">		 * have modified this list.  normally it&#39;s just prepending</span>
<span class="cm">		 * entries (which we&#39;d ignore), but paranoia won&#39;t hurt.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">last</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_next</span><span class="p">;</span>
		<span class="n">ed</span><span class="o">-&gt;</span><span class="n">ed_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">modified</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* unlink urbs as requested, but rescan the list after</span>
<span class="cm">		 * we call a completion since it might have unlinked</span>
<span class="cm">		 * another (earlier) urb</span>
<span class="cm">		 *</span>
<span class="cm">		 * When we get here, the HC doesn&#39;t see this ed.  But it</span>
<span class="cm">		 * must not be rescheduled until all completed URBs have</span>
<span class="cm">		 * been given back to the driver.</span>
<span class="cm">		 */</span>
<span class="nl">rescan_this:</span>
		<span class="n">completed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwHeadP</span><span class="p">;</span>
		<span class="n">list_for_each_safe</span> <span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">td_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">td</span>	<span class="o">*</span><span class="n">td</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">urb</span>	<span class="o">*</span><span class="n">urb</span><span class="p">;</span>
			<span class="n">urb_priv_t</span>	<span class="o">*</span><span class="n">urb_priv</span><span class="p">;</span>
			<span class="n">__hc32</span>		<span class="n">savebits</span><span class="p">;</span>
			<span class="n">u32</span>		<span class="n">tdINFO</span><span class="p">;</span>

			<span class="n">td</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">td</span><span class="p">,</span> <span class="n">td_list</span><span class="p">);</span>
			<span class="n">urb</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">;</span>
			<span class="n">urb_priv</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">unlinked</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">hwNextTD</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* patch pointer hc uses */</span>
			<span class="n">savebits</span> <span class="o">=</span> <span class="o">*</span><span class="n">prev</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">TD_MASK</span><span class="p">);</span>
			<span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">hwNextTD</span> <span class="o">|</span> <span class="n">savebits</span><span class="p">;</span>

			<span class="cm">/* If this was unlinked, the TD may not have been</span>
<span class="cm">			 * retired ... so manually save the data toggle.</span>
<span class="cm">			 * The controller ignores the value we save for</span>
<span class="cm">			 * control and ISO endpoints.</span>
<span class="cm">			 */</span>
			<span class="n">tdINFO</span> <span class="o">=</span> <span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">hwINFO</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tdINFO</span> <span class="o">&amp;</span> <span class="n">TD_T</span><span class="p">)</span> <span class="o">==</span> <span class="n">TD_T_DATA0</span><span class="p">)</span>
				<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwHeadP</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_hc32</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_C</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tdINFO</span> <span class="o">&amp;</span> <span class="n">TD_T</span><span class="p">)</span> <span class="o">==</span> <span class="n">TD_T_DATA1</span><span class="p">)</span>
				<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwHeadP</span> <span class="o">|=</span> <span class="n">cpu_to_hc32</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_C</span><span class="p">);</span>

			<span class="cm">/* HC may have partly processed this TD */</span>
			<span class="n">td_done</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
			<span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">td_cnt</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* if URB is done, clean up */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">td_cnt</span> <span class="o">==</span> <span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">modified</span> <span class="o">=</span> <span class="n">completed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">finish_urb</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">completed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">td_list</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">rescan_this</span><span class="p">;</span>

		<span class="cm">/* ED&#39;s now officially unlinked, hc doesn&#39;t see */</span>
		<span class="n">ed</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ED_IDLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">quirk_zfmicro</span><span class="p">(</span><span class="n">ohci</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_INTERRUPT</span><span class="p">)</span>
			<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">eds_scheduled</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwHeadP</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_hc32</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_H</span><span class="p">);</span>
		<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwNextED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wmb</span> <span class="p">();</span>
		<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwINFO</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_hc32</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_SKIP</span> <span class="o">|</span> <span class="n">ED_DEQUEUE</span><span class="p">);</span>

		<span class="cm">/* but if there&#39;s work queued, reschedule */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">td_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">==</span> <span class="n">OHCI_RH_RUNNING</span><span class="p">)</span>
				<span class="n">ed_schedule</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ed</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">modified</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">rescan_all</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* maybe reenable control and bulk lists */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">rh_state</span> <span class="o">==</span> <span class="n">OHCI_RH_RUNNING</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_rm_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span>	<span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_controltail</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">command</span> <span class="o">|=</span> <span class="n">OHCI_CLF</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">quirk_zfmicro</span><span class="p">(</span><span class="n">ohci</span><span class="p">))</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;</span> <span class="n">OHCI_CTRL_CLE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">control</span> <span class="o">|=</span> <span class="n">OHCI_CTRL_CLE</span><span class="p">;</span>
				<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ed_controlcurrent</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">ed_bulktail</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">command</span> <span class="o">|=</span> <span class="n">OHCI_BLF</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">quirk_zfmicro</span><span class="p">(</span><span class="n">ohci</span><span class="p">))</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;</span> <span class="n">OHCI_CTRL_BLE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">control</span> <span class="o">|=</span> <span class="n">OHCI_CTRL_BLE</span><span class="p">;</span>
				<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ed_bulkcurrent</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* CLE/BLE to enable, CLF/BLF to (maybe) kickstart */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">|=</span> <span class="n">control</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">quirk_zfmicro</span><span class="p">(</span><span class="n">ohci</span><span class="p">))</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ohci</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">quirk_zfmicro</span><span class="p">(</span><span class="n">ohci</span><span class="p">))</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">ohci_writel</span> <span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cmdstatus</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * Used to take back a TD from the host controller. This would normally be</span>
<span class="cm"> * called from within dl_done_list, however it may be called directly if the</span>
<span class="cm"> * HC no longer sees the TD and it has not appeared on the donelist (after</span>
<span class="cm"> * two frames).  This bug has been observed on ZF Micro systems.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">takeback_td</span><span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">td</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span>	<span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">;</span>
	<span class="n">urb_priv_t</span>	<span class="o">*</span><span class="n">urb_priv</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ed</span>	<span class="o">*</span><span class="n">ed</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">ed</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span><span class="p">;</span>

	<span class="cm">/* update URB&#39;s length and status from TD */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">td_done</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
	<span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">td_cnt</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* If all this urb&#39;s TDs are done, call complete() */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">td_cnt</span> <span class="o">==</span> <span class="n">urb_priv</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="n">finish_urb</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="cm">/* clean schedule:  unlink EDs that are no longer busy */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">td_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ED_OPER</span><span class="p">)</span>
			<span class="n">start_ed_unlink</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ed</span><span class="p">);</span>

	<span class="cm">/* ... reenabling halted EDs only after fault cleanup */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwINFO</span> <span class="o">&amp;</span> <span class="n">cpu_to_hc32</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_SKIP</span> <span class="o">|</span> <span class="n">ED_DEQUEUE</span><span class="p">))</span>
			<span class="o">==</span> <span class="n">cpu_to_hc32</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_SKIP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">td_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">td</span><span class="p">,</span> <span class="n">td_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">hwINFO</span> <span class="o">&amp;</span> <span class="n">cpu_to_hc32</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">TD_DONE</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ed</span><span class="o">-&gt;</span><span class="n">hwINFO</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_hc32</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">ED_SKIP</span><span class="p">);</span>
			<span class="cm">/* ... hc may need waking-up */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PIPE_CONTROL</span>:
				<span class="n">ohci_writel</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">OHCI_CLF</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cmdstatus</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PIPE_BULK</span>:
				<span class="n">ohci_writel</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">OHCI_BLF</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ohci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cmdstatus</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process normal completions (error or success) and clean the schedules.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the main path for handing urbs back to drivers.  The only other</span>
<span class="cm"> * normal path is finish_unlinks(), which unlinks URBs using ed_rm_list,</span>
<span class="cm"> * instead of scanning the (re-reversed) donelist as this does.  There&#39;s</span>
<span class="cm"> * an abnormal path too, handling a quirk in some Compaq silicon:  URBs</span>
<span class="cm"> * with TDs that appear to be orphaned are directly reclaimed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dl_done_list</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ohci_hcd</span> <span class="o">*</span><span class="n">ohci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">td</span>	<span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="n">dl_reverse_done_list</span> <span class="p">(</span><span class="n">ohci</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">td</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">td</span>	<span class="o">*</span><span class="n">td_next</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">next_dl_td</span><span class="p">;</span>
		<span class="n">takeback_td</span><span class="p">(</span><span class="n">ohci</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">td_next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
