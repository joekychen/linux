<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › host › isp1362.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>isp1362.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ISP1362 HCD (Host Controller Driver) for USB.</span>
<span class="cm"> *</span>
<span class="cm"> * COPYRIGHT (C) by L. Wassmann &lt;LW@KARO-electronics.de&gt;</span>
<span class="cm"> */</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>
<span class="cm">/*</span>
<span class="cm"> * Platform specific compile time options</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_BLACKFIN)</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#define USE_32BIT		0</span>
<span class="cp">#define MAX_ROOT_PORTS		2</span>
<span class="cp">#define USE_PLATFORM_DELAY	0</span>
<span class="cp">#define USE_NDELAY		1</span>

<span class="cp">#define DUMMY_DELAY_ACCESS \</span>
<span class="cp">	do { \</span>
<span class="cp">		bfin_read16(ASYNC_BANK0_BASE); \</span>
<span class="cp">		bfin_read16(ASYNC_BANK0_BASE); \</span>
<span class="cp">		bfin_read16(ASYNC_BANK0_BASE); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#undef insw</span>
<span class="cp">#undef outsw</span>

<span class="cp">#define insw  delayed_insw</span>
<span class="cp">#define outsw  delayed_outsw</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">delayed_outsw</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DUMMY_DELAY_ACCESS</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">++</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">delayed_insw</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DUMMY_DELAY_ACCESS</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define MAX_ROOT_PORTS		2</span>

<span class="cp">#define USE_32BIT		0</span>

<span class="cm">/* These options are mutually eclusive */</span>
<span class="cp">#define USE_PLATFORM_DELAY	0</span>
<span class="cp">#define USE_NDELAY		0</span>

<span class="cp">#define DUMMY_DELAY_ACCESS do {} while (0)</span>

<span class="cp">#endif</span>


<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="cp">#define USB_RESET_WIDTH			50</span>
<span class="cp">#define MAX_XFER_SIZE			1023</span>

<span class="cm">/* Buffer sizes */</span>
<span class="cp">#define ISP1362_BUF_SIZE		4096</span>
<span class="cp">#define ISP1362_ISTL_BUFSIZE		512</span>
<span class="cp">#define ISP1362_INTL_BLKSIZE		64</span>
<span class="cp">#define ISP1362_INTL_BUFFERS		16</span>
<span class="cp">#define ISP1362_ATL_BLKSIZE		64</span>

<span class="cp">#define ISP1362_REG_WRITE_OFFSET	0x80</span>

<span class="cp">#ifdef ISP1362_DEBUG</span>
<span class="k">typedef</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">isp1362_reg_t</span><span class="p">;</span>

<span class="cp">#define REG_WIDTH_16			0x000</span>
<span class="cp">#define REG_WIDTH_32			0x100</span>
<span class="cp">#define REG_WIDTH_MASK			0x100</span>
<span class="cp">#define REG_NO_MASK			0x0ff</span>

<span class="cp">#define REG_ACCESS_R			0x200</span>
<span class="cp">#define REG_ACCESS_W			0x400</span>
<span class="cp">#define REG_ACCESS_RW			0x600</span>
<span class="cp">#define REG_ACCESS_MASK			0x600</span>

<span class="cp">#define ISP1362_REG_NO(r)		((r) &amp; REG_NO_MASK)</span>

<span class="cp">#define _BUG_ON(x)	BUG_ON(x)</span>
<span class="cp">#define _WARN_ON(x)	WARN_ON(x)</span>

<span class="cp">#define ISP1362_REG(name, addr, width, rw) \</span>
<span class="cp">static isp1362_reg_t ISP1362_REG_##name = ((addr) | (width) | (rw))</span>

<span class="cp">#define REG_ACCESS_TEST(r)   BUG_ON(((r) &amp; ISP1362_REG_WRITE_OFFSET) &amp;&amp; !((r) &amp; REG_ACCESS_W))</span>
<span class="cp">#define REG_WIDTH_TEST(r, w) BUG_ON(((r) &amp; REG_WIDTH_MASK) != (w))</span>
<span class="cp">#else</span>
<span class="k">typedef</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">isp1362_reg_t</span><span class="p">;</span>
<span class="cp">#define ISP1362_REG_NO(r)		(r)</span>
<span class="cp">#define _BUG_ON(x)			do {} while (0)</span>
<span class="cp">#define _WARN_ON(x)			do {} while (0)</span>

<span class="cp">#define ISP1362_REG(name, addr, width, rw) \</span>
<span class="cp">static isp1362_reg_t ISP1362_REG_##name = addr</span>

<span class="cp">#define REG_ACCESS_TEST(r)		do {} while (0)</span>
<span class="cp">#define REG_WIDTH_TEST(r, w)		do {} while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/* OHCI compatible registers */</span>
<span class="cm">/*</span>
<span class="cm"> * Note: Some of the ISP1362 &#39;OHCI&#39; registers implement only</span>
<span class="cm"> * a subset of the bits defined in the OHCI spec.</span>
<span class="cm"> *</span>
<span class="cm"> * Bitmasks for the individual bits of these registers are defined in &quot;ohci.h&quot;</span>
<span class="cm"> */</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCREVISION</span><span class="p">,</span>	<span class="mh">0x00</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_R</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCCONTROL</span><span class="p">,</span>	<span class="mh">0x01</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCCMDSTAT</span><span class="p">,</span>	<span class="mh">0x02</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCINTSTAT</span><span class="p">,</span>	<span class="mh">0x03</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCINTENB</span><span class="p">,</span>	<span class="mh">0x04</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCINTDIS</span><span class="p">,</span>	<span class="mh">0x05</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCFMINTVL</span><span class="p">,</span>	<span class="mh">0x0d</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCFMREM</span><span class="p">,</span>	<span class="mh">0x0e</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCFMNUM</span><span class="p">,</span>	<span class="mh">0x0f</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCLSTHRESH</span><span class="p">,</span>	<span class="mh">0x11</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCRHDESCA</span><span class="p">,</span>	<span class="mh">0x12</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCRHDESCB</span><span class="p">,</span>	<span class="mh">0x13</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCRHSTATUS</span><span class="p">,</span>	<span class="mh">0x14</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCRHPORT1</span><span class="p">,</span>	<span class="mh">0x15</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCRHPORT2</span><span class="p">,</span>	<span class="mh">0x16</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>

<span class="cm">/* Philips ISP1362 specific registers */</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCHWCFG</span><span class="p">,</span>	<span class="mh">0x20</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="cp">#define HCHWCFG_DISABLE_SUSPEND	(1 &lt;&lt; 15)</span>
<span class="cp">#define HCHWCFG_GLOBAL_PWRDOWN	(1 &lt;&lt; 14)</span>
<span class="cp">#define HCHWCFG_PULLDOWN_DS2	(1 &lt;&lt; 13)</span>
<span class="cp">#define HCHWCFG_PULLDOWN_DS1	(1 &lt;&lt; 12)</span>
<span class="cp">#define HCHWCFG_CLKNOTSTOP	(1 &lt;&lt; 11)</span>
<span class="cp">#define HCHWCFG_ANALOG_OC	(1 &lt;&lt; 10)</span>
<span class="cp">#define HCHWCFG_ONEINT		(1 &lt;&lt; 9)</span>
<span class="cp">#define HCHWCFG_DACK_MODE	(1 &lt;&lt; 8)</span>
<span class="cp">#define HCHWCFG_ONEDMA		(1 &lt;&lt; 7)</span>
<span class="cp">#define HCHWCFG_DACK_POL	(1 &lt;&lt; 6)</span>
<span class="cp">#define HCHWCFG_DREQ_POL	(1 &lt;&lt; 5)</span>
<span class="cp">#define HCHWCFG_DBWIDTH_MASK	(0x03 &lt;&lt; 3)</span>
<span class="cp">#define HCHWCFG_DBWIDTH(n)	(((n) &lt;&lt; 3) &amp; HCHWCFG_DBWIDTH_MASK)</span>
<span class="cp">#define HCHWCFG_INT_POL		(1 &lt;&lt; 2)</span>
<span class="cp">#define HCHWCFG_INT_TRIGGER	(1 &lt;&lt; 1)</span>
<span class="cp">#define HCHWCFG_INT_ENABLE	(1 &lt;&lt; 0)</span>

<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCDMACFG</span><span class="p">,</span>	<span class="mh">0x21</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="cp">#define HCDMACFG_CTR_ENABLE	(1 &lt;&lt; 7)</span>
<span class="cp">#define HCDMACFG_BURST_LEN_MASK	(0x03 &lt;&lt; 5)</span>
<span class="cp">#define HCDMACFG_BURST_LEN(n)	(((n) &lt;&lt; 5) &amp; HCDMACFG_BURST_LEN_MASK)</span>
<span class="cp">#define HCDMACFG_BURST_LEN_1	HCDMACFG_BURST_LEN(0)</span>
<span class="cp">#define HCDMACFG_BURST_LEN_4	HCDMACFG_BURST_LEN(1)</span>
<span class="cp">#define HCDMACFG_BURST_LEN_8	HCDMACFG_BURST_LEN(2)</span>
<span class="cp">#define HCDMACFG_DMA_ENABLE	(1 &lt;&lt; 4)</span>
<span class="cp">#define HCDMACFG_BUF_TYPE_MASK	(0x07 &lt;&lt; 1)</span>
<span class="cp">#define HCDMACFG_BUF_TYPE(n)	(((n) &lt;&lt; 1) &amp; HCDMACFG_BUF_TYPE_MASK)</span>
<span class="cp">#define HCDMACFG_BUF_ISTL0	HCDMACFG_BUF_TYPE(0)</span>
<span class="cp">#define HCDMACFG_BUF_ISTL1	HCDMACFG_BUF_TYPE(1)</span>
<span class="cp">#define HCDMACFG_BUF_INTL	HCDMACFG_BUF_TYPE(2)</span>
<span class="cp">#define HCDMACFG_BUF_ATL	HCDMACFG_BUF_TYPE(3)</span>
<span class="cp">#define HCDMACFG_BUF_DIRECT	HCDMACFG_BUF_TYPE(4)</span>
<span class="cp">#define HCDMACFG_DMA_RW_SELECT	(1 &lt;&lt; 0)</span>

<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCXFERCTR</span><span class="p">,</span>	<span class="mh">0x22</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>

<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCuPINT</span><span class="p">,</span>	<span class="mh">0x24</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="cp">#define HCuPINT_SOF		(1 &lt;&lt; 0)</span>
<span class="cp">#define HCuPINT_ISTL0		(1 &lt;&lt; 1)</span>
<span class="cp">#define HCuPINT_ISTL1		(1 &lt;&lt; 2)</span>
<span class="cp">#define HCuPINT_EOT		(1 &lt;&lt; 3)</span>
<span class="cp">#define HCuPINT_OPR		(1 &lt;&lt; 4)</span>
<span class="cp">#define HCuPINT_SUSP		(1 &lt;&lt; 5)</span>
<span class="cp">#define HCuPINT_CLKRDY		(1 &lt;&lt; 6)</span>
<span class="cp">#define HCuPINT_INTL		(1 &lt;&lt; 7)</span>
<span class="cp">#define HCuPINT_ATL		(1 &lt;&lt; 8)</span>
<span class="cp">#define HCuPINT_OTG		(1 &lt;&lt; 9)</span>

<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCuPINTENB</span><span class="p">,</span>	<span class="mh">0x25</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="cm">/* same bit definitions apply as for HCuPINT */</span>

<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCCHIPID</span><span class="p">,</span>	<span class="mh">0x27</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_R</span><span class="p">);</span>
<span class="cp">#define HCCHIPID_MASK		0xff00</span>
<span class="cp">#define HCCHIPID_MAGIC		0x3600</span>

<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCSCRATCH</span><span class="p">,</span>	<span class="mh">0x28</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>

<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCSWRES</span><span class="p">,</span>	<span class="mh">0x29</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_W</span><span class="p">);</span>
<span class="cp">#define HCSWRES_MAGIC		0x00f6</span>

<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCBUFSTAT</span><span class="p">,</span>	<span class="mh">0x2c</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="cp">#define HCBUFSTAT_ISTL0_FULL	(1 &lt;&lt; 0)</span>
<span class="cp">#define HCBUFSTAT_ISTL1_FULL	(1 &lt;&lt; 1)</span>
<span class="cp">#define HCBUFSTAT_INTL_ACTIVE	(1 &lt;&lt; 2)</span>
<span class="cp">#define HCBUFSTAT_ATL_ACTIVE	(1 &lt;&lt; 3)</span>
<span class="cp">#define HCBUFSTAT_RESET_HWPP	(1 &lt;&lt; 4)</span>
<span class="cp">#define HCBUFSTAT_ISTL0_ACTIVE	(1 &lt;&lt; 5)</span>
<span class="cp">#define HCBUFSTAT_ISTL1_ACTIVE	(1 &lt;&lt; 6)</span>
<span class="cp">#define HCBUFSTAT_ISTL0_DONE	(1 &lt;&lt; 8)</span>
<span class="cp">#define HCBUFSTAT_ISTL1_DONE	(1 &lt;&lt; 9)</span>
<span class="cp">#define HCBUFSTAT_PAIRED_PTDPP	(1 &lt;&lt; 10)</span>

<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCDIRADDR</span><span class="p">,</span>	<span class="mh">0x32</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="cp">#define HCDIRADDR_ADDR_MASK	0x0000ffff</span>
<span class="cp">#define HCDIRADDR_ADDR(n)	(((n) &lt;&lt; 0) &amp; HCDIRADDR_ADDR_MASK)</span>
<span class="cp">#define HCDIRADDR_COUNT_MASK	0xffff0000</span>
<span class="cp">#define HCDIRADDR_COUNT(n)	(((n) &lt;&lt; 16) &amp; HCDIRADDR_COUNT_MASK)</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCDIRDATA</span><span class="p">,</span>	<span class="mh">0x45</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>

<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCISTLBUFSZ</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCISTL0PORT</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCISTL1PORT</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCISTLRATE</span><span class="p">,</span>	<span class="mh">0x47</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>

<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCINTLBUFSZ</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCINTLPORT</span><span class="p">,</span>	<span class="mh">0x43</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCINTLBLKSZ</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCINTLDONE</span><span class="p">,</span>	<span class="mh">0x17</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_R</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCINTLSKIP</span><span class="p">,</span>	<span class="mh">0x18</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCINTLLAST</span><span class="p">,</span>	<span class="mh">0x19</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCINTLCURR</span><span class="p">,</span>	<span class="mh">0x1a</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_R</span><span class="p">);</span>

<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCATLBUFSZ</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCATLPORT</span><span class="p">,</span>	<span class="mh">0x44</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCATLBLKSZ</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCATLDONE</span><span class="p">,</span>	<span class="mh">0x1b</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_R</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCATLSKIP</span><span class="p">,</span>	<span class="mh">0x1c</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCATLLAST</span><span class="p">,</span>	<span class="mh">0x1d</span><span class="p">,</span>	<span class="n">REG_WIDTH_32</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCATLCURR</span><span class="p">,</span>	<span class="mh">0x1e</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_R</span><span class="p">);</span>

<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCATLDTC</span><span class="p">,</span>	<span class="mh">0x51</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">HCATLDTCTO</span><span class="p">,</span>	<span class="mh">0x52</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>


<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">OTGCONTROL</span><span class="p">,</span>	<span class="mh">0x62</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">OTGSTATUS</span><span class="p">,</span>	<span class="mh">0x67</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_R</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">OTGINT</span><span class="p">,</span>	<span class="mh">0x68</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">OTGINTENB</span><span class="p">,</span>	<span class="mh">0x69</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">OTGTIMER</span><span class="p">,</span>	<span class="mh">0x6A</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>
<span class="n">ISP1362_REG</span><span class="p">(</span><span class="n">OTGALTTMR</span><span class="p">,</span>	<span class="mh">0x6C</span><span class="p">,</span>	<span class="n">REG_WIDTH_16</span><span class="p">,</span>	<span class="n">REG_ACCESS_RW</span><span class="p">);</span>

<span class="cm">/* Philips transfer descriptor, cpu-endian */</span>
<span class="k">struct</span> <span class="n">ptd</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">count</span><span class="p">;</span>
<span class="cp">#define	PTD_COUNT_MSK	(0x3ff &lt;&lt; 0)</span>
<span class="cp">#define	PTD_TOGGLE_MSK	(1 &lt;&lt; 10)</span>
<span class="cp">#define	PTD_ACTIVE_MSK	(1 &lt;&lt; 11)</span>
<span class="cp">#define	PTD_CC_MSK	(0xf &lt;&lt; 12)</span>
	<span class="n">u16</span> <span class="n">mps</span><span class="p">;</span>
<span class="cp">#define	PTD_MPS_MSK	(0x3ff &lt;&lt; 0)</span>
<span class="cp">#define	PTD_SPD_MSK	(1 &lt;&lt; 10)</span>
<span class="cp">#define	PTD_LAST_MSK	(1 &lt;&lt; 11)</span>
<span class="cp">#define	PTD_EP_MSK	(0xf &lt;&lt; 12)</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
<span class="cp">#define	PTD_LEN_MSK	(0x3ff &lt;&lt; 0)</span>
<span class="cp">#define	PTD_DIR_MSK	(3 &lt;&lt; 10)</span>
<span class="cp">#define	PTD_DIR_SETUP	(0)</span>
<span class="cp">#define	PTD_DIR_OUT	(1)</span>
<span class="cp">#define	PTD_DIR_IN	(2)</span>
	<span class="n">u16</span> <span class="n">faddr</span><span class="p">;</span>
<span class="cp">#define	PTD_FA_MSK	(0x7f &lt;&lt; 0)</span>
<span class="cm">/* PTD Byte 7: [StartingFrame (if ISO PTD) | StartingFrame[0..4], PollingRate[0..2] (if INT PTD)] */</span>
<span class="cp">#define PTD_SF_ISO_MSK	(0xff &lt;&lt; 8)</span>
<span class="cp">#define PTD_SF_INT_MSK	(0x1f &lt;&lt; 8)</span>
<span class="cp">#define PTD_PR_MSK	(0x07 &lt;&lt; 13)</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">,</span> <span class="n">aligned</span><span class="p">(</span><span class="mi">2</span><span class="p">)));</span>
<span class="cp">#define PTD_HEADER_SIZE sizeof(struct ptd)</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>
<span class="cm">/* Copied from ohci.h: */</span>
<span class="cm">/*</span>
<span class="cm"> * Hardware transfer status codes -- CC from PTD</span>
<span class="cm"> */</span>
<span class="cp">#define PTD_CC_NOERROR      0x00</span>
<span class="cp">#define PTD_CC_CRC          0x01</span>
<span class="cp">#define PTD_CC_BITSTUFFING  0x02</span>
<span class="cp">#define PTD_CC_DATATOGGLEM  0x03</span>
<span class="cp">#define PTD_CC_STALL        0x04</span>
<span class="cp">#define PTD_DEVNOTRESP      0x05</span>
<span class="cp">#define PTD_PIDCHECKFAIL    0x06</span>
<span class="cp">#define PTD_UNEXPECTEDPID   0x07</span>
<span class="cp">#define PTD_DATAOVERRUN     0x08</span>
<span class="cp">#define PTD_DATAUNDERRUN    0x09</span>
    <span class="cm">/* 0x0A, 0x0B reserved for hardware */</span>
<span class="cp">#define PTD_BUFFEROVERRUN   0x0C</span>
<span class="cp">#define PTD_BUFFERUNDERRUN  0x0D</span>
    <span class="cm">/* 0x0E, 0x0F reserved for HCD */</span>
<span class="cp">#define PTD_NOTACCESSED     0x0F</span>


<span class="cm">/* map OHCI TD status codes (CC) to errno values */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">cc_to_error</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* No  Error  */</span>               <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* CRC Error  */</span>               <span class="o">-</span><span class="n">EILSEQ</span><span class="p">,</span>
	<span class="cm">/* Bit Stuff  */</span>               <span class="o">-</span><span class="n">EPROTO</span><span class="p">,</span>
	<span class="cm">/* Data Togg  */</span>               <span class="o">-</span><span class="n">EILSEQ</span><span class="p">,</span>
	<span class="cm">/* Stall      */</span>               <span class="o">-</span><span class="n">EPIPE</span><span class="p">,</span>
	<span class="cm">/* DevNotResp */</span>               <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">,</span>
	<span class="cm">/* PIDCheck   */</span>               <span class="o">-</span><span class="n">EPROTO</span><span class="p">,</span>
	<span class="cm">/* UnExpPID   */</span>               <span class="o">-</span><span class="n">EPROTO</span><span class="p">,</span>
	<span class="cm">/* DataOver   */</span>               <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">,</span>
	<span class="cm">/* DataUnder  */</span>               <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">,</span>
	<span class="cm">/* (for hw)   */</span>               <span class="o">-</span><span class="n">EIO</span><span class="p">,</span>
	<span class="cm">/* (for hw)   */</span>               <span class="o">-</span><span class="n">EIO</span><span class="p">,</span>
	<span class="cm">/* BufferOver */</span>               <span class="o">-</span><span class="n">ECOMM</span><span class="p">,</span>
	<span class="cm">/* BuffUnder  */</span>               <span class="o">-</span><span class="n">ENOSR</span><span class="p">,</span>
	<span class="cm">/* (for HCD)  */</span>               <span class="o">-</span><span class="n">EALREADY</span><span class="p">,</span>
	<span class="cm">/* (for HCD)  */</span>               <span class="o">-</span><span class="n">EALREADY</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * HcControl (control) register masks</span>
<span class="cm"> */</span>
<span class="cp">#define OHCI_CTRL_HCFS	(3 &lt;&lt; 6)	</span><span class="cm">/* host controller functional state */</span><span class="cp"></span>
<span class="cp">#define OHCI_CTRL_RWC	(1 &lt;&lt; 9)	</span><span class="cm">/* remote wakeup connected */</span><span class="cp"></span>
<span class="cp">#define OHCI_CTRL_RWE	(1 &lt;&lt; 10)	</span><span class="cm">/* remote wakeup enable */</span><span class="cp"></span>

<span class="cm">/* pre-shifted values for HCFS */</span>
<span class="cp">#	define OHCI_USB_RESET	(0 &lt;&lt; 6)</span>
<span class="cp">#	define OHCI_USB_RESUME	(1 &lt;&lt; 6)</span>
<span class="cp">#	define OHCI_USB_OPER	(2 &lt;&lt; 6)</span>
<span class="cp">#	define OHCI_USB_SUSPEND	(3 &lt;&lt; 6)</span>

<span class="cm">/*</span>
<span class="cm"> * HcCommandStatus (cmdstatus) register masks</span>
<span class="cm"> */</span>
<span class="cp">#define OHCI_HCR	(1 &lt;&lt; 0)	</span><span class="cm">/* host controller reset */</span><span class="cp"></span>
<span class="cp">#define OHCI_SOC  	(3 &lt;&lt; 16)	</span><span class="cm">/* scheduling overrun count */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * masks used with interrupt registers:</span>
<span class="cm"> * HcInterruptStatus (intrstatus)</span>
<span class="cm"> * HcInterruptEnable (intrenable)</span>
<span class="cm"> * HcInterruptDisable (intrdisable)</span>
<span class="cm"> */</span>
<span class="cp">#define OHCI_INTR_SO	(1 &lt;&lt; 0)	</span><span class="cm">/* scheduling overrun */</span><span class="cp"></span>
<span class="cp">#define OHCI_INTR_WDH	(1 &lt;&lt; 1)	</span><span class="cm">/* writeback of done_head */</span><span class="cp"></span>
<span class="cp">#define OHCI_INTR_SF	(1 &lt;&lt; 2)	</span><span class="cm">/* start frame */</span><span class="cp"></span>
<span class="cp">#define OHCI_INTR_RD	(1 &lt;&lt; 3)	</span><span class="cm">/* resume detect */</span><span class="cp"></span>
<span class="cp">#define OHCI_INTR_UE	(1 &lt;&lt; 4)	</span><span class="cm">/* unrecoverable error */</span><span class="cp"></span>
<span class="cp">#define OHCI_INTR_FNO	(1 &lt;&lt; 5)	</span><span class="cm">/* frame number overflow */</span><span class="cp"></span>
<span class="cp">#define OHCI_INTR_RHSC	(1 &lt;&lt; 6)	</span><span class="cm">/* root hub status change */</span><span class="cp"></span>
<span class="cp">#define OHCI_INTR_OC	(1 &lt;&lt; 30)	</span><span class="cm">/* ownership change */</span><span class="cp"></span>
<span class="cp">#define OHCI_INTR_MIE	(1 &lt;&lt; 31)	</span><span class="cm">/* master interrupt enable */</span><span class="cp"></span>

<span class="cm">/* roothub.portstatus [i] bits */</span>
<span class="cp">#define RH_PS_CCS            0x00000001   	</span><span class="cm">/* current connect status */</span><span class="cp"></span>
<span class="cp">#define RH_PS_PES            0x00000002   	</span><span class="cm">/* port enable status*/</span><span class="cp"></span>
<span class="cp">#define RH_PS_PSS            0x00000004   	</span><span class="cm">/* port suspend status */</span><span class="cp"></span>
<span class="cp">#define RH_PS_POCI           0x00000008   	</span><span class="cm">/* port over current indicator */</span><span class="cp"></span>
<span class="cp">#define RH_PS_PRS            0x00000010  	</span><span class="cm">/* port reset status */</span><span class="cp"></span>
<span class="cp">#define RH_PS_PPS            0x00000100   	</span><span class="cm">/* port power status */</span><span class="cp"></span>
<span class="cp">#define RH_PS_LSDA           0x00000200    	</span><span class="cm">/* low speed device attached */</span><span class="cp"></span>
<span class="cp">#define RH_PS_CSC            0x00010000 	</span><span class="cm">/* connect status change */</span><span class="cp"></span>
<span class="cp">#define RH_PS_PESC           0x00020000   	</span><span class="cm">/* port enable status change */</span><span class="cp"></span>
<span class="cp">#define RH_PS_PSSC           0x00040000    	</span><span class="cm">/* port suspend status change */</span><span class="cp"></span>
<span class="cp">#define RH_PS_OCIC           0x00080000    	</span><span class="cm">/* over current indicator change */</span><span class="cp"></span>
<span class="cp">#define RH_PS_PRSC           0x00100000   	</span><span class="cm">/* port reset status change */</span><span class="cp"></span>

<span class="cm">/* roothub.status bits */</span>
<span class="cp">#define RH_HS_LPS	     0x00000001		</span><span class="cm">/* local power status */</span><span class="cp"></span>
<span class="cp">#define RH_HS_OCI	     0x00000002		</span><span class="cm">/* over current indicator */</span><span class="cp"></span>
<span class="cp">#define RH_HS_DRWE	     0x00008000		</span><span class="cm">/* device remote wakeup enable */</span><span class="cp"></span>
<span class="cp">#define RH_HS_LPSC	     0x00010000		</span><span class="cm">/* local power status change */</span><span class="cp"></span>
<span class="cp">#define RH_HS_OCIC	     0x00020000		</span><span class="cm">/* over current indicator change */</span><span class="cp"></span>
<span class="cp">#define RH_HS_CRWE	     0x80000000		</span><span class="cm">/* clear remote wakeup enable */</span><span class="cp"></span>

<span class="cm">/* roothub.b masks */</span>
<span class="cp">#define RH_B_DR		0x0000ffff		</span><span class="cm">/* device removable flags */</span><span class="cp"></span>
<span class="cp">#define RH_B_PPCM	0xffff0000		</span><span class="cm">/* port power control mask */</span><span class="cp"></span>

<span class="cm">/* roothub.a masks */</span>
<span class="cp">#define	RH_A_NDP	(0xff &lt;&lt; 0)		</span><span class="cm">/* number of downstream ports */</span><span class="cp"></span>
<span class="cp">#define	RH_A_PSM	(1 &lt;&lt; 8)		</span><span class="cm">/* power switching mode */</span><span class="cp"></span>
<span class="cp">#define	RH_A_NPS	(1 &lt;&lt; 9)		</span><span class="cm">/* no power switching */</span><span class="cp"></span>
<span class="cp">#define	RH_A_DT		(1 &lt;&lt; 10)		</span><span class="cm">/* device type (mbz) */</span><span class="cp"></span>
<span class="cp">#define	RH_A_OCPM	(1 &lt;&lt; 11)		</span><span class="cm">/* over current protection mode */</span><span class="cp"></span>
<span class="cp">#define	RH_A_NOCP	(1 &lt;&lt; 12)		</span><span class="cm">/* no over current protection */</span><span class="cp"></span>
<span class="cp">#define	RH_A_POTPGT	(0xff &lt;&lt; 24)		</span><span class="cm">/* power on to power good time */</span><span class="cp"></span>

<span class="cp">#define	FI			0x2edf		</span><span class="cm">/* 12000 bits per frame (-1) */</span><span class="cp"></span>
<span class="cp">#define	FSMP(fi) 		(0x7fff &amp; ((6 * ((fi) - 210)) / 7))</span>
<span class="cp">#define LSTHRESH		0x628		</span><span class="cm">/* lowspeed bit threshold */</span><span class="cp"></span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="cm">/* PTD accessor macros. */</span>
<span class="cp">#define PTD_GET_COUNT(p)	(((p)-&gt;count &amp; PTD_COUNT_MSK) &gt;&gt; 0)</span>
<span class="cp">#define PTD_COUNT(v)		(((v) &lt;&lt; 0) &amp; PTD_COUNT_MSK)</span>
<span class="cp">#define PTD_GET_TOGGLE(p)	(((p)-&gt;count &amp; PTD_TOGGLE_MSK) &gt;&gt; 10)</span>
<span class="cp">#define PTD_TOGGLE(v)		(((v) &lt;&lt; 10) &amp; PTD_TOGGLE_MSK)</span>
<span class="cp">#define PTD_GET_ACTIVE(p)	(((p)-&gt;count &amp; PTD_ACTIVE_MSK) &gt;&gt; 11)</span>
<span class="cp">#define PTD_ACTIVE(v)		(((v) &lt;&lt; 11) &amp; PTD_ACTIVE_MSK)</span>
<span class="cp">#define PTD_GET_CC(p)		(((p)-&gt;count &amp; PTD_CC_MSK) &gt;&gt; 12)</span>
<span class="cp">#define PTD_CC(v)		(((v) &lt;&lt; 12) &amp; PTD_CC_MSK)</span>
<span class="cp">#define PTD_GET_MPS(p)		(((p)-&gt;mps &amp; PTD_MPS_MSK) &gt;&gt; 0)</span>
<span class="cp">#define PTD_MPS(v)		(((v) &lt;&lt; 0) &amp; PTD_MPS_MSK)</span>
<span class="cp">#define PTD_GET_SPD(p)		(((p)-&gt;mps &amp; PTD_SPD_MSK) &gt;&gt; 10)</span>
<span class="cp">#define PTD_SPD(v)		(((v) &lt;&lt; 10) &amp; PTD_SPD_MSK)</span>
<span class="cp">#define PTD_GET_LAST(p)		(((p)-&gt;mps &amp; PTD_LAST_MSK) &gt;&gt; 11)</span>
<span class="cp">#define PTD_LAST(v)		(((v) &lt;&lt; 11) &amp; PTD_LAST_MSK)</span>
<span class="cp">#define PTD_GET_EP(p)		(((p)-&gt;mps &amp; PTD_EP_MSK) &gt;&gt; 12)</span>
<span class="cp">#define PTD_EP(v)		(((v) &lt;&lt; 12) &amp; PTD_EP_MSK)</span>
<span class="cp">#define PTD_GET_LEN(p)		(((p)-&gt;len &amp; PTD_LEN_MSK) &gt;&gt; 0)</span>
<span class="cp">#define PTD_LEN(v)		(((v) &lt;&lt; 0) &amp; PTD_LEN_MSK)</span>
<span class="cp">#define PTD_GET_DIR(p)		(((p)-&gt;len &amp; PTD_DIR_MSK) &gt;&gt; 10)</span>
<span class="cp">#define PTD_DIR(v)		(((v) &lt;&lt; 10) &amp; PTD_DIR_MSK)</span>
<span class="cp">#define PTD_GET_FA(p)		(((p)-&gt;faddr &amp; PTD_FA_MSK) &gt;&gt; 0)</span>
<span class="cp">#define PTD_FA(v)		(((v) &lt;&lt; 0) &amp; PTD_FA_MSK)</span>
<span class="cp">#define PTD_GET_SF_INT(p)	(((p)-&gt;faddr &amp; PTD_SF_INT_MSK) &gt;&gt; 8)</span>
<span class="cp">#define PTD_SF_INT(v)		(((v) &lt;&lt; 8) &amp; PTD_SF_INT_MSK)</span>
<span class="cp">#define PTD_GET_SF_ISO(p)	(((p)-&gt;faddr &amp; PTD_SF_ISO_MSK) &gt;&gt; 8)</span>
<span class="cp">#define PTD_SF_ISO(v)		(((v) &lt;&lt; 8) &amp; PTD_SF_ISO_MSK)</span>
<span class="cp">#define PTD_GET_PR(p)		(((p)-&gt;faddr &amp; PTD_PR_MSK) &gt;&gt; 13)</span>
<span class="cp">#define PTD_PR(v)		(((v) &lt;&lt; 13) &amp; PTD_PR_MSK)</span>

<span class="cp">#define	LOG2_PERIODIC_SIZE	5	</span><span class="cm">/* arbitrary; this matches OHCI */</span><span class="cp"></span>
<span class="cp">#define	PERIODIC_SIZE		(1 &lt;&lt; LOG2_PERIODIC_SIZE)</span>

<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">hep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span>	<span class="o">*</span><span class="n">udev</span><span class="p">;</span>

	<span class="cm">/* philips transfer descriptor */</span>
	<span class="k">struct</span> <span class="n">ptd</span>		<span class="n">ptd</span><span class="p">;</span>

	<span class="n">u8</span>			<span class="n">maxpacket</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">epnum</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">nextpid</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">error_count</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">length</span><span class="p">;</span>		<span class="cm">/* of current packet */</span>
	<span class="n">s16</span>			<span class="n">ptd_offset</span><span class="p">;</span>	<span class="cm">/* buffer offset in ISP1362 where</span>
<span class="cm">						   PTD has been stored</span>
<span class="cm">						   (for access thru HCDIRDATA) */</span>
	<span class="kt">int</span>			<span class="n">ptd_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_ptds</span><span class="p">;</span>
	<span class="kt">void</span> 			<span class="o">*</span><span class="n">data</span><span class="p">;</span>		<span class="cm">/* to databuf */</span>
	<span class="cm">/* queue of active EPs (the ones transmitted to the chip) */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">active</span><span class="p">;</span>

	<span class="cm">/* periodic schedule */</span>
	<span class="n">u8</span>			<span class="n">branch</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">interval</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">load</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">last_iso</span><span class="p">;</span>

	<span class="cm">/* async schedule */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">schedule</span><span class="p">;</span>	<span class="cm">/* list of all EPs that need processing */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">remove_list</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">num_req</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">active</span><span class="p">;</span>		<span class="cm">/* list of PTDs currently processed by HC */</span>
	<span class="n">atomic_t</span>		<span class="n">finishing</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">buf_map</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">skip_map</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">free_ptd</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">buf_start</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">buf_size</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">blk_size</span><span class="p">;</span>	<span class="cm">/* PTD buffer block size for ATL and INTL */</span>
	<span class="n">u8</span>			<span class="n">buf_count</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">buf_avail</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="cm">/* for statistical tracking */</span>
	<span class="n">u8</span>			<span class="n">stat_maxptds</span><span class="p">;</span>	<span class="cm">/* Max # of ptds seen simultaneously in fifo */</span>
	<span class="n">u8</span>			<span class="n">ptd_count</span><span class="p">;</span>	<span class="cm">/* number of ptds submitted to this queue */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">addr_reg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">data_reg</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">isp1362_platform_data</span> <span class="o">*</span><span class="n">board</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">proc_dir_entry</span>	<span class="o">*</span><span class="n">pde</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">stat1</span><span class="p">,</span> <span class="n">stat2</span><span class="p">,</span> <span class="n">stat4</span><span class="p">,</span> <span class="n">stat8</span><span class="p">,</span> <span class="n">stat16</span><span class="p">;</span>

	<span class="cm">/* HC registers */</span>
	<span class="n">u32</span>			<span class="n">intenb</span><span class="p">;</span>		<span class="cm">/* &quot;OHCI&quot; interrupts */</span>
	<span class="n">u16</span>			<span class="n">irqenb</span><span class="p">;</span>		<span class="cm">/* uP interrupts */</span>

	<span class="cm">/* Root hub registers */</span>
	<span class="n">u32</span>			<span class="n">rhdesca</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">rhdescb</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">rhstatus</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">rhport</span><span class="p">[</span><span class="n">MAX_ROOT_PORTS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">next_statechange</span><span class="p">;</span>

	<span class="cm">/* HC control reg shadow copy */</span>
	<span class="n">u32</span>			<span class="n">hc_control</span><span class="p">;</span>

	<span class="cm">/* async schedule: control, bulk */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">async</span><span class="p">;</span>

	<span class="cm">/* periodic schedule: int */</span>
	<span class="n">u16</span>			<span class="n">load</span><span class="p">[</span><span class="n">PERIODIC_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">periodic</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">fmindex</span><span class="p">;</span>

	<span class="cm">/* periodic schedule: isochronous */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">isoc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">istl_flip</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">irq_active</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Schedules for the current frame */</span>
	<span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="n">atl_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="n">intl_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="n">istl_queue</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* list of PTDs retrieved from HC */</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">remove_list</span><span class="p">;</span>
	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">ISP1362_INT_SOF</span><span class="p">,</span>
		<span class="n">ISP1362_INT_ISTL0</span><span class="p">,</span>
		<span class="n">ISP1362_INT_ISTL1</span><span class="p">,</span>
		<span class="n">ISP1362_INT_EOT</span><span class="p">,</span>
		<span class="n">ISP1362_INT_OPR</span><span class="p">,</span>
		<span class="n">ISP1362_INT_SUSP</span><span class="p">,</span>
		<span class="n">ISP1362_INT_CLKRDY</span><span class="p">,</span>
		<span class="n">ISP1362_INT_INTL</span><span class="p">,</span>
		<span class="n">ISP1362_INT_ATL</span><span class="p">,</span>
		<span class="n">ISP1362_INT_OTG</span><span class="p">,</span>
		<span class="n">NUM_ISP1362_IRQS</span>
	<span class="p">}</span> <span class="n">IRQ_NAMES</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">irq_stat</span><span class="p">[</span><span class="n">NUM_ISP1362_IRQS</span><span class="p">];</span>
	<span class="kt">int</span>			<span class="n">req_serial</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ISP1362_INT_NAME</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISP1362_INT_SOF</span>:    <span class="k">return</span> <span class="s">&quot;SOF&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISP1362_INT_ISTL0</span>:  <span class="k">return</span> <span class="s">&quot;ISTL0&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISP1362_INT_ISTL1</span>:  <span class="k">return</span> <span class="s">&quot;ISTL1&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISP1362_INT_EOT</span>:    <span class="k">return</span> <span class="s">&quot;EOT&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISP1362_INT_OPR</span>:    <span class="k">return</span> <span class="s">&quot;OPR&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISP1362_INT_SUSP</span>:   <span class="k">return</span> <span class="s">&quot;SUSP&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISP1362_INT_CLKRDY</span>: <span class="k">return</span> <span class="s">&quot;CLKRDY&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISP1362_INT_INTL</span>:   <span class="k">return</span> <span class="s">&quot;INTL&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISP1362_INT_ATL</span>:    <span class="k">return</span> <span class="s">&quot;ATL&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISP1362_INT_OTG</span>:    <span class="k">return</span> <span class="s">&quot;OTG&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>                 <span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ALIGNSTAT</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">stat16</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">stat8</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">))</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">stat4</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">stat2</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">stat1</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="nf">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">hcd_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="nf">isp1362_hcd_to_hcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_hcd</span><span class="p">,</span> <span class="n">hcd_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define frame_before(f1, f2)	((s16)((u16)f1 - (u16)f2) &lt; 0)</span>

<span class="cm">/*</span>
<span class="cm"> * ISP1362 HW Interface</span>
<span class="cm"> */</span>

<span class="cp">#ifdef ISP1362_DEBUG</span>
<span class="cp">#define DBG(level, fmt...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (dbg_level &gt; level) \</span>
<span class="cp">			pr_debug(fmt); \</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define _DBG(level, fmt...)	\</span>
<span class="cp">	do { \</span>
<span class="cp">		if (dbg_level &gt; level) \</span>
<span class="cp">			printk(fmt); \</span>
<span class="cp">	} while (0)</span>
<span class="cp">#else</span>
<span class="cp">#define DBG(fmt...)		do {} while (0)</span>
<span class="cp">#define _DBG DBG</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef VERBOSE</span>
<span class="cp">#    define VDBG(fmt...)	DBG(3, fmt)</span>
<span class="cp">#else</span>
<span class="cp">#    define VDBG(fmt...)	do {} while (0)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef REGISTERS</span>
<span class="cp">#    define RDBG(fmt...)	DBG(1, fmt)</span>
<span class="cp">#else</span>
<span class="cp">#    define RDBG(fmt...)	do {} while (0)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef URB_TRACE</span>
<span class="cp">#define URB_DBG(fmt...)		DBG(0, fmt)</span>
<span class="cp">#else</span>
<span class="cp">#define URB_DBG(fmt...)		do {} while (0)</span>
<span class="cp">#endif</span>


<span class="cp">#if USE_PLATFORM_DELAY</span>
<span class="cp">#if USE_NDELAY</span>
<span class="cp">#error USE_PLATFORM_DELAY and USE_NDELAY defined simultaneously.</span>
<span class="cp">#endif</span>
<span class="cp">#define	isp1362_delay(h, d)	(h)-&gt;board-&gt;delay(isp1362_hcd_to_hcd(h)-&gt;self.controller, d)</span>
<span class="cp">#elif USE_NDELAY</span>
<span class="cp">#define	isp1362_delay(h, d)	ndelay(d)</span>
<span class="cp">#else</span>
<span class="cp">#define	isp1362_delay(h, d)	do {} while (0)</span>
<span class="cp">#endif</span>

<span class="cp">#define get_urb(ep) ({							\</span>
<span class="cp">	BUG_ON(list_empty(&amp;ep-&gt;hep-&gt;urb_list));				\</span>
<span class="cp">	container_of(ep-&gt;hep-&gt;urb_list.next, struct urb, urb_list);	\</span>
<span class="cp">})</span>

<span class="cm">/* basic access functions for ISP1362 chip registers */</span>
<span class="cm">/* NOTE: The contents of the address pointer register cannot be read back! The driver must ensure,</span>
<span class="cm"> * that all register accesses are performed with interrupts disabled, since the interrupt</span>
<span class="cm"> * handler has no way of restoring the previous state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1362_write_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">isp1362_reg_t</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*_BUG_ON((reg &amp; ISP1362_REG_WRITE_OFFSET) &amp;&amp; !(reg &amp; REG_ACCESS_W));*/</span>
	<span class="n">REG_ACCESS_TEST</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">());</span>
	<span class="n">DUMMY_DELAY_ACCESS</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">reg</span><span class="p">),</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">addr_reg</span><span class="p">);</span>
	<span class="n">DUMMY_DELAY_ACCESS</span><span class="p">;</span>
	<span class="n">isp1362_delay</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1362_write_data16</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">());</span>
	<span class="n">DUMMY_DELAY_ACCESS</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">isp1362_read_data16</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">());</span>
	<span class="n">DUMMY_DELAY_ACCESS</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1362_write_data32</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">());</span>
<span class="cp">#if USE_32BIT</span>
	<span class="n">DUMMY_DELAY_ACCESS</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">DUMMY_DELAY_ACCESS</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">);</span>
	<span class="n">DUMMY_DELAY_ACCESS</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">isp1362_read_data32</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">());</span>
<span class="cp">#if USE_32BIT</span>
	<span class="n">DUMMY_DELAY_ACCESS</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">DUMMY_DELAY_ACCESS</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">readw</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">);</span>
	<span class="n">DUMMY_DELAY_ACCESS</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">readw</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* use readsw/writesw to access the fifo whenever possible */</span>
<span class="cm">/* assume HCDIRDATA or XFERCTR &amp; addr_reg have been set up */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1362_read_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">());</span>

	<span class="n">RDBG</span><span class="p">(</span><span class="s">&quot;%s: Reading %d byte from fifo to mem @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="cp">#if USE_32BIT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RDBG</span><span class="p">(</span><span class="s">&quot;%s: Using readsl for %d dwords</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">readsl</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dp</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">&amp;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RDBG</span><span class="p">(</span><span class="s">&quot;%s: Using readsw for %d words</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">insw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dp</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">&amp;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">isp1362_read_data16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>
		<span class="n">RDBG</span><span class="p">(</span><span class="s">&quot;%s: Reading trailing byte %02x to mem @ %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">dp</span><span class="p">);</span>
		<span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1362_write_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dp</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* not aligned */</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">dp</span><span class="o">++</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="o">*</span><span class="n">dp</span><span class="o">++</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">isp1362_write_data16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
			<span class="n">isp1362_write_data16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="o">*</span><span class="n">dp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">());</span>

	<span class="n">RDBG</span><span class="p">(</span><span class="s">&quot;%s: Writing %d byte to fifo from memory @%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="cp">#if USE_32BIT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RDBG</span><span class="p">(</span><span class="s">&quot;%s: Using writesl for %d dwords</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">writesl</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dp</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">&amp;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RDBG</span><span class="p">(</span><span class="s">&quot;%s: Using writesw for %d words</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">outsw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dp</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">&amp;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* finally write any trailing byte; we don&#39;t need to care</span>
<span class="cm">		 * about the high byte of the last word written</span>
<span class="cm">		 */</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="o">*</span><span class="n">dp</span><span class="p">;</span>
		<span class="n">RDBG</span><span class="p">(</span><span class="s">&quot;%s: Sending trailing byte %02x from mem @ %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">dp</span><span class="p">);</span>
		<span class="n">isp1362_write_data16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define isp1362_read_reg16(d, r)		({			\</span>
<span class="cp">	u16 __v;							\</span>
<span class="cp">	REG_WIDTH_TEST(ISP1362_REG_##r, REG_WIDTH_16);			\</span>
<span class="cp">	isp1362_write_addr(d, ISP1362_REG_##r);				\</span>
<span class="cp">	__v = isp1362_read_data16(d);					\</span>
<span class="cp">	RDBG(&quot;%s: Read %04x from %s[%02x]\n&quot;, __func__, __v, #r,	\</span>
<span class="cp">	     ISP1362_REG_NO(ISP1362_REG_##r));				\</span>
<span class="cp">	__v;								\</span>
<span class="cp">})</span>

<span class="cp">#define isp1362_read_reg32(d, r)		({			\</span>
<span class="cp">	u32 __v;							\</span>
<span class="cp">	REG_WIDTH_TEST(ISP1362_REG_##r, REG_WIDTH_32);			\</span>
<span class="cp">	isp1362_write_addr(d, ISP1362_REG_##r);				\</span>
<span class="cp">	__v = isp1362_read_data32(d);					\</span>
<span class="cp">	RDBG(&quot;%s: Read %08x from %s[%02x]\n&quot;, __func__, __v, #r,	\</span>
<span class="cp">	     ISP1362_REG_NO(ISP1362_REG_##r));				\</span>
<span class="cp">	__v;								\</span>
<span class="cp">})</span>

<span class="cp">#define isp1362_write_reg16(d, r, v)	{					\</span>
<span class="cp">	REG_WIDTH_TEST(ISP1362_REG_##r, REG_WIDTH_16);				\</span>
<span class="cp">	isp1362_write_addr(d, (ISP1362_REG_##r) | ISP1362_REG_WRITE_OFFSET);	\</span>
<span class="cp">	isp1362_write_data16(d, (u16)(v));					\</span>
<span class="cp">	RDBG(&quot;%s: Wrote %04x to %s[%02x]\n&quot;, __func__, (u16)(v), #r,	\</span>
<span class="cp">	     ISP1362_REG_NO(ISP1362_REG_##r));					\</span>
<span class="cp">}</span>

<span class="cp">#define isp1362_write_reg32(d, r, v)	{					\</span>
<span class="cp">	REG_WIDTH_TEST(ISP1362_REG_##r, REG_WIDTH_32);				\</span>
<span class="cp">	isp1362_write_addr(d, (ISP1362_REG_##r) | ISP1362_REG_WRITE_OFFSET);	\</span>
<span class="cp">	isp1362_write_data32(d, (u32)(v));					\</span>
<span class="cp">	RDBG(&quot;%s: Wrote %08x to %s[%02x]\n&quot;, __func__, (u32)(v), #r,	\</span>
<span class="cp">	     ISP1362_REG_NO(ISP1362_REG_##r));					\</span>
<span class="cp">}</span>

<span class="cp">#define isp1362_set_mask16(d, r, m) {			\</span>
<span class="cp">	u16 __v;					\</span>
<span class="cp">	__v = isp1362_read_reg16(d, r);			\</span>
<span class="cp">	if ((__v | m) != __v)				\</span>
<span class="cp">		isp1362_write_reg16(d, r, __v | m);	\</span>
<span class="cp">}</span>

<span class="cp">#define isp1362_clr_mask16(d, r, m) {			\</span>
<span class="cp">	u16 __v;					\</span>
<span class="cp">	__v = isp1362_read_reg16(d, r);			\</span>
<span class="cp">	if ((__v &amp; ~m) != __v)			\</span>
<span class="cp">		isp1362_write_reg16(d, r, __v &amp; ~m);	\</span>
<span class="cp">}</span>

<span class="cp">#define isp1362_set_mask32(d, r, m) {			\</span>
<span class="cp">	u32 __v;					\</span>
<span class="cp">	__v = isp1362_read_reg32(d, r);			\</span>
<span class="cp">	if ((__v | m) != __v)				\</span>
<span class="cp">		isp1362_write_reg32(d, r, __v | m);	\</span>
<span class="cp">}</span>

<span class="cp">#define isp1362_clr_mask32(d, r, m) {			\</span>
<span class="cp">	u32 __v;					\</span>
<span class="cp">	__v = isp1362_read_reg32(d, r);			\</span>
<span class="cp">	if ((__v &amp; ~m) != __v)			\</span>
<span class="cp">		isp1362_write_reg32(d, r, __v &amp; ~m);	\</span>
<span class="cp">}</span>

<span class="cp">#ifdef ISP1362_DEBUG</span>
<span class="cp">#define isp1362_show_reg(d, r) {								\</span>
<span class="cp">	if ((ISP1362_REG_##r &amp; REG_WIDTH_MASK) == REG_WIDTH_32)			\</span>
<span class="cp">		DBG(0, &quot;%-12s[%02x]: %08x\n&quot;, #r,					\</span>
<span class="cp">			ISP1362_REG_NO(ISP1362_REG_##r), isp1362_read_reg32(d, r));	\</span>
<span class="cp">	else									\</span>
<span class="cp">		DBG(0, &quot;%-12s[%02x]:     %04x\n&quot;, #r,					\</span>
<span class="cp">			ISP1362_REG_NO(ISP1362_REG_##r), isp1362_read_reg16(d, r));	\</span>
<span class="cp">}</span>
<span class="cp">#else</span>
<span class="cp">#define isp1362_show_reg(d, r)	do {} while (0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">__unused__</span><span class="p">))</span> <span class="n">isp1362_show_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCREVISION</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCMDSTAT</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTSTAT</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTENB</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCFMINTVL</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCFMREM</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCFMNUM</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCLSTHRESH</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHDESCA</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHDESCB</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHSTATUS</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT1</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT2</span><span class="p">);</span>

	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCHWCFG</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCDMACFG</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCXFERCTR</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%-12s[%02x]:     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;HCuPINTENB&quot;</span><span class="p">,</span>
			 <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCuPINTENB</span><span class="p">),</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCHIPID</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCSCRATCH</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCDIRADDR</span><span class="p">);</span>
	<span class="cm">/* Access would advance fifo</span>
<span class="cm">	 * isp1362_show_reg(isp1362_hcd, HCDIRDATA);</span>
<span class="cm">	 */</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCISTLBUFSZ</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCISTLRATE</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLBUFSZ</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLBLKSZ</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLDONE</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLSKIP</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLLAST</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLCURR</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLBUFSZ</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLBLKSZ</span><span class="p">);</span>
	<span class="cm">/* only valid after ATL_DONE interrupt</span>
<span class="cm">	 * isp1362_show_reg(isp1362_hcd, HCATLDONE);</span>
<span class="cm">	 */</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLSKIP</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLLAST</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLCURR</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLDTC</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLDTCTO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1362_write_diraddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_BUG_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">_BUG_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">ISP1362_BUF_SIZE</span><span class="p">);</span>
	<span class="n">_BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ISP1362_BUF_SIZE</span><span class="p">);</span>
	<span class="n">_BUG_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">ISP1362_BUF_SIZE</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">isp1362_clr_mask16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCDMACFG</span><span class="p">,</span> <span class="n">HCDMACFG_CTR_ENABLE</span><span class="p">);</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCDIRADDR</span><span class="p">,</span>
			    <span class="n">HCDIRADDR_ADDR</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span> <span class="n">HCDIRADDR_COUNT</span><span class="p">(</span><span class="n">len</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1362_read_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_BUG_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">isp1362_write_diraddr</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: Reading %d byte from buffer @%04x to memory @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">,</span> <span class="n">HCuPINT_EOT</span><span class="p">);</span>
	<span class="n">_WARN_ON</span><span class="p">((</span><span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCuPINT_EOT</span><span class="p">));</span>

	<span class="n">isp1362_write_addr</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ISP1362_REG_HCDIRDATA</span><span class="p">);</span>

	<span class="n">isp1362_read_fifo</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCuPINT_EOT</span><span class="p">));</span>
	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">,</span> <span class="n">HCuPINT_EOT</span><span class="p">);</span>
	<span class="n">_WARN_ON</span><span class="p">((</span><span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCuPINT_EOT</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1362_write_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_BUG_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">isp1362_write_diraddr</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: Writing %d byte to buffer @%04x from memory @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">,</span> <span class="n">HCuPINT_EOT</span><span class="p">);</span>
	<span class="n">_WARN_ON</span><span class="p">((</span><span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCuPINT_EOT</span><span class="p">));</span>

	<span class="n">isp1362_write_addr</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ISP1362_REG_HCDIRDATA</span> <span class="o">|</span> <span class="n">ISP1362_REG_WRITE_OFFSET</span><span class="p">);</span>
	<span class="n">isp1362_write_fifo</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCuPINT_EOT</span><span class="p">));</span>
	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">,</span> <span class="n">HCuPINT_EOT</span><span class="p">);</span>
	<span class="n">_WARN_ON</span><span class="p">((</span><span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCuPINT_EOT</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">unused</span><span class="p">))</span> <span class="n">dump_data</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">lf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lf</span><span class="p">)</span>
				<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%04x:&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">)[</span><span class="n">k</span><span class="p">]);</span>
			<span class="n">lf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">k</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">lf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lf</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if defined(ISP1362_DEBUG) &amp;&amp; defined(PTD_TRACE)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_ptd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ptd</span> <span class="o">*</span><span class="n">ptd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;EP %p: CC=%x EP=%d DIR=%x CNT=%d LEN=%d MPS=%d TGL=%x ACT=%x FA=%d SPD=%x SF=%x PR=%x LST=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">ptd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1362_ep</span><span class="p">,</span> <span class="n">ptd</span><span class="p">),</span>
	    <span class="n">PTD_GET_CC</span><span class="p">(</span><span class="n">ptd</span><span class="p">),</span> <span class="n">PTD_GET_EP</span><span class="p">(</span><span class="n">ptd</span><span class="p">),</span> <span class="n">PTD_GET_DIR</span><span class="p">(</span><span class="n">ptd</span><span class="p">),</span>
	    <span class="n">PTD_GET_COUNT</span><span class="p">(</span><span class="n">ptd</span><span class="p">),</span> <span class="n">PTD_GET_LEN</span><span class="p">(</span><span class="n">ptd</span><span class="p">),</span> <span class="n">PTD_GET_MPS</span><span class="p">(</span><span class="n">ptd</span><span class="p">),</span>
	    <span class="n">PTD_GET_TOGGLE</span><span class="p">(</span><span class="n">ptd</span><span class="p">),</span> <span class="n">PTD_GET_ACTIVE</span><span class="p">(</span><span class="n">ptd</span><span class="p">),</span> <span class="n">PTD_GET_FA</span><span class="p">(</span><span class="n">ptd</span><span class="p">),</span>
	    <span class="n">PTD_GET_SPD</span><span class="p">(</span><span class="n">ptd</span><span class="p">),</span> <span class="n">PTD_GET_SF_INT</span><span class="p">(</span><span class="n">ptd</span><span class="p">),</span> <span class="n">PTD_GET_PR</span><span class="p">(</span><span class="n">ptd</span><span class="p">),</span> <span class="n">PTD_GET_LAST</span><span class="p">(</span><span class="n">ptd</span><span class="p">));</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;  %04x %04x %04x %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptd</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">ptd</span><span class="o">-&gt;</span><span class="n">mps</span><span class="p">,</span> <span class="n">ptd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">ptd</span><span class="o">-&gt;</span><span class="n">faddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_ptd_out_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ptd</span> <span class="o">*</span><span class="n">ptd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PTD_GET_DIR</span><span class="p">(</span><span class="n">ptd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PTD_DIR_IN</span> <span class="o">&amp;&amp;</span> <span class="n">PTD_GET_LEN</span><span class="p">(</span><span class="n">ptd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;--out-&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dump_data</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PTD_GET_LEN</span><span class="p">(</span><span class="n">ptd</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_ptd_in_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ptd</span> <span class="o">*</span><span class="n">ptd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PTD_GET_DIR</span><span class="p">(</span><span class="n">ptd</span><span class="p">)</span> <span class="o">==</span> <span class="n">PTD_DIR_IN</span> <span class="o">&amp;&amp;</span> <span class="n">PTD_GET_COUNT</span><span class="p">(</span><span class="n">ptd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&lt;--in--</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dump_data</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PTD_GET_COUNT</span><span class="p">(</span><span class="n">ptd</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;-----</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_ptd_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dbg</span> <span class="o">=</span> <span class="n">dbg_level</span><span class="p">;</span>

	<span class="n">dbg_level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dump_ptd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd</span><span class="p">);</span>
		<span class="n">dump_data</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dbg_level</span> <span class="o">=</span> <span class="n">dbg</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define dump_ptd(ptd)			do {} while (0)</span>
<span class="cp">#define dump_ptd_in_data(ptd, buf)	do {} while (0)</span>
<span class="cp">#define dump_ptd_out_data(ptd, buf)	do {} while (0)</span>
<span class="cp">#define dump_ptd_data(ptd, buf)		do {} while (0)</span>
<span class="cp">#define dump_ptd_queue(epq)		do {} while (0)</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
