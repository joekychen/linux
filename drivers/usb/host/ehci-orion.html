<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › host › ehci-orion.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ehci-orion.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/usb/host/ehci-orion.c</span>
<span class="cm"> *</span>
<span class="cm"> * Tzachi Perelstein &lt;tzachi@marvell.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licensed under  the terms of the GNU General Public</span>
<span class="cm"> * License version 2. This program is licensed &quot;as is&quot; without any</span>
<span class="cm"> * warranty of any kind, whether express or implied.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/mbus.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;plat/ehci-orion.h&gt;</span>

<span class="cp">#define rdl(off)	__raw_readl(hcd-&gt;regs + (off))</span>
<span class="cp">#define wrl(off, val)	__raw_writel((val), hcd-&gt;regs + (off))</span>

<span class="cp">#define USB_CMD			0x140</span>
<span class="cp">#define USB_MODE		0x1a8</span>
<span class="cp">#define USB_CAUSE		0x310</span>
<span class="cp">#define USB_MASK		0x314</span>
<span class="cp">#define USB_WINDOW_CTRL(i)	(0x320 + ((i) &lt;&lt; 4))</span>
<span class="cp">#define USB_WINDOW_BASE(i)	(0x324 + ((i) &lt;&lt; 4))</span>
<span class="cp">#define USB_IPG			0x360</span>
<span class="cp">#define USB_PHY_PWR_CTRL	0x400</span>
<span class="cp">#define USB_PHY_TX_CTRL		0x420</span>
<span class="cp">#define USB_PHY_RX_CTRL		0x430</span>
<span class="cp">#define USB_PHY_IVREF_CTRL	0x440</span>
<span class="cp">#define USB_PHY_TST_GRP_CTRL	0x450</span>

<span class="cm">/*</span>
<span class="cm"> * Implement Orion USB controller specification guidelines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">orion_usb_phy_v1_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The below GLs are according to the Orion Errata document */</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clear interrupt cause and mask</span>
<span class="cm">	 */</span>
	<span class="n">wrl</span><span class="p">(</span><span class="n">USB_CAUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wrl</span><span class="p">(</span><span class="n">USB_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset controller</span>
<span class="cm">	 */</span>
	<span class="n">wrl</span><span class="p">(</span><span class="n">USB_CMD</span><span class="p">,</span> <span class="n">rdl</span><span class="p">(</span><span class="n">USB_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rdl</span><span class="p">(</span><span class="n">USB_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * GL# USB-10: Set IPG for non start of frame packets</span>
<span class="cm">	 * Bits[14:8]=0xc</span>
<span class="cm">	 */</span>
	<span class="n">wrl</span><span class="p">(</span><span class="n">USB_IPG</span><span class="p">,</span> <span class="p">(</span><span class="n">rdl</span><span class="p">(</span><span class="n">USB_IPG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7f00</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xc00</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * GL# USB-9: USB 2.0 Power Control</span>
<span class="cm">	 * BG_VSEL[7:6]=0x1</span>
<span class="cm">	 */</span>
	<span class="n">wrl</span><span class="p">(</span><span class="n">USB_PHY_PWR_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">rdl</span><span class="p">(</span><span class="n">USB_PHY_PWR_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xc0</span><span class="p">)</span><span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * GL# USB-1: USB PHY Tx Control - force calibration to &#39;8&#39;</span>
<span class="cm">	 * TXDATA_BLOCK_EN[21]=0x1, EXT_RCAL_EN[13]=0x1, IMP_CAL[6:3]=0x8</span>
<span class="cm">	 */</span>
	<span class="n">wrl</span><span class="p">(</span><span class="n">USB_PHY_TX_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">rdl</span><span class="p">(</span><span class="n">USB_PHY_TX_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x78</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x202040</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * GL# USB-3 GL# USB-9: USB PHY Rx Control</span>
<span class="cm">	 * RXDATA_BLOCK_LENGHT[31:30]=0x3, EDGE_DET_SEL[27:26]=0,</span>
<span class="cm">	 * CDR_FASTLOCK_EN[21]=0, DISCON_THRESHOLD[9:8]=0, SQ_THRESH[7:4]=0x1</span>
<span class="cm">	 */</span>
	<span class="n">wrl</span><span class="p">(</span><span class="n">USB_PHY_RX_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">rdl</span><span class="p">(</span><span class="n">USB_PHY_RX_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xc2003f0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xc0000010</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * GL# USB-3 GL# USB-9: USB PHY IVREF Control</span>
<span class="cm">	 * PLLVDD12[1:0]=0x2, RXVDD[5:4]=0x3, Reserved[19]=0</span>
<span class="cm">	 */</span>
	<span class="n">wrl</span><span class="p">(</span><span class="n">USB_PHY_IVREF_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">rdl</span><span class="p">(</span><span class="n">USB_PHY_IVREF_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80003</span> <span class="p">)</span> <span class="o">|</span> <span class="mh">0x32</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * GL# USB-3 GL# USB-9: USB PHY Test Group Control</span>
<span class="cm">	 * REG_FIFO_SQ_RST[15]=0</span>
<span class="cm">	 */</span>
	<span class="n">wrl</span><span class="p">(</span><span class="n">USB_PHY_TST_GRP_CTRL</span><span class="p">,</span> <span class="n">rdl</span><span class="p">(</span><span class="n">USB_PHY_TST_GRP_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x8000</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop and reset controller</span>
<span class="cm">	 */</span>
	<span class="n">wrl</span><span class="p">(</span><span class="n">USB_CMD</span><span class="p">,</span> <span class="n">rdl</span><span class="p">(</span><span class="n">USB_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">);</span>
	<span class="n">wrl</span><span class="p">(</span><span class="n">USB_CMD</span><span class="p">,</span> <span class="n">rdl</span><span class="p">(</span><span class="n">USB_CMD</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rdl</span><span class="p">(</span><span class="n">USB_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * GL# USB-5 Streaming disable REG_USB_MODE[4]=1</span>
<span class="cm">	 * TBD: This need to be done after each reset!</span>
<span class="cm">	 * GL# USB-4 Setup USB Host mode</span>
<span class="cm">	 */</span>
	<span class="n">wrl</span><span class="p">(</span><span class="n">USB_MODE</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ehci_orion_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span> <span class="o">=</span> <span class="n">hcd_to_ehci</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">has_tt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ehci_halt</span><span class="p">(</span><span class="n">ehci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * data structure init</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">ehci_init</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">ehci_reset</span><span class="p">(</span><span class="n">ehci</span><span class="p">);</span>

	<span class="n">ehci_port_power</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hc_driver</span> <span class="n">ehci_orion_hc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">hcd_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">product_desc</span> <span class="o">=</span> <span class="s">&quot;Marvell Orion EHCI&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hcd_priv_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span><span class="p">),</span>

	<span class="cm">/*</span>
<span class="cm">	 * generic hardware linkage</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">ehci_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">HCD_MEMORY</span> <span class="o">|</span> <span class="n">HCD_USB2</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * basic lifecycle operations</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">ehci_orion_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">ehci_run</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">ehci_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">ehci_shutdown</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * managing i/o requests and associated device resources</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">urb_enqueue</span> <span class="o">=</span> <span class="n">ehci_urb_enqueue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">urb_dequeue</span> <span class="o">=</span> <span class="n">ehci_urb_dequeue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">endpoint_disable</span> <span class="o">=</span> <span class="n">ehci_endpoint_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">endpoint_reset</span> <span class="o">=</span> <span class="n">ehci_endpoint_reset</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * scheduling support</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">get_frame_number</span> <span class="o">=</span> <span class="n">ehci_get_frame</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * root hub support</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">hub_status_data</span> <span class="o">=</span> <span class="n">ehci_hub_status_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hub_control</span> <span class="o">=</span> <span class="n">ehci_hub_control</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_suspend</span> <span class="o">=</span> <span class="n">ehci_bus_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_resume</span> <span class="o">=</span> <span class="n">ehci_bus_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">relinquish_port</span> <span class="o">=</span> <span class="n">ehci_relinquish_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_handed_over</span> <span class="o">=</span> <span class="n">ehci_port_handed_over</span><span class="p">,</span>

	<span class="p">.</span><span class="n">clear_tt_buffer_complete</span> <span class="o">=</span> <span class="n">ehci_clear_tt_buffer_complete</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">ehci_orion_conf_mbus_windows</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">mbus_dram_target_info</span> <span class="o">*</span><span class="n">dram</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrl</span><span class="p">(</span><span class="n">USB_WINDOW_CTRL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">wrl</span><span class="p">(</span><span class="n">USB_WINDOW_BASE</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dram</span><span class="o">-&gt;</span><span class="n">num_cs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">mbus_dram_window</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">dram</span><span class="o">-&gt;</span><span class="n">cs</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">wrl</span><span class="p">(</span><span class="n">USB_WINDOW_CTRL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mbus_attr</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">dram</span><span class="o">-&gt;</span><span class="n">mbus_dram_target_id</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">wrl</span><span class="p">(</span><span class="n">USB_WINDOW_BASE</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ehci_orion_drv_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">orion_ehci_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mbus_dram_target_info</span> <span class="o">*</span><span class="n">dram</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_disabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Initializing Orion-SoC USB Host Controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Found HC with no IRQ. Check %s setup!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Found HC with no register addr. Check %s setup!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
				<span class="n">ehci_orion_hc_driver</span><span class="p">.</span><span class="n">description</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error mapping memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Not all platforms can gate the clock, so it is not</span>
<span class="cm">	   an error if the clock does not exists. */</span>
	<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hcd</span> <span class="o">=</span> <span class="n">usb_create_hcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehci_orion_hc_driver</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hcd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_start</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_len</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">regs</span><span class="p">;</span>

	<span class="n">ehci</span> <span class="o">=</span> <span class="n">hcd_to_ehci</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">=</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="mh">0x100</span> <span class="o">+</span>
		<span class="n">HC_LENGTH</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">hc_capbase</span><span class="p">));</span>
	<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">has_tt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">sbrn</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * (Re-)program MBUS remapping windows if we are asked to.</span>
<span class="cm">	 */</span>
	<span class="n">dram</span> <span class="o">=</span> <span class="n">mv_mbus_dram_info</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dram</span><span class="p">)</span>
		<span class="n">ehci_orion_conf_mbus_windows</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">dram</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * setup Orion USB controller.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">phy_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EHCI_PHY_NA</span>:	<span class="cm">/* dont change USB phy settings */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EHCI_PHY_ORION</span>:
		<span class="n">orion_usb_phy_v1_setup</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EHCI_PHY_DD</span>:
	<span class="k">case</span> <span class="n">EHCI_PHY_KW</span>:
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Orion ehci -USB phy version isn&#39;t supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_add_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err4:</span>
	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
<span class="nl">err3:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="nl">err2:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
<span class="nl">err1:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;init %s fail, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">ehci_orion_drv_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>

	<span class="n">usb_remove_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_start</span><span class="p">,</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_len</span><span class="p">);</span>
	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clk_disable_unprepare</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:orion-ehci&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ehci_orion_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ehci_orion_drv_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">ehci_orion_drv_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">usb_hcd_platform_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;orion-ehci&quot;</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
