<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › host › isp1362-hcd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>isp1362-hcd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ISP1362 HCD (Host Controller Driver) for USB.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005 Lothar Wassmann &lt;LW@KARO-electronics.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Derived from the SL811 HCD, rewritten for ISP116x.</span>
<span class="cm"> * Copyright (C) 2005 Olav Kongas &lt;ok@artecdesign.ee&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Portions:</span>
<span class="cm"> * Copyright (C) 2004 Psion Teklogix (for NetBook PRO)</span>
<span class="cm"> * Copyright (C) 2004 David Brownell</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The ISP1362 chip requires a large delay (300ns and 462ns) between</span>
<span class="cm"> * accesses to the address and data register.</span>
<span class="cm"> * The following timing options exist:</span>
<span class="cm"> *</span>
<span class="cm"> * 1. Configure your memory controller to add such delays if it can (the best)</span>
<span class="cm"> * 2. Implement platform-specific delay function possibly</span>
<span class="cm"> *    combined with configuring the memory controller; see</span>
<span class="cm"> *    include/linux/usb_isp1362.h for more info.</span>
<span class="cm"> * 3. Use ndelay (easiest, poorest).</span>
<span class="cm"> *</span>
<span class="cm"> * Use the corresponding macros USE_PLATFORM_DELAY and USE_NDELAY in the</span>
<span class="cm"> * platform specific section of isp1362.h to select the appropriate variant.</span>
<span class="cm"> *</span>
<span class="cm"> * Also note that according to the Philips &quot;ISP1362 Errata&quot; document</span>
<span class="cm"> * Rev 1.00 from 27 May data corruption may occur when the #WR signal</span>
<span class="cm"> * is reasserted (even with #CS deasserted) within 132ns after a</span>
<span class="cm"> * write cycle to any controller register. If the hardware doesn&#39;t</span>
<span class="cm"> * implement the recommended fix (gating the #WR with #CS) software</span>
<span class="cm"> * must ensure that no further write cycle (not necessarily to the chip!)</span>
<span class="cm"> * is issued by the CPU within this interval.</span>

<span class="cm"> * For PXA25x this can be ensured by using VLIO with the maximum</span>
<span class="cm"> * recovery time (MSCx = 0x7f8c) with a memory clock of 99.53 MHz.</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_USB_DEBUG</span>
<span class="cp"># define ISP1362_DEBUG</span>
<span class="cp">#else</span>
<span class="cp"># undef ISP1362_DEBUG</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * The PXA255 UDC apparently doesn&#39;t handle GET_STATUS, GET_CONFIG and</span>
<span class="cm"> * GET_INTERFACE requests correctly when the SETUP and DATA stages of the</span>
<span class="cm"> * requests are carried out in separate frames. This will delay any SETUP</span>
<span class="cm"> * packets until the start of the next frame so that this situation is</span>
<span class="cm"> * unlikely to occur (and makes usbtest happy running with a PXA255 target</span>
<span class="cm"> * device).</span>
<span class="cm"> */</span>
<span class="cp">#undef BUGGY_PXA2XX_UDC_USBTEST</span>

<span class="cp">#undef PTD_TRACE</span>
<span class="cp">#undef URB_TRACE</span>
<span class="cp">#undef VERBOSE</span>
<span class="cp">#undef REGISTERS</span>

<span class="cm">/* This enables a memory test on the ISP1362 chip memory to make sure the</span>
<span class="cm"> * chip access timing is correct.</span>
<span class="cm"> */</span>
<span class="cp">#undef CHIP_BUFFER_TEST</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/isp1362.h&gt;</span>
<span class="cp">#include &lt;linux/usb/hcd.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/bitmap.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dbg_level</span><span class="p">;</span>
<span class="cp">#ifdef ISP1362_DEBUG</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dbg_level</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dbg_level</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#define	STUB_DEBUG_FILE</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;../core/usb.h&quot;</span>
<span class="cp">#include &quot;isp1362.h&quot;</span>


<span class="cp">#define DRIVER_VERSION	&quot;2005-04-04&quot;</span>
<span class="cp">#define DRIVER_DESC	&quot;ISP1362 USB Host Controller Driver&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">hcd_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;isp1362-hcd&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">isp1362_hc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isp1362_hc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">);</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * When called from the interrupthandler only isp1362_hcd-&gt;irqenb is modified,</span>
<span class="cm"> * since the interrupt handler will write isp1362_hcd-&gt;irqenb to HCuPINT upon</span>
<span class="cm"> * completion.</span>
<span class="cm"> * We don&#39;t need a &#39;disable&#39; counterpart, since interrupts will be disabled</span>
<span class="cm"> * only by the interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">isp1362_enable_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span> <span class="o">|</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span><span class="p">)</span>
		<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span><span class="p">);</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irq_active</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="nf">get_ptd_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span>
						     <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf_start</span><span class="p">)</span>
		<span class="n">epq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">buf_start</span><span class="p">)</span>
		<span class="n">epq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">buf_start</span><span class="p">)</span>
		<span class="n">epq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">buf_start</span> <span class="o">+</span>
		   <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">buf_size</span><span class="p">)</span>
		<span class="n">epq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">epq</span><span class="p">)</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: PTD $%04x is on %s queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: invalid PTD $%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">epq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_ptd_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">blk_size</span> <span class="o">&gt;</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Bad %s index %d(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
		     <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">/</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">blk_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_start</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">blk_size</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: %s PTD[%02x] # %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">max_transfer_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">mps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">xfer_size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">MAX_XFER_SIZE</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">xfer_size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">xfer_size</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_avail</span> <span class="o">*</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">blk_size</span> <span class="o">-</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xfer_size</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">xfer_size</span> <span class="o">%</span> <span class="n">mps</span><span class="p">)</span>
		<span class="n">xfer_size</span> <span class="o">-=</span> <span class="n">xfer_size</span> <span class="o">%</span> <span class="n">mps</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">xfer_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">claim_ptd_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ptd_offset</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_ptds</span> <span class="o">=</span> <span class="p">((</span><span class="n">len</span> <span class="o">+</span> <span class="n">PTD_HEADER_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">blk_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_avail</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_ptds</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: %s len %d/%d num_ptds %d buf_map %08lx skip_map %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">blk_size</span><span class="p">,</span> <span class="n">num_ptds</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_map</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_ptds</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">found</span> <span class="o">=</span> <span class="n">bitmap_find_next_zero_area</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_map</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">num_ptds</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&gt;=</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Found %d PTDs[%d] for %d/%d byte</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">num_ptds</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">blk_size</span> <span class="o">-</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">));</span>
	<span class="n">ptd_offset</span> <span class="o">=</span> <span class="n">get_ptd_offset</span><span class="p">(</span><span class="n">epq</span><span class="p">,</span> <span class="n">found</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ptd_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span> <span class="o">=</span> <span class="n">ptd_offset</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_ptds</span> <span class="o">+=</span> <span class="n">num_ptds</span><span class="p">;</span>
	<span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_avail</span> <span class="o">-=</span> <span class="n">num_ptds</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_avail</span> <span class="o">&gt;</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span> <span class="o">=</span> <span class="n">found</span><span class="p">;</span>
	<span class="n">bitmap_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_map</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="n">num_ptds</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Done %s PTD[%d] $%04x, avail %d count %d claimed %d %08lx:%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">,</span>
	    <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_avail</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">,</span> <span class="n">num_ptds</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_map</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">release_ptd_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">last</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_ptds</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&gt;</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: ep %p req %d len %d %s PTD[%d] $%04x num_ptds %d buf_count %d buf_avail %d buf_map %08lx skip_map %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span><span class="p">,</span>
		    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_ptds</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_avail</span><span class="p">,</span>
		    <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_map</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">last</span> <span class="o">&gt;</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">);</span>

	<span class="n">bitmap_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_map</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_ptds</span><span class="p">);</span>
	<span class="n">bitmap_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_ptds</span><span class="p">);</span>
	<span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_avail</span> <span class="o">+=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_ptds</span><span class="p">;</span>
	<span class="n">epq</span><span class="o">-&gt;</span><span class="n">ptd_count</span><span class="o">--</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_avail</span> <span class="o">&gt;</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">ptd_count</span> <span class="o">&gt;</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Done %s PTDs $%04x released %d avail %d count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_ptds</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_avail</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: buf_map %08lx skip_map %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_map</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span><span class="p">);</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_ptds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm">  Set up PTD&#39;s.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_ptd</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">fno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ptd</span> <span class="o">*</span><span class="n">ptd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">toggle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">buf_len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">-</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: %s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="n">ptd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd</span><span class="p">;</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_PID_IN</span>:
		<span class="n">toggle</span> <span class="o">=</span> <span class="n">usb_gettoggle</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">PTD_DIR_IN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeisoc</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">fno</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">MAX_XFER_SIZE</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">fno</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">max_transfer_size</span><span class="p">(</span><span class="n">epq</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: IN    len %d/%d/%d from URB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">buf_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_PID_OUT</span>:
		<span class="n">toggle</span> <span class="o">=</span> <span class="n">usb_gettoggle</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">PTD_DIR_OUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeisoc</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">MAX_XFER_SIZE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">max_transfer_size</span><span class="p">(</span><span class="n">epq</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Sending ZERO packet: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			     <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">&amp;</span> <span class="n">URB_ZERO_PACKET</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: OUT   len %d/%d/%d from URB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">buf_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_PID_SETUP</span>:
		<span class="n">toggle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">PTD_DIR_SETUP</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ctrlrequest</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: SETUP len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">setup_packet</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_PID_ACK</span>:
		<span class="n">toggle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">&amp;&amp;</span> <span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PTD_DIR_OUT</span> <span class="o">:</span> <span class="n">PTD_DIR_IN</span><span class="p">;</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: ACK   len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">toggle</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s@%d: ep-&gt;nextpid %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">PTD_CC_MSK</span> <span class="o">|</span> <span class="n">PTD_ACTIVE_MSK</span> <span class="o">|</span> <span class="n">PTD_TOGGLE</span><span class="p">(</span><span class="n">toggle</span><span class="p">);</span>
	<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">mps</span> <span class="o">=</span> <span class="n">PTD_MPS</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">)</span> <span class="o">|</span> <span class="n">PTD_SPD</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_LOW</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">PTD_EP</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">);</span>
	<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">PTD_LEN</span><span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="o">|</span> <span class="n">PTD_DIR</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">faddr</span> <span class="o">=</span> <span class="n">PTD_FA</span><span class="p">(</span><span class="n">usb_pipedevice</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeint</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">faddr</span> <span class="o">|=</span> <span class="n">PTD_SF_INT</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">);</span>
		<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">faddr</span> <span class="o">|=</span> <span class="n">PTD_PR</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">?</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeisoc</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
		<span class="n">ptd</span><span class="o">-&gt;</span><span class="n">faddr</span> <span class="o">|=</span> <span class="n">PTD_SF_ISO</span><span class="p">(</span><span class="n">fno</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1362_write_ptd</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ptd</span> <span class="o">*</span><span class="n">ptd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">PTD_GET_DIR</span><span class="p">(</span><span class="n">ptd</span><span class="p">)</span> <span class="o">==</span> <span class="n">PTD_DIR_IN</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="n">_BUG_ON</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">prefetch</span><span class="p">(</span><span class="n">ptd</span><span class="p">);</span>
	<span class="n">isp1362_write_buffer</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ptd</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">,</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="n">isp1362_write_buffer</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span> <span class="o">+</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">dump_ptd</span><span class="p">(</span><span class="n">ptd</span><span class="p">);</span>
	<span class="n">dump_ptd_out_data</span><span class="p">(</span><span class="n">ptd</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1362_read_ptd</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ptd</span> <span class="o">*</span><span class="n">ptd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">act_len</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: ep %p removed from active list %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>

	<span class="n">prefetchw</span><span class="p">(</span><span class="n">ptd</span><span class="p">);</span>
	<span class="n">isp1362_read_buffer</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ptd</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">,</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">dump_ptd</span><span class="p">(</span><span class="n">ptd</span><span class="p">);</span>
	<span class="n">act_len</span> <span class="o">=</span> <span class="n">PTD_GET_COUNT</span><span class="p">(</span><span class="n">ptd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PTD_GET_DIR</span><span class="p">(</span><span class="n">ptd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PTD_DIR_IN</span> <span class="o">||</span> <span class="n">act_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">act_len</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: ep %p PTD $%04x act_len %d ep-&gt;length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
			 <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">,</span> <span class="n">act_len</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">act_len</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="cm">/* Only transfer the amount of data that has actually been overwritten</span>
<span class="cm">	 * in the chip buffer. We don&#39;t want any data that doesn&#39;t belong to the</span>
<span class="cm">	 * transfer to leak out of the chip to the callers transfer buffer!</span>
<span class="cm">	 */</span>
	<span class="n">prefetchw</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">isp1362_read_buffer</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span> <span class="o">+</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">,</span> <span class="n">act_len</span><span class="p">);</span>
	<span class="n">dump_ptd_in_data</span><span class="p">(</span><span class="n">ptd</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * INT PTDs will stay in the chip until data is available.</span>
<span class="cm"> * This function will remove a PTD from the chip when the URB is dequeued.</span>
<span class="cm"> * Must be called with the spinlock held and IRQs disabled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_ptd</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: ep %p PTD[%d] $%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">epq</span> <span class="o">=</span> <span class="n">get_ptd_queue</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">epq</span><span class="p">);</span>

	<span class="cm">/* put ep in remove_list for cleanup */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">remove_list</span><span class="p">));</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">remove_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">remove_list</span><span class="p">);</span>
	<span class="cm">/* let SOF interrupt handle the cleanup */</span>
	<span class="n">isp1362_enable_int</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT_SOF</span><span class="p">);</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* ISO queues don&#39;t have SKIP registers */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Disabling PTD[%02x] $%04x %08lx|%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">index</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">);</span>

	<span class="cm">/* prevent further processing of PTD (will be effective after next SOF) */</span>
	<span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epq</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: ATLSKIP = %08x -&gt; %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLSKIP</span><span class="p">),</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span><span class="p">);</span>
		<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLSKIP</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">isp1362_clr_mask16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">,</span> <span class="n">HCBUFSTAT_ATL_ACTIVE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">epq</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: INTLSKIP = %08x -&gt; %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLSKIP</span><span class="p">),</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span><span class="p">);</span>
		<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLSKIP</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">isp1362_clr_mask16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">,</span> <span class="n">HCBUFSTAT_INTL_ACTIVE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Take done or failed requests out of schedule. Give back</span>
<span class="cm">  processed urbs.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">finish_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
     <span class="n">__releases</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
     <span class="n">__acquires</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_SETUP</span><span class="p">;</span>

	<span class="n">URB_DBG</span><span class="p">(</span><span class="s">&quot;%s: req %d FA %d ep%d%s %s: len %d/%d %s stat %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">usb_pipedevice</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span>
		<span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span>
		<span class="o">!</span><span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;out&quot;</span> <span class="o">:</span> <span class="s">&quot;in&quot;</span><span class="p">,</span>
		<span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ctrl&quot;</span> <span class="o">:</span>
			<span class="n">usb_pipeint</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;int&quot;</span> <span class="o">:</span>
			<span class="n">usb_pipebulk</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;bulk&quot;</span> <span class="o">:</span>
			<span class="s">&quot;iso&quot;</span><span class="p">,</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
		<span class="o">!</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">&amp;</span> <span class="n">URB_SHORT_NOT_OK</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;short_ok&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>


	<span class="n">usb_hcd_unlink_urb_from_ep</span><span class="p">(</span><span class="n">isp1362_hcd_to_hcd</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">),</span> <span class="n">urb</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">usb_hcd_giveback_urb</span><span class="p">(</span><span class="n">isp1362_hcd_to_hcd</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">),</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* take idle endpoints out of the schedule right away */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* async deschedule */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* periodic deschedule */</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;deschedule qh%d/%p branch %d load %d bandwidth %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">,</span>
		    <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">,</span>
		    <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">],</span>
		    <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">]</span> <span class="o">-</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">);</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span> <span class="o">=</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Analyze transfer results, handle partial transfers and errors</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">postproc_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="n">get_urb</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ptd</span> <span class="o">*</span><span class="n">ptd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">short_ok</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">urbstat</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cc</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: ep %p req %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">);</span>

	<span class="n">udev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ptd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd</span><span class="p">;</span>
	<span class="n">cc</span> <span class="o">=</span> <span class="n">PTD_GET_CC</span><span class="p">(</span><span class="n">ptd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">==</span> <span class="n">PTD_NOTACCESSED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: req %d PTD %p Untouched by ISP1362</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">ptd</span><span class="p">);</span>
		<span class="n">cc</span> <span class="o">=</span> <span class="n">PTD_DEVNOTRESP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">short_ok</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">&amp;</span> <span class="n">URB_SHORT_NOT_OK</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">-</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>

	<span class="cm">/* Data underrun is special. For allowed underrun</span>
<span class="cm">	   we clear the error and continue as normal. For</span>
<span class="cm">	   forbidden underrun we finish the DATA stage</span>
<span class="cm">	   immediately while for control transfer,</span>
<span class="cm">	   we do a STATUS stage.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">==</span> <span class="n">PTD_DATAUNDERRUN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">short_ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: req %d Allowed data underrun short_%sok %d/%d/%d byte</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">short_ok</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not_&quot;</span><span class="p">,</span>
			    <span class="n">PTD_GET_COUNT</span><span class="p">(</span><span class="n">ptd</span><span class="p">),</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">cc</span> <span class="o">=</span> <span class="n">PTD_CC_NOERROR</span><span class="p">;</span>
			<span class="n">urbstat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: req %d Data Underrun %s nextpid %02x short_%sok %d/%d/%d byte</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span>
			    <span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;IN&quot;</span> <span class="o">:</span> <span class="s">&quot;OUT&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span><span class="p">,</span>
			    <span class="n">short_ok</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not_&quot;</span><span class="p">,</span>
			    <span class="n">PTD_GET_COUNT</span><span class="p">(</span><span class="n">ptd</span><span class="p">),</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_ACK</span><span class="p">;</span>
				<span class="cm">/* save the data underrun error code for later and</span>
<span class="cm">				 * proceed with the status stage</span>
<span class="cm">				 */</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">PTD_GET_COUNT</span><span class="p">(</span><span class="n">ptd</span><span class="p">);</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">&gt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
					<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">cc_to_error</span><span class="p">[</span><span class="n">PTD_DATAUNDERRUN</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">==</span> <span class="n">USB_PID_OUT</span><span class="p">,</span>
					      <span class="n">PTD_GET_TOGGLE</span><span class="p">(</span><span class="n">ptd</span><span class="p">));</span>
				<span class="n">urbstat</span> <span class="o">=</span> <span class="n">cc_to_error</span><span class="p">[</span><span class="n">PTD_DATAUNDERRUN</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">!=</span> <span class="n">PTD_CC_NOERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">cc</span> <span class="o">==</span> <span class="n">PTD_CC_STALL</span> <span class="o">||</span> <span class="n">cc</span> <span class="o">==</span> <span class="n">PTD_DATAOVERRUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">urbstat</span> <span class="o">=</span> <span class="n">cc_to_error</span><span class="p">[</span><span class="n">cc</span><span class="p">];</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: req %d nextpid %02x, status %d, error %d, error_count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span><span class="p">,</span> <span class="n">urbstat</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span>
			    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_PID_OUT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">PTD_GET_COUNT</span><span class="p">(</span><span class="n">ptd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: count=%d len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">PTD_GET_COUNT</span><span class="p">(</span><span class="n">ptd</span><span class="p">),</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">PTD_GET_COUNT</span><span class="p">(</span><span class="n">ptd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">&gt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">);</span>
		<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PTD_GET_TOGGLE</span><span class="p">(</span><span class="n">ptd</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">==</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: req %d xfer complete %d/%d status %d -&gt; 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span> <span class="n">urbstat</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: req %d %s Wait for ACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span>
				    <span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;IN&quot;</span> <span class="o">:</span> <span class="s">&quot;OUT&quot;</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_ACK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">||</span>
				    <span class="o">!</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">&amp;</span> <span class="n">URB_ZERO_PACKET</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">urbstat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: req %d URB %s status %d count %d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;IN&quot;</span> <span class="o">:</span> <span class="s">&quot;OUT&quot;</span><span class="p">,</span>
					    <span class="n">urbstat</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_PID_IN</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">PTD_GET_COUNT</span><span class="p">(</span><span class="n">ptd</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">&gt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">);</span>
		<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PTD_GET_TOGGLE</span><span class="p">(</span><span class="n">ptd</span><span class="p">));</span>
		<span class="cm">/* if transfer completed or (allowed) data underrun */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">==</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">len</span> <span class="o">%</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: req %d xfer complete %d/%d status %d -&gt; 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span> <span class="n">urbstat</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: req %d %s Wait for ACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span>
				    <span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;IN&quot;</span> <span class="o">:</span> <span class="s">&quot;OUT&quot;</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_ACK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">urbstat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: req %d URB %s status %d count %d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;IN&quot;</span> <span class="o">:</span> <span class="s">&quot;OUT&quot;</span><span class="p">,</span>
				    <span class="n">urbstat</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_PID_SETUP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">==</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_ACK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeout</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_OUT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_IN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_PID_ACK</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: req %d got ACK %d -&gt; 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span>
		    <span class="n">urbstat</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">urbstat</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">);</span>
		<span class="n">urbstat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urbstat</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: Finishing ep %p req %d urb %p status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">urbstat</span><span class="p">);</span>
		<span class="n">finish_request</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">urbstat</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">finish_unlinks</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">remove_list</span><span class="p">,</span> <span class="n">remove_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span> <span class="o">=</span>
			<span class="n">get_ptd_queue</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">epq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: remove PTD[%d] $%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_ptds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">release_ptd_buffers</span><span class="p">(</span><span class="n">epq</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="n">get_urb</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>

			<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Finishing req %d ep %p from remove_list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
			<span class="n">finish_request</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: ep %p removed from active list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">remove_list</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: ep %p removed from remove_list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">enable_atl_transfers</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">ptd_count</span><span class="p">)</span>
			<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLDTC</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">isp1362_enable_int</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT_ATL</span><span class="p">);</span>
		<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLSKIP</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">skip_map</span><span class="p">);</span>
		<span class="n">isp1362_set_mask16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">,</span> <span class="n">HCBUFSTAT_ATL_ACTIVE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">isp1362_enable_int</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT_SOF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">enable_intl_transfers</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp1362_enable_int</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT_INTL</span><span class="p">);</span>
	<span class="n">isp1362_set_mask16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">,</span> <span class="n">HCBUFSTAT_INTL_ACTIVE</span><span class="p">);</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLSKIP</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">skip_map</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">enable_istl_transfers</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp1362_enable_int</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">flip</span> <span class="o">?</span> <span class="n">HCuPINT_ISTL1</span> <span class="o">:</span> <span class="n">HCuPINT_ISTL0</span><span class="p">);</span>
	<span class="n">isp1362_set_mask16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">,</span> <span class="n">flip</span> <span class="o">?</span>
			   <span class="n">HCBUFSTAT_ISTL1_FULL</span> <span class="o">:</span> <span class="n">HCBUFSTAT_ISTL0_FULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">submit_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">free_ptd</span><span class="p">;</span>

	<span class="n">prepare_ptd</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">epq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">claim_ptd_buffers</span><span class="p">(</span><span class="n">epq</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: req %d No free %s PTD available: %d, %08lx:%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_ptds</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_map</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">index</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: req %d Not enough space for %d byte %s PTD %d %08lx:%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_ptds</span><span class="p">,</span>
		    <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_map</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">index</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: ep %p req %d len %d added to active list %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Submitting %s PTD $%04x for ep %p req %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">);</span>
	<span class="n">isp1362_write_ptd</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">epq</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_atl_transfers</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ptd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">defer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">finishing</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: finish_transfers is active for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="n">get_urb</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: Skipping active %s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Processing %s ep %p req %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">submit_req</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">epq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">defer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">defer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef BUGGY_PXA2XX_UDC_USBTEST</span>
		<span class="n">defer</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">==</span> <span class="n">USB_PID_SETUP</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">ptd_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Avoid starving of endpoints */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">.</span><span class="n">next</span> <span class="o">!=</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">.</span><span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: Cycling ASYNC schedule %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ptd_count</span><span class="p">);</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptd_count</span> <span class="o">||</span> <span class="n">defer</span><span class="p">)</span>
		<span class="n">enable_atl_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">defer</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ptd_count</span><span class="p">);</span>

	<span class="n">epq</span><span class="o">-&gt;</span><span class="n">ptd_count</span> <span class="o">+=</span> <span class="n">ptd_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">ptd_count</span> <span class="o">&gt;</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">stat_maxptds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">epq</span><span class="o">-&gt;</span><span class="n">stat_maxptds</span> <span class="o">=</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">ptd_count</span><span class="p">;</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: max_ptds: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">stat_maxptds</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_intl_transfers</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ptd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">finishing</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: finish_transfers is active for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="n">get_urb</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Skipping active %s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			    <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Processing %s ep %p req %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">submit_req</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">epq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ptd_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptd_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">last_count</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ptd_count</span> <span class="o">!=</span> <span class="n">last_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: ptd_count: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ptd_count</span><span class="p">);</span>
			<span class="n">last_count</span> <span class="o">=</span> <span class="n">ptd_count</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">enable_intl_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">epq</span><span class="o">-&gt;</span><span class="n">ptd_count</span> <span class="o">+=</span> <span class="n">ptd_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">ptd_count</span> <span class="o">&gt;</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">stat_maxptds</span><span class="p">)</span>
		<span class="n">epq</span><span class="o">-&gt;</span><span class="n">stat_maxptds</span> <span class="o">=</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">ptd_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">next_ptd</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ptd_offset</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_ptds</span> <span class="o">=</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="n">PTD_HEADER_SIZE</span> <span class="o">+</span> <span class="p">(</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">blk_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">blk_size</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: PTD offset $%04x + %04x =&gt; %d * %04x -&gt; $%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ptd_offset</span><span class="p">,</span>
	    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">num_ptds</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">blk_size</span><span class="p">,</span> <span class="n">ptd_offset</span> <span class="o">+</span> <span class="n">num_ptds</span> <span class="o">*</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">blk_size</span><span class="p">);</span>

	<span class="n">ptd_offset</span> <span class="o">+=</span> <span class="n">num_ptds</span> <span class="o">*</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">blk_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptd_offset</span> <span class="o">&lt;</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_start</span> <span class="o">+</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ptd_offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_iso_transfers</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ptd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flip</span> <span class="o">=</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_flip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ptd_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fno</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCFMNUM</span><span class="p">);</span>

 <span class="nl">fill2:</span>
	<span class="n">epq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="n">flip</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">finishing</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: finish_transfers is active for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ptd_offset</span> <span class="o">=</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_start</span><span class="p">;</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">isoc</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="n">get_urb</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">s16</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">fno</span> <span class="o">-</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">start_frame</span><span class="p">;</span>

		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Processing %s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* time frame for this URB has elapsed */</span>
			<span class="n">finish_request</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* URB is not due in this frame or the next one.</span>
<span class="cm">			 * Comparing with &#39;-1&#39; instead of &#39;0&#39; accounts for double</span>
<span class="cm">			 * buffering in the ISP1362 which enables us to queue the PTD</span>
<span class="cm">			 * one frame ahead of time</span>
<span class="cm">			 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* submit PTD&#39;s that are due in the next frame */</span>
			<span class="n">prepare_ptd</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">epq</span><span class="p">,</span> <span class="n">fno</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptd_offset</span> <span class="o">+</span> <span class="n">PTD_HEADER_SIZE</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span>
			    <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_start</span> <span class="o">+</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Not enough ISO buffer space for %d byte PTD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span> <span class="o">=</span> <span class="n">ptd_offset</span><span class="p">;</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>

			<span class="n">ptd_offset</span> <span class="o">=</span> <span class="n">next_ptd</span><span class="p">(</span><span class="n">epq</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptd_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: req %d No more %s PTD buffers available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				     <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd</span><span class="p">.</span><span class="n">mps</span> <span class="o">|=</span> <span class="n">PTD_LAST_MSK</span><span class="p">;</span>
		<span class="n">isp1362_write_ptd</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">epq</span><span class="p">);</span>
		<span class="n">ptd_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptd_count</span><span class="p">)</span>
		<span class="n">enable_istl_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">flip</span><span class="p">);</span>

	<span class="n">epq</span><span class="o">-&gt;</span><span class="n">ptd_count</span> <span class="o">+=</span> <span class="n">ptd_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">ptd_count</span> <span class="o">&gt;</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">stat_maxptds</span><span class="p">)</span>
		<span class="n">epq</span><span class="o">-&gt;</span><span class="n">stat_maxptds</span> <span class="o">=</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">ptd_count</span><span class="p">;</span>

	<span class="cm">/* check, whether the second ISTL buffer may also be filled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">)</span> <span class="o">&amp;</span>
	      <span class="p">(</span><span class="n">flip</span> <span class="o">?</span> <span class="n">HCBUFSTAT_ISTL0_FULL</span> <span class="o">:</span> <span class="n">HCBUFSTAT_ISTL1_FULL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">fno</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ptd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">flip</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">flip</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fill2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">finish_transfers</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">done_map</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Nothing to do for %s queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Finishing %s transfers %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">done_map</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">finishing</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span><span class="p">;</span>

		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Checking %s PTD[%02x] $%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">index</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">);</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__test_and_clear_bit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done_map</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">isp1362_read_ptd</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">epq</span><span class="p">);</span>
			<span class="n">epq</span><span class="o">-&gt;</span><span class="n">free_ptd</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_ptds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">release_ptd_buffers</span><span class="p">(</span><span class="n">epq</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

			<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: ep %p req %d removed from active list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			    <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">remove_list</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">remove_list</span><span class="p">);</span>
				<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: ep %p removed from remove list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Postprocessing %s ep %p req %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">);</span>
			<span class="n">postproc_ep</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done_map</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">done_map</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: done_map not clear: %08lx:%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">done_map</span><span class="p">,</span>
		     <span class="n">epq</span><span class="o">-&gt;</span><span class="n">skip_map</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">finishing</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">finish_iso_transfers</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1362_ep_queue</span> <span class="o">*</span><span class="n">epq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Nothing to do for %s queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Finishing %s transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">finishing</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Checking PTD $%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">);</span>

		<span class="n">isp1362_read_ptd</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">epq</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Postprocessing %s ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">epq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="n">postproc_ep</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">blk_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epq</span><span class="o">-&gt;</span><span class="n">finishing</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">isp1362_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">irqstat</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">svc_mask</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irq_active</span><span class="o">++</span><span class="p">);</span>

	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">irqstat</span> <span class="o">=</span> <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: got IRQ %04x:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">irqstat</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span><span class="p">);</span>

	<span class="cm">/* only handle interrupts that are currently enabled */</span>
	<span class="n">irqstat</span> <span class="o">&amp;=</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span><span class="p">;</span>
	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">,</span> <span class="n">irqstat</span><span class="p">);</span>
	<span class="n">svc_mask</span> <span class="o">=</span> <span class="n">irqstat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">HCuPINT_SOF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_SOF</span><span class="p">;</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irq_stat</span><span class="p">[</span><span class="n">ISP1362_INT_SOF</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">svc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_SOF</span><span class="p">;</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: SOF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">fmindex</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCFMNUM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">remove_list</span><span class="p">))</span>
			<span class="n">finish_unlinks</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">HCuPINT_ATL</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">active</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">start_atl_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">isp1362_enable_int</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT_ATL</span><span class="p">);</span>
				<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLSKIP</span><span class="p">,</span>
						    <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">skip_map</span><span class="p">);</span>
				<span class="n">isp1362_set_mask16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">,</span> <span class="n">HCBUFSTAT_ATL_ACTIVE</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">HCuPINT_ISTL0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irq_stat</span><span class="p">[</span><span class="n">ISP1362_INT_ISTL0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">svc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_ISTL0</span><span class="p">;</span>
		<span class="n">isp1362_clr_mask16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">,</span> <span class="n">HCBUFSTAT_ISTL0_FULL</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: ISTL0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="o">!!</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_flip</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">HCBUFSTAT_ISTL0_ACTIVE</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">HCBUFSTAT_ISTL0_DONE</span><span class="p">));</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_ISTL0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">HCuPINT_ISTL1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irq_stat</span><span class="p">[</span><span class="n">ISP1362_INT_ISTL1</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">svc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_ISTL1</span><span class="p">;</span>
		<span class="n">isp1362_clr_mask16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">,</span> <span class="n">HCBUFSTAT_ISTL1_FULL</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: ISTL1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_flip</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">HCBUFSTAT_ISTL1_ACTIVE</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">HCBUFSTAT_ISTL1_DONE</span><span class="p">));</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_ISTL1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HCuPINT_ISTL0</span> <span class="o">|</span> <span class="n">HCuPINT_ISTL1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">((</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HCuPINT_ISTL0</span> <span class="o">|</span> <span class="n">HCuPINT_ISTL1</span><span class="p">))</span> <span class="o">==</span>
			<span class="p">(</span><span class="n">HCuPINT_ISTL0</span> <span class="o">|</span> <span class="n">HCuPINT_ISTL1</span><span class="p">));</span>
		<span class="n">finish_iso_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_flip</span><span class="p">]);</span>
		<span class="n">start_iso_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_flip</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_flip</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">HCuPINT_INTL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">done_map</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLDONE</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">skip_map</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLSKIP</span><span class="p">);</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irq_stat</span><span class="p">[</span><span class="n">ISP1362_INT_INTL</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="n">DBG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: INTL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">svc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_INTL</span><span class="p">;</span>

		<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLSKIP</span><span class="p">,</span> <span class="n">skip_map</span> <span class="o">|</span> <span class="n">done_map</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">done_map</span> <span class="o">|</span> <span class="n">skip_map</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* All PTDs are finished, disable INTL processing entirely */</span>
			<span class="n">isp1362_clr_mask16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">,</span> <span class="n">HCBUFSTAT_INTL_ACTIVE</span><span class="p">);</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">done_map</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">done_map</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: INTL done_map %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">done_map</span><span class="p">);</span>
			<span class="n">finish_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">done_map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">);</span>
			<span class="n">start_intl_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">HCuPINT_ATL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">done_map</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLDONE</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">skip_map</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLSKIP</span><span class="p">);</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irq_stat</span><span class="p">[</span><span class="n">ISP1362_INT_ATL</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="n">DBG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: ATL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">svc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_ATL</span><span class="p">;</span>

		<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLSKIP</span><span class="p">,</span> <span class="n">skip_map</span> <span class="o">|</span> <span class="n">done_map</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">done_map</span> <span class="o">|</span> <span class="n">skip_map</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">isp1362_clr_mask16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">,</span> <span class="n">HCBUFSTAT_ATL_ACTIVE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">done_map</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: ATL done_map %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">done_map</span><span class="p">);</span>
			<span class="n">finish_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">done_map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">);</span>
			<span class="n">start_atl_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">HCuPINT_OPR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">intstat</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTSTAT</span><span class="p">);</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irq_stat</span><span class="p">[</span><span class="n">ISP1362_INT_OPR</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="n">svc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_OPR</span><span class="p">;</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: OPR %08x:%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">intstat</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intenb</span><span class="p">);</span>
		<span class="n">intstat</span> <span class="o">&amp;=</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intenb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">OHCI_INTR_UE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unrecoverable error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* FIXME: do here reset or cleanup or whatever */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">OHCI_INTR_RHSC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhstatus</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHSTATUS</span><span class="p">);</span>
			<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhport</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT1</span><span class="p">);</span>
			<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhport</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">OHCI_INTR_RD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: RESUME DETECTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">);</span>
			<span class="n">usb_hcd_resume_root_hub</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTSTAT</span><span class="p">,</span> <span class="n">intstat</span><span class="p">);</span>
		<span class="n">irqstat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_OPR</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">HCuPINT_SUSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irq_stat</span><span class="p">[</span><span class="n">ISP1362_INT_SUSP</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">svc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_SUSP</span><span class="p">;</span>

		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: SUSPEND IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">HCuPINT_CLKRDY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irq_stat</span><span class="p">[</span><span class="n">ISP1362_INT_CLKRDY</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_CLKRDY</span><span class="p">;</span>
		<span class="n">svc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCuPINT_CLKRDY</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: CLKRDY IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">svc_mask</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Unserviced interrupt(s) %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">svc_mask</span><span class="p">);</span>

	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span><span class="p">);</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irq_active</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#define	MAX_PERIODIC_LOAD	900	</span><span class="cm">/* out of 1000 usec */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">balance</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">interval</span><span class="p">,</span> <span class="n">u16</span> <span class="n">load</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">branch</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="cm">/* search for the least loaded schedule branch of that interval</span>
<span class="cm">	 * which has enough bandwidth left unreserved.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">interval</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">branch</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="n">interval</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">load</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_PERIODIC_LOAD</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: new load %d load[%02x] %d max %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					    <span class="n">load</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">MAX_PERIODIC_LOAD</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">branch</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">branch</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* NB! ALL the code above this point runs with isp1362_hcd-&gt;lock</span>
<span class="cm">   held, irqs off</span>
<span class="cm">*/</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp1362_urb_enqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
			       <span class="n">gfp_t</span> <span class="n">mem_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_out</span> <span class="o">=</span> <span class="o">!</span><span class="n">usb_pipein</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">usb_pipetype</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">epnum</span> <span class="o">=</span> <span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">hep</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: urb %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_ISOCHRONOUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Isochronous transfers not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">URB_DBG</span><span class="p">(</span><span class="s">&quot;%s: FA %d ep%d%s %s: len %d %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">usb_pipedevice</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">epnum</span><span class="p">,</span>
		<span class="n">is_out</span> <span class="o">?</span> <span class="s">&quot;out&quot;</span> <span class="o">:</span> <span class="s">&quot;in&quot;</span><span class="p">,</span>
		<span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ctrl&quot;</span> <span class="o">:</span>
			<span class="n">usb_pipeint</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;int&quot;</span> <span class="o">:</span>
			<span class="n">usb_pipebulk</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;bulk&quot;</span> <span class="o">:</span>
			<span class="s">&quot;iso&quot;</span><span class="p">,</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
		<span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">&amp;</span> <span class="n">URB_ZERO_PACKET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ZERO_PACKET &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="o">!</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">&amp;</span> <span class="n">URB_SHORT_NOT_OK</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;short_ok&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="cm">/* avoid all allocations within spinlocks: request or endpoint */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">mem_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* don&#39;t submit to a dead or disabled port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhport</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhport</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>
	      <span class="n">USB_PORT_STAT_ENABLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">HC_IS_RUNNING</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_not_linked</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_hcd_link_urb_to_ep</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_not_linked</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">remove_list</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">usb_get_dev</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span> <span class="o">=</span> <span class="n">hep</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">=</span> <span class="n">epnum</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">usb_maxpacket</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="n">is_out</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">epnum</span><span class="p">,</span> <span class="n">is_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_CONTROL</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_SETUP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_out</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_OUT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_IN</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PIPE_ISOCHRONOUS</span>:
		<span class="k">case</span> <span class="n">PIPE_INTERRUPT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">)</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span> <span class="o">=</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span> <span class="o">=</span> <span class="n">usb_calc_bus_time</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="o">!</span><span class="n">is_out</span><span class="p">,</span>
						     <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_ISOCHRONOUS</span><span class="p">),</span>
						     <span class="n">usb_maxpacket</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">is_out</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span> <span class="o">=</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">req_serial</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* maybe put endpoint into schedule */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PIPE_CONTROL</span>:
	<span class="k">case</span> <span class="n">PIPE_BULK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Adding ep %p req %d to async schedule</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIPE_ISOCHRONOUS</span>:
	<span class="k">case</span> <span class="n">PIPE_INTERRUPT</span>:
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">;</span>

		<span class="cm">/* urb submitted for already existing EP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span> <span class="o">&lt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">balance</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: balance returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span> <span class="o">=</span> <span class="n">retval</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">fmindex</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCFMNUM</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Current frame %04x branch %02x start_frame %04x(%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">fmindex</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">,</span>
		    <span class="p">((</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">fmindex</span> <span class="o">+</span> <span class="n">PERIODIC_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
		     <span class="o">~</span><span class="p">(</span><span class="n">PERIODIC_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">fmindex</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PERIODIC_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_ISOCHRONOUS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u16</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">fmindex</span><span class="p">;</span>

				<span class="n">frame</span> <span class="o">+=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">);</span>
				<span class="n">frame</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">frame</span> <span class="o">|=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">frame_before</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">fmindex</span><span class="p">))</span>
					<span class="n">frame</span> <span class="o">+=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">;</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">start_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>

				<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Adding ep %p to isoc schedule</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">isoc</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Adding ep %p to periodic schedule</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: ep %p already scheduled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

		<span class="n">DBG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: load %d bandwidth %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span> <span class="o">/</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">],</span>
		    <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">]</span> <span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">);</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="n">hep</span><span class="p">;</span>
	<span class="n">ALIGNSTAT</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PIPE_CONTROL</span>:
	<span class="k">case</span> <span class="n">PIPE_BULK</span>:
		<span class="n">start_atl_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIPE_INTERRUPT</span>:
		<span class="n">start_intl_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIPE_ISOCHRONOUS</span>:
		<span class="n">start_iso_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
 <span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">usb_hcd_unlink_urb_from_ep</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>


 <span class="nl">fail_not_linked:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: urb %p failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp1362_urb_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">hep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: urb %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_hcd_check_unlink_urb</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">hep</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIDRM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* In front of queue? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: urb %p ep %p req %d active PTD[%d] $%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				    <span class="n">urb</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">);</span>
				<span class="cm">/* disable processing and queue PTD for removal */</span>
				<span class="n">remove_ptd</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
				<span class="n">urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Finishing ep %p req %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
			    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">);</span>
			<span class="n">finish_request</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: urb %p active; wait4irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: No EP in URB %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1362_endpoint_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">hep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: ep %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">remove_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Removing ep %p req %d PTD[%d] $%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			    <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num_req</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">);</span>
			<span class="n">remove_ptd</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Waiting for Interrupt to clean up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Wait for interrupt to clear out active list */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Freeing EP %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp1362_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">fmnum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fmnum</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCFMNUM</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">fmnum</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* Adapted from ohci-hub.c */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp1362_hub_status_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ports</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HC_IS_RUNNING</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

	<span class="cm">/* Report no status change now, if we are scheduled to be</span>
<span class="cm">	   called later */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rh_timer</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ports</span> <span class="o">=</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhdesca</span> <span class="o">&amp;</span> <span class="n">RH_A_NDP</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ports</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* init status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RH_HS_LPSC</span> <span class="o">|</span> <span class="n">RH_HS_OCIC</span><span class="p">))</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhport</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RH_PS_CSC</span> <span class="o">|</span> <span class="n">RH_PS_PESC</span> <span class="o">|</span> <span class="n">RH_PS_PSSC</span> <span class="o">|</span>
			      <span class="n">RH_PS_OCIC</span> <span class="o">|</span> <span class="n">RH_PS_PRSC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RH_PS_CCS</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1362_hub_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">usb_hub_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhdesca</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescLength</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bHubContrCurrent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bNbrPorts</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="cm">/* Power switching, device type, overcurrent. */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">wHubCharacteristics</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: hubcharacteristics = %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">));</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bPwrOn2PwrGood</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="cm">/* ports removable, and legacy PortPwrCtrlMask */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bNbrPorts</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Adapted from ohci-hub.c */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp1362_hub_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">typeReq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">wValue</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">wIndex</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">wLength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ports</span> <span class="o">=</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhdesca</span> <span class="o">&amp;</span> <span class="n">RH_A_NDP</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">typeReq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ClearHubFeature</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ClearHubFeature: &quot;</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">C_HUB_OVER_CURRENT</span>:
			<span class="n">_DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;C_HUB_OVER_CURRENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHSTATUS</span><span class="p">,</span> <span class="n">RH_HS_OCIC</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">C_HUB_LOCAL_POWER</span>:
			<span class="n">_DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;C_HUB_LOCAL_POWER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SetHubFeature</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;SetHubFeature: &quot;</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">C_HUB_OVER_CURRENT</span>:
		<span class="k">case</span> <span class="n">C_HUB_LOCAL_POWER</span>:
			<span class="n">_DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;C_HUB_OVER_CURRENT or C_HUB_LOCAL_POWER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetHubDescriptor</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;GetHubDescriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">isp1362_hub_descriptor</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_hub_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetHubStatus</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;GetHubStatus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">put_unaligned</span><span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetPortStatus</span>:
<span class="cp">#ifndef VERBOSE</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;GetPortStatus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wIndex</span> <span class="o">||</span> <span class="n">wIndex</span> <span class="o">&gt;</span> <span class="n">ports</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhport</span><span class="p">[</span><span class="o">--</span><span class="n">wIndex</span><span class="p">];</span>
		<span class="n">put_unaligned</span><span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ClearPortFeature</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ClearPortFeature: &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wIndex</span> <span class="o">||</span> <span class="n">wIndex</span> <span class="o">&gt;</span> <span class="n">ports</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">wIndex</span><span class="o">--</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_ENABLE</span>:
			<span class="n">_DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;USB_PORT_FEAT_ENABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_CCS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_ENABLE</span>:
			<span class="n">_DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;USB_PORT_FEAT_C_ENABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_PESC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_SUSPEND</span>:
			<span class="n">_DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;USB_PORT_FEAT_SUSPEND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_POCI</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_SUSPEND</span>:
			<span class="n">_DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;USB_PORT_FEAT_C_SUSPEND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_PSSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_POWER</span>:
			<span class="n">_DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;USB_PORT_FEAT_POWER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_LSDA</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_CONNECTION</span>:
			<span class="n">_DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;USB_PORT_FEAT_C_CONNECTION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_CSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_OVER_CURRENT</span>:
			<span class="n">_DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;USB_PORT_FEAT_C_OVER_CURRENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_OCIC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_RESET</span>:
			<span class="n">_DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;USB_PORT_FEAT_C_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">RH_PS_PRSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT1</span> <span class="o">+</span> <span class="n">wIndex</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhport</span><span class="p">[</span><span class="n">wIndex</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT1</span> <span class="o">+</span> <span class="n">wIndex</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SetPortFeature</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;SetPortFeature: &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wIndex</span> <span class="o">||</span> <span class="n">wIndex</span> <span class="o">&gt;</span> <span class="n">ports</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">wIndex</span><span class="o">--</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_SUSPEND</span>:
			<span class="n">_DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;USB_PORT_FEAT_SUSPEND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT1</span> <span class="o">+</span> <span class="n">wIndex</span><span class="p">,</span> <span class="n">RH_PS_PSS</span><span class="p">);</span>
			<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhport</span><span class="p">[</span><span class="n">wIndex</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT1</span> <span class="o">+</span> <span class="n">wIndex</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_POWER</span>:
			<span class="n">_DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;USB_PORT_FEAT_POWER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT1</span> <span class="o">+</span> <span class="n">wIndex</span><span class="p">,</span> <span class="n">RH_PS_PPS</span><span class="p">);</span>
			<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhport</span><span class="p">[</span><span class="n">wIndex</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT1</span> <span class="o">+</span> <span class="n">wIndex</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_RESET</span>:
			<span class="n">_DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;USB_PORT_FEAT_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">t1</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">USB_RESET_WIDTH</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">t1</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* spin until any current reset finishes */</span>
				<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT1</span> <span class="o">+</span> <span class="n">wIndex</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">RH_PS_PRS</span><span class="p">))</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">RH_PS_CCS</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="cm">/* Reset lasts 10ms (claims datasheet) */</span>
				<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT1</span> <span class="o">+</span> <span class="n">wIndex</span><span class="p">,</span> <span class="p">(</span><span class="n">RH_PS_PRS</span><span class="p">));</span>

				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhport</span><span class="p">[</span><span class="n">wIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span>
									 <span class="n">HCRHPORT1</span> <span class="o">+</span> <span class="n">wIndex</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
 <span class="nl">error:</span>
		<span class="cm">/* &quot;protocol stall&quot; on error */</span>
		<span class="n">_DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;PROTOCOL STALL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef	CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp1362_bus_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">next_statechange</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;</span> <span class="n">OHCI_CTRL_HCFS</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OHCI_USB_RESUME</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: resume/suspend?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OHCI_CTRL_HCFS</span><span class="p">;</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">|=</span> <span class="n">OHCI_USB_RESET</span><span class="p">;</span>
		<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">);</span>
		<span class="cm">/* FALL THROUGH */</span>
	<span class="k">case</span> <span class="n">OHCI_USB_RESET</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: needs reinit!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OHCI_USB_SUSPEND</span>:
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: already suspended?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: suspend root hub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* First stop any processing */</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_QUIESCING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">.</span><span class="n">active</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>

		<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLSKIP</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLSKIP</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTSTAT</span><span class="p">,</span> <span class="n">OHCI_INTR_SF</span><span class="p">);</span>

		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: stopping schedules ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
			<span class="n">limit</span> <span class="o">-=</span> <span class="mi">250</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OHCI_INTR_SF</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCuPINT_ATL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">done_map</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLDONE</span><span class="p">);</span>
			<span class="n">finish_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">done_map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCuPINT_INTL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">done_map</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLDONE</span><span class="p">);</span>
			<span class="n">finish_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">done_map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCuPINT_ISTL0</span><span class="p">)</span>
			<span class="n">finish_iso_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCuPINT_ISTL1</span><span class="p">)</span>
			<span class="n">finish_iso_transfers</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: HCINTSTAT: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTSTAT</span><span class="p">));</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTSTAT</span><span class="p">,</span>
			    <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTSTAT</span><span class="p">));</span>

	<span class="cm">/* Suspend hub */</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">=</span> <span class="n">OHCI_USB_SUSPEND</span><span class="p">;</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">);</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">);</span>

<span class="cp">#if 1</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;</span> <span class="n">OHCI_CTRL_HCFS</span><span class="p">)</span> <span class="o">!=</span> <span class="n">OHCI_USB_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: controller won&#39;t suspend %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="cm">/* no resumes until devices finish suspending */</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">next_statechange</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_SUSPENDED</span><span class="p">;</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: HCD suspended: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp1362_bus_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">next_statechange</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: HCCONTROL: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">HC_STATE_RESUMING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: duplicate resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;</span> <span class="n">OHCI_CTRL_HCFS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OHCI_USB_SUSPEND</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: resume root hub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OHCI_CTRL_HCFS</span><span class="p">;</span>
			<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">|=</span> <span class="n">OHCI_USB_RESUME</span><span class="p">;</span>
			<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OHCI_USB_RESUME</span>:
			<span class="cm">/* HCFS changes sometime after INTR_RD */</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: remote wakeup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OHCI_USB_OPER</span>:
			<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: odd resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">PMSG_ON</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>		<span class="cm">/* RESET, we lost power */</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: root hub hardware reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Restarting HC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">isp1362_hc_stop</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">isp1362_hc_start</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHDESCA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RH_A_NDP</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">port</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT1</span> <span class="o">+</span> <span class="n">port</span><span class="p">);</span>

		<span class="cm">/* force global, not selective, resume */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">RH_PS_PSS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Not Resuming RH port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Resuming RH port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT1</span> <span class="o">+</span> <span class="n">port</span><span class="p">,</span> <span class="n">RH_PS_POCI</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Some controllers (lucent) need extra-long delays */</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_RESUMING</span><span class="p">;</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span> <span class="cm">/* usb 11.5.1.10 */</span> <span class="o">+</span> <span class="mi">15</span><span class="p">);</span>

	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">=</span> <span class="n">OHCI_USB_OPER</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">);</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* TRSMRCY */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* keep it alive for ~5x suspend + resume costs */</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">next_statechange</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>

	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">PMSG_ON</span><span class="p">;</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_RUNNING</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define	isp1362_bus_suspend	NULL</span>
<span class="cp">#define	isp1362_bus_resume	NULL</span>
<span class="cp">#endif</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef STUB_DEBUG_FILE</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">create_debug_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">remove_debug_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%-15s %04x%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCuPINT_CLKRDY</span> <span class="o">?</span> <span class="s">&quot; clkrdy&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCuPINT_SUSP</span> <span class="o">?</span> <span class="s">&quot; susp&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCuPINT_OPR</span> <span class="o">?</span> <span class="s">&quot; opr&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCuPINT_EOT</span> <span class="o">?</span> <span class="s">&quot; eot&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCuPINT_ATL</span> <span class="o">?</span> <span class="s">&quot; atl&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">HCuPINT_SOF</span> <span class="o">?</span> <span class="s">&quot; sof&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%-15s %08x%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">OHCI_INTR_MIE</span> <span class="o">?</span> <span class="s">&quot; MIE&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">OHCI_INTR_RHSC</span> <span class="o">?</span> <span class="s">&quot; rhsc&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">OHCI_INTR_FNO</span> <span class="o">?</span> <span class="s">&quot; fno&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">OHCI_INTR_UE</span> <span class="o">?</span> <span class="s">&quot; ue&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">OHCI_INTR_RD</span> <span class="o">?</span> <span class="s">&quot; rd&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">OHCI_INTR_SF</span> <span class="o">?</span> <span class="s">&quot; sof&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">OHCI_INTR_SO</span> <span class="o">?</span> <span class="s">&quot; so&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%-15s %08x%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">OHCI_CTRL_RWC</span> <span class="o">?</span> <span class="s">&quot; rwc&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">OHCI_CTRL_RWE</span> <span class="o">?</span> <span class="s">&quot; rwe&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="p">({</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">hcfs</span><span class="p">;</span>
			   <span class="k">switch</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">OHCI_CTRL_HCFS</span><span class="p">)</span> <span class="p">{</span>
			   <span class="k">case</span> <span class="n">OHCI_USB_OPER</span>:
				   <span class="n">hcfs</span> <span class="o">=</span> <span class="s">&quot; oper&quot;</span><span class="p">;</span>
				   <span class="k">break</span><span class="p">;</span>
			   <span class="k">case</span> <span class="n">OHCI_USB_RESET</span>:
				   <span class="n">hcfs</span> <span class="o">=</span> <span class="s">&quot; reset&quot;</span><span class="p">;</span>
				   <span class="k">break</span><span class="p">;</span>
			   <span class="k">case</span> <span class="n">OHCI_USB_RESUME</span>:
				   <span class="n">hcfs</span> <span class="o">=</span> <span class="s">&quot; resume&quot;</span><span class="p">;</span>
				   <span class="k">break</span><span class="p">;</span>
			   <span class="k">case</span> <span class="n">OHCI_USB_SUSPEND</span>:
				   <span class="n">hcfs</span> <span class="o">=</span> <span class="s">&quot; suspend&quot;</span><span class="p">;</span>
				   <span class="k">break</span><span class="p">;</span>
			   <span class="nl">default:</span>
				   <span class="n">hcfs</span> <span class="o">=</span> <span class="s">&quot; ?&quot;</span><span class="p">;</span>
			   <span class="p">}</span>
			   <span class="n">hcfs</span><span class="p">;</span>
		   <span class="p">}));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCREVISION [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCREVISION</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCREVISION</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCCONTROL  [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCCONTROL</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCCMDSTAT  [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCCMDSTAT</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCMDSTAT</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCINTSTAT  [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCINTSTAT</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTSTAT</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCINTENB   [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCINTENB</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTENB</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCFMINTVL  [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCFMINTVL</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCFMINTVL</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCFMREM    [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCFMREM</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCFMREM</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCFMNUM    [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCFMNUM</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCFMNUM</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCLSTHRESH [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCLSTHRESH</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCLSTHRESH</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCRHDESCA  [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCRHDESCA</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHDESCA</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCRHDESCB  [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCRHDESCB</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHDESCB</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCRHSTATUS [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCRHSTATUS</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHSTATUS</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCRHPORT1  [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCRHPORT1</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT1</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCRHPORT2  [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCRHPORT2</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHPORT2</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCHWCFG    [%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCHWCFG</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCHWCFG</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCDMACFG   [%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCDMACFG</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCDMACFG</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCXFERCTR  [%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCXFERCTR</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCXFERCTR</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCuPINT    [%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCuPINT</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCuPINTENB [%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCuPINTENB</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCCHIPID   [%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCCHIPID</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCHIPID</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCSCRATCH  [%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCSCRATCH</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCSCRATCH</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCBUFSTAT  [%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCBUFSTAT</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCBUFSTAT</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCDIRADDR  [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCDIRADDR</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCDIRADDR</span><span class="p">));</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	seq_printf(s, &quot;HCDIRDATA  [%02x]     %04x\n&quot;, ISP1362_REG_NO(HCDIRDATA),</span>
<span class="c">		   isp1362_read_reg16(isp1362_hcd, HCDIRDATA));</span>
<span class="cp">#endif</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCISTLBUFSZ[%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCISTLBUFSZ</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCISTLBUFSZ</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCISTLRATE [%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCISTLRATE</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCISTLRATE</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCINTLBUFSZ[%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCINTLBUFSZ</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLBUFSZ</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCINTLBLKSZ[%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCINTLBLKSZ</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLBLKSZ</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCINTLDONE [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCINTLDONE</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLDONE</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCINTLSKIP [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCINTLSKIP</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLSKIP</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCINTLLAST [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCINTLLAST</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLLAST</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCINTLCURR [%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCINTLCURR</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLCURR</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCATLBUFSZ [%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCATLBUFSZ</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLBUFSZ</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCATLBLKSZ [%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCATLBLKSZ</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLBLKSZ</span><span class="p">));</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	seq_printf(s, &quot;HCATLDONE  [%02x] %08x\n&quot;, ISP1362_REG_NO(ISP1362_REG_HCATLDONE),</span>
<span class="c">		   isp1362_read_reg32(isp1362_hcd, HCATLDONE));</span>
<span class="cp">#endif</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCATLSKIP  [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCATLSKIP</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLSKIP</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCATLLAST  [%02x] %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCATLLAST</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLLAST</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCATLCURR  [%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCATLCURR</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLCURR</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCATLDTC   [%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCATLDTC</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLDTC</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCATLDTCTO [%02x]     %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ISP1362_REG_NO</span><span class="p">(</span><span class="n">ISP1362_REG_HCATLDTCTO</span><span class="p">),</span>
		   <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLDTCTO</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_isp1362_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">%s version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">isp1362_hcd_to_hcd</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">product_desc</span><span class="p">,</span> <span class="n">hcd_name</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span><span class="p">);</span>

	<span class="cm">/* collect statistics to help estimate potential win for</span>
<span class="cm">	 * DMA engines that care about alignment (PXA)</span>
<span class="cm">	 */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;alignment:  16b/%ld 8b/%ld 4b/%ld 2b/%ld 1b/%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">stat16</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">stat8</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">stat4</span><span class="p">,</span>
		   <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">stat2</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">stat1</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;max # ptds in ATL  fifo: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">stat_maxptds</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;max # ptds in INTL fifo: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">stat_maxptds</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;max # ptds in ISTL fifo: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">max</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">.</span><span class="n">stat_maxptds</span><span class="p">,</span>
		       <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">.</span><span class="n">stat_maxptds</span><span class="p">));</span>

	<span class="cm">/* FIXME: don&#39;t show the following in suspended state */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dump_irq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;hc_irq_enable&quot;</span><span class="p">,</span> <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">));</span>
	<span class="n">dump_irq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;hc_irq_status&quot;</span><span class="p">,</span> <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">));</span>
	<span class="n">dump_int</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;ohci_int_enable&quot;</span><span class="p">,</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTENB</span><span class="p">));</span>
	<span class="n">dump_int</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;ohci_int_status&quot;</span><span class="p">,</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTSTAT</span><span class="p">));</span>
	<span class="n">dump_ctrl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;ohci_control&quot;</span><span class="p">,</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_ISP1362_IRQS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irq_stat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%-15s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ISP1362_INT_NAME</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irq_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">dump_regs</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%p, ep%d%s, maxpacket %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span>
			   <span class="p">({</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
				   <span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span><span class="p">)</span> <span class="p">{</span>
				   <span class="k">case</span> <span class="n">USB_PID_IN</span>:
					   <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;in&quot;</span><span class="p">;</span>
					   <span class="k">break</span><span class="p">;</span>
				   <span class="k">case</span> <span class="n">USB_PID_OUT</span>:
					   <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;out&quot;</span><span class="p">;</span>
					   <span class="k">break</span><span class="p">;</span>
				   <span class="k">case</span> <span class="n">USB_PID_SETUP</span>:
					   <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;setup&quot;</span><span class="p">;</span>
					   <span class="k">break</span><span class="p">;</span>
				   <span class="k">case</span> <span class="n">USB_PID_ACK</span>:
					   <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;status&quot;</span><span class="p">;</span>
					   <span class="k">break</span><span class="p">;</span>
				   <span class="nl">default:</span>
					   <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;?&quot;</span><span class="p">;</span>
					   <span class="k">break</span><span class="p">;</span>
				   <span class="p">};</span>
				   <span class="n">s</span><span class="p">;}),</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">,</span> <span class="n">urb_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;  urb%p, %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span>
				   <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span>
				   <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">))</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dump_ptd_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;periodic size= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PERIODIC_SIZE</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;branch:%2d load:%3d PTD[%d] $%04x:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">,</span>
			   <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">],</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_index</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ptd_offset</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;   %d/%p (%sdev%d ep%d%s max %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ep</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;ls &quot;</span><span class="p">,</span>
			   <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span>
			   <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">==</span> <span class="n">USB_PID_IN</span><span class="p">)</span> <span class="o">?</span>
			    <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">),</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dump_ptd_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;ISO:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">isoc</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;   %d/%p (%sdev%d ep%d%s max %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ep</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;ls &quot;</span><span class="p">,</span>
			   <span class="n">ep</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span>
			   <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">==</span> <span class="n">USB_PID_IN</span><span class="p">)</span> <span class="o">?</span>
			    <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">),</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_isp1362_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">proc_isp1362_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">proc_isp1362_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* expect just one isp1362_hcd per system */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">proc_filename</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;driver/isp1362&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">create_debug_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">pde</span><span class="p">;</span>

	<span class="n">pde</span> <span class="o">=</span> <span class="n">create_proc_entry</span><span class="p">(</span><span class="n">proc_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pde</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Failed to create debug file &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">proc_filename</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pde</span><span class="o">-&gt;</span><span class="n">proc_fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">proc_ops</span><span class="p">;</span>
	<span class="n">pde</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">isp1362_hcd</span><span class="p">;</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">pde</span> <span class="o">=</span> <span class="n">pde</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_debug_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">pde</span><span class="p">)</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">proc_filename</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__isp1362_sw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCSWRES</span><span class="p">,</span> <span class="n">HCSWRES_MAGIC</span><span class="p">);</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCMDSTAT</span><span class="p">,</span> <span class="n">OHCI_HCR</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCMDSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OHCI_HCR</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Software reset timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1362_sw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__isp1362_sw_reset</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp1362_mem_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">total</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">istl_size</span> <span class="o">=</span> <span class="n">ISP1362_ISTL_BUFSIZE</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">intl_blksize</span> <span class="o">=</span> <span class="n">ISP1362_INTL_BLKSIZE</span> <span class="o">+</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">intl_size</span> <span class="o">=</span> <span class="n">ISP1362_INTL_BUFFERS</span> <span class="o">*</span> <span class="n">intl_blksize</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">atl_blksize</span> <span class="o">=</span> <span class="n">ISP1362_ATL_BLKSIZE</span> <span class="o">+</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">atl_buffers</span> <span class="o">=</span> <span class="p">(</span><span class="n">ISP1362_BUF_SIZE</span> <span class="o">-</span> <span class="p">(</span><span class="n">istl_size</span> <span class="o">+</span> <span class="n">intl_size</span><span class="p">))</span> <span class="o">/</span> <span class="n">atl_blksize</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">atl_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">istl_size</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">atl_blksize</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">intl_blksize</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">atl_blksize</span> <span class="o">&lt;</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">intl_blksize</span> <span class="o">&lt;</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">ISP1362_INTL_BUFFERS</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atl_buffers</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">atl_buffers</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">atl_size</span> <span class="o">=</span> <span class="n">atl_buffers</span> <span class="o">*</span> <span class="n">atl_blksize</span><span class="p">;</span>
	<span class="n">total</span> <span class="o">=</span> <span class="n">atl_size</span> <span class="o">+</span> <span class="n">intl_size</span> <span class="o">+</span> <span class="n">istl_size</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;ISP1362 Memory usage:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;  ISTL:    2 * %4d:     %4d @ $%04x:$%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">istl_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">istl_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">istl_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;  INTL: %4d * (%3zu+8):  %4d @ $%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ISP1362_INTL_BUFFERS</span><span class="p">,</span> <span class="n">intl_blksize</span> <span class="o">-</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">,</span>
		 <span class="n">intl_size</span><span class="p">,</span> <span class="n">istl_size</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;  ATL : %4d * (%3zu+8):  %4d @ $%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">atl_buffers</span><span class="p">,</span> <span class="n">atl_blksize</span> <span class="o">-</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">,</span>
		 <span class="n">atl_size</span><span class="p">,</span> <span class="n">istl_size</span> <span class="o">+</span> <span class="n">intl_size</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;  USED/FREE:   %4d      %4d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span>
		 <span class="n">ISP1362_BUF_SIZE</span> <span class="o">-</span> <span class="n">total</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">&gt;</span> <span class="n">ISP1362_BUF_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;%s: Memory requested: %d, available %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">ISP1362_BUF_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">total</span> <span class="o">=</span> <span class="n">istl_size</span> <span class="o">+</span> <span class="n">intl_size</span> <span class="o">+</span> <span class="n">atl_size</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">istl_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">istl_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blk_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">active</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;ISTL%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: %5s buf $%04x %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		     <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		     <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_start</span><span class="p">,</span>
		     <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">istl_queue</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCISTLBUFSZ</span><span class="p">,</span> <span class="n">istl_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">buf_start</span> <span class="o">=</span> <span class="n">istl_size</span><span class="p">;</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">intl_size</span><span class="p">;</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">buf_count</span> <span class="o">=</span> <span class="n">ISP1362_INTL_BUFFERS</span><span class="p">;</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">blk_size</span> <span class="o">=</span> <span class="n">intl_blksize</span><span class="p">;</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">buf_avail</span> <span class="o">=</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">buf_count</span><span class="p">;</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">skip_map</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>

	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLBUFSZ</span><span class="p">,</span>
			    <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">buf_size</span><span class="p">);</span>
	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLBLKSZ</span><span class="p">,</span>
			    <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">blk_size</span> <span class="o">-</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLSKIP</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTLLAST</span><span class="p">,</span>
			    <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ISP1362_INTL_BUFFERS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">buf_start</span> <span class="o">=</span> <span class="n">istl_size</span> <span class="o">+</span> <span class="n">intl_size</span><span class="p">;</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">atl_size</span><span class="p">;</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">buf_count</span> <span class="o">=</span> <span class="n">atl_buffers</span><span class="p">;</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">blk_size</span> <span class="o">=</span> <span class="n">atl_blksize</span><span class="p">;</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">buf_avail</span> <span class="o">=</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">buf_count</span><span class="p">;</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">skip_map</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>

	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLBUFSZ</span><span class="p">,</span>
			    <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">buf_size</span><span class="p">);</span>
	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLBLKSZ</span><span class="p">,</span>
			    <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">blk_size</span> <span class="o">-</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLSKIP</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCATLLAST</span><span class="p">,</span>
			    <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">atl_buffers</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;ATL&quot;</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;INTL&quot;</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: %5s buf $%04x %2d * %4d = %4d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	     <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">buf_start</span><span class="p">,</span>
	     <span class="n">ISP1362_INTL_BUFFERS</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">blk_size</span><span class="p">,</span>
	     <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intl_queue</span><span class="p">.</span><span class="n">buf_size</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: %5s buf $%04x %2d * %4d = %4d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	     <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	     <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">buf_start</span><span class="p">,</span>
	     <span class="n">atl_buffers</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">blk_size</span><span class="p">,</span>
	     <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">atl_queue</span><span class="p">.</span><span class="n">buf_size</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp1362_hc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clkrdy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">&amp;&amp;</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span>
			<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">isp1362_sw_reset</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>

	<span class="cm">/* chip has been reset. First we need to see a clock */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">clkrdy</span> <span class="o">&amp;&amp;</span> <span class="n">time_before_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">clkrdy</span> <span class="o">=</span> <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HCuPINT_CLKRDY</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clkrdy</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">,</span> <span class="n">HCuPINT_CLKRDY</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clkrdy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Clock not ready after %lums</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp1362_hc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rh_timer</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Switch off power for all ports */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHDESCA</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RH_A_NPS</span> <span class="o">|</span> <span class="n">RH_A_PSM</span><span class="p">);</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHDESCA</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHSTATUS</span><span class="p">,</span> <span class="n">RH_HS_LPS</span><span class="p">);</span>

	<span class="cm">/* Reset the chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">&amp;&amp;</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__isp1362_sw_reset</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">&amp;&amp;</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CHIP_BUFFER_TEST</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp1362_chip_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ref</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ISP1362_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">tst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ref</span><span class="p">[</span><span class="n">ISP1362_BUF_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">ISP1362_BUF_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ref</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">offset</span><span class="p">;</span>
			<span class="n">tst</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">isp1362_write_buffer</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ref</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
				<span class="n">isp1362_read_buffer</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">tst</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">tst</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
					<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: memory check with %d byte offset %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">__func__</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
					<span class="n">dump_data</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ref</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
					<span class="n">dump_data</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">tst</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">isp1362_write_buffer</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ISP1362_BUF_SIZE</span><span class="p">);</span>
		<span class="n">isp1362_read_buffer</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">tst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ISP1362_BUF_SIZE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">tst</span><span class="p">,</span> <span class="n">ISP1362_BUF_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: memory check failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">dump_data</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">tst</span><span class="p">,</span> <span class="n">ISP1362_BUF_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">test_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">yield</span><span class="p">();</span>

			<span class="n">memset</span><span class="p">(</span><span class="n">tst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ISP1362_BUF_SIZE</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">isp1362_write_buffer</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">tst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ISP1362_BUF_SIZE</span><span class="p">);</span>
			<span class="n">isp1362_read_buffer</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">tst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ISP1362_BUF_SIZE</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">tst</span><span class="p">,</span> <span class="n">tst</span> <span class="o">+</span> <span class="p">(</span><span class="n">ISP1362_BUF_SIZE</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tst</span><span class="p">))),</span>
				   <span class="n">ISP1362_BUF_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Failed to clear buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">dump_data</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">tst</span><span class="p">,</span> <span class="n">ISP1362_BUF_SIZE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">isp1362_write_buffer</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">offset</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">);</span>
			<span class="n">isp1362_write_buffer</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">ref</span> <span class="o">+</span> <span class="n">PTD_HEADER_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ref</span><span class="p">),</span>
					     <span class="n">offset</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">PTD_HEADER_SIZE</span><span class="p">,</span> <span class="n">test_size</span><span class="p">);</span>
			<span class="n">isp1362_read_buffer</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">tst</span><span class="p">,</span> <span class="n">offset</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
					    <span class="n">PTD_HEADER_SIZE</span> <span class="o">+</span> <span class="n">test_size</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">tst</span><span class="p">,</span> <span class="n">PTD_HEADER_SIZE</span> <span class="o">+</span> <span class="n">test_size</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dump_data</span><span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ref</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">PTD_HEADER_SIZE</span> <span class="o">+</span> <span class="n">test_size</span><span class="p">);</span>
				<span class="n">dump_data</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">tst</span><span class="p">,</span> <span class="n">PTD_HEADER_SIZE</span> <span class="o">+</span> <span class="n">test_size</span><span class="p">);</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">isp1362_read_buffer</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">tst</span><span class="p">,</span> <span class="n">offset</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
						    <span class="n">PTD_HEADER_SIZE</span> <span class="o">+</span> <span class="n">test_size</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">tst</span><span class="p">,</span> <span class="n">PTD_HEADER_SIZE</span> <span class="o">+</span> <span class="n">test_size</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
					<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: memory check with offset %02x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">__func__</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: memory check with offset %02x ok after second read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp1362_hc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp1362_platform_data</span> <span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hwcfg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">chipid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">chipid</span> <span class="o">=</span> <span class="n">isp1362_read_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCHIPID</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chipid</span> <span class="o">&amp;</span> <span class="n">HCCHIPID_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HCCHIPID_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Invalid chip ID %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">chipid</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CHIP_BUFFER_TEST</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">isp1362_chip_test</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* clear interrupt status and disable all interrupt sources */</span>
	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINT</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* HW conf */</span>
	<span class="n">hwcfg</span> <span class="o">=</span> <span class="n">HCHWCFG_INT_ENABLE</span> <span class="o">|</span> <span class="n">HCHWCFG_DBWIDTH</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">sel15Kres</span><span class="p">)</span>
		<span class="n">hwcfg</span> <span class="o">|=</span> <span class="n">HCHWCFG_PULLDOWN_DS2</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">MAX_ROOT_PORTS</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">HCHWCFG_PULLDOWN_DS1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">clknotstop</span><span class="p">)</span>
		<span class="n">hwcfg</span> <span class="o">|=</span> <span class="n">HCHWCFG_CLKNOTSTOP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">oc_enable</span><span class="p">)</span>
		<span class="n">hwcfg</span> <span class="o">|=</span> <span class="n">HCHWCFG_ANALOG_OC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">int_act_high</span><span class="p">)</span>
		<span class="n">hwcfg</span> <span class="o">|=</span> <span class="n">HCHWCFG_INT_POL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">int_edge_triggered</span><span class="p">)</span>
		<span class="n">hwcfg</span> <span class="o">|=</span> <span class="n">HCHWCFG_INT_TRIGGER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">dreq_act_high</span><span class="p">)</span>
		<span class="n">hwcfg</span> <span class="o">|=</span> <span class="n">HCHWCFG_DREQ_POL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">dack_act_high</span><span class="p">)</span>
		<span class="n">hwcfg</span> <span class="o">|=</span> <span class="n">HCHWCFG_DACK_POL</span><span class="p">;</span>
	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCHWCFG</span><span class="p">,</span> <span class="n">hwcfg</span><span class="p">);</span>
	<span class="n">isp1362_show_reg</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCHWCFG</span><span class="p">);</span>
	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCDMACFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">isp1362_mem_config</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Root hub conf */</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhdesca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">no_power_switching</span><span class="p">)</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhdesca</span> <span class="o">|=</span> <span class="n">RH_A_NPS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">power_switching_mode</span><span class="p">)</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhdesca</span> <span class="o">|=</span> <span class="n">RH_A_PSM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">potpg</span><span class="p">)</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhdesca</span> <span class="o">|=</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">potpg</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RH_A_POTPGT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhdesca</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">25</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RH_A_POTPGT</span><span class="p">;</span>

	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHDESCA</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhdesca</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RH_A_OCPM</span><span class="p">);</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHDESCA</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhdesca</span> <span class="o">|</span> <span class="n">RH_A_OCPM</span><span class="p">);</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhdesca</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHDESCA</span><span class="p">);</span>

	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhdescb</span> <span class="o">=</span> <span class="n">RH_B_PPCM</span><span class="p">;</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHDESCB</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhdescb</span><span class="p">);</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">rhdescb</span> <span class="o">=</span> <span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHDESCB</span><span class="p">);</span>

	<span class="n">isp1362_read_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCFMINTVL</span><span class="p">);</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCFMINTVL</span><span class="p">,</span> <span class="p">(</span><span class="n">FSMP</span><span class="p">(</span><span class="n">FI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FI</span><span class="p">);</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCLSTHRESH</span><span class="p">,</span> <span class="n">LSTHRESH</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span> <span class="o">=</span> <span class="n">OHCI_USB_OPER</span><span class="p">;</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_RUNNING</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Set up interrupts */</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intenb</span> <span class="o">=</span> <span class="n">OHCI_INTR_MIE</span> <span class="o">|</span> <span class="n">OHCI_INTR_RHSC</span> <span class="o">|</span> <span class="n">OHCI_INTR_UE</span><span class="p">;</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intenb</span> <span class="o">|=</span> <span class="n">OHCI_INTR_RD</span><span class="p">;</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span> <span class="o">=</span> <span class="n">HCuPINT_OPR</span> <span class="o">|</span> <span class="n">HCuPINT_SUSP</span><span class="p">;</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCINTENB</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">intenb</span><span class="p">);</span>
	<span class="n">isp1362_write_reg16</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCuPINTENB</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">irqenb</span><span class="p">);</span>

	<span class="cm">/* Go operational */</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCCONTROL</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">hc_control</span><span class="p">);</span>
	<span class="cm">/* enable global power */</span>
	<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHSTATUS</span><span class="p">,</span> <span class="n">RH_HS_LPSC</span> <span class="o">|</span> <span class="n">RH_HS_DRWE</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hc_driver</span> <span class="n">isp1362_hc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span>		<span class="n">hcd_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">product_desc</span> <span class="o">=</span>		<span class="s">&quot;ISP1362 Host Controller&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hcd_priv_size</span> <span class="o">=</span>	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp1362_hcd</span><span class="p">),</span>

	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span>			<span class="n">isp1362_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span>		<span class="n">HCD_USB11</span> <span class="o">|</span> <span class="n">HCD_MEMORY</span><span class="p">,</span>

	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span>		<span class="n">isp1362_hc_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span>		<span class="n">isp1362_hc_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span>			<span class="n">isp1362_hc_stop</span><span class="p">,</span>

	<span class="p">.</span><span class="n">urb_enqueue</span> <span class="o">=</span>		<span class="n">isp1362_urb_enqueue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">urb_dequeue</span> <span class="o">=</span>		<span class="n">isp1362_urb_dequeue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">endpoint_disable</span> <span class="o">=</span>	<span class="n">isp1362_endpoint_disable</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_frame_number</span> <span class="o">=</span>	<span class="n">isp1362_get_frame</span><span class="p">,</span>

	<span class="p">.</span><span class="n">hub_status_data</span> <span class="o">=</span>	<span class="n">isp1362_hub_status_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hub_control</span> <span class="o">=</span>		<span class="n">isp1362_hub_control</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_suspend</span> <span class="o">=</span>		<span class="n">isp1362_bus_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_resume</span> <span class="o">=</span>		<span class="n">isp1362_bus_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">isp1362_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">remove_debug_file</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Removing HCD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">usb_remove_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Unmapping data_reg @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Unmapping addr_reg @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">addr_reg</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">addr_reg</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: release mem_region: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: release mem_region: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: put_hcd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">isp1362_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr_reg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">data_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">irq_res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_disabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* basic sanity checks first.  board-specific init logic should</span>
<span class="cm">	 * have initialized this the three resources and probably board</span>
<span class="cm">	 * specific platform_data.  we don&#39;t probe for IRQs, and do only</span>
<span class="cm">	 * minimal sanity checking.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">num_resources</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">irq_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span> <span class="o">||</span> <span class="o">!</span><span class="n">irq_res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">irq_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;won&#39;t do DMA&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="n">hcd_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr_reg</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr_reg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">hcd_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data_reg</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_reg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate and initialize hcd */</span>
	<span class="n">hcd</span> <span class="o">=</span> <span class="n">usb_create_hcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hc_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hcd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err5</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_start</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">data_reg</span> <span class="o">=</span> <span class="n">data_reg</span><span class="p">;</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">addr_reg</span> <span class="o">=</span> <span class="n">addr_reg</span><span class="p">;</span>

	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">next_statechange</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">isoc</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">remove_list</span><span class="p">);</span>
	<span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
<span class="cp">#if USE_PLATFORM_DELAY</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;No platform delay function given</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err6</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IRQ_HIGHEDGE</span><span class="p">)</span>
		<span class="n">irq_flags</span> <span class="o">|=</span> <span class="n">IRQF_TRIGGER_RISING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IRQ_LOWEDGE</span><span class="p">)</span>
		<span class="n">irq_flags</span> <span class="o">|=</span> <span class="n">IRQF_TRIGGER_FALLING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IRQ_HIGHLEVEL</span><span class="p">)</span>
		<span class="n">irq_flags</span> <span class="o">|=</span> <span class="n">IRQF_TRIGGER_HIGH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IRQ_LOWLEVEL</span><span class="p">)</span>
		<span class="n">irq_flags</span> <span class="o">|=</span> <span class="n">IRQF_TRIGGER_LOW</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_add_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">irq_flags</span> <span class="o">|</span> <span class="n">IRQF_SHARED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err6</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s, irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">product_desc</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

	<span class="n">create_debug_file</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err6:</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Freeing dev %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">isp1362_hcd</span><span class="p">);</span>
	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
 <span class="nl">err5:</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Unmapping data_reg @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">data_reg</span><span class="p">);</span>
 <span class="nl">err4:</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Releasing mem region %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
 <span class="nl">err3:</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Unmapping addr_reg @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">addr_reg</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">addr_reg</span><span class="p">);</span>
 <span class="nl">err2:</span>
	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Releasing mem region %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
 <span class="nl">err1:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: init error, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef	CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp1362_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Suspending device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">PM_EVENT_FREEZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Suspending root hub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">isp1362_bus_suspend</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Suspending RH ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHSTATUS</span><span class="p">,</span> <span class="n">RH_HS_LPS</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp1362_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp1362_hcd</span> <span class="o">*</span><span class="n">isp1362_hcd</span> <span class="o">=</span> <span class="n">hcd_to_isp1362_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Resuming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">PM_EVENT_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Resume RH ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">isp1362_write_reg32</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">,</span> <span class="n">HCRHSTATUS</span><span class="p">,</span> <span class="n">RH_HS_LPSC</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp1362_hcd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">PMSG_ON</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">isp1362_bus_resume</span><span class="p">(</span><span class="n">isp1362_hcd_to_hcd</span><span class="p">(</span><span class="n">isp1362_hcd</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define	isp1362_suspend	NULL</span>
<span class="cp">#define	isp1362_resume	NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">isp1362_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">isp1362_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">isp1362_remove</span><span class="p">),</span>

	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">isp1362_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">isp1362_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hcd_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">isp1362_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
