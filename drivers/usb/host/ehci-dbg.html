<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › host › ehci-dbg.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ehci-dbg.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2001-2002 by David Brownell</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2 of the License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class="cm"> * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software Foundation,</span>
<span class="cm"> * Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cm">/* this file is part of ehci-hcd.c */</span>

<span class="cp">#define ehci_dbg(ehci, fmt, args...) \</span>
<span class="cp">	dev_dbg (ehci_to_hcd(ehci)-&gt;self.controller , fmt , ## args )</span>
<span class="cp">#define ehci_err(ehci, fmt, args...) \</span>
<span class="cp">	dev_err (ehci_to_hcd(ehci)-&gt;self.controller , fmt , ## args )</span>
<span class="cp">#define ehci_info(ehci, fmt, args...) \</span>
<span class="cp">	dev_info (ehci_to_hcd(ehci)-&gt;self.controller , fmt , ## args )</span>
<span class="cp">#define ehci_warn(ehci, fmt, args...) \</span>
<span class="cp">	dev_warn (ehci_to_hcd(ehci)-&gt;self.controller , fmt , ## args )</span>

<span class="cp">#ifdef VERBOSE_DEBUG</span>
<span class="cp">#	define ehci_vdbg ehci_dbg</span>
<span class="cp">#else</span>
	<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ehci_vdbg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef	DEBUG</span>

<span class="cm">/* check the values in the HCSPARAMS register</span>
<span class="cm"> * (host controller _Structural_ parameters)</span>
<span class="cm"> * see EHCI spec, Table 2-4 for each value</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbg_hcs_params</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">params</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>

	<span class="n">ehci_dbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
		<span class="s">&quot;%s hcs_params 0x%x dbg=%d%s cc=%d pcc=%d%s%s ports=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">label</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
		<span class="n">HCS_DEBUG_PORT</span> <span class="p">(</span><span class="n">params</span><span class="p">),</span>
		<span class="n">HCS_INDICATOR</span> <span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ind&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">HCS_N_CC</span> <span class="p">(</span><span class="n">params</span><span class="p">),</span>
		<span class="n">HCS_N_PCC</span> <span class="p">(</span><span class="n">params</span><span class="p">),</span>
		<span class="n">HCS_PORTROUTED</span> <span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; ordered&quot;</span><span class="p">,</span>
		<span class="n">HCS_PPC</span> <span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; !ppc&quot;</span><span class="p">,</span>
		<span class="n">HCS_N_PORTS</span> <span class="p">(</span><span class="n">params</span><span class="p">)</span>
		<span class="p">);</span>
	<span class="cm">/* Port routing, per EHCI 0.95 Spec, Section 2.2.5 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HCS_PORTROUTED</span> <span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">buf</span> <span class="p">[</span><span class="mi">46</span><span class="p">],</span> <span class="n">tmp</span> <span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">byte</span><span class="p">;</span>

		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HCS_N_PORTS</span> <span class="p">(</span><span class="n">params</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>FIXME MIPS won't readb() ...</p></td><td class="code"><div class="highlight"><pre>			<span class="n">byte</span> <span class="o">=</span> <span class="n">readb</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">portroute</span><span class="p">[(</span><span class="n">i</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)]);</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;%d &quot;</span><span class="p">,</span>
				<span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="n">byte</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xf</span><span class="p">)</span> <span class="o">:</span> <span class="p">((</span><span class="n">byte</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xf</span><span class="p">)));</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ehci_dbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;%s portroute %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">label</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dbg_hcs_params</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">)</span> <span class="p">{}</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef	DEBUG</span>

<span class="cm">/* check the values in the HCCPARAMS register</span>
<span class="cm"> * (host controller _Capability_ parameters)</span>
<span class="cm"> * see EHCI Spec, Table 2-5 for each value</span>
<span class="cm"> * */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbg_hcc_params</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">params</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">hcc_params</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HCC_ISOC_CACHE</span> <span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehci_dbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
			<span class="s">&quot;%s hcc_params %04x caching frame %s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">label</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
			<span class="n">HCC_PGM_FRAMELISTLEN</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;256/512/1024&quot;</span> <span class="o">:</span> <span class="s">&quot;1024&quot;</span><span class="p">,</span>
			<span class="n">HCC_CANPARK</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; park&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">HCC_64BIT_ADDR</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; 64 bit addr&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ehci_dbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
			<span class="s">&quot;%s hcc_params %04x thresh %d uframes %s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">label</span><span class="p">,</span>
			<span class="n">params</span><span class="p">,</span>
			<span class="n">HCC_ISOC_THRES</span><span class="p">(</span><span class="n">params</span><span class="p">),</span>
			<span class="n">HCC_PGM_FRAMELISTLEN</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;256/512/1024&quot;</span> <span class="o">:</span> <span class="s">&quot;1024&quot;</span><span class="p">,</span>
			<span class="n">HCC_CANPARK</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; park&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">HCC_64BIT_ADDR</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; 64 bit addr&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">HCC_LPM</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; LPM&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">HCC_PER_PORT_CHANGE_EVENT</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ppce&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">HCC_HW_PREFETCH</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; hw prefetch&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">HCC_32FRAME_PERIODIC_LIST</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">?</span>
				<span class="s">&quot; 32 periodic list&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dbg_hcc_params</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">)</span> <span class="p">{}</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef	DEBUG</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__maybe_unused</span>
<span class="nf">dbg_qtd</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehci_qtd</span> <span class="o">*</span><span class="n">qtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ehci_dbg</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;%s td %p n%08x %08x t%08x p0=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">qtd</span><span class="p">,</span>
		<span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qtd</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">),</span>
		<span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qtd</span><span class="o">-&gt;</span><span class="n">hw_alt_next</span><span class="p">),</span>
		<span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qtd</span><span class="o">-&gt;</span><span class="n">hw_token</span><span class="p">),</span>
		<span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qtd</span><span class="o">-&gt;</span><span class="n">hw_buf</span> <span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qtd</span><span class="o">-&gt;</span><span class="n">hw_buf</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">ehci_dbg</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;  p1=%08x p2=%08x p3=%08x p4=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qtd</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
			<span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qtd</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
			<span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qtd</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
			<span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qtd</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__maybe_unused</span>
<span class="nf">dbg_qh</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehci_qh</span> <span class="o">*</span><span class="n">qh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ehci_qh_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">qh</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ehci_dbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;%s qh %p n%08x info %x %x qtd %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
		<span class="n">qh</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_info1</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_info2</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_current</span><span class="p">);</span>
	<span class="n">dbg_qtd</span><span class="p">(</span><span class="s">&quot;overlay&quot;</span><span class="p">,</span> <span class="n">ehci</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ehci_qtd</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_qtd_next</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__maybe_unused</span>
<span class="nf">dbg_itd</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehci_itd</span> <span class="o">*</span><span class="n">itd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ehci_dbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;%s [%d] itd %p, next %08x, urb %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">label</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">,</span> <span class="n">itd</span><span class="p">,</span> <span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">),</span>
		<span class="n">itd</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">);</span>
	<span class="n">ehci_dbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
		<span class="s">&quot;  trans: %08x %08x %08x %08x %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_transaction</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_transaction</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_transaction</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_transaction</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_transaction</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_transaction</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_transaction</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_transaction</span><span class="p">[</span><span class="mi">7</span><span class="p">]));</span>
	<span class="n">ehci_dbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
		<span class="s">&quot;  buf:   %08x %08x %08x %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_bufp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_bufp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_bufp</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_bufp</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_bufp</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_bufp</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_bufp</span><span class="p">[</span><span class="mi">6</span><span class="p">]));</span>
	<span class="n">ehci_dbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;  index: %d %d %d %d %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">itd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		<span class="n">itd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		<span class="n">itd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">itd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__maybe_unused</span>
<span class="nf">dbg_sitd</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehci_sitd</span> <span class="o">*</span><span class="n">sitd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ehci_dbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;%s [%d] sitd %p, next %08x, urb %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">label</span><span class="p">,</span> <span class="n">sitd</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">,</span> <span class="n">sitd</span><span class="p">,</span> <span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">sitd</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">),</span>
		<span class="n">sitd</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">);</span>
	<span class="n">ehci_dbg</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
		<span class="s">&quot;  addr %08x sched %04x result %08x buf %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">sitd</span><span class="o">-&gt;</span><span class="n">hw_fullspeed_ep</span><span class="p">),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">sitd</span><span class="o">-&gt;</span><span class="n">hw_uframe</span><span class="p">),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">sitd</span><span class="o">-&gt;</span><span class="n">hw_results</span><span class="p">),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">sitd</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		<span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">sitd</span><span class="o">-&gt;</span><span class="n">hw_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__maybe_unused</span>
<span class="nf">dbg_status_buf</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;%s%sstatus %04x%s%s%s%s%s%s%s%s%s%s%s&quot;</span><span class="p">,</span>
		<span class="n">label</span><span class="p">,</span> <span class="n">label</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_PPCE_MASK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; PPCE&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_ASS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; Async&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_PSS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; Periodic&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_RECL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; Recl&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_HALT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; Halt&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_IAA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; IAA&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_FATAL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; FATAL&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_FLR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; FLR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_PCD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; PCD&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_ERR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ERR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STS_INT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; INT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span>
		<span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__maybe_unused</span>
<span class="nf">dbg_intr_buf</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u32</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;%s%sintrenable %02x%s%s%s%s%s%s%s&quot;</span><span class="p">,</span>
		<span class="n">label</span><span class="p">,</span> <span class="n">label</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span>
		<span class="p">(</span><span class="n">enable</span> <span class="o">&amp;</span> <span class="n">STS_PPCE_MASK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; PPCE&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">enable</span> <span class="o">&amp;</span> <span class="n">STS_IAA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; IAA&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">enable</span> <span class="o">&amp;</span> <span class="n">STS_FATAL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; FATAL&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">enable</span> <span class="o">&amp;</span> <span class="n">STS_FLR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; FLR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">enable</span> <span class="o">&amp;</span> <span class="n">STS_PCD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; PCD&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">enable</span> <span class="o">&amp;</span> <span class="n">STS_ERR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ERR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">enable</span> <span class="o">&amp;</span> <span class="n">STS_INT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; INT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span>
		<span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">fls_strings</span> <span class="p">[]</span> <span class="o">=</span>
    <span class="p">{</span> <span class="s">&quot;1024&quot;</span><span class="p">,</span> <span class="s">&quot;512&quot;</span><span class="p">,</span> <span class="s">&quot;256&quot;</span><span class="p">,</span> <span class="s">&quot;??&quot;</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dbg_command_buf</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u32</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;%s%scommand %07x %s%s%s%s%s%s=%d ithresh=%d%s%s%s%s &quot;</span>
		<span class="s">&quot;period=%s%s %s&quot;</span><span class="p">,</span>
		<span class="n">label</span><span class="p">,</span> <span class="n">label</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span>
		<span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_HIRD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; HIRD&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_PPCEE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; PPCEE&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_FSP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; FSP&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_ASPE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ASPE&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_PSPE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; PSPE&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_PARK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; park&quot;</span> <span class="o">:</span> <span class="s">&quot;(park)&quot;</span><span class="p">,</span>
		<span class="n">CMD_PARK_CNT</span> <span class="p">(</span><span class="n">command</span><span class="p">),</span>
		<span class="p">(</span><span class="n">command</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span>
		<span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_LRESET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; LReset&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_IAAD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; IAAD&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_ASE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; Async&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_PSE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; Periodic&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">fls_strings</span> <span class="p">[(</span><span class="n">command</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">],</span>
		<span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_RESET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; Reset&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_RUN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RUN&quot;</span> <span class="o">:</span> <span class="s">&quot;HALT&quot;</span>
		<span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dbg_port_buf</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">sig</span><span class="p">;</span>

	<span class="cm">/* signaling state */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>: <span class="n">sig</span> <span class="o">=</span> <span class="s">&quot;se0&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>: <span class="n">sig</span> <span class="o">=</span> <span class="s">&quot;k&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>		<span class="cm">/* low speed */</span>
	<span class="k">case</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>: <span class="n">sig</span> <span class="o">=</span> <span class="s">&quot;j&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">sig</span> <span class="o">=</span> <span class="s">&quot;?&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;%s%sport:%d status %06x %d %s%s%s%s%s%s &quot;</span>
		<span class="s">&quot;sig=%s%s%s%s%s%s%s%s%s%s%s&quot;</span><span class="p">,</span>
		<span class="n">label</span><span class="p">,</span> <span class="n">label</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
		<span class="n">status</span><span class="o">&gt;&gt;</span><span class="mi">25</span><span class="p">,</span><span class="cm">/*device address */</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_SSTS</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">23</span> <span class="o">==</span> <span class="n">PORTSC_SUSPEND_STS_ACK</span> <span class="o">?</span>
						<span class="s">&quot; ACK&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_SSTS</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">23</span> <span class="o">==</span> <span class="n">PORTSC_SUSPEND_STS_NYET</span> <span class="o">?</span>
						<span class="s">&quot; NYET&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_SSTS</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">23</span> <span class="o">==</span> <span class="n">PORTSC_SUSPEND_STS_STALL</span> <span class="o">?</span>
						<span class="s">&quot; STALL&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_SSTS</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">23</span> <span class="o">==</span> <span class="n">PORTSC_SUSPEND_STS_ERR</span> <span class="o">?</span>
						<span class="s">&quot; ERR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_POWER</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; POWER&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_OWNER</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; OWNER&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">sig</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_LPM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; LPM&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_RESET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; RESET&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_SUSPEND</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; SUSPEND&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_RESUME</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; RESUME&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_OCC</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; OCC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_OC</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; OC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_PEC</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; PEC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_PE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; PE&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_CSC</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; CSC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_CONNECT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; CONNECT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__maybe_unused</span>
<span class="nf">dbg_qh</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehci_qh</span> <span class="o">*</span><span class="n">qh</span><span class="p">)</span>
<span class="p">{}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">__maybe_unused</span>
<span class="nf">dbg_status_buf</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">__maybe_unused</span>
<span class="nf">dbg_command_buf</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u32</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">__maybe_unused</span>
<span class="nf">dbg_intr_buf</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u32</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">__maybe_unused</span>
<span class="nf">dbg_port_buf</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="cp">#endif	</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

<span class="cm">/* functions have the &quot;wrong&quot; filename when they&#39;re output... */</span>
<span class="cp">#define dbg_status(ehci, label, status) { \</span>
<span class="cp">	char _buf [80]; \</span>
<span class="cp">	dbg_status_buf (_buf, sizeof _buf, label, status); \</span>
<span class="cp">	ehci_dbg (ehci, &quot;%s\n&quot;, _buf); \</span>
<span class="cp">}</span>

<span class="cp">#define dbg_cmd(ehci, label, command) { \</span>
<span class="cp">	char _buf [80]; \</span>
<span class="cp">	dbg_command_buf (_buf, sizeof _buf, label, command); \</span>
<span class="cp">	ehci_dbg (ehci, &quot;%s\n&quot;, _buf); \</span>
<span class="cp">}</span>

<span class="cp">#define dbg_port(ehci, label, port, status) { \</span>
<span class="cp">	char _buf [80]; \</span>
<span class="cp">	dbg_port_buf (_buf, sizeof _buf, label, port, status); \</span>
<span class="cp">	ehci_dbg (ehci, &quot;%s\n&quot;, _buf); \</span>
<span class="cp">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef STUB_DEBUG_FILES</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">create_debug_files</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">remove_debug_files</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

<span class="cp">#else</span>

<span class="cm">/* troubleshooting help: expose state in debugfs */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_async_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_periodic_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_registers_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_async_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">debug_lpm_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">debug_lpm_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_lpm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">debug_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span><span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span><span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span> <span class="n">loff_t</span><span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">debug_async_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">debug_async_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">debug_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">debug_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">debug_periodic_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">debug_periodic_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">debug_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">debug_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">debug_registers_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">debug_registers_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">debug_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">debug_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">debug_lpm_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">debug_lpm_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">debug_lpm_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">debug_lpm_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ehci_debug_root</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">debug_buffer</span> <span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">fill_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">debug_buffer</span> <span class="o">*</span><span class="p">);</span>	<span class="cm">/* fill method */</span>
	<span class="k">struct</span> <span class="n">usb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>	<span class="cm">/* protect filling of buffer */</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>		<span class="cm">/* number of characters filled into buffer */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">output_buf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">alloc_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define speed_char(info1) ({ char tmp; \</span>
<span class="cp">		switch (info1 &amp; (3 &lt;&lt; 12)) { \</span>
<span class="cp">		case 0 &lt;&lt; 12: tmp = &#39;f&#39;; break; \</span>
<span class="cp">		case 1 &lt;&lt; 12: tmp = &#39;l&#39;; break; \</span>
<span class="cp">		case 2 &lt;&lt; 12: tmp = &#39;h&#39;; break; \</span>
<span class="cp">		default: tmp = &#39;?&#39;; break; \</span>
<span class="cp">		}; tmp; })</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="nf">token_mark</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">,</span> <span class="n">__hc32</span> <span class="n">token</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">v</span> <span class="o">=</span> <span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">QTD_STS_ACTIVE</span><span class="p">)</span>
		<span class="k">return</span> <span class="sc">&#39;*&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">QTD_STS_HALT</span><span class="p">)</span>
		<span class="k">return</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_SHORT_READ</span> <span class="p">(</span><span class="n">v</span><span class="p">))</span>
		<span class="k">return</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="cm">/* tries to advance through hw_alt_next */</span>
	<span class="k">return</span> <span class="sc">&#39;/&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qh_lines</span> <span class="p">(</span>
	<span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ehci_qh</span> <span class="o">*</span><span class="n">qh</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">nextp</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="o">*</span><span class="n">sizep</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>			<span class="n">scratch</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">hw_curr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehci_qtd</span>		<span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">temp</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">size</span> <span class="o">=</span> <span class="o">*</span><span class="n">sizep</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="o">*</span><span class="n">nextp</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="n">mark</span><span class="p">;</span>
	<span class="n">__le32</span>			<span class="n">list_end</span> <span class="o">=</span> <span class="n">EHCI_LIST_END</span><span class="p">(</span><span class="n">ehci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ehci_qh_hw</span>	<span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">qh</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_qtd_next</span> <span class="o">==</span> <span class="n">list_end</span><span class="p">)</span>	<span class="cm">/* NEC does this */</span>
		<span class="n">mark</span> <span class="o">=</span> <span class="sc">&#39;@&#39;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mark</span> <span class="o">=</span> <span class="n">token_mark</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_token</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mark</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* qh_alt_next controls qh advance? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_alt_next</span> <span class="o">&amp;</span> <span class="n">QTD_MASK</span><span class="p">(</span><span class="n">ehci</span><span class="p">))</span>
				<span class="o">==</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_alt_next</span><span class="p">)</span>
			<span class="n">mark</span> <span class="o">=</span> <span class="sc">&#39;#&#39;</span><span class="p">;</span>	<span class="cm">/* blocked */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_alt_next</span> <span class="o">==</span> <span class="n">list_end</span><span class="p">)</span>
			<span class="n">mark</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>	<span class="cm">/* use hw_qtd_next */</span>
		<span class="cm">/* else alt_next points to some other qtd */</span>
	<span class="p">}</span>
	<span class="n">scratch</span> <span class="o">=</span> <span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_info1</span><span class="p">);</span>
	<span class="n">hw_curr</span> <span class="o">=</span> <span class="p">(</span><span class="n">mark</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_current</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			<span class="s">&quot;qh/%p dev%d %cs ep%d %08x %08x (%08x%c %s nak%d)&quot;</span><span class="p">,</span>
			<span class="n">qh</span><span class="p">,</span> <span class="n">scratch</span> <span class="o">&amp;</span> <span class="mh">0x007f</span><span class="p">,</span>
			<span class="n">speed_char</span> <span class="p">(</span><span class="n">scratch</span><span class="p">),</span>
			<span class="p">(</span><span class="n">scratch</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">,</span>
			<span class="n">scratch</span><span class="p">,</span> <span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_info2</span><span class="p">),</span>
			<span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_token</span><span class="p">),</span> <span class="n">mark</span><span class="p">,</span>
			<span class="p">(</span><span class="n">cpu_to_hc32</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">QTD_TOGGLE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_token</span><span class="p">)</span>
				<span class="o">?</span> <span class="s">&quot;data1&quot;</span> <span class="o">:</span> <span class="s">&quot;data0&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_alt_next</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* hc may be modifying the list as we read it ... */</span>
	<span class="n">list_for_each</span> <span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qh</span><span class="o">-&gt;</span><span class="n">qtd_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ehci_qtd</span><span class="p">,</span> <span class="n">qtd_list</span><span class="p">);</span>
		<span class="n">scratch</span> <span class="o">=</span> <span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">hw_token</span><span class="p">);</span>
		<span class="n">mark</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw_curr</span> <span class="o">==</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">qtd_dma</span><span class="p">)</span>
			<span class="n">mark</span> <span class="o">=</span> <span class="sc">&#39;*&#39;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_qtd_next</span> <span class="o">==</span> <span class="n">cpu_to_hc32</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">qtd_dma</span><span class="p">))</span>
			<span class="n">mark</span> <span class="o">=</span> <span class="sc">&#39;+&#39;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">QTD_LENGTH</span> <span class="p">(</span><span class="n">scratch</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">hw_alt_next</span> <span class="o">==</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_alt_next</span><span class="p">)</span>
				<span class="n">mark</span> <span class="o">=</span> <span class="sc">&#39;#&#39;</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">hw_alt_next</span> <span class="o">!=</span> <span class="n">list_end</span><span class="p">)</span>
				<span class="n">mark</span> <span class="o">=</span> <span class="sc">&#39;/&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">snprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\n\t</span><span class="s">%p%c%s len=%d %08x urb %p&quot;</span><span class="p">,</span>
				<span class="n">td</span><span class="p">,</span> <span class="n">mark</span><span class="p">,</span> <span class="p">({</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
				 <span class="k">switch</span> <span class="p">((</span><span class="n">scratch</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
				 <span class="k">case</span> <span class="mi">0</span>: <span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;out&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				 <span class="k">case</span> <span class="mi">1</span>: <span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;in&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				 <span class="k">case</span> <span class="mi">2</span>: <span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;setup&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				 <span class="nl">default:</span> <span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;?&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				 <span class="p">}</span> <span class="n">tmp</span><span class="p">;}),</span>
				<span class="p">(</span><span class="n">scratch</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">,</span>
				<span class="n">scratch</span><span class="p">,</span>
				<span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">temp</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">snprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">temp</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="o">*</span><span class="n">sizep</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="o">*</span><span class="n">nextp</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fill_async_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">debug_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>		<span class="o">*</span><span class="n">hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehci_hcd</span>		<span class="o">*</span><span class="n">ehci</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">temp</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehci_qh</span>		<span class="o">*</span><span class="n">qh</span><span class="p">;</span>

	<span class="n">hcd</span> <span class="o">=</span> <span class="n">bus_to_hcd</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">ehci</span> <span class="o">=</span> <span class="n">hcd_to_ehci</span> <span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">output_buf</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">alloc_size</span><span class="p">;</span>

	<span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* dumps a snapshot of the async schedule.</span>
<span class="cm">	 * usually empty except for long-term bulk reads, or head.</span>
<span class="cm">	 * one QH per line, and TDs we know about</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">qh</span> <span class="o">=</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">async</span><span class="o">-&gt;</span><span class="n">qh_next</span><span class="p">.</span><span class="n">qh</span><span class="p">;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">qh</span><span class="p">;</span> <span class="n">qh</span> <span class="o">=</span> <span class="n">qh</span><span class="o">-&gt;</span><span class="n">qh_next</span><span class="p">.</span><span class="n">qh</span><span class="p">)</span>
		<span class="n">qh_lines</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">qh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reclaim</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">reclaim =</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">qh</span> <span class="o">=</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reclaim</span><span class="p">;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">qh</span><span class="p">;</span> <span class="n">qh</span> <span class="o">=</span> <span class="n">qh</span><span class="o">-&gt;</span><span class="n">reclaim</span><span class="p">)</span>
			<span class="n">qh_lines</span> <span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">qh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">output_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define DBG_SCHED_LIMIT 64</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fill_periodic_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">debug_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>		<span class="o">*</span><span class="n">hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehci_hcd</span>		<span class="o">*</span><span class="n">ehci</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ehci_shadow</span>	<span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">seen</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">temp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">seen_count</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">i</span><span class="p">;</span>
	<span class="n">__hc32</span>			<span class="n">tag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">seen</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="n">DBG_SCHED_LIMIT</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">seen</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">seen_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hcd</span> <span class="o">=</span> <span class="n">bus_to_hcd</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">ehci</span> <span class="o">=</span> <span class="n">hcd_to_ehci</span> <span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">output_buf</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">alloc_size</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">periodic_size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* dump a snapshot of the periodic schedule.</span>
<span class="cm">	 * iso changes, interrupt usually doesn&#39;t.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">periodic_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">pshadow</span> <span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">.</span><span class="n">ptr</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">Q_NEXT_TYPE</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">periodic</span> <span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%4d: &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ehci_qh_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">hc32_to_cpu</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">Q_TYPE_QH</span>:
				<span class="n">hw</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">qh</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot; qh%d-%04x/%p&quot;</span><span class="p">,</span>
						<span class="n">p</span><span class="p">.</span><span class="n">qh</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">,</span>
						<span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_info2</span><span class="p">)</span>
							<span class="cm">/* uframe masks */</span>
							<span class="o">&amp;</span> <span class="p">(</span><span class="n">QH_CMASK</span> <span class="o">|</span> <span class="n">QH_SMASK</span><span class="p">),</span>
						<span class="n">p</span><span class="p">.</span><span class="n">qh</span><span class="p">);</span>
				<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="cm">/* don&#39;t repeat what follows this qh */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">temp</span> <span class="o">&lt;</span> <span class="n">seen_count</span><span class="p">;</span> <span class="n">temp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">seen</span> <span class="p">[</span><span class="n">temp</span><span class="p">].</span><span class="n">ptr</span> <span class="o">!=</span> <span class="n">p</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">qh</span><span class="o">-&gt;</span><span class="n">qh_next</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
							<span class="s">&quot; ...&quot;</span><span class="p">);</span>
						<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
						<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* show more info the first time around */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="n">seen_count</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u32</span>	<span class="n">scratch</span> <span class="o">=</span> <span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_info1</span><span class="p">);</span>
					<span class="k">struct</span> <span class="n">ehci_qtd</span>	<span class="o">*</span><span class="n">qtd</span><span class="p">;</span>
					<span class="kt">char</span>		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

					<span class="cm">/* count tds, get ep direction */</span>
					<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">qtd</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">qh</span><span class="o">-&gt;</span><span class="n">qtd_list</span><span class="p">,</span>
							<span class="n">qtd_list</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">temp</span><span class="o">++</span><span class="p">;</span>
						<span class="k">switch</span> <span class="p">(</span><span class="mh">0x03</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hc32_to_cpu</span><span class="p">(</span>
							<span class="n">ehci</span><span class="p">,</span>
							<span class="n">qtd</span><span class="o">-&gt;</span><span class="n">hw_token</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">case</span> <span class="mi">0</span>: <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;out&quot;</span><span class="p">;</span> <span class="k">continue</span><span class="p">;</span>
						<span class="k">case</span> <span class="mi">1</span>: <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;in&quot;</span><span class="p">;</span> <span class="k">continue</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>

					<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
						<span class="s">&quot; (%c%d ep%d%s &quot;</span>
						<span class="s">&quot;[%d/%d] q%d p%d)&quot;</span><span class="p">,</span>
						<span class="n">speed_char</span> <span class="p">(</span><span class="n">scratch</span><span class="p">),</span>
						<span class="n">scratch</span> <span class="o">&amp;</span> <span class="mh">0x007f</span><span class="p">,</span>
						<span class="p">(</span><span class="n">scratch</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
						<span class="n">p</span><span class="p">.</span><span class="n">qh</span><span class="o">-&gt;</span><span class="n">usecs</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">qh</span><span class="o">-&gt;</span><span class="n">c_usecs</span><span class="p">,</span>
						<span class="n">temp</span><span class="p">,</span>
						<span class="mh">0x7ff</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">scratch</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">seen_count</span> <span class="o">&lt;</span> <span class="n">DBG_SCHED_LIMIT</span><span class="p">)</span>
						<span class="n">seen</span> <span class="p">[</span><span class="n">seen_count</span><span class="o">++</span><span class="p">].</span><span class="n">qh</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">qh</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">qh</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tag</span> <span class="o">=</span> <span class="n">Q_NEXT_TYPE</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">);</span>
					<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">qh</span><span class="o">-&gt;</span><span class="n">qh_next</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">Q_TYPE_FSTN</span>:
				<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="s">&quot; fstn-%8x/%p&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">fstn</span><span class="o">-&gt;</span><span class="n">hw_prev</span><span class="p">,</span>
					<span class="n">p</span><span class="p">.</span><span class="n">fstn</span><span class="p">);</span>
				<span class="n">tag</span> <span class="o">=</span> <span class="n">Q_NEXT_TYPE</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">fstn</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">);</span>
				<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">fstn</span><span class="o">-&gt;</span><span class="n">fstn_next</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">Q_TYPE_ITD</span>:
				<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="s">&quot; itd/%p&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">itd</span><span class="p">);</span>
				<span class="n">tag</span> <span class="o">=</span> <span class="n">Q_NEXT_TYPE</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">itd</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">);</span>
				<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">itd</span><span class="o">-&gt;</span><span class="n">itd_next</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">Q_TYPE_SITD</span>:
				<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="s">&quot; sitd%d-%04x/%p&quot;</span><span class="p">,</span>
					<span class="n">p</span><span class="p">.</span><span class="n">sitd</span><span class="o">-&gt;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">,</span>
					<span class="n">hc32_to_cpup</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">sitd</span><span class="o">-&gt;</span><span class="n">hw_uframe</span><span class="p">)</span>
						<span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">,</span>
					<span class="n">p</span><span class="p">.</span><span class="n">sitd</span><span class="p">);</span>
				<span class="n">tag</span> <span class="o">=</span> <span class="n">Q_NEXT_TYPE</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">sitd</span><span class="o">-&gt;</span><span class="n">hw_next</span><span class="p">);</span>
				<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">sitd</span><span class="o">-&gt;</span><span class="n">sitd_next</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
			<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">seen</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">alloc_size</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#undef DBG_SCHED_LIMIT</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">rh_state_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">rh_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EHCI_RH_HALTED</span>:
		<span class="k">return</span> <span class="s">&quot;halted&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EHCI_RH_SUSPENDED</span>:
		<span class="k">return</span> <span class="s">&quot;suspended&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EHCI_RH_RUNNING</span>:
		<span class="k">return</span> <span class="s">&quot;running&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;?&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fill_registers_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">debug_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>		<span class="o">*</span><span class="n">hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehci_hcd</span>		<span class="o">*</span><span class="n">ehci</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">temp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="n">scratch</span> <span class="p">[</span><span class="mi">80</span><span class="p">];</span>
	<span class="k">static</span> <span class="kt">char</span>		<span class="n">fmt</span> <span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;%*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span>		<span class="n">label</span> <span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="n">hcd</span> <span class="o">=</span> <span class="n">bus_to_hcd</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">ehci</span> <span class="o">=</span> <span class="n">hcd_to_ehci</span> <span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">output_buf</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">alloc_size</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HCD_HW_ACCESSIBLE</span><span class="p">(</span><span class="n">hcd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			<span class="s">&quot;bus %s, device %s</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;SUSPENDED (no register access)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">),</span>
			<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">product_desc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Capability Registers */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">HC_VERSION</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">hc_capbase</span><span class="p">));</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
		<span class="s">&quot;bus %s, device %s</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;EHCI %x.%02x, rh state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">dev_name</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">),</span>
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">product_desc</span><span class="p">,</span>
		<span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x0ff</span><span class="p">,</span> <span class="n">rh_state_string</span><span class="p">(</span><span class="n">ehci</span><span class="p">));</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>

<span class="cp">#ifdef	CONFIG_PCI</span>
	<span class="cm">/* EHCI 0.96 and later may have &quot;extended capabilities&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">pci_bus_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span>	<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
		<span class="n">u32</span>		<span class="n">offset</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">cap2</span><span class="p">;</span>
		<span class="kt">unsigned</span>	<span class="n">count</span> <span class="o">=</span> <span class="mi">256</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>

		<span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ehci_to_hcd</span><span class="p">(</span><span class="n">ehci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">HCC_EXT_CAPS</span><span class="p">(</span><span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">hcc_params</span><span class="p">));</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_read_config_dword</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="s">&quot;ownership %08x%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span>
					<span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; linux&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; firmware&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
				<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>

				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">pci_read_config_dword</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap2</span><span class="p">);</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="s">&quot;SMI sts/enable 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cap2</span><span class="p">);</span>
				<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* illegal reserved capability */</span>
				<span class="n">cap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* FALLTHROUGH */</span>
			<span class="nl">default:</span>		<span class="cm">/* unknown */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>FIXME interpret both types of params</p></td><td class="code"><div class="highlight"><pre>	<span class="n">i</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;structural params 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">hcc_params</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;capability params 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* Operational Registers */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">dbg_status_buf</span> <span class="p">(</span><span class="n">scratch</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">scratch</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
			<span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">scratch</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">dbg_command_buf</span> <span class="p">(</span><span class="n">scratch</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">scratch</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
			<span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">));</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">scratch</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">dbg_intr_buf</span> <span class="p">(</span><span class="n">scratch</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">scratch</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
			<span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">));</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">scratch</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;uframe %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ehci_read_frame_index</span><span class="p">(</span><span class="n">ehci</span><span class="p">));</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">HCS_N_PORTS</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">dbg_port_buf</span> <span class="p">(</span><span class="n">scratch</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">scratch</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]));</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">scratch</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">HCS_DEBUG_PORT</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="s">&quot;    debug control %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">debug</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">));</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
			<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reclaim</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;reclaim qh %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">reclaim</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef EHCI_STATS</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
		<span class="s">&quot;irq normal %ld err %ld reclaim %ld (lost %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">error</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">reclaim</span><span class="p">,</span>
		<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">lost_iaa</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">scnprintf</span> <span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;complete %ld unlink %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">complete</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">unlink</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">alloc_size</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">debug_buffer</span> <span class="o">*</span><span class="nf">alloc_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
				<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">fill_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">debug_buffer</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">debug_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">debug_buffer</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">fill_func</span> <span class="o">=</span> <span class="n">fill_func</span><span class="p">;</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">alloc_size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fill_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">debug_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">output_buf</span><span class="p">)</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">output_buf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">alloc_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">output_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fill_func</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">debug_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">debug_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fill_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
				      <span class="n">buf</span><span class="o">-&gt;</span><span class="n">output_buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">debug_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">debug_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">output_buf</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">debug_async_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">alloc_buffer</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">,</span> <span class="n">fill_async_buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">debug_periodic_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">debug_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">alloc_buffer</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">,</span> <span class="n">fill_periodic_buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">alloc_size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">?</span> <span class="mi">6</span> <span class="o">:</span> <span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">debug_registers_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">alloc_buffer</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">,</span>
					  <span class="n">fill_registers_buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">debug_lpm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">debug_lpm_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TODO: show lpm stats */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">debug_lpm_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>		<span class="o">*</span><span class="n">hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ehci_hcd</span>		<span class="o">*</span><span class="n">ehci</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">portsc</span> <span class="p">;</span>
	<span class="n">u32</span> <span class="n">params</span><span class="p">;</span>

	<span class="n">hcd</span> <span class="o">=</span> <span class="n">bus_to_hcd</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="n">ehci</span> <span class="o">=</span> <span class="n">hcd_to_ehci</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;enable&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">params</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&gt;</span> <span class="n">HCS_N_PORTS</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ehci_dbg</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;ERR: LPM on bad port %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">portsc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span><span class="p">[</span><span class="n">port</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">portsc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_DEV_ADDR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ehci_dbg</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;LPM: no device attached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">PORT_LPM</span><span class="p">;</span>
		<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">portsc</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;force enable LPM for port %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;hird=&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hird</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hird</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;setting hird %s %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">hird</span><span class="p">);</span>
		<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CMD_HIRD</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hird</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;disable&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">params</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">hcs_params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&gt;</span> <span class="n">HCS_N_PORTS</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ehci_dbg</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;ERR: LPM off bad port %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">portsc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">port_status</span><span class="p">[</span><span class="n">port</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">ehci_readl</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">portsc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PORT_DEV_ADDR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ehci_dbg</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="s">&quot;ERR: no device attached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_LPM</span><span class="p">;</span>
		<span class="n">ehci_writel</span><span class="p">(</span><span class="n">ehci</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">portsc</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;disabled LPM for port %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">create_debug_files</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ehci_to_hcd</span><span class="p">(</span><span class="n">ehci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>

	<span class="n">ehci</span><span class="o">-&gt;</span><span class="n">debug_dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bus_name</span><span class="p">,</span> <span class="n">ehci_debug_root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">debug_dir</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;async&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">debug_dir</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">debug_async_fops</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">file_error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;periodic&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">debug_dir</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">debug_periodic_fops</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">file_error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;registers&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">debug_dir</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">debug_registers_fops</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">file_error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;lpm&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">ehci</span><span class="o">-&gt;</span><span class="n">debug_dir</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">debug_lpm_fops</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">file_error</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">file_error:</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">debug_dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">remove_debug_files</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ehci_hcd</span> <span class="o">*</span><span class="n">ehci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">ehci</span><span class="o">-&gt;</span><span class="n">debug_dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* STUB_DEBUG_FILES */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
