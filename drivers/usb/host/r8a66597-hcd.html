<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › host › r8a66597-hcd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>r8a66597-hcd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * R8A66597 HCD (Host Controller Driver)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006-2007 Renesas Solutions Corp.</span>
<span class="cm"> * Portions Copyright (C) 2004 Psion Teklogix (for NetBook PRO)</span>
<span class="cm"> * Portions Copyright (C) 2004-2005 David Brownell</span>
<span class="cm"> * Portions Copyright (C) 1999 Roman Weissgaerber</span>
<span class="cm"> *</span>
<span class="cm"> * Author : Yoshihiro Shimoda &lt;yoshihiro.shimoda.uh@renesas.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/hcd.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>

<span class="cp">#include &quot;r8a66597.h&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;R8A66597 USB Host Controller Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Yoshihiro Shimoda&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:r8a66597_hcd&quot;</span><span class="p">);</span>

<span class="cp">#define DRIVER_VERSION	&quot;2009-05-26&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">hcd_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;r8a66597_hcd&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">packet_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pipenum</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">r8a66597_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">);</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_pipe_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pipenum</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">INTENB0</span><span class="p">);</span>
	<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BEMPE</span> <span class="o">|</span> <span class="n">NRDYE</span> <span class="o">|</span> <span class="n">BRDYE</span><span class="p">,</span> <span class="n">INTENB0</span><span class="p">);</span>
	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pipenum</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">INTENB0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_pipe_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pipenum</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">INTENB0</span><span class="p">);</span>
	<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BEMPE</span> <span class="o">|</span> <span class="n">NRDYE</span> <span class="o">|</span> <span class="n">BRDYE</span><span class="p">,</span> <span class="n">INTENB0</span><span class="p">);</span>
	<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pipenum</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">INTENB0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_devadd_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">u8</span> <span class="n">r8a66597_address</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">usbspd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">upphub</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hubport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">devadd_reg</span> <span class="o">=</span> <span class="n">get_devadd_addr</span><span class="p">(</span><span class="n">r8a66597_address</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">upphub</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hubport</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">usbspd</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">devadd_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8a66597_clock_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">on_chip</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_HAVE_CLK</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">SCKE</span><span class="p">,</span> <span class="n">SYSCFG0</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">SYSCFG0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r8a66597: reg access fail.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">SCKE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SCKE</span><span class="p">);</span>
		<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">USBE</span><span class="p">,</span> <span class="n">SYSCFG0</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">SYSCFG0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r8a66597: reg access fail.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">USBE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">USBE</span><span class="p">);</span>
		<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">USBE</span><span class="p">,</span> <span class="n">SYSCFG0</span><span class="p">);</span>
		<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">get_xtal_from_pdata</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">),</span>
			      <span class="n">XTAL</span><span class="p">,</span> <span class="n">SYSCFG0</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">XCKE</span><span class="p">,</span> <span class="n">SYSCFG0</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">SYSCFG0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r8a66597: reg access fail.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">SCKE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SCKE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_clock_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">SCKE</span><span class="p">,</span> <span class="n">SYSCFG0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">on_chip</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_HAVE_CLK</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">PLLC</span><span class="p">,</span> <span class="n">SYSCFG0</span><span class="p">);</span>
		<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">XCKE</span><span class="p">,</span> <span class="n">SYSCFG0</span><span class="p">);</span>
		<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">USBE</span><span class="p">,</span> <span class="n">SYSCFG0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_enable_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">DRPD</span> <span class="o">:</span> <span class="n">DCFM</span> <span class="o">|</span> <span class="n">DRPD</span><span class="p">;</span>
	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">get_syscfg_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">HSE</span><span class="p">,</span> <span class="n">get_syscfg_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>

	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BURST</span> <span class="o">|</span> <span class="n">CPU_ADR_RD_WR</span><span class="p">,</span> <span class="n">get_dmacfg_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">DTCHE</span><span class="p">,</span> <span class="n">get_intenb_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">ATTCHE</span><span class="p">,</span> <span class="n">get_intenb_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_disable_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">get_intenb_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">get_intsts_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>

	<span class="n">r8a66597_port_power</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">SOFCFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EDGESTS</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">640</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">EDGESTS</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">DRPD</span> <span class="o">:</span> <span class="n">DCFM</span> <span class="o">|</span> <span class="n">DRPD</span><span class="p">;</span>
	<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">get_syscfg_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">HSE</span><span class="p">,</span> <span class="n">get_syscfg_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enable_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vif</span> <span class="o">=</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">?</span> <span class="n">LDRV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">irq_sense</span> <span class="o">=</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">irq_sense_low</span> <span class="o">?</span> <span class="n">INTL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">endian</span> <span class="o">=</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">endian</span> <span class="o">?</span> <span class="n">BIGEND</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">r8a66597_clock_enable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">vif</span> <span class="o">&amp;</span> <span class="n">LDRV</span><span class="p">,</span> <span class="n">PINCFG</span><span class="p">);</span>
	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">USBE</span><span class="p">,</span> <span class="n">SYSCFG0</span><span class="p">);</span>

	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BEMPE</span> <span class="o">|</span> <span class="n">NRDYE</span> <span class="o">|</span> <span class="n">BRDYE</span><span class="p">,</span> <span class="n">INTENB0</span><span class="p">);</span>
	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">irq_sense</span> <span class="o">&amp;</span> <span class="n">INTL</span><span class="p">,</span> <span class="n">SOFCFG</span><span class="p">);</span>
	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BRDY0</span><span class="p">,</span> <span class="n">BRDYENB</span><span class="p">);</span>
	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BEMP0</span><span class="p">,</span> <span class="n">BEMPENB</span><span class="p">);</span>

	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">endian</span> <span class="o">&amp;</span> <span class="n">BIGEND</span><span class="p">,</span> <span class="n">CFIFOSEL</span><span class="p">);</span>
	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">endian</span> <span class="o">&amp;</span> <span class="n">BIGEND</span><span class="p">,</span> <span class="n">D0FIFOSEL</span><span class="p">);</span>
	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">endian</span> <span class="o">&amp;</span> <span class="n">BIGEND</span><span class="p">,</span> <span class="n">D1FIFOSEL</span><span class="p">);</span>
	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">TRNENSEL</span><span class="p">,</span> <span class="n">SOFCFG</span><span class="p">);</span>

	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">SIGNE</span> <span class="o">|</span> <span class="n">SACKE</span><span class="p">,</span> <span class="n">INTENB1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span>
		<span class="n">r8a66597_enable_port</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

	<span class="cm">/* disable interrupts */</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INTENB0</span><span class="p">);</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INTENB1</span><span class="p">);</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BRDYENB</span><span class="p">);</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BEMPENB</span><span class="p">);</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NRDYENB</span><span class="p">);</span>

	<span class="cm">/* clear status */</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BRDYSTS</span><span class="p">);</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NRDYSTS</span><span class="p">);</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BEMPSTS</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span>
		<span class="n">r8a66597_disable_port</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">r8a66597_clock_disable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_parent_r8a66597_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">devnum</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">udev</span> <span class="o">=</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_child_device</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">devpath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">devpath</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_hub_limit</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">devpath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">devpath</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_port_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">devpath</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">root_port</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">hub_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">root_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">root_port</span> <span class="o">=</span> <span class="p">(</span><span class="n">devpath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">root_port</span> <span class="o">&gt;=</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r8a66597: Illegal root port number.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hub_port</span><span class="p">)</span>
		<span class="o">*</span><span class="n">hub_port</span> <span class="o">=</span> <span class="n">devpath</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_r8a66597_usb_speed</span><span class="p">(</span><span class="k">enum</span> <span class="n">usb_device_speed</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">usbspd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_SPEED_LOW</span>:
		<span class="n">usbspd</span> <span class="o">=</span> <span class="n">LSMODE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_SPEED_FULL</span>:
		<span class="n">usbspd</span> <span class="o">=</span> <span class="n">FSMODE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
		<span class="n">usbspd</span> <span class="o">=</span> <span class="n">HSMODE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r8a66597: unknown speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">usbspd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_child_connect_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="kt">int</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">address</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">child_connect_map</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">address</span> <span class="o">%</span> <span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_child_connect_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="kt">int</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">address</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">child_connect_map</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">address</span> <span class="o">%</span> <span class="mi">32</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_pipe_reg_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dma_ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">pipenum</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pipenum</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fifoaddr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">D0FIFO</span><span class="p">,</span> <span class="n">D1FIFO</span><span class="p">,</span> <span class="n">CFIFO</span><span class="p">};</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fifosel</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">D0FIFOSEL</span><span class="p">,</span> <span class="n">D1FIFOSEL</span><span class="p">,</span> <span class="n">CFIFOSEL</span><span class="p">};</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fifoctr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">D0FIFOCTR</span><span class="p">,</span> <span class="n">D1FIFOCTR</span><span class="p">,</span> <span class="n">CFIFOCTR</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_ch</span> <span class="o">&gt;</span> <span class="n">R8A66597_PIPE_NO_DMA</span><span class="p">)</span>	<span class="cm">/* dma fifo not use? */</span>
		<span class="n">dma_ch</span> <span class="o">=</span> <span class="n">R8A66597_PIPE_NO_DMA</span><span class="p">;</span>

	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifoaddr</span> <span class="o">=</span> <span class="n">fifoaddr</span><span class="p">[</span><span class="n">dma_ch</span><span class="p">];</span>
	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifosel</span> <span class="o">=</span> <span class="n">fifosel</span><span class="p">[</span><span class="n">dma_ch</span><span class="p">];</span>
	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifoctr</span> <span class="o">=</span> <span class="n">fifoctr</span><span class="p">[</span><span class="n">dma_ch</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipenum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span> <span class="o">=</span> <span class="n">DCPCTR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span> <span class="o">=</span> <span class="n">get_pipectr_addr</span><span class="p">(</span><span class="n">pipenum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_bulk_or_isoc</span><span class="p">(</span><span class="n">pipenum</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipetre</span> <span class="o">=</span> <span class="n">get_pipetre_addr</span><span class="p">(</span><span class="n">pipenum</span><span class="p">);</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipetrn</span> <span class="o">=</span> <span class="n">get_pipetrn_addr</span><span class="p">(</span><span class="n">pipenum</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipetre</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipetrn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span>
<span class="nf">get_urb_to_r8a66597_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipedevice</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">device0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">make_r8a66597_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">usb_address</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">setup_packet</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* urb-&gt;pipe is address 0 */</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597_device</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_address</span> <span class="o">=</span> <span class="n">usb_address</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">USB_STATE_ADDRESS</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep_in_toggle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep_out_toggle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">child_device</span><span class="p">);</span>

	<span class="n">get_port_number</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devpath</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">root_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hub_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_child_device</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devpath</span><span class="p">))</span>
		<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">root_hub</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">root_port</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">set_devadd_reg</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
		       <span class="n">get_r8a66597_usb_speed</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">),</span>
		       <span class="n">get_parent_r8a66597_address</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hub_port</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">root_port</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">alloc_usb_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">;</span>	<span class="cm">/* R8A66597&#39;s address */</span>
	<span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_hub_limit</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devpath</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;External hub limit reached.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">get_urb_to_r8a66597_dev</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">USB_STATE_ADDRESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;=</span> <span class="n">R8A66597_MAX_DEVICE</span><span class="p">;</span> <span class="n">addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">address_map</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">addr</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;alloc_address: r8a66597_addr=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">address_map</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">addr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">make_r8a66597_device</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;cannot communicate with a USB device more than 10.(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">address_map</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_usb_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;free_addr: addr=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">USB_STATE_DEFAULT</span><span class="p">;</span>
	<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">address_map</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Only when resetting USB, it is necessary to erase drvdata. When</span>
<span class="cm">	 * a usb device with usb hub is disconnect, &quot;dev-&gt;udev&quot; is already</span>
<span class="cm">	 * freed on usb_desconnect(). So we cannot access the data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">root_hub</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">root_hub</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_reg_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u16</span> <span class="n">loop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r8a66597: register%lx, loop %x &quot;</span>
			       <span class="s">&quot;is timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">loop</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ndelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">loop</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pipe_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r8a66597_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pipenum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PID_STALL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="cm">/* stall? */</span>
		<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">PID_NAK</span><span class="p">,</span> <span class="n">PID</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">);</span>
	<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">PID_BUF</span><span class="p">,</span> <span class="n">PID</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pipe_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r8a66597_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PID_STALL11</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PID_STALL11</span><span class="p">)</span>	<span class="cm">/* force stall? */</span>
		<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">PID_STALL</span><span class="p">,</span> <span class="n">PID</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">);</span>
	<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">PID_NAK</span><span class="p">,</span> <span class="n">PID</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">);</span>
	<span class="n">r8a66597_reg_wait</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">,</span> <span class="n">PBUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_all_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">r8a66597_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pipe</span> <span class="o">||</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pipenum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pipe_stop</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">ACLRM</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">);</span>
	<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">ACLRM</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_pipe_toggle</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">r8a66597_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">toggle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">toggle</span><span class="p">)</span>
		<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">SQSET</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">SQCLR</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">mbw_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">on_chip</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MBW_32</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">MBW_16</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cfifo_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pipenum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mbw</span> <span class="o">=</span> <span class="n">mbw_value</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>

	<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">mbw</span> <span class="o">|</span> <span class="n">pipenum</span><span class="p">,</span> <span class="n">mbw</span> <span class="o">|</span> <span class="n">CURPIPE</span><span class="p">,</span> <span class="n">CFIFOSEL</span><span class="p">);</span>
	<span class="n">r8a66597_reg_wait</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">CFIFOSEL</span><span class="p">,</span> <span class="n">CURPIPE</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fifo_change_from_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">r8a66597_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mbw</span> <span class="o">=</span> <span class="n">mbw_value</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>

	<span class="n">cfifo_change</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">mbw</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mbw</span> <span class="o">|</span> <span class="n">CURPIPE</span><span class="p">,</span> <span class="n">D0FIFOSEL</span><span class="p">);</span>
	<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">mbw</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mbw</span> <span class="o">|</span> <span class="n">CURPIPE</span><span class="p">,</span> <span class="n">D1FIFOSEL</span><span class="p">);</span>

	<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">mbw</span> <span class="o">|</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pipenum</span><span class="p">,</span> <span class="n">mbw</span> <span class="o">|</span> <span class="n">CURPIPE</span><span class="p">,</span>
		      <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifosel</span><span class="p">);</span>
	<span class="n">r8a66597_reg_wait</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifosel</span><span class="p">,</span> <span class="n">CURPIPE</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pipenum</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">r8a66597_get_pipenum</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">hep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pipenum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_urb_to_r8a66597_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">get_urb_to_r8a66597_dev</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">usb_pipedevice</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="nf">get_toggle_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">urb_pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb_pipe</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep_in_toggle</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ep_out_toggle</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pipe_toggle_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">r8a66597_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">get_urb_to_r8a66597_dev</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">endpoint</span> <span class="o">=</span> <span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">toggle</span> <span class="o">=</span> <span class="n">get_toggle_pointer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">toggle</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span>
		<span class="o">*</span><span class="n">toggle</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">endpoint</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">toggle</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">endpoint</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pipe_toggle_save</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">r8a66597_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SQMON</span><span class="p">)</span>
		<span class="n">pipe_toggle_set</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pipe_toggle_set</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pipe_toggle_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">r8a66597_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">get_urb_to_r8a66597_dev</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">endpoint</span> <span class="o">=</span> <span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">toggle</span> <span class="o">=</span> <span class="n">get_toggle_pointer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">toggle</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">r8a66597_pipe_toggle</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="o">*</span><span class="n">toggle</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">endpoint</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pipe_buffer_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">r8a66597_pipe_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipenum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">ACLRM</span><span class="p">,</span> <span class="n">get_pipectr_addr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">));</span>
	<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">ACLRM</span><span class="p">,</span> <span class="n">get_pipectr_addr</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">));</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">,</span> <span class="n">PIPESEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">R8A66597_DIR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">R8A66597_BULK</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_in</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">R8A66597_DBLB</span> <span class="o">|</span> <span class="n">R8A66597_SHTNAK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">|</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">;</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">PIPECFG</span><span class="p">);</span>

	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">buf_bsize</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bufnum</span><span class="p">),</span>
		       <span class="n">PIPEBUF</span><span class="p">);</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">make_devsel</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">)</span> <span class="o">|</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span>
		       <span class="n">PIPEMAXP</span><span class="p">);</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">,</span> <span class="n">PIPEPERI</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pipe_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_pipe_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
		<span class="n">cfifo_change</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pipe_buffer_setting</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_gettoggle</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span>
				   <span class="n">usb_pipeout</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r8a66597_pipe_toggle</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">pipe_toggle_set</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">clear_all_buffer</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
			<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span>
				      <span class="n">usb_pipeout</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pipe_toggle_restore</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_empty_pipenum</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">array</span><span class="p">[</span><span class="n">R8A66597_MAX_NUM_PIPE</span><span class="p">],</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">min</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">array</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">usb_endpoint_type</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r8a66597: Illegal type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">min</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pipe_cnt</span><span class="p">[</span><span class="n">min</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pipe_cnt</span><span class="p">[</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
			<span class="n">min</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">min</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_r8a66597_type</span><span class="p">(</span><span class="n">__u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">r8a66597_type</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
		<span class="n">r8a66597_type</span> <span class="o">=</span> <span class="n">R8A66597_BULK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
		<span class="n">r8a66597_type</span> <span class="o">=</span> <span class="n">R8A66597_INT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>:
		<span class="n">r8a66597_type</span> <span class="o">=</span> <span class="n">R8A66597_ISO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r8a66597: Illegal type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r8a66597_type</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r8a66597_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_bufnum</span><span class="p">(</span><span class="n">u16</span> <span class="n">pipenum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">bufnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipenum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bufnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">check_bulk_or_isoc</span><span class="p">(</span><span class="n">pipenum</span><span class="p">))</span>
		<span class="n">bufnum</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="p">(</span><span class="n">pipenum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">R8A66597_BUF_BSIZE</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">check_interrupt</span><span class="p">(</span><span class="n">pipenum</span><span class="p">))</span>
		<span class="n">bufnum</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">pipenum</span> <span class="o">-</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r8a66597: Illegal pipenum (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bufnum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_buf_bsize</span><span class="p">(</span><span class="n">u16</span> <span class="n">pipenum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">buf_bsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipenum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">buf_bsize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">check_bulk_or_isoc</span><span class="p">(</span><span class="n">pipenum</span><span class="p">))</span>
		<span class="n">buf_bsize</span> <span class="o">=</span> <span class="n">R8A66597_BUF_BSIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">check_interrupt</span><span class="p">(</span><span class="n">pipenum</span><span class="p">))</span>
		<span class="n">buf_bsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r8a66597: Illegal pipenum (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buf_bsize</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_r8a66597_pipe_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">r8a66597_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8a66597_pipe_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mbw</span> <span class="o">=</span> <span class="n">mbw_value</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>

	<span class="cm">/* pipe dma is only for external controlles */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">on_chip</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pipenum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">R8A66597_INT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">R8A66597_MAX_DMA_CHANNEL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">dma_map</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;address %d, EndpointAddress 0x%02x use &quot;</span>
				 <span class="s">&quot;DMA FIFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usb_pipedevice</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span>
				 <span class="n">info</span><span class="o">-&gt;</span><span class="n">dir_in</span> <span class="o">?</span>
				 	<span class="n">USB_ENDPOINT_DIR_MASK</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">epnum</span>
					<span class="o">:</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">);</span>

			<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">dma_map</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_map</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">set_pipe_reg_addr</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

			<span class="n">cfifo_change</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">mbw</span> <span class="o">|</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pipenum</span><span class="p">,</span>
				      <span class="n">mbw</span> <span class="o">|</span> <span class="n">CURPIPE</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifosel</span><span class="p">);</span>

			<span class="n">r8a66597_reg_wait</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifosel</span><span class="p">,</span> <span class="n">CURPIPE</span><span class="p">,</span>
					  <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pipenum</span><span class="p">);</span>
			<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BCLR</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifoctr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_r8a66597_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">hep</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">r8a66597_pipe_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">get_urb_to_r8a66597_dev</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r8a66597_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enable_pipe:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="n">set_pipe_reg_addr</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">R8A66597_PIPE_NO_DMA</span><span class="p">);</span>
	<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pipe_cnt</span><span class="p">[</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pipenum</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pipe_cnt</span><span class="p">[</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pipenum</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

	<span class="n">enable_r8a66597_pipe_dma</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_urb_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">usb_pipetype</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PIPE_CONTROL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
		     <span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">;</span>
		     <span class="n">ptr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">usb_hcd_unlink_urb_from_ep</span><span class="p">(</span><span class="n">r8a66597_to_hcd</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">),</span> <span class="n">urb</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">usb_hcd_giveback_urb</span><span class="p">(</span><span class="n">r8a66597_to_hcd</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">),</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">force_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pipenum</span><span class="p">,</span> <span class="n">u16</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pipe_queue</span><span class="p">[</span><span class="n">pipenum</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">!=</span> <span class="n">address</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">urb</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">td</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="p">)</span>
			<span class="n">r8a66597_urb_done</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_r8a66597_pipe_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">check_ep0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pipenum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pipenum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">pipenum</span> <span class="o">&lt;</span> <span class="n">R8A66597_MAX_NUM_PIPE</span><span class="p">;</span> <span class="n">pipenum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pipe_cnt</span><span class="p">[</span><span class="n">pipenum</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_ep0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">check_ep0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">force_dequeue</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pipe_cnt</span><span class="p">[</span><span class="n">pipenum</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pipe_cnt</span><span class="p">[</span><span class="n">pipenum</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pipe_cnt</span><span class="p">[</span><span class="n">pipenum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">force_dequeue</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disable_pipe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">dma_map</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_map</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="n">IITV</span><span class="p">)</span>
			<span class="n">time</span> <span class="o">=</span> <span class="n">IITV</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">time</span> <span class="o">=</span> <span class="n">interval</span> <span class="o">?</span> <span class="n">interval</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">time</span> <span class="o">=</span> <span class="n">IITV</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* calculate the nearest value for PIPEPERI */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">interval</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">interval</span><span class="p">))</span>
					<span class="n">time</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">time</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">get_timer_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeisoc</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_r8a66597_usb_speed</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="o">==</span> <span class="n">HSMODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">interval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">time</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">time</span> <span class="o">=</span> <span class="n">time</span> <span class="o">*</span> <span class="mi">125</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* uSOF -&gt; msec */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">time</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">time</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_pipe_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">hep</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_pipe_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">info</span><span class="p">.</span><span class="n">pipenum</span> <span class="o">=</span> <span class="n">get_empty_pipenum</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">get_urb_to_r8a66597_addr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">epnum</span> <span class="o">=</span> <span class="n">usb_endpoint_num</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">get_r8a66597_type</span><span class="p">(</span><span class="n">usb_endpoint_type</span><span class="p">(</span><span class="n">ep</span><span class="p">));</span>
	<span class="n">info</span><span class="p">.</span><span class="n">bufnum</span> <span class="o">=</span> <span class="n">get_bufnum</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">pipenum</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">buf_bsize</span> <span class="o">=</span> <span class="n">get_buf_bsize</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">pipenum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">R8A66597_BULK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">timer_interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">get_interval</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">timer_interval</span> <span class="o">=</span> <span class="n">get_timer_interval</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span>
		<span class="n">info</span><span class="p">.</span><span class="n">dir_in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="p">.</span><span class="n">dir_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">enable_r8a66597_pipe</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">hep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_pipe_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">get_urb_to_r8a66597_dev</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">USB_STATE_CONFIGURED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pipe_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">pipenum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipenum</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">usb_pipeout</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
		<span class="n">enable_irq_empty</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">enable_irq_ready</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_pipeisoc</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
		<span class="n">enable_irq_nrdy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pipe_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pipenum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disable_irq_ready</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
	<span class="n">disable_irq_nrdy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_root_hub_start_polling</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">rh_timer</span><span class="p">,</span>
			<span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">R8A66597_RH_POLL_TIME</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_root_hub_sampling</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">connect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_root_hub</span> <span class="o">*</span><span class="n">rh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">root_hub</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>

	<span class="n">rh</span><span class="o">-&gt;</span><span class="n">old_syssts</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">get_syssts_reg</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">LNST</span><span class="p">;</span>
	<span class="n">rh</span><span class="o">-&gt;</span><span class="n">scount</span> <span class="o">=</span> <span class="n">R8A66597_MAX_SAMPLING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">)</span>
		<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">;</span>
	<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_C_CONNECTION</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">r8a66597_root_hub_start_polling</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_check_syssts</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">syssts</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">syssts</span> <span class="o">==</span> <span class="n">SE0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">ATTCH</span><span class="p">,</span> <span class="n">get_intsts_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">ATTCHE</span><span class="p">,</span> <span class="n">get_intenb_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">syssts</span> <span class="o">==</span> <span class="n">FS_JSTS</span><span class="p">)</span>
			<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">HSE</span><span class="p">,</span> <span class="n">get_syscfg_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">syssts</span> <span class="o">==</span> <span class="n">LS_JSTS</span><span class="p">)</span>
			<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">HSE</span><span class="p">,</span> <span class="n">get_syscfg_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>

		<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">DTCH</span><span class="p">,</span> <span class="n">get_intsts_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">DTCHE</span><span class="p">,</span> <span class="n">get_intenb_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">bus_suspended</span><span class="p">)</span>
			<span class="n">usb_hcd_resume_root_hub</span><span class="p">(</span><span class="n">r8a66597_to_hcd</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">usb_hcd_poll_rh_status</span><span class="p">(</span><span class="n">r8a66597_to_hcd</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">));</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_usb_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">get_rh_usb_speed</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r8a66597_root_hub</span> <span class="o">*</span><span class="n">rh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">root_hub</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>

	<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">USB_PORT_STAT_HIGH_SPEED</span> <span class="o">|</span> <span class="n">USB_PORT_STAT_LOW_SPEED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">HSMODE</span><span class="p">)</span>
		<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_HIGH_SPEED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">LSMODE</span><span class="p">)</span>
		<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_LOW_SPEED</span><span class="p">;</span>

	<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_PORT_STAT_RESET</span><span class="p">;</span>
	<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_ENABLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_usb_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">root_hub</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">disable_r8a66597_pipe_all</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">free_usb_address</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">start_root_hub_sampling</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_setup_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">setup_packet</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">setup_addr</span> <span class="o">=</span> <span class="n">USBREQ</span><span class="p">;</span>

	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">make_devsel</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">)</span> <span class="o">|</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span>
		       <span class="n">DCPMAXP</span><span class="p">);</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">SIGN</span> <span class="o">|</span> <span class="n">SACK</span><span class="p">),</span> <span class="n">INTSTS1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">setup_addr</span><span class="p">);</span>
		<span class="n">setup_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">SUREQ</span><span class="p">,</span> <span class="n">DCPCTR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_packet_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">R8A66597_DIR</span><span class="p">,</span> <span class="n">DCPCFG</span><span class="p">);</span>
		<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ISEL</span> <span class="o">|</span> <span class="n">CURPIPE</span><span class="p">,</span> <span class="n">CFIFOSEL</span><span class="p">);</span>
		<span class="n">r8a66597_reg_wait</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">CFIFOSEL</span><span class="p">,</span> <span class="n">CURPIPE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r8a66597_pipe_toggle</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BCLR</span><span class="p">,</span> <span class="n">CFIFOCTR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pipe_irq_disable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">);</span>
		<span class="n">pipe_start</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">pipe_irq_enable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pipe_irq_disable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">);</span>
			<span class="n">pipe_setting</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
			<span class="n">pipe_stop</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">),</span> <span class="n">BRDYSTS</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipetre</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">TRCLR</span><span class="p">,</span>
						<span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipetre</span><span class="p">);</span>
				<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span>
						<span class="n">DIV_ROUND_UP</span>
						  <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
						   <span class="n">td</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">),</span>
						<span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipetrn</span><span class="p">);</span>
				<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">TRENB</span><span class="p">,</span>
						<span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipetre</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">pipe_start</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
			<span class="n">pipe_irq_enable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_packet_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pipe_stop</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">R8A66597_DIR</span><span class="p">,</span> <span class="n">DCPCFG</span><span class="p">);</span>
		<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">ISEL</span><span class="p">,</span> <span class="n">ISEL</span> <span class="o">|</span> <span class="n">CURPIPE</span><span class="p">,</span> <span class="n">CFIFOSEL</span><span class="p">);</span>
		<span class="n">r8a66597_reg_wait</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">CFIFOSEL</span><span class="p">,</span> <span class="n">CURPIPE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r8a66597_pipe_toggle</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BCLR</span><span class="p">,</span> <span class="n">CFIFOCTR</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pipe_setting</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipetre</span><span class="p">)</span>
			<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">TRENB</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipetre</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">),</span> <span class="n">BRDYSTS</span><span class="p">);</span>

	<span class="n">fifo_change_from_pipe</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifoctr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">FRDY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">pipe_irq_enable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">packet_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">);</span>
	<span class="n">pipe_start</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_status_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">;</span>

	<span class="n">r8a66597_pipe_toggle</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pipe_stop</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">setup_packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_DIR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">R8A66597_DIR</span><span class="p">,</span> <span class="n">DCPCFG</span><span class="p">);</span>
		<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">ISEL</span><span class="p">,</span> <span class="n">ISEL</span> <span class="o">|</span> <span class="n">CURPIPE</span><span class="p">,</span> <span class="n">CFIFOSEL</span><span class="p">);</span>
		<span class="n">r8a66597_reg_wait</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">CFIFOSEL</span><span class="p">,</span> <span class="n">CURPIPE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">BEMP0</span><span class="p">,</span> <span class="n">BEMPSTS</span><span class="p">);</span>
		<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BCLR</span> <span class="o">|</span> <span class="n">BVAL</span><span class="p">,</span> <span class="n">CFIFOCTR</span><span class="p">);</span>
		<span class="n">enable_irq_empty</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">R8A66597_DIR</span><span class="p">,</span> <span class="n">DCPCFG</span><span class="p">);</span>
		<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ISEL</span> <span class="o">|</span> <span class="n">CURPIPE</span><span class="p">,</span> <span class="n">CFIFOSEL</span><span class="p">);</span>
		<span class="n">r8a66597_reg_wait</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">CFIFOSEL</span><span class="p">,</span> <span class="n">CURPIPE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BCLR</span><span class="p">,</span> <span class="n">CFIFOCTR</span><span class="p">);</span>
		<span class="n">enable_irq_ready</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">enable_irq_nrdy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pipe_start</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_set_address</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">setup_packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">setup_packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">USB_TYPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">USB_TYPE_STANDARD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">setup_packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">USB_REQ_SET_ADDRESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_PID_SETUP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_set_address</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">setup_packet</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">td</span><span class="o">-&gt;</span><span class="n">set_address</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">setup_packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_usb_address</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span>
								     <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">setup_packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">prepare_setup_packet</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_PID_IN</span>:
		<span class="n">prepare_packet_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_PID_OUT</span>:
		<span class="n">prepare_packet_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_PID_ACK</span>:
		<span class="n">prepare_status_packet</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r8a66597: invalid type.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_transfer_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeisoc</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span> <span class="o">==</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">iso_cnt</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* control or bulk or interrupt */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">&lt;=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">short_packet</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">zero_packet</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_td_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pipe_queue</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">usb_pipein</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">timeout_map</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">usb_pipetype</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PIPE_INTERRUPT</span>:
		<span class="k">case</span> <span class="n">PIPE_ISOCHRONOUS</span>:
			<span class="n">time</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">time</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">td_timer</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">],</span>
			  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">time</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">finish_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">,</span>
		<span class="n">u16</span> <span class="n">pipenum</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="n">__acquires</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">r8a66597_to_hcd</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>

	<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">timeout_map</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pipenum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">td</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">set_address</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">unlinked</span><span class="p">))</span>
			<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">address_map</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">setup_packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

		<span class="n">pipe_toggle_save</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">td</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pipe_queue</span><span class="p">[</span><span class="n">pipenum</span><span class="p">]))</span>
		<span class="n">restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">urb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeisoc</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">start_frame</span> <span class="o">=</span> <span class="n">r8a66597_get_frame</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

		<span class="n">r8a66597_urb_done</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">r8a66597_get_td</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">start_transfer</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
		<span class="n">set_td_timer</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">packet_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pipenum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rcv_len</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span> <span class="n">urb_len</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="n">r8a66597_get_td</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">finish</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">urb</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">;</span>

	<span class="n">fifo_change_from_pipe</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifoctr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">FRDY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pipe_stop</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">pipe_irq_disable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r8a66597: in fifo not ready (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
		<span class="n">finish_request</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">,</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prepare parameters */</span>
	<span class="n">rcv_len</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">DTLN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeisoc</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">iso_cnt</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">urb_len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">iso_cnt</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
		<span class="n">urb_len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">-</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bufsize</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">urb_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcv_len</span> <span class="o">&lt;=</span> <span class="n">bufsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">rcv_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">bufsize</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
		<span class="n">finish</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update parameters */</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcv_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">zero_packet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcv_len</span> <span class="o">&lt;</span> <span class="n">bufsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">short_packet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeisoc</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">iso_cnt</span><span class="p">].</span><span class="n">actual_length</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">iso_cnt</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">iso_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">finish</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check transfer finish */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">finish</span> <span class="o">||</span> <span class="n">check_transfer_finish</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">urb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pipe_stop</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">pipe_irq_disable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
		<span class="n">finish</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read fifo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BCLR</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifoctr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">r8a66597_read_fifo</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifoaddr</span><span class="p">,</span>
					   <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">finish</span> <span class="o">&amp;&amp;</span> <span class="n">pipenum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">finish_request</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">packet_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pipenum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bufsize</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="n">r8a66597_get_td</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">urb</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">;</span>

	<span class="n">fifo_change_from_pipe</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifoctr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">FRDY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pipe_stop</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">pipe_irq_disable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r8a66597: out fifo not ready (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
		<span class="n">finish_request</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prepare parameters */</span>
	<span class="n">bufsize</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeisoc</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">iso_cnt</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">bufsize</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">iso_cnt</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span>
			   <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">-</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* write fifo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipenum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pipenum</span><span class="p">),</span> <span class="n">BEMPSTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r8a66597_write_fifo</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_pipebulk</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">||</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BVAL</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifoctr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* update parameters */</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeisoc</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">iso_cnt</span><span class="p">].</span><span class="n">actual_length</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">iso_cnt</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">iso_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check transfer finish */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_transfer_finish</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">urb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">disable_irq_ready</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
		<span class="n">enable_irq_empty</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_pipeisoc</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
			<span class="n">enable_irq_nrdy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pipe_irq_enable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_next_phase</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="n">r8a66597_get_td</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">finish</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">urb</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_PID_IN</span>:
	<span class="k">case</span> <span class="n">USB_PID_OUT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">check_transfer_finish</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">urb</span><span class="p">))</span>
			<span class="n">td</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_PID_ACK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_PID_SETUP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">==</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span>
			<span class="n">td</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_PID_ACK</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeout</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
			<span class="n">td</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_PID_OUT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">td</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_PID_IN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_PID_ACK</span>:
		<span class="n">finish</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">finish</span> <span class="o">||</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">unlinked</span><span class="p">)</span>
		<span class="n">finish_request</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">start_transfer</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_urb_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pipenum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="n">r8a66597_get_td</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PID</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="n">PID_NAK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">irq_pipe_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">check</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pipenum</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BRDYSTS</span><span class="p">)</span>
	       <span class="o">&amp;</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BRDYENB</span><span class="p">);</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="n">BRDYSTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">BRDY0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">r8a66597_get_td</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span> <span class="o">&amp;&amp;</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_PID_IN</span><span class="p">)</span>
			<span class="n">packet_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pipe_irq_disable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">check_next_phase</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pipenum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">pipenum</span> <span class="o">&lt;</span> <span class="n">R8A66597_MAX_NUM_PIPE</span><span class="p">;</span> <span class="n">pipenum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">check</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pipenum</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">check</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">td</span> <span class="o">=</span> <span class="n">r8a66597_get_td</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_PID_IN</span><span class="p">)</span>
				<span class="n">packet_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_PID_OUT</span><span class="p">)</span>
				<span class="n">packet_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">irq_pipe_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">check</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pipenum</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BEMPSTS</span><span class="p">)</span>
	       <span class="o">&amp;</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BEMPENB</span><span class="p">);</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="n">BEMPSTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">BEMP0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfifo_change</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">r8a66597_get_td</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span> <span class="o">&amp;&amp;</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">USB_PID_OUT</span><span class="p">)</span>
			<span class="n">disable_irq_empty</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">check_next_phase</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pipenum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">pipenum</span> <span class="o">&lt;</span> <span class="n">R8A66597_MAX_NUM_PIPE</span><span class="p">;</span> <span class="n">pipenum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">check</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pipenum</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span>  <span class="n">check</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
			<span class="n">td</span> <span class="o">=</span> <span class="n">r8a66597_get_td</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipectr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">INBUFM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">disable_irq_empty</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
				<span class="n">pipe_irq_disable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
				<span class="n">finish_request</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">irq_pipe_nrdy</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">check</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pipenum</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">NRDYSTS</span><span class="p">)</span>
	       <span class="o">&amp;</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">NRDYENB</span><span class="p">);</span>
	<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="n">NRDYSTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">NRDY0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfifo_change</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">get_urb_error</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pipe_irq_disable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">check_next_phase</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pipenum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">pipenum</span> <span class="o">&lt;</span> <span class="n">R8A66597_MAX_NUM_PIPE</span><span class="p">;</span> <span class="n">pipenum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">check</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pipenum</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">check</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
			<span class="n">td</span> <span class="o">=</span> <span class="n">r8a66597_get_td</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">get_urb_error</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
			<span class="n">pipe_irq_disable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
			<span class="n">pipe_stop</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
			<span class="n">finish_request</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">r8a66597_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="n">hcd_to_r8a66597</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">intsts0</span><span class="p">,</span> <span class="n">intsts1</span><span class="p">,</span> <span class="n">intsts2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">intenb0</span><span class="p">,</span> <span class="n">intenb1</span><span class="p">,</span> <span class="n">intenb2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mask0</span><span class="p">,</span> <span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">intsts0</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">INTSTS0</span><span class="p">);</span>
	<span class="n">intsts1</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">INTSTS1</span><span class="p">);</span>
	<span class="n">intsts2</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">INTSTS2</span><span class="p">);</span>
	<span class="n">intenb0</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">INTENB0</span><span class="p">);</span>
	<span class="n">intenb1</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">INTENB1</span><span class="p">);</span>
	<span class="n">intenb2</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">INTENB2</span><span class="p">);</span>

	<span class="n">mask2</span> <span class="o">=</span> <span class="n">intsts2</span> <span class="o">&amp;</span> <span class="n">intenb2</span><span class="p">;</span>
	<span class="n">mask1</span> <span class="o">=</span> <span class="n">intsts1</span> <span class="o">&amp;</span> <span class="n">intenb1</span><span class="p">;</span>
	<span class="n">mask0</span> <span class="o">=</span> <span class="n">intsts0</span> <span class="o">&amp;</span> <span class="n">intenb0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BEMP</span> <span class="o">|</span> <span class="n">NRDY</span> <span class="o">|</span> <span class="n">BRDY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask2</span> <span class="o">&amp;</span> <span class="n">ATTCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">ATTCH</span><span class="p">,</span> <span class="n">INTSTS2</span><span class="p">);</span>
			<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">ATTCHE</span><span class="p">,</span> <span class="n">INTENB2</span><span class="p">);</span>

			<span class="cm">/* start usb bus sampling */</span>
			<span class="n">start_root_hub_sampling</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask2</span> <span class="o">&amp;</span> <span class="n">DTCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">DTCH</span><span class="p">,</span> <span class="n">INTSTS2</span><span class="p">);</span>
			<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">DTCHE</span><span class="p">,</span> <span class="n">INTENB2</span><span class="p">);</span>
			<span class="n">r8a66597_usb_disconnect</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask2</span> <span class="o">&amp;</span> <span class="n">BCHG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">BCHG</span><span class="p">,</span> <span class="n">INTSTS2</span><span class="p">);</span>
			<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BCHGE</span><span class="p">,</span> <span class="n">INTENB2</span><span class="p">);</span>
			<span class="n">usb_hcd_resume_root_hub</span><span class="p">(</span><span class="n">r8a66597_to_hcd</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask1</span> <span class="o">&amp;</span> <span class="n">ATTCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">ATTCH</span><span class="p">,</span> <span class="n">INTSTS1</span><span class="p">);</span>
			<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">ATTCHE</span><span class="p">,</span> <span class="n">INTENB1</span><span class="p">);</span>

			<span class="cm">/* start usb bus sampling */</span>
			<span class="n">start_root_hub_sampling</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask1</span> <span class="o">&amp;</span> <span class="n">DTCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">DTCH</span><span class="p">,</span> <span class="n">INTSTS1</span><span class="p">);</span>
			<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">DTCHE</span><span class="p">,</span> <span class="n">INTENB1</span><span class="p">);</span>
			<span class="n">r8a66597_usb_disconnect</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask1</span> <span class="o">&amp;</span> <span class="n">BCHG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">BCHG</span><span class="p">,</span> <span class="n">INTSTS1</span><span class="p">);</span>
			<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BCHGE</span><span class="p">,</span> <span class="n">INTENB1</span><span class="p">);</span>
			<span class="n">usb_hcd_resume_root_hub</span><span class="p">(</span><span class="n">r8a66597_to_hcd</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mask1</span> <span class="o">&amp;</span> <span class="n">SIGN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">SIGN</span><span class="p">,</span> <span class="n">INTSTS1</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">get_urb_error</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">check_next_phase</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask1</span> <span class="o">&amp;</span> <span class="n">SACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">SACK</span><span class="p">,</span> <span class="n">INTSTS1</span><span class="p">);</span>
			<span class="n">check_next_phase</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask0</span> <span class="o">&amp;</span> <span class="n">BRDY</span><span class="p">)</span>
			<span class="n">irq_pipe_ready</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask0</span> <span class="o">&amp;</span> <span class="n">BEMP</span><span class="p">)</span>
			<span class="n">irq_pipe_empty</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask0</span> <span class="o">&amp;</span> <span class="n">NRDY</span><span class="p">)</span>
			<span class="n">irq_pipe_nrdy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_root_hub_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8a66597_root_hub</span> <span class="o">*</span><span class="n">rh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">root_hub</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dvstctr_reg</span> <span class="o">=</span> <span class="n">get_dvstctr_reg</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">dvstctr_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">USBRST</span><span class="p">)</span> <span class="o">==</span> <span class="n">USBRST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">UACT</span><span class="p">,</span> <span class="n">USBRST</span> <span class="o">|</span> <span class="n">UACT</span><span class="p">,</span>
				      <span class="n">dvstctr_reg</span><span class="p">);</span>
			<span class="n">r8a66597_root_hub_start_polling</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">r8a66597_usb_connect</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">ATTCH</span><span class="p">,</span> <span class="n">get_intsts_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">ATTCHE</span><span class="p">,</span> <span class="n">get_intenb_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">scount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">get_syssts_reg</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">LNST</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">rh</span><span class="o">-&gt;</span><span class="n">old_syssts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rh</span><span class="o">-&gt;</span><span class="n">scount</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">scount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">r8a66597_check_syssts</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">r8a66597_root_hub_start_polling</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rh</span><span class="o">-&gt;</span><span class="n">scount</span> <span class="o">=</span> <span class="n">R8A66597_MAX_SAMPLING</span><span class="p">;</span>
			<span class="n">rh</span><span class="o">-&gt;</span><span class="n">old_syssts</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">r8a66597_root_hub_start_polling</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_interval_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_r8a66597</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="p">)</span><span class="n">_r8a66597</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pipenum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pipenum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pipenum</span> <span class="o">&lt;</span> <span class="n">R8A66597_MAX_NUM_PIPE</span><span class="p">;</span> <span class="n">pipenum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">interval_map</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pipenum</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">interval_timer</span><span class="p">[</span><span class="n">pipenum</span><span class="p">]))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">td</span> <span class="o">=</span> <span class="n">r8a66597_get_td</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="p">)</span>
			<span class="n">start_transfer</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_td_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_r8a66597</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="p">)</span><span class="n">_r8a66597</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pipenum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">,</span> <span class="o">*</span><span class="n">new_td</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8a66597_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pipenum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pipenum</span> <span class="o">&lt;</span> <span class="n">R8A66597_MAX_NUM_PIPE</span><span class="p">;</span> <span class="n">pipenum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">timeout_map</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pipenum</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">td_timer</span><span class="p">[</span><span class="n">pipenum</span><span class="p">]))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">td</span> <span class="o">=</span> <span class="n">r8a66597_get_td</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">timeout_map</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pipenum</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_td_timer</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pipe</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
		<span class="n">pipe_stop</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

		<span class="n">new_td</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_td</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pipe_queue</span><span class="p">[</span><span class="n">pipenum</span><span class="p">]);</span>
			<span class="n">new_td</span> <span class="o">=</span> <span class="n">r8a66597_get_td</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_td</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">new_td</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">td</span> <span class="o">!=</span> <span class="n">new_td</span> <span class="o">&amp;&amp;</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">==</span> <span class="n">new_td</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>

		<span class="n">start_transfer</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">new_td</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">td</span> <span class="o">==</span> <span class="n">new_td</span><span class="p">)</span>
			<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">timeout_map</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pipenum</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_td_timer</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">new_td</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_r8a66597</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="p">)</span><span class="n">_r8a66597</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span>
		<span class="n">r8a66597_root_hub_control</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_pipe_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">get_urb_to_r8a66597_dev</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">USB_STATE_CONFIGURED</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">USB_STATE_CONFIGURED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8a66597_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="n">hcd_to_r8a66597</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_RUNNING</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">enable_controller</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="n">hcd_to_r8a66597</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="n">disable_controller</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_address_zero</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">usb_address</span> <span class="o">=</span> <span class="n">usb_pipedevice</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">root_port</span><span class="p">,</span> <span class="n">hub_port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_port_number</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devpath</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">root_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hub_port</span><span class="p">);</span>
		<span class="n">set_devadd_reg</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">get_r8a66597_usb_speed</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">),</span>
			       <span class="n">get_parent_r8a66597_address</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			       <span class="n">hub_port</span><span class="p">,</span> <span class="n">root_port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="nf">r8a66597_make_td</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">hep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pipenum</span><span class="p">;</span>

	<span class="n">td</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597_td</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pipenum</span> <span class="o">=</span> <span class="n">r8a66597_get_pipenum</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">hep</span><span class="p">);</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span> <span class="o">=</span> <span class="n">pipenum</span><span class="p">;</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span> <span class="o">=</span> <span class="n">urb</span><span class="p">;</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">get_urb_to_r8a66597_addr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">usb_maxpacket</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span>
				      <span class="o">!</span><span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_PID_SETUP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_PID_IN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_PID_OUT</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">td</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8a66597_urb_enqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
				<span class="n">gfp_t</span> <span class="n">mem_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">hep</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="n">hcd_to_r8a66597</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">request</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_urb_to_r8a66597_dev</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_not_linked</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_hcd_link_urb_to_ep</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_not_linked</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597_pipe</span><span class="p">),</span>
				<span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_pipe_reg_addr</span><span class="p">(</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">,</span> <span class="n">R8A66597_PIPE_NO_DMA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
			<span class="n">init_pipe_info</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">hep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">check_pipe_config</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">)))</span>
		<span class="n">init_pipe_config</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>

	<span class="n">set_address_zero</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="n">td</span> <span class="o">=</span> <span class="n">r8a66597_make_td</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">hep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pipe_queue</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">]))</span>
		<span class="n">request</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pipe_queue</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">]);</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">timer_interval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">interval_map</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">;</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">interval_timer</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">],</span>
				  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span>
					<span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">timer_interval</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">start_transfer</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">td</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">set_td_timer</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">usb_hcd_unlink_urb_from_ep</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
<span class="nl">error_not_linked:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8a66597_urb_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="n">hcd_to_r8a66597</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_hcd_check_unlink_urb</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
		<span class="n">pipe_stop</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">pipe_irq_disable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">);</span>
		<span class="n">disable_irq_empty</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">);</span>
		<span class="n">finish_request</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">pipenum</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
 <span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_endpoint_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">hep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="n">hcd_to_r8a66597</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">r8a66597_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597_pipe</span> <span class="o">*</span><span class="p">)</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8a66597_td</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pipenum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pipenum</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">pipenum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipenum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">);</span>
		<span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pipe_stop</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="n">pipe_irq_disable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
	<span class="n">disable_irq_empty</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
	<span class="n">td</span> <span class="o">=</span> <span class="n">r8a66597_get_td</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="p">)</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">;</span>
	<span class="n">finish_request</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">pipenum</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">);</span>
	<span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8a66597_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="n">hcd_to_r8a66597</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r8a66597_read</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">FRMNUM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03FF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">collect_usb_address_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chix</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">USB_STATE_CONFIGURED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">udev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">devnum</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">udev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bDeviceClass</span> <span class="o">==</span> <span class="n">USB_CLASS_HUB</span><span class="p">)</span>
		<span class="n">map</span><span class="p">[</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="o">/</span><span class="mi">32</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span> <span class="o">%</span> <span class="mi">32</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">chix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chix</span> <span class="o">&lt;</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">maxchild</span><span class="p">;</span> <span class="n">chix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">childdev</span> <span class="o">=</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">[</span><span class="n">chix</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">childdev</span><span class="p">)</span>
			<span class="n">collect_usb_address_map</span><span class="p">(</span><span class="n">childdev</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* this function must be called with interrupt disabled */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="nf">get_r8a66597_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
						   <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">child_device</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">device_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_address</span> <span class="o">!=</span> <span class="n">addr</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r8a66597: get_r8a66597_device fail.(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_usb_address_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">root_hub</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">diff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diff</span> <span class="o">=</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">child_connect_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">diff</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">addr</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">))</span>
				<span class="n">set_child_connect_map</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">dev</span> <span class="o">=</span> <span class="n">get_r8a66597_device</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
				<span class="n">disable_r8a66597_pipe_all</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
				<span class="n">free_usb_address</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">put_child_connect_map</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_check_detect_child</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now_map</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">now_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">now_map</span><span class="p">));</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usb_bus_list</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">root_hub</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">busnum</span> <span class="o">!=</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">busnum</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">collect_usb_address_map</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">root_hub</span><span class="p">,</span> <span class="n">now_map</span><span class="p">);</span>
		<span class="n">update_usb_address_map</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">root_hub</span><span class="p">,</span> <span class="n">now_map</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8a66597_hub_status_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="n">hcd_to_r8a66597</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">r8a66597_check_detect_child</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">hcd</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* initialize (no change) */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">root_hub</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8a66597_hub_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">usb_hub_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bHubContrCurrent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bNbrPorts</span> <span class="o">=</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescLength</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bPwrOn2PwrGood</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">wHubCharacteristics</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0011</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8a66597_hub_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">typeReq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">wValue</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">wIndex</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">wLength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="n">hcd_to_r8a66597</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="n">wIndex</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8a66597_root_hub</span> <span class="o">*</span><span class="n">rh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">root_hub</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">typeReq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ClearHubFeature</span>:
	<span class="k">case</span> <span class="n">SetHubFeature</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">C_HUB_OVER_CURRENT</span>:
		<span class="k">case</span> <span class="n">C_HUB_LOCAL_POWER</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ClearPortFeature</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wIndex</span> <span class="o">&gt;</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_ENABLE</span>:
			<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_PORT_STAT_POWER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_SUSPEND</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_POWER</span>:
			<span class="n">r8a66597_port_power</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_ENABLE</span>:
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_SUSPEND</span>:
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_CONNECTION</span>:
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_OVER_CURRENT</span>:
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_RESET</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">wValue</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetHubDescriptor</span>:
		<span class="n">r8a66597_hub_descriptor</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">usb_hub_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetHubStatus</span>:
		<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetPortStatus</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wIndex</span> <span class="o">&gt;</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SetPortFeature</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wIndex</span> <span class="o">&gt;</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_SUSPEND</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_POWER</span>:
			<span class="n">r8a66597_port_power</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_POWER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_RESET</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">r8a66597_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

			<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_RESET</span><span class="p">;</span>

			<span class="n">disable_r8a66597_pipe_all</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">free_usb_address</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">USBRST</span><span class="p">,</span> <span class="n">USBRST</span> <span class="o">|</span> <span class="n">UACT</span><span class="p">,</span>
				      <span class="n">get_dvstctr_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">rh_timer</span><span class="p">,</span>
				  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">50</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">wValue</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
<span class="nl">error:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_PM)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8a66597_bus_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="n">hcd_to_r8a66597</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">device0</span><span class="p">.</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">r8a66597_root_hub</span> <span class="o">*</span><span class="n">rh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">root_hub</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dvstctr_reg</span> <span class="o">=</span> <span class="n">get_dvstctr_reg</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_ENABLE</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;suspend port = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="n">r8a66597_bclr</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">UACT</span><span class="p">,</span> <span class="n">dvstctr_reg</span><span class="p">);</span>	<span class="cm">/* suspend */</span>
		<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">do_remote_wakeup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>	<span class="cm">/* waiting last SOF */</span>
			<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">RWUPE</span><span class="p">,</span> <span class="n">dvstctr_reg</span><span class="p">);</span>
			<span class="n">r8a66597_write</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="o">~</span><span class="n">BCHG</span><span class="p">,</span> <span class="n">get_intsts_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
			<span class="n">r8a66597_bset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">BCHGE</span><span class="p">,</span> <span class="n">get_intenb_reg</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">bus_suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8a66597_bus_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="n">hcd_to_r8a66597</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">device0</span><span class="p">.</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">r8a66597_root_hub</span> <span class="o">*</span><span class="n">rh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">root_hub</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dvstctr_reg</span> <span class="o">=</span> <span class="n">get_dvstctr_reg</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resume port = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">;</span>
		<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_C_SUSPEND</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">RESUME</span><span class="p">,</span> <span class="n">RESUME</span> <span class="o">|</span> <span class="n">UACT</span><span class="p">,</span> <span class="n">dvstctr_reg</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">r8a66597_mdfy</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="n">UACT</span><span class="p">,</span> <span class="n">RESUME</span> <span class="o">|</span> <span class="n">UACT</span><span class="p">,</span> <span class="n">dvstctr_reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define	r8a66597_bus_suspend	NULL</span>
<span class="cp">#define	r8a66597_bus_resume	NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hc_driver</span> <span class="n">r8a66597_hc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span>		<span class="n">hcd_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hcd_priv_size</span> <span class="o">=</span>	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span><span class="p">),</span>
	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span>			<span class="n">r8a66597_irq</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * generic hardware linkage</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span>		<span class="n">HCD_USB2</span><span class="p">,</span>

	<span class="p">.</span><span class="n">start</span> <span class="o">=</span>		<span class="n">r8a66597_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span>			<span class="n">r8a66597_stop</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * managing i/o requests and associated device resources</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">urb_enqueue</span> <span class="o">=</span>		<span class="n">r8a66597_urb_enqueue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">urb_dequeue</span> <span class="o">=</span>		<span class="n">r8a66597_urb_dequeue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">endpoint_disable</span> <span class="o">=</span>	<span class="n">r8a66597_endpoint_disable</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * periodic schedule support</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">get_frame_number</span> <span class="o">=</span>	<span class="n">r8a66597_get_frame</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * root hub support</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">hub_status_data</span> <span class="o">=</span>	<span class="n">r8a66597_hub_status_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hub_control</span> <span class="o">=</span>		<span class="n">r8a66597_hub_control</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_suspend</span> <span class="o">=</span>		<span class="n">r8a66597_bus_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_resume</span> <span class="o">=</span>		<span class="n">r8a66597_bus_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#if defined(CONFIG_PM)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8a66597_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span>		<span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">disable_controller</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">r8a66597_root_hub</span> <span class="o">*</span><span class="n">rh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">root_hub</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>

		<span class="n">rh</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8a66597_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span>		<span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>		<span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">r8a66597_to_hcd</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">enable_controller</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>
	<span class="n">usb_root_hub_lost_power</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">r8a66597_dev_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">r8a66597_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">r8a66597_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poweroff</span> <span class="o">=</span> <span class="n">r8a66597_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">r8a66597_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define R8A66597_DEV_PM_OPS	(&amp;r8a66597_dev_pm_ops)</span>
<span class="cp">#else	</span><span class="cm">/* if defined(CONFIG_PM) */</span><span class="cp"></span>
<span class="cp">#define R8A66597_DEV_PM_OPS	NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">r8a66597_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r8a66597</span>		<span class="o">*</span><span class="n">r8a66597</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>		<span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">r8a66597_to_hcd</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">rh_timer</span><span class="p">);</span>
	<span class="n">usb_remove_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_HAVE_CLK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">on_chip</span><span class="p">)</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">r8a66597_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_HAVE_CLK</span>
	<span class="kt">char</span> <span class="n">clk_name</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">ires</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r8a66597</span> <span class="o">*</span><span class="n">r8a66597</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_trigger</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_disabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dma not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform_get_resource error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ires</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ires</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;platform_get_resource IORESOURCE_IRQ error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">ires</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">irq_trigger</span> <span class="o">=</span> <span class="n">ires</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IRQF_TRIGGER_MASK</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ioremap error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize hcd */</span>
	<span class="n">hcd</span> <span class="o">=</span> <span class="n">usb_create_hcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597_hc_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hcd_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hcd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to create hcd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r8a66597</span> <span class="o">=</span> <span class="n">hcd_to_r8a66597</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r8a66597</span><span class="p">));</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">r8a66597</span><span class="p">);</span>
	<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">irq_sense_low</span> <span class="o">=</span> <span class="n">irq_trigger</span> <span class="o">==</span> <span class="n">IRQF_TRIGGER_LOW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">on_chip</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_HAVE_CLK</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">clk_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clk_name</span><span class="p">),</span> <span class="s">&quot;usb%d&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">clk_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot get clock </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">clk_name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">clean_up2</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">max_root_hub</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">rh_timer</span><span class="p">);</span>
	<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">rh_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">r8a66597_timer</span><span class="p">;</span>
	<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">rh_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">r8a66597</span><span class="p">;</span>
	<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* make sure no interrupts are pending */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">r8a66597_clock_enable</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clean_up3</span><span class="p">;</span>
	<span class="n">disable_controller</span><span class="p">(</span><span class="n">r8a66597</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">R8A66597_MAX_NUM_PIPE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pipe_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">td_timer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">td_timer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">function</span> <span class="o">=</span> <span class="n">r8a66597_td_timer</span><span class="p">;</span>
		<span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">td_timer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">r8a66597</span><span class="p">;</span>
		<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">interval_timer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">r8a66597_interval_timer</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">r8a66597</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">child_device</span><span class="p">);</span>

	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_start</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">has_tt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_add_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">irq_trigger</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to add hcd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean_up3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">clean_up3:</span>
<span class="cp">#ifdef CONFIG_HAVE_CLK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">on_chip</span><span class="p">)</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">r8a66597</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="nl">clean_up2:</span>
<span class="cp">#endif</span>
	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

<span class="nl">clean_up:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">r8a66597_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">r8a66597_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>	<span class="n">__devexit_p</span><span class="p">(</span><span class="n">r8a66597_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">hcd_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="n">R8A66597_DEV_PM_OPS</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">r8a66597_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
