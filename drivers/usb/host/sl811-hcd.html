<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › host › sl811-hcd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sl811-hcd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * SL811HS HCD (Host Controller Driver) for USB.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 Psion Teklogix (for NetBook PRO)</span>
<span class="cm"> * Copyright (C) 2004-2005 David Brownell</span>
<span class="cm"> *</span>
<span class="cm"> * Periodic scheduling is based on Roman&#39;s OHCI code</span>
<span class="cm"> * 	Copyright (C) 1999 Roman Weissgaerber</span>
<span class="cm"> *</span>
<span class="cm"> * The SL811HS controller handles host side USB (like the SL11H, but with</span>
<span class="cm"> * another register set and SOF generation) as well as peripheral side USB</span>
<span class="cm"> * (like the SL811S).  This driver version doesn&#39;t implement the Gadget API</span>
<span class="cm"> * for the peripheral role; or OTG (that&#39;d need much external circuitry).</span>
<span class="cm"> *</span>
<span class="cm"> * For documentation, see the SL811HS spec and the &quot;SL811HS Embedded Host&quot;</span>
<span class="cm"> * document (providing significant pieces missing from that spec); plus</span>
<span class="cm"> * the SL811S spec if you want peripheral side info.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Status:  Passed basic stress testing, works with hubs, mice, keyboards,</span>
<span class="cm"> * and usb-storage.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> * - usb suspend/resume triggered by sl811 (with USB_SUSPEND)</span>
<span class="cm"> * - various issues noted in the code</span>
<span class="cm"> * - performance work; use both register banks; ...</span>
<span class="cm"> * - use urb-&gt;iso_frame_desc[] with ISO transfers</span>
<span class="cm"> */</span>

<span class="cp">#undef	VERBOSE</span>
<span class="cp">#undef	PACKET_TRACE</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/sl811.h&gt;</span>
<span class="cp">#include &lt;linux/usb/hcd.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;sl811.h&quot;</span>


<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SL811HS USB Host Controller Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:sl811-hcd&quot;</span><span class="p">);</span>

<span class="cp">#define DRIVER_VERSION	&quot;19 May 2005&quot;</span>


<span class="cp">#ifndef DEBUG</span>
<span class="cp">#	define	STUB_DEBUG_FILE</span>
<span class="cp">#endif</span>

<span class="cm">/* for now, use only one transfer register bank */</span>
<span class="cp">#undef	USE_B</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define    QUIRK2</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#define	QUIRK3</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">hcd_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;sl811-hcd&quot;</span><span class="p">;</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">port_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">sl811</span> <span class="o">*</span><span class="n">sl811</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>	<span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">sl811_to_hcd</span><span class="p">(</span><span class="n">sl811</span><span class="p">);</span>

	<span class="cm">/* hub is inactive unless the port is powered */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_POWER</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">=</span> <span class="n">USB_PORT_STAT_POWER</span><span class="p">;</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span> <span class="o">=</span> <span class="n">SL11H_INTMASK_INSRMV</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_HALT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_STATUS</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">&amp;&amp;</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">port_power</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* switch VBUS, at 500mA unless hub power budget gets set */</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;power %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">is_on</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">port_power</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="n">is_on</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* reset as thoroughly as we can */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">&amp;&amp;</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_CTLREG1</span><span class="p">,</span> <span class="n">SL11H_CTL1MASK_SE0</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_CTLREG1</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span><span class="p">);</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811HS_CTLREG2</span><span class="p">,</span> <span class="n">SL811HS_CTL2_INIT</span><span class="p">);</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_ENABLE</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>if !is_on, put into lowpower mode now</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* This is a PIO-only HCD.  Queueing appends URBs to the endpoint&#39;s queue,</span>
<span class="cm"> * and may start I/O.  Endpoint queues are scanned during completion irq</span>
<span class="cm"> * handlers (one per packet: ACK, NAK, faults, etc) and urb cancellation.</span>
<span class="cm"> *</span>
<span class="cm"> * Using an external DMA engine to copy a packet at a time could work,</span>
<span class="cm"> * though setup/teardown costs may be too big to make it worthwhile.</span>
<span class="cm"> */</span>

<span class="cm">/* SETUP starts a new control request.  Devices are not allowed to</span>
<span class="cm"> * STALL or NAK these; they must cancel any pending control requests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_packet</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">sl811</span>		<span class="o">*</span><span class="n">sl811</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">sl811h_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb</span><span class="p">,</span>
	<span class="n">u8</span>			<span class="n">bank</span><span class="p">,</span>
	<span class="n">u8</span>			<span class="n">control</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>			<span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">data_reg</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">SL811HS_PACKET_BUF</span><span class="p">(</span><span class="n">bank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ctrlrequest</span><span class="p">);</span>
	<span class="n">data_reg</span> <span class="o">=</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">;</span>
	<span class="n">sl811_write_buf</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">setup_packet</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* autoincrementing */</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">bank</span> <span class="o">+</span> <span class="n">SL11H_BUFADDRREG</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">SL_SETUP</span> <span class="cm">/* | ep-&gt;epnum */</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">usb_pipedevice</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span> <span class="n">data_reg</span><span class="p">);</span>

	<span class="cm">/* always OUT/data0 */</span> <span class="p">;</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">bank</span> <span class="o">+</span> <span class="n">SL11H_HOSTCTLREG</span><span class="p">,</span>
			<span class="n">control</span> <span class="o">|</span> <span class="n">SL11H_HCTLMASK_OUT</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PACKET</span><span class="p">(</span><span class="s">&quot;SETUP qh%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* STATUS finishes control requests, often after IN or OUT data packets */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">status_packet</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">sl811</span>		<span class="o">*</span><span class="n">sl811</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">sl811h_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb</span><span class="p">,</span>
	<span class="n">u8</span>			<span class="n">bank</span><span class="p">,</span>
	<span class="n">u8</span>			<span class="n">control</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">do_out</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">data_reg</span><span class="p">;</span>

	<span class="n">do_out</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">&amp;&amp;</span> <span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">data_reg</span> <span class="o">=</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">;</span>

	<span class="cm">/* autoincrementing */</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">bank</span> <span class="o">+</span> <span class="n">SL11H_BUFADDRREG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">((</span><span class="n">do_out</span> <span class="o">?</span> <span class="n">SL_OUT</span> <span class="o">:</span> <span class="n">SL_IN</span><span class="p">)</span> <span class="cm">/* | ep-&gt;epnum */</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">usb_pipedevice</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span> <span class="n">data_reg</span><span class="p">);</span>

	<span class="cm">/* always data1; sometimes IN */</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">SL11H_HCTLMASK_TOGGLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_out</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">SL11H_HCTLMASK_OUT</span><span class="p">;</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">bank</span> <span class="o">+</span> <span class="n">SL11H_HOSTCTLREG</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PACKET</span><span class="p">(</span><span class="s">&quot;STATUS%s/%s qh%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">nak_count</span> <span class="o">?</span> <span class="s">&quot;/retry&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">do_out</span> <span class="o">?</span> <span class="s">&quot;out&quot;</span> <span class="o">:</span> <span class="s">&quot;in&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* IN packets can be used with any type of endpoint. here we just</span>
<span class="cm"> * start the transfer, data from the peripheral may arrive later.</span>
<span class="cm"> * urb-&gt;iso_frame_desc is currently ignored here...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">in_packet</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">sl811</span>		<span class="o">*</span><span class="n">sl811</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">sl811h_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb</span><span class="p">,</span>
	<span class="n">u8</span>			<span class="n">bank</span><span class="p">,</span>
	<span class="n">u8</span>			<span class="n">control</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>			<span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">data_reg</span><span class="p">;</span>

	<span class="cm">/* avoid losing data on overflow */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">SL811HS_PACKET_BUF</span><span class="p">(</span><span class="n">bank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">SL11H_HCTLMASK_ISOCH</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="n">usb_gettoggle</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">SL11H_HCTLMASK_TOGGLE</span><span class="p">;</span>
	<span class="n">data_reg</span> <span class="o">=</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">;</span>

	<span class="cm">/* autoincrementing */</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">bank</span> <span class="o">+</span> <span class="n">SL11H_BUFADDRREG</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">SL_IN</span> <span class="o">|</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">usb_pipedevice</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span> <span class="n">data_reg</span><span class="p">);</span>

	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">bank</span> <span class="o">+</span> <span class="n">SL11H_HOSTCTLREG</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">-</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
	<span class="n">PACKET</span><span class="p">(</span><span class="s">&quot;IN%s/%d qh%p len%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">nak_count</span> <span class="o">?</span> <span class="s">&quot;/retry&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="o">!!</span><span class="n">usb_gettoggle</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ep</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* OUT packets can be used with any type of endpoint.</span>
<span class="cm"> * urb-&gt;iso_frame_desc is currently ignored here...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">out_packet</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">sl811</span>		<span class="o">*</span><span class="n">sl811</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">sl811h_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb</span><span class="p">,</span>
	<span class="n">u8</span>			<span class="n">bank</span><span class="p">,</span>
	<span class="n">u8</span>			<span class="n">control</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">data_reg</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">-</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">SL11H_HCTLMASK_ISOCH</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="n">usb_gettoggle</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">SL11H_HCTLMASK_TOGGLE</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">SL811HS_PACKET_BUF</span><span class="p">(</span><span class="n">bank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">data_reg</span> <span class="o">=</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">;</span>

	<span class="n">sl811_write_buf</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* autoincrementing */</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">bank</span> <span class="o">+</span> <span class="n">SL11H_BUFADDRREG</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">SL_OUT</span> <span class="o">|</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">usb_pipedevice</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span> <span class="n">data_reg</span><span class="p">);</span>

	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">bank</span> <span class="o">+</span> <span class="n">SL11H_HOSTCTLREG</span><span class="p">,</span>
			<span class="n">control</span> <span class="o">|</span> <span class="n">SL11H_HCTLMASK_OUT</span><span class="p">);</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">PACKET</span><span class="p">(</span><span class="s">&quot;OUT%s/%d qh%p len%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">nak_count</span> <span class="o">?</span> <span class="s">&quot;/retry&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="o">!!</span><span class="n">usb_gettoggle</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ep</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* caller updates on-chip enables later */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sofirq_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">sl811</span> <span class="o">*</span><span class="n">sl811</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_SOFINTR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;sof irq on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span> <span class="o">|=</span> <span class="n">SL11H_INTMASK_SOFINTR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sofirq_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">sl811</span> <span class="o">*</span><span class="n">sl811</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_SOFINTR</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;sof irq off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SL11H_INTMASK_SOFINTR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* pick the next endpoint for a transaction, and issue it.</span>
<span class="cm"> * frames start with periodic transfers (after whatever is pending</span>
<span class="cm"> * from the previous frame), and the rest of the time is async</span>
<span class="cm"> * transfers, scheduled round-robin.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sl811h_ep</span>	<span class="o">*</span><span class="nf">start</span><span class="p">(</span><span class="k">struct</span> <span class="n">sl811</span> <span class="o">*</span><span class="n">sl811</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sl811h_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">fclock</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">control</span><span class="p">;</span>

	<span class="cm">/* use endpoint at schedule head */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">next_periodic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">next_periodic</span><span class="p">;</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">next_periodic</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">next_async</span><span class="p">)</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">next_async</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">))</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sl811h_ep</span><span class="p">,</span> <span class="n">schedule</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* could set up the first fullspeed periodic</span>
<span class="cm">			 * transfer for the next frame ...</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#ifdef USE_B</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bank</span> <span class="o">&amp;&amp;</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span> <span class="o">==</span> <span class="n">ep</span><span class="p">)</span> <span class="o">||</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span> <span class="o">==</span> <span class="n">ep</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">next_async</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">next_async</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sl811h_ep</span><span class="p">,</span> <span class="n">schedule</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;empty %p queue?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">urb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span><span class="p">,</span> <span class="n">urb_list</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">defctrl</span><span class="p">;</span>

	<span class="cm">/* if this frame doesn&#39;t have enough time left to transfer this</span>
<span class="cm">	 * packet, wait till the next frame.  too-simple algorithm...</span>
<span class="cm">	 */</span>
	<span class="n">fclock</span> <span class="o">=</span> <span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_SOFTMRREG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">fclock</span> <span class="o">-=</span> <span class="mi">100</span><span class="p">;</span>		<span class="cm">/* setup takes not much time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_LOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">SL11H_HCTLMASK_PREAMBLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* also note erratum 1: some hubs won&#39;t work */</span>
			<span class="n">fclock</span> <span class="o">-=</span> <span class="mi">800</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fclock</span> <span class="o">-=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

		<span class="cm">/* erratum 2: AFTERSOF only works for fullspeed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fclock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">)</span>
				<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_overrun</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sofirq_on</span><span class="p">(</span><span class="n">sl811</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fclock</span> <span class="o">-=</span> <span class="mi">12000</span> <span class="o">/</span> <span class="mi">19</span><span class="p">;</span>	<span class="cm">/* 19 64byte packets/msec */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fclock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">)</span>
				<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_overrun</span><span class="o">++</span><span class="p">;</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">SL11H_HCTLMASK_AFTERSOF</span><span class="p">;</span>

		<span class="cm">/* throttle bulk/control irq noise */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nak_count</span><span class="p">)</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">SL11H_HCTLMASK_AFTERSOF</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_PID_IN</span>:
		<span class="n">in_packet</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_PID_OUT</span>:
		<span class="n">out_packet</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_PID_SETUP</span>:
		<span class="n">setup_packet</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_PID_ACK</span>:		<span class="cm">/* for control status */</span>
		<span class="n">status_packet</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;bad ep%p pid %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span><span class="p">);</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MIN_JIFFIES	((msecs_to_jiffies(2) &gt; 1) ? msecs_to_jiffies(2) : 2)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">start_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sl811</span> <span class="o">*</span><span class="n">sl811</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span> <span class="o">=</span> <span class="n">start</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_A</span><span class="p">(</span><span class="n">SL811_HOST_BUF</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">jiffies_a</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MIN_JIFFIES</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef USE_B</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span> <span class="o">=</span> <span class="n">start</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_B</span><span class="p">(</span><span class="n">SL811_HOST_BUF</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">jiffies_b</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MIN_JIFFIES</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">finish_request</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">sl811</span>		<span class="o">*</span><span class="n">sl811</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">sl811h_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb</span><span class="p">,</span>
	<span class="kt">int</span>			<span class="n">status</span>
<span class="p">)</span> <span class="n">__releases</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span> <span class="n">__acquires</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>		<span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_SETUP</span><span class="p">;</span>

	<span class="n">usb_hcd_unlink_urb_from_ep</span><span class="p">(</span><span class="n">sl811_to_hcd</span><span class="p">(</span><span class="n">sl811</span><span class="p">),</span> <span class="n">urb</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">usb_hcd_giveback_urb</span><span class="p">(</span><span class="n">sl811_to_hcd</span><span class="p">(</span><span class="n">sl811</span><span class="p">),</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* leave active endpoints in the schedule */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* async deschedule? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">next_async</span><span class="p">)</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">next_async</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* periodic deschedule */</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;deschedule qh%d/%p branch %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sl811h_ep</span>	<span class="o">*</span><span class="n">temp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sl811h_ep</span>	<span class="o">**</span><span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">prev</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">temp</span> <span class="o">=</span> <span class="o">*</span><span class="n">prev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ep</span><span class="p">))</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">temp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">prev</span><span class="p">)</span>
			<span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span> <span class="o">=</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span>
	<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">periodic_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">sl811_to_hcd</span><span class="p">(</span><span class="n">sl811</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_allocated</span>
		<span class="o">-=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span> <span class="o">/</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">next_periodic</span><span class="p">)</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">next_periodic</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="cm">/* we might turn SOFs back on again for the async schedule */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">periodic_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sofirq_off</span><span class="p">(</span><span class="n">sl811</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">done</span><span class="p">(</span><span class="k">struct</span> <span class="n">sl811</span> <span class="o">*</span><span class="n">sl811</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sl811h_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>			<span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">urbstat</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">bank</span> <span class="o">+</span> <span class="n">SL11H_PKTSTATREG</span><span class="p">);</span>

	<span class="n">urb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span><span class="p">,</span> <span class="n">urb_list</span><span class="p">);</span>

	<span class="cm">/* we can safely ignore NAKs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SL11H_STATMASK_NAK</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>PACKET("...NAK_%02x qh%p\n", bank, ep);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nak_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* ACK advances transfer, toggle, and maybe queue */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SL11H_STATMASK_ACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_device</span>	<span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="kt">int</span>			<span class="n">len</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">buf</span><span class="p">;</span>

		<span class="cm">/* urb-&gt;iso_frame_desc is currently ignored here... */</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nak_count</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PID_OUT</span>:</pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>PACKET("...ACK/out_%02x qh%p\n", bank, ep);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
			<span class="n">usb_dotoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span>
					<span class="o">==</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_ACK</span><span class="p">;</span>

				<span class="cm">/* some bulk protocols terminate OUT transfers</span>
<span class="cm">				 * by a short packet, using ZLPs not padding.</span>
<span class="cm">				 */</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span>
						<span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span>
							<span class="o">&amp;</span> <span class="n">URB_ZERO_PACKET</span><span class="p">))</span>
					<span class="n">urbstat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PID_IN</span>:</pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>PACKET("...ACK/in_%02x qh%p\n", bank, ep);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">buf</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
			<span class="n">prefetchw</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">-</span> <span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span>
						<span class="n">bank</span> <span class="o">+</span> <span class="n">SL11H_XFERCNTREG</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
				<span class="n">urbstat</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">sl811_read_buf</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811HS_PACKET_BUF</span><span class="p">(</span><span class="n">bank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">usb_dotoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">urbstat</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">||</span>
						<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">==</span>
						<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span>
					<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_ACK</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">urbstat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PID_SETUP</span>:</pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>PACKET("...ACK/setup_%02x qh%p\n", bank, ep);</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">==</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">)</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_ACK</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeout</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_OUT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_IN</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PID_ACK</span>:</pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>PACKET("...ACK/status_%02x qh%p\n", bank, ep);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">urbstat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* STALL stops all transfers */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SL11H_STATMASK_STALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PACKET</span><span class="p">(</span><span class="s">&quot;...STALL_%02x qh%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nak_count</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">urbstat</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>

	<span class="cm">/* error? retry, until &quot;3 strikes&quot; */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SL11H_STATMASK_TMOUT</span><span class="p">)</span>
			<span class="n">urbstat</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SL11H_STATMASK_OVF</span><span class="p">)</span>
			<span class="n">urbstat</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">urbstat</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">PACKET</span><span class="p">(</span><span class="s">&quot;...3STRIKES_%02x %02x qh%p stat %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bank</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">urbstat</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urbstat</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINPROGRESS</span> <span class="o">||</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">unlinked</span><span class="p">)</span>
		<span class="n">finish_request</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">urbstat</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">checkdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">sl811</span> <span class="o">*</span><span class="n">sl811</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>	<span class="n">ctl</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">irqstat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span> <span class="o">&amp;&amp;</span> <span class="n">time_before_eq</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">jiffies_a</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctl</span> <span class="o">=</span> <span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_A</span><span class="p">(</span><span class="n">SL11H_HOSTCTLREG</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">SL11H_HCTLMASK_ARM</span><span class="p">)</span>
			<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_A</span><span class="p">(</span><span class="n">SL11H_HOSTCTLREG</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s DONE_A: ctrl %02x sts %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">SL11H_HCTLMASK_ARM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;timeout&quot;</span> <span class="o">:</span> <span class="s">&quot;lost&quot;</span><span class="p">,</span>
			<span class="n">ctl</span><span class="p">,</span>
			<span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_A</span><span class="p">(</span><span class="n">SL11H_PKTSTATREG</span><span class="p">)));</span>
		<span class="n">irqstat</span> <span class="o">|=</span> <span class="n">SL11H_INTMASK_DONE_A</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef	USE_B</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span> <span class="o">&amp;&amp;</span> <span class="n">time_before_eq</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">jiffies_b</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctl</span> <span class="o">=</span> <span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_B</span><span class="p">(</span><span class="n">SL11H_HOSTCTLREG</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">SL11H_HCTLMASK_ARM</span><span class="p">)</span>
			<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_B</span><span class="p">(</span><span class="n">SL11H_HOSTCTLREG</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s DONE_B: ctrl %02x sts %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">SL11H_HCTLMASK_ARM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;timeout&quot;</span> <span class="o">:</span> <span class="s">&quot;lost&quot;</span><span class="p">,</span>
			<span class="n">ctl</span><span class="p">,</span>
			<span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_B</span><span class="p">(</span><span class="n">SL11H_PKTSTATREG</span><span class="p">)));</span>
		<span class="n">irqstat</span> <span class="o">|=</span> <span class="n">SL11H_INTMASK_DONE_A</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">irqstat</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sl811h_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sl811</span>	<span class="o">*</span><span class="n">sl811</span> <span class="o">=</span> <span class="n">hcd_to_sl811</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">u8</span>		<span class="n">irqstat</span><span class="p">;</span>
	<span class="n">irqreturn_t</span>	<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">retries</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="nl">retry:</span>
	<span class="n">irqstat</span> <span class="o">=</span> <span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SL11H_INTMASK_DP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_STATUS</span><span class="p">,</span> <span class="n">irqstat</span><span class="p">);</span>
		<span class="n">irqstat</span> <span class="o">&amp;=</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef	QUIRK2</span>
	<span class="cm">/* this may no longer be necessary ... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irqstat</span> <span class="o">=</span> <span class="n">checkdone</span><span class="p">(</span><span class="n">sl811</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span><span class="p">)</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_lost</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* USB packets, not necessarily handled in the order they&#39;re</span>
<span class="cm">	 * issued ... that&#39;s fine if they&#39;re different endpoints.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_DONE_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">done</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span><span class="p">,</span> <span class="n">SL811_EP_A</span><span class="p">(</span><span class="n">SL811_HOST_BUF</span><span class="p">));</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_a</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef USE_B</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_DONE_B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">done</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span><span class="p">,</span> <span class="n">SL811_EP_B</span><span class="p">(</span><span class="n">SL811_HOST_BUF</span><span class="p">));</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_b</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_SOFINTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">index</span><span class="p">;</span>

		<span class="n">index</span> <span class="o">=</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">++</span> <span class="o">%</span> <span class="p">(</span><span class="n">PERIODIC_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_sof</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* be graceful about almost-inevitable periodic schedule</span>
<span class="cm">		 * overruns:  continue the previous frame&#39;s transfers iff</span>
<span class="cm">		 * this one has nothing scheduled.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">next_periodic</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>ERR("overrun to slot %d\n", index);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_overrun</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">next_periodic</span> <span class="o">=</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* khubd manages debouncing and wakeup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_INSRMV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_insrmv</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* most stats are reset for each VBUS session */</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_wake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_sof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_lost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_CTLREG1</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span><span class="p">);</span>

		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span> <span class="o">=</span> <span class="n">SL11H_INTMASK_INSRMV</span><span class="p">;</span>
		<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_ENABLE</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">);</span>

		<span class="cm">/* usbcore nukes other pending transactions on disconnect */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_A</span><span class="p">(</span><span class="n">SL11H_HOSTCTLREG</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">finish_request</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span><span class="p">,</span>
				<span class="n">container_of</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span>
						<span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">urb</span><span class="p">,</span> <span class="n">urb_list</span><span class="p">),</span>
				<span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef	USE_B</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_B</span><span class="p">(</span><span class="n">SL11H_HOSTCTLREG</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">finish_request</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span><span class="p">,</span>
				<span class="n">container_of</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span>
						<span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">urb</span><span class="p">,</span> <span class="n">urb_list</span><span class="p">),</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">);</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="cm">/* port status seems weird until after reset, so</span>
<span class="cm">		 * force the reset and make khubd clean up later.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_RD</span><span class="p">)</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">;</span>

		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_C_CONNECTION</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_RD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;wakeup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_C_SUSPEND</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_wake</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">irqstat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SL11H_INTMASK_RD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_ENABLE</span><span class="p">)</span>
			<span class="n">start_transfer</span><span class="p">(</span><span class="n">sl811</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retries</span><span class="o">--</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">periodic_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">))</span>
		<span class="n">sofirq_off</span><span class="p">(</span><span class="n">sl811</span><span class="p">);</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_ENABLE</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* usb 1.1 says max 90% of a frame is available for periodic transfers.</span>
<span class="cm"> * this driver doesn&#39;t promise that much since it&#39;s got to handle an</span>
<span class="cm"> * IRQ per packet; irq handling latencies also use up that time.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:  the periodic schedule is a sparse tree, with the load for</span>
<span class="cm"> * each branch minimized.  see fig 3.5 in the OHCI spec for example.</span>
<span class="cm"> */</span>
<span class="cp">#define	MAX_PERIODIC_LOAD	500	</span><span class="cm">/* out of 1000 usec */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">balance</span><span class="p">(</span><span class="k">struct</span> <span class="n">sl811</span> <span class="o">*</span><span class="n">sl811</span><span class="p">,</span> <span class="n">u16</span> <span class="n">period</span><span class="p">,</span> <span class="n">u16</span> <span class="n">load</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">branch</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="cm">/* search for the least loaded schedule branch of that period</span>
<span class="cm">	 * which has enough bandwidth left unreserved.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">period</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">branch</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="kt">int</span>	<span class="n">j</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="n">period</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">load</span><span class="p">)</span>
						<span class="o">&gt;</span> <span class="n">MAX_PERIODIC_LOAD</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">branch</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">branch</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sl811h_urb_enqueue</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>		<span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb</span><span class="p">,</span>
	<span class="n">gfp_t</span>			<span class="n">mem_flags</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sl811</span>		<span class="o">*</span><span class="n">sl811</span> <span class="o">=</span> <span class="n">hcd_to_sl811</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span>	<span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">pipe</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">is_out</span> <span class="o">=</span> <span class="o">!</span><span class="n">usb_pipein</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">type</span> <span class="o">=</span> <span class="n">usb_pipetype</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">epnum</span> <span class="o">=</span> <span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sl811h_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span>	<span class="o">*</span><span class="n">hep</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_USB_SL811_HCD_ISO</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_ISOCHRONOUS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* avoid all allocations within spinlocks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">mem_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* don&#39;t submit to a dead or disabled port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_ENABLE</span><span class="p">)</span>
			<span class="o">||</span> <span class="o">!</span><span class="n">HC_IS_RUNNING</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_not_linked</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_hcd_link_urb_to_ep</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_not_linked</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">=</span> <span class="n">epnum</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">usb_maxpacket</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="n">is_out</span><span class="p">);</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">defctrl</span> <span class="o">=</span> <span class="n">SL11H_HCTLMASK_ARM</span> <span class="o">|</span> <span class="n">SL11H_HCTLMASK_ENABLE</span><span class="p">;</span>
		<span class="n">usb_settoggle</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">epnum</span><span class="p">,</span> <span class="n">is_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_CONTROL</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_SETUP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_out</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_OUT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">=</span> <span class="n">USB_PID_IN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span> <span class="o">&gt;</span> <span class="n">H_MAXPACKET</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* iso packets up to 240 bytes could work... */</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;dev %d ep%d maxpacket %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">epnum</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_LOW</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* send preamble for external hub? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">&amp;</span> <span class="n">SL11H_CTL1MASK_LSPD</span><span class="p">))</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">defctrl</span> <span class="o">|=</span> <span class="n">SL11H_HCTLMASK_PREAMBLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PIPE_ISOCHRONOUS</span>:
		<span class="k">case</span> <span class="n">PIPE_INTERRUPT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">)</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span> <span class="o">=</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_ISOCHRONOUS</span><span class="p">)</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">defctrl</span> <span class="o">|=</span> <span class="n">SL11H_HCTLMASK_ISOCH</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span> <span class="o">=</span> <span class="n">usb_calc_bus_time</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="o">!</span><span class="n">is_out</span><span class="p">,</span>
				<span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PIPE_ISOCHRONOUS</span><span class="p">),</span>
				<span class="n">usb_maxpacket</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">is_out</span><span class="p">))</span>
					<span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span> <span class="o">=</span> <span class="n">hep</span><span class="p">;</span>
		<span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* maybe put endpoint into schedule */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PIPE_CONTROL</span>:
	<span class="k">case</span> <span class="n">PIPE_BULK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">))</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIPE_ISOCHRONOUS</span>:
	<span class="k">case</span> <span class="n">PIPE_INTERRUPT</span>:
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span> <span class="o">&lt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* NOTE:  the phase is correct here, but the value</span>
<span class="cm">			 * needs offsetting by the transfer queue depth.</span>
<span class="cm">			 * All current drivers ignore start_frame, so this</span>
<span class="cm">			 * is unlikely to ever matter...</span>
<span class="cm">			 */</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">start_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PERIODIC_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
						<span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">balance</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span> <span class="o">=</span> <span class="n">retval</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">start_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PERIODIC_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
					<span class="o">+</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">;</span>

		<span class="cm">/* sort each schedule branch by period (slow before fast)</span>
<span class="cm">		 * to share the faster parts of the tree without needing</span>
<span class="cm">		 * dummy/placeholder nodes</span>
<span class="cm">		 */</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;schedule qh%d/%p branch %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sl811h_ep</span>	<span class="o">**</span><span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">sl811h_ep</span>	<span class="o">*</span><span class="n">here</span> <span class="o">=</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">here</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span> <span class="o">!=</span> <span class="n">here</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span> <span class="o">&gt;</span> <span class="n">here</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">prev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">here</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">here</span> <span class="o">=</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">!=</span> <span class="n">here</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">here</span><span class="p">;</span>
				<span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">periodic_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">bandwidth_allocated</span> <span class="o">+=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">load</span> <span class="o">/</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">;</span>
		<span class="n">sofirq_on</span><span class="p">(</span><span class="n">sl811</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="n">hep</span><span class="p">;</span>
	<span class="n">start_transfer</span><span class="p">(</span><span class="n">sl811</span><span class="p">);</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_ENABLE</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">usb_hcd_unlink_urb_from_ep</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
<span class="nl">fail_not_linked:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sl811h_urb_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sl811</span>		<span class="o">*</span><span class="n">sl811</span> <span class="o">=</span> <span class="n">hcd_to_sl811</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">hep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sl811h_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_hcd_check_unlink_urb</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">hep</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* finish right away if this urb can&#39;t be active ...</span>
<span class="cm">		 * note that some drivers wrongly expect delays</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">.</span><span class="n">next</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* not front of queue?  never active */</span>

		<span class="cm">/* for active transfers, we expect an IRQ */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span> <span class="o">==</span> <span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_before_eq</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">jiffies_a</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* happens a lot with lowspeed?? */</span>
				<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;giveup on DONE_A: ctrl %02x sts %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span>
						<span class="n">SL811_EP_A</span><span class="p">(</span><span class="n">SL11H_HOSTCTLREG</span><span class="p">)),</span>
					<span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span>
						<span class="n">SL811_EP_A</span><span class="p">(</span><span class="n">SL11H_PKTSTATREG</span><span class="p">)));</span>
				<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_A</span><span class="p">(</span><span class="n">SL11H_HOSTCTLREG</span><span class="p">),</span>
						<span class="mi">0</span><span class="p">);</span>
				<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef	USE_B</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span> <span class="o">==</span> <span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_before_eq</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">jiffies_a</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* happens a lot with lowspeed?? */</span>
				<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;giveup on DONE_B: ctrl %02x sts %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span>
						<span class="n">SL811_EP_B</span><span class="p">(</span><span class="n">SL11H_HOSTCTLREG</span><span class="p">)),</span>
					<span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span>
						<span class="n">SL811_EP_B</span><span class="p">(</span><span class="n">SL11H_PKTSTATREG</span><span class="p">)));</span>
				<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_B</span><span class="p">(</span><span class="n">SL11H_HOSTCTLREG</span><span class="p">),</span>
						<span class="mi">0</span><span class="p">);</span>
				<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* front of queue for inactive endpoint */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="p">)</span>
			<span class="n">finish_request</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">VDBG</span><span class="p">(</span><span class="s">&quot;dequeue, urb %p active %s; wait4irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span>
				<span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span> <span class="o">==</span> <span class="n">ep</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;A&quot;</span> <span class="o">:</span> <span class="s">&quot;B&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
 <span class="nl">fail:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sl811h_endpoint_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">hep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sl811h_ep</span>	<span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* assume we&#39;d just wait for the irq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">))</span>
		<span class="n">WARNING</span><span class="p">(</span><span class="s">&quot;ep %p not empty?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">hep</span><span class="o">-&gt;</span><span class="n">hcpriv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sl811h_get_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sl811</span> <span class="o">*</span><span class="n">sl811</span> <span class="o">=</span> <span class="n">hcd_to_sl811</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="cm">/* wrong except while periodic transfers are scheduled;</span>
<span class="cm">	 * never matches the on-the-wire frame;</span>
<span class="cm">	 * subject to overruns.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* the virtual root hub timer IRQ checks for hub status */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sl811h_hub_status_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sl811</span> <span class="o">*</span><span class="n">sl811</span> <span class="o">=</span> <span class="n">hcd_to_sl811</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
<span class="cp">#ifdef	QUIRK3</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* non-SMP HACK: use root hub timer as i/o watchdog</span>
<span class="cm">	 * this seems essential when SOF IRQs aren&#39;t in use...</span>
<span class="cm">	 */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl811h_irq</span><span class="p">(</span> <span class="cm">/* ~0, */</span> <span class="n">hcd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IRQ_NONE</span><span class="p">)</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_lost</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xffff</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* tell khubd port 1 changed */</span>
	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sl811h_hub_descriptor</span> <span class="p">(</span>
	<span class="k">struct</span> <span class="n">sl811</span>			<span class="o">*</span><span class="n">sl811</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">usb_hub_descriptor</span>	<span class="o">*</span><span class="n">desc</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="n">u16</span>		<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bHubContrCurrent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bNbrPorts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bDescLength</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>

	<span class="cm">/* per-port power switching (gang of one!), or none */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bPwrOn2PwrGood</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">&amp;&amp;</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">port_power</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bPwrOn2PwrGood</span> <span class="o">=</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">potpg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bPwrOn2PwrGood</span><span class="p">)</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bPwrOn2PwrGood</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="mh">0x0002</span><span class="p">;</span>

	<span class="cm">/* no overcurrent errors detection/handling */</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x0010</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">wHubCharacteristics</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>

	<span class="cm">/* ports removable, and legacy PortPwrCtrlMask */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hs</span><span class="p">.</span><span class="n">DeviceRemovable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sl811h_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_sl811</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sl811</span> 	<span class="o">*</span><span class="n">sl811</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">_sl811</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">irqstat</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">signaling</span> <span class="o">=</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">&amp;</span> <span class="n">SL11H_CTL1MASK_FORCE</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span>	<span class="n">mask</span> <span class="o">=</span> <span class="n">USB_PORT_STAT_CONNECTION</span>
				<span class="o">|</span> <span class="n">USB_PORT_STAT_ENABLE</span>
				<span class="o">|</span> <span class="n">USB_PORT_STAT_LOW_SPEED</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* stop special signaling */</span>
	<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SL11H_CTL1MASK_FORCE</span><span class="p">;</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_CTLREG1</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

	<span class="n">irqstat</span> <span class="o">=</span> <span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_STATUS</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">signaling</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SL11H_CTL1MASK_SE0</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;end reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">=</span> <span class="p">(</span><span class="n">USB_PORT_STAT_C_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
				 <span class="o">|</span> <span class="n">USB_PORT_STAT_POWER</span><span class="p">;</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* don&#39;t wrongly ack RD */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_INSRMV</span><span class="p">)</span>
			<span class="n">irqstat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SL11H_INTMASK_RD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SL11H_CTL1MASK_K</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;end resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;odd timer signaling: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">signaling</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_STATUS</span><span class="p">,</span> <span class="n">irqstat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_RD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* usbcore nukes all pending transactions on disconnect */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">)</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">USB_PORT_STAT_C_CONNECTION</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
					<span class="o">|</span> <span class="p">(</span><span class="n">USB_PORT_STAT_C_ENABLE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span> <span class="o">=</span> <span class="n">SL11H_INTMASK_INSRMV</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_DP</span><span class="p">)</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_PORT_STAT_LOW_SPEED</span><span class="p">;</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span> <span class="o">=</span> <span class="n">SL11H_INTMASK_INSRMV</span> <span class="o">|</span> <span class="n">SL11H_INTMASK_RD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span>	<span class="n">ctrl2</span> <span class="o">=</span> <span class="n">SL811HS_CTL2_INIT</span><span class="p">;</span>

		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span> <span class="o">|=</span> <span class="n">SL11H_INTMASK_DONE_A</span><span class="p">;</span>
<span class="cp">#ifdef USE_B</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span> <span class="o">|=</span> <span class="n">SL11H_INTMASK_DONE_B</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_LOW_SPEED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">|=</span> <span class="n">SL11H_CTL1MASK_LSPD</span><span class="p">;</span>
			<span class="n">ctrl2</span> <span class="o">|=</span> <span class="n">SL811HS_CTL2MASK_DSWAP</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* start SOFs flowing, kickstarting with A registers */</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">|=</span> <span class="n">SL11H_CTL1MASK_SOF_ENA</span><span class="p">;</span>
		<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_SOFLOWREG</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">);</span>
		<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811HS_CTLREG2</span><span class="p">,</span> <span class="n">ctrl2</span><span class="p">);</span>

		<span class="cm">/* autoincrementing */</span>
		<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_A</span><span class="p">(</span><span class="n">SL11H_BUFLNTHREG</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">SL_SOF</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">);</span>
		<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_A</span><span class="p">(</span><span class="n">SL11H_HOSTCTLREG</span><span class="p">),</span>
				<span class="n">SL11H_HCTLMASK_ARM</span><span class="p">);</span>

		<span class="cm">/* khubd provides debounce delay */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_CTLREG1</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span><span class="p">);</span>

	<span class="cm">/* reenable irqs */</span>
	<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_ENABLE</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sl811h_hub_control</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>	<span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">typeReq</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">wValue</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">wIndex</span><span class="p">,</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="n">u16</span>		<span class="n">wLength</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sl811</span>	<span class="o">*</span><span class="n">sl811</span> <span class="o">=</span> <span class="n">hcd_to_sl811</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">typeReq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ClearHubFeature</span>:
	<span class="k">case</span> <span class="n">SetHubFeature</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">C_HUB_OVER_CURRENT</span>:
		<span class="k">case</span> <span class="n">C_HUB_LOCAL_POWER</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ClearPortFeature</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wIndex</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">wLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_ENABLE</span>:
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;=</span> <span class="n">USB_PORT_STAT_POWER</span><span class="p">;</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_CTLREG1</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span><span class="p">);</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span> <span class="o">=</span> <span class="n">SL11H_INTMASK_INSRMV</span><span class="p">;</span>
			<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_ENABLE</span><span class="p">,</span>
						<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_SUSPEND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* 20 msec of resume/K signaling, other irqs blocked */</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;start resume...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_ENABLE</span><span class="p">,</span>
						<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">);</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">|=</span> <span class="n">SL11H_CTL1MASK_K</span><span class="p">;</span>
			<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_CTLREG1</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span><span class="p">);</span>

			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span>
					<span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_POWER</span>:
			<span class="n">port_power</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_ENABLE</span>:
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_SUSPEND</span>:
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_CONNECTION</span>:
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_OVER_CURRENT</span>:
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_C_RESET</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">wValue</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetHubDescriptor</span>:
		<span class="n">sl811h_hub_descriptor</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_hub_descriptor</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetHubStatus</span>:
		<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GetPortStatus</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wIndex</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

<span class="cp">#ifndef	VERBOSE</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>	<span class="cm">/* only if wPortChange is interesting */</span>
<span class="cp">#endif</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;GetPortStatus %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SetPortFeature</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wIndex</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">wLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_SUSPEND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_RESET</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_ENABLE</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;suspend...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SL11H_CTL1MASK_SOF_ENA</span><span class="p">;</span>
			<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_CTLREG1</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_POWER</span>:
			<span class="n">port_power</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_PORT_FEAT_RESET</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_SUSPEND</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_POWER</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* 50 msec of reset/SE0 signaling, irqs blocked */</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_ENABLE</span><span class="p">,</span>
						<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">);</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">=</span> <span class="n">SL11H_CTL1MASK_SE0</span><span class="p">;</span>
			<span class="n">sl811_write</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_CTLREG1</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span><span class="p">);</span>
			<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_RESET</span><span class="p">;</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span>
					<span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">50</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">wValue</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
<span class="nl">error:</span>
		<span class="cm">/* &quot;protocol stall&quot; on error */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef	CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sl811h_bus_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>SOFs off</p></td><td class="code"><div class="highlight"><pre>	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sl811h_bus_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>SOFs on</p></td><td class="code"><div class="highlight"><pre>	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define	sl811h_bus_suspend	NULL</span>
<span class="cp">#define	sl811h_bus_resume	NULL</span>

<span class="cp">#endif</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef STUB_DEBUG_FILE</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">create_debug_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">sl811</span> <span class="o">*</span><span class="n">sl811</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">remove_debug_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">sl811</span> <span class="o">*</span><span class="n">sl811</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s %02x%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_DONE_A</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; done_a&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_DONE_B</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; done_b&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_SOFINTR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; sof&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_INSRMV</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ins/rmv&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_RD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; rd&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">SL11H_INTMASK_DP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; dp&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_sl811h_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sl811</span>		<span class="o">*</span><span class="n">sl811</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sl811h_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">i</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">%s version %s</span><span class="se">\n</span><span class="s">portstatus[1] = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sl811_to_hcd</span><span class="p">(</span><span class="n">sl811</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">product_desc</span><span class="p">,</span>
		<span class="n">hcd_name</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span><span class="p">,</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;insert/remove: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_insrmv</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;current session:  done_a %ld done_b %ld &quot;</span>
			<span class="s">&quot;wake %ld sof %ld overrun %ld lost %ld</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_a</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_b</span><span class="p">,</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_wake</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_sof</span><span class="p">,</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_overrun</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">stat_lost</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">ctrl1</span> <span class="o">&amp;</span> <span class="n">SL11H_CTL1MASK_SUSPEND</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;(suspended)</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span>	<span class="n">t</span> <span class="o">=</span> <span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_CTLREG1</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;ctrl1 %02x%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span>
			<span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="n">SL11H_CTL1MASK_SOF_ENA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; sofgen&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">({</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> <span class="k">switch</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="n">SL11H_CTL1MASK_FORCE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SL11H_CTL1MASK_NORMAL</span>: <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SL11H_CTL1MASK_SE0</span>: <span class="n">s</span> <span class="o">=</span> <span class="s">&quot; se0/reset&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SL11H_CTL1MASK_K</span>: <span class="n">s</span> <span class="o">=</span> <span class="s">&quot; k/resume&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;j&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">};</span> <span class="n">s</span><span class="p">;</span> <span class="p">}),</span>
			<span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="n">SL11H_CTL1MASK_LSPD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; lowspeed&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="n">SL11H_CTL1MASK_SUSPEND</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; suspend&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

		<span class="n">dump_irq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;irq_enable&quot;</span><span class="p">,</span>
				<span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_ENABLE</span><span class="p">));</span>
		<span class="n">dump_irq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;irq_status&quot;</span><span class="p">,</span>
				<span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_IRQ_STATUS</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;frame clocks remaining:  %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_SOFTMRREG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;A: qh%p ctl %02x sts %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span><span class="p">,</span>
		<span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_A</span><span class="p">(</span><span class="n">SL11H_HOSTCTLREG</span><span class="p">)),</span>
		<span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_A</span><span class="p">(</span><span class="n">SL11H_PKTSTATREG</span><span class="p">)));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;B: qh%p ctl %02x sts %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span><span class="p">,</span>
		<span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_B</span><span class="p">(</span><span class="n">SL11H_HOSTCTLREG</span><span class="p">)),</span>
		<span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL811_EP_B</span><span class="p">(</span><span class="n">SL11H_PKTSTATREG</span><span class="p">)));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s%sqh%p, ep%d%s, maxpacket %d&quot;</span>
					<span class="s">&quot; nak %d err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;(A) &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;(B) &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">ep</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span>
			<span class="p">({</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> <span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">USB_PID_IN</span>: <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;in&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_PID_OUT</span>: <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;out&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_PID_SETUP</span>: <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;setup&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">USB_PID_ACK</span>: <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;status&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;?&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">};</span> <span class="n">s</span><span class="p">;}),</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">nak_count</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">hep</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">,</span> <span class="n">urb_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;  urb%p, %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">))</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;periodic size= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PERIODIC_SIZE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PERIODIC_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%2d [%3d]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/* DUMB: prints shared entries multiple times */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
				<span class="s">&quot;   %s%sqh%d/%p (%sdev%d ep%d%s max %d) &quot;</span>
					<span class="s">&quot;err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_a</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;(A) &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">active_b</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;(B) &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">period</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span>
					<span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;ls &quot;</span><span class="p">,</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span>
					<span class="o">:</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">nextpid</span> <span class="o">==</span> <span class="n">USB_PID_IN</span><span class="p">)</span>
						<span class="o">?</span> <span class="s">&quot;in&quot;</span>
						<span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">),</span>
				<span class="n">ep</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">error_count</span><span class="p">);</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_sl811h_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">proc_sl811h_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">proc_sl811h_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* expect just one sl811 per system */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">proc_filename</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;driver/sl811h&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">create_debug_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">sl811</span> <span class="o">*</span><span class="n">sl811</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">pde</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="n">proc_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_ops</span><span class="p">,</span> <span class="n">sl811</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_debug_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">sl811</span> <span class="o">*</span><span class="n">sl811</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">pde</span><span class="p">)</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">proc_filename</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sl811h_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sl811</span>	<span class="o">*</span><span class="n">sl811</span> <span class="o">=</span> <span class="n">hcd_to_sl811</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rh_timer</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">port_power</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sl811h_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sl811</span>		<span class="o">*</span><span class="n">sl811</span> <span class="o">=</span> <span class="n">hcd_to_sl811</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="cm">/* chip has been reset, VBUS power is off */</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_RUNNING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_can_wakeup</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">))</span>
			<span class="n">device_init_wakeup</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span>
				<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">can_wakeup</span><span class="p">);</span>
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">power_budget</span> <span class="o">=</span> <span class="n">sl811</span><span class="o">-&gt;</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable power and interrupts */</span>
	<span class="n">port_power</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hc_driver</span> <span class="n">sl811h_hc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span>		<span class="n">hcd_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hcd_priv_size</span> <span class="o">=</span>	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sl811</span><span class="p">),</span>

	<span class="cm">/*</span>
<span class="cm">	 * generic hardware linkage</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span>			<span class="n">sl811h_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span>		<span class="n">HCD_USB11</span> <span class="o">|</span> <span class="n">HCD_MEMORY</span><span class="p">,</span>

	<span class="cm">/* Basic lifecycle operations */</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span>		<span class="n">sl811h_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span>			<span class="n">sl811h_stop</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * managing i/o requests and associated device resources</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">urb_enqueue</span> <span class="o">=</span>		<span class="n">sl811h_urb_enqueue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">urb_dequeue</span> <span class="o">=</span>		<span class="n">sl811h_urb_dequeue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">endpoint_disable</span> <span class="o">=</span>	<span class="n">sl811h_endpoint_disable</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * periodic schedule support</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">get_frame_number</span> <span class="o">=</span>	<span class="n">sl811h_get_frame</span><span class="p">,</span>

	<span class="cm">/*</span>
<span class="cm">	 * root hub support</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">hub_status_data</span> <span class="o">=</span>	<span class="n">sl811h_hub_status_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hub_control</span> <span class="o">=</span>		<span class="n">sl811h_hub_control</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_suspend</span> <span class="o">=</span>		<span class="n">sl811h_bus_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_resume</span> <span class="o">=</span>		<span class="n">sl811h_bus_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span>
<span class="nf">sl811h_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>		<span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sl811</span>		<span class="o">*</span><span class="n">sl811</span> <span class="o">=</span> <span class="n">hcd_to_sl811</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">remove_debug_file</span><span class="p">(</span><span class="n">sl811</span><span class="p">);</span>
	<span class="n">usb_remove_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="cm">/* some platforms may use IORESOURCE_IO */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">data_reg</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">addr_reg</span><span class="p">);</span>

	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">sl811h_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>		<span class="o">*</span><span class="n">hcd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sl811</span>		<span class="o">*</span><span class="n">sl811</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">ires</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">irq</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">addr_reg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">data_reg</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">tmp</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">irqflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_disabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* basic sanity checks first.  board-specific init logic should</span>
<span class="cm">	 * have initialized these three resources and probably board</span>
<span class="cm">	 * specific platform_data.  we don&#39;t probe for IRQs, and do only</span>
<span class="cm">	 * minimal sanity checking.</span>
<span class="cm">	 */</span>
	<span class="n">ires</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_resources</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="o">!</span><span class="n">ires</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">ires</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">irqflags</span> <span class="o">=</span> <span class="n">ires</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IRQF_TRIGGER_MASK</span><span class="p">;</span>

	<span class="cm">/* refuse to confuse usbcore */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;no we won&#39;t dma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the chip may be wired for either kind of addressing */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_IO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_IO</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">ioaddr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * NOTE: 64-bit resource-&gt;start is getting truncated</span>
<span class="cm">		 * to avoid compiler warning, assuming that -&gt;start</span>
<span class="cm">		 * is always 32-bit for this case</span>
<span class="cm">		 */</span>
		<span class="n">addr_reg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">data_reg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">addr_reg</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr_reg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">data_reg</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_reg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* allocate and initialize hcd */</span>
	<span class="n">hcd</span> <span class="o">=</span> <span class="n">usb_create_hcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811h_hc_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hcd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err5</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_start</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">sl811</span> <span class="o">=</span> <span class="n">hcd_to_sl811</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">);</span>
	<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">sl811h_timer</span><span class="p">;</span>
	<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sl811</span><span class="p">;</span>
	<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">addr_reg</span> <span class="o">=</span> <span class="n">addr_reg</span><span class="p">;</span>
	<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">data_reg</span> <span class="o">=</span> <span class="n">data_reg</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">port_power</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">sl811_read</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="n">SL11H_HWREVREG</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">product_desc</span> <span class="o">=</span> <span class="s">&quot;SL811HS v1.2&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">product_desc</span> <span class="o">=</span> <span class="s">&quot;SL811HS v1.5&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* reject case 0, SL11S is less functional */</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;chiprev %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err6</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The chip&#39;s IRQ is level triggered, active high.  A requirement</span>
<span class="cm">	 * for platform device setup is to cope with things like signal</span>
<span class="cm">	 * inverters (e.g. CF is active low) or working only with edge</span>
<span class="cm">	 * triggers (e.g. most ARM CPUs).  Initial driver stress testing</span>
<span class="cm">	 * was on a system with single edge triggering, so most sorts of</span>
<span class="cm">	 * triggering arrangement should work.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Use resource IRQ flags if set by platform device setup.</span>
<span class="cm">	 */</span>
	<span class="n">irqflags</span> <span class="o">|=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_add_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err6</span><span class="p">;</span>

	<span class="n">create_debug_file</span><span class="p">(</span><span class="n">sl811</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

 <span class="nl">err6:</span>
	<span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
 <span class="nl">err5:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">data_reg</span><span class="p">);</span>
 <span class="nl">err4:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">addr_reg</span><span class="p">);</span>
 <span class="nl">err2:</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;init error, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef	CONFIG_PM</span>

<span class="cm">/* for this device there&#39;s no useful distinction between the controller</span>
<span class="cm"> * and its root hub, except that the root hub only gets direct PM calls</span>
<span class="cm"> * when CONFIG_USB_SUSPEND is enabled.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sl811h_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>	<span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sl811</span>	<span class="o">*</span><span class="n">sl811</span> <span class="o">=</span> <span class="n">hcd_to_sl811</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM_EVENT_FREEZE</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sl811h_bus_suspend</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_EVENT_SUSPEND</span>:
	<span class="k">case</span> <span class="n">PM_EVENT_HIBERNATE</span>:
	<span class="k">case</span> <span class="n">PM_EVENT_PRETHAW</span>:		<span class="cm">/* explicitly discard hw state */</span>
		<span class="n">port_power</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sl811h_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>	<span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sl811</span>	<span class="o">*</span><span class="n">sl811</span> <span class="o">=</span> <span class="n">hcd_to_sl811</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

	<span class="cm">/* with no &quot;check to see if VBUS is still powered&quot; board hook,</span>
<span class="cm">	 * let&#39;s assume it&#39;d only be powered to enable remote wakeup.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">||</span> <span class="o">!</span><span class="n">device_can_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sl811</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">port_power</span><span class="p">(</span><span class="n">sl811</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">usb_root_hub_lost_power</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sl811h_bus_resume</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define	sl811h_suspend	NULL</span>
<span class="cp">#define	sl811h_resume	NULL</span>

<span class="cp">#endif</span>


<span class="cm">/* this driver is exported so sl811_cs can depend on it */</span>
<span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">sl811h_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">sl811h_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>	<span class="n">__devexit_p</span><span class="p">(</span><span class="n">sl811h_remove</span><span class="p">),</span>

	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>	<span class="n">sl811h_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span>	<span class="n">sl811h_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>	<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">hcd_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sl811h_driver</span><span class="p">);</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">sl811h_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
