<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › renesas_usbhs › common.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>common.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Renesas USB driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Renesas Solutions Corp.</span>
<span class="cm"> * Kuninori Morimoto &lt;kuninori.morimoto.gx@renesas.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sysfs.h&gt;</span>
<span class="cp">#include &quot;./common.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> *		image of renesas_usbhs</span>
<span class="cm"> *</span>
<span class="cm"> * ex) gadget case</span>

<span class="cm"> * mod.c</span>
<span class="cm"> * mod_gadget.c</span>
<span class="cm"> * mod_host.c		pipe.c		fifo.c</span>
<span class="cm"> *</span>
<span class="cm"> *			+-------+	+-----------+</span>
<span class="cm"> *			| pipe0 |------&gt;| fifo pio  |</span>
<span class="cm"> * +------------+	+-------+	+-----------+</span>
<span class="cm"> * | mod_gadget |=====&gt; | pipe1 |--+</span>
<span class="cm"> * +------------+	+-------+  |	+-----------+</span>
<span class="cm"> *			| pipe2 |  |  +-| fifo dma0 |</span>
<span class="cm"> * +------------+	+-------+  |  |	+-----------+</span>
<span class="cm"> * | mod_host   |	| pipe3 |&lt;-|--+</span>
<span class="cm"> * +------------+	+-------+  |	+-----------+</span>
<span class="cm"> *			| ....  |  +---&gt;| fifo dma1 |</span>
<span class="cm"> *			| ....  |	+-----------+</span>
<span class="cm"> */</span>


<span class="cp">#define USBHSF_RUNTIME_PWCTRL	(1 &lt;&lt; 0)</span>

<span class="cm">/* status */</span>
<span class="cp">#define usbhsc_flags_init(p)   do {(p)-&gt;flags = 0; } while (0)</span>
<span class="cp">#define usbhsc_flags_set(p, b) ((p)-&gt;flags |=  (b))</span>
<span class="cp">#define usbhsc_flags_clr(p, b) ((p)-&gt;flags &amp;= ~(b))</span>
<span class="cp">#define usbhsc_flags_has(p, b) ((p)-&gt;flags &amp;   (b))</span>

<span class="cm">/*</span>
<span class="cm"> * platform call back</span>
<span class="cm"> *</span>
<span class="cm"> * renesas usb support platform callback function.</span>
<span class="cm"> * Below macro call it.</span>
<span class="cm"> * if platform doesn&#39;t have callback, it return 0 (no error)</span>
<span class="cm"> */</span>
<span class="cp">#define usbhs_platform_call(priv, func, args...)\</span>
<span class="cp">	(!(priv) ? -ENODEV :			\</span>
<span class="cp">	 !((priv)-&gt;pfunc.func) ? 0 :		\</span>
<span class="cp">	 (priv)-&gt;pfunc.func(args))</span>

<span class="cm">/*</span>
<span class="cm"> *		common functions</span>
<span class="cm"> */</span>
<span class="n">u16</span> <span class="nf">usbhs_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usbhs_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usbhs_bset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">usbhs_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">usbhs_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="nf">usbhs_pdev_to_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		syscfg functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbhs_sys_clock_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usbhs_bset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">SYSCFG</span><span class="p">,</span> <span class="n">SCKE</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">SCKE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usbhs_sys_host_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">DCFM</span> <span class="o">|</span> <span class="n">DRPD</span> <span class="o">|</span> <span class="n">DPRPU</span> <span class="o">|</span> <span class="n">HSE</span> <span class="o">|</span> <span class="n">USBE</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span>  <span class="o">=</span> <span class="n">DCFM</span> <span class="o">|</span> <span class="n">DRPD</span> <span class="o">|</span> <span class="n">HSE</span> <span class="o">|</span> <span class="n">USBE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">has_otg</span> <span class="o">=</span> <span class="n">usbhs_get_dparam</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">has_otg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_otg</span><span class="p">)</span>
		<span class="n">usbhs_bset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DVSTCTR</span><span class="p">,</span> <span class="p">(</span><span class="n">EXTLP</span> <span class="o">|</span> <span class="n">PWEN</span><span class="p">),</span> <span class="p">(</span><span class="n">EXTLP</span> <span class="o">|</span> <span class="n">PWEN</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * if enable</span>
<span class="cm">	 *</span>
<span class="cm">	 * - select Host mode</span>
<span class="cm">	 * - D+ Line/D- Line Pull-down</span>
<span class="cm">	 */</span>
	<span class="n">usbhs_bset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">SYSCFG</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">val</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usbhs_sys_function_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">DCFM</span> <span class="o">|</span> <span class="n">DRPD</span> <span class="o">|</span> <span class="n">DPRPU</span> <span class="o">|</span> <span class="n">HSE</span> <span class="o">|</span> <span class="n">USBE</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span>  <span class="o">=</span> <span class="n">DPRPU</span> <span class="o">|</span> <span class="n">HSE</span> <span class="o">|</span> <span class="n">USBE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if enable</span>
<span class="cm">	 *</span>
<span class="cm">	 * - select Function mode</span>
<span class="cm">	 * - D+ Line Pull-up</span>
<span class="cm">	 */</span>
	<span class="n">usbhs_bset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">SYSCFG</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">val</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usbhs_sys_set_test_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usbhs_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TESTMODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		frame functions</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usbhs_frame_get_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">usbhs_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">FRMNUM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FRNM_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		usb request functions</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">usbhs_usbreq_get_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">usbhs_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">USBREQ</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">bRequest</span>		<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">bRequestType</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wValue</span>	<span class="o">=</span> <span class="n">usbhs_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">USBVAL</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wIndex</span>	<span class="o">=</span> <span class="n">usbhs_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">USBINDX</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">wLength</span>	<span class="o">=</span> <span class="n">usbhs_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">USBLENG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usbhs_usbreq_set_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usbhs_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">USBREQ</span><span class="p">,</span>  <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">bRequest</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">bRequestType</span><span class="p">);</span>
	<span class="n">usbhs_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">USBVAL</span><span class="p">,</span>  <span class="n">req</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">);</span>
	<span class="n">usbhs_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">USBINDX</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">);</span>
	<span class="n">usbhs_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">USBLENG</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">);</span>

	<span class="n">usbhs_bset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DCPCTR</span><span class="p">,</span> <span class="n">SUREQ</span><span class="p">,</span> <span class="n">SUREQ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		bus/vbus functions</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">usbhs_bus_send_sof_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span> <span class="o">=</span> <span class="n">usbhs_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DVSTCTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">USBRST</span> <span class="o">|</span> <span class="n">UACT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">USBRST</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;usbhs should be reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">usbhs_bset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DVSTCTR</span><span class="p">,</span> <span class="p">(</span><span class="n">USBRST</span> <span class="o">|</span> <span class="n">UACT</span><span class="p">),</span> <span class="n">UACT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usbhs_bus_send_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usbhs_bset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DVSTCTR</span><span class="p">,</span> <span class="p">(</span><span class="n">USBRST</span> <span class="o">|</span> <span class="n">UACT</span><span class="p">),</span> <span class="n">USBRST</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">usbhs_bus_get_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dvstctr</span> <span class="o">=</span> <span class="n">usbhs_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DVSTCTR</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">RHST</span> <span class="o">&amp;</span> <span class="n">dvstctr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RHST_LOW_SPEED</span>:
		<span class="k">return</span> <span class="n">USB_SPEED_LOW</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RHST_FULL_SPEED</span>:
		<span class="k">return</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RHST_HIGH_SPEED</span>:
		<span class="k">return</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">usbhs_vbus_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_pdev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">usbhs_platform_call</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">set_vbus</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbhsc_bus_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usbhs_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DVSTCTR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">usbhs_vbus_ctrl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		device configuration</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usbhs_set_device_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devnum</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">upphub</span><span class="p">,</span> <span class="n">u16</span> <span class="n">hubport</span><span class="p">,</span> <span class="n">u16</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">usbspd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">DEVADD0</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">devnum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devnum</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot set speed to unknown device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">upphub</span> <span class="o">&gt;</span> <span class="mh">0xA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unsupported hub number %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">upphub</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_SPEED_LOW</span>:
		<span class="n">usbspd</span> <span class="o">=</span> <span class="n">USBSPD_SPEED_LOW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_SPEED_FULL</span>:
		<span class="n">usbspd</span> <span class="o">=</span> <span class="n">USBSPD_SPEED_FULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_SPEED_HIGH</span>:
		<span class="n">usbspd</span> <span class="o">=</span> <span class="n">USBSPD_SPEED_HIGH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unsupported speed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usbhs_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>	<span class="n">UPPHUB</span><span class="p">(</span><span class="n">upphub</span><span class="p">)</span>	<span class="o">|</span>
				<span class="n">HUBPORT</span><span class="p">(</span><span class="n">hubport</span><span class="p">)</span><span class="o">|</span>
				<span class="n">USBSPD</span><span class="p">(</span><span class="n">usbspd</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		local functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbhsc_set_buswait</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">wait</span> <span class="o">=</span> <span class="n">usbhs_get_dparam</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">buswait_bwait</span><span class="p">);</span>

	<span class="cm">/* set bus wait if platform have */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span>
		<span class="n">usbhs_bset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">BUSWAIT</span><span class="p">,</span> <span class="mh">0x000F</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		platform default param</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">usbhsc_default_pipe_type</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_ENDPOINT_XFER_CONTROL</span><span class="p">,</span>
		<span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">,</span>
		<span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">,</span>
		<span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
		<span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
		<span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">,</span>
		<span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">,</span>
		<span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">,</span>
		<span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">,</span>
		<span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *		power control</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbhsc_power_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_pdev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable PM */</span>
		<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* enable platform power */</span>
		<span class="n">usbhs_platform_call</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">power_ctrl</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

		<span class="cm">/* USB on */</span>
		<span class="n">usbhs_sys_clock_ctrl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* USB off */</span>
		<span class="n">usbhs_sys_clock_ctrl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

		<span class="cm">/* disable platform power */</span>
		<span class="n">usbhs_platform_call</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">power_ctrl</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

		<span class="cm">/* disable PM */</span>
		<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		hotplug</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbhsc_hotplug</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_pdev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_mod</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">usbhs_mod_get_current</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * get vbus status from platform</span>
<span class="cm">	 */</span>
	<span class="n">enable</span> <span class="o">=</span> <span class="n">usbhs_platform_call</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">get_vbus</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * get id from platform</span>
<span class="cm">	 */</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">usbhs_platform_call</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">get_id</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mod</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhs_mod_change</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/* power on */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbhsc_flags_has</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">USBHSF_RUNTIME_PWCTRL</span><span class="p">))</span>
			<span class="n">usbhsc_power_ctrl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

		<span class="cm">/* bus init */</span>
		<span class="n">usbhsc_set_buswait</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">usbhsc_bus_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="cm">/* module start */</span>
		<span class="n">usbhs_mod_call</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">mod</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/* module stop */</span>
		<span class="n">usbhs_mod_call</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

		<span class="cm">/* bus init */</span>
		<span class="n">usbhsc_bus_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="cm">/* power off */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbhsc_flags_has</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">USBHSF_RUNTIME_PWCTRL</span><span class="p">))</span>
			<span class="n">usbhsc_power_ctrl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

		<span class="n">usbhs_mod_change</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* reset phy for next connection */</span>
		<span class="n">usbhs_platform_call</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">phy_reset</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		notify hotplug</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbhsc_notify_hotplug</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">usbhs_priv</span><span class="p">,</span>
					       <span class="n">notify_hotplug_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">usbhsc_hotplug</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsc_drvcllbck_notify_hotplug</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pdev_to_priv</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">usbhs_get_dparam</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">detection_delay</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This functions will be called in interrupt.</span>
<span class="cm">	 * To make sure safety context,</span>
<span class="cm">	 * use workqueue for usbhs_notify_hotplug</span>
<span class="cm">	 */</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">notify_hotplug_work</span><span class="p">,</span>
			      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">delay</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		platform functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhs_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">renesas_usbhs_platform_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">renesas_usbhs_driver_callback</span> <span class="o">*</span><span class="n">dfunc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="o">*</span><span class="n">irq_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* check platform information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">platform_callback</span><span class="p">.</span><span class="n">get_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* platform data */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irq_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">||</span> <span class="o">!</span><span class="n">irq_res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not enough Renesas USB platform resources.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* usb private data */</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not allocate priv</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ioremap error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">probe_end_kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * care platform info</span>
<span class="cm">	 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pfunc</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">platform_callback</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">renesas_usbhs_platform_callback</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dparam</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver_param</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">renesas_usbhs_driver_param</span><span class="p">));</span>

	<span class="cm">/* set driver callback functions for platform */</span>
	<span class="n">dfunc</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver_callback</span><span class="p">;</span>
	<span class="n">dfunc</span><span class="o">-&gt;</span><span class="n">notify_hotplug</span>	<span class="o">=</span> <span class="n">usbhsc_drvcllbck_notify_hotplug</span><span class="p">;</span>

	<span class="cm">/* set default param if platform doesn&#39;t have */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dparam</span><span class="p">.</span><span class="n">pipe_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dparam</span><span class="p">.</span><span class="n">pipe_type</span> <span class="o">=</span> <span class="n">usbhsc_default_pipe_type</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dparam</span><span class="p">.</span><span class="n">pipe_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">usbhsc_default_pipe_type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dparam</span><span class="p">.</span><span class="n">pio_dma_border</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dparam</span><span class="p">.</span><span class="n">pio_dma_border</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span> <span class="cm">/* 64byte */</span>

	<span class="cm">/* FIXME */</span>
	<span class="cm">/* runtime power control ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pfunc</span><span class="p">.</span><span class="n">get_vbus</span><span class="p">)</span>
		<span class="n">usbhsc_flags_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">USBHSF_RUNTIME_PWCTRL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * priv settings</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span>	<span class="o">=</span> <span class="n">irq_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IRQ_SHAREABLE</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irqflags</span> <span class="o">=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span>	<span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">notify_hotplug_work</span><span class="p">,</span> <span class="n">usbhsc_notify_hotplug</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="n">usbhs_priv_to_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">));</span>

	<span class="cm">/* call pipe and module init */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhs_pipe_probe</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_end_iounmap</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhs_fifo_probe</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_end_pipe_exit</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhs_mod_probe</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_end_fifo_exit</span><span class="p">;</span>

	<span class="cm">/* dev_set_drvdata should be called after usbhs_mod_init */</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * deviece reset here because</span>
<span class="cm">	 * USB device might be used in boot loader.</span>
<span class="cm">	 */</span>
	<span class="n">usbhs_sys_clock_ctrl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * platform call</span>
<span class="cm">	 *</span>
<span class="cm">	 * USB phy setup might depend on CPU/Board.</span>
<span class="cm">	 * If platform has its callback functions,</span>
<span class="cm">	 * call it here.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhs_platform_call</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">hardware_init</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform prove failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">probe_end_mod_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset phy for connection */</span>
	<span class="n">usbhs_platform_call</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">phy_reset</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* power control */</span>
	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbhsc_flags_has</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">USBHSF_RUNTIME_PWCTRL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usbhsc_power_ctrl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">usbhs_mod_autonomy_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * manual call notify_hotplug for cold plug</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhsc_drvcllbck_notify_hotplug</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_end_call_remove</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">probe_end_call_remove:</span>
	<span class="n">usbhs_platform_call</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">hardware_exit</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
<span class="nl">probe_end_mod_exit:</span>
	<span class="n">usbhs_mod_remove</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">probe_end_fifo_exit:</span>
	<span class="n">usbhs_fifo_remove</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">probe_end_pipe_exit:</span>
	<span class="n">usbhs_pipe_remove</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">probe_end_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">probe_end_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probe failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">usbhs_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pdev_to_priv</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">renesas_usbhs_platform_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">renesas_usbhs_driver_callback</span> <span class="o">*</span><span class="n">dfunc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver_callback</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;usb remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dfunc</span><span class="o">-&gt;</span><span class="n">notify_hotplug</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* power off */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbhsc_flags_has</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">USBHSF_RUNTIME_PWCTRL</span><span class="p">))</span>
		<span class="n">usbhsc_power_ctrl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">usbhs_platform_call</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">hardware_exit</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
	<span class="n">usbhs_mod_remove</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">usbhs_fifo_remove</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">usbhs_pipe_remove</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_mod</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">usbhs_mod_get_current</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbhs_mod_call</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
		<span class="n">usbhs_mod_change</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mod</span> <span class="o">||</span> <span class="o">!</span><span class="n">usbhsc_flags_has</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">USBHSF_RUNTIME_PWCTRL</span><span class="p">))</span>
		<span class="n">usbhsc_power_ctrl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_pdev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">usbhs_platform_call</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">phy_reset</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbhsc_flags_has</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">USBHSF_RUNTIME_PWCTRL</span><span class="p">))</span>
		<span class="n">usbhsc_power_ctrl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">usbhsc_hotplug</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsc_runtime_nop</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Runtime PM callback shared between -&gt;runtime_suspend()</span>
<span class="cm">	 * and -&gt;runtime_resume(). Simply returns success.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This driver re-initializes all registers after</span>
<span class="cm">	 * pm_runtime_get_sync() anyway so there is no need</span>
<span class="cm">	 * to save and restore registers here.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">usbhsc_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>		<span class="o">=</span> <span class="n">usbhsc_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>			<span class="o">=</span> <span class="n">usbhsc_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_suspend</span>	<span class="o">=</span> <span class="n">usbhsc_runtime_nop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_resume</span>		<span class="o">=</span> <span class="n">usbhsc_runtime_nop</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">renesas_usbhs_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;renesas_usbhs&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">usbhsc_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">usbhs_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">usbhs_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">renesas_usbhs_driver</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Renesas USB driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kuninori Morimoto &lt;kuninori.morimoto.gx@renesas.com&gt;&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
