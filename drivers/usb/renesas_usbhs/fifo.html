<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › renesas_usbhs › fifo.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fifo.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Renesas USB driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Renesas Solutions Corp.</span>
<span class="cm"> * Kuninori Morimoto &lt;kuninori.morimoto.gx@renesas.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &quot;./common.h&quot;</span>
<span class="cp">#include &quot;./pipe.h&quot;</span>

<span class="cp">#define usbhsf_get_cfifo(p)	(&amp;((p)-&gt;fifo_info.cfifo))</span>
<span class="cp">#define usbhsf_get_d0fifo(p)	(&amp;((p)-&gt;fifo_info.d0fifo))</span>
<span class="cp">#define usbhsf_get_d1fifo(p)	(&amp;((p)-&gt;fifo_info.d1fifo))</span>
<span class="cp">#define usbhsf_is_cfifo(p, f)	(usbhsf_get_cfifo(p) == f)</span>

<span class="cp">#define usbhsf_fifo_is_busy(f)	((f)-&gt;pipe) </span><span class="cm">/* see usbhs_pipe_select_fifo */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *		packet initialize</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">usbhs_pkt_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">DMA_ADDR_INVALID</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		packet control function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_null_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;null handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usbhs_pkt_handle</span> <span class="n">usbhsf_null_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">usbhsf_null_handle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_run</span> <span class="o">=</span> <span class="n">usbhsf_null_handle</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">usbhs_pkt_push</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span>
		    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">),</span>
		    <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">zero</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sequence</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no done function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/********************  spin lock ********************/</span>
	<span class="n">usbhs_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no handler function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usbhsf_null_handler</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * each pkt must hold own handler.</span>
<span class="cm">	 * because handler might be changed by its situation.</span>
<span class="cm">	 * dma handler -&gt; pio handler.</span>
<span class="cm">	 */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span>	<span class="o">=</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">buf</span>	<span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">length</span>	<span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">zero</span>	<span class="o">=</span> <span class="n">zero</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">done</span>	<span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sequence</span>	<span class="o">=</span> <span class="n">sequence</span><span class="p">;</span>

	<span class="n">usbhs_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/********************  spin unlock ******************/</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__usbhsf_pkt_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="nf">__usbhsf_pkt_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbhs_pkt</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="nf">usbhs_pkt_pop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/********************  spin lock ********************/</span>
	<span class="n">usbhs_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="p">)</span>
		<span class="n">pkt</span> <span class="o">=</span> <span class="n">__usbhsf_pkt_get</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
		<span class="n">__usbhsf_pkt_del</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>

	<span class="n">usbhs_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/********************  spin unlock ******************/</span>

	<span class="k">return</span> <span class="n">pkt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">USBHSF_PKT_PREPARE</span><span class="p">,</span>
	<span class="n">USBHSF_PKT_TRY_RUN</span><span class="p">,</span>
	<span class="n">USBHSF_PKT_DMA_DONE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_pkt_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_done</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/********************  spin lock ********************/</span>
	<span class="n">usbhs_lock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pkt</span> <span class="o">=</span> <span class="n">__usbhsf_pkt_get</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__usbhs_pkt_handler_end</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USBHSF_PKT_PREPARE</span>:
		<span class="n">func</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USBHSF_PKT_TRY_RUN</span>:
		<span class="n">func</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">try_run</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USBHSF_PKT_DMA_DONE</span>:
		<span class="n">func</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">dma_done</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown pkt hander</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__usbhs_pkt_handler_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is_done</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_done</span><span class="p">)</span>
		<span class="n">__usbhsf_pkt_del</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>

<span class="nl">__usbhs_pkt_handler_end:</span>
	<span class="n">usbhs_unlock</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/********************  spin unlock ******************/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="n">usbhs_pkt_start</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usbhs_pkt_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usbhsf_pkt_handler</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">USBHSF_PKT_PREPARE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		irq enable/disable function</span>
<span class="cm"> */</span>
<span class="cp">#define usbhsf_irq_empty_ctrl(p, e) usbhsf_irq_callback_ctrl(p, bempsts, e)</span>
<span class="cp">#define usbhsf_irq_ready_ctrl(p, e) usbhsf_irq_callback_ctrl(p, brdysts, e)</span>
<span class="cp">#define usbhsf_irq_callback_ctrl(pipe, status, enable)			\</span>
<span class="cp">	({								\</span>
<span class="cp">		struct usbhs_priv *priv = usbhs_pipe_to_priv(pipe);	\</span>
<span class="cp">		struct usbhs_mod *mod = usbhs_mod_get_current(priv);	\</span>
<span class="cp">		u16 status = (1 &lt;&lt; usbhs_pipe_number(pipe));		\</span>
<span class="cp">		if (!mod)						\</span>
<span class="cp">			return;						\</span>
<span class="cp">		if (enable)						\</span>
<span class="cp">			mod-&gt;irq_##status |= status;			\</span>
<span class="cp">		else							\</span>
<span class="cp">			mod-&gt;irq_##status &amp;= ~status;			\</span>
<span class="cp">		usbhs_irq_callback_update(priv, mod);			\</span>
<span class="cp">	})</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbhsf_tx_irq_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * And DCP pipe can NOT use &quot;ready interrupt&quot; for &quot;send&quot;</span>
<span class="cm">	 * it should use &quot;empty&quot; interrupt.</span>
<span class="cm">	 * see</span>
<span class="cm">	 *   &quot;Operation&quot; - &quot;Interrupt Function&quot; - &quot;BRDY Interrupt&quot;</span>
<span class="cm">	 *</span>
<span class="cm">	 * on the other hand, normal pipe can use &quot;ready interrupt&quot; for &quot;send&quot;</span>
<span class="cm">	 * even though it is single/double buffer</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbhs_pipe_is_dcp</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
		<span class="n">usbhsf_irq_empty_ctrl</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">usbhsf_irq_ready_ctrl</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbhsf_rx_irq_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usbhsf_irq_ready_ctrl</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		FIFO ctrl</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbhsf_send_terminator</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="n">usbhs_bset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">,</span> <span class="n">BVAL</span><span class="p">,</span> <span class="n">BVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_fifo_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* The FIFO port is accessible */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbhs_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FRDY</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbhsf_fifo_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbhs_pipe_is_dcp</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
		<span class="n">usbhsf_fifo_barrier</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>

	<span class="n">usbhs_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">,</span> <span class="n">BCLR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_fifo_rcv_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">usbhs_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DTLN_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbhsf_fifo_unselect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="n">usbhs_pipe_select_fifo</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">usbhs_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_fifo_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xF</span><span class="p">);</span>		<span class="cm">/* mask of ISEL | CURPIPE */</span>
	<span class="n">u16</span> <span class="n">base</span> <span class="o">=</span> <span class="n">usbhs_pipe_number</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>	<span class="cm">/* CURPIPE */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbhs_pipe_is_busy</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">usbhsf_fifo_is_busy</span><span class="p">(</span><span class="n">fifo</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbhs_pipe_is_dcp</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">base</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">write</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>	<span class="cm">/* ISEL */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">usbhs_mod_is_host</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">usbhs_dcp_dir_for_host</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* &quot;base&quot; will be used below  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbhs_get_dparam</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">has_sudmac</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">usbhsf_is_cfifo</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="p">))</span>
		<span class="n">usbhs_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">usbhs_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="n">base</span> <span class="o">|</span> <span class="n">MBW_32</span><span class="p">);</span>

	<span class="cm">/* check ISEL and CURPIPE value */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">usbhs_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">usbhs_pipe_select_fifo</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fifo select error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		DCP status stage</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhs_dcp_dir_switch_to_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">usbhsf_get_cfifo</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span> <span class="cm">/* CFIFO */</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">usbhs_pipe_disable</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhsf_fifo_select</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s() faile</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usbhs_pipe_sequence_data1</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span> <span class="cm">/* DATA1 */</span>

	<span class="n">usbhsf_fifo_clear</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
	<span class="n">usbhsf_send_terminator</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>

	<span class="n">usbhsf_fifo_unselect</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>

	<span class="n">usbhsf_tx_irq_ctrl</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">usbhs_pipe_enable</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhs_dcp_dir_switch_to_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">usbhsf_get_cfifo</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span> <span class="cm">/* CFIFO */</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">usbhs_pipe_disable</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhsf_fifo_select</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s() fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usbhs_pipe_sequence_data1</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span> <span class="cm">/* DATA1 */</span>
	<span class="n">usbhsf_fifo_clear</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>

	<span class="n">usbhsf_fifo_unselect</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>

	<span class="n">usbhsf_rx_irq_ctrl</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">usbhs_pipe_enable</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhs_dcp_dir_switch_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">usbhs_dcp_status_stage_in_handler</span><span class="p">)</span>
		<span class="n">usbhsf_tx_irq_ctrl</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">usbhsf_rx_irq_ctrl</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="o">*</span><span class="n">is_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">usbhs_pkt_handle</span> <span class="n">usbhs_dcp_status_stage_in_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">usbhs_dcp_dir_switch_to_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_run</span> <span class="o">=</span> <span class="n">usbhs_dcp_dir_switch_done</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">usbhs_pkt_handle</span> <span class="n">usbhs_dcp_status_stage_out_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">usbhs_dcp_dir_switch_to_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_run</span> <span class="o">=</span> <span class="n">usbhs_dcp_dir_switch_done</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *		DCP data stage (push)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_dcp_data_stage_try_push</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>

	<span class="n">usbhs_pipe_sequence_data1</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span> <span class="cm">/* DATA1 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * change handler to PIO push</span>
<span class="cm">	 */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usbhs_fifo_pio_push_handler</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">is_done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">usbhs_pkt_handle</span> <span class="n">usbhs_dcp_data_stage_out_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">usbhsf_dcp_data_stage_try_push</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *		DCP data stage (pop)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_dcp_data_stage_prepare_pop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="o">*</span><span class="n">is_done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">usbhsf_get_cfifo</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbhs_pipe_is_busy</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * prepare pop for DCP should</span>
<span class="cm">	 *  - change DCP direction,</span>
<span class="cm">	 *  - clear fifo</span>
<span class="cm">	 *  - DATA1</span>
<span class="cm">	 */</span>
	<span class="n">usbhs_pipe_disable</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="n">usbhs_pipe_sequence_data1</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span> <span class="cm">/* DATA1 */</span>

	<span class="n">usbhsf_fifo_select</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">usbhsf_fifo_clear</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
	<span class="n">usbhsf_fifo_unselect</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * change handler to PIO pop</span>
<span class="cm">	 */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usbhs_fifo_pio_pop_handler</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">is_done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">usbhs_pkt_handle</span> <span class="n">usbhs_dcp_data_stage_in_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">usbhsf_dcp_data_stage_prepare_pop</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *		PIO push handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_pio_try_push</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">usbhsf_get_cfifo</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span> <span class="cm">/* CFIFO */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxp</span> <span class="o">=</span> <span class="n">usbhs_pipe_get_maxpacket</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">total_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_short</span><span class="p">;</span>

	<span class="n">usbhs_pipe_data_sequence</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* -1 sequence will be ignored */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhsf_fifo_select</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhs_pipe_is_accessible</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* inaccessible pipe is not an error */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">usbhs_fifo_write_busy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhsf_fifo_barrier</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">usbhs_fifo_write_busy</span><span class="p">;</span>

	<span class="n">buf</span>		<span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">buf</span>    <span class="o">+</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">len</span>		<span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">len</span>		<span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">maxp</span><span class="p">);</span>
	<span class="n">total_len</span>	<span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">is_short</span>	<span class="o">=</span> <span class="n">total_len</span> <span class="o">&lt;</span> <span class="n">maxp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME</span>
<span class="cm">	 *</span>
<span class="cm">	 * 32-bit access only</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">iowrite32_rep</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">%=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">total_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the rest operation */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x03</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)));</span>

	<span class="cm">/*</span>
<span class="cm">	 * variable update</span>
<span class="cm">	 */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">total_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">&lt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="o">*</span><span class="n">is_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* there are remainder data */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_short</span><span class="p">)</span>
		<span class="o">*</span><span class="n">is_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* short packet */</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">is_done</span> <span class="o">=</span> <span class="o">!</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">zero</span><span class="p">;</span>	<span class="cm">/* send zero packet ? */</span>

	<span class="cm">/*</span>
<span class="cm">	 * pipe/irq handling</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_short</span><span class="p">)</span>
		<span class="n">usbhsf_send_terminator</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>

	<span class="n">usbhsf_tx_irq_ctrl</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="o">!*</span><span class="n">is_done</span><span class="p">);</span>
	<span class="n">usbhs_pipe_enable</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  send %d (%d/ %d/ %d/ %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">usbhs_pipe_number</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">,</span> <span class="o">*</span><span class="n">is_done</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">zero</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Transmission end</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">is_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbhs_pipe_is_dcp</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
			<span class="n">usbhs_dcp_control_transfer_done</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">usbhsf_fifo_unselect</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">usbhs_fifo_write_busy:</span>
	<span class="n">usbhsf_fifo_unselect</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * pipe is busy.</span>
<span class="cm">	 * retry in interrupt</span>
<span class="cm">	 */</span>
	<span class="n">usbhsf_tx_irq_ctrl</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">usbhs_pkt_handle</span> <span class="n">usbhs_fifo_pio_push_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">usbhsf_pio_try_push</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_run</span> <span class="o">=</span> <span class="n">usbhsf_pio_try_push</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *		PIO pop handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_prepare_pop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbhs_pipe_is_busy</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * pipe enable to prepare packet receive</span>
<span class="cm">	 */</span>
	<span class="n">usbhs_pipe_data_sequence</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* -1 sequence will be ignored */</span>

	<span class="n">usbhs_pipe_enable</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">usbhsf_rx_irq_ctrl</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_pio_try_pop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">usbhsf_get_cfifo</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span> <span class="cm">/* CFIFO */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxp</span> <span class="o">=</span> <span class="n">usbhs_pipe_get_maxpacket</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rcv_len</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhsf_fifo_select</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhsf_fifo_barrier</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">usbhs_fifo_read_busy</span><span class="p">;</span>

	<span class="n">rcv_len</span> <span class="o">=</span> <span class="n">usbhsf_fifo_rcv_len</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>

	<span class="n">buf</span>		<span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">buf</span>    <span class="o">+</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">len</span>		<span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">len</span>		<span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">rcv_len</span><span class="p">);</span>
	<span class="n">total_len</span>	<span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * update actual length first here to decide disable pipe.</span>
<span class="cm">	 * if this pipe keeps BUF status and all data were popped,</span>
<span class="cm">	 * then, next interrupt/token will be issued again</span>
<span class="cm">	 */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">total_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">==</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">||</span>	<span class="cm">/* receive all data */</span>
	    <span class="p">(</span><span class="n">total_len</span> <span class="o">&lt;</span> <span class="n">maxp</span><span class="p">))</span> <span class="p">{</span>		<span class="cm">/* short packet */</span>
		<span class="o">*</span><span class="n">is_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">usbhsf_rx_irq_ctrl</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">usbhs_pipe_disable</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>	<span class="cm">/* disable pipe first */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Buffer clear if Zero-Length packet</span>
<span class="cm">	 *</span>
<span class="cm">	 * see</span>
<span class="cm">	 * &quot;Operation&quot; - &quot;FIFO Buffer Memory&quot; - &quot;FIFO Port Function&quot;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">rcv_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">usbhsf_fifo_clear</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">usbhs_fifo_read_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME</span>
<span class="cm">	 *</span>
<span class="cm">	 * 32-bit access only</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ioread32_rep</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">%=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">total_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the rest operation */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">))</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">usbhs_fifo_read_end:</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  recv %d (%d/ %d/ %d/ %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">usbhs_pipe_number</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">,</span> <span class="o">*</span><span class="n">is_done</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">zero</span><span class="p">);</span>

<span class="nl">usbhs_fifo_read_busy:</span>
	<span class="n">usbhsf_fifo_unselect</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">usbhs_pkt_handle</span> <span class="n">usbhs_fifo_pio_pop_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">usbhsf_prepare_pop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_run</span> <span class="o">=</span> <span class="n">usbhsf_pio_try_pop</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *		DCP ctrol statge handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_ctrl_stage_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usbhs_dcp_control_transfer_done</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

	<span class="o">*</span><span class="n">is_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">usbhs_pkt_handle</span> <span class="n">usbhs_ctrl_stage_end_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">usbhsf_ctrl_stage_end</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_run</span> <span class="o">=</span> <span class="n">usbhsf_ctrl_stage_end</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *		DMA fifo functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="nf">usbhsf_dma_chan_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">usbhs_fifo_dma_push_handler</span> <span class="o">==</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">usbhs_fifo_dma_pop_handler</span> <span class="o">==</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="nf">usbhsf_get_dma_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">;</span>

	<span class="cm">/* DMA :: D0FIFO */</span>
	<span class="n">fifo</span> <span class="o">=</span> <span class="n">usbhsf_get_d0fifo</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbhsf_dma_chan_get</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">pkt</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">usbhsf_fifo_is_busy</span><span class="p">(</span><span class="n">fifo</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">fifo</span><span class="p">;</span>

	<span class="cm">/* DMA :: D1FIFO */</span>
	<span class="n">fifo</span> <span class="o">=</span> <span class="n">usbhsf_get_d1fifo</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbhsf_dma_chan_get</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">pkt</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">usbhsf_fifo_is_busy</span><span class="p">(</span><span class="n">fifo</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">fifo</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define usbhsf_dma_start(p, f)	__usbhsf_dma_ctrl(p, f, DREQE)</span>
<span class="cp">#define usbhsf_dma_stop(p, f)	__usbhsf_dma_ctrl(p, f, 0)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__usbhsf_dma_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">dreqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="n">usbhs_bset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">sel</span><span class="p">,</span> <span class="n">DREQE</span><span class="p">,</span> <span class="n">dreqe</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define usbhsf_dma_map(p)	__usbhsf_dma_map_ctrl(p, 1)</span>
<span class="cp">#define usbhsf_dma_unmap(p)	__usbhsf_dma_map_ctrl(p, 0)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__usbhsf_dma_map_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">usbhs_priv_to_pipeinfo</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dma_map_ctrl</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">usbhsf_dma_complete</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xfer_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbhs_pkt</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_fifo</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">usbhsf_dma_chan_get</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">dma_transfer_direction</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="n">dir</span> <span class="o">=</span> <span class="n">usbhs_pipe_is_dir_in</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="n">DMA_DEV_TO_MEM</span> <span class="o">:</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">;</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">),</span>
		    <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">));</span>
	<span class="n">sg_dma_address</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">dmaengine_prep_slave_sg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span>
					<span class="n">DMA_PREP_INTERRUPT</span> <span class="o">|</span> <span class="n">DMA_CTRL_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback</span>		<span class="o">=</span> <span class="n">usbhsf_dma_complete</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback_param</span>	<span class="o">=</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="n">cookie</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">tx_submit</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to submit dma descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  %s %d (%d/ %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">usbhs_pipe_number</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">zero</span><span class="p">);</span>

	<span class="n">usbhsf_dma_start</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
	<span class="n">dma_async_issue_pending</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		DMA push handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_dma_prepare_push</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbhs_pipe_is_busy</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* use PIO if packet is less than pio_dma_border or pipe is DCP */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">usbhs_get_dparam</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">pio_dma_border</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">usbhs_pipe_is_dcp</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">usbhsf_pio_prepare_push</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="cm">/* 32bit alignment */</span>
		<span class="k">goto</span> <span class="n">usbhsf_pio_prepare_push</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="cm">/* 8byte alignment */</span>
		<span class="k">goto</span> <span class="n">usbhsf_pio_prepare_push</span><span class="p">;</span>

	<span class="cm">/* get enable DMA fifo */</span>
	<span class="n">fifo</span> <span class="o">=</span> <span class="n">usbhsf_get_dma_fifo</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fifo</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">usbhsf_pio_prepare_push</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbhsf_dma_map</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">usbhsf_pio_prepare_push</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhsf_fifo_select</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">usbhsf_pio_prepare_push_unmap</span><span class="p">;</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">trans</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">xfer_work</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">usbhsf_pio_prepare_push_unmap:</span>
	<span class="n">usbhsf_dma_unmap</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
<span class="nl">usbhsf_pio_prepare_push:</span>
	<span class="cm">/*</span>
<span class="cm">	 * change handler to PIO</span>
<span class="cm">	 */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usbhs_fifo_pio_push_handler</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">is_done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_dma_push_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">;</span>

	<span class="o">*</span><span class="n">is_done</span> <span class="o">=</span> <span class="o">!</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">zero</span><span class="p">;</span>	<span class="cm">/* send zero packet ? */</span>

	<span class="n">usbhsf_dma_stop</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">);</span>
	<span class="n">usbhsf_dma_unmap</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
	<span class="n">usbhsf_fifo_unselect</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">usbhs_pkt_handle</span> <span class="n">usbhs_fifo_dma_push_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span>	<span class="o">=</span> <span class="n">usbhsf_dma_prepare_push</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_done</span>	<span class="o">=</span> <span class="n">usbhsf_dma_push_done</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *		DMA pop handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_dma_try_pop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbhs_pipe_is_busy</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbhs_pipe_is_dcp</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">usbhsf_pio_prepare_pop</span><span class="p">;</span>

	<span class="cm">/* get enable DMA fifo */</span>
	<span class="n">fifo</span> <span class="o">=</span> <span class="n">usbhsf_get_dma_fifo</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fifo</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">usbhsf_pio_prepare_pop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="cm">/* 8byte alignment */</span>
		<span class="k">goto</span> <span class="n">usbhsf_pio_prepare_pop</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhsf_fifo_select</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">usbhsf_pio_prepare_pop</span><span class="p">;</span>

	<span class="cm">/* use PIO if packet is less than pio_dma_border */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">usbhsf_fifo_rcv_len</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="cm">/* 32bit alignment */</span>
		<span class="k">goto</span> <span class="n">usbhsf_pio_prepare_pop_unselect</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">usbhs_get_dparam</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">pio_dma_border</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">usbhsf_pio_prepare_pop_unselect</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhsf_fifo_barrier</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">usbhsf_pio_prepare_pop_unselect</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbhsf_dma_map</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">usbhsf_pio_prepare_pop_unselect</span><span class="p">;</span>

	<span class="cm">/* DMA */</span>

	<span class="cm">/*</span>
<span class="cm">	 * usbhs_fifo_dma_pop_handler :: prepare</span>
<span class="cm">	 * enabled irq to come here.</span>
<span class="cm">	 * but it is no longer needed for DMA. disable it.</span>
<span class="cm">	 */</span>
	<span class="n">usbhsf_rx_irq_ctrl</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">trans</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">xfer_work</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">usbhsf_pio_prepare_pop_unselect:</span>
	<span class="n">usbhsf_fifo_unselect</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
<span class="nl">usbhsf_pio_prepare_pop:</span>

	<span class="cm">/*</span>
<span class="cm">	 * change handler to PIO</span>
<span class="cm">	 */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usbhs_fifo_pio_pop_handler</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">try_run</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">is_done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_dma_pop_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxp</span> <span class="o">=</span> <span class="n">usbhs_pipe_get_maxpacket</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="n">usbhsf_dma_stop</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">);</span>
	<span class="n">usbhsf_dma_unmap</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
	<span class="n">usbhsf_fifo_unselect</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">);</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">+=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">actual</span> <span class="o">==</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">||</span>	<span class="cm">/* receive all data */</span>
	    <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">trans</span> <span class="o">&lt;</span> <span class="n">maxp</span><span class="p">))</span> <span class="p">{</span>		<span class="cm">/* short packet */</span>
		<span class="o">*</span><span class="n">is_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* re-enable */</span>
		<span class="n">usbhsf_prepare_pop</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">is_done</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">usbhs_pkt_handle</span> <span class="n">usbhs_fifo_dma_pop_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span>	<span class="o">=</span> <span class="n">usbhsf_prepare_pop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_run</span>	<span class="o">=</span> <span class="n">usbhsf_dma_try_pop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_done</span>	<span class="o">=</span> <span class="n">usbhsf_dma_pop_done</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *		DMA setting</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">usbhsf_dma_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_dmae_slave</span> <span class="o">*</span><span class="n">slave</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME</span>
<span class="cm">	 *</span>
<span class="cm">	 * usbhs doesn&#39;t recognize id = 0 as valid DMA</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">slave_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">slave</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbhsf_dma_quit</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">)</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">)</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">);</span>

	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_chan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">rx_chan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbhsf_dma_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">dma_cap_mask_t</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_chan</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">usbhsf_dma_filter</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_slave</span><span class="p">);</span>

	<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">rx_chan</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">usbhsf_dma_filter</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">rx_slave</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_chan</span> <span class="o">||</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enable DMAEngine (%s%s%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_chan</span> <span class="o">?</span> <span class="s">&quot;[TX]&quot;</span> <span class="o">:</span> <span class="s">&quot;    &quot;</span><span class="p">,</span>
			 <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">rx_chan</span> <span class="o">?</span> <span class="s">&quot;[RX]&quot;</span> <span class="o">:</span> <span class="s">&quot;    &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		irq functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_irq_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">usbhs_irq_state</span> <span class="o">*</span><span class="n">irq_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_state</span><span class="o">-&gt;</span><span class="n">bempsts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;debug %s !!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq empty [0x%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_state</span><span class="o">-&gt;</span><span class="n">bempsts</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * search interrupted &quot;pipe&quot;</span>
<span class="cm">	 * not &quot;uep&quot;.</span>
<span class="cm">	 */</span>
	<span class="n">usbhs_for_each_pipe_with_dcp</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irq_state</span><span class="o">-&gt;</span><span class="n">bempsts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhsf_pkt_handler</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">USBHSF_PKT_TRY_RUN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq_empty run_error %d : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbhsf_irq_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">usbhs_irq_state</span> <span class="o">*</span><span class="n">irq_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_state</span><span class="o">-&gt;</span><span class="n">brdysts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;debug %s !!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq ready [0x%04x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_state</span><span class="o">-&gt;</span><span class="n">brdysts</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * search interrupted &quot;pipe&quot;</span>
<span class="cm">	 * not &quot;uep&quot;.</span>
<span class="cm">	 */</span>
	<span class="n">usbhs_for_each_pipe_with_dcp</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irq_state</span><span class="o">-&gt;</span><span class="n">brdysts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhsf_pkt_handler</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">USBHSF_PKT_TRY_RUN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq_ready run_error %d : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbhsf_dma_complete</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_pipe</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbhs_pipe_to_priv</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbhs_priv_to_dev</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbhsf_pkt_handler</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">USBHSF_PKT_DMA_DONE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dma_complete run_error %d : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">usbhs_pipe_number</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *		fifo init</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">usbhs_fifo_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_mod</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">usbhs_mod_get_current</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">cfifo</span> <span class="o">=</span> <span class="n">usbhsf_get_cfifo</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">d0fifo</span> <span class="o">=</span> <span class="n">usbhsf_get_d0fifo</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">d1fifo</span> <span class="o">=</span> <span class="n">usbhsf_get_d1fifo</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">irq_empty</span>		<span class="o">=</span> <span class="n">usbhsf_irq_empty</span><span class="p">;</span>
	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">irq_ready</span>		<span class="o">=</span> <span class="n">usbhsf_irq_ready</span><span class="p">;</span>
	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">irq_bempsts</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">irq_brdysts</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cfifo</span><span class="o">-&gt;</span><span class="n">pipe</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cfifo</span><span class="o">-&gt;</span><span class="n">tx_chan</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cfifo</span><span class="o">-&gt;</span><span class="n">rx_chan</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">d0fifo</span><span class="o">-&gt;</span><span class="n">pipe</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">d0fifo</span><span class="o">-&gt;</span><span class="n">tx_chan</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">d0fifo</span><span class="o">-&gt;</span><span class="n">rx_chan</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">d1fifo</span><span class="o">-&gt;</span><span class="n">pipe</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">d1fifo</span><span class="o">-&gt;</span><span class="n">tx_chan</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">d1fifo</span><span class="o">-&gt;</span><span class="n">rx_chan</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">usbhsf_dma_init</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">usbhsf_get_d0fifo</span><span class="p">(</span><span class="n">priv</span><span class="p">));</span>
	<span class="n">usbhsf_dma_init</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">usbhsf_get_d1fifo</span><span class="p">(</span><span class="n">priv</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usbhs_fifo_quit</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_mod</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="n">usbhs_mod_get_current</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">irq_empty</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">irq_ready</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">irq_bempsts</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">irq_brdysts</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">usbhsf_dma_quit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">usbhsf_get_d0fifo</span><span class="p">(</span><span class="n">priv</span><span class="p">));</span>
	<span class="n">usbhsf_dma_quit</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">usbhsf_get_d1fifo</span><span class="p">(</span><span class="n">priv</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">usbhs_fifo_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbhs_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">;</span>

	<span class="cm">/* CFIFO */</span>
	<span class="n">fifo</span> <span class="o">=</span> <span class="n">usbhsf_get_cfifo</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;CFIFO&quot;</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">port</span>	<span class="o">=</span> <span class="n">CFIFO</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">sel</span>	<span class="o">=</span> <span class="n">CFIFOSEL</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ctr</span>	<span class="o">=</span> <span class="n">CFIFOCTR</span><span class="p">;</span>

	<span class="cm">/* D0FIFO */</span>
	<span class="n">fifo</span> <span class="o">=</span> <span class="n">usbhsf_get_d0fifo</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;D0FIFO&quot;</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">port</span>	<span class="o">=</span> <span class="n">D0FIFO</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">sel</span>	<span class="o">=</span> <span class="n">D0FIFOSEL</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ctr</span>	<span class="o">=</span> <span class="n">D0FIFOCTR</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_slave</span><span class="p">.</span><span class="n">slave_id</span>	<span class="o">=</span> <span class="n">usbhs_get_dparam</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">d0_tx_id</span><span class="p">);</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">rx_slave</span><span class="p">.</span><span class="n">slave_id</span>	<span class="o">=</span> <span class="n">usbhs_get_dparam</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">d0_rx_id</span><span class="p">);</span>

	<span class="cm">/* D1FIFO */</span>
	<span class="n">fifo</span> <span class="o">=</span> <span class="n">usbhsf_get_d1fifo</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;D1FIFO&quot;</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">port</span>	<span class="o">=</span> <span class="n">D1FIFO</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">sel</span>	<span class="o">=</span> <span class="n">D1FIFOSEL</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ctr</span>	<span class="o">=</span> <span class="n">D1FIFOCTR</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_slave</span><span class="p">.</span><span class="n">slave_id</span>	<span class="o">=</span> <span class="n">usbhs_get_dparam</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">d1_tx_id</span><span class="p">);</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">rx_slave</span><span class="p">.</span><span class="n">slave_id</span>	<span class="o">=</span> <span class="n">usbhs_get_dparam</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">d1_rx_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usbhs_fifo_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbhs_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
