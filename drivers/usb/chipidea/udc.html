<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › chipidea › udc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>udc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * udc.c - ChipIdea UDC driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Chipidea - MIPS Technologies, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: David Lopo</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/dmapool.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>
<span class="cp">#include &lt;linux/usb/otg.h&gt;</span>
<span class="cp">#include &lt;linux/usb/chipidea.h&gt;</span>

<span class="cp">#include &quot;ci.h&quot;</span>
<span class="cp">#include &quot;udc.h&quot;</span>
<span class="cp">#include &quot;bits.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>

<span class="cm">/* control endpoint description */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span>
<span class="n">ctrl_endpt_out_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span>         <span class="o">=</span> <span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span>    <span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wMaxPacketSize</span>  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CTRL_PAYLOAD_MAX</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span>
<span class="n">ctrl_endpt_in_desc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bLength</span>         <span class="o">=</span> <span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">,</span>

	<span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmAttributes</span>    <span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wMaxPacketSize</span>  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CTRL_PAYLOAD_MAX</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * hw_ep_bit: calculates the bit number</span>
<span class="cm"> * @num: endpoint number</span>
<span class="cm"> * @dir: endpoint direction</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns bit number</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hw_ep_bit</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">num</span> <span class="o">+</span> <span class="p">(</span><span class="n">dir</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ep_to_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fill</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">hw_ep_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">hw_ep_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">+=</span> <span class="n">fill</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_device_state: enables/disables interrupts &amp; starts/stops device (execute</span>
<span class="cm"> *                  without interruption)</span>
<span class="cm"> * @dma: 0 =&gt; disable, !0 =&gt; enable and set dma engine</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_device_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTLISTADDR</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
		<span class="cm">/* interrupt, error, port change, reset, sleep/suspend */</span>
		<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_USBINTR</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span>
			     <span class="n">USBi_UI</span><span class="o">|</span><span class="n">USBi_UEI</span><span class="o">|</span><span class="n">USBi_PCI</span><span class="o">|</span><span class="n">USBi_URI</span><span class="o">|</span><span class="n">USBi_SLI</span><span class="p">);</span>
		<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_USBCMD</span><span class="p">,</span> <span class="n">USBCMD_RS</span><span class="p">,</span> <span class="n">USBCMD_RS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_USBCMD</span><span class="p">,</span> <span class="n">USBCMD_RS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_USBINTR</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_ep_flush: flush endpoint fifo (execute without interruption)</span>
<span class="cm"> * @num: endpoint number</span>
<span class="cm"> * @dir: endpoint direction</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_ep_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">hw_ep_bit</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* flush any pending transfer */</span>
		<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTFLUSH</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">BIT</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTFLUSH</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTSTAT</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="n">n</span><span class="p">)));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_ep_disable: disables endpoint (execute without interruption)</span>
<span class="cm"> * @num: endpoint number</span>
<span class="cm"> * @dir: endpoint direction</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_ep_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw_ep_flush</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTCTRL</span> <span class="o">+</span> <span class="n">num</span><span class="p">,</span>
		 <span class="n">dir</span> <span class="o">?</span> <span class="n">ENDPTCTRL_TXE</span> <span class="o">:</span> <span class="n">ENDPTCTRL_RXE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_ep_enable: enables endpoint (execute without interruption)</span>
<span class="cm"> * @num:  endpoint number</span>
<span class="cm"> * @dir:  endpoint direction</span>
<span class="cm"> * @type: endpoint type</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_ep_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span>  <span class="o">=</span> <span class="n">ENDPTCTRL_TXT</span><span class="p">;</span>  <span class="cm">/* type    */</span>
		<span class="n">data</span>  <span class="o">=</span> <span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="n">ffs_nr</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>

		<span class="n">mask</span> <span class="o">|=</span> <span class="n">ENDPTCTRL_TXS</span><span class="p">;</span>  <span class="cm">/* unstall */</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">ENDPTCTRL_TXR</span><span class="p">;</span>  <span class="cm">/* reset data toggle */</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">ENDPTCTRL_TXR</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">ENDPTCTRL_TXE</span><span class="p">;</span>  <span class="cm">/* enable  */</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">ENDPTCTRL_TXE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mask</span>  <span class="o">=</span> <span class="n">ENDPTCTRL_RXT</span><span class="p">;</span>  <span class="cm">/* type    */</span>
		<span class="n">data</span>  <span class="o">=</span> <span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="n">ffs_nr</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>

		<span class="n">mask</span> <span class="o">|=</span> <span class="n">ENDPTCTRL_RXS</span><span class="p">;</span>  <span class="cm">/* unstall */</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">ENDPTCTRL_RXR</span><span class="p">;</span>  <span class="cm">/* reset data toggle */</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">ENDPTCTRL_RXR</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">ENDPTCTRL_RXE</span><span class="p">;</span>  <span class="cm">/* enable  */</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">ENDPTCTRL_RXE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTCTRL</span> <span class="o">+</span> <span class="n">num</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_ep_get_halt: return endpoint halt status</span>
<span class="cm"> * @num: endpoint number</span>
<span class="cm"> * @dir: endpoint direction</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns 1 if endpoint halted</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_ep_get_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">?</span> <span class="n">ENDPTCTRL_TXS</span> <span class="o">:</span> <span class="n">ENDPTCTRL_RXS</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTCTRL</span> <span class="o">+</span> <span class="n">num</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_test_and_clear_setup_status: test &amp; clear setup status (execute without</span>
<span class="cm"> *                                 interruption)</span>
<span class="cm"> * @n: endpoint number</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns setup status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_test_and_clear_setup_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">ep_to_bit</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hw_test_and_clear</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTSETUPSTAT</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_ep_prime: primes endpoint (execute without interruption)</span>
<span class="cm"> * @num:     endpoint number</span>
<span class="cm"> * @dir:     endpoint direction</span>
<span class="cm"> * @is_ctrl: true if control endpoint</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_ep_prime</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">hw_ep_bit</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ctrl</span> <span class="o">&amp;&amp;</span> <span class="n">dir</span> <span class="o">==</span> <span class="n">RX</span> <span class="o">&amp;&amp;</span> <span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTSETUPSTAT</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="n">num</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTPRIME</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">BIT</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTPRIME</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_ctrl</span> <span class="o">&amp;&amp;</span> <span class="n">dir</span> <span class="o">==</span> <span class="n">RX</span> <span class="o">&amp;&amp;</span> <span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTSETUPSTAT</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="n">num</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="cm">/* status shoult be tested according with manual but it doesn&#39;t work */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_ep_set_halt: configures ep halt &amp; resets data toggle after clear (execute</span>
<span class="cm"> *                 without interruption)</span>
<span class="cm"> * @num:   endpoint number</span>
<span class="cm"> * @dir:   endpoint direction</span>
<span class="cm"> * @value: true =&gt; stall, false =&gt; unstall</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_ep_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">ci13xxx_regs</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">OP_ENDPTCTRL</span> <span class="o">+</span> <span class="n">num</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">mask_xs</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">?</span> <span class="n">ENDPTCTRL_TXS</span> <span class="o">:</span> <span class="n">ENDPTCTRL_RXS</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">mask_xr</span> <span class="o">=</span> <span class="n">dir</span> <span class="o">?</span> <span class="n">ENDPTCTRL_TXR</span> <span class="o">:</span> <span class="n">ENDPTCTRL_RXR</span><span class="p">;</span>

		<span class="cm">/* data toggle - reserved for EP0 but it&#39;s in ESS */</span>
		<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mask_xs</span><span class="o">|</span><span class="n">mask_xr</span><span class="p">,</span>
			  <span class="n">value</span> <span class="o">?</span> <span class="n">mask_xs</span> <span class="o">:</span> <span class="n">mask_xr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">hw_ep_get_halt</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">dir</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_is_port_high_speed: test if port is high speed</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns true if high speed port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_port_is_high_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">lpm</span> <span class="o">?</span> <span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_DEVLC</span><span class="p">,</span> <span class="n">DEVLC_PSPD</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_PORTSC</span><span class="p">,</span> <span class="n">PORTSC_HSP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_read_intr_enable: returns interrupt enable register</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns register data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">hw_read_intr_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_USBINTR</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_read_intr_status: returns interrupt status register</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns register data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">hw_read_intr_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_USBSTS</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_test_and_clear_complete: test &amp; clear complete status (execute without</span>
<span class="cm"> *                             interruption)</span>
<span class="cm"> * @n: endpoint number</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns complete status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_test_and_clear_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">ep_to_bit</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hw_test_and_clear</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTCOMPLETE</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_test_and_clear_intr_active: test &amp; clear active interrupts (execute</span>
<span class="cm"> *                                without interruption)</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns active interrutps</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">hw_test_and_clear_intr_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">hw_read_intr_status</span><span class="p">(</span><span class="n">udc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">hw_read_intr_enable</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>

	<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_USBSTS</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_test_and_clear_setup_guard: test &amp; clear setup guard (execute without</span>
<span class="cm"> *                                interruption)</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns guard value</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_test_and_clear_setup_guard</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw_test_and_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_USBCMD</span><span class="p">,</span> <span class="n">USBCMD_SUTW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_test_and_set_setup_guard: test &amp; set setup guard (execute without</span>
<span class="cm"> *                              interruption)</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns guard value</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_test_and_set_setup_guard</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw_test_and_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_USBCMD</span><span class="p">,</span> <span class="n">USBCMD_SUTW</span><span class="p">,</span> <span class="n">USBCMD_SUTW</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_usb_set_address: configures USB address (execute without interruption)</span>
<span class="cm"> * @value: new USB address</span>
<span class="cm"> *</span>
<span class="cm"> * This function explicitly sets the address, without the &quot;USBADRA&quot; (advance)</span>
<span class="cm"> * feature, which is not supported by older versions of the controller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_usb_set_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_DEVICEADDR</span><span class="p">,</span> <span class="n">DEVICEADDR_USBADR</span><span class="p">,</span>
		 <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">ffs_nr</span><span class="p">(</span><span class="n">DEVICEADDR_USBADR</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_usb_reset: restart device after a bus reset (execute without</span>
<span class="cm"> *               interruption)</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_usb_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw_usb_set_address</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* ESS flushes only at end?!? */</span>
	<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTFLUSH</span><span class="p">,</span>    <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* clear setup token semaphores */</span>
	<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTSETUPSTAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* clear complete status */</span>
	<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTCOMPLETE</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* wait until all bits cleared */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTPRIME</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>             <span class="cm">/* not RTOS friendly */</span>

	<span class="cm">/* reset all endpoints ? */</span>

	<span class="cm">/* reset internal status and wait for further instructions</span>
<span class="cm">	   no need to verify the port reset status (ESS does it) */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * UTIL block</span>
<span class="cm"> *****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm"> * _usb_addr: calculates endpoint address from direction &amp; number</span>
<span class="cm"> * @ep:  endpoint</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">_usb_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">TX</span><span class="p">)</span> <span class="o">?</span> <span class="n">USB_ENDPOINT_DIR_MASK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _hardware_queue: configures a request at hardware level</span>
<span class="cm"> * @gadget: gadget</span>
<span class="cm"> * @mEp:    endpoint</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_hardware_enqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">mEp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx_req</span> <span class="o">*</span><span class="n">mReq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">length</span> <span class="o">=</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

	<span class="cm">/* don&#39;t queue twice */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>

	<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">zero</span> <span class="o">&amp;&amp;</span> <span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">length</span> <span class="o">%</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">zptr</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">td_pool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">zdma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">zptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">zptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">zptr</span><span class="p">));</span>
		<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">zptr</span><span class="o">-&gt;</span><span class="n">next</span>    <span class="o">=</span> <span class="n">TD_TERMINATE</span><span class="p">;</span>
		<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">zptr</span><span class="o">-&gt;</span><span class="n">token</span>   <span class="o">=</span> <span class="n">TD_STATUS_ACTIVE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">no_interrupt</span><span class="p">)</span>
			<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">zptr</span><span class="o">-&gt;</span><span class="n">token</span>   <span class="o">|=</span> <span class="n">TD_IOC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_gadget_map_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * TD configuration</span>
<span class="cm">	 * TODO - handle requests which spawns into several TDs</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">));</span>
	<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">token</span>    <span class="o">=</span> <span class="n">length</span> <span class="o">&lt;&lt;</span> <span class="n">ffs_nr</span><span class="p">(</span><span class="n">TD_TOTAL_BYTES</span><span class="p">);</span>
	<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">token</span>   <span class="o">&amp;=</span> <span class="n">TD_TOTAL_BYTES</span><span class="p">;</span>
	<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">token</span>   <span class="o">|=</span> <span class="n">TD_STATUS_ACTIVE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">zptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span>    <span class="o">=</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">zdma</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span>    <span class="o">=</span> <span class="n">TD_TERMINATE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">no_interrupt</span><span class="p">)</span>
			<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">token</span>  <span class="o">|=</span> <span class="n">TD_IOC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">dma</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">CI13XXX_PAGE_SIZE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TD_RESERVED_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ci13xxx_req</span> <span class="o">*</span><span class="n">mReqPrev</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">hw_ep_bit</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">tmp_stat</span><span class="p">;</span>

		<span class="n">mReqPrev</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ci13xxx_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mReqPrev</span><span class="o">-&gt;</span><span class="n">zptr</span><span class="p">)</span>
			<span class="n">mReqPrev</span><span class="o">-&gt;</span><span class="n">zptr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&amp;</span> <span class="n">TD_ADDR_MASK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mReqPrev</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&amp;</span> <span class="n">TD_ADDR_MASK</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTPRIME</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_USBCMD</span><span class="p">,</span> <span class="n">USBCMD_ATDTW</span><span class="p">,</span> <span class="n">USBCMD_ATDTW</span><span class="p">);</span>
			<span class="n">tmp_stat</span> <span class="o">=</span> <span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_ENDPTSTAT</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_USBCMD</span><span class="p">,</span> <span class="n">USBCMD_ATDTW</span><span class="p">));</span>
		<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_USBCMD</span><span class="p">,</span> <span class="n">USBCMD_ATDTW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_stat</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  QH configuration */</span>
	<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">td</span><span class="p">.</span><span class="n">next</span>   <span class="o">=</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>    <span class="cm">/* TERMINATE = 0 */</span>
	<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">td</span><span class="p">.</span><span class="n">token</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TD_STATUS</span><span class="p">;</span>   <span class="cm">/* clear status */</span>
	<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">|=</span>  <span class="n">QH_ZLT</span><span class="p">;</span>

	<span class="n">wmb</span><span class="p">();</span>   <span class="cm">/* synchronize before ep prime */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hw_ep_prime</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span>
			   <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _hardware_dequeue: handles a request at hardware level</span>
<span class="cm"> * @gadget: gadget</span>
<span class="cm"> * @mEp:    endpoint</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_hardware_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">mEp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx_req</span> <span class="o">*</span><span class="n">mReq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">TD_STATUS_ACTIVE</span> <span class="o">&amp;</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">zptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">TD_STATUS_ACTIVE</span> <span class="o">&amp;</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">zptr</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">td_pool</span><span class="p">,</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">zptr</span><span class="p">,</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">zdma</span><span class="p">);</span>
		<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">zptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">usb_gadget_unmap_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>

	<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">&amp;</span> <span class="n">TD_STATUS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">TD_STATUS_HALTED</span> <span class="o">&amp;</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">TD_STATUS_DT_ERR</span> <span class="o">&amp;</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">TD_STATUS_TR_ERR</span> <span class="o">&amp;</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span>   <span class="o">=</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">&amp;</span> <span class="n">TD_TOTAL_BYTES</span><span class="p">;</span>
	<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">&gt;&gt;=</span> <span class="n">ffs_nr</span><span class="p">(</span><span class="n">TD_TOTAL_BYTES</span><span class="p">);</span>
	<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span>   <span class="o">=</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
	<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span>   <span class="o">=</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _ep_nuke: dequeues all endpoint requests</span>
<span class="cm"> * @mEp: endpoint</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> * Caller must hold lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_ep_nuke</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">mEp</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mEp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">hw_ep_flush</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* pop oldest request */</span>
		<span class="k">struct</span> <span class="n">ci13xxx_req</span> <span class="o">*</span><span class="n">mReq</span> <span class="o">=</span> \
			<span class="n">list_entry</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ci13xxx_req</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _gadget_stop_activity: stops all USB activity, flushes &amp; disables all endpts</span>
<span class="cm"> * @gadget: gadget</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_gadget_stop_activity</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ci13xxx</span>    <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">remote_wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* flush all endpoints */</span>
	<span class="n">gadget_for_each_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">gadget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_ep_fifo_flush</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">usb_ep_fifo_flush</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0out</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">);</span>
	<span class="n">usb_ep_fifo_flush</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0in</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="n">gadget</span><span class="p">);</span>

	<span class="cm">/* make sure to disable all endpoints */</span>
	<span class="n">gadget_for_each_ep</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">gadget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_ep_disable</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0in</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * ISR block</span>
<span class="cm"> *****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm"> * isr_reset_handler: USB reset interrupt handler</span>
<span class="cm"> * @udc: UDC device</span>
<span class="cm"> *</span>
<span class="cm"> * This function resets USB engine after a bus reset occurred</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_reset_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">dbg_event</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="s">&quot;BUS RST&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">_gadget_stop_activity</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">hw_usb_reset</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">usb_ep_alloc_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0in</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * isr_get_status_complete: get_status request complete function</span>
<span class="cm"> * @ep:  endpoint</span>
<span class="cm"> * @req: request handled</span>
<span class="cm"> *</span>
<span class="cm"> * Caller must release lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_get_status_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * isr_get_status_response: get_status request response</span>
<span class="cm"> * @udc: udc struct</span>
<span class="cm"> * @setup: setup request packet</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isr_get_status_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="o">*</span><span class="n">setup</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">mEp</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0in</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">gfp_t</span> <span class="n">gfp_flags</span> <span class="o">=</span> <span class="n">GFP_ATOMIC</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mEp</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">setup</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">usb_ep_alloc_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">isr_get_status_complete</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span>      <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_req</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_RECIP_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Assume that device is bus powered for now. */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">remote_wakeup</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_RECIP_MASK</span><span class="p">)</span> \
		   <span class="o">==</span> <span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_DIR_MASK</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">TX</span> <span class="o">:</span> <span class="n">RX</span><span class="p">;</span>
		<span class="n">num</span> <span class="o">=</span>  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">wIndex</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">hw_ep_get_halt</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* else do nothing; reserved for future use */</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_buf</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_free_buf:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
 <span class="nl">err_free_req:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">usb_ep_free_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * isr_setup_status_complete: setup_status request complete function</span>
<span class="cm"> * @ep:  endpoint</span>
<span class="cm"> * @req: request handled</span>
<span class="cm"> *</span>
<span class="cm"> * Caller must release lock. Put the port in test mode if test mode</span>
<span class="cm"> * feature is selected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isr_setup_status_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">setaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_usb_set_address</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">setaddr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">test_mode</span><span class="p">)</span>
		<span class="n">hw_port_test_set</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">test_mode</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * isr_setup_status_phase: queues the status phase of a setup transation</span>
<span class="cm"> * @udc: udc struct</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isr_setup_status_phase</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">mEp</span><span class="p">;</span>

	<span class="n">mEp</span> <span class="o">=</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">==</span> <span class="n">TX</span><span class="p">)</span> <span class="o">?</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0out</span> <span class="o">:</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0in</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">udc</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">isr_setup_status_complete</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * isr_tr_complete_low: transaction complete low level handler</span>
<span class="cm"> * @mEp: endpoint</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> * Caller must hold lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isr_tr_complete_low</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">mEp</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx_req</span> <span class="o">*</span><span class="n">mReq</span><span class="p">,</span> <span class="o">*</span><span class="n">mReqTemp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">mEpTemp</span> <span class="o">=</span> <span class="n">mEp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mReq</span><span class="p">,</span> <span class="n">mReqTemp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span>
			<span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">_hardware_dequeue</span><span class="p">(</span><span class="n">mEp</span><span class="p">,</span> <span class="n">mReq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">dbg_done</span><span class="p">(</span><span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">),</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
				<span class="n">mEpTemp</span> <span class="o">=</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0in</span><span class="p">;</span>
			<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEpTemp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dbg_event</span><span class="p">(</span><span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">),</span> <span class="s">&quot;DONE&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * isr_tr_complete_handler: transaction complete interrupt handler</span>
<span class="cm"> * @udc: UDC descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * This function handles traffic events</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isr_tr_complete_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="n">__releases</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="n">__acquires</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">hw_ep_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">mEp</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ci13xxx_ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="n">req</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>   <span class="cm">/* not configured */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw_test_and_clear_complete</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">isr_tr_complete_low</span><span class="p">(</span><span class="n">mEp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>   <span class="cm">/* needs status phase */</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">isr_setup_status_phase</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dbg_event</span><span class="p">(</span><span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">),</span>
						  <span class="s">&quot;ERROR&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">usb_ep_set_halt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">))</span>
						<span class="n">dev_err</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							<span class="s">&quot;error: ep_set_halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">hw_test_and_clear_setup_status</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ctrl traffic at endpoint %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Flush data and handshake transactions of previous</span>
<span class="cm">		 * setup packet.</span>
<span class="cm">		 */</span>
		<span class="n">_ep_nuke</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0out</span><span class="p">);</span>
		<span class="n">_ep_nuke</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0in</span><span class="p">);</span>

		<span class="cm">/* read_setup_packet */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">hw_test_and_set_setup_guard</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">hw_test_and_clear_setup_guard</span><span class="p">(</span><span class="n">udc</span><span class="p">));</span>

		<span class="n">type</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">bRequestType</span><span class="p">;</span>

		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="o">?</span> <span class="n">TX</span> <span class="o">:</span> <span class="n">RX</span><span class="p">;</span>

		<span class="n">dbg_setup</span><span class="p">(</span><span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">bRequest</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_REQ_CLEAR_FEATURE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="p">(</span><span class="n">USB_DIR_OUT</span><span class="o">|</span><span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wValue</span><span class="p">)</span> <span class="o">==</span>
					<span class="n">USB_ENDPOINT_HALT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">num</span>  <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wIndex</span><span class="p">);</span>
				<span class="n">dir</span> <span class="o">=</span> <span class="n">num</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_DIR_MASK</span><span class="p">;</span>
				<span class="n">num</span> <span class="o">&amp;=</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="cm">/* TX */</span>
					<span class="n">num</span> <span class="o">+=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">hw_ep_max</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ci13xxx_ep</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">wedge</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">usb_ep_clear_halt</span><span class="p">(</span>
						<span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ci13xxx_ep</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">ep</span><span class="p">);</span>
					<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">isr_setup_status_phase</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="p">(</span><span class="n">USB_DIR_OUT</span><span class="o">|</span><span class="n">USB_RECIP_DEVICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wValue</span><span class="p">)</span> <span class="o">==</span>
					<span class="n">USB_DEVICE_REMOTE_WAKEUP</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">remote_wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">isr_setup_status_phase</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_REQ_GET_STATUS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="p">(</span><span class="n">USB_DIR_IN</span><span class="o">|</span><span class="n">USB_RECIP_DEVICE</span><span class="p">)</span>   <span class="o">&amp;&amp;</span>
			    <span class="n">type</span> <span class="o">!=</span> <span class="p">(</span><span class="n">USB_DIR_IN</span><span class="o">|</span><span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">type</span> <span class="o">!=</span> <span class="p">(</span><span class="n">USB_DIR_IN</span><span class="o">|</span><span class="n">USB_RECIP_INTERFACE</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wLength</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">||</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wValue</span><span class="p">)</span>  <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">isr_get_status_response</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_REQ_SET_ADDRESS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="p">(</span><span class="n">USB_DIR_OUT</span><span class="o">|</span><span class="n">USB_RECIP_DEVICE</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wLength</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wIndex</span><span class="p">)</span>  <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wValue</span><span class="p">);</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">setaddr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">isr_setup_status_phase</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_REQ_SET_FEATURE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="p">(</span><span class="n">USB_DIR_OUT</span><span class="o">|</span><span class="n">USB_RECIP_ENDPOINT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wValue</span><span class="p">)</span> <span class="o">==</span>
					<span class="n">USB_ENDPOINT_HALT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">num</span>  <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wIndex</span><span class="p">);</span>
				<span class="n">dir</span> <span class="o">=</span> <span class="n">num</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_DIR_MASK</span><span class="p">;</span>
				<span class="n">num</span> <span class="o">&amp;=</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="cm">/* TX */</span>
					<span class="n">num</span> <span class="o">+=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">hw_ep_max</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">usb_ep_set_halt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ci13xxx_ep</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">ep</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
					<span class="n">isr_setup_status_phase</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="p">(</span><span class="n">USB_DIR_OUT</span><span class="o">|</span><span class="n">USB_RECIP_DEVICE</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wValue</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">USB_DEVICE_REMOTE_WAKEUP</span>:
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">remote_wakeup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">isr_setup_status_phase</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">USB_DEVICE_TEST_MODE</span>:
					<span class="n">tmode</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wIndex</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">tmode</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">TEST_J</span>:
					<span class="k">case</span> <span class="n">TEST_K</span>:
					<span class="k">case</span> <span class="n">TEST_SE0_NAK</span>:
					<span class="k">case</span> <span class="n">TEST_PACKET</span>:
					<span class="k">case</span> <span class="n">TEST_FORCE_EN</span>:
						<span class="n">udc</span><span class="o">-&gt;</span><span class="n">test_mode</span> <span class="o">=</span> <span class="n">tmode</span><span class="p">;</span>
						<span class="n">err</span> <span class="o">=</span> <span class="n">isr_setup_status_phase</span><span class="p">(</span>
								<span class="n">udc</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="nl">default:</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="nl">default:</span>
					<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">delegate</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
<span class="nl">delegate:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">wLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>   <span class="cm">/* no data phase */</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">=</span> <span class="n">TX</span><span class="p">;</span>

			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg_event</span><span class="p">(</span><span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">),</span> <span class="s">&quot;ERROR&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">usb_ep_set_halt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">))</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error: ep_set_halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * ENDPT block</span>
<span class="cm"> *****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm"> * ep_enable: configure endpoint, making it usable</span>
<span class="cm"> *</span>
<span class="cm"> * Check usb_ep_enable() at &quot;usb_gadget.h&quot; for details</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
		     <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">mEp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* only internal SW should enable ctrl endpts */</span>

	<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enabling a non-empty endpoint!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span>  <span class="o">=</span> <span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">?</span> <span class="n">TX</span> <span class="o">:</span> <span class="n">RX</span><span class="p">;</span>
	<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">num</span>  <span class="o">=</span> <span class="n">usb_endpoint_num</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">usb_endpoint_type</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">usb_endpoint_maxp</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">dbg_event</span><span class="p">(</span><span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">),</span> <span class="s">&quot;ENABLE&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span><span class="p">)</span>
		<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">|=</span>  <span class="n">QH_IOS</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span><span class="p">)</span>
		<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QH_MULT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QH_ZLT</span><span class="p">;</span>

	<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">|=</span>
		<span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">&lt;&lt;</span> <span class="n">ffs_nr</span><span class="p">(</span><span class="n">QH_MAX_PKT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">QH_MAX_PKT</span><span class="p">;</span>
	<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">td</span><span class="p">.</span><span class="n">next</span> <span class="o">|=</span> <span class="n">TD_TERMINATE</span><span class="p">;</span>   <span class="cm">/* needed? */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable endpoints in the HW other than ep0 as ep0</span>
<span class="cm">	 * is always enabled</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">hw_ep_enable</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep_disable: endpoint is no longer usable</span>
<span class="cm"> *</span>
<span class="cm"> * Check usb_ep_disable() at &quot;usb_gadget.h&quot; for details</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">mEp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">direction</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* only internal SW should disable ctrl endpts */</span>

	<span class="n">direction</span> <span class="o">=</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">dbg_event</span><span class="p">(</span><span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">),</span> <span class="s">&quot;DISABLE&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">|=</span> <span class="n">_ep_nuke</span><span class="p">(</span><span class="n">mEp</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">hw_ep_disable</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span><span class="p">)</span>
			<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">TX</span><span class="p">)</span> <span class="o">?</span> <span class="n">RX</span> <span class="o">:</span> <span class="n">TX</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">direction</span><span class="p">);</span>

	<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep_alloc_request: allocate a request object to use with this endpoint</span>
<span class="cm"> *</span>
<span class="cm"> * Check usb_ep_alloc_request() at &quot;usb_gadget.h&quot; for details</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="nf">ep_alloc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx_ep</span>  <span class="o">*</span><span class="n">mEp</span>  <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ci13xxx_req</span> <span class="o">*</span><span class="n">mReq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mReq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx_req</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mReq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

		<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">td_pool</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mReq</span><span class="p">);</span>
			<span class="n">mReq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dbg_event</span><span class="p">(</span><span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">),</span> <span class="s">&quot;ALLOC&quot;</span><span class="p">,</span> <span class="n">mReq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">mReq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep_free_request: frees a request object</span>
<span class="cm"> *</span>
<span class="cm"> * Check usb_ep_free_request() at &quot;usb_gadget.h&quot; for details</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_free_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx_ep</span>  <span class="o">*</span><span class="n">mEp</span>  <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">ci13xxx_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ci13xxx_req</span> <span class="o">*</span><span class="n">mReq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx_req</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;freeing queued request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">)</span>
		<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">td_pool</span><span class="p">,</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mReq</span><span class="p">);</span>

	<span class="n">dbg_event</span><span class="p">(</span><span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">),</span> <span class="s">&quot;FREE&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep_queue: queues (submits) an I/O request to an endpoint</span>
<span class="cm"> *</span>
<span class="cm"> * Check usb_ep_queue()* at usb_gadget.h&quot; for details</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
		    <span class="n">gfp_t</span> <span class="n">__maybe_unused</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx_ep</span>  <span class="o">*</span><span class="n">mEp</span>  <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">ci13xxx_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ci13xxx_req</span> <span class="o">*</span><span class="n">mReq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx_req</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
			<span class="n">mEp</span> <span class="o">=</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0_dir</span> <span class="o">==</span> <span class="n">RX</span><span class="p">)</span> <span class="o">?</span>
			       <span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0out</span> <span class="o">:</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0in</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">_ep_nuke</span><span class="p">(</span><span class="n">mEp</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;endpoint ctrl %X nuked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* first nuke then test link, e.g. previous status has not sent */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request already in queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">CI13XXX_PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">CI13XXX_PAGE_SIZE</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request length truncated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dbg_queue</span><span class="p">(</span><span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">),</span> <span class="n">req</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>

	<span class="cm">/* push request */</span>
	<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">_hardware_enqueue</span><span class="p">(</span><span class="n">mEp</span><span class="p">,</span> <span class="n">mReq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg_event</span><span class="p">(</span><span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">),</span> <span class="s">&quot;QUEUE&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>

 <span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep_dequeue: dequeues (cancels, unlinks) an I/O request from an endpoint</span>
<span class="cm"> *</span>
<span class="cm"> * Check usb_ep_dequeue() at &quot;usb_gadget.h&quot; for details</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx_ep</span>  <span class="o">*</span><span class="n">mEp</span>  <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">ci13xxx_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ci13xxx_req</span> <span class="o">*</span><span class="n">mReq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx_req</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EALREADY</span> <span class="o">||</span>
		<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbg_event</span><span class="p">(</span><span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">),</span> <span class="s">&quot;DEQUEUE&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hw_ep_flush</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>

	<span class="cm">/* pop request */</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">usb_gadget_unmap_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mReq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep_set_halt: sets the endpoint halt feature</span>
<span class="cm"> *</span>
<span class="cm"> * Check usb_ep_set_halt() at &quot;usb_gadget.h&quot; for details</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_set_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">mEp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">direction</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifndef STALL_IN</span>
	<span class="cm">/* g_file_storage MS compliant but g_zero fails chapter 9 compliance */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_BULK</span> <span class="o">&amp;&amp;</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">TX</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">direction</span> <span class="o">=</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">dbg_event</span><span class="p">(</span><span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">),</span> <span class="s">&quot;HALT&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">hw_ep_set_halt</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span>
			<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">wedge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_CONTROL</span><span class="p">)</span>
			<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">TX</span><span class="p">)</span> <span class="o">?</span> <span class="n">RX</span> <span class="o">:</span> <span class="n">TX</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">!=</span> <span class="n">direction</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep_set_wedge: sets the halt feature and ignores clear requests</span>
<span class="cm"> *</span>
<span class="cm"> * Check usb_ep_set_wedge() at &quot;usb_gadget.h&quot; for details</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_set_wedge</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">mEp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbg_event</span><span class="p">(</span><span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">),</span> <span class="s">&quot;WEDGE&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">wedge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">usb_ep_set_halt</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ep_fifo_flush: flushes contents of a fifo</span>
<span class="cm"> *</span>
<span class="cm"> * Check usb_ep_fifo_flush() at &quot;usb_gadget.h&quot; for details</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_fifo_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_ep</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">mEp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx_ep</span><span class="p">,</span> <span class="n">ep</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%02X: -EINVAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbg_event</span><span class="p">(</span><span class="n">_usb_addr</span><span class="p">(</span><span class="n">mEp</span><span class="p">),</span> <span class="s">&quot;FFLUSH&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hw_ep_flush</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Endpoint-specific part of the API to the USB controller hardware</span>
<span class="cm"> * Check &quot;usb_gadget.h&quot; for details</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_ep_ops</span> <span class="n">usb_ep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>	       <span class="o">=</span> <span class="n">ep_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span>       <span class="o">=</span> <span class="n">ep_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_request</span> <span class="o">=</span> <span class="n">ep_alloc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_request</span>  <span class="o">=</span> <span class="n">ep_free_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queue</span>	       <span class="o">=</span> <span class="n">ep_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dequeue</span>       <span class="o">=</span> <span class="n">ep_dequeue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_halt</span>      <span class="o">=</span> <span class="n">ep_set_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wedge</span>     <span class="o">=</span> <span class="n">ep_set_wedge</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_flush</span>    <span class="o">=</span> <span class="n">ep_fifo_flush</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * GADGET block</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ci13xxx_vbus_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gadget_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CI13XXX_PULLUP_ON_VBUS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus_active</span> <span class="o">=</span> <span class="n">is_active</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="n">gadget_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gadget_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_gadget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">hw_device_reset</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">USBMODE_CM_DC</span><span class="p">);</span>
			<span class="n">hw_device_state</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0out</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hw_device_state</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">notify_event</span><span class="p">)</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">notify_event</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span>
				<span class="n">CI13XXX_CONTROLLER_STOPPED_EVENT</span><span class="p">);</span>
			<span class="n">_gadget_stop_activity</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
			<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_gadget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ci13xxx_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">remote_wakeup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_PORTSC</span><span class="p">,</span> <span class="n">PORTSC_SUSP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hw_write</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_PORTSC</span><span class="p">,</span> <span class="n">PORTSC_FPR</span><span class="p">,</span> <span class="n">PORTSC_FPR</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ci13xxx_vbus_draw</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">_gadget</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mA</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">usb_phy_set_power</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">,</span> <span class="n">mA</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ci13xxx_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ci13xxx_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">);</span>
<span class="cm">/**</span>
<span class="cm"> * Device operations part of the API to the USB controller hardware,</span>
<span class="cm"> * which don&#39;t involve endpoints (or i/o)</span>
<span class="cm"> * Check  &quot;usb_gadget.h&quot; for details</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_gadget_ops</span> <span class="n">usb_gadget_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vbus_session</span>	<span class="o">=</span> <span class="n">ci13xxx_vbus_session</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wakeup</span>		<span class="o">=</span> <span class="n">ci13xxx_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vbus_draw</span>	<span class="o">=</span> <span class="n">ci13xxx_vbus_draw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_start</span>	<span class="o">=</span> <span class="n">ci13xxx_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udc_stop</span>	<span class="o">=</span> <span class="n">ci13xxx_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_eps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">hw_ep_max</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">RX</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">TX</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">hw_ep_max</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">mEp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ci13xxx_ep</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>

			<span class="n">scnprintf</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;ep%i%s&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					<span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">TX</span><span class="p">)</span>  <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">);</span>

			<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">udc</span>          <span class="o">=</span> <span class="n">udc</span><span class="p">;</span>
			<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">lock</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
			<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">td_pool</span>      <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">td_pool</span><span class="p">;</span>

			<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">name</span>      <span class="o">=</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
			<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ops</span>       <span class="o">=</span> <span class="o">&amp;</span><span class="n">usb_ep_ops</span><span class="p">;</span>
			<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="n">CTRL_PAYLOAD_MAX</span><span class="p">;</span>

			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
			<span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">qh_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">ptr</span><span class="p">));</span>

			<span class="cm">/*</span>
<span class="cm">			 * set up shorthands for ep0 out and in endpoints,</span>
<span class="cm">			 * don&#39;t add to gadget&#39;s ep_list</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">RX</span><span class="p">)</span>
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0out</span> <span class="o">=</span> <span class="n">mEp</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0in</span> <span class="o">=</span> <span class="n">mEp</span><span class="p">;</span>

				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mEp</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">ep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ci13xxx_start: register a gadget driver</span>
<span class="cm"> * @gadget: our gadget</span>
<span class="cm"> * @driver: the driver being registered</span>
<span class="cm"> *</span>
<span class="cm"> * Interrupts are enabled here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ci13xxx_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disconnect</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>


	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0out</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctrl_endpt_out_desc</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_ep_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0out</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0in</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctrl_endpt_in_desc</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_ep_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0in</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CI13XXX_PULLUP_ON_VBUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CI13XXX_REGS_SHARED</span><span class="p">)</span>
				<span class="n">hw_device_reset</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">USBMODE_CM_DC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">hw_device_state</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0out</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

 <span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ci13xxx_stop: unregister a gadget driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ci13xxx_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_gadget</span> <span class="o">*</span><span class="n">gadget</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">usb_gadget_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gadget</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx</span><span class="p">,</span> <span class="n">gadget</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CI13XXX_PULLUP_ON_VBUS</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">vbus_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_device_state</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">notify_event</span><span class="p">)</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">notify_event</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span>
			<span class="n">CI13XXX_CONTROLLER_STOPPED_EVENT</span><span class="p">);</span>
		<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">_gadget_stop_activity</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * BUS block</span>
<span class="cm"> *****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm"> * udc_irq: udc interrupt handler</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns IRQ_HANDLED if the IRQ has been handled</span>
<span class="cm"> * It locks access to registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">udc_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqreturn_t</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CI13XXX_REGS_SHARED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw_read</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">OP_USBMODE</span><span class="p">,</span> <span class="n">USBMODE_CM</span><span class="p">)</span> <span class="o">!=</span>
				<span class="n">USBMODE_CM_DC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">intr</span> <span class="o">=</span> <span class="n">hw_test_and_clear_intr_active</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="n">dbg_interrupt</span><span class="p">(</span><span class="n">intr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* order defines priority - do NOT change it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">USBi_URI</span> <span class="o">&amp;</span> <span class="n">intr</span><span class="p">)</span>
			<span class="n">isr_reset_handler</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">USBi_PCI</span> <span class="o">&amp;</span> <span class="n">intr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">hw_port_is_high_speed</span><span class="p">(</span><span class="n">udc</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">USB_SPEED_HIGH</span> <span class="o">:</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">&amp;&amp;</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">USBi_UI</span>  <span class="o">&amp;</span> <span class="n">intr</span><span class="p">)</span>
			<span class="n">isr_tr_complete_handler</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">USBi_SLI</span> <span class="o">&amp;</span> <span class="n">intr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_UNKNOWN</span> <span class="o">&amp;&amp;</span>
			    <span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">udc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * udc_release: driver release function</span>
<span class="cm"> * @dev: device</span>
<span class="cm"> *</span>
<span class="cm"> * Currently does nothing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * udc_start: initialize gadget role</span>
<span class="cm"> * @udc: chipidea controller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ops</span>          <span class="o">=</span> <span class="o">&amp;</span><span class="n">usb_gadget_ops</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">speed</span>        <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">max_speed</span>    <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">is_otg</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">name</span>         <span class="o">=</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep_list</span><span class="p">);</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gadget&quot;</span><span class="p">);</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">coherent_dma_mask</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">coherent_dma_mask</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span>   <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span>  <span class="o">=</span> <span class="n">udc_release</span><span class="p">;</span>

	<span class="cm">/* alloc resources */</span>
	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">qh_pool</span> <span class="o">=</span> <span class="n">dma_pool_create</span><span class="p">(</span><span class="s">&quot;ci13xxx_qh&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx_qh</span><span class="p">),</span>
				       <span class="mi">64</span><span class="p">,</span> <span class="n">CI13XXX_PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">qh_pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">td_pool</span> <span class="o">=</span> <span class="n">dma_pool_create</span><span class="p">(</span><span class="s">&quot;ci13xxx_td&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx_td</span><span class="p">),</span>
				       <span class="mi">64</span><span class="p">,</span> <span class="n">CI13XXX_PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">td_pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_qh_pool</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">init_eps</span><span class="p">(</span><span class="n">udc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_pools</span><span class="p">;</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">ep0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ep0in</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">usb_get_transceiver</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CI13XXX_REQUIRE_TRANSCEIVER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_pools</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CI13XXX_REGS_SHARED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">hw_device_reset</span><span class="p">(</span><span class="n">udc</span><span class="p">,</span> <span class="n">USBMODE_CM_DC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">put_transceiver</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">put_transceiver</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">dbg_create_files</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unreg_device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">otg_set_peripheral</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">remove_dbg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_add_gadget_udc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">remove_trans</span><span class="p">;</span>

	<span class="n">pm_runtime_no_callbacks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">remove_trans:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">otg_set_peripheral</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>
		<span class="n">usb_put_transceiver</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="nl">remove_dbg:</span>
	<span class="n">dbg_remove_files</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">unreg_device:</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">put_transceiver:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span>
		<span class="n">usb_put_transceiver</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">);</span>
<span class="nl">free_pools:</span>
	<span class="n">dma_pool_destroy</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">td_pool</span><span class="p">);</span>
<span class="nl">free_qh_pool:</span>
	<span class="n">dma_pool_destroy</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">qh_pool</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * udc_remove: parent remove must call this to remove UDC</span>
<span class="cm"> *</span>
<span class="cm"> * No interrupts active, the IRQ has been released</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">udc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">usb_del_gadget_udc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">udc</span><span class="o">-&gt;</span><span class="n">hw_ep_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ci13xxx_ep</span> <span class="o">*</span><span class="n">mEp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">ci13xxx_ep</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">qh_pool</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">mEp</span><span class="o">-&gt;</span><span class="n">qh</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_pool_destroy</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">td_pool</span><span class="p">);</span>
	<span class="n">dma_pool_destroy</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">qh_pool</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">otg_set_peripheral</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">usb_put_transceiver</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dbg_remove_files</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* my kobject is dynamic, I swear! */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">udc</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ci_hdrc_gadget_init - initialize device related bits</span>
<span class="cm"> * ci: the controller</span>
<span class="cm"> *</span>
<span class="cm"> * This function enables the gadget role, if the device is &quot;device capable&quot;.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ci_hdrc_gadget_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">ci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci_role_driver</span> <span class="o">*</span><span class="n">rdrv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw_read</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">CAP_DCCPARAMS</span><span class="p">,</span> <span class="n">DCCPARAMS_DC</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">rdrv</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci_role_driver</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdrv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rdrv</span><span class="o">-&gt;</span><span class="n">start</span>	<span class="o">=</span> <span class="n">udc_start</span><span class="p">;</span>
	<span class="n">rdrv</span><span class="o">-&gt;</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">udc_stop</span><span class="p">;</span>
	<span class="n">rdrv</span><span class="o">-&gt;</span><span class="n">irq</span>	<span class="o">=</span> <span class="n">udc_irq</span><span class="p">;</span>
	<span class="n">rdrv</span><span class="o">-&gt;</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;gadget&quot;</span><span class="p">;</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">roles</span><span class="p">[</span><span class="n">CI_ROLE_GADGET</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdrv</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
