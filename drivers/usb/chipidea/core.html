<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › chipidea › core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * core.c - ChipIdea USB IP core family device controller</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Chipidea - MIPS Technologies, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: David Lopo</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Description: ChipIdea USB IP core family device controller</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is composed of several blocks:</span>
<span class="cm"> * - HW:     hardware interface</span>
<span class="cm"> * - DBG:    debug facilities (optional)</span>
<span class="cm"> * - UTIL:   utilities</span>
<span class="cm"> * - ISR:    interrupts handling</span>
<span class="cm"> * - ENDPT:  endpoint operations (Gadget API)</span>
<span class="cm"> * - GADGET: gadget operations (Gadget API)</span>
<span class="cm"> * - BUS:    bus glue code, bus abstraction layer</span>
<span class="cm"> *</span>
<span class="cm"> * Compile Options</span>
<span class="cm"> * - CONFIG_USB_GADGET_DEBUG_FILES: enable debug facilities</span>
<span class="cm"> * - STALL_IN:  non-empty bulk-in pipes cannot be halted</span>
<span class="cm"> *              if defined mass storage compliance succeeds but with warnings</span>
<span class="cm"> *              =&gt; case 4: Hi &gt;  Dn</span>
<span class="cm"> *              =&gt; case 5: Hi &gt;  Di</span>
<span class="cm"> *              =&gt; case 8: Hi &lt;&gt; Do</span>
<span class="cm"> *              if undefined usbtest 13 fails</span>
<span class="cm"> * - TRACE:     enable function tracing (depends on DEBUG)</span>
<span class="cm"> *</span>
<span class="cm"> * Main Features</span>
<span class="cm"> * - Chapter 9 &amp; Mass Storage Compliance with Gadget File Storage</span>
<span class="cm"> * - Chapter 9 Compliance with Gadget Zero (STALL_IN undefined)</span>
<span class="cm"> * - Normal &amp; LPM support</span>
<span class="cm"> *</span>
<span class="cm"> * USBTEST Report</span>
<span class="cm"> * - OK: 0-12, 13 (STALL_IN defined) &amp; 14</span>
<span class="cm"> * - Not Supported: 15 &amp; 16 (ISO)</span>
<span class="cm"> *</span>
<span class="cm"> * TODO List</span>
<span class="cm"> * - OTG</span>
<span class="cm"> * - Isochronous &amp; Interrupt Traffic</span>
<span class="cm"> * - Handle requests which spawns into several TDs</span>
<span class="cm"> * - GET_STATUS(device) - always reports 0</span>
<span class="cm"> * - Gadget API (majority of optional features)</span>
<span class="cm"> * - Suspend &amp; Remote Wakeup</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/dmapool.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/usb/ch9.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gadget.h&gt;</span>
<span class="cp">#include &lt;linux/usb/otg.h&gt;</span>
<span class="cp">#include &lt;linux/usb/chipidea.h&gt;</span>

<span class="cp">#include &quot;ci.h&quot;</span>
<span class="cp">#include &quot;udc.h&quot;</span>
<span class="cp">#include &quot;bits.h&quot;</span>
<span class="cp">#include &quot;host.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>

<span class="cm">/* Controller register map */</span>
<span class="k">static</span> <span class="kt">uintptr_t</span> <span class="n">ci_regs_nolpm</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CAP_CAPLENGTH</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x000UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CAP_HCCPARAMS</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x008UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CAP_DCCPARAMS</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x024UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CAP_TESTMODE</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x038UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_USBCMD</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x000UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_USBSTS</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x004UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_USBINTR</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x008UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_DEVICEADDR</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x014UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_ENDPTLISTADDR</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x018UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_PORTSC</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x044UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_DEVLC</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x084UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_OTGSC</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x064UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_USBMODE</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x068UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_ENDPTSETUPSTAT</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x06CUL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_ENDPTPRIME</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x070UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_ENDPTFLUSH</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x074UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_ENDPTSTAT</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x078UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_ENDPTCOMPLETE</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x07CUL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_ENDPTCTRL</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x080UL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">uintptr_t</span> <span class="n">ci_regs_lpm</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CAP_CAPLENGTH</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x000UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CAP_HCCPARAMS</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x008UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CAP_DCCPARAMS</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x024UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CAP_TESTMODE</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x0FCUL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_USBCMD</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x000UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_USBSTS</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x004UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_USBINTR</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x008UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_DEVICEADDR</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x014UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_ENDPTLISTADDR</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x018UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_PORTSC</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x044UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_DEVLC</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x084UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_OTGSC</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x0C4UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_USBMODE</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x0C8UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_ENDPTSETUPSTAT</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x0D8UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_ENDPTPRIME</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x0DCUL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_ENDPTFLUSH</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x0E0UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_ENDPTSTAT</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x0E4UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_ENDPTCOMPLETE</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x0E8UL</span><span class="p">,</span>
	<span class="p">[</span><span class="n">OP_ENDPTCTRL</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0x0ECUL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_alloc_regmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_lpm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">regmap</span><span class="p">);</span>

	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">regmap</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">((</span><span class="n">OP_LAST</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
				     <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">regmap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OP_ENDPTCTRL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">regmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">CAP_LAST</span> <span class="o">?</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">cap</span> <span class="o">:</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">op</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">is_lpm</span> <span class="o">?</span> <span class="n">ci_regs_lpm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="n">ci_regs_nolpm</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">OP_LAST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">regmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">op</span> <span class="o">+</span>
			<span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">OP_ENDPTCTRL</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">is_lpm</span>
			 <span class="o">?</span> <span class="n">ci_regs_lpm</span><span class="p">[</span><span class="n">OP_ENDPTCTRL</span><span class="p">]</span>
			 <span class="o">:</span> <span class="n">ci_regs_nolpm</span><span class="p">[</span><span class="n">OP_ENDPTCTRL</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_port_test_set: writes port test mode (execute without interruption)</span>
<span class="cm"> * @mode: new value</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">hw_port_test_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">TEST_MODE_MAX</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;</span> <span class="n">TEST_MODE_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">hw_write</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">OP_PORTSC</span><span class="p">,</span> <span class="n">PORTSC_PTC</span><span class="p">,</span> <span class="n">mode</span> <span class="o">&lt;&lt;</span> <span class="n">ffs_nr</span><span class="p">(</span><span class="n">PORTSC_PTC</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_port_test_get: reads port test mode value</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns port test mode value</span>
<span class="cm"> */</span>
<span class="n">u8</span> <span class="nf">hw_port_test_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">ci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw_read</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">OP_PORTSC</span><span class="p">,</span> <span class="n">PORTSC_PTC</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ffs_nr</span><span class="p">(</span><span class="n">PORTSC_PTC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_device_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* bank is a module variable */</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">abs</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>

	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">cap</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">abs</span><span class="p">;</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">cap</span> <span class="o">+=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">capoffset</span><span class="p">;</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">cap</span> <span class="o">+</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">cap</span><span class="p">);</span>

	<span class="n">hw_alloc_regmap</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">hw_read</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">CAP_HCCPARAMS</span><span class="p">,</span> <span class="n">HCCPARAMS_LEN</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">ffs_nr</span><span class="p">(</span><span class="n">HCCPARAMS_LEN</span><span class="p">);</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">lpm</span>  <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">hw_alloc_regmap</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="o">!!</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">op</span> <span class="o">-</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">abs</span><span class="p">;</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">size</span> <span class="o">+=</span> <span class="n">OP_LAST</span><span class="p">;</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">size</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">hw_read</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">CAP_DCCPARAMS</span><span class="p">,</span> <span class="n">DCCPARAMS_DEN</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">ffs_nr</span><span class="p">(</span><span class="n">DCCPARAMS_DEN</span><span class="p">);</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_ep_max</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>   <span class="cm">/* cache hw ENDPT_MAX */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_ep_max</span> <span class="o">&gt;</span> <span class="n">ENDPT_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ChipIdea HDRC found, lpm: %d; cap: %p op: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">lpm</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">cap</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>

	<span class="cm">/* setup lock mode ? */</span>

	<span class="cm">/* ENDPTSETUPSTAT is &#39;0&#39; by default */</span>

	<span class="cm">/* HCSPARAMS.bf.ppc SHOULD BE zero for device */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * hw_device_reset: resets chip (execute without interruption)</span>
<span class="cm"> * @ci: the controller</span>
<span class="cm">  *</span>
<span class="cm"> * This function returns an error code</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">hw_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">ci</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* should flush &amp; stop before reset */</span>
	<span class="n">hw_write</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">OP_ENDPTFLUSH</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">hw_write</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">OP_USBCMD</span><span class="p">,</span> <span class="n">USBCMD_RS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hw_write</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">OP_USBCMD</span><span class="p">,</span> <span class="n">USBCMD_RST</span><span class="p">,</span> <span class="n">USBCMD_RST</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hw_read</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">OP_USBCMD</span><span class="p">,</span> <span class="n">USBCMD_RST</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>		<span class="cm">/* not RTOS friendly */</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">notify_event</span><span class="p">)</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">notify_event</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span>
			<span class="n">CI13XXX_CONTROLLER_RESET_EVENT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CI13XXX_DISABLE_STREAMING</span><span class="p">)</span>
		<span class="n">hw_write</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">OP_USBMODE</span><span class="p">,</span> <span class="n">USBMODE_CI_SDIS</span><span class="p">,</span> <span class="n">USBMODE_CI_SDIS</span><span class="p">);</span>

	<span class="cm">/* USBMODE should be configured step by step */</span>
	<span class="n">hw_write</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">OP_USBMODE</span><span class="p">,</span> <span class="n">USBMODE_CM</span><span class="p">,</span> <span class="n">USBMODE_CM_IDLE</span><span class="p">);</span>
	<span class="n">hw_write</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">OP_USBMODE</span><span class="p">,</span> <span class="n">USBMODE_CM</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="cm">/* HW &gt;= 2.3 */</span>
	<span class="n">hw_write</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">OP_USBMODE</span><span class="p">,</span> <span class="n">USBMODE_SLOM</span><span class="p">,</span> <span class="n">USBMODE_SLOM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_read</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">OP_USBMODE</span><span class="p">,</span> <span class="n">USBMODE_CM</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot enter in %s mode&quot;</span><span class="p">,</span> <span class="n">ci_role</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;lpm = %i&quot;</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">lpm</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ci_otg_role - pick role based on ID pin state</span>
<span class="cm"> * @ci: the controller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">ci_role</span> <span class="nf">ci_otg_role</span><span class="p">(</span><span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">ci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">hw_read</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">OP_OTGSC</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">ci_role</span> <span class="n">role</span> <span class="o">=</span> <span class="n">sts</span> <span class="o">&amp;</span> <span class="n">OTGSC_ID</span>
		<span class="o">?</span> <span class="n">CI_ROLE_GADGET</span>
		<span class="o">:</span> <span class="n">CI_ROLE_HOST</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">role</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ci_role_work - perform role changing based on ID pin</span>
<span class="cm"> * @work: work struct</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ci_role_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ci13xxx</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">ci_role</span> <span class="n">role</span> <span class="o">=</span> <span class="n">ci_otg_role</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span>

	<span class="n">hw_write</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">OP_OTGSC</span><span class="p">,</span> <span class="n">OTGSC_IDIS</span><span class="p">,</span> <span class="n">OTGSC_IDIS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">!=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;switching from %s to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ci_role</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">roles</span><span class="p">[</span><span class="n">role</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">ci_role_stop</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span>
		<span class="n">ci_role_start</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">role</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_role</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ci_role</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_role</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">ci_role</span> <span class="n">role</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">role</span> <span class="o">=</span> <span class="n">CI_ROLE_HOST</span><span class="p">;</span> <span class="n">role</span> <span class="o">&lt;</span> <span class="n">CI_ROLE_END</span><span class="p">;</span> <span class="n">role</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">roles</span><span class="p">[</span><span class="n">role</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">roles</span><span class="p">[</span><span class="n">role</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">==</span> <span class="n">CI_ROLE_END</span> <span class="o">||</span> <span class="n">role</span> <span class="o">==</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ci_role_stop</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ci_role_start</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">role</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_role</span><span class="p">,</span> <span class="n">store_role</span><span class="p">);</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ci_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">is_otg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">hw_read</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">OP_OTGSC</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">OTGSC_IDIS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">==</span> <span class="n">CI_ROLE_END</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">ci_role</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ci_hdrc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ci13xxx</span>	<span class="o">*</span><span class="n">ci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>	<span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform data missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;missing resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">devm_request_and_ioremap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t request and ioremap resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ci</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ci</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">udc_driver</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hw_device_init</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t initialize hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">hw_bank</span><span class="p">.</span><span class="n">phys</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;missing IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">ci_role_work</span><span class="p">);</span>
	<span class="n">ci</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;ci_otg&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t create workqueue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize role(s) before the interrupt is requested */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ci_hdrc_host_init</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;doesn&#39;t support host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ci_hdrc_gadget_init</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;doesn&#39;t support gadget</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">roles</span><span class="p">[</span><span class="n">CI_ROLE_HOST</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">roles</span><span class="p">[</span><span class="n">CI_ROLE_GADGET</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no supported roles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rm_wq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">roles</span><span class="p">[</span><span class="n">CI_ROLE_HOST</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">roles</span><span class="p">[</span><span class="n">CI_ROLE_GADGET</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">is_otg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">=</span> <span class="n">ci_otg_role</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ci</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">=</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">roles</span><span class="p">[</span><span class="n">CI_ROLE_HOST</span><span class="p">]</span>
			<span class="o">?</span> <span class="n">CI_ROLE_HOST</span>
			<span class="o">:</span> <span class="n">CI_ROLE_GADGET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ci_role_start</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t start %s role</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ci_role</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">rm_wq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ci</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ci_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">ci</span><span class="o">-&gt;</span><span class="n">udc_driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			  <span class="n">ci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">stop</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_role</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rm_attr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">is_otg</span><span class="p">)</span>
		<span class="n">hw_write</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">OP_OTGSC</span><span class="p">,</span> <span class="n">OTGSC_IDIE</span><span class="p">,</span> <span class="n">OTGSC_IDIE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">rm_attr:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_role</span><span class="p">);</span>
<span class="nl">stop:</span>
	<span class="n">ci_role_stop</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span>
<span class="nl">rm_wq:</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ci_hdrc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ci13xxx</span> <span class="o">*</span><span class="n">ci</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_role</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ci</span><span class="p">);</span>
	<span class="n">ci_role_stop</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ci_hdrc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">ci_hdrc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ci_hdrc_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ci_hdrc&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">ci_hdrc_driver</span><span class="p">);</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:ci_hdrc&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:ci13xxx&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David Lopo &lt;dlopo@chipidea.mips.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ChipIdea HDRC Driver&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
