<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › usb › musb › musb_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>musb_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * MUSB OTG driver core code</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2005 Mentor Graphics Corporation</span>
<span class="cm"> * Copyright (C) 2005-2006 by Texas Instruments</span>
<span class="cm"> * Copyright (C) 2006-2007 Nokia Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * version 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED</span>
<span class="cm"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN</span>
<span class="cm"> * NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="cm"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
<span class="cm"> * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF</span>
<span class="cm"> * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON</span>
<span class="cm"> * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<span class="cm"> * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Inventra (Multipoint) Dual-Role Controller Driver for Linux.</span>
<span class="cm"> *</span>
<span class="cm"> * This consists of a Host Controller Driver (HCD) and a peripheral</span>
<span class="cm"> * controller driver implementing the &quot;Gadget&quot; API; OTG support is</span>
<span class="cm"> * in the works.  These are normal Linux-USB controller drivers which</span>
<span class="cm"> * use IRQs and have no dedicated thread.</span>
<span class="cm"> *</span>
<span class="cm"> * This version of the driver has only been used with products from</span>
<span class="cm"> * Texas Instruments.  Those products integrate the Inventra logic</span>
<span class="cm"> * with other DMA, IRQ, and bus modules, as well as other logic that</span>
<span class="cm"> * needs to be reflected in this driver.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:  the original Mentor code here was pretty much a collection</span>
<span class="cm"> * of mechanisms that don&#39;t seem to have been fully integrated/working</span>
<span class="cm"> * for *any* Linux kernel version.  This version aims at Linux 2.6.now,</span>
<span class="cm"> * Key open issues include:</span>
<span class="cm"> *</span>
<span class="cm"> *  - Lack of host-side transaction scheduling, for all transfer types.</span>
<span class="cm"> *    The hardware doesn&#39;t do it; instead, software must.</span>
<span class="cm"> *</span>
<span class="cm"> *    This is not an issue for OTG devices that don&#39;t support external</span>
<span class="cm"> *    hubs, but for more &quot;normal&quot; USB hosts it&#39;s a user issue that the</span>
<span class="cm"> *    &quot;multipoint&quot; support doesn&#39;t scale in the expected ways.  That</span>
<span class="cm"> *    includes DaVinci EVM in a common non-OTG mode.</span>
<span class="cm"> *</span>
<span class="cm"> *      * Control and bulk use dedicated endpoints, and there&#39;s as</span>
<span class="cm"> *        yet no mechanism to either (a) reclaim the hardware when</span>
<span class="cm"> *        peripherals are NAKing, which gets complicated with bulk</span>
<span class="cm"> *        endpoints, or (b) use more than a single bulk endpoint in</span>
<span class="cm"> *        each direction.</span>
<span class="cm"> *</span>
<span class="cm"> *        RESULT:  one device may be perceived as blocking another one.</span>
<span class="cm"> *</span>
<span class="cm"> *      * Interrupt and isochronous will dynamically allocate endpoint</span>
<span class="cm"> *        hardware, but (a) there&#39;s no record keeping for bandwidth;</span>
<span class="cm"> *        (b) in the common case that few endpoints are available, there</span>
<span class="cm"> *        is no mechanism to reuse endpoints to talk to multiple devices.</span>
<span class="cm"> *</span>
<span class="cm"> *        RESULT:  At one extreme, bandwidth can be overcommitted in</span>
<span class="cm"> *        some hardware configurations, no faults will be reported.</span>
<span class="cm"> *        At the other extreme, the bandwidth capabilities which do</span>
<span class="cm"> *        exist tend to be severely undercommitted.  You can&#39;t yet hook</span>
<span class="cm"> *        up both a keyboard and a mouse to an external USB hub.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This gets many kinds of configuration information:</span>
<span class="cm"> *	- Kconfig for everything user-configurable</span>
<span class="cm"> *	- platform_device for addressing, irq, and platform_data</span>
<span class="cm"> *	- platform_data is mostly for board-specific informarion</span>
<span class="cm"> *	  (plus recentrly, SOC or family details)</span>
<span class="cm"> *</span>
<span class="cm"> * Most of the conditional compilation will (someday) vanish.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/kobject.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &quot;musb_core.h&quot;</span>

<span class="cp">#define TA_WAIT_BCON(m) max_t(int, (m)-&gt;a_wait_bcon, OTG_TIME_A_WAIT_BCON)</span>


<span class="cp">#define DRIVER_AUTHOR &quot;Mentor Graphics, Texas Instruments, Nokia&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;Inventra Dual-Role USB Controller Driver&quot;</span>

<span class="cp">#define MUSB_VERSION &quot;6.0&quot;</span>

<span class="cp">#define DRIVER_INFO DRIVER_DESC &quot;, v&quot; MUSB_VERSION</span>

<span class="cp">#define MUSB_DRIVER_NAME &quot;musb-hdrc&quot;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">musb_driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="n">MUSB_DRIVER_NAME</span><span class="p">;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_INFO</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">MUSB_DRIVER_NAME</span><span class="p">);</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="nf">dev_to_musb</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#ifndef CONFIG_BLACKFIN</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">musb_ulpi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">io_priv</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">r</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">power</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ret</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">io_dev</span><span class="p">);</span>

	<span class="cm">/* Make sure the transceiver is not in low power mode */</span>
	<span class="n">power</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_POWER</span><span class="p">);</span>
	<span class="n">power</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MUSB_POWER_SUSPENDM</span><span class="p">;</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_POWER</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>

	<span class="cm">/* REVISIT: musbhdrc_ulpi_an.pdf recommends setting the</span>
<span class="cm">	 * ULPICarKitControlDisableUTMI after clearing POWER_SUSPENDM.</span>
<span class="cm">	 */</span>

	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_ULPI_REG_ADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_ULPI_REG_CONTROL</span><span class="p">,</span>
			<span class="n">MUSB_ULPI_REG_REQ</span> <span class="o">|</span> <span class="n">MUSB_ULPI_RDN_WR</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">musb_readb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_ULPI_REG_CONTROL</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="n">MUSB_ULPI_REG_CMPLT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_ULPI_REG_CONTROL</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MUSB_ULPI_REG_CMPLT</span><span class="p">;</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_ULPI_REG_CONTROL</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_ULPI_REG_DATA</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">io_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">musb_ulpi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">io_priv</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">power</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">io_dev</span><span class="p">);</span>

	<span class="cm">/* Make sure the transceiver is not in low power mode */</span>
	<span class="n">power</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_POWER</span><span class="p">);</span>
	<span class="n">power</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MUSB_POWER_SUSPENDM</span><span class="p">;</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_POWER</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>

	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_ULPI_REG_ADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_ULPI_REG_DATA</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_ULPI_REG_CONTROL</span><span class="p">,</span> <span class="n">MUSB_ULPI_REG_REQ</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">musb_readb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_ULPI_REG_CONTROL</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="n">MUSB_ULPI_REG_CMPLT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_ULPI_REG_CONTROL</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MUSB_ULPI_REG_CMPLT</span><span class="p">;</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">MUSB_ULPI_REG_CONTROL</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">io_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define musb_ulpi_read		NULL</span>
<span class="cp">#define musb_ulpi_write		NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_phy_io_ops</span> <span class="n">musb_ulpi_access</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">musb_ulpi_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">musb_ulpi_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#if !defined(CONFIG_USB_MUSB_TUSB6010) &amp;&amp; !defined(CONFIG_USB_MUSB_BLACKFIN)</span>

<span class="cm">/*</span>
<span class="cm"> * Load an endpoint&#39;s FIFO</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">musb_write_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb_hw_ep</span> <span class="o">*</span><span class="n">hw_ep</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span> <span class="o">=</span> <span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">musb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">;</span>

	<span class="n">prefetch</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">src</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;%cX ep%d fifo %p count %d buf %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>

	<span class="cm">/* we can&#39;t assume unaligned reads work */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="mh">0x01</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">src</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span>	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* best case is 32bit-aligned source address */</span>
		<span class="k">if</span> <span class="p">((</span><span class="mh">0x02</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">src</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">writesl</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">src</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">index</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">musb_writew</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">src</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
				<span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">writesw</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">src</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">index</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="n">musb_writeb</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
		<span class="cm">/* byte aligned */</span>
		<span class="n">writesb</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if !defined(CONFIG_USB_MUSB_AM35X)</span>
<span class="cm">/*</span>
<span class="cm"> * Unload an endpoint&#39;s FIFO</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">musb_read_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb_hw_ep</span> <span class="o">*</span><span class="n">hw_ep</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span> <span class="o">=</span> <span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">musb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;%cX ep%d fifo %p count %d buf %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="sc">&#39;R&#39;</span><span class="p">,</span> <span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>

	<span class="cm">/* we can&#39;t assume unaligned writes work */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="mh">0x01</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span>	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* best case is 32bit-aligned destination address */</span>
		<span class="k">if</span> <span class="p">((</span><span class="mh">0x02</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">readsl</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dst</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">musb_readw</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">readsw</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="n">dst</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
		<span class="cm">/* byte aligned */</span>
		<span class="n">readsb</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#endif	</span><span class="cm">/* normal PIO */</span><span class="cp"></span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* for high speed test mode; see USB 2.0 spec 7.1.20 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">musb_test_packet</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* implicit SYNC then DATA0 to start */</span>

	<span class="cm">/* JKJKJKJK x9 */</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="cm">/* JJKKJJKK x8 */</span>
	<span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span>
	<span class="cm">/* JJJJKKKK x8 */</span>
	<span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span>
	<span class="cm">/* JJJJJJJKKKKKKK x8 */</span>
	<span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="cm">/* JJJJJJJK x8 */</span>
	<span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span>
	<span class="cm">/* JKKKKKKK x10, JK */</span>
	<span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0x7e</span>

	<span class="cm">/* implicit CRC16 then EOP to end */</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">musb_load_testpacket</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">endpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">musb_ep_select</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">musb_write_fifo</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">control_ep</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">musb_test_packet</span><span class="p">),</span> <span class="n">musb_test_packet</span><span class="p">);</span>
	<span class="n">musb_writew</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">MUSB_CSR0</span><span class="p">,</span> <span class="n">MUSB_CSR0_TXPKTRDY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * Handles OTG hnp timeouts, such as b_ase0_brst</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">musb_otg_timer_func</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">musb</span>	<span class="o">*</span><span class="n">musb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OTG_STATE_B_WAIT_ACON</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;HNP: b_wait_acon timeout; back to b_peripheral</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">musb_g_disconnect</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_PERIPHERAL</span><span class="p">;</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">is_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OTG_STATE_A_SUSPEND</span>:
	<span class="k">case</span> <span class="n">OTG_STATE_A_WAIT_BCON</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;HNP: %s timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
		<span class="n">musb_platform_set_vbus</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_WAIT_VFALL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;HNP: Unhandled mode %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">ignore_disconnect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stops the HNP transition. Caller must take care of locking.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">musb_hnp_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>	<span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">musb_to_hcd</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">mbase</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">reg</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;HNP: stop from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OTG_STATE_A_PERIPHERAL</span>:
		<span class="n">musb_g_disconnect</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;HNP: back to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OTG_STATE_B_HOST</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;HNP: Disabling HR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">is_b_host</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_PERIPHERAL</span><span class="p">;</span>
		<span class="n">MUSB_DEV_MODE</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">MUSB_POWER</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">MUSB_POWER_SUSPENDM</span><span class="p">;</span>
		<span class="n">musb_writeb</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">MUSB_POWER</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="cm">/* REVISIT: Start SESSION_REQUEST here? */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;HNP: Stopping in unknown state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * When returning to A state after HNP, avoid hub_port_rebounce(),</span>
<span class="cm">	 * which cause occasional OPT A &quot;Did not receive reset after connect&quot;</span>
<span class="cm">	 * errors.</span>
<span class="cm">	 */</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">port1_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">USB_PORT_STAT_C_CONNECTION</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt Service Routine to record USB &quot;global&quot; interrupts.</span>
<span class="cm"> * Since these do not happen often and signify things of</span>
<span class="cm"> * paramount importance, it seems OK to check them individually;</span>
<span class="cm"> * the order of the tests is specified in the manual</span>
<span class="cm"> *</span>
<span class="cm"> * @param musb instance pointer</span>
<span class="cm"> * @param int_usb register contents</span>
<span class="cm"> * @param devctl</span>
<span class="cm"> * @param power</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">musb_stage0_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span><span class="p">,</span> <span class="n">u8</span> <span class="n">int_usb</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">devctl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_otg</span> <span class="o">*</span><span class="n">otg</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">handled</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;&lt;== Power=%02x, DevCtl=%02x, int_usb=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">devctl</span><span class="p">,</span>
		<span class="n">int_usb</span><span class="p">);</span>

	<span class="cm">/* in host mode, the peripheral may issue remote wakeup.</span>
<span class="cm">	 * in peripheral mode, the host may resume the link.</span>
<span class="cm">	 * spurious RESUME irqs happen too, paired with SUSPEND.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_usb</span> <span class="o">&amp;</span> <span class="n">MUSB_INTR_RESUME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;RESUME (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_HM</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mbase</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">OTG_STATE_A_SUSPEND</span>:
				<span class="cm">/* remote wakeup?  later, GetPortStatus</span>
<span class="cm">				 * will stop RESUME signaling</span>
<span class="cm">				 */</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">power</span> <span class="o">&amp;</span> <span class="n">MUSB_POWER_SUSPENDM</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* spurious */</span>
					<span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_usb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MUSB_INTR_SUSPEND</span><span class="p">;</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;Spurious SUSPENDM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">power</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MUSB_POWER_SUSPENDM</span><span class="p">;</span>
				<span class="n">musb_writeb</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">MUSB_POWER</span><span class="p">,</span>
						<span class="n">power</span> <span class="o">|</span> <span class="n">MUSB_POWER_RESUME</span><span class="p">);</span>

				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">port1_status</span> <span class="o">|=</span>
						<span class="p">(</span><span class="n">USB_PORT_STAT_C_SUSPEND</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
						<span class="o">|</span> <span class="n">MUSB_PORT_STAT_RESUME</span><span class="p">;</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">rh_timer</span> <span class="o">=</span> <span class="n">jiffies</span>
						<span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_HOST</span><span class="p">;</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">is_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">usb_hcd_resume_root_hub</span><span class="p">(</span><span class="n">musb_to_hcd</span><span class="p">(</span><span class="n">musb</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OTG_STATE_B_WAIT_ACON</span>:
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_PERIPHERAL</span><span class="p">;</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">is_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">MUSB_DEV_MODE</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">WARNING</span><span class="p">(</span><span class="s">&quot;bogus %s RESUME (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="s">&quot;host&quot;</span><span class="p">,</span>
					<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">OTG_STATE_A_SUSPEND</span>:
				<span class="cm">/* possibly DISCONNECT is upcoming */</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_HOST</span><span class="p">;</span>
				<span class="n">usb_hcd_resume_root_hub</span><span class="p">(</span><span class="n">musb_to_hcd</span><span class="p">(</span><span class="n">musb</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OTG_STATE_B_WAIT_ACON</span>:
			<span class="k">case</span> <span class="n">OTG_STATE_B_PERIPHERAL</span>:
				<span class="cm">/* disconnect while suspended?  we may</span>
<span class="cm">				 * not get a disconnect irq...</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_VBUS</span><span class="p">)</span>
						<span class="o">!=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">MUSB_DEVCTL_VBUS_SHIFT</span><span class="p">)</span>
						<span class="p">)</span> <span class="p">{</span>
					<span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_usb</span> <span class="o">|=</span> <span class="n">MUSB_INTR_DISCONNECT</span><span class="p">;</span>
					<span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_usb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MUSB_INTR_SUSPEND</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">musb_g_resume</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OTG_STATE_B_IDLE</span>:
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_usb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MUSB_INTR_SUSPEND</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">WARNING</span><span class="p">(</span><span class="s">&quot;bogus %s RESUME (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="s">&quot;peripheral&quot;</span><span class="p">,</span>
					<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* see manual for the order of the tests */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_usb</span> <span class="o">&amp;</span> <span class="n">MUSB_INTR_SESSREQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mbase</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_VBUS</span><span class="p">)</span> <span class="o">==</span> <span class="n">MUSB_DEVCTL_VBUS</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_BDEVICE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;SessReq while on B state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;SESSION_REQUEST (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>

		<span class="cm">/* IRQ arrives from ID pin sense or (later, if VBUS power</span>
<span class="cm">		 * is removed) SRP.  responses are time critical:</span>
<span class="cm">		 *  - turn on VBUS (with silicon-specific mechanism)</span>
<span class="cm">		 *  - go through A_WAIT_VRISE</span>
<span class="cm">		 *  - ... to A_WAIT_BCON.</span>
<span class="cm">		 * a_wait_vrise_tmout triggers VBUS_ERROR transitions</span>
<span class="cm">		 */</span>
		<span class="n">musb_writeb</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">MUSB_DEVCTL</span><span class="p">,</span> <span class="n">MUSB_DEVCTL_SESSION</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">ep0_stage</span> <span class="o">=</span> <span class="n">MUSB_EP0_START</span><span class="p">;</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_IDLE</span><span class="p">;</span>
		<span class="n">MUSB_HST_MODE</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
		<span class="n">musb_platform_set_vbus</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_usb</span> <span class="o">&amp;</span> <span class="n">MUSB_INTR_VBUSERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">ignore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* During connection as an A-Device, we may see a short</span>
<span class="cm">		 * current spikes causing voltage drop, because of cable</span>
<span class="cm">		 * and peripheral capacitance combined with vbus draw.</span>
<span class="cm">		 * (So: less common with truly self-powered devices, where</span>
<span class="cm">		 * vbus doesn&#39;t act like a power supply.)</span>
<span class="cm">		 *</span>
<span class="cm">		 * Such spikes are short; usually less than ~500 usec, max</span>
<span class="cm">		 * of ~2 msec.  That is, they&#39;re not sustained overcurrent</span>
<span class="cm">		 * errors, though they&#39;re reported using VBUSERROR irqs.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Workarounds:  (a) hardware: use self powered devices.</span>
<span class="cm">		 * (b) software:  ignore non-repeated VBUS errors.</span>
<span class="cm">		 *</span>
<span class="cm">		 * REVISIT:  do delays from lots of DEBUG_KERNEL checks</span>
<span class="cm">		 * make trouble here, keeping VBUS &lt; 4.4V ?</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OTG_STATE_A_HOST</span>:
			<span class="cm">/* recovery is dicey once we&#39;ve gotten past the</span>
<span class="cm">			 * initial stages of enumeration, but if VBUS</span>
<span class="cm">			 * stayed ok at the other end of the link, and</span>
<span class="cm">			 * another reset is due (at least for high speed,</span>
<span class="cm">			 * to redo the chirp etc), it might work OK...</span>
<span class="cm">			 */</span>
		<span class="k">case</span> <span class="n">OTG_STATE_A_WAIT_BCON</span>:
		<span class="k">case</span> <span class="n">OTG_STATE_A_WAIT_VRISE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">vbuserr_retry</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mbase</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">;</span>

				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">vbuserr_retry</span><span class="o">--</span><span class="p">;</span>
				<span class="n">ignore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">devctl</span> <span class="o">|=</span> <span class="n">MUSB_DEVCTL_SESSION</span><span class="p">;</span>
				<span class="n">musb_writeb</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">MUSB_DEVCTL</span><span class="p">,</span> <span class="n">devctl</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">port1_status</span> <span class="o">|=</span>
					  <span class="n">USB_PORT_STAT_OVERCURRENT</span>
					<span class="o">|</span> <span class="p">(</span><span class="n">USB_PORT_STAT_C_OVERCURRENT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;VBUS_ERROR in %s (%02x, %s), retry #%d, port1 %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span>
				<span class="n">devctl</span><span class="p">,</span>
				<span class="p">({</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_VBUS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">MUSB_DEVCTL_VBUS_SHIFT</span>:
					<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&lt;SessEnd&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MUSB_DEVCTL_VBUS_SHIFT</span>:
					<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&lt;AValid&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">MUSB_DEVCTL_VBUS_SHIFT</span>:
					<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&lt;VBusValid&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="cm">/* case 3 &lt;&lt; MUSB_DEVCTL_VBUS_SHIFT: */</span>
				<span class="nl">default:</span>
					<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;VALID&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="p">};</span> <span class="n">s</span><span class="p">;</span> <span class="p">}),</span>
				<span class="n">VBUSERR_RETRY_COUNT</span> <span class="o">-</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">vbuserr_retry</span><span class="p">,</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">port1_status</span><span class="p">);</span>

		<span class="cm">/* go through A_WAIT_VFALL then start a new session */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ignore</span><span class="p">)</span>
			<span class="n">musb_platform_set_vbus</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_usb</span> <span class="o">&amp;</span> <span class="n">MUSB_INTR_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;SUSPEND (%s) devctl %02x power %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span> <span class="n">devctl</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OTG_STATE_A_PERIPHERAL</span>:
			<span class="cm">/* We also come here if the cable is removed, since</span>
<span class="cm">			 * this silicon doesn&#39;t report ID-no-longer-grounded.</span>
<span class="cm">			 *</span>
<span class="cm">			 * We depend on T(a_wait_bcon) to shut us down, and</span>
<span class="cm">			 * hope users don&#39;t do anything dicey during this</span>
<span class="cm">			 * undesired detour through A_WAIT_BCON.</span>
<span class="cm">			 */</span>
			<span class="n">musb_hnp_stop</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
			<span class="n">usb_hcd_resume_root_hub</span><span class="p">(</span><span class="n">musb_to_hcd</span><span class="p">(</span><span class="n">musb</span><span class="p">));</span>
			<span class="n">musb_root_disconnect</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
			<span class="n">musb_platform_try_idle</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">jiffies</span>
					<span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">a_wait_bcon</span>
						<span class="o">?</span> <span class="o">:</span> <span class="n">OTG_TIME_A_WAIT_BCON</span><span class="p">));</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OTG_STATE_B_IDLE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">is_active</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OTG_STATE_B_PERIPHERAL</span>:
			<span class="n">musb_g_suspend</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">is_active</span> <span class="o">=</span> <span class="n">is_otg_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="n">otg</span><span class="o">-&gt;</span><span class="n">gadget</span><span class="o">-&gt;</span><span class="n">b_hnp_enable</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">is_active</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_WAIT_ACON</span><span class="p">;</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;HNP: Setting timer for b_ase0_brst</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">otg_timer</span><span class="p">,</span> <span class="n">jiffies</span>
					<span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span>
							<span class="n">OTG_TIME_B_ASE0_BRST</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OTG_STATE_A_WAIT_BCON</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">a_wait_bcon</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">musb_platform_try_idle</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">jiffies</span>
					<span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">a_wait_bcon</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OTG_STATE_A_HOST</span>:
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_SUSPEND</span><span class="p">;</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">is_active</span> <span class="o">=</span> <span class="n">is_otg_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">b_hnp_enable</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OTG_STATE_B_HOST</span>:
			<span class="cm">/* Transition to B_PERIPHERAL, see 6.8.2.6 p 44 */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;REVISIT: SUSPEND as B_HOST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* &quot;should not happen&quot; */</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">is_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_usb</span> <span class="o">&amp;</span> <span class="n">MUSB_INTR_CONNECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">musb_to_hcd</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">is_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">ep0_stage</span> <span class="o">=</span> <span class="n">MUSB_EP0_START</span><span class="p">;</span>

		<span class="cm">/* flush endpoints when transitioning from Device Mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_peripheral_active</span><span class="p">(</span><span class="n">musb</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* REVISIT HNP; just force disconnect */</span>
		<span class="p">}</span>
		<span class="n">musb_writew</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">MUSB_INTRTXE</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">epmask</span><span class="p">);</span>
		<span class="n">musb_writew</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">MUSB_INTRRXE</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">epmask</span> <span class="o">&amp;</span> <span class="mh">0xfffe</span><span class="p">);</span>
		<span class="n">musb_writeb</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">MUSB_INTRUSBE</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">port1_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">USB_PORT_STAT_LOW_SPEED</span>
					<span class="o">|</span><span class="n">USB_PORT_STAT_HIGH_SPEED</span>
					<span class="o">|</span><span class="n">USB_PORT_STAT_ENABLE</span>
					<span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">port1_status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_CONNECTION</span>
					<span class="o">|</span><span class="p">(</span><span class="n">USB_PORT_STAT_C_CONNECTION</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="cm">/* high vs full speed is just a guess until after reset */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_LSDEV</span><span class="p">)</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">port1_status</span> <span class="o">|=</span> <span class="n">USB_PORT_STAT_LOW_SPEED</span><span class="p">;</span>

		<span class="cm">/* indicate new connection to OTG machine */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OTG_STATE_B_PERIPHERAL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">int_usb</span> <span class="o">&amp;</span> <span class="n">MUSB_INTR_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;HNP: SUSPEND+CONNECT, now b_host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">int_usb</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MUSB_INTR_SUSPEND</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">b_host</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;CONNECT as b_peripheral???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OTG_STATE_B_WAIT_ACON</span>:
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;HNP: CONNECT, now b_host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">b_host:</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_HOST</span><span class="p">;</span>
			<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">is_b_host</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">ignore_disconnect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">otg_timer</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_VBUS</span><span class="p">)</span>
					<span class="o">==</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">MUSB_DEVCTL_VBUS_SHIFT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_HOST</span><span class="p">;</span>
				<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">is_b_host</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* poke the root hub */</span>
		<span class="n">MUSB_HST_MODE</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">status_urb</span><span class="p">)</span>
			<span class="n">usb_hcd_poll_rh_status</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">usb_hcd_resume_root_hub</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;CONNECT (%s) devctl %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span> <span class="n">devctl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">int_usb</span> <span class="o">&amp;</span> <span class="n">MUSB_INTR_DISCONNECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">ignore_disconnect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;DISCONNECT (%s) as %s, devctl %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span>
				<span class="n">MUSB_MODE</span><span class="p">(</span><span class="n">musb</span><span class="p">),</span> <span class="n">devctl</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OTG_STATE_A_HOST</span>:
		<span class="k">case</span> <span class="n">OTG_STATE_A_SUSPEND</span>:
			<span class="n">usb_hcd_resume_root_hub</span><span class="p">(</span><span class="n">musb_to_hcd</span><span class="p">(</span><span class="n">musb</span><span class="p">));</span>
			<span class="n">musb_root_disconnect</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">a_wait_bcon</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">is_otg_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">))</span>
				<span class="n">musb_platform_try_idle</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">jiffies</span>
					<span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">a_wait_bcon</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OTG_STATE_B_HOST</span>:
			<span class="cm">/* REVISIT this behaves for &quot;real disconnect&quot;</span>
<span class="cm">			 * cases; make sure the other transitions from</span>
<span class="cm">			 * from B_HOST act right too.  The B_HOST code</span>
<span class="cm">			 * in hnp_stop() is currently not used...</span>
<span class="cm">			 */</span>
			<span class="n">musb_root_disconnect</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
			<span class="n">musb_to_hcd</span><span class="p">(</span><span class="n">musb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">is_b_host</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_PERIPHERAL</span><span class="p">;</span>
			<span class="n">MUSB_DEV_MODE</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
			<span class="n">musb_g_disconnect</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OTG_STATE_A_PERIPHERAL</span>:
			<span class="n">musb_hnp_stop</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
			<span class="n">musb_root_disconnect</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
			<span class="cm">/* FALLTHROUGH */</span>
		<span class="k">case</span> <span class="n">OTG_STATE_B_WAIT_ACON</span>:
			<span class="cm">/* FALLTHROUGH */</span>
		<span class="k">case</span> <span class="n">OTG_STATE_B_PERIPHERAL</span>:
		<span class="k">case</span> <span class="n">OTG_STATE_B_IDLE</span>:
			<span class="n">musb_g_disconnect</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">WARNING</span><span class="p">(</span><span class="s">&quot;unhandled DISCONNECT transition (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* mentor saves a bit: bus reset and babble share the same irq.</span>
<span class="cm">	 * only host sees babble; only peripheral sees bus reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_usb</span> <span class="o">&amp;</span> <span class="n">MUSB_INTR_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_host_capable</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_HM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Looks like non-HS BABBLE can be ignored, but</span>
<span class="cm">			 * HS BABBLE is an error condition. For HS the solution</span>
<span class="cm">			 * is to avoid babble in the first place and fix what</span>
<span class="cm">			 * caused BABBLE. When HS BABBLE happens we can only</span>
<span class="cm">			 * stop the session.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MUSB_DEVCTL_FSDEV</span> <span class="o">|</span> <span class="n">MUSB_DEVCTL_LSDEV</span><span class="p">))</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;BABBLE devctl: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devctl</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">ERR</span><span class="p">(</span><span class="s">&quot;Stopping host session -- babble</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">musb_writeb</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">MUSB_DEVCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_peripheral_capable</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;BUS RESET as %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">OTG_STATE_A_SUSPEND</span>:
				<span class="cm">/* We need to ignore disconnect on suspend</span>
<span class="cm">				 * otherwise tusb 2.0 won&#39;t reconnect after a</span>
<span class="cm">				 * power cycle, which breaks otg compliance.</span>
<span class="cm">				 */</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">ignore_disconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">musb_g_reset</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
				<span class="cm">/* FALLTHROUGH */</span>
			<span class="k">case</span> <span class="n">OTG_STATE_A_WAIT_BCON</span>:	<span class="cm">/* OPT TD.4.7-900ms */</span>
				<span class="cm">/* never use invalid T(a_wait_bcon) */</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;HNP: in %s, %d msec timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span>
					<span class="n">TA_WAIT_BCON</span><span class="p">(</span><span class="n">musb</span><span class="p">));</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">otg_timer</span><span class="p">,</span> <span class="n">jiffies</span>
					<span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">TA_WAIT_BCON</span><span class="p">(</span><span class="n">musb</span><span class="p">)));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OTG_STATE_A_PERIPHERAL</span>:
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">ignore_disconnect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">otg_timer</span><span class="p">);</span>
				<span class="n">musb_g_reset</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OTG_STATE_B_WAIT_ACON</span>:
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;HNP: RESET (%s), to b_peripheral</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_PERIPHERAL</span><span class="p">;</span>
				<span class="n">musb_g_reset</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">OTG_STATE_B_IDLE</span>:
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_PERIPHERAL</span><span class="p">;</span>
				<span class="cm">/* FALLTHROUGH */</span>
			<span class="k">case</span> <span class="n">OTG_STATE_B_PERIPHERAL</span>:
				<span class="n">musb_g_reset</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;Unhandled BUS RESET as %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* REVISIT ... this would be for multiplexing periodic endpoints, or</span>
<span class="c"> * supporting transfer phasing to prevent exceeding ISO bandwidth</span>
<span class="c"> * limits of a given frame or microframe.</span>
<span class="c"> *</span>
<span class="c"> * It&#39;s not needed for peripheral side, which dedicates endpoints;</span>
<span class="c"> * though it _might_ use SOF irqs for other purposes.</span>
<span class="c"> *</span>
<span class="c"> * And it&#39;s not currently needed for host side, which also dedicates</span>
<span class="c"> * endpoints, relies on TX/RX interval registers, and isn&#39;t claimed</span>
<span class="c"> * to support ISO transfers yet.</span>
<span class="c"> */</span>
<span class="c">	if (int_usb &amp; MUSB_INTR_SOF) {</span>
<span class="c">		void __iomem *mbase = musb-&gt;mregs;</span>
<span class="c">		struct musb_hw_ep	*ep;</span>
<span class="c">		u8 epnum;</span>
<span class="c">		u16 frame;</span>

<span class="c">		dev_dbg(musb-&gt;controller, &quot;START_OF_FRAME\n&quot;);</span>
<span class="c">		handled = IRQ_HANDLED;</span>

<span class="c">		/* start any periodic Tx transfers waiting for current frame */</span>
<span class="c">		frame = musb_readw(mbase, MUSB_FRAME);</span>
<span class="c">		ep = musb-&gt;endpoints;</span>
<span class="c">		for (epnum = 1; (epnum &lt; musb-&gt;nr_endpoints)</span>
<span class="c">					&amp;&amp; (musb-&gt;epmask &gt;= (1 &lt;&lt; epnum));</span>
<span class="c">				epnum++, ep++) {</span>
<span class="c">			/*</span>
<span class="c">			 * FIXME handle framecounter wraps (12 bits)</span>
<span class="c">			 * eliminate duplicated StartUrb logic</span>
<span class="c">			 */</span>
<span class="c">			if (ep-&gt;dwWaitFrame &gt;= frame) {</span>
<span class="c">				ep-&gt;dwWaitFrame = 0;</span>
<span class="c">				pr_debug(&quot;SOF --&gt; periodic TX%s on %d\n&quot;,</span>
<span class="c">					ep-&gt;tx_channel ? &quot; DMA&quot; : &quot;&quot;,</span>
<span class="c">					epnum);</span>
<span class="c">				if (!ep-&gt;tx_channel)</span>
<span class="c">					musb_h_tx_start(musb, epnum);</span>
<span class="c">				else</span>
<span class="c">					cppi_hostdma_start(musb, epnum);</span>
<span class="c">			}</span>
<span class="c">		}		/* end of for loop */</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">irq_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm">* Program the HDRC to start (enable interrupts, dma, etc.).</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">musb_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">devctl</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">MUSB_DEVCTL</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;&lt;== devctl %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devctl</span><span class="p">);</span>

	<span class="cm">/*  Set INT enable registers, enable interrupts */</span>
	<span class="n">musb_writew</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">MUSB_INTRTXE</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">epmask</span><span class="p">);</span>
	<span class="n">musb_writew</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">MUSB_INTRRXE</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">epmask</span> <span class="o">&amp;</span> <span class="mh">0xfffe</span><span class="p">);</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">MUSB_INTRUSBE</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">);</span>

	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">MUSB_TESTMODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* put into basic highspeed mode and start session */</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">MUSB_POWER</span><span class="p">,</span> <span class="n">MUSB_POWER_ISOUPDATE</span>
						<span class="o">|</span> <span class="n">MUSB_POWER_HSENAB</span>
						<span class="cm">/* ENSUSPEND wedges tusb */</span>
						<span class="cm">/* | MUSB_POWER_ENSUSPEND */</span>
						<span class="p">);</span>

	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">is_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devctl</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">MUSB_DEVCTL</span><span class="p">);</span>
	<span class="n">devctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MUSB_DEVCTL_SESSION</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_otg_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* session started after:</span>
<span class="cm">		 * (a) ID-grounded irq, host mode;</span>
<span class="cm">		 * (b) vbus present/connect IRQ, peripheral mode;</span>
<span class="cm">		 * (c) peripheral initiates, using SRP</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_VBUS</span><span class="p">)</span> <span class="o">==</span> <span class="n">MUSB_DEVCTL_VBUS</span><span class="p">)</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">is_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devctl</span> <span class="o">|=</span> <span class="n">MUSB_DEVCTL_SESSION</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_host_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* assume ID pin is hard-wired to ground */</span>
		<span class="n">devctl</span> <span class="o">|=</span> <span class="n">MUSB_DEVCTL_SESSION</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* peripheral is enabled */</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_VBUS</span><span class="p">)</span> <span class="o">==</span> <span class="n">MUSB_DEVCTL_VBUS</span><span class="p">)</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">is_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">musb_platform_enable</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">MUSB_DEVCTL</span><span class="p">,</span> <span class="n">devctl</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">musb_generic_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">mbase</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* disable interrupts */</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">MUSB_INTRUSBE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">musb_writew</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">MUSB_INTRTXE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">musb_writew</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">MUSB_INTRRXE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* off */</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">MUSB_DEVCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*  flush pending interrupts */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">MUSB_INTRUSB</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">musb_readw</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">MUSB_INTRTX</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">musb_readw</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">MUSB_INTRRX</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Make the HDRC stop (disable interrupts, etc.);</span>
<span class="cm"> * reversible by musb_start</span>
<span class="cm"> * called on gadget driver unregister</span>
<span class="cm"> * with controller locked, irqs blocked</span>
<span class="cm"> * acts as a NOP unless some role activated the hardware</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">musb_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* stop IRQs, timers, ... */</span>
	<span class="n">musb_platform_disable</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
	<span class="n">musb_generic_disable</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;HDRC disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* FIXME</span>
<span class="cm">	 *  - mark host and/or peripheral drivers unusable/inactive</span>
<span class="cm">	 *  - disable DMA (and enable it in HdrcStart)</span>
<span class="cm">	 *  - make sure we can musb_start() after musb_stop(); with</span>
<span class="cm">	 *    OTG mode, gadget driver module rmmod/modprobe cycles that</span>
<span class="cm">	 *  - ...</span>
<span class="cm">	 */</span>
	<span class="n">musb_platform_try_idle</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">musb_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">musb</span>	<span class="o">*</span><span class="n">musb</span> <span class="o">=</span> <span class="n">dev_to_musb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">);</span>

	<span class="n">musb_gadget_cleanup</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">musb_platform_disable</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
	<span class="n">musb_generic_disable</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_otg_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_host_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">))</span>
		<span class="n">usb_remove_hcd</span><span class="p">(</span><span class="n">musb_to_hcd</span><span class="p">(</span><span class="n">musb</span><span class="p">));</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">MUSB_DEVCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">musb_platform_exit</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">);</span>
	<span class="cm">/* FIXME power down */</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * The silicon either has hard-wired endpoint configurations, or else</span>
<span class="cm"> * &quot;dynamic fifo&quot; sizing.  The driver has support for both, though at this</span>
<span class="cm"> * writing only the dynamic sizing is very well tested.   Since we switched</span>
<span class="cm"> * away from compile-time hardware parameters, we can no longer rely on</span>
<span class="cm"> * dead code elimination to leave only the relevant one in the object file.</span>
<span class="cm"> *</span>
<span class="cm"> * We don&#39;t currently use dynamic fifo setup capability to do anything</span>
<span class="cm"> * more than selecting one of a bunch of predefined configurations.</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_USB_MUSB_TUSB6010)			\</span>
<span class="cp">	|| defined(CONFIG_USB_MUSB_TUSB6010_MODULE)	\</span>
<span class="cp">	|| defined(CONFIG_USB_MUSB_OMAP2PLUS)		\</span>
<span class="cp">	|| defined(CONFIG_USB_MUSB_OMAP2PLUS_MODULE)	\</span>
<span class="cp">	|| defined(CONFIG_USB_MUSB_AM35X)		\</span>
<span class="cp">	|| defined(CONFIG_USB_MUSB_AM35X_MODULE)	\</span>
<span class="cp">	|| defined(CONFIG_USB_MUSB_DSPS)		\</span>
<span class="cp">	|| defined(CONFIG_USB_MUSB_DSPS_MODULE)</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="n">__devinitdata</span> <span class="n">fifo_mode</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_USB_MUSB_UX500)			\</span>
<span class="cp">	|| defined(CONFIG_USB_MUSB_UX500_MODULE)</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="n">__devinitdata</span> <span class="n">fifo_mode</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="n">__devinitdata</span> <span class="n">fifo_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/* &quot;modprobe ... fifo_mode=1&quot; etc */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fifo_mode</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fifo_mode</span><span class="p">,</span> <span class="s">&quot;initial endpoint configuration&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * tables defining fifo_mode values.  define more if you like.</span>
<span class="cm"> * for host side, make sure both halves of ep1 are set up.</span>
<span class="cm"> */</span>

<span class="cm">/* mode 0 - fits in 2KB */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">musb_fifo_cfg</span> <span class="n">__devinitdata</span> <span class="n">mode_0_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* mode 1 - fits in 4KB */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">musb_fifo_cfg</span> <span class="n">__devinitdata</span> <span class="n">mode_1_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">BUF_DOUBLE</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">BUF_DOUBLE</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">BUF_DOUBLE</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* mode 2 - fits in 4KB */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">musb_fifo_cfg</span> <span class="n">__devinitdata</span> <span class="n">mode_2_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* mode 3 - fits in 4KB */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">musb_fifo_cfg</span> <span class="n">__devinitdata</span> <span class="n">mode_3_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">BUF_DOUBLE</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">BUF_DOUBLE</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* mode 4 - fits in 16KB */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">musb_fifo_cfg</span> <span class="n">__devinitdata</span> <span class="n">mode_4_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">6</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">6</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">7</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">7</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">9</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">9</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* mode 5 - fits in 8KB */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">musb_fifo_cfg</span> <span class="n">__devinitdata</span> <span class="n">mode_5_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">6</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">6</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">7</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">7</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">9</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span>  <span class="mi">9</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_TX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RX</span><span class="p">,</span>   <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">},</span>
<span class="p">{</span> <span class="p">.</span><span class="n">hw_ep_num</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * configure a fifo; for non-shared endpoints, this may be called</span>
<span class="cm"> * once for a tx fifo and once for an rx fifo.</span>
<span class="cm"> *</span>
<span class="cm"> * returns negative errno or offset for next fifo.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fifo_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">musb_hw_ep</span>  <span class="o">*</span><span class="n">hw_ep</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">musb_fifo_cfg</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">mbase</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">maxpacket</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maxpacket</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">c_off</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">c_size</span><span class="p">;</span>

	<span class="cm">/* expect hw_ep has already been zero-initialized */</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">maxpacket</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mi">8</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">c_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BUF_DOUBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxpacket</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ram_bits</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
		<span class="n">c_size</span> <span class="o">|=</span> <span class="n">MUSB_FIFOSZ_DPB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="n">maxpacket</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ram_bits</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* configure the FIFO */</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">MUSB_INDEX</span><span class="p">,</span> <span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">);</span>

	<span class="cm">/* EP0 reserved endpoint for control, bidirectional;</span>
<span class="cm">	 * EP1 reserved for bulk, two unidirection halves.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">bulk_ep</span> <span class="o">=</span> <span class="n">hw_ep</span><span class="p">;</span>
	<span class="cm">/* REVISIT error check:  be sure ep0 can both rx and tx ... */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">style</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIFO_TX</span>:
		<span class="n">musb_write_txfifosz</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">c_size</span><span class="p">);</span>
		<span class="n">musb_write_txfifoadd</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">c_off</span><span class="p">);</span>
		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">tx_double_buffered</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">c_size</span> <span class="o">&amp;</span> <span class="n">MUSB_FIFOSZ_DPB</span><span class="p">);</span>
		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">max_packet_sz_tx</span> <span class="o">=</span> <span class="n">maxpacket</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIFO_RX</span>:
		<span class="n">musb_write_rxfifosz</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">c_size</span><span class="p">);</span>
		<span class="n">musb_write_rxfifoadd</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">c_off</span><span class="p">);</span>
		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">rx_double_buffered</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">c_size</span> <span class="o">&amp;</span> <span class="n">MUSB_FIFOSZ_DPB</span><span class="p">);</span>
		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">max_packet_sz_rx</span> <span class="o">=</span> <span class="n">maxpacket</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIFO_RXTX</span>:
		<span class="n">musb_write_txfifosz</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">c_size</span><span class="p">);</span>
		<span class="n">musb_write_txfifoadd</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">c_off</span><span class="p">);</span>
		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">rx_double_buffered</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">c_size</span> <span class="o">&amp;</span> <span class="n">MUSB_FIFOSZ_DPB</span><span class="p">);</span>
		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">max_packet_sz_rx</span> <span class="o">=</span> <span class="n">maxpacket</span><span class="p">;</span>

		<span class="n">musb_write_rxfifosz</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">c_size</span><span class="p">);</span>
		<span class="n">musb_write_rxfifoadd</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">c_off</span><span class="p">);</span>
		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">tx_double_buffered</span> <span class="o">=</span> <span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">rx_double_buffered</span><span class="p">;</span>
		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">max_packet_sz_tx</span> <span class="o">=</span> <span class="n">maxpacket</span><span class="p">;</span>

		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">is_shared_fifo</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NOTE rx and tx endpoint irqs aren&#39;t managed separately,</span>
<span class="cm">	 * which happens to be ok</span>
<span class="cm">	 */</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">epmask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">epnum</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxpacket</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">c_size</span> <span class="o">&amp;</span> <span class="n">MUSB_FIFOSZ_DPB</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">musb_fifo_cfg</span> <span class="n">__devinitdata</span> <span class="n">ep0_cfg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">FIFO_RXTX</span><span class="p">,</span> <span class="p">.</span><span class="n">maxpacket</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ep_config_from_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">musb_fifo_cfg</span>	<span class="o">*</span><span class="n">cfg</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">musb_hw_ep</span>	<span class="o">*</span><span class="n">hw_ep</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">endpoints</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">fifo_cfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">fifo_cfg</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">fifo_cfg_size</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fifo_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">fifo_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* FALLTHROUGH */</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">mode_0_cfg</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mode_0_cfg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">mode_1_cfg</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mode_1_cfg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">mode_2_cfg</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mode_2_cfg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">mode_3_cfg</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mode_3_cfg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">mode_4_cfg</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mode_4_cfg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">mode_5_cfg</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mode_5_cfg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: setup fifo_mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">musb_driver_name</span><span class="p">,</span> <span class="n">fifo_mode</span><span class="p">);</span>


<span class="nl">done:</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">fifo_setup</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">hw_ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep0_cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* assert(offset &gt; 0) */</span>

	<span class="cm">/* NOTE:  for RTL versions &gt;= 1.400 EPINFO and RAMINFO would</span>
<span class="cm">	 * be better than static musb-&gt;config-&gt;num_eps and DYN_FIFO_SIZE...</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span>	<span class="n">epn</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hw_ep_num</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">epn</span> <span class="o">&gt;=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">num_eps</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: invalid ep %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">musb_driver_name</span><span class="p">,</span> <span class="n">epn</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">fifo_setup</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">hw_ep</span> <span class="o">+</span> <span class="n">epn</span><span class="p">,</span> <span class="n">cfg</span><span class="o">++</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: mem overrun, ep %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">musb_driver_name</span><span class="p">,</span> <span class="n">epn</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">epn</span><span class="o">++</span><span class="p">;</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">nr_endpoints</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">epn</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">nr_endpoints</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %d/%d max ep, %d/%d memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">musb_driver_name</span><span class="p">,</span>
			<span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">num_eps</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">ram_bits</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">bulk_ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: missing bulk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">musb_driver_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * ep_config_from_hw - when MUSB_C_DYNFIFO_DEF is false</span>
<span class="cm"> * @param musb the controller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ep_config_from_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">epnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">musb_hw_ep</span> <span class="o">*</span><span class="n">hw_ep</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mbase</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;&lt;== static silicon ep config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* FIXME pick up ep0 maxpacket size */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">epnum</span> <span class="o">&lt;</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">num_eps</span><span class="p">;</span> <span class="n">epnum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">musb_ep_select</span><span class="p">(</span><span class="n">mbase</span><span class="p">,</span> <span class="n">epnum</span><span class="p">);</span>
		<span class="n">hw_ep</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">endpoints</span> <span class="o">+</span> <span class="n">epnum</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">musb_read_fifosize</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">hw_ep</span><span class="p">,</span> <span class="n">epnum</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* FIXME set up hw_ep-&gt;{rx,tx}_double_buffered */</span>

		<span class="cm">/* pick an RX/TX endpoint for bulk */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">max_packet_sz_tx</span> <span class="o">&lt;</span> <span class="mi">512</span>
				<span class="o">||</span> <span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">max_packet_sz_rx</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* REVISIT:  this algorithm is lazy, we should at least</span>
<span class="cm">		 * try to pick a double buffered endpoint.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">bulk_ep</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">bulk_ep</span> <span class="o">=</span> <span class="n">hw_ep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">bulk_ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: missing bulk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">musb_driver_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">MUSB_CONTROLLER_MHDRC</span><span class="p">,</span> <span class="n">MUSB_CONTROLLER_HDRC</span><span class="p">,</span> <span class="p">};</span>

<span class="cm">/* Initialize MUSB (M)HDRC part of the USB hardware subsystem;</span>
<span class="cm"> * configure endpoints, or take their config from silicon</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">musb_core_init</span><span class="p">(</span><span class="n">u16</span> <span class="n">musb_type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">aInfo</span><span class="p">[</span><span class="mi">90</span><span class="p">],</span> <span class="n">aRevision</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">aDate</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">mbase</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

	<span class="cm">/* log core options (read using indexed model) */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">musb_read_configdata</span><span class="p">(</span><span class="n">mbase</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">aInfo</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MUSB_CONFIGDATA_UTMIDW</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;UTMI-16&quot;</span> <span class="o">:</span> <span class="s">&quot;UTMI-8&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MUSB_CONFIGDATA_DYNFIFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">aInfo</span><span class="p">,</span> <span class="s">&quot;, dyn FIFOs&quot;</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">dyn_fifo</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MUSB_CONFIGDATA_MPRXE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">aInfo</span><span class="p">,</span> <span class="s">&quot;, bulk combine&quot;</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">bulk_combine</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MUSB_CONFIGDATA_MPTXE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">aInfo</span><span class="p">,</span> <span class="s">&quot;, bulk split&quot;</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">bulk_split</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MUSB_CONFIGDATA_HBRXE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">aInfo</span><span class="p">,</span> <span class="s">&quot;, HB-ISO Rx&quot;</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">hb_iso_rx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MUSB_CONFIGDATA_HBTXE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">aInfo</span><span class="p">,</span> <span class="s">&quot;, HB-ISO Tx&quot;</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">hb_iso_tx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MUSB_CONFIGDATA_SOFTCONE</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">aInfo</span><span class="p">,</span> <span class="s">&quot;, SoftConn&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: ConfigData=0x%02x (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">musb_driver_name</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">aInfo</span><span class="p">);</span>

	<span class="n">aDate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MUSB_CONTROLLER_MHDRC</span> <span class="o">==</span> <span class="n">musb_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">is_multipoint</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;M&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">is_multipoint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="cp">#ifndef	CONFIG_USB_OTG_BLACKLIST_HUB</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: kernel must blacklist external hubs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">musb_driver_name</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* log release info */</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">hwvers</span> <span class="o">=</span> <span class="n">musb_read_hwvers</span><span class="p">(</span><span class="n">mbase</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">aRevision</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;%d.%d%s&quot;</span><span class="p">,</span> <span class="n">MUSB_HWVERS_MAJOR</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">hwvers</span><span class="p">),</span>
		<span class="n">MUSB_HWVERS_MINOR</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">hwvers</span><span class="p">),</span>
		<span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">hwvers</span> <span class="o">&amp;</span> <span class="n">MUSB_HWVERS_RC</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %sHDRC RTL version %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">musb_driver_name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">aRevision</span><span class="p">,</span> <span class="n">aDate</span><span class="p">);</span>

	<span class="cm">/* configure ep0 */</span>
	<span class="n">musb_configure_ep0</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

	<span class="cm">/* discover endpoint configuration */</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">nr_endpoints</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">epmask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">dyn_fifo</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ep_config_from_table</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ep_config_from_hw</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* finish init, and print endpoint config */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">nr_endpoints</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">musb_hw_ep</span>	<span class="o">*</span><span class="n">hw_ep</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">endpoints</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">MUSB_FIFO_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">mbase</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_USB_MUSB_TUSB6010) || defined (CONFIG_USB_MUSB_TUSB6010_MODULE)</span>
		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">fifo_async</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">async</span> <span class="o">+</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="n">MUSB_FIFO_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">fifo_sync</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">+</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="n">MUSB_FIFO_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">fifo_sync_va</span> <span class="o">=</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">sync_va</span> <span class="o">+</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="n">MUSB_FIFO_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mbase</span> <span class="o">-</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="n">TUSB_EP0_CONF</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">conf</span> <span class="o">=</span> <span class="n">mbase</span> <span class="o">+</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="p">(((</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">MUSB_EP_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">mbase</span><span class="p">;</span>
		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">target_regs</span> <span class="o">=</span> <span class="n">musb_read_target_reg_base</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mbase</span><span class="p">);</span>
		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">rx_reinit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">tx_reinit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">max_packet_sz_tx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span>
				<span class="s">&quot;%s: hw_ep %d%s, %smax %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">musb_driver_name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">is_shared_fifo</span> <span class="o">?</span> <span class="s">&quot;shared&quot;</span> <span class="o">:</span> <span class="s">&quot;tx&quot;</span><span class="p">,</span>
				<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">tx_double_buffered</span>
					<span class="o">?</span> <span class="s">&quot;doublebuffer, &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">max_packet_sz_tx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">max_packet_sz_rx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">is_shared_fifo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span>
				<span class="s">&quot;%s: hw_ep %d%s, %smax %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">musb_driver_name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="s">&quot;rx&quot;</span><span class="p">,</span>
				<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">rx_double_buffered</span>
					<span class="o">?</span> <span class="s">&quot;doublebuffer, &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">max_packet_sz_rx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">max_packet_sz_tx</span> <span class="o">||</span> <span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">max_packet_sz_rx</span><span class="p">))</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;hw_ep %d not configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#if defined(CONFIG_SOC_OMAP2430) || defined(CONFIG_SOC_OMAP3430) || \</span>
<span class="cp">	defined(CONFIG_ARCH_OMAP4) || defined(CONFIG_ARCH_U8500)</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">generic_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__hci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">irqreturn_t</span>	<span class="n">retval</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">musb</span>	<span class="o">*</span><span class="n">musb</span> <span class="o">=</span> <span class="n">__hci</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_usb</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">MUSB_INTRUSB</span><span class="p">);</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_tx</span> <span class="o">=</span> <span class="n">musb_readw</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">MUSB_INTRTX</span><span class="p">);</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_rx</span> <span class="o">=</span> <span class="n">musb_readw</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">MUSB_INTRRX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_usb</span> <span class="o">||</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_tx</span> <span class="o">||</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_rx</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">musb_interrupt</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define generic_interrupt	NULL</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * handle all the irqs defined by the HDRC core. for now we expect:  other</span>
<span class="cm"> * irq sources (phy, dma, etc) will be handled first, musb-&gt;int_* values</span>
<span class="cm"> * will be assigned, and the irq will already have been acked.</span>
<span class="cm"> *</span>
<span class="cm"> * called in irq context with spinlock held, irqs blocked</span>
<span class="cm"> */</span>
<span class="n">irqreturn_t</span> <span class="nf">musb_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqreturn_t</span>	<span class="n">retval</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">devctl</span><span class="p">,</span> <span class="n">power</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ep_num</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">reg</span><span class="p">;</span>

	<span class="n">devctl</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">MUSB_DEVCTL</span><span class="p">);</span>
	<span class="n">power</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">MUSB_POWER</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;** IRQ %s usb%04x tx%04x rx%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_HM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;host&quot;</span> <span class="o">:</span> <span class="s">&quot;peripheral&quot;</span><span class="p">,</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_usb</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_tx</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_rx</span><span class="p">);</span>

	<span class="cm">/* the core can interrupt us for multiple reasons; docs have</span>
<span class="cm">	 * a generic interrupt flowchart to follow</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_usb</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">musb_stage0_irq</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_usb</span><span class="p">,</span>
				<span class="n">devctl</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>

	<span class="cm">/* &quot;stage 1&quot; is handling endpoint irqs */</span>

	<span class="cm">/* handle endpoint 0 first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_tx</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_HM</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">|=</span> <span class="n">musb_h_ep0_irq</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">retval</span> <span class="o">|=</span> <span class="n">musb_g_ep0_irq</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* RX on endpoints 1-15 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_rx</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ep_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* musb_ep_select(musb-&gt;mregs, ep_num); */</span>
			<span class="cm">/* REVISIT just retval = ep-&gt;rx_irq(...) */</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_HM</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_host_capable</span><span class="p">())</span>
					<span class="n">musb_host_rx</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">ep_num</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_peripheral_capable</span><span class="p">())</span>
					<span class="n">musb_g_rx</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">ep_num</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ep_num</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TX on endpoints 1-15 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">int_tx</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ep_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* musb_ep_select(musb-&gt;mregs, ep_num); */</span>
			<span class="cm">/* REVISIT just retval |= ep-&gt;tx_irq(...) */</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_HM</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_host_capable</span><span class="p">())</span>
					<span class="n">musb_host_tx</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">ep_num</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_peripheral_capable</span><span class="p">())</span>
					<span class="n">musb_g_tx</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">ep_num</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ep_num</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">musb_interrupt</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_MUSB_PIO_ONLY</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">__devinitdata</span> <span class="n">use_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/* &quot;modprobe ... use_dma=0&quot; etc */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_dma</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_dma</span><span class="p">,</span> <span class="s">&quot;enable/disable use of DMA&quot;</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">musb_dma_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span><span class="p">,</span> <span class="n">u8</span> <span class="n">epnum</span><span class="p">,</span> <span class="n">u8</span> <span class="n">transmit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>	<span class="n">devctl</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">MUSB_DEVCTL</span><span class="p">);</span>

	<span class="cm">/* called with controller lock already held */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">epnum</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef CONFIG_USB_TUSB_OMAP_DMA</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cppi_enabled</span><span class="p">())</span> <span class="p">{</span>
			<span class="cm">/* endpoint 0 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_HM</span><span class="p">)</span>
				<span class="n">musb_h_ep0_irq</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">musb_g_ep0_irq</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* endpoints 1..15 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">transmit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_HM</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_host_capable</span><span class="p">())</span>
					<span class="n">musb_host_tx</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">epnum</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_peripheral_capable</span><span class="p">())</span>
					<span class="n">musb_g_tx</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">epnum</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* receive */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_HM</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_host_capable</span><span class="p">())</span>
					<span class="n">musb_host_rx</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">epnum</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_peripheral_capable</span><span class="p">())</span>
					<span class="n">musb_g_rx</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">epnum</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">musb_dma_completion</span><span class="p">);</span>

<span class="cp">#else</span>
<span class="cp">#define use_dma			0</span>
<span class="cp">#endif</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef CONFIG_SYSFS</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">musb_mode_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span> <span class="o">=</span> <span class="n">dev_to_musb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">otg_state_string</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">musb_mode_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">musb</span>	<span class="o">*</span><span class="n">musb</span> <span class="o">=</span> <span class="n">dev_to_musb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sysfs_streq</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;host&quot;</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">musb_platform_set_mode</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">MUSB_HOST</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sysfs_streq</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;peripheral&quot;</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">musb_platform_set_mode</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">MUSB_PERIPHERAL</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sysfs_streq</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;otg&quot;</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">musb_platform_set_mode</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">MUSB_OTG</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">n</span> <span class="o">:</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">musb_mode_show</span><span class="p">,</span> <span class="n">musb_mode_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">musb_vbus_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">musb</span>	<span class="o">*</span><span class="n">musb</span> <span class="o">=</span> <span class="n">dev_to_musb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid VBUS timeout ms value</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* force T(a_wait_bcon) to be zero/unlimited *OR* valid */</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">a_wait_bcon</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">OTG_TIME_A_WAIT_BCON</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">OTG_STATE_A_WAIT_BCON</span><span class="p">)</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">is_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">musb_platform_try_idle</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">musb_vbus_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">musb</span>	<span class="o">*</span><span class="n">musb</span> <span class="o">=</span> <span class="n">dev_to_musb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">vbus</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">a_wait_bcon</span><span class="p">;</span>
	<span class="cm">/* FIXME get_vbus_status() is normally #defined as false...</span>
<span class="cm">	 * and is effectively TUSB-specific.</span>
<span class="cm">	 */</span>
	<span class="n">vbus</span> <span class="o">=</span> <span class="n">musb_platform_get_vbus_status</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Vbus %s, timeout %lu msec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vbus</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">vbus</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">musb_vbus_show</span><span class="p">,</span> <span class="n">musb_vbus_store</span><span class="p">);</span>

<span class="cm">/* Gadget drivers can&#39;t know that a host is connected so they might want</span>
<span class="cm"> * to start SRP, but users can.  This allows userspace to trigger SRP.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">musb_srp_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">musb</span>	<span class="o">*</span><span class="n">musb</span> <span class="o">=</span> <span class="n">dev_to_musb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">srp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%hu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">srp</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SRP: Value must be 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">musb_g_wakeup</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">srp</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">musb_srp_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">musb_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_vbus</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_srp</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">musb_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">musb_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif	</span><span class="cm">/* sysfs */</span><span class="cp"></span>

<span class="cm">/* Only used to provide driver mode change events */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">musb_irq_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">musb</span><span class="p">,</span> <span class="n">irq_work</span><span class="p">);</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">old_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">old_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">old_state</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
		<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;mode&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm"> * Init support</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">__devinit</span>
<span class="nf">allocate_instance</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">musb_hdrc_config</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mbase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">musb</span>		<span class="o">*</span><span class="n">musb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">musb_hw_ep</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">epnum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_hcd</span>	<span class="o">*</span><span class="n">hcd</span><span class="p">;</span>

	<span class="n">hcd</span> <span class="o">=</span> <span class="n">usb_create_hcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb_hc_driver</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hcd</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* usbcore sets dev-&gt;driver_data to hcd, and sometimes uses that... */</span>

	<span class="n">musb</span> <span class="o">=</span> <span class="n">hcd_to_musb</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">in_bulk</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">out_bulk</span><span class="p">);</span>

	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">uses_new_polling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">has_tt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">vbuserr_retry</span> <span class="o">=</span> <span class="n">VBUSERR_RETRY_COUNT</span><span class="p">;</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">a_wait_bcon</span> <span class="o">=</span> <span class="n">OTG_TIME_A_WAIT_BCON</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">musb</span><span class="p">);</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span> <span class="o">=</span> <span class="n">mbase</span><span class="p">;</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">ctrl_base</span> <span class="o">=</span> <span class="n">mbase</span><span class="p">;</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">nIrq</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">num_eps</span> <span class="o">&gt;</span> <span class="n">MUSB_C_NUM_EPS</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">epnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ep</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">endpoints</span><span class="p">;</span>
			<span class="n">epnum</span> <span class="o">&lt;</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">num_eps</span><span class="p">;</span>
			<span class="n">epnum</span><span class="o">++</span><span class="p">,</span> <span class="n">ep</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">musb</span> <span class="o">=</span> <span class="n">musb</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">epnum</span> <span class="o">=</span> <span class="n">epnum</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">musb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">musb_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* this has multiple entry modes. it handles fault cleanup after</span>
<span class="cm">	 * probe(), where things may be partially set up, as well as rmmod</span>
<span class="cm">	 * cleanup after everything&#39;s been de-activated.</span>
<span class="cm">	 */</span>

<span class="cp">#ifdef CONFIG_SYSFS</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">musb_attr_group</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">nIrq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">irq_wake</span><span class="p">)</span>
			<span class="n">disable_irq_wake</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">nIrq</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">nIrq</span><span class="p">,</span> <span class="n">musb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_dma_capable</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">dma_controller</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dma_controller</span>	<span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">dma_controller</span><span class="p">;</span>

		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">dma_controller_destroy</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform generic per-controller initialization.</span>
<span class="cm"> *</span>
<span class="cm"> * @pDevice: the controller (already clocked, etc)</span>
<span class="cm"> * @nIrq: irq</span>
<span class="cm"> * @mregs: virtual address of controller registers,</span>
<span class="cm"> *	not yet corrected for platform-specific offsets</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">musb_init_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nIrq</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">musb</span>		<span class="o">*</span><span class="n">musb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">musb_hdrc_platform_data</span> <span class="o">*</span><span class="n">plat</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="cm">/* The driver might handle more features than the board; OK.</span>
<span class="cm">	 * Fail when the board needs a feature that&#39;s not enabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform_data?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate */</span>
	<span class="n">musb</span> <span class="o">=</span> <span class="n">allocate_instance</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">musb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_use_autosuspend</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">);</span>
	<span class="n">pm_runtime_set_autosuspend_delay</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">board_mode</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">board_set_power</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">;</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">min_power</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">min_power</span><span class="p">;</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">platform_ops</span><span class="p">;</span>

	<span class="cm">/* The musb_platform_init() call:</span>
<span class="cm">	 *   - adjusts musb-&gt;mregs and musb-&gt;isr if needed,</span>
<span class="cm">	 *   - may initialize an integrated tranceiver</span>
<span class="cm">	 *   - initializes musb-&gt;xceiv, usually by otg_get_transceiver()</span>
<span class="cm">	 *   - stops powering VBUS</span>
<span class="cm">	 *</span>
<span class="cm">	 * There are various transceiver configurations.  Blackfin,</span>
<span class="cm">	 * DaVinci, TUSB60x0, and others integrate them.  OMAP3 uses</span>
<span class="cm">	 * external/discrete ones in various flavors (twl4030 family,</span>
<span class="cm">	 * isp1504, non-OTG, etc) mostly hooking up through ULPI.</span>
<span class="cm">	 */</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">=</span> <span class="n">generic_interrupt</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">musb_platform_init</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">io_ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">io_dev</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">;</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">io_priv</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">;</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">io_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">musb_ulpi_access</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_MUSB_PIO_ONLY</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dma_controller</span>	<span class="o">*</span><span class="n">c</span><span class="p">;</span>

		<span class="n">c</span> <span class="o">=</span> <span class="n">dma_controller_create</span><span class="p">(</span><span class="n">musb</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">dma_controller</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* ideally this would be abstracted in platform setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_dma_capable</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">dma_controller</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* be sure interrupts are disabled before connecting ISR */</span>
	<span class="n">musb_platform_disable</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
	<span class="n">musb_generic_disable</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

	<span class="cm">/* setup musb parts of the core (especially endpoints) */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">musb_core_init</span><span class="p">(</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">multipoint</span>
			<span class="o">?</span> <span class="n">MUSB_CONTROLLER_MHDRC</span>
			<span class="o">:</span> <span class="n">MUSB_CONTROLLER_HDRC</span><span class="p">,</span> <span class="n">musb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">otg_timer</span><span class="p">,</span> <span class="n">musb_otg_timer_func</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">musb</span><span class="p">);</span>

	<span class="cm">/* Init IRQ workqueue before request_irq */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">irq_work</span><span class="p">,</span> <span class="n">musb_irq_work</span><span class="p">);</span>

	<span class="cm">/* attach to the IRQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">nIrq</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">musb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_irq %d failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nIrq</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">nIrq</span> <span class="o">=</span> <span class="n">nIrq</span><span class="p">;</span>
<span class="cm">/* FIXME this handles wakeup irqs wrong */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_irq_wake</span><span class="p">(</span><span class="n">nIrq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">irq_wake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">device_init_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">irq_wake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* host side needs more setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_host_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_hcd</span>	<span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">musb_to_hcd</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

		<span class="n">otg_set_host</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_otg_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">))</span>
			<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">otg_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">power_budget</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">250</span><span class="p">);</span>

		<span class="cm">/* program PHY to use external vBus if required */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">extvbus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">busctl</span> <span class="o">=</span> <span class="n">musb_read_ulpi_buscontrol</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">);</span>
			<span class="n">busctl</span> <span class="o">|=</span> <span class="n">MUSB_ULPI_USE_EXTVBUS</span><span class="p">;</span>
			<span class="n">musb_write_ulpi_buscontrol</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">busctl</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* For the host-only role, we can activate right away.</span>
<span class="cm">	 * (We expect the ID pin to be forcibly grounded!!)</span>
<span class="cm">	 * Otherwise, wait till the gadget driver hooks up.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_otg_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_host_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_hcd</span>	<span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">musb_to_hcd</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

		<span class="n">MUSB_HST_MODE</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">default_a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_A_IDLE</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_add_hcd</span><span class="p">(</span><span class="n">musb_to_hcd</span><span class="p">(</span><span class="n">musb</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">uses_pio_for_control</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;%s mode, status %d, devctl %02x %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;HOST&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			<span class="n">musb_readb</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">MUSB_DEVCTL</span><span class="p">),</span>
			<span class="p">(</span><span class="n">musb_readb</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">MUSB_DEVCTL</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="n">MUSB_DEVCTL_BDEVICE</span>
				<span class="o">?</span> <span class="sc">&#39;B&#39;</span> <span class="o">:</span> <span class="sc">&#39;A&#39;</span><span class="p">));</span>

	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* peripheral is enabled */</span> <span class="p">{</span>
		<span class="n">MUSB_DEV_MODE</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">otg</span><span class="o">-&gt;</span><span class="n">default_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">xceiv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OTG_STATE_B_IDLE</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">musb_gadget_setup</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;%s mode, status %d, dev%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">is_otg_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;OTG&quot;</span> <span class="o">:</span> <span class="s">&quot;PERIPHERAL&quot;</span><span class="p">,</span>
			<span class="n">status</span><span class="p">,</span>
			<span class="n">musb_readb</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">MUSB_DEVCTL</span><span class="p">));</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">musb_init_debugfs</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail4</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SYSFS</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">musb_attr_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail5</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB %s mode controller at %p using %s, IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">({</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
			 <span class="k">switch</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">board_mode</span><span class="p">)</span> <span class="p">{</span>
			 <span class="k">case</span> <span class="n">MUSB_HOST</span>:		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Host&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			 <span class="k">case</span> <span class="n">MUSB_PERIPHERAL</span>:	<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Peripheral&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			 <span class="nl">default:</span>		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;OTG&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			 <span class="p">};</span> <span class="n">s</span><span class="p">;</span> <span class="p">}),</span>
			<span class="n">ctrl</span><span class="p">,</span>
			<span class="p">(</span><span class="n">is_dma_capable</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">dma_controller</span><span class="p">)</span>
			<span class="o">?</span> <span class="s">&quot;DMA&quot;</span> <span class="o">:</span> <span class="s">&quot;PIO&quot;</span><span class="p">,</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">nIrq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail5:</span>
	<span class="n">musb_exit_debugfs</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

<span class="nl">fail4:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_otg_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_host_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">))</span>
		<span class="n">usb_remove_hcd</span><span class="p">(</span><span class="n">musb_to_hcd</span><span class="p">(</span><span class="n">musb</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">musb_gadget_cleanup</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

<span class="nl">fail3:</span>
	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">);</span>

<span class="nl">fail2:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">irq_wake</span><span class="p">)</span>
		<span class="n">device_init_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">musb_platform_exit</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

<span class="nl">fail1:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">,</span>
		<span class="s">&quot;musb_init_controller failed with status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">musb_free</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

<span class="nl">fail0:</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* all implementations (PCI bridge to FPGA, VLYNQ, etc) should just</span>
<span class="cm"> * bridge to a platform device; this driver then suffices.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef CONFIG_MUSB_PIO_ONLY</span>
<span class="k">static</span> <span class="n">u64</span>	<span class="o">*</span><span class="n">orig_dma_mask</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">musb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;mc&quot;</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>	<span class="o">*</span><span class="n">iomem</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="n">iomem</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iomem</span> <span class="o">||</span> <span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">iomem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">iomem</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ioremap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifndef CONFIG_MUSB_PIO_ONLY</span>
	<span class="cm">/* clobbered by use_dma=n */</span>
	<span class="n">orig_dma_mask</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">musb_init_controller</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">musb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">musb</span>	<span class="o">*</span><span class="n">musb</span> <span class="o">=</span> <span class="n">dev_to_musb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">ctrl_base</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">ctrl_base</span><span class="p">;</span>

	<span class="cm">/* this gets called on rmmod.</span>
<span class="cm">	 *  - Host mode: host may still be active</span>
<span class="cm">	 *  - Peripheral mode: peripheral is deactivated (or never-activated)</span>
<span class="cm">	 *  - OTG mode: both roles are deactivated (or never-activated)</span>
<span class="cm">	 */</span>
	<span class="n">musb_exit_debugfs</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
	<span class="n">musb_shutdown</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">musb_free</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ctrl_base</span><span class="p">);</span>
	<span class="n">device_init_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifndef CONFIG_MUSB_PIO_ONLY</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">orig_dma_mask</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef	CONFIG_PM</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">musb_save_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">musb_base</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">epio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_host_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">musb_readw</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_FRAME</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">testmode</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_TESTMODE</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">busctl</span> <span class="o">=</span> <span class="n">musb_read_ulpi_buscontrol</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_POWER</span><span class="p">);</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">intrtxe</span> <span class="o">=</span> <span class="n">musb_readw</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_INTRTXE</span><span class="p">);</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">intrrxe</span> <span class="o">=</span> <span class="n">musb_readw</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_INTRRXE</span><span class="p">);</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">intrusbe</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_INTRUSBE</span><span class="p">);</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_INDEX</span><span class="p">);</span>
	<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">devctl</span> <span class="o">=</span> <span class="n">musb_readb</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_DEVCTL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">num_eps</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">musb_hw_ep</span>	<span class="o">*</span><span class="n">hw_ep</span><span class="p">;</span>

		<span class="n">hw_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">endpoints</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw_ep</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">epio</span> <span class="o">=</span> <span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">epio</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">musb_writeb</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_INDEX</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txmaxp</span> <span class="o">=</span>
			<span class="n">musb_readw</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_TXMAXP</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txcsr</span> <span class="o">=</span>
			<span class="n">musb_readw</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_TXCSR</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxmaxp</span> <span class="o">=</span>
			<span class="n">musb_readw</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_RXMAXP</span><span class="p">);</span>
		<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxcsr</span> <span class="o">=</span>
			<span class="n">musb_readw</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_RXCSR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">dyn_fifo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txfifoadd</span> <span class="o">=</span>
					<span class="n">musb_read_txfifoadd</span><span class="p">(</span><span class="n">musb_base</span><span class="p">);</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxfifoadd</span> <span class="o">=</span>
					<span class="n">musb_read_rxfifoadd</span><span class="p">(</span><span class="n">musb_base</span><span class="p">);</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txfifosz</span> <span class="o">=</span>
					<span class="n">musb_read_txfifosz</span><span class="p">(</span><span class="n">musb_base</span><span class="p">);</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxfifosz</span> <span class="o">=</span>
					<span class="n">musb_read_rxfifosz</span><span class="p">(</span><span class="n">musb_base</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_host_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txtype</span> <span class="o">=</span>
				<span class="n">musb_readb</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_TXTYPE</span><span class="p">);</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txinterval</span> <span class="o">=</span>
				<span class="n">musb_readb</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_TXINTERVAL</span><span class="p">);</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxtype</span> <span class="o">=</span>
				<span class="n">musb_readb</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_RXTYPE</span><span class="p">);</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxinterval</span> <span class="o">=</span>
				<span class="n">musb_readb</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_RXINTERVAL</span><span class="p">);</span>

			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txfunaddr</span> <span class="o">=</span>
				<span class="n">musb_read_txfunaddr</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txhubaddr</span> <span class="o">=</span>
				<span class="n">musb_read_txhubaddr</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txhubport</span> <span class="o">=</span>
				<span class="n">musb_read_txhubport</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxfunaddr</span> <span class="o">=</span>
				<span class="n">musb_read_rxfunaddr</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxhubaddr</span> <span class="o">=</span>
				<span class="n">musb_read_rxhubaddr</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxhubport</span> <span class="o">=</span>
				<span class="n">musb_read_rxhubport</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">musb_restore_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">musb</span> <span class="o">*</span><span class="n">musb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">musb_base</span> <span class="o">=</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ep_target_regs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">epio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_host_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">musb_writew</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_FRAME</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">frame</span><span class="p">);</span>
		<span class="n">musb_writeb</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_TESTMODE</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">testmode</span><span class="p">);</span>
		<span class="n">musb_write_ulpi_buscontrol</span><span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">mregs</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">busctl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_POWER</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">power</span><span class="p">);</span>
	<span class="n">musb_writew</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_INTRTXE</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">intrtxe</span><span class="p">);</span>
	<span class="n">musb_writew</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_INTRRXE</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">intrrxe</span><span class="p">);</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_INTRUSBE</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">intrusbe</span><span class="p">);</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_DEVCTL</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">devctl</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">num_eps</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">musb_hw_ep</span>	<span class="o">*</span><span class="n">hw_ep</span><span class="p">;</span>

		<span class="n">hw_ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">endpoints</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw_ep</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">epio</span> <span class="o">=</span> <span class="n">hw_ep</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">epio</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">musb_writeb</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_INDEX</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">musb_writew</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_TXMAXP</span><span class="p">,</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txmaxp</span><span class="p">);</span>
		<span class="n">musb_writew</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_TXCSR</span><span class="p">,</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txcsr</span><span class="p">);</span>
		<span class="n">musb_writew</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_RXMAXP</span><span class="p">,</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxmaxp</span><span class="p">);</span>
		<span class="n">musb_writew</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_RXCSR</span><span class="p">,</span>
			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxcsr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">dyn_fifo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">musb_write_txfifosz</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txfifosz</span><span class="p">);</span>
			<span class="n">musb_write_rxfifosz</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxfifosz</span><span class="p">);</span>
			<span class="n">musb_write_txfifoadd</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txfifoadd</span><span class="p">);</span>
			<span class="n">musb_write_rxfifoadd</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxfifoadd</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_host_enabled</span><span class="p">(</span><span class="n">musb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">musb_writeb</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_TXTYPE</span><span class="p">,</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txtype</span><span class="p">);</span>
			<span class="n">musb_writeb</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_TXINTERVAL</span><span class="p">,</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txinterval</span><span class="p">);</span>
			<span class="n">musb_writeb</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_RXTYPE</span><span class="p">,</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxtype</span><span class="p">);</span>
			<span class="n">musb_writeb</span><span class="p">(</span><span class="n">epio</span><span class="p">,</span> <span class="n">MUSB_RXINTERVAL</span><span class="p">,</span>

			<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxinterval</span><span class="p">);</span>
			<span class="n">musb_write_txfunaddr</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txfunaddr</span><span class="p">);</span>
			<span class="n">musb_write_txhubaddr</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txhubaddr</span><span class="p">);</span>
			<span class="n">musb_write_txhubport</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txhubport</span><span class="p">);</span>

			<span class="n">ep_target_regs</span> <span class="o">=</span>
				<span class="n">musb_read_target_reg_base</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">musb_base</span><span class="p">);</span>

			<span class="n">musb_write_rxfunaddr</span><span class="p">(</span><span class="n">ep_target_regs</span><span class="p">,</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxfunaddr</span><span class="p">);</span>
			<span class="n">musb_write_rxhubaddr</span><span class="p">(</span><span class="n">ep_target_regs</span><span class="p">,</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxhubaddr</span><span class="p">);</span>
			<span class="n">musb_write_rxhubport</span><span class="p">(</span><span class="n">ep_target_regs</span><span class="p">,</span>
				<span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rxhubport</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">musb_writeb</span><span class="p">(</span><span class="n">musb_base</span><span class="p">,</span> <span class="n">MUSB_INDEX</span><span class="p">,</span> <span class="n">musb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">musb_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">musb</span>	<span class="o">*</span><span class="n">musb</span> <span class="o">=</span> <span class="n">dev_to_musb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_peripheral_active</span><span class="p">(</span><span class="n">musb</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* FIXME force disconnect unless we know USB will wake</span>
<span class="cm">		 * the system up quickly enough to respond ...</span>
<span class="cm">		 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_host_active</span><span class="p">(</span><span class="n">musb</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* we know all the children are suspended; sometimes</span>
<span class="cm">		 * they will even be wakeup-enabled.</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">musb_resume_noirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* for static cmos like DaVinci, register values were preserved</span>
<span class="cm">	 * unless for some reason the whole soc powered down or the USB</span>
<span class="cm">	 * module got reset through the PSC (vs just being disabled).</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">musb_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">musb</span>	<span class="o">*</span><span class="n">musb</span> <span class="o">=</span> <span class="n">dev_to_musb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">musb_save_context</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">musb_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">musb</span>	<span class="o">*</span><span class="n">musb</span> <span class="o">=</span> <span class="n">dev_to_musb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">static</span> <span class="kt">int</span>	<span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * When pm_runtime_get_sync called for the first time in driver</span>
<span class="cm">	 * init,  some of the structure is still not initialized which is</span>
<span class="cm">	 * used in restore function. But clock needs to be</span>
<span class="cm">	 * enabled before any register access, so</span>
<span class="cm">	 * pm_runtime_get_sync has to be called.</span>
<span class="cm">	 * Also context restore without save does not make</span>
<span class="cm">	 * any sense</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span>
		<span class="n">musb_restore_context</span><span class="p">(</span><span class="n">musb</span><span class="p">);</span>
	<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">musb_dev_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">musb_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume_noirq</span>	<span class="o">=</span> <span class="n">musb_resume_noirq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_suspend</span> <span class="o">=</span> <span class="n">musb_runtime_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_resume</span> <span class="o">=</span> <span class="n">musb_runtime_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define MUSB_DEV_PM_OPS (&amp;musb_dev_pm_ops)</span>
<span class="cp">#else</span>
<span class="cp">#define	MUSB_DEV_PM_OPS	NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">musb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">musb_driver_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bus</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>		<span class="o">=</span> <span class="n">MUSB_DEV_PM_OPS</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">musb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">musb_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">musb_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">musb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_disabled</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: version &quot;</span> <span class="n">MUSB_VERSION</span> <span class="s">&quot;, &quot;</span>
		<span class="s">&quot;?dma?&quot;</span>
		<span class="s">&quot;, &quot;</span>
		<span class="s">&quot;otg (peripheral+host)&quot;</span><span class="p">,</span>
		<span class="n">musb_driver_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">musb_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">musb_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">musb_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">musb_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
