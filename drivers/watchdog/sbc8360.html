<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › watchdog › sbc8360.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sbc8360.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	SBC8360 Watchdog driver</span>
<span class="cm"> *</span>
<span class="cm"> *	(c) Copyright 2005 Webcon, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *	Based on ib700wdt.c, which is based on advantechwdt.c which is based</span>
<span class="cm"> *	on acquirewdt.c which is based on wdt.c.</span>
<span class="cm"> *</span>
<span class="cm"> *	(c) Copyright 2001 Charles Howes &lt;chowes@vsol.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	Based on advantechwdt.c which is based on acquirewdt.c which</span>
<span class="cm"> *	is based on wdt.c.</span>
<span class="cm"> *</span>
<span class="cm"> *	(c) Copyright 2000-2001 Marek Michalkiewicz &lt;marekm@linux.org.pl&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	Based on acquirewdt.c which is based on wdt.c.</span>
<span class="cm"> *	Original copyright messages:</span>
<span class="cm"> *</span>
<span class="cm"> *	(c) Copyright 1996 Alan Cox &lt;alan@lxorguk.ukuu.org.uk&gt;,</span>
<span class="cm"> *						All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License</span>
<span class="cm"> *	as published by the Free Software Foundation; either version</span>
<span class="cm"> *	2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	Neither Alan Cox nor CymruNet Ltd. admit liability nor provide</span>
<span class="cm"> *	warranty for any of this software. This material is provided</span>
<span class="cm"> *	&quot;AS-IS&quot; and at no charge.</span>
<span class="cm"> *</span>
<span class="cm"> *	(c) Copyright 1995    Alan Cox &lt;alan@lxorguk.ukuu.org.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	14-Dec-2001 Matt Domsch &lt;Matt_Domsch@dell.com&gt;</span>
<span class="cm"> *	     Added nowayout module option to override CONFIG_WATCHDOG_NOWAYOUT</span>
<span class="cm"> *	     Added timeout module option to override default</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/watchdog.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sbc8360_is_open</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">expect_close</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Watchdog Timer Configuration</span>
<span class="cm"> *</span>
<span class="cm"> * The function of the watchdog timer is to reset the system automatically</span>
<span class="cm"> * and is defined at I/O port 0120H and 0121H.  To enable the watchdog timer</span>
<span class="cm"> * and allow the system to reset, write appropriate values from the table</span>
<span class="cm"> * below to I/O port 0120H and 0121H.  To disable the timer, write a zero</span>
<span class="cm"> * value to I/O port 0121H for the system to stop the watchdog function.</span>
<span class="cm"> *</span>
<span class="cm"> * The following describes how the timer should be programmed (according to</span>
<span class="cm"> * the vendor documentation)</span>
<span class="cm"> *</span>
<span class="cm"> * Enabling Watchdog:</span>
<span class="cm"> * MOV AX,000AH (enable, phase I)</span>
<span class="cm"> * MOV DX,0120H</span>
<span class="cm"> * OUT DX,AX</span>
<span class="cm"> * MOV AX,000BH (enable, phase II)</span>
<span class="cm"> * MOV DX,0120H</span>
<span class="cm"> * OUT DX,AX</span>
<span class="cm"> * MOV AX,000nH (set multiplier n, from 1-4)</span>
<span class="cm"> * MOV DX,0120H</span>
<span class="cm"> * OUT DX,AX</span>
<span class="cm"> * MOV AX,000mH (set base timer m, from 0-F)</span>
<span class="cm"> * MOV DX,0121H</span>
<span class="cm"> * OUT DX,AX</span>
<span class="cm"> *</span>
<span class="cm"> * Reset timer:</span>
<span class="cm"> * MOV AX,000mH (same as set base timer, above)</span>
<span class="cm"> * MOV DX,0121H</span>
<span class="cm"> * OUT DX,AX</span>
<span class="cm"> *</span>
<span class="cm"> * Disabling Watchdog:</span>
<span class="cm"> * MOV AX,0000H (a zero value)</span>
<span class="cm"> * MOV DX,0120H</span>
<span class="cm"> * OUT DX,AX</span>
<span class="cm"> *</span>
<span class="cm"> * Watchdog timeout configuration values:</span>
<span class="cm"> *		N</span>
<span class="cm"> *	M |	1	2	3	4</span>
<span class="cm"> *	--|----------------------------------</span>
<span class="cm"> *	0 |	0.5s	5s	50s	100s</span>
<span class="cm"> *	1 |	1s	10s	100s	200s</span>
<span class="cm"> *	2 |	1.5s	15s	150s	300s</span>
<span class="cm"> *	3 |	2s	20s	200s	400s</span>
<span class="cm"> *	4 |	2.5s	25s	250s	500s</span>
<span class="cm"> *	5 |	3s	30s	300s	600s</span>
<span class="cm"> *	6 |	3.5s	35s	350s	700s</span>
<span class="cm"> *	7 |	4s	40s	400s	800s</span>
<span class="cm"> *	8 |	4.5s	45s	450s	900s</span>
<span class="cm"> *	9 |	5s	50s	500s	1000s</span>
<span class="cm"> *	A |	5.5s	55s	550s	1100s</span>
<span class="cm"> *	B |	6s	60s	600s	1200s</span>
<span class="cm"> *	C |	6.5s	65s	650s	1300s</span>
<span class="cm"> *	D |	7s	70s	700s	1400s</span>
<span class="cm"> *	E |	7.5s	75s	750s	1500s</span>
<span class="cm"> *	F |	8s	80s	800s	1600s</span>
<span class="cm"> *</span>
<span class="cm"> * Another way to say the same things is:</span>
<span class="cm"> *  For N=1, Timeout = (M+1) * 0.5s</span>
<span class="cm"> *  For N=2, Timeout = (M+1) * 5s</span>
<span class="cm"> *  For N=3, Timeout = (M+1) * 50s</span>
<span class="cm"> *  For N=4, Timeout = (M+1) * 100s</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">wd_times</span><span class="p">[</span><span class="mi">64</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>			<span class="cm">/* 0  = 0.5s */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>			<span class="cm">/* 1  = 1s   */</span>
	<span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>			<span class="cm">/* 2  = 1.5s */</span>
	<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>			<span class="cm">/* 3  = 2s   */</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>			<span class="cm">/* 4  = 2.5s */</span>
	<span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>			<span class="cm">/* 5  = 3s   */</span>
	<span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>			<span class="cm">/* 6  = 3.5s */</span>
	<span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>			<span class="cm">/* 7  = 4s   */</span>
	<span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>			<span class="cm">/* 8  = 4.5s */</span>
	<span class="p">{</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>			<span class="cm">/* 9  = 5s   */</span>
	<span class="p">{</span><span class="mh">0xA</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>		<span class="cm">/* 10 = 5.5s */</span>
	<span class="p">{</span><span class="mh">0xB</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>		<span class="cm">/* 11 = 6s   */</span>
	<span class="p">{</span><span class="mh">0xC</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>		<span class="cm">/* 12 = 6.5s */</span>
	<span class="p">{</span><span class="mh">0xD</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>		<span class="cm">/* 13 = 7s   */</span>
	<span class="p">{</span><span class="mh">0xE</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>		<span class="cm">/* 14 = 7.5s */</span>
	<span class="p">{</span><span class="mh">0xF</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>		<span class="cm">/* 15 = 8s   */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>			<span class="cm">/* 16 = 5s  */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>			<span class="cm">/* 17 = 10s */</span>
	<span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>			<span class="cm">/* 18 = 15s */</span>
	<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>			<span class="cm">/* 19 = 20s */</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>			<span class="cm">/* 20 = 25s */</span>
	<span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>			<span class="cm">/* 21 = 30s */</span>
	<span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>			<span class="cm">/* 22 = 35s */</span>
	<span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>			<span class="cm">/* 23 = 40s */</span>
	<span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>			<span class="cm">/* 24 = 45s */</span>
	<span class="p">{</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>			<span class="cm">/* 25 = 50s */</span>
	<span class="p">{</span><span class="mh">0xA</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>		<span class="cm">/* 26 = 55s */</span>
	<span class="p">{</span><span class="mh">0xB</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>		<span class="cm">/* 27 = 60s */</span>
	<span class="p">{</span><span class="mh">0xC</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>		<span class="cm">/* 28 = 65s */</span>
	<span class="p">{</span><span class="mh">0xD</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>		<span class="cm">/* 29 = 70s */</span>
	<span class="p">{</span><span class="mh">0xE</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>		<span class="cm">/* 30 = 75s */</span>
	<span class="p">{</span><span class="mh">0xF</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>		<span class="cm">/* 31 = 80s */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>			<span class="cm">/* 32 = 50s  */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>			<span class="cm">/* 33 = 100s */</span>
	<span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>			<span class="cm">/* 34 = 150s */</span>
	<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>			<span class="cm">/* 35 = 200s */</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>			<span class="cm">/* 36 = 250s */</span>
	<span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>			<span class="cm">/* 37 = 300s */</span>
	<span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>			<span class="cm">/* 38 = 350s */</span>
	<span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>			<span class="cm">/* 39 = 400s */</span>
	<span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>			<span class="cm">/* 40 = 450s */</span>
	<span class="p">{</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>			<span class="cm">/* 41 = 500s */</span>
	<span class="p">{</span><span class="mh">0xA</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>		<span class="cm">/* 42 = 550s */</span>
	<span class="p">{</span><span class="mh">0xB</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>		<span class="cm">/* 43 = 600s */</span>
	<span class="p">{</span><span class="mh">0xC</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>		<span class="cm">/* 44 = 650s */</span>
	<span class="p">{</span><span class="mh">0xD</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>		<span class="cm">/* 45 = 700s */</span>
	<span class="p">{</span><span class="mh">0xE</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>		<span class="cm">/* 46 = 750s */</span>
	<span class="p">{</span><span class="mh">0xF</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>		<span class="cm">/* 47 = 800s */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>			<span class="cm">/* 48 = 100s */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>			<span class="cm">/* 49 = 200s */</span>
	<span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>			<span class="cm">/* 50 = 300s */</span>
	<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>			<span class="cm">/* 51 = 400s */</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>			<span class="cm">/* 52 = 500s */</span>
	<span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>			<span class="cm">/* 53 = 600s */</span>
	<span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>			<span class="cm">/* 54 = 700s */</span>
	<span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>			<span class="cm">/* 55 = 800s */</span>
	<span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>			<span class="cm">/* 56 = 900s */</span>
	<span class="p">{</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>			<span class="cm">/* 57 = 1000s */</span>
	<span class="p">{</span><span class="mh">0xA</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>		<span class="cm">/* 58 = 1100s */</span>
	<span class="p">{</span><span class="mh">0xB</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>		<span class="cm">/* 59 = 1200s */</span>
	<span class="p">{</span><span class="mh">0xC</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>		<span class="cm">/* 60 = 1300s */</span>
	<span class="p">{</span><span class="mh">0xD</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>		<span class="cm">/* 61 = 1400s */</span>
	<span class="p">{</span><span class="mh">0xE</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>		<span class="cm">/* 62 = 1500s */</span>
	<span class="p">{</span><span class="mh">0xF</span><span class="p">,</span> <span class="mi">4</span><span class="p">}</span>		<span class="cm">/* 63 = 1600s */</span>
<span class="p">};</span>

<span class="cp">#define SBC8360_ENABLE 0x120</span>
<span class="cp">#define SBC8360_BASETIME 0x121</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">27</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wd_margin</span> <span class="o">=</span> <span class="mh">0xB</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wd_multiplier</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">nowayout</span> <span class="o">=</span> <span class="n">WATCHDOG_NOWAYOUT</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="s">&quot;Index into timeout table (0-63) (default=27 (60s))&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nowayout</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nowayout</span><span class="p">,</span>
		 <span class="s">&quot;Watchdog cannot be stopped once started (default=&quot;</span>
				<span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">WATCHDOG_NOWAYOUT</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	Kernel methods.</span>
<span class="cm"> */</span>

<span class="cm">/* Activate and pre-configure watchdog */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbc8360_activate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Enable the watchdog */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x0A</span><span class="p">,</span> <span class="n">SBC8360_ENABLE</span><span class="p">);</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">SBC8360_ENABLE</span><span class="p">);</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="cm">/* Set timeout multiplier */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">wd_multiplier</span><span class="p">,</span> <span class="n">SBC8360_ENABLE</span><span class="p">);</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="cm">/* Nothing happens until first sbc8360_ping() */</span>
<span class="p">}</span>

<span class="cm">/* Kernel pings watchdog */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbc8360_ping</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Write the base timer register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">wd_margin</span><span class="p">,</span> <span class="n">SBC8360_BASETIME</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* stop watchdog */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbc8360_stop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* De-activate the watchdog */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SBC8360_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Userspace pings kernel driver, or requests clean close */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sbc8360_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			     <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nowayout</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

			<span class="cm">/* In case it was set long ago */</span>
			<span class="n">expect_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;V&#39;</span><span class="p">)</span>
					<span class="n">expect_close</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">sbc8360_ping</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sbc8360_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbc8360_is_open</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nowayout</span><span class="p">)</span>
		<span class="n">__module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>

	<span class="cm">/* Activate and ping once to start the countdown */</span>
	<span class="n">sbc8360_activate</span><span class="p">();</span>
	<span class="n">sbc8360_ping</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sbc8360_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">expect_close</span> <span class="o">==</span> <span class="mi">42</span><span class="p">)</span>
		<span class="n">sbc8360_stop</span><span class="p">();</span>
	<span class="k">else</span>
		<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;SBC8360 device closed unexpectedly.  SBC8360 will not stop!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbc8360_is_open</span><span class="p">);</span>
	<span class="n">expect_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Notifier for system down</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sbc8360_notify_sys</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">SYS_DOWN</span> <span class="o">||</span> <span class="n">code</span> <span class="o">==</span> <span class="n">SYS_HALT</span><span class="p">)</span>
		<span class="n">sbc8360_stop</span><span class="p">();</span>	<span class="cm">/* Disable the SBC8360 Watchdog */</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Kernel Interfaces</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">sbc8360_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">sbc8360_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">sbc8360_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">sbc8360_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">sbc8360_miscdev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">WATCHDOG_MINOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;watchdog&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sbc8360_fops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	The SBC8360 needs to learn about soft shutdowns in order to</span>
<span class="cm"> *	turn the timebomb registers off.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">sbc8360_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">sbc8360_notify_sys</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sbc8360_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">mseconds</span> <span class="o">=</span> <span class="mi">60000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Invalid timeout index (must be 0-63)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">SBC8360_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SBC8360&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ENABLE method I/O %X is not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">SBC8360_ENABLE</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">SBC8360_BASETIME</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SBC8360&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;BASETIME method I/O %X is not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">SBC8360_BASETIME</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_nobasetimereg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbc8360_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to register reboot notifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_noreboot</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbc8360_miscdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to register misc device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_nomisc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wd_margin</span> <span class="o">=</span> <span class="n">wd_times</span><span class="p">[</span><span class="n">timeout</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">wd_multiplier</span> <span class="o">=</span> <span class="n">wd_times</span><span class="p">[</span><span class="n">timeout</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wd_multiplier</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mseconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">wd_margin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wd_multiplier</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">mseconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">wd_margin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wd_multiplier</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">mseconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">wd_margin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">50000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wd_multiplier</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">mseconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">wd_margin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>

	<span class="cm">/* My kingdom for the ability to print &quot;0.5 seconds&quot; in the kernel! */</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Timeout set at %ld ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mseconds</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_nomisc:</span>
	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbc8360_notifier</span><span class="p">);</span>
<span class="nl">out_noreboot:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">SBC8360_BASETIME</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">out_nobasetimereg:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">SBC8360_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sbc8360_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbc8360_miscdev</span><span class="p">);</span>
	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbc8360_notifier</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">SBC8360_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">SBC8360_BASETIME</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sbc8360_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sbc8360_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ian E. Morgan &lt;imorgan@webcon.ca&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SBC8360 watchdog driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;1.01&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_MISCDEV</span><span class="p">(</span><span class="n">WATCHDOG_MINOR</span><span class="p">);</span>

<span class="cm">/* end of sbc8360.c */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
