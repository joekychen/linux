<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › watchdog › pcwd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pcwd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * PC Watchdog Driver</span>
<span class="cm"> * by Ken Hollis (khollis@bitgate.com)</span>
<span class="cm"> *</span>
<span class="cm"> * Permission granted from Simon Machell (smachell@berkprod.com)</span>
<span class="cm"> * Written for the Linux Kernel, and GPLed by Ken Hollis</span>
<span class="cm"> *</span>
<span class="cm"> * 960107	Added request_region routines, modulized the whole thing.</span>
<span class="cm"> * 960108	Fixed end-of-file pointer (Thanks to Dan Hollis), added</span>
<span class="cm"> *		WD_TIMEOUT define.</span>
<span class="cm"> * 960216	Added eof marker on the file, and changed verbose messages.</span>
<span class="cm"> * 960716	Made functional and cosmetic changes to the source for</span>
<span class="cm"> *		inclusion in Linux 2.0.x kernels, thanks to Alan Cox.</span>
<span class="cm"> * 960717	Removed read/seek routines, replaced with ioctl.  Also, added</span>
<span class="cm"> *		check_region command due to Alan&#39;s suggestion.</span>
<span class="cm"> * 960821	Made changes to compile in newer 2.0.x kernels.  Added</span>
<span class="cm"> *		&quot;cold reboot sense&quot; entry.</span>
<span class="cm"> * 960825	Made a few changes to code, deleted some defines and made</span>
<span class="cm"> *		typedefs to replace them.  Made heartbeat reset only available</span>
<span class="cm"> *		via ioctl, and removed the write routine.</span>
<span class="cm"> * 960828	Added new items for PC Watchdog Rev.C card.</span>
<span class="cm"> * 960829	Changed around all of the IOCTLs, added new features,</span>
<span class="cm"> *		added watchdog disable/re-enable routines.  Added firmware</span>
<span class="cm"> *		version reporting.  Added read routine for temperature.</span>
<span class="cm"> *		Removed some extra defines, added an autodetect Revision</span>
<span class="cm"> *		routine.</span>
<span class="cm"> * 961006	Revised some documentation, fixed some cosmetic bugs.  Made</span>
<span class="cm"> *		drivers to panic the system if it&#39;s overheating at bootup.</span>
<span class="cm"> * 961118	Changed some verbiage on some of the output, tidied up</span>
<span class="cm"> *		code bits, and added compatibility to 2.1.x.</span>
<span class="cm"> * 970912	Enabled board on open and disable on close.</span>
<span class="cm"> * 971107	Took account of recent VFS changes (broke read).</span>
<span class="cm"> * 971210	Disable board on initialisation in case board already ticking.</span>
<span class="cm"> * 971222	Changed open/close for temperature handling</span>
<span class="cm"> *		Michael Meskes &lt;meskes@debian.org&gt;.</span>
<span class="cm"> * 980112	Used minor numbers from include/linux/miscdevice.h</span>
<span class="cm"> * 990403	Clear reset status after reading control status register in</span>
<span class="cm"> *		pcwd_showprevstate(). [Marc Boucher &lt;marc@mbsi.ca&gt;]</span>
<span class="cm"> * 990605	Made changes to code to support Firmware 1.22a, added</span>
<span class="cm"> *		fairly useless proc entry.</span>
<span class="cm"> * 990610	removed said useless proc code for the merge &lt;alan&gt;</span>
<span class="cm"> * 000403	Removed last traces of proc code. &lt;davej&gt;</span>
<span class="cm"> * 011214	Added nowayout module option to override</span>
<span class="cm"> *		CONFIG_WATCHDOG_NOWAYOUT &lt;Matt_Domsch@dell.com&gt;</span>
<span class="cm"> *		Added timeout module option to override default</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *	A bells and whistles driver is available from http://www.pcwd.de/</span>
<span class="cm"> *	More info available at http://www.berkprod.com/ or</span>
<span class="cm"> *	http://www.pcwatchdog.com/</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;	</span><span class="cm">/* For module specific items */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;	</span><span class="cm">/* For new moduleparam&#39;s */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/types.h&gt;	</span><span class="cm">/* For standard types (like size_t) */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/errno.h&gt;	</span><span class="cm">/* For the -ENODEV/... values */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/kernel.h&gt;	</span><span class="cm">/* For printk/panic/... */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/delay.h&gt;	</span><span class="cm">/* For mdelay function */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/timer.h&gt;	</span><span class="cm">/* For timer related operations */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/jiffies.h&gt;	</span><span class="cm">/* For jiffies stuff */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;	</span><span class="cm">/* For MODULE_ALIAS_MISCDEV(WATCHDOG_MINOR) */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/watchdog.h&gt;	</span><span class="cm">/* For the watchdog specific items */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/reboot.h&gt;	</span><span class="cm">/* For kernel_power_off() */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/init.h&gt;		</span><span class="cm">/* For __init/__exit/... */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/fs.h&gt;		</span><span class="cm">/* For file operations */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/isa.h&gt;		</span><span class="cm">/* For isa devices */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/ioport.h&gt;	</span><span class="cm">/* For io-port access */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/spinlock.h&gt;	</span><span class="cm">/* For spin_lock/spin_unlock/... */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/uaccess.h&gt;	</span><span class="cm">/* For copy_to_user/put_user/... */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/io.h&gt;		</span><span class="cm">/* For inb/outb/... */</span><span class="cp"></span>

<span class="cm">/* Module and version information */</span>
<span class="cp">#define WATCHDOG_VERSION &quot;1.20&quot;</span>
<span class="cp">#define WATCHDOG_DATE &quot;18 Feb 2007&quot;</span>
<span class="cp">#define WATCHDOG_DRIVER_NAME &quot;ISA-PC Watchdog&quot;</span>
<span class="cp">#define WATCHDOG_NAME &quot;pcwd&quot;</span>
<span class="cp">#define DRIVER_VERSION WATCHDOG_DRIVER_NAME &quot; driver, v&quot; WATCHDOG_VERSION &quot;\n&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * It should be noted that PCWD_REVISION_B was removed because A and B</span>
<span class="cm"> * are essentially the same types of card, with the exception that B</span>
<span class="cm"> * has temperature reporting.  Since I didn&#39;t receive a Rev.B card,</span>
<span class="cm"> * the Rev.B card is not supported.  (It&#39;s a good thing too, as they</span>
<span class="cm"> * are no longer in production.)</span>
<span class="cm"> */</span>
<span class="cp">#define	PCWD_REVISION_A		1</span>
<span class="cp">#define	PCWD_REVISION_C		2</span>

<span class="cm">/*</span>
<span class="cm"> * These are the auto-probe addresses available.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision A only uses ports 0x270 and 0x370.  Revision C introduced 0x350.</span>
<span class="cm"> * Revision A has an address range of 2 addresses, while Revision C has 4.</span>
<span class="cm"> */</span>
<span class="cp">#define PCWD_ISA_NR_CARDS	3</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pcwd_ioports</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x270</span><span class="p">,</span> <span class="mh">0x350</span><span class="p">,</span> <span class="mh">0x370</span><span class="p">,</span> <span class="mh">0x000</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * These are the defines that describe the control status bits for the</span>
<span class="cm"> * PCI-PC Watchdog card.</span>
<span class="cm">*/</span>
<span class="cm">/* Port 1 : Control Status #1 for the PC Watchdog card, revision A. */</span>
<span class="cp">#define WD_WDRST		0x01	</span><span class="cm">/* Previously reset state */</span><span class="cp"></span>
<span class="cp">#define WD_T110			0x02	</span><span class="cm">/* Temperature overheat sense */</span><span class="cp"></span>
<span class="cp">#define WD_HRTBT		0x04	</span><span class="cm">/* Heartbeat sense */</span><span class="cp"></span>
<span class="cp">#define WD_RLY2			0x08	</span><span class="cm">/* External relay triggered */</span><span class="cp"></span>
<span class="cp">#define WD_SRLY2		0x80	</span><span class="cm">/* Software external relay triggered */</span><span class="cp"></span>
<span class="cm">/* Port 1 : Control Status #1 for the PC Watchdog card, revision C. */</span>
<span class="cp">#define WD_REVC_WTRP		0x01	</span><span class="cm">/* Watchdog Trip status */</span><span class="cp"></span>
<span class="cp">#define WD_REVC_HRBT		0x02	</span><span class="cm">/* Watchdog Heartbeat */</span><span class="cp"></span>
<span class="cp">#define WD_REVC_TTRP		0x04	</span><span class="cm">/* Temperature Trip status */</span><span class="cp"></span>
<span class="cp">#define WD_REVC_RL2A		0x08	</span><span class="cm">/* Relay 2 activated by</span>
<span class="cm">							on-board processor */</span><span class="cp"></span>
<span class="cp">#define WD_REVC_RL1A		0x10	</span><span class="cm">/* Relay 1 active */</span><span class="cp"></span>
<span class="cp">#define WD_REVC_R2DS		0x40	</span><span class="cm">/* Relay 2 disable */</span><span class="cp"></span>
<span class="cp">#define WD_REVC_RLY2		0x80	</span><span class="cm">/* Relay 2 activated? */</span><span class="cp"></span>
<span class="cm">/* Port 2 : Control Status #2 */</span>
<span class="cp">#define WD_WDIS			0x10	</span><span class="cm">/* Watchdog Disabled */</span><span class="cp"></span>
<span class="cp">#define WD_ENTP			0x20	</span><span class="cm">/* Watchdog Enable Temperature Trip */</span><span class="cp"></span>
<span class="cp">#define WD_SSEL			0x40	</span><span class="cm">/* Watchdog Switch Select</span>
<span class="cm">							(1:SW1 &lt;-&gt; 0:SW2) */</span><span class="cp"></span>
<span class="cp">#define WD_WCMD			0x80	</span><span class="cm">/* Watchdog Command Mode */</span><span class="cp"></span>

<span class="cm">/* max. time we give an ISA watchdog card to process a command */</span>
<span class="cm">/* 500ms for each 4 bit response (according to spec.) */</span>
<span class="cp">#define ISA_COMMAND_TIMEOUT     1000</span>

<span class="cm">/* Watchdog&#39;s internal commands */</span>
<span class="cp">#define CMD_ISA_IDLE			0x00</span>
<span class="cp">#define CMD_ISA_VERSION_INTEGER		0x01</span>
<span class="cp">#define CMD_ISA_VERSION_TENTH		0x02</span>
<span class="cp">#define CMD_ISA_VERSION_HUNDRETH	0x03</span>
<span class="cp">#define CMD_ISA_VERSION_MINOR		0x04</span>
<span class="cp">#define CMD_ISA_SWITCH_SETTINGS		0x05</span>
<span class="cp">#define CMD_ISA_RESET_PC		0x06</span>
<span class="cp">#define CMD_ISA_ARM_0			0x07</span>
<span class="cp">#define CMD_ISA_ARM_30			0x08</span>
<span class="cp">#define CMD_ISA_ARM_60			0x09</span>
<span class="cp">#define CMD_ISA_DELAY_TIME_2SECS	0x0A</span>
<span class="cp">#define CMD_ISA_DELAY_TIME_4SECS	0x0B</span>
<span class="cp">#define CMD_ISA_DELAY_TIME_8SECS	0x0C</span>
<span class="cp">#define CMD_ISA_RESET_RELAYS		0x0D</span>

<span class="cm">/* Watchdog&#39;s Dip Switch heartbeat values */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">heartbeat_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">20</span><span class="p">,</span>	<span class="cm">/* OFF-OFF-OFF	= 20 Sec  */</span>
	<span class="mi">40</span><span class="p">,</span>	<span class="cm">/* OFF-OFF-ON	= 40 Sec  */</span>
	<span class="mi">60</span><span class="p">,</span>	<span class="cm">/* OFF-ON-OFF	=  1 Min  */</span>
	<span class="mi">300</span><span class="p">,</span>	<span class="cm">/* OFF-ON-ON	=  5 Min  */</span>
	<span class="mi">600</span><span class="p">,</span>	<span class="cm">/* ON-OFF-OFF	= 10 Min  */</span>
	<span class="mi">1800</span><span class="p">,</span>	<span class="cm">/* ON-OFF-ON	= 30 Min  */</span>
	<span class="mi">3600</span><span class="p">,</span>	<span class="cm">/* ON-ON-OFF	=  1 Hour */</span>
	<span class="mi">7200</span><span class="p">,</span>	<span class="cm">/* ON-ON-ON	=  2 hour */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * We are using an kernel timer to do the pinging of the watchdog</span>
<span class="cm"> * every ~500ms. We try to set the internal heartbeat of the</span>
<span class="cm"> * watchdog to 2 ms.</span>
<span class="cm"> */</span>

<span class="cp">#define WDT_INTERVAL (HZ/2+1)</span>

<span class="cm">/* We can only use 1 card due to the /dev/watchdog restriction */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cards_found</span><span class="p">;</span>

<span class="cm">/* internal variables */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">open_allowed</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">expect_close</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">temp_panic</span><span class="p">;</span>

<span class="cm">/* this is private data for each ISA-PC watchdog card */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">fw_ver_str</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>		<span class="cm">/* The cards firmware version */</span>
	<span class="kt">int</span> <span class="n">revision</span><span class="p">;</span>			<span class="cm">/* The card&#39;s revision */</span>
	<span class="kt">int</span> <span class="n">supports_temp</span><span class="p">;</span>		<span class="cm">/* Whether or not the card has</span>
<span class="cm">						a temperature device */</span>
	<span class="kt">int</span> <span class="n">command_mode</span><span class="p">;</span>		<span class="cm">/* Whether or not the card is in</span>
<span class="cm">						command mode */</span>
	<span class="kt">int</span> <span class="n">boot_status</span><span class="p">;</span>		<span class="cm">/* The card&#39;s boot status */</span>
	<span class="kt">int</span> <span class="n">io_addr</span><span class="p">;</span>			<span class="cm">/* The cards I/O address */</span>
	<span class="n">spinlock_t</span> <span class="n">io_lock</span><span class="p">;</span>		<span class="cm">/* the lock for io operations */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>	<span class="cm">/* The timer that pings the watchdog */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_heartbeat</span><span class="p">;</span>	<span class="cm">/* the next_heartbeat for the timer */</span>
<span class="p">}</span> <span class="n">pcwd_private</span><span class="p">;</span>

<span class="cm">/* module parameters */</span>
<span class="cp">#define QUIET	0	</span><span class="cm">/* Default */</span><span class="cp"></span>
<span class="cp">#define VERBOSE	1	</span><span class="cm">/* Verbose */</span><span class="cp"></span>
<span class="cp">#define DEBUG	2	</span><span class="cm">/* print fancy stuff too */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="n">QUIET</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span>
		<span class="s">&quot;Debug level: 0=Quiet, 1=Verbose, 2=Debug (default=0)&quot;</span><span class="p">);</span>

<span class="cm">/* default heartbeat = delay-time from dip-switches */</span>
<span class="cp">#define WATCHDOG_HEARTBEAT 0</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">heartbeat</span> <span class="o">=</span> <span class="n">WATCHDOG_HEARTBEAT</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">heartbeat</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">heartbeat</span><span class="p">,</span> <span class="s">&quot;Watchdog heartbeat in seconds. &quot;</span>
	<span class="s">&quot;(2 &lt;= heartbeat &lt;= 7200 or 0=delay-time from dip-switches, default=&quot;</span>
				<span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">WATCHDOG_HEARTBEAT</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">nowayout</span> <span class="o">=</span> <span class="n">WATCHDOG_NOWAYOUT</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nowayout</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nowayout</span><span class="p">,</span>
		<span class="s">&quot;Watchdog cannot be stopped once started (default=&quot;</span>
				<span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">WATCHDOG_NOWAYOUT</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	Internal functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_isa_command</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">control_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port0</span><span class="p">,</span> <span class="n">last_port0</span><span class="p">;</span>	<span class="cm">/* Double read for stabilising */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="n">DEBUG</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;sending following data cmd=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* The WCMD bit must be 1 and the command is only 4 bits in size */</span>
	<span class="n">control_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">|</span> <span class="n">WD_WCMD</span><span class="p">;</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">control_status</span><span class="p">,</span> <span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ISA_COMMAND_TIMEOUT</span><span class="p">);</span>

	<span class="n">port0</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">last_port0</span> <span class="o">=</span> <span class="n">port0</span><span class="p">;</span>
		<span class="n">port0</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port0</span> <span class="o">==</span> <span class="n">last_port0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* Data is stable */</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="n">DEBUG</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;received following data for cmd=0x%02x: port0=0x%02x last_port0=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">cmd</span><span class="p">,</span> <span class="n">port0</span><span class="p">,</span> <span class="n">last_port0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">port0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_command_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set the card into command mode */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">send_isa_command</span><span class="p">(</span><span class="n">CMD_ISA_IDLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mh">0xF3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Card does not like what we&#39;ve done to it */</span>
			<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1200</span><span class="p">);</span>	<span class="cm">/* Spec says wait 1ms */</span>
			<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">ISA_COMMAND_TIMEOUT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="n">pcwd_private</span><span class="p">.</span><span class="n">command_mode</span> <span class="o">=</span> <span class="n">found</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="n">DEBUG</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;command_mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcwd_private</span><span class="p">.</span><span class="n">command_mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unset_command_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set the card into normal mode */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ISA_COMMAND_TIMEOUT</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="n">pcwd_private</span><span class="p">.</span><span class="n">command_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="n">DEBUG</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;command_mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcwd_private</span><span class="p">.</span><span class="n">command_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pcwd_check_temperature_support</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xF0</span><span class="p">)</span>
		<span class="n">pcwd_private</span><span class="p">.</span><span class="n">supports_temp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pcwd_get_firmware</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">one</span><span class="p">,</span> <span class="n">ten</span><span class="p">,</span> <span class="n">hund</span><span class="p">,</span> <span class="n">minor</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">fw_ver_str</span><span class="p">,</span> <span class="s">&quot;ERROR&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_command_mode</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">one</span> <span class="o">=</span> <span class="n">send_isa_command</span><span class="p">(</span><span class="n">CMD_ISA_VERSION_INTEGER</span><span class="p">);</span>
		<span class="n">ten</span> <span class="o">=</span> <span class="n">send_isa_command</span><span class="p">(</span><span class="n">CMD_ISA_VERSION_TENTH</span><span class="p">);</span>
		<span class="n">hund</span> <span class="o">=</span> <span class="n">send_isa_command</span><span class="p">(</span><span class="n">CMD_ISA_VERSION_HUNDRETH</span><span class="p">);</span>
		<span class="n">minor</span> <span class="o">=</span> <span class="n">send_isa_command</span><span class="p">(</span><span class="n">CMD_ISA_VERSION_MINOR</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">fw_ver_str</span><span class="p">,</span> <span class="s">&quot;%c.%c%c%c&quot;</span><span class="p">,</span>
					<span class="n">one</span><span class="p">,</span> <span class="n">ten</span><span class="p">,</span> <span class="n">hund</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">unset_command_mode</span><span class="p">();</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pcwd_get_option_switches</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">option_switches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_command_mode</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/* Get switch settings */</span>
		<span class="n">option_switches</span> <span class="o">=</span> <span class="n">send_isa_command</span><span class="p">(</span><span class="n">CMD_ISA_SWITCH_SETTINGS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">unset_command_mode</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">option_switches</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcwd_show_card_info</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">option_switches</span><span class="p">;</span>

	<span class="cm">/* Get some extra info from the hardware (in command/debug/diag mode) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="n">PCWD_REVISION_A</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ISA-PC Watchdog (REV.A) detected at port 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="n">PCWD_REVISION_C</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcwd_get_firmware</span><span class="p">();</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ISA-PC Watchdog (REV.C) detected at port 0x%04x (Firmware version: %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span><span class="p">,</span> <span class="n">pcwd_private</span><span class="p">.</span><span class="n">fw_ver_str</span><span class="p">);</span>
		<span class="n">option_switches</span> <span class="o">=</span> <span class="n">pcwd_get_option_switches</span><span class="p">();</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Option switches (0x%02x): Temperature Reset Enable=%s, Power On Delay=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">option_switches</span><span class="p">,</span>
			<span class="p">((</span><span class="n">option_switches</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ON&quot;</span> <span class="o">:</span> <span class="s">&quot;OFF&quot;</span><span class="p">),</span>
			<span class="p">((</span><span class="n">option_switches</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ON&quot;</span> <span class="o">:</span> <span class="s">&quot;OFF&quot;</span><span class="p">));</span>

		<span class="cm">/* Reprogram internal heartbeat to 2 seconds */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_command_mode</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">send_isa_command</span><span class="p">(</span><span class="n">CMD_ISA_DELAY_TIME_2SECS</span><span class="p">);</span>
			<span class="n">unset_command_mode</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">supports_temp</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Temperature Option Detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">boot_status</span> <span class="o">&amp;</span> <span class="n">WDIOF_CARDRESET</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Previous reboot was caused by the card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">boot_status</span> <span class="o">&amp;</span> <span class="n">WDIOF_OVERHEAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_emerg</span><span class="p">(</span><span class="s">&quot;Card senses a CPU Overheat. Panicking!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_emerg</span><span class="p">(</span><span class="s">&quot;CPU Overheat</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">boot_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;No previous trip detected - Cold boot or reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcwd_timer_ping</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">wdrst_stat</span><span class="p">;</span>

	<span class="cm">/* If we got a heartbeat pulse within the WDT_INTERVAL</span>
<span class="cm">	 * we agree to ping the WDT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">pcwd_private</span><span class="p">.</span><span class="n">next_heartbeat</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Ping the watchdog */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="n">PCWD_REVISION_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  Rev A cards are reset by setting the</span>
<span class="cm">			    WD_WDRST bit in register 1 */</span>
			<span class="n">wdrst_stat</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span><span class="p">);</span>
			<span class="n">wdrst_stat</span> <span class="o">&amp;=</span> <span class="mh">0x0F</span><span class="p">;</span>
			<span class="n">wdrst_stat</span> <span class="o">|=</span> <span class="n">WD_WDRST</span><span class="p">;</span>

			<span class="n">outb_p</span><span class="p">(</span><span class="n">wdrst_stat</span><span class="p">,</span> <span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Re-trigger watchdog by writing to port 0 */</span>
			<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Re-set the timer interval */</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">WDT_INTERVAL</span><span class="p">);</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Heartbeat lost! Will not ping the watchdog</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcwd_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">stat_reg</span><span class="p">;</span>

	<span class="n">pcwd_private</span><span class="p">.</span><span class="n">next_heartbeat</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">heartbeat</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="cm">/* Start the timer */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">WDT_INTERVAL</span><span class="p">);</span>

	<span class="cm">/* Enable the port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="n">PCWD_REVISION_C</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ISA_COMMAND_TIMEOUT</span><span class="p">);</span>
		<span class="n">stat_reg</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat_reg</span> <span class="o">&amp;</span> <span class="n">WD_WDIS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Could not start watchdog</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="n">VERBOSE</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Watchdog started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcwd_stop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">stat_reg</span><span class="p">;</span>

	<span class="cm">/* Stop the timer */</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>

	<span class="cm">/*  Disable the board  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="n">PCWD_REVISION_C</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0xA5</span><span class="p">,</span> <span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ISA_COMMAND_TIMEOUT</span><span class="p">);</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0xA5</span><span class="p">,</span> <span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ISA_COMMAND_TIMEOUT</span><span class="p">);</span>
		<span class="n">stat_reg</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">stat_reg</span> <span class="o">&amp;</span> <span class="n">WD_WDIS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Could not stop watchdog</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="n">VERBOSE</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Watchdog stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcwd_keepalive</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* user land ping */</span>
	<span class="n">pcwd_private</span><span class="p">.</span><span class="n">next_heartbeat</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">heartbeat</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="n">DEBUG</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Watchdog keepalive signal send</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcwd_set_heartbeat</span><span class="p">(</span><span class="kt">int</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">7200</span><span class="p">)</span> <span class="cm">/* arbitrary upper limit */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">heartbeat</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="n">VERBOSE</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;New heartbeat: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">heartbeat</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcwd_get_status</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">control_status</span><span class="p">;</span>

	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="n">PCWD_REVISION_A</span><span class="p">)</span>
		<span class="cm">/* Rev A cards return status information from</span>
<span class="cm">		 * the base register, which is used for the</span>
<span class="cm">		 * temperature in other cards. */</span>
		<span class="n">control_status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Rev C cards return card status in the base</span>
<span class="cm">		 * address + 1 register. And use different bits</span>
<span class="cm">		 * to indicate a card initiated reset, and an</span>
<span class="cm">		 * over-temperature condition. And the reboot</span>
<span class="cm">		 * status can be reset. */</span>
		<span class="n">control_status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="n">PCWD_REVISION_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control_status</span> <span class="o">&amp;</span> <span class="n">WD_WDRST</span><span class="p">)</span>
			<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">WDIOF_CARDRESET</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">control_status</span> <span class="o">&amp;</span> <span class="n">WD_T110</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">WDIOF_OVERHEAT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp_panic</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Temperature overheat trip!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">kernel_power_off</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control_status</span> <span class="o">&amp;</span> <span class="n">WD_REVC_WTRP</span><span class="p">)</span>
			<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">WDIOF_CARDRESET</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">control_status</span> <span class="o">&amp;</span> <span class="n">WD_REVC_TTRP</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">WDIOF_OVERHEAT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp_panic</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Temperature overheat trip!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">kernel_power_off</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcwd_clear_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">control_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="n">PCWD_REVISION_C</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="n">VERBOSE</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;clearing watchdog trip status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">control_status</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;status was: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">control_status</span><span class="p">);</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;sending: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">control_status</span> <span class="o">&amp;</span> <span class="n">WD_REVC_R2DS</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* clear reset status &amp; Keep Relay 2 disable state as it is */</span>
		<span class="n">outb_p</span><span class="p">((</span><span class="n">control_status</span> <span class="o">&amp;</span> <span class="n">WD_REVC_R2DS</span><span class="p">),</span>
						<span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcwd_get_temperature</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">temperature</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check that port 0 gives temperature info and no command results */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">command_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">temperature</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">supports_temp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Convert celsius to fahrenheit, since this was</span>
<span class="cm">	 * the decided &#39;standard&#39; for this return value.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="o">*</span><span class="n">temperature</span> <span class="o">=</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span><span class="p">))</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;temperature is: %d F</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">temperature</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	/dev/watchdog handling</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">pcwd_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temperature</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_heartbeat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">watchdog_info</span> <span class="n">ident</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">options</span> <span class="o">=</span>		<span class="n">WDIOF_OVERHEAT</span> <span class="o">|</span>
					<span class="n">WDIOF_CARDRESET</span> <span class="o">|</span>
					<span class="n">WDIOF_KEEPALIVEPING</span> <span class="o">|</span>
					<span class="n">WDIOF_SETTIMEOUT</span> <span class="o">|</span>
					<span class="n">WDIOF_MAGICCLOSE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">firmware_version</span> <span class="o">=</span>	<span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">identity</span> <span class="o">=</span>		<span class="s">&quot;PCWD&quot;</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WDIOC_GETSUPPORT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ident</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ident</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_GETSTATUS</span>:
		<span class="n">pcwd_get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">WDIOC_GETBOOTSTATUS</span>:
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">boot_status</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">WDIOC_GETTEMP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_get_temperature</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temperature</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">WDIOC_SETOPTIONS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="n">PCWD_REVISION_C</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">argp</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&amp;</span> <span class="n">WDIOS_DISABLECARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">pcwd_stop</span><span class="p">();</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&amp;</span> <span class="n">WDIOS_ENABLECARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">pcwd_start</span><span class="p">();</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&amp;</span> <span class="n">WDIOS_TEMPPANIC</span><span class="p">)</span>
				<span class="n">temp_panic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_KEEPALIVE</span>:
		<span class="n">pcwd_keepalive</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_SETTIMEOUT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">new_heartbeat</span><span class="p">,</span> <span class="n">argp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_set_heartbeat</span><span class="p">(</span><span class="n">new_heartbeat</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">pcwd_keepalive</span><span class="p">();</span>
		<span class="cm">/* Fall */</span>

	<span class="k">case</span> <span class="n">WDIOC_GETTIMEOUT</span>:
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">heartbeat</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pcwd_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			  <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nowayout</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

			<span class="cm">/* In case it was set long ago */</span>
			<span class="n">expect_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;V&#39;</span><span class="p">)</span>
					<span class="n">expect_close</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">pcwd_keepalive</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcwd_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open_allowed</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nowayout</span><span class="p">)</span>
		<span class="n">__module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="cm">/* Activate */</span>
	<span class="n">pcwd_start</span><span class="p">();</span>
	<span class="n">pcwd_keepalive</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcwd_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">expect_close</span> <span class="o">==</span> <span class="mi">42</span><span class="p">)</span>
		<span class="n">pcwd_stop</span><span class="p">();</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;Unexpected close, not stopping watchdog!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pcwd_keepalive</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">expect_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open_allowed</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	/dev/temperature handling</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pcwd_temp_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			 <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temperature</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_get_temperature</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temperature</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temperature</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcwd_temp_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">supports_temp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcwd_temp_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Kernel Interfaces</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">pcwd_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">pcwd_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">pcwd_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">pcwd_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">pcwd_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">pcwd_miscdev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">minor</span> <span class="o">=</span>	<span class="n">WATCHDOG_MINOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;watchdog&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span> <span class="o">=</span>		<span class="o">&amp;</span><span class="n">pcwd_fops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">pcwd_temp_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">pcwd_temp_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">pcwd_temp_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">pcwd_temp_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">temp_miscdev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">minor</span> <span class="o">=</span>	<span class="n">TEMP_MINOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;temperature&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span> <span class="o">=</span>		<span class="o">&amp;</span><span class="n">pcwd_temp_fops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	Init &amp; exit routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_revision</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">PCWD_REVISION_C</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="cm">/* REV A cards use only 2 io ports; test</span>
<span class="cm">	 * presumes a floating bus reads as 0xff. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">PCWD_REVISION_A</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  The ISA cards have a heartbeat bit in one of the registers, which</span>
<span class="cm"> *  register is card dependent.  The heartbeat bit is monitored, and if</span>
<span class="cm"> *  found, is considered proof that a Berkshire card has been found.</span>
<span class="cm"> *  The initial rate is once per second at board start up, then twice</span>
<span class="cm"> *  per second for normal operation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pcwd_isa_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">base_addr</span> <span class="o">=</span> <span class="n">pcwd_ioports</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">port0</span><span class="p">,</span> <span class="n">last_port0</span><span class="p">;</span>	<span class="cm">/* Reg 0, in case it&#39;s REV A */</span>
	<span class="kt">int</span> <span class="n">port1</span><span class="p">,</span> <span class="n">last_port1</span><span class="p">;</span>	<span class="cm">/* Register 1 for REV C cards */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="n">DEBUG</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pcwd_isa_match id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">base_addr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;PCWD&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Port 0x%04x unavailable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">port0</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">base_addr</span><span class="p">);</span>	<span class="cm">/* For REV A boards */</span>
	<span class="n">port1</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* For REV C boards */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port0</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="n">port1</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Not an &#39;ff&#39; from a floating bus, so must be a card! */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

			<span class="n">last_port0</span> <span class="o">=</span> <span class="n">port0</span><span class="p">;</span>
			<span class="n">last_port1</span> <span class="o">=</span> <span class="n">port1</span><span class="p">;</span>

			<span class="n">port0</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">base_addr</span><span class="p">);</span>
			<span class="n">port1</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* Has either hearbeat bit changed?  */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">port0</span> <span class="o">^</span> <span class="n">last_port0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WD_HRTBT</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">port1</span> <span class="o">^</span> <span class="n">last_port1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WD_REVC_HRBT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">base_addr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pcwd_isa_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="n">DEBUG</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pcwd_isa_probe id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="n">cards_found</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cards_found</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;v%s Ken Hollis (kenji@bitgate.com)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">WATCHDOG_VERSION</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cards_found</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;This driver only supports 1 device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_ioports</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No I/O-Address for card detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">=</span> <span class="n">pcwd_ioports</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="cm">/* Check card&#39;s revision */</span>
	<span class="n">pcwd_private</span><span class="p">.</span><span class="n">revision</span> <span class="o">=</span> <span class="n">get_revision</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span><span class="p">,</span>
		<span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="n">PCWD_REVISION_A</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;PCWD&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;I/O address 0x%04x already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_request_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initial variables */</span>
	<span class="n">pcwd_private</span><span class="p">.</span><span class="n">supports_temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">temp_panic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pcwd_private</span><span class="p">.</span><span class="n">boot_status</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>

	<span class="cm">/* get the boot_status */</span>
	<span class="n">pcwd_get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">boot_status</span><span class="p">);</span>

	<span class="cm">/* clear the &quot;card caused reboot&quot; flag */</span>
	<span class="n">pcwd_clear_status</span><span class="p">();</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="n">pcwd_timer_ping</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*  Disable the board  */</span>
	<span class="n">pcwd_stop</span><span class="p">();</span>

	<span class="cm">/*  Check whether or not the card supports the temperature device */</span>
	<span class="n">pcwd_check_temperature_support</span><span class="p">();</span>

	<span class="cm">/* Show info about the card itself */</span>
	<span class="n">pcwd_show_card_info</span><span class="p">();</span>

	<span class="cm">/* If heartbeat = 0 then we use the heartbeat from the dip-switches */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">heartbeat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">heartbeat</span> <span class="o">=</span> <span class="n">heartbeat_tbl</span><span class="p">[(</span><span class="n">pcwd_get_option_switches</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)];</span>

	<span class="cm">/* Check that the heartbeat value is within it&#39;s range;</span>
<span class="cm">	   if not reset to the default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_set_heartbeat</span><span class="p">(</span><span class="n">heartbeat</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pcwd_set_heartbeat</span><span class="p">(</span><span class="n">WATCHDOG_HEARTBEAT</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;heartbeat value must be 2 &lt;= heartbeat &lt;= 7200, using %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">WATCHDOG_HEARTBEAT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">supports_temp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp_miscdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot register miscdev on minor=%d (err=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">TEMP_MINOR</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error_misc_register_temp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_miscdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot register miscdev on minor=%d (err=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">WATCHDOG_MINOR</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_misc_register_watchdog</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;initialized. heartbeat=%d sec (nowayout=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">heartbeat</span><span class="p">,</span> <span class="n">nowayout</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_misc_register_watchdog:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">supports_temp</span><span class="p">)</span>
		<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp_miscdev</span><span class="p">);</span>
<span class="nl">error_misc_register_temp:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span><span class="p">,</span>
			<span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="n">PCWD_REVISION_A</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">4</span><span class="p">);</span>
<span class="nl">error_request_region:</span>
	<span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">cards_found</span><span class="o">--</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">pcwd_isa_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="n">DEBUG</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pcwd_isa_remove id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*  Disable the board  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nowayout</span><span class="p">)</span>
		<span class="n">pcwd_stop</span><span class="p">();</span>

	<span class="cm">/* Deregister */</span>
	<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_miscdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">supports_temp</span><span class="p">)</span>
		<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp_miscdev</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span><span class="p">,</span>
			<span class="p">(</span><span class="n">pcwd_private</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="n">PCWD_REVISION_A</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">pcwd_private</span><span class="p">.</span><span class="n">io_addr</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">cards_found</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcwd_isa_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="n">DEBUG</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pcwd_isa_shutdown id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="n">pcwd_stop</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isa_driver</span> <span class="n">pcwd_isa_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match</span>		<span class="o">=</span> <span class="n">pcwd_isa_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">pcwd_isa_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">pcwd_isa_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">pcwd_isa_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">WATCHDOG_NAME</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pcwd_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">isa_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_isa_driver</span><span class="p">,</span> <span class="n">PCWD_ISA_NR_CARDS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pcwd_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isa_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcwd_isa_driver</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Watchdog Module Unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">pcwd_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pcwd_cleanup_module</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ken Hollis &lt;kenji@bitgate.com&gt;, &quot;</span>
		<span class="s">&quot;Wim Van Sebroeck &lt;wim@iguana.be&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Berkshire ISA-PC Watchdog driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">WATCHDOG_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_MISCDEV</span><span class="p">(</span><span class="n">WATCHDOG_MINOR</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_MISCDEV</span><span class="p">(</span><span class="n">TEMP_MINOR</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
