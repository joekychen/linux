<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › watchdog › f71808e_wdt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>f71808e_wdt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/***************************************************************************</span>
<span class="cm"> *   Copyright (C) 2006 by Hans Edgington &lt;hans@edgington.nl&gt;              *</span>
<span class="cm"> *   Copyright (C) 2007-2009 Hans de Goede &lt;hdegoede@redhat.com&gt;           *</span>
<span class="cm"> *   Copyright (C) 2010 Giel van Schijndel &lt;me@mortis.eu&gt;                  *</span>
<span class="cm"> *                                                                         *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify  *</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by  *</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or     *</span>
<span class="cm"> *   (at your option) any later version.                                   *</span>
<span class="cm"> *                                                                         *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,       *</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *</span>
<span class="cm"> *   GNU General Public License for more details.                          *</span>
<span class="cm"> *                                                                         *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License     *</span>
<span class="cm"> *   along with this program; if not, write to the                         *</span>
<span class="cm"> *   Free Software Foundation, Inc.,                                       *</span>
<span class="cm"> *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *</span>
<span class="cm"> ***************************************************************************/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/watchdog.h&gt;</span>

<span class="cp">#define DRVNAME &quot;f71808e_wdt&quot;</span>

<span class="cp">#define SIO_F71808FG_LD_WDT	0x07	</span><span class="cm">/* Watchdog timer logical device */</span><span class="cp"></span>
<span class="cp">#define SIO_UNLOCK_KEY		0x87	</span><span class="cm">/* Key to enable Super-I/O */</span><span class="cp"></span>
<span class="cp">#define SIO_LOCK_KEY		0xAA	</span><span class="cm">/* Key to diasble Super-I/O */</span><span class="cp"></span>

<span class="cp">#define SIO_REG_LDSEL		0x07	</span><span class="cm">/* Logical device select */</span><span class="cp"></span>
<span class="cp">#define SIO_REG_DEVID		0x20	</span><span class="cm">/* Device ID (2 bytes) */</span><span class="cp"></span>
<span class="cp">#define SIO_REG_DEVREV		0x22	</span><span class="cm">/* Device revision */</span><span class="cp"></span>
<span class="cp">#define SIO_REG_MANID		0x23	</span><span class="cm">/* Fintek ID (2 bytes) */</span><span class="cp"></span>
<span class="cp">#define SIO_REG_ROM_ADDR_SEL	0x27	</span><span class="cm">/* ROM address select */</span><span class="cp"></span>
<span class="cp">#define SIO_REG_MFUNCT1		0x29	</span><span class="cm">/* Multi function select 1 */</span><span class="cp"></span>
<span class="cp">#define SIO_REG_MFUNCT2		0x2a	</span><span class="cm">/* Multi function select 2 */</span><span class="cp"></span>
<span class="cp">#define SIO_REG_MFUNCT3		0x2b	</span><span class="cm">/* Multi function select 3 */</span><span class="cp"></span>
<span class="cp">#define SIO_REG_ENABLE		0x30	</span><span class="cm">/* Logical device enable */</span><span class="cp"></span>
<span class="cp">#define SIO_REG_ADDR		0x60	</span><span class="cm">/* Logical device address (2 bytes) */</span><span class="cp"></span>

<span class="cp">#define SIO_FINTEK_ID		0x1934	</span><span class="cm">/* Manufacturers ID */</span><span class="cp"></span>
<span class="cp">#define SIO_F71808_ID		0x0901	</span><span class="cm">/* Chipset ID */</span><span class="cp"></span>
<span class="cp">#define SIO_F71858_ID		0x0507	</span><span class="cm">/* Chipset ID */</span><span class="cp"></span>
<span class="cp">#define SIO_F71862_ID		0x0601	</span><span class="cm">/* Chipset ID */</span><span class="cp"></span>
<span class="cp">#define SIO_F71869_ID		0x0814	</span><span class="cm">/* Chipset ID */</span><span class="cp"></span>
<span class="cp">#define SIO_F71882_ID		0x0541	</span><span class="cm">/* Chipset ID */</span><span class="cp"></span>
<span class="cp">#define SIO_F71889_ID		0x0723	</span><span class="cm">/* Chipset ID */</span><span class="cp"></span>

<span class="cp">#define F71808FG_REG_WDO_CONF		0xf0</span>
<span class="cp">#define F71808FG_REG_WDT_CONF		0xf5</span>
<span class="cp">#define F71808FG_REG_WD_TIME		0xf6</span>

<span class="cp">#define F71808FG_FLAG_WDOUT_EN		7</span>

<span class="cp">#define F71808FG_FLAG_WDTMOUT_STS	5</span>
<span class="cp">#define F71808FG_FLAG_WD_EN		5</span>
<span class="cp">#define F71808FG_FLAG_WD_PULSE		4</span>
<span class="cp">#define F71808FG_FLAG_WD_UNIT		3</span>

<span class="cm">/* Default values */</span>
<span class="cp">#define WATCHDOG_TIMEOUT	60	</span><span class="cm">/* 1 minute default timeout */</span><span class="cp"></span>
<span class="cp">#define WATCHDOG_MAX_TIMEOUT	(60 * 255)</span>
<span class="cp">#define WATCHDOG_PULSE_WIDTH	125	</span><span class="cm">/* 125 ms, default pulse width for</span>
<span class="cm">					   watchdog signal */</span><span class="cp"></span>
<span class="cp">#define WATCHDOG_F71862FG_PIN	63	</span><span class="cm">/* default watchdog reset output</span>
<span class="cm">					   pin number 63 */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">force_id</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">force_id</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">force_id</span><span class="p">,</span> <span class="s">&quot;Override the detected device ID&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">max_timeout</span> <span class="o">=</span> <span class="n">WATCHDOG_MAX_TIMEOUT</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">WATCHDOG_TIMEOUT</span><span class="p">;</span>	<span class="cm">/* default timeout in seconds */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span>
	<span class="s">&quot;Watchdog timeout in seconds. 1&lt;= timeout &lt;=&quot;</span>
			<span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">WATCHDOG_MAX_TIMEOUT</span><span class="p">)</span> <span class="s">&quot; (default=&quot;</span>
			<span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">WATCHDOG_TIMEOUT</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pulse_width</span> <span class="o">=</span> <span class="n">WATCHDOG_PULSE_WIDTH</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pulse_width</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pulse_width</span><span class="p">,</span>
	<span class="s">&quot;Watchdog signal pulse width. 0(=level), 1 ms, 25 ms, 125 ms or 5000 ms&quot;</span>
			<span class="s">&quot; (default=&quot;</span> <span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">WATCHDOG_PULSE_WIDTH</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">f71862fg_pin</span> <span class="o">=</span> <span class="n">WATCHDOG_F71862FG_PIN</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">f71862fg_pin</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">f71862fg_pin</span><span class="p">,</span>
	<span class="s">&quot;Watchdog f71862fg reset output pin configuration. Choose pin 56 or 63&quot;</span>
			<span class="s">&quot; (default=&quot;</span> <span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">WATCHDOG_F71862FG_PIN</span><span class="p">)</span><span class="s">&quot;)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">nowayout</span> <span class="o">=</span> <span class="n">WATCHDOG_NOWAYOUT</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nowayout</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nowayout</span><span class="p">,</span> <span class="s">&quot;Disable watchdog shutdown on close&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start_withtimeout</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">start_withtimeout</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">start_withtimeout</span><span class="p">,</span> <span class="s">&quot;Start watchdog timer on module load with&quot;</span>
	<span class="s">&quot; given initial timeout. Zero (default) disables this feature.&quot;</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">chips</span> <span class="p">{</span> <span class="n">f71808fg</span><span class="p">,</span> <span class="n">f71858fg</span><span class="p">,</span> <span class="n">f71862fg</span><span class="p">,</span> <span class="n">f71869</span><span class="p">,</span> <span class="n">f71882fg</span><span class="p">,</span> <span class="n">f71889fg</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">f71808e_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;f71808fg&quot;</span><span class="p">,</span>
	<span class="s">&quot;f71858fg&quot;</span><span class="p">,</span>
	<span class="s">&quot;f71862fg&quot;</span><span class="p">,</span>
	<span class="s">&quot;f71869&quot;</span><span class="p">,</span>
	<span class="s">&quot;f71882fg&quot;</span><span class="p">,</span>
	<span class="s">&quot;f71889fg&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Super-I/O Function prototypes */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">superio_inb</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">superio_inw</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">superio_outb</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">superio_set_bit</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">superio_clear_bit</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">superio_enter</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">superio_select</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ld</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">superio_exit</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">watchdog_data</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">sioaddr</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">chips</span>	<span class="n">type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">opened</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>	<span class="n">lock</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="n">expect_close</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">watchdog_info</span> <span class="n">ident</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">timeout</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">timer_val</span><span class="p">;</span>	<span class="cm">/* content for the wd_time register */</span>
	<span class="kt">char</span>		<span class="n">minutes_mode</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">pulse_val</span><span class="p">;</span>	<span class="cm">/* pulse width flag */</span>
	<span class="kt">char</span>		<span class="n">pulse_mode</span><span class="p">;</span>	<span class="cm">/* enable pulse output mode? */</span>
	<span class="kt">char</span>		<span class="n">caused_reboot</span><span class="p">;</span>	<span class="cm">/* last reboot was by the watchdog */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">watchdog_data</span> <span class="n">watchdog</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">__MUTEX_INITIALIZER</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Super I/O functions */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">superio_inb</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">superio_inw</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span>  <span class="o">=</span> <span class="n">superio_inb</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">superio_inb</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">superio_outb</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">superio_set_bit</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="n">superio_inb</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">superio_outb</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">superio_clear_bit</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="n">superio_inb</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">superio_outb</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">superio_enter</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Don&#39;t step on other drivers&#39; I/O space by accident */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_muxed_region</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">DRVNAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;I/O address 0x%04x already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">base</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* according to the datasheet the key must be send twice! */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">SIO_UNLOCK_KEY</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">SIO_UNLOCK_KEY</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">superio_select</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ld</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">SIO_REG_LDSEL</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">ld</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">superio_exit</span><span class="p">(</span><span class="kt">int</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">SIO_LOCK_KEY</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_set_timeout</span><span class="p">(</span><span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span>
	 <span class="o">||</span> <span class="n">timeout</span> <span class="o">&gt;</span>  <span class="n">max_timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;watchdog timeout out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">watchdog</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">watchdog</span><span class="p">.</span><span class="n">timer_val</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
		<span class="n">watchdog</span><span class="p">.</span><span class="n">minutes_mode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">watchdog</span><span class="p">.</span><span class="n">timer_val</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
		<span class="n">watchdog</span><span class="p">.</span><span class="n">minutes_mode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_set_pulse_width</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span>        <span class="p">(</span><span class="n">pw</span> <span class="o">&lt;=</span>    <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">watchdog</span><span class="p">.</span><span class="n">pulse_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pw</span> <span class="o">&lt;=</span>   <span class="mi">25</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">watchdog</span><span class="p">.</span><span class="n">pulse_val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pw</span> <span class="o">&lt;=</span>  <span class="mi">125</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">watchdog</span><span class="p">.</span><span class="n">pulse_val</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pw</span> <span class="o">&lt;=</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">watchdog</span><span class="p">.</span><span class="n">pulse_val</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;pulse width out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">watchdog</span><span class="p">.</span><span class="n">pulse_mode</span> <span class="o">=</span> <span class="n">pw</span><span class="p">;</span>

<span class="nl">exit_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_keepalive</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">superio_enter</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>
	<span class="n">superio_select</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_F71808FG_LD_WDT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">minutes_mode</span><span class="p">)</span>
		<span class="cm">/* select minutes for timer units */</span>
		<span class="n">superio_set_bit</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">F71808FG_REG_WDT_CONF</span><span class="p">,</span>
				<span class="n">F71808FG_FLAG_WD_UNIT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* select seconds for timer units */</span>
		<span class="n">superio_clear_bit</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">F71808FG_REG_WDT_CONF</span><span class="p">,</span>
				<span class="n">F71808FG_FLAG_WD_UNIT</span><span class="p">);</span>

	<span class="cm">/* Set timer value */</span>
	<span class="n">superio_outb</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">F71808FG_REG_WD_TIME</span><span class="p">,</span>
			   <span class="n">watchdog</span><span class="p">.</span><span class="n">timer_val</span><span class="p">);</span>

	<span class="n">superio_exit</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">);</span>

<span class="nl">exit_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">f71862fg_pin_configure</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* When ioaddr is non-zero the calling function has to take care of</span>
<span class="cm">	   mutex handling and superio preparation! */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f71862fg_pin</span> <span class="o">==</span> <span class="mi">63</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* SPI must be disabled first to use this pin! */</span>
			<span class="n">superio_clear_bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">SIO_REG_ROM_ADDR_SEL</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
			<span class="n">superio_set_bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">SIO_REG_MFUNCT3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f71862fg_pin</span> <span class="o">==</span> <span class="mi">56</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span>
			<span class="n">superio_set_bit</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">SIO_REG_MFUNCT1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Invalid argument f71862fg_pin=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">f71862fg_pin</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Make sure we don&#39;t die as soon as the watchdog is enabled below */</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">watchdog_keepalive</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">superio_enter</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>
	<span class="n">superio_select</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_F71808FG_LD_WDT</span><span class="p">);</span>

	<span class="cm">/* Watchdog pin configuration */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">f71808fg</span>:
		<span class="cm">/* Set pin 21 to GPIO23/WDTRST#, then to WDTRST# */</span>
		<span class="n">superio_clear_bit</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_REG_MFUNCT2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">superio_clear_bit</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_REG_MFUNCT3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">f71862fg</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">f71862fg_pin_configure</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_superio</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">f71869</span>:
		<span class="cm">/* GPIO14 --&gt; WDTRST# */</span>
		<span class="n">superio_clear_bit</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_REG_MFUNCT1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">f71882fg</span>:
		<span class="cm">/* Set pin 56 to WDTRST# */</span>
		<span class="n">superio_set_bit</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_REG_MFUNCT1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">f71889fg</span>:
		<span class="cm">/* set pin 40 to WDTRST# */</span>
		<span class="n">superio_outb</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_REG_MFUNCT3</span><span class="p">,</span>
			<span class="n">superio_inb</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_REG_MFUNCT3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xcf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * &#39;default&#39; label to shut up the compiler and catch</span>
<span class="cm">		 * programmer errors</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_superio</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">superio_select</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_F71808FG_LD_WDT</span><span class="p">);</span>
	<span class="n">superio_set_bit</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_REG_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">superio_set_bit</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">F71808FG_REG_WDO_CONF</span><span class="p">,</span>
			<span class="n">F71808FG_FLAG_WDOUT_EN</span><span class="p">);</span>

	<span class="n">superio_set_bit</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">F71808FG_REG_WDT_CONF</span><span class="p">,</span>
			<span class="n">F71808FG_FLAG_WD_EN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">pulse_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Select &quot;pulse&quot; output mode with given duration */</span>
		<span class="n">u8</span> <span class="n">wdt_conf</span> <span class="o">=</span> <span class="n">superio_inb</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span>
				<span class="n">F71808FG_REG_WDT_CONF</span><span class="p">);</span>

		<span class="cm">/* Set WD_PSWIDTH bits (1:0) */</span>
		<span class="n">wdt_conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">wdt_conf</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">pulse_val</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="cm">/* Set WD_PULSE to &quot;pulse&quot; mode */</span>
		<span class="n">wdt_conf</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">F71808FG_FLAG_WD_PULSE</span><span class="p">);</span>

		<span class="n">superio_outb</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">F71808FG_REG_WDT_CONF</span><span class="p">,</span>
				<span class="n">wdt_conf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Select &quot;level&quot; output mode */</span>
		<span class="n">superio_clear_bit</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">F71808FG_REG_WDT_CONF</span><span class="p">,</span>
				<span class="n">F71808FG_FLAG_WD_PULSE</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">exit_superio:</span>
	<span class="n">superio_exit</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">);</span>
<span class="nl">exit_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_stop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">superio_enter</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>
	<span class="n">superio_select</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_F71808FG_LD_WDT</span><span class="p">);</span>

	<span class="n">superio_clear_bit</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">F71808FG_REG_WDT_CONF</span><span class="p">,</span>
			<span class="n">F71808FG_FLAG_WD_EN</span><span class="p">);</span>

	<span class="n">superio_exit</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">);</span>

<span class="nl">exit_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_get_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">caused_reboot</span><span class="p">)</span> <span class="o">?</span> <span class="n">WDIOF_CARDRESET</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">watchdog_is_running</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * if we fail to determine the watchdog&#39;s status assume it to be</span>
<span class="cm">	 * running to be on the safe side</span>
<span class="cm">	 */</span>
	<span class="n">bool</span> <span class="n">is_running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">superio_enter</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>
	<span class="n">superio_select</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_F71808FG_LD_WDT</span><span class="p">);</span>

	<span class="n">is_running</span> <span class="o">=</span> <span class="p">(</span><span class="n">superio_inb</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_REG_ENABLE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">superio_inb</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">F71808FG_REG_WDT_CONF</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="n">F71808FG_FLAG_WD_EN</span><span class="p">);</span>

	<span class="n">superio_exit</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">);</span>

<span class="nl">exit_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">is_running</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* /dev/watchdog api */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* If the watchdog is alive we don&#39;t need to start it again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">opened</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">watchdog_start</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">opened</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nowayout</span><span class="p">)</span>
		<span class="n">__module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>

	<span class="n">watchdog</span><span class="p">.</span><span class="n">expect_close</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">opened</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">watchdog</span><span class="p">.</span><span class="n">expect_close</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">watchdog_keepalive</span><span class="p">();</span>
		<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;Unexpected close, not stopping watchdog!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nowayout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">watchdog_stop</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *      watchdog_write:</span>
<span class="cm"> *      @file: file handle to the watchdog</span>
<span class="cm"> *      @buf: buffer to write</span>
<span class="cm"> *      @count: count of bytes</span>
<span class="cm"> *      @ppos: pointer to the position to write. No seeks allowed</span>
<span class="cm"> *</span>
<span class="cm"> *      A write to a watchdog device is defined as a keepalive signal. Any</span>
<span class="cm"> *      write of data will do, as we we don&#39;t define content meaning.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">watchdog_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nowayout</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

			<span class="cm">/* In case it was set long ago */</span>
			<span class="n">bool</span> <span class="n">expect_close</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">expect_close</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;V&#39;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* Properly order writes across fork()ed processes */</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">watchdog</span><span class="p">.</span><span class="n">expect_close</span> <span class="o">=</span> <span class="n">expect_close</span><span class="p">;</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* someone wrote to us, we should restart timer */</span>
		<span class="n">watchdog_keepalive</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *      watchdog_ioctl:</span>
<span class="cm"> *      @inode: inode of the device</span>
<span class="cm"> *      @file: file handle to the device</span>
<span class="cm"> *      @cmd: watchdog command</span>
<span class="cm"> *      @arg: argument pointer</span>
<span class="cm"> *</span>
<span class="cm"> *      The watchdog API defines a common set of functions for all watchdogs</span>
<span class="cm"> *      according to their available features.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">watchdog_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_options</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_timeout</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">watchdog_info</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ident</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">uarg</span><span class="p">;</span>

	<span class="n">uarg</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WDIOC_GETSUPPORT</span>:
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">uarg</span><span class="p">.</span><span class="n">ident</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">ident</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">ident</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_GETSTATUS</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">watchdog_get_status</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">uarg</span><span class="p">.</span><span class="n">i</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">WDIOC_GETBOOTSTATUS</span>:
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">uarg</span><span class="p">.</span><span class="n">i</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">WDIOC_SETOPTIONS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">new_options</span><span class="p">,</span> <span class="n">uarg</span><span class="p">.</span><span class="n">i</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_options</span> <span class="o">&amp;</span> <span class="n">WDIOS_DISABLECARD</span><span class="p">)</span>
			<span class="n">watchdog_stop</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_options</span> <span class="o">&amp;</span> <span class="n">WDIOS_ENABLECARD</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">watchdog_start</span><span class="p">();</span>


	<span class="k">case</span> <span class="n">WDIOC_KEEPALIVE</span>:
		<span class="n">watchdog_keepalive</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_SETTIMEOUT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">new_timeout</span><span class="p">,</span> <span class="n">uarg</span><span class="p">.</span><span class="n">i</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">watchdog_set_timeout</span><span class="p">(</span><span class="n">new_timeout</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">watchdog_keepalive</span><span class="p">();</span>
		<span class="cm">/* Fall */</span>

	<span class="k">case</span> <span class="n">WDIOC_GETTIMEOUT</span>:
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">uarg</span><span class="p">.</span><span class="n">i</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">watchdog_notify_sys</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">SYS_DOWN</span> <span class="o">||</span> <span class="n">code</span> <span class="o">==</span> <span class="n">SYS_HALT</span><span class="p">)</span>
		<span class="n">watchdog_stop</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">watchdog_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">watchdog_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">watchdog_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">watchdog_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">watchdog_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">watchdog_miscdev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">minor</span>		<span class="o">=</span> <span class="n">WATCHDOG_MINOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;watchdog&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">watchdog_fops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">watchdog_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">watchdog_notify_sys</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">watchdog_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">sioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">wdt_conf</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* No need to lock watchdog.lock here because no entry points</span>
<span class="cm">	 * into the module have been registered yet.</span>
<span class="cm">	 */</span>
	<span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span> <span class="o">=</span> <span class="n">sioaddr</span><span class="p">;</span>
	<span class="n">watchdog</span><span class="p">.</span><span class="n">ident</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">WDIOC_SETTIMEOUT</span>
				<span class="o">|</span> <span class="n">WDIOF_MAGICCLOSE</span>
				<span class="o">|</span> <span class="n">WDIOF_KEEPALIVEPING</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">ident</span><span class="p">.</span><span class="n">identity</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">ident</span><span class="p">.</span><span class="n">identity</span><span class="p">),</span> <span class="s">&quot;%s watchdog&quot;</span><span class="p">,</span>
		<span class="n">f71808e_names</span><span class="p">[</span><span class="n">watchdog</span><span class="p">.</span><span class="n">type</span><span class="p">]);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">superio_enter</span><span class="p">(</span><span class="n">sioaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">superio_select</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_F71808FG_LD_WDT</span><span class="p">);</span>

	<span class="n">wdt_conf</span> <span class="o">=</span> <span class="n">superio_inb</span><span class="p">(</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">F71808FG_REG_WDT_CONF</span><span class="p">);</span>
	<span class="n">watchdog</span><span class="p">.</span><span class="n">caused_reboot</span> <span class="o">=</span> <span class="n">wdt_conf</span> <span class="o">&amp;</span> <span class="n">F71808FG_FLAG_WDTMOUT_STS</span><span class="p">;</span>

	<span class="n">superio_exit</span><span class="p">(</span><span class="n">sioaddr</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">watchdog_set_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">watchdog_set_pulse_width</span><span class="p">(</span><span class="n">pulse_width</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_miscdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot register miscdev on minor=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">watchdog_miscdev</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_reboot</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_withtimeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start_withtimeout</span> <span class="o">&lt;=</span> <span class="mi">0</span>
		 <span class="o">||</span> <span class="n">start_withtimeout</span> <span class="o">&gt;</span>  <span class="n">max_timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;starting timeout out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_miscdev</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">watchdog_start</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot start watchdog timer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit_miscdev</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">superio_enter</span><span class="p">(</span><span class="n">sioaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>
		<span class="n">superio_select</span><span class="p">(</span><span class="n">watchdog</span><span class="p">.</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_F71808FG_LD_WDT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">start_withtimeout</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* select minutes for timer units */</span>
			<span class="n">superio_set_bit</span><span class="p">(</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">F71808FG_REG_WDT_CONF</span><span class="p">,</span>
				<span class="n">F71808FG_FLAG_WD_UNIT</span><span class="p">);</span>
			<span class="n">superio_outb</span><span class="p">(</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">F71808FG_REG_WD_TIME</span><span class="p">,</span>
				<span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">start_withtimeout</span><span class="p">,</span> <span class="mi">60</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* select seconds for timer units */</span>
			<span class="n">superio_clear_bit</span><span class="p">(</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">F71808FG_REG_WDT_CONF</span><span class="p">,</span>
				<span class="n">F71808FG_FLAG_WD_UNIT</span><span class="p">);</span>
			<span class="n">superio_outb</span><span class="p">(</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">F71808FG_REG_WD_TIME</span><span class="p">,</span>
				<span class="n">start_withtimeout</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">superio_exit</span><span class="p">(</span><span class="n">sioaddr</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nowayout</span><span class="p">)</span>
			<span class="n">__module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>

		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;watchdog started with initial timeout of %u sec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">start_withtimeout</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="nl">exit_miscdev:</span>
	<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_miscdev</span><span class="p">);</span>
<span class="nl">exit_reboot:</span>
	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_notifier</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">f71808e_find</span><span class="p">(</span><span class="kt">int</span> <span class="n">sioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">devid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">superio_enter</span><span class="p">(</span><span class="n">sioaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">devid</span> <span class="o">=</span> <span class="n">superio_inw</span><span class="p">(</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_REG_MANID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devid</span> <span class="o">!=</span> <span class="n">SIO_FINTEK_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Not a Fintek device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devid</span> <span class="o">=</span> <span class="n">force_id</span> <span class="o">?</span> <span class="n">force_id</span> <span class="o">:</span> <span class="n">superio_inw</span><span class="p">(</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_REG_DEVID</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">devid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIO_F71808_ID</span>:
		<span class="n">watchdog</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">f71808fg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIO_F71862_ID</span>:
		<span class="n">watchdog</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">f71862fg</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">f71862fg_pin_configure</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* validate module parameter */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIO_F71869_ID</span>:
		<span class="n">watchdog</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">f71869</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIO_F71882_ID</span>:
		<span class="n">watchdog</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">f71882fg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIO_F71889_ID</span>:
		<span class="n">watchdog</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">f71889fg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIO_F71858_ID</span>:
		<span class="cm">/* Confirmed (by datasheet) not to have a watchdog. */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unrecognized Fintek device: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">devid</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Found %s watchdog chip, revision %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">f71808e_names</span><span class="p">[</span><span class="n">watchdog</span><span class="p">.</span><span class="n">type</span><span class="p">],</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">superio_inb</span><span class="p">(</span><span class="n">sioaddr</span><span class="p">,</span> <span class="n">SIO_REG_DEVREV</span><span class="p">));</span>
<span class="nl">exit:</span>
	<span class="n">superio_exit</span><span class="p">(</span><span class="n">sioaddr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">f71808e_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x4e</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">addrs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">f71808e_find</span><span class="p">(</span><span class="n">addrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">addrs</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">watchdog_init</span><span class="p">(</span><span class="n">addrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">f71808e_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">watchdog_is_running</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Watchdog timer still running, stopping it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">watchdog_stop</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_miscdev</span><span class="p">);</span>
	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">watchdog_notifier</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;F71808E Watchdog Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Giel van Schijndel &lt;me@mortis.eu&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">f71808e_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">f71808e_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
