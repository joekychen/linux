<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › watchdog › iTCO_wdt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>iTCO_wdt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	intel TCO Watchdog Driver</span>
<span class="cm"> *</span>
<span class="cm"> *	(c) Copyright 2006-2011 Wim Van Sebroeck &lt;wim@iguana.be&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License</span>
<span class="cm"> *	as published by the Free Software Foundation; either version</span>
<span class="cm"> *	2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	Neither Wim Van Sebroeck nor Iguana vzw. admit liability nor</span>
<span class="cm"> *	provide warranty for any of this software. This material is</span>
<span class="cm"> *	provided &quot;AS-IS&quot; and at no charge.</span>
<span class="cm"> *</span>
<span class="cm"> *	The TCO watchdog is implemented in the following I/O controller hubs:</span>
<span class="cm"> *	(See the intel documentation on http://developer.intel.com.)</span>
<span class="cm"> *	document number 290655-003, 290677-014: 82801AA (ICH), 82801AB (ICHO)</span>
<span class="cm"> *	document number 290687-002, 298242-027: 82801BA (ICH2)</span>
<span class="cm"> *	document number 290733-003, 290739-013: 82801CA (ICH3-S)</span>
<span class="cm"> *	document number 290716-001, 290718-007: 82801CAM (ICH3-M)</span>
<span class="cm"> *	document number 290744-001, 290745-025: 82801DB (ICH4)</span>
<span class="cm"> *	document number 252337-001, 252663-008: 82801DBM (ICH4-M)</span>
<span class="cm"> *	document number 273599-001, 273645-002: 82801E (C-ICH)</span>
<span class="cm"> *	document number 252516-001, 252517-028: 82801EB (ICH5), 82801ER (ICH5R)</span>
<span class="cm"> *	document number 300641-004, 300884-013: 6300ESB</span>
<span class="cm"> *	document number 301473-002, 301474-026: 82801F (ICH6)</span>
<span class="cm"> *	document number 313082-001, 313075-006: 631xESB, 632xESB</span>
<span class="cm"> *	document number 307013-003, 307014-024: 82801G (ICH7)</span>
<span class="cm"> *	document number 322896-001, 322897-001: NM10</span>
<span class="cm"> *	document number 313056-003, 313057-017: 82801H (ICH8)</span>
<span class="cm"> *	document number 316972-004, 316973-012: 82801I (ICH9)</span>
<span class="cm"> *	document number 319973-002, 319974-002: 82801J (ICH10)</span>
<span class="cm"> *	document number 322169-001, 322170-003: 5 Series, 3400 Series (PCH)</span>
<span class="cm"> *	document number 320066-003, 320257-008: EP80597 (IICH)</span>
<span class="cm"> *	document number 324645-001, 324646-001: Cougar Point (CPT)</span>
<span class="cm"> *	document number TBD                   : Patsburg (PBG)</span>
<span class="cm"> *	document number TBD                   : DH89xxCC</span>
<span class="cm"> *	document number TBD                   : Panther Point</span>
<span class="cm"> *	document number TBD                   : Lynx Point</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *	Includes, defines, variables, module parameters, ...</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cm">/* Module and version information */</span>
<span class="cp">#define DRV_NAME	&quot;iTCO_wdt&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;1.07&quot;</span>

<span class="cm">/* Includes */</span>
<span class="cp">#include &lt;linux/module.h&gt;		</span><span class="cm">/* For module specific items */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;		</span><span class="cm">/* For new moduleparam&#39;s */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/types.h&gt;		</span><span class="cm">/* For standard types (like size_t) */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/errno.h&gt;		</span><span class="cm">/* For the -ENODEV/... values */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/kernel.h&gt;		</span><span class="cm">/* For printk/panic/... */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;		</span><span class="cm">/* For MODULE_ALIAS_MISCDEV</span>
<span class="cm">							(WATCHDOG_MINOR) */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/watchdog.h&gt;		</span><span class="cm">/* For the watchdog specific items */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/init.h&gt;			</span><span class="cm">/* For __init/__exit/... */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/fs.h&gt;			</span><span class="cm">/* For file operations */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/platform_device.h&gt;	</span><span class="cm">/* For platform_driver framework */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/pci.h&gt;			</span><span class="cm">/* For pci functions */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/ioport.h&gt;		</span><span class="cm">/* For io-port access */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/spinlock.h&gt;		</span><span class="cm">/* For spin_lock/spin_unlock/... */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/uaccess.h&gt;		</span><span class="cm">/* For copy_to_user/put_user/... */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/io.h&gt;			</span><span class="cm">/* For inb/outb/... */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/mfd/core.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/lpc_ich.h&gt;</span>

<span class="cp">#include &quot;iTCO_vendor.h&quot;</span>

<span class="cm">/* Address definitions for the TCO */</span>
<span class="cm">/* TCO base address */</span>
<span class="cp">#define TCOBASE		(iTCO_wdt_private.tco_res-&gt;start)</span>
<span class="cm">/* SMI Control and Enable Register */</span>
<span class="cp">#define SMI_EN		(iTCO_wdt_private.smi_res-&gt;start)</span>

<span class="cp">#define TCO_RLD		(TCOBASE + 0x00) </span><span class="cm">/* TCO Timer Reload and Curr. Value */</span><span class="cp"></span>
<span class="cp">#define TCOv1_TMR	(TCOBASE + 0x01) </span><span class="cm">/* TCOv1 Timer Initial Value	*/</span><span class="cp"></span>
<span class="cp">#define TCO_DAT_IN	(TCOBASE + 0x02) </span><span class="cm">/* TCO Data In Register	*/</span><span class="cp"></span>
<span class="cp">#define TCO_DAT_OUT	(TCOBASE + 0x03) </span><span class="cm">/* TCO Data Out Register	*/</span><span class="cp"></span>
<span class="cp">#define TCO1_STS	(TCOBASE + 0x04) </span><span class="cm">/* TCO1 Status Register	*/</span><span class="cp"></span>
<span class="cp">#define TCO2_STS	(TCOBASE + 0x06) </span><span class="cm">/* TCO2 Status Register	*/</span><span class="cp"></span>
<span class="cp">#define TCO1_CNT	(TCOBASE + 0x08) </span><span class="cm">/* TCO1 Control Register	*/</span><span class="cp"></span>
<span class="cp">#define TCO2_CNT	(TCOBASE + 0x0a) </span><span class="cm">/* TCO2 Control Register	*/</span><span class="cp"></span>
<span class="cp">#define TCOv2_TMR	(TCOBASE + 0x12) </span><span class="cm">/* TCOv2 Timer Initial Value	*/</span><span class="cp"></span>

<span class="cm">/* internal variables */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">is_active</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">expect_release</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>		<span class="cm">/* this is private data for the iTCO_wdt device */</span>
	<span class="cm">/* TCO version/generation */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iTCO_version</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">tco_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">smi_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">gcs_res</span><span class="p">;</span>
	<span class="cm">/* NO_REBOOT flag is Memory-Mapped GCS register bit 5 (TCO version 2)*/</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">gcs</span><span class="p">;</span>
	<span class="cm">/* the lock for io operations */</span>
	<span class="n">spinlock_t</span> <span class="n">io_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="cm">/* the PCI-device */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
<span class="p">}</span> <span class="n">iTCO_wdt_private</span><span class="p">;</span>

<span class="cm">/* module parameters */</span>
<span class="cp">#define WATCHDOG_HEARTBEAT 30	</span><span class="cm">/* 30 sec default heartbeat */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">heartbeat</span> <span class="o">=</span> <span class="n">WATCHDOG_HEARTBEAT</span><span class="p">;</span>  <span class="cm">/* in seconds */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">heartbeat</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">heartbeat</span><span class="p">,</span> <span class="s">&quot;Watchdog timeout in seconds. &quot;</span>
	<span class="s">&quot;5..76 (TCO v1) or 3..614 (TCO v2), default=&quot;</span>
				<span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">WATCHDOG_HEARTBEAT</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">nowayout</span> <span class="o">=</span> <span class="n">WATCHDOG_NOWAYOUT</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nowayout</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nowayout</span><span class="p">,</span>
	<span class="s">&quot;Watchdog cannot be stopped once started (default=&quot;</span>
				<span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">WATCHDOG_NOWAYOUT</span><span class="p">)</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">turn_SMI_watchdog_clear_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">turn_SMI_watchdog_clear_off</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">turn_SMI_watchdog_clear_off</span><span class="p">,</span>
	<span class="s">&quot;Turn off SMI clearing watchdog (depends on TCO-version)(default=1)&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Some TCO specific functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">seconds_to_ticks</span><span class="p">(</span><span class="kt">int</span> <span class="n">seconds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* the internal timer is stored as ticks which decrement</span>
<span class="cm">	 * every 0.6 seconds */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">seconds</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iTCO_wdt_set_NO_REBOOT_bit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val32</span><span class="p">;</span>

	<span class="cm">/* Set the NO_REBOOT bit: this disables reboots */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs</span><span class="p">);</span>
		<span class="n">val32</span> <span class="o">|=</span> <span class="mh">0x00000020</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val32</span><span class="p">,</span> <span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
		<span class="n">val32</span> <span class="o">|=</span> <span class="mh">0x00000002</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="n">val32</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iTCO_wdt_unset_NO_REBOOT_bit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val32</span><span class="p">;</span>

	<span class="cm">/* Unset the NO_REBOOT bit: this enables reboots */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs</span><span class="p">);</span>
		<span class="n">val32</span> <span class="o">&amp;=</span> <span class="mh">0xffffffdf</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val32</span><span class="p">,</span> <span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs</span><span class="p">);</span>

		<span class="n">val32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val32</span> <span class="o">&amp;</span> <span class="mh">0x00000020</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
		<span class="n">val32</span> <span class="o">&amp;=</span> <span class="mh">0xfffffffd</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="n">val32</span><span class="p">);</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val32</span> <span class="o">&amp;</span> <span class="mh">0x00000002</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span> <span class="cm">/* returns: 0 = OK, -EIO = Error */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iTCO_wdt_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="n">iTCO_vendor_pre_start</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">smi_res</span><span class="p">,</span> <span class="n">heartbeat</span><span class="p">);</span>

	<span class="cm">/* disable chipset&#39;s NO_REBOOT bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_unset_NO_REBOOT_bit</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to reset NO_REBOOT flag, reboot disabled by hardware/BIOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Force the timer to its reload value by writing to the TCO_RLD</span>
<span class="cm">	   register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">TCO_RLD</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">TCO_RLD</span><span class="p">);</span>

	<span class="cm">/* Bit 11: TCO Timer Halt -&gt; 0 = The TCO timer is enabled to count */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">TCO1_CNT</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xf7ff</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">TCO1_CNT</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">TCO1_CNT</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0800</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iTCO_wdt_stop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="n">iTCO_vendor_pre_stop</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">smi_res</span><span class="p">);</span>

	<span class="cm">/* Bit 11: TCO Timer Halt -&gt; 1 = The TCO timer is disabled */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">TCO1_CNT</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x0800</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">TCO1_CNT</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">TCO1_CNT</span><span class="p">);</span>

	<span class="cm">/* Set the NO_REBOOT bit to prevent later reboots, just for sure */</span>
	<span class="n">iTCO_wdt_set_NO_REBOOT_bit</span><span class="p">();</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0800</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iTCO_wdt_keepalive</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="n">iTCO_vendor_pre_keepalive</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">smi_res</span><span class="p">,</span> <span class="n">heartbeat</span><span class="p">);</span>

	<span class="cm">/* Reload the timer by writing to the TCO Timer Counter register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">TCO_RLD</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset the timeout status bit so that the timer</span>
<span class="cm">		 * needs to count down twice again before rebooting */</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x0008</span><span class="p">,</span> <span class="n">TCO1_STS</span><span class="p">);</span>	<span class="cm">/* write 1 to clear bit */</span>

		<span class="n">outb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">TCO_RLD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iTCO_wdt_set_heartbeat</span><span class="p">(</span><span class="kt">int</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val16</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val8</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmrval</span><span class="p">;</span>

	<span class="n">tmrval</span> <span class="o">=</span> <span class="n">seconds_to_ticks</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="cm">/* For TCO v1 the timer counts down twice before rebooting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tmrval</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* from the specs: */</span>
	<span class="cm">/* &quot;Values of 0h-3h are ignored and should not be attempted&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmrval</span> <span class="o">&lt;</span> <span class="mh">0x04</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmrval</span> <span class="o">&gt;</span> <span class="mh">0x3ff</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmrval</span> <span class="o">&gt;</span> <span class="mh">0x03f</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">iTCO_vendor_pre_set_heartbeat</span><span class="p">(</span><span class="n">tmrval</span><span class="p">);</span>

	<span class="cm">/* Write new heartbeat to watchdog */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
		<span class="n">val16</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">TCOv2_TMR</span><span class="p">);</span>
		<span class="n">val16</span> <span class="o">&amp;=</span> <span class="mh">0xfc00</span><span class="p">;</span>
		<span class="n">val16</span> <span class="o">|=</span> <span class="n">tmrval</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">val16</span><span class="p">,</span> <span class="n">TCOv2_TMR</span><span class="p">);</span>
		<span class="n">val16</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">TCOv2_TMR</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val16</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tmrval</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
		<span class="n">val8</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">TCOv1_TMR</span><span class="p">);</span>
		<span class="n">val8</span> <span class="o">&amp;=</span> <span class="mh">0xc0</span><span class="p">;</span>
		<span class="n">val8</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tmrval</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">val8</span><span class="p">,</span> <span class="n">TCOv1_TMR</span><span class="p">);</span>
		<span class="n">val8</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">TCOv1_TMR</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val8</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tmrval</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">heartbeat</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iTCO_wdt_get_timeleft</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">time_left</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val16</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val8</span><span class="p">;</span>

	<span class="cm">/* read the TCO Timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
		<span class="n">val16</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">TCO_RLD</span><span class="p">);</span>
		<span class="n">val16</span> <span class="o">&amp;=</span> <span class="mh">0x3ff</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

		<span class="o">*</span><span class="n">time_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">val16</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>
		<span class="n">val8</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">TCO_RLD</span><span class="p">);</span>
		<span class="n">val8</span> <span class="o">&amp;=</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">TCO1_STS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0008</span><span class="p">))</span>
			<span class="n">val8</span> <span class="o">+=</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">TCOv1_TMR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

		<span class="o">*</span><span class="n">time_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">val8</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	/dev/watchdog handling</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iTCO_wdt_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* /dev/watchdog can only be opened once */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is_active</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *      Reload and activate timer</span>
<span class="cm">	 */</span>
	<span class="n">iTCO_wdt_start</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iTCO_wdt_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *      Shut off the timer.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">expect_release</span> <span class="o">==</span> <span class="mi">42</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iTCO_wdt_stop</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;Unexpected close, not stopping watchdog!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">iTCO_wdt_keepalive</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is_active</span><span class="p">);</span>
	<span class="n">expect_release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">iTCO_wdt_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* See if we got the magic character &#39;V&#39; and reload the timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nowayout</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

			<span class="cm">/* note: just in case someone wrote the magic</span>
<span class="cm">			   character five months ago... */</span>
			<span class="n">expect_release</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* scan to see whether or not we got the</span>
<span class="cm">			   magic character */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;V&#39;</span><span class="p">)</span>
					<span class="n">expect_release</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* someone wrote to us, we should reload the timer */</span>
		<span class="n">iTCO_wdt_keepalive</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">iTCO_wdt_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
							<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_options</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_heartbeat</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">argp</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">watchdog_info</span> <span class="n">ident</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">options</span> <span class="o">=</span>		<span class="n">WDIOF_SETTIMEOUT</span> <span class="o">|</span>
					<span class="n">WDIOF_KEEPALIVEPING</span> <span class="o">|</span>
					<span class="n">WDIOF_MAGICCLOSE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">firmware_version</span> <span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">identity</span> <span class="o">=</span>		<span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WDIOC_GETSUPPORT</span>:
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ident</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ident</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WDIOC_GETSTATUS</span>:
	<span class="k">case</span> <span class="n">WDIOC_GETBOOTSTATUS</span>:
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">WDIOC_SETOPTIONS</span>:
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">new_options</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_options</span> <span class="o">&amp;</span> <span class="n">WDIOS_DISABLECARD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iTCO_wdt_stop</span><span class="p">();</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_options</span> <span class="o">&amp;</span> <span class="n">WDIOS_ENABLECARD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iTCO_wdt_keepalive</span><span class="p">();</span>
			<span class="n">iTCO_wdt_start</span><span class="p">();</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">WDIOC_KEEPALIVE</span>:
		<span class="n">iTCO_wdt_keepalive</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WDIOC_SETTIMEOUT</span>:
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">new_heartbeat</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_set_heartbeat</span><span class="p">(</span><span class="n">new_heartbeat</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">iTCO_wdt_keepalive</span><span class="p">();</span>
		<span class="cm">/* Fall */</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">WDIOC_GETTIMEOUT</span>:
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">heartbeat</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WDIOC_GETTIMELEFT</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">time_left</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_get_timeleft</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time_left</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">time_left</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Kernel Interfaces</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">iTCO_wdt_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>		<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>		<span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>		<span class="n">iTCO_wdt_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span>	<span class="n">iTCO_wdt_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">iTCO_wdt_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>		<span class="n">iTCO_wdt_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">iTCO_wdt_miscdev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">minor</span> <span class="o">=</span>	<span class="n">WATCHDOG_MINOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;watchdog&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span> <span class="o">=</span>		<span class="o">&amp;</span><span class="n">iTCO_wdt_fops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	Init &amp; exit routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">iTCO_wdt_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Stop the timer before we leave */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nowayout</span><span class="p">)</span>
		<span class="n">iTCO_wdt_stop</span><span class="p">();</span>

	<span class="cm">/* Deregister */</span>
	<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_miscdev</span><span class="p">);</span>

	<span class="cm">/* release resources */</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">tco_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">tco_res</span><span class="p">));</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">smi_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">smi_res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				<span class="n">resource_size</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs_res</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">tco_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">smi_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">iTCO_wdt_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val32</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lpc_ich_info</span> <span class="o">*</span><span class="n">ich_info</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ich_info</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">tco_res</span> <span class="o">=</span>
		<span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_IO</span><span class="p">,</span> <span class="n">ICH_RES_IO_TCO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">tco_res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">smi_res</span> <span class="o">=</span>
		<span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_IO</span><span class="p">,</span> <span class="n">ICH_RES_IO_SMI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">smi_res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">=</span> <span class="n">ich_info</span><span class="o">-&gt;</span><span class="n">iTCO_version</span><span class="p">;</span>
	<span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the Memory-Mapped GCS register, we need it for the</span>
<span class="cm">	 * NO_REBOOT flag (TCO v2).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">IORESOURCE_MEM</span><span class="p">,</span>
							<span class="n">ICH_RES_MEM_GCS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs_res</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs_res</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs_res</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unreg_gcs</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check chipset&#39;s NO_REBOOT bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_unset_NO_REBOOT_bit</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">iTCO_vendor_check_noreboot_on</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;unable to reset NO_REBOOT flag, device disabled by hardware/BIOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>	<span class="cm">/* Cannot reset NO_REBOOT bit */</span>
		<span class="k">goto</span> <span class="n">unmap_gcs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the NO_REBOOT bit to prevent later reboots, just for sure */</span>
	<span class="n">iTCO_wdt_set_NO_REBOOT_bit</span><span class="p">();</span>

	<span class="cm">/* The TCO logic uses the TCO_EN bit in the SMI_EN register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">smi_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">smi_res</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;I/O address 0x%04llx already in use, device disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">SMI_EN</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unmap_gcs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">turn_SMI_watchdog_clear_off</span> <span class="o">&gt;=</span> <span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Bit 13: TCO_EN -&gt; 0</span>
<span class="cm">		 * Disables TCO logic generating an SMI#</span>
<span class="cm">		 */</span>
		<span class="n">val32</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">SMI_EN</span><span class="p">);</span>
		<span class="n">val32</span> <span class="o">&amp;=</span> <span class="mh">0xffffdfff</span><span class="p">;</span>	<span class="cm">/* Turn off SMI clearing watchdog */</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">val32</span><span class="p">,</span> <span class="n">SMI_EN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">tco_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">tco_res</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;I/O address 0x%04llx already in use, device disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">TCOBASE</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unreg_smi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Found a %s TCO device (Version=%d, TCOBASE=0x%04llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ich_info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ich_info</span><span class="o">-&gt;</span><span class="n">iTCO_version</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">TCOBASE</span><span class="p">);</span>

	<span class="cm">/* Clear out the (probably old) status */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0008</span><span class="p">,</span> <span class="n">TCO1_STS</span><span class="p">);</span>	<span class="cm">/* Clear the Time Out Status bit */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0002</span><span class="p">,</span> <span class="n">TCO2_STS</span><span class="p">);</span>	<span class="cm">/* Clear SECOND_TO_STS bit */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0004</span><span class="p">,</span> <span class="n">TCO2_STS</span><span class="p">);</span>	<span class="cm">/* Clear BOOT_STS bit */</span>

	<span class="cm">/* Make sure the watchdog is not running */</span>
	<span class="n">iTCO_wdt_stop</span><span class="p">();</span>

	<span class="cm">/* Check that the heartbeat value is within it&#39;s range;</span>
<span class="cm">	   if not reset to the default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_set_heartbeat</span><span class="p">(</span><span class="n">heartbeat</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">iTCO_wdt_set_heartbeat</span><span class="p">(</span><span class="n">WATCHDOG_HEARTBEAT</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;timeout value out of range, using %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">heartbeat</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_miscdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot register miscdev on minor=%d (err=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">WATCHDOG_MINOR</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unreg_tco</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;initialized. heartbeat=%d sec (nowayout=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">heartbeat</span><span class="p">,</span> <span class="n">nowayout</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unreg_tco:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">tco_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">tco_res</span><span class="p">));</span>
<span class="nl">unreg_smi:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">smi_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">smi_res</span><span class="p">));</span>
<span class="nl">unmap_gcs:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs</span><span class="p">);</span>
<span class="nl">unreg_gcs:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">iTCO_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				<span class="n">resource_size</span><span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs_res</span><span class="p">));</span>
<span class="nl">out:</span>
	<span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">tco_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">smi_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">gcs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">iTCO_wdt_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">tco_res</span> <span class="o">||</span> <span class="n">iTCO_wdt_private</span><span class="p">.</span><span class="n">smi_res</span><span class="p">)</span>
		<span class="n">iTCO_wdt_cleanup</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iTCO_wdt_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iTCO_wdt_stop</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">iTCO_wdt_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>          <span class="o">=</span> <span class="n">iTCO_wdt_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">iTCO_wdt_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>       <span class="o">=</span> <span class="n">iTCO_wdt_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>         <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">iTCO_wdt_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Intel TCO WatchDog Timer Driver v%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">iTCO_wdt_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iTCO_wdt_driver</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Watchdog Module Unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">iTCO_wdt_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">iTCO_wdt_cleanup_module</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Wim Van Sebroeck &lt;wim@iguana.be&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Intel TCO WatchDog Timer Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_MISCDEV</span><span class="p">(</span><span class="n">WATCHDOG_MINOR</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">DRV_NAME</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
