<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pci › setup-bus.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>setup-bus.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	drivers/pci/setup-bus.c</span>
<span class="cm"> *</span>
<span class="cm"> * Extruded from code written by</span>
<span class="cm"> *      Dave Rusling (david.rusling@reo.mts.dec.com)</span>
<span class="cm"> *      David Mosberger (davidm@cs.arizona.edu)</span>
<span class="cm"> *	David Miller (davem@redhat.com)</span>
<span class="cm"> *</span>
<span class="cm"> * Support routines for initializing a PCI subsystem.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Nov 2000, Ivan Kokshaysky &lt;ink@jurassic.park.msu.ru&gt;</span>
<span class="cm"> *	     PCI-PCI bridges cleanup, sorted resource allocation.</span>
<span class="cm"> * Feb 2002, Ivan Kokshaysky &lt;ink@jurassic.park.msu.ru&gt;</span>
<span class="cm"> *	     Converted to allocation in 3 passes, which gives</span>
<span class="cm"> *	     tighter packing. Prefetchable range support.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/cache.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm-generic/pci-bridge.h&gt;</span>
<span class="cp">#include &quot;pci.h&quot;</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci_flags</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">pci_dev_resource</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">add_size</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">min_align</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev_resource</span> <span class="o">*</span><span class="n">dev_res</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">dev_res</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev_res</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * add_to_list() - add a new resource tracker to the list</span>
<span class="cm"> * @head:	Head of the list</span>
<span class="cm"> * @dev:	device corresponding to which the resource</span>
<span class="cm"> *		belongs</span>
<span class="cm"> * @res:	The resource to be tracked</span>
<span class="cm"> * @add_size:	additional size to be optionally added</span>
<span class="cm"> *              to the resource</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_to_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
		 <span class="n">resource_size_t</span> <span class="n">add_size</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">min_align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev_resource</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;add_to_list: kmalloc() failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
	<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">add_size</span> <span class="o">=</span> <span class="n">add_size</span><span class="p">;</span>
	<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">min_align</span> <span class="o">=</span> <span class="n">min_align</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_from_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev_resource</span> <span class="o">*</span><span class="n">dev_res</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">dev_res</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">==</span> <span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">dev_res</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">resource_size_t</span> <span class="nf">get_res_add_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev_resource</span> <span class="o">*</span><span class="n">dev_res</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev_res</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">==</span> <span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">res</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;res[%d]=%pR get_res_add_size add_size %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">idx</span><span class="p">,</span> <span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">add_size</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">add_size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Sort resources by alignment */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pdev_sort_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCI_NUM_RESOURCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">pci_dev_resource</span> <span class="o">*</span><span class="n">dev_res</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
		<span class="n">resource_size_t</span> <span class="n">r_align</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_PCI_FIXED</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">r_align</span> <span class="o">=</span> <span class="n">pci_resource_alignment</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r_align</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BAR %d: %pR has bogus alignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;pdev_sort_resources(): &quot;</span>
			      <span class="s">&quot;kmalloc() failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
		<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

		<span class="cm">/* fallback is smallest one or list is empty*/</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev_res</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">resource_size_t</span> <span class="n">align</span><span class="p">;</span>

			<span class="n">align</span> <span class="o">=</span> <span class="n">pci_resource_alignment</span><span class="p">(</span><span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							 <span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">r_align</span> <span class="o">&gt;</span> <span class="n">align</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">n</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* Insert it just before n*/</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__dev_sort_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">class</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t touch classless devices or host bridges or ioapics.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">PCI_CLASS_NOT_DEFINED</span> <span class="o">||</span> <span class="n">class</span> <span class="o">==</span> <span class="n">PCI_CLASS_BRIDGE_HOST</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t touch ioapic devices already enabled by firmware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">PCI_CLASS_SYSTEM_PIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">command</span><span class="p">;</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCI_COMMAND_IO</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MEMORY</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pdev_sort_resources</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">reset_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * reassign_resources_sorted() - satisfy any additional resource requests</span>
<span class="cm"> *</span>
<span class="cm"> * @realloc_head : head of the list tracking requests requiring additional</span>
<span class="cm"> *             resources</span>
<span class="cm"> * @head     : head of the list tracking requests with allocated</span>
<span class="cm"> *             resources</span>
<span class="cm"> *</span>
<span class="cm"> * Walk through each element of the realloc_head and try to procure</span>
<span class="cm"> * additional resources for the element, provided the element</span>
<span class="cm"> * is in the head list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reassign_resources_sorted</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">realloc_head</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev_resource</span> <span class="o">*</span><span class="n">add_res</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev_resource</span> <span class="o">*</span><span class="n">dev_res</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">add_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">add_res</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">realloc_head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">found_match</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">add_res</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
		<span class="cm">/* skip resource that has been reset */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/* skip this resource if not found in head list */</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev_res</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">==</span> <span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">found_match</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found_match</span><span class="p">)</span><span class="cm">/* just skip */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">idx</span> <span class="o">=</span> <span class="n">res</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">add_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">add_size</span> <span class="o">=</span> <span class="n">add_res</span><span class="o">-&gt;</span><span class="n">add_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">add_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">add_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_assign_resource</span><span class="p">(</span><span class="n">add_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span>
				<span class="n">reset_resource</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">resource_size_t</span> <span class="n">align</span> <span class="o">=</span> <span class="n">add_res</span><span class="o">-&gt;</span><span class="n">min_align</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">add_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
				 <span class="p">(</span><span class="n">IORESOURCE_STARTALIGN</span><span class="o">|</span><span class="n">IORESOURCE_SIZEALIGN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_reassign_resource</span><span class="p">(</span><span class="n">add_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
						  <span class="n">add_size</span><span class="p">,</span> <span class="n">align</span><span class="p">))</span>
				<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;failed to add %llx res[%d]=%pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">add_size</span><span class="p">,</span>
					   <span class="n">idx</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="p">}</span>
<span class="nl">out:</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">add_res</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">add_res</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * assign_requested_resources_sorted() - satisfy resource requests</span>
<span class="cm"> *</span>
<span class="cm"> * @head : head of the list tracking requests for resources</span>
<span class="cm"> * @failed_list : head of the list tracking requests that could</span>
<span class="cm"> *		not be allocated</span>
<span class="cm"> *</span>
<span class="cm"> * Satisfy resource requests of each element in the list. Add</span>
<span class="cm"> * requests that could not satisfied to the failed_list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">assign_requested_resources_sorted</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">fail_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev_resource</span> <span class="o">*</span><span class="n">dev_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev_res</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">res</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pci_assign_resource</span><span class="p">(</span><span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fail_head</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_is_root_bus</span><span class="p">(</span><span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * if the failed res is for ROM BAR, and it will</span>
<span class="cm">				 * be enabled later, don&#39;t add it to the list</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">idx</span> <span class="o">==</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				      <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_ROM_ENABLE</span><span class="p">))))</span>
					<span class="n">add_to_list</span><span class="p">(</span><span class="n">fail_head</span><span class="p">,</span>
						    <span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span>
						    <span class="mi">0</span> <span class="cm">/* dont care */</span><span class="p">,</span>
						    <span class="mi">0</span> <span class="cm">/* dont care */</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">reset_resource</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__assign_resources_sorted</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">realloc_head</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">fail_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Should not assign requested resources at first.</span>
<span class="cm">	 *   they could be adjacent, so later reassign can not reallocate</span>
<span class="cm">	 *   them one by one in parent resource window.</span>
<span class="cm">	 * Try to assign requested + add_size at begining</span>
<span class="cm">	 *  if could do that, could get out early.</span>
<span class="cm">	 *  if could not do that, we still try to assign requested at first,</span>
<span class="cm">	 *    then try to reassign add_size for some resources.</span>
<span class="cm">	 */</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">save_head</span><span class="p">);</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">local_fail_head</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev_resource</span> <span class="o">*</span><span class="n">save_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev_resource</span> <span class="o">*</span><span class="n">dev_res</span><span class="p">;</span>

	<span class="cm">/* Check if optional add_size is there */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">realloc_head</span> <span class="o">||</span> <span class="n">list_empty</span><span class="p">(</span><span class="n">realloc_head</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">requested_and_reassign</span><span class="p">;</span>

	<span class="cm">/* Save original start, end, flags etc at first */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev_res</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">add_to_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">save_head</span><span class="p">,</span> <span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">free_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">save_head</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">requested_and_reassign</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Update res in head list with add_size in realloc_head list */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev_res</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+=</span> <span class="n">get_res_add_size</span><span class="p">(</span><span class="n">realloc_head</span><span class="p">,</span>
							<span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">);</span>

	<span class="cm">/* Try updated head list with add_size added */</span>
	<span class="n">assign_requested_resources_sorted</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_fail_head</span><span class="p">);</span>

	<span class="cm">/* all assigned with add_size ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_fail_head</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Remove head list from realloc_head list */</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev_res</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="n">remove_from_list</span><span class="p">(</span><span class="n">realloc_head</span><span class="p">,</span> <span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">);</span>
		<span class="n">free_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">save_head</span><span class="p">);</span>
		<span class="n">free_list</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_fail_head</span><span class="p">);</span>
	<span class="cm">/* Release assigned resource */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev_res</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
			<span class="n">release_resource</span><span class="p">(</span><span class="n">dev_res</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">);</span>
	<span class="cm">/* Restore start/end/flags from saved list */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">save_res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save_head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">save_res</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>

		<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">save_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">save_res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">save_res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">free_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">save_head</span><span class="p">);</span>

<span class="nl">requested_and_reassign:</span>
	<span class="cm">/* Satisfy the must-have resource requests */</span>
	<span class="n">assign_requested_resources_sorted</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">fail_head</span><span class="p">);</span>

	<span class="cm">/* Try to satisfy any additional optional resource</span>
<span class="cm">		requests */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">realloc_head</span><span class="p">)</span>
		<span class="n">reassign_resources_sorted</span><span class="p">(</span><span class="n">realloc_head</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
	<span class="n">free_list</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pdev_assign_resources_sorted</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">add_head</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">fail_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>

	<span class="n">__dev_sort_resources</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>
	<span class="n">__assign_resources_sorted</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="n">add_head</span><span class="p">,</span> <span class="n">fail_head</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pbus_assign_resources_sorted</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">realloc_head</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">fail_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span>
		<span class="n">__dev_sort_resources</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>

	<span class="n">__assign_resources_sorted</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="n">realloc_head</span><span class="p">,</span> <span class="n">fail_head</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pci_setup_cardbus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus_region</span> <span class="n">region</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CardBus bridge to [bus %02x-%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pcibios_resource_to_bus</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The IO resource is allocated a range twice as large as it</span>
<span class="cm">		 * would normally need.  This allows us to set both IO regs.</span>
<span class="cm">		 */</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  bridge window %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CB_IO_BASE_0</span><span class="p">,</span>
					<span class="n">region</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CB_IO_LIMIT_0</span><span class="p">,</span>
					<span class="n">region</span><span class="p">.</span><span class="n">end</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">pcibios_resource_to_bus</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  bridge window %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CB_IO_BASE_1</span><span class="p">,</span>
					<span class="n">region</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CB_IO_LIMIT_1</span><span class="p">,</span>
					<span class="n">region</span><span class="p">.</span><span class="n">end</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">pcibios_resource_to_bus</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  bridge window %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CB_MEMORY_BASE_0</span><span class="p">,</span>
					<span class="n">region</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CB_MEMORY_LIMIT_0</span><span class="p">,</span>
					<span class="n">region</span><span class="p">.</span><span class="n">end</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">pcibios_resource_to_bus</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  bridge window %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CB_MEMORY_BASE_1</span><span class="p">,</span>
					<span class="n">region</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CB_MEMORY_LIMIT_1</span><span class="p">,</span>
					<span class="n">region</span><span class="p">.</span><span class="n">end</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_setup_cardbus</span><span class="p">);</span>

<span class="cm">/* Initialize bridges with base/limit values we have collected.</span>
<span class="cm">   PCI-to-PCI Bridge Architecture Specification rev. 1.1 (1998)</span>
<span class="cm">   requires that if there is no I/O ports or memory behind the</span>
<span class="cm">   bridge, corresponding range must be turned off by writing base</span>
<span class="cm">   value greater than limit to the bridge&#39;s base/limit registers.</span>

<span class="cm">   Note: care must be taken when updating I/O base/limit registers</span>
<span class="cm">   of bridges which support 32-bit I/O. This update requires two</span>
<span class="cm">   config space writes, so it&#39;s quite possible that an I/O window of</span>
<span class="cm">   the bridge will have some undesirable address (e.g. 0) after the</span>
<span class="cm">   first write. Ditto 64-bit prefetchable MMIO.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_setup_bridge_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus_region</span> <span class="n">region</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">,</span> <span class="n">io_upper16</span><span class="p">;</span>

	<span class="cm">/* Set up the top and bottom of the PCI I/O segment for this bus. */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pcibios_resource_to_bus</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_IO_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="mh">0xffff0000</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="n">region</span><span class="p">.</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00f0</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">;</span>
		<span class="cm">/* Set up upper 16 bits of I/O base/limit. */</span>
		<span class="n">io_upper16</span> <span class="o">=</span> <span class="p">(</span><span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">region</span><span class="p">.</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  bridge window %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Clear upper 16 bits of I/O base/limit. */</span>
		<span class="n">io_upper16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="mh">0x00f0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Temporarily disable the I/O range before updating PCI_IO_BASE. */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_IO_BASE_UPPER16</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
	<span class="cm">/* Update lower 16 bits of I/O base/limit. */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_IO_BASE</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="cm">/* Update upper 16 bits of I/O base/limit. */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_IO_BASE_UPPER16</span><span class="p">,</span> <span class="n">io_upper16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_setup_bridge_mmio</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus_region</span> <span class="n">region</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="cm">/* Set up the top and bottom of the PCI Memory segment for this bus. */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">pcibios_resource_to_bus</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">region</span><span class="p">.</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff0</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">&amp;</span> <span class="mh">0xfff00000</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  bridge window %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">=</span> <span class="mh">0x0000fff0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_MEMORY_BASE</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_setup_bridge_mmio_pref</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus_region</span> <span class="n">region</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">,</span> <span class="n">bu</span><span class="p">,</span> <span class="n">lu</span><span class="p">;</span>

	<span class="cm">/* Clear out the upper 32 bits of PREF limit.</span>
<span class="cm">	   If PCI_PREF_BASE_UPPER32 was non-zero, this temporarily</span>
<span class="cm">	   disables PREF range, which is ok. */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_PREF_LIMIT_UPPER32</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set up PREF base/limit. */</span>
	<span class="n">bu</span> <span class="o">=</span> <span class="n">lu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">pcibios_resource_to_bus</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_PREFETCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">region</span><span class="p">.</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff0</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">&amp;</span> <span class="mh">0xfff00000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM_64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bu</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">region</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
			<span class="n">lu</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">region</span><span class="p">.</span><span class="n">end</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  bridge window %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">=</span> <span class="mh">0x0000fff0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_BASE</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

	<span class="cm">/* Set the upper 32 bits of PREF base &amp; limit. */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_PREF_BASE_UPPER32</span><span class="p">,</span> <span class="n">bu</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_PREF_LIMIT_UPPER32</span><span class="p">,</span> <span class="n">lu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__pci_setup_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI bridge to [bus %02x-%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span>
		<span class="n">pci_setup_bridge_io</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span>
		<span class="n">pci_setup_bridge_mmio</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_PREFETCH</span><span class="p">)</span>
		<span class="n">pci_setup_bridge_mmio_pref</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_BRIDGE_CONTROL</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">bridge_ctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pci_setup_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span> <span class="o">=</span> <span class="n">IORESOURCE_IO</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span> <span class="o">|</span>
				  <span class="n">IORESOURCE_PREFETCH</span><span class="p">;</span>

	<span class="n">__pci_setup_bridge</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Check whether the bridge supports optional I/O and</span>
<span class="cm">   prefetchable memory ranges. If not, the respective</span>
<span class="cm">   base/limit registers must be read-only and read as 0. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_bridge_check_ranges</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">io</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pmem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">b_res</span><span class="p">;</span>

	<span class="n">b_res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">PCI_BRIDGE_RESOURCES</span><span class="p">];</span>
	<span class="n">b_res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_IO_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_IO_BASE</span><span class="p">,</span> <span class="mh">0xf0f0</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_IO_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="p">);</span>
 		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_IO_BASE</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
 	<span class="p">}</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="p">)</span>
		<span class="n">b_res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_IO</span><span class="p">;</span>
	<span class="cm">/*  DECchip 21050 pass 2 errata: the bridge may miss an address</span>
<span class="cm">	    disconnect boundary by one PCI data phase.</span>
<span class="cm">	    Workaround: do not use prefetching on this device. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_DEC</span> <span class="o">&amp;&amp;</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x0001</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_BASE</span><span class="p">,</span>
					       <span class="mh">0xfff0fff0</span><span class="p">);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmem</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_BASE</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b_res</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_MEM</span> <span class="o">|</span> <span class="n">IORESOURCE_PREFETCH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pmem</span> <span class="o">&amp;</span> <span class="n">PCI_PREF_RANGE_TYPE_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">PCI_PREF_RANGE_TYPE_64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b_res</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_MEM_64</span><span class="p">;</span>
			<span class="n">b_res</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PCI_PREF_RANGE_TYPE_64</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* double check if bridge does support 64 bit pref */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_res</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM_64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mem_base_hi</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_PREF_BASE_UPPER32</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">mem_base_hi</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_PREF_BASE_UPPER32</span><span class="p">,</span>
					       <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_PREF_BASE_UPPER32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span>
			<span class="n">b_res</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IORESOURCE_MEM_64</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_PREF_BASE_UPPER32</span><span class="p">,</span>
				       <span class="n">mem_base_hi</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Helper function for sizing routines: find first available</span>
<span class="cm">   bus resource of a given type. Note: we intentionally skip</span>
<span class="cm">   the bus resources which have already been assigned (that is,</span>
<span class="cm">   have non-NULL parent resource). */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="nf">find_free_bus_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type_mask</span> <span class="o">=</span> <span class="n">IORESOURCE_IO</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span> <span class="o">|</span>
				  <span class="n">IORESOURCE_PREFETCH</span><span class="p">;</span>

	<span class="n">pci_bus_for_each_resource</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">ioport_resource</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">type_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">resource_size_t</span> <span class="nf">calculate_iosize</span><span class="p">(</span><span class="n">resource_size_t</span> <span class="n">size</span><span class="p">,</span>
		<span class="n">resource_size_t</span> <span class="n">min_size</span><span class="p">,</span>
		<span class="n">resource_size_t</span> <span class="n">size1</span><span class="p">,</span>
		<span class="n">resource_size_t</span> <span class="n">old_size</span><span class="p">,</span>
		<span class="n">resource_size_t</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">min_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_size</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
		<span class="n">old_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* To be fixed in 2.5: we should have sort of HAVE_ISA</span>
<span class="cm">	   flag in the struct pci_bus. */</span>
<span class="cp">#if defined(CONFIG_ISA) || defined(CONFIG_EISA)</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xffUL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">size1</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">old_size</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">old_size</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">resource_size_t</span> <span class="nf">calculate_memsize</span><span class="p">(</span><span class="n">resource_size_t</span> <span class="n">size</span><span class="p">,</span>
		<span class="n">resource_size_t</span> <span class="n">min_size</span><span class="p">,</span>
		<span class="n">resource_size_t</span> <span class="n">size1</span><span class="p">,</span>
		<span class="n">resource_size_t</span> <span class="n">old_size</span><span class="p">,</span>
		<span class="n">resource_size_t</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">min_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_size</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
		<span class="n">old_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">old_size</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">old_size</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">size1</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pbus_size_io() - size the io window of a given bus</span>
<span class="cm"> *</span>
<span class="cm"> * @bus : the bus</span>
<span class="cm"> * @min_size : the minimum io window that must to be allocated</span>
<span class="cm"> * @add_size : additional optional io window</span>
<span class="cm"> * @realloc_head : track the additional io window on this list</span>
<span class="cm"> *</span>
<span class="cm"> * Sizing the IO windows of the PCI-PCI bridge is trivial,</span>
<span class="cm"> * since these windows have 4K granularity and the IO ranges</span>
<span class="cm"> * of non-bridge PCI devices are limited to 256 bytes.</span>
<span class="cm"> * We must be careful with the ISA aliasing though.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pbus_size_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">min_size</span><span class="p">,</span>
		<span class="n">resource_size_t</span> <span class="n">add_size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">realloc_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">b_res</span> <span class="o">=</span> <span class="n">find_free_bus_resource</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">IORESOURCE_IO</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">children_add_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b_res</span><span class="p">)</span>
 		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCI_NUM_RESOURCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r_size</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">r_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">r_size</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">)</span>
				<span class="cm">/* Might be re-aligned for ISA */</span>
				<span class="n">size</span> <span class="o">+=</span> <span class="n">r_size</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">size1</span> <span class="o">+=</span> <span class="n">r_size</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">realloc_head</span><span class="p">)</span>
				<span class="n">children_add_size</span> <span class="o">+=</span> <span class="n">get_res_add_size</span><span class="p">(</span><span class="n">realloc_head</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">size0</span> <span class="o">=</span> <span class="n">calculate_iosize</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">size1</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">b_res</span><span class="p">),</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">children_add_size</span> <span class="o">&gt;</span> <span class="n">add_size</span><span class="p">)</span>
		<span class="n">add_size</span> <span class="o">=</span> <span class="n">children_add_size</span><span class="p">;</span>
	<span class="n">size1</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">realloc_head</span> <span class="o">||</span> <span class="p">(</span><span class="n">realloc_head</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">add_size</span><span class="p">))</span> <span class="o">?</span> <span class="n">size0</span> <span class="o">:</span>
		<span class="n">calculate_iosize</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">add_size</span> <span class="o">+</span> <span class="n">size1</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">b_res</span><span class="p">),</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">size1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">||</span> <span class="n">b_res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disabling bridge window &quot;</span>
				 <span class="s">&quot;%pR to [bus %02x-%02x] (unused)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b_res</span><span class="p">,</span>
				 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">);</span>
		<span class="n">b_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Alignment of the IO window is always 4K */</span>
	<span class="n">b_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">b_res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">b_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">size0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">b_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_STARTALIGN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size1</span> <span class="o">&gt;</span> <span class="n">size0</span> <span class="o">&amp;&amp;</span> <span class="n">realloc_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">add_to_list</span><span class="p">(</span><span class="n">realloc_head</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">,</span> <span class="n">b_res</span><span class="p">,</span> <span class="n">size1</span><span class="o">-</span><span class="n">size0</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bridge window &quot;</span>
				 <span class="s">&quot;%pR to [bus %02x-%02x] add_size %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b_res</span><span class="p">,</span>
				 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">,</span> <span class="n">size1</span><span class="o">-</span><span class="n">size0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pbus_size_mem() - size the memory window of a given bus</span>
<span class="cm"> *</span>
<span class="cm"> * @bus : the bus</span>
<span class="cm"> * @min_size : the minimum memory window that must to be allocated</span>
<span class="cm"> * @add_size : additional optional memory window</span>
<span class="cm"> * @realloc_head : track the additional memory window on this list</span>
<span class="cm"> *</span>
<span class="cm"> * Calculate the size of the bus and minimal alignment which</span>
<span class="cm"> * guarantees that all child resources fit in this size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pbus_size_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">min_size</span><span class="p">,</span>
			<span class="n">resource_size_t</span> <span class="n">add_size</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">realloc_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">min_align</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size0</span><span class="p">,</span> <span class="n">size1</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">aligns</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>	<span class="cm">/* Alignments from 1Mb to 2Gb */</span>
	<span class="kt">int</span> <span class="n">order</span><span class="p">,</span> <span class="n">max_order</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">b_res</span> <span class="o">=</span> <span class="n">find_free_bus_resource</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mem64_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">children_add_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">aligns</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">aligns</span><span class="p">));</span>
	<span class="n">max_order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mem64_mask</span> <span class="o">=</span> <span class="n">b_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM_64</span><span class="p">;</span>
	<span class="n">b_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IORESOURCE_MEM_64</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCI_NUM_RESOURCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">resource_size_t</span> <span class="n">r_size</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">||</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">r_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PCI_IOV</span>
			<span class="cm">/* put SRIOV requested res to the optional list */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">realloc_head</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">PCI_IOV_RESOURCES</span> <span class="o">&amp;&amp;</span>
					<span class="n">i</span> <span class="o">&lt;=</span> <span class="n">PCI_IOV_RESOURCE_END</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">r</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">add_to_list</span><span class="p">(</span><span class="n">realloc_head</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_size</span><span class="p">,</span> <span class="mi">0</span><span class="cm">/* dont&#39; care */</span><span class="p">);</span>
				<span class="n">children_add_size</span> <span class="o">+=</span> <span class="n">r_size</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="cm">/* For bridges size != alignment */</span>
			<span class="n">align</span> <span class="o">=</span> <span class="n">pci_resource_alignment</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="n">order</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">align</span><span class="p">)</span> <span class="o">-</span> <span class="mi">20</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disabling BAR %d: %pR &quot;</span>
					 <span class="s">&quot;(bad alignment %#llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span>
					 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">align</span><span class="p">);</span>
				<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">r_size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Exclude ranges with size &gt; align from</span>
<span class="cm">			   calculation of the alignment. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r_size</span> <span class="o">==</span> <span class="n">align</span><span class="p">)</span>
				<span class="n">aligns</span><span class="p">[</span><span class="n">order</span><span class="p">]</span> <span class="o">+=</span> <span class="n">align</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">&gt;</span> <span class="n">max_order</span><span class="p">)</span>
				<span class="n">max_order</span> <span class="o">=</span> <span class="n">order</span><span class="p">;</span>
			<span class="n">mem64_mask</span> <span class="o">&amp;=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM_64</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">realloc_head</span><span class="p">)</span>
				<span class="n">children_add_size</span> <span class="o">+=</span> <span class="n">get_res_add_size</span><span class="p">(</span><span class="n">realloc_head</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">align</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">min_align</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">order</span> <span class="o">&lt;=</span> <span class="n">max_order</span><span class="p">;</span> <span class="n">order</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resource_size_t</span> <span class="n">align1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">align1</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="n">order</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">align</span><span class="p">)</span>
			<span class="n">min_align</span> <span class="o">=</span> <span class="n">align1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ALIGN</span><span class="p">(</span><span class="n">align</span> <span class="o">+</span> <span class="n">min_align</span><span class="p">,</span> <span class="n">min_align</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">align1</span><span class="p">)</span>
			<span class="n">min_align</span> <span class="o">=</span> <span class="n">align1</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">align</span> <span class="o">+=</span> <span class="n">aligns</span><span class="p">[</span><span class="n">order</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">size0</span> <span class="o">=</span> <span class="n">calculate_memsize</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">b_res</span><span class="p">),</span> <span class="n">min_align</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">children_add_size</span> <span class="o">&gt;</span> <span class="n">add_size</span><span class="p">)</span>
		<span class="n">add_size</span> <span class="o">=</span> <span class="n">children_add_size</span><span class="p">;</span>
	<span class="n">size1</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">realloc_head</span> <span class="o">||</span> <span class="p">(</span><span class="n">realloc_head</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">add_size</span><span class="p">))</span> <span class="o">?</span> <span class="n">size0</span> <span class="o">:</span>
		<span class="n">calculate_memsize</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">add_size</span><span class="p">,</span>
				<span class="n">resource_size</span><span class="p">(</span><span class="n">b_res</span><span class="p">),</span> <span class="n">min_align</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">size1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">||</span> <span class="n">b_res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disabling bridge window &quot;</span>
				 <span class="s">&quot;%pR to [bus %02x-%02x] (unused)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b_res</span><span class="p">,</span>
				 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">);</span>
		<span class="n">b_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">min_align</span><span class="p">;</span>
	<span class="n">b_res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">size0</span> <span class="o">+</span> <span class="n">min_align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">b_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_STARTALIGN</span> <span class="o">|</span> <span class="n">mem64_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size1</span> <span class="o">&gt;</span> <span class="n">size0</span> <span class="o">&amp;&amp;</span> <span class="n">realloc_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">add_to_list</span><span class="p">(</span><span class="n">realloc_head</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">,</span> <span class="n">b_res</span><span class="p">,</span> <span class="n">size1</span><span class="o">-</span><span class="n">size0</span><span class="p">,</span> <span class="n">min_align</span><span class="p">);</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bridge window &quot;</span>
				 <span class="s">&quot;%pR to [bus %02x-%02x] add_size %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b_res</span><span class="p">,</span>
				 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">size1</span><span class="o">-</span><span class="n">size0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">pci_cardbus_resource_alignment</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pci_cardbus_io_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pci_cardbus_mem_size</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_bus_size_cardbus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">realloc_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">b_res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">PCI_BRIDGE_RESOURCES</span><span class="p">];</span>
	<span class="n">resource_size_t</span> <span class="n">b_res_3_size</span> <span class="o">=</span> <span class="n">pci_cardbus_mem_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">parent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">handle_b_res_1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Reserve some resources for CardBus.  We reserve</span>
<span class="cm">	 * a fixed amount of bus space for CardBus bridges.</span>
<span class="cm">	 */</span>
	<span class="n">b_res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">pci_cardbus_io_size</span><span class="p">;</span>
	<span class="n">b_res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">b_res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="n">pci_cardbus_io_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">b_res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_IO</span> <span class="o">|</span> <span class="n">IORESOURCE_STARTALIGN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">realloc_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b_res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">-=</span> <span class="n">pci_cardbus_io_size</span><span class="p">;</span>
		<span class="n">add_to_list</span><span class="p">(</span><span class="n">realloc_head</span><span class="p">,</span> <span class="n">bridge</span><span class="p">,</span> <span class="n">b_res</span><span class="p">,</span> <span class="n">pci_cardbus_io_size</span><span class="p">,</span>
				<span class="n">pci_cardbus_io_size</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">handle_b_res_1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">parent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">handle_b_res_2</span><span class="p">;</span>
	<span class="n">b_res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">pci_cardbus_io_size</span><span class="p">;</span>
	<span class="n">b_res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">b_res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="n">pci_cardbus_io_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">b_res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_IO</span> <span class="o">|</span> <span class="n">IORESOURCE_STARTALIGN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">realloc_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b_res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span> <span class="o">-=</span> <span class="n">pci_cardbus_io_size</span><span class="p">;</span>
		<span class="n">add_to_list</span><span class="p">(</span><span class="n">realloc_head</span><span class="p">,</span> <span class="n">bridge</span><span class="p">,</span> <span class="n">b_res</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">pci_cardbus_io_size</span><span class="p">,</span>
				 <span class="n">pci_cardbus_io_size</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">handle_b_res_2:</span>
	<span class="cm">/* MEM1 must not be pref mmio */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CB_BRIDGE_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">PCI_CB_BRIDGE_CTL_PREFETCH_MEM1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_CB_BRIDGE_CTL_PREFETCH_MEM1</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CB_BRIDGE_CONTROL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CB_BRIDGE_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check whether prefetchable memory is supported</span>
<span class="cm">	 * by this bridge.</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CB_BRIDGE_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">PCI_CB_BRIDGE_CTL_PREFETCH_MEM0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PCI_CB_BRIDGE_CTL_PREFETCH_MEM0</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CB_BRIDGE_CONTROL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CB_BRIDGE_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_res</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">parent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">handle_b_res_3</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we have prefetchable memory support, allocate</span>
<span class="cm">	 * two regions.  Otherwise, allocate one region of</span>
<span class="cm">	 * twice the size.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">PCI_CB_BRIDGE_CTL_PREFETCH_MEM0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b_res</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">pci_cardbus_mem_size</span><span class="p">;</span>
		<span class="n">b_res</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">b_res</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="n">pci_cardbus_mem_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">b_res</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_MEM</span> <span class="o">|</span> <span class="n">IORESOURCE_PREFETCH</span> <span class="o">|</span>
				  <span class="n">IORESOURCE_STARTALIGN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">realloc_head</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b_res</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">end</span> <span class="o">-=</span> <span class="n">pci_cardbus_mem_size</span><span class="p">;</span>
			<span class="n">add_to_list</span><span class="p">(</span><span class="n">realloc_head</span><span class="p">,</span> <span class="n">bridge</span><span class="p">,</span> <span class="n">b_res</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>
				 <span class="n">pci_cardbus_mem_size</span><span class="p">,</span> <span class="n">pci_cardbus_mem_size</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* reduce that to half */</span>
		<span class="n">b_res_3_size</span> <span class="o">=</span> <span class="n">pci_cardbus_mem_size</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">handle_b_res_3:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_res</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">parent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">handle_done</span><span class="p">;</span>
	<span class="n">b_res</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">pci_cardbus_mem_size</span><span class="p">;</span>
	<span class="n">b_res</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">b_res</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="n">b_res_3_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">b_res</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_MEM</span> <span class="o">|</span> <span class="n">IORESOURCE_STARTALIGN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">realloc_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b_res</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">end</span> <span class="o">-=</span> <span class="n">b_res_3_size</span><span class="p">;</span>
		<span class="n">add_to_list</span><span class="p">(</span><span class="n">realloc_head</span><span class="p">,</span> <span class="n">bridge</span><span class="p">,</span> <span class="n">b_res</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">b_res_3_size</span><span class="p">,</span>
				 <span class="n">pci_cardbus_mem_size</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">handle_done:</span>
	<span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__ref</span> <span class="nf">__pci_bus_size_bridges</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">realloc_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">,</span> <span class="n">prefmask</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">additional_mem_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">additional_io_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PCI_CLASS_BRIDGE_CARDBUS</span>:
			<span class="n">pci_bus_size_cardbus</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">realloc_head</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PCI_CLASS_BRIDGE_PCI</span>:
		<span class="nl">default:</span>
			<span class="n">__pci_bus_size_bridges</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">realloc_head</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* The root bus? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_CLASS_BRIDGE_CARDBUS</span>:
		<span class="cm">/* don&#39;t size cardbuses yet. */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PCI_CLASS_BRIDGE_PCI</span>:
		<span class="n">pci_bridge_check_ranges</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">is_hotplug_bridge</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">additional_io_size</span>  <span class="o">=</span> <span class="n">pci_hotplug_io_size</span><span class="p">;</span>
			<span class="n">additional_mem_size</span> <span class="o">=</span> <span class="n">pci_hotplug_mem_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Follow thru</span>
<span class="cm">		 */</span>
	<span class="nl">default:</span>
		<span class="n">pbus_size_io</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">realloc_head</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">additional_io_size</span><span class="p">,</span>
			     <span class="n">additional_io_size</span><span class="p">,</span> <span class="n">realloc_head</span><span class="p">);</span>
		<span class="cm">/* If the bridge supports prefetchable range, size it</span>
<span class="cm">		   separately. If it doesn&#39;t, or its prefetchable window</span>
<span class="cm">		   has already been allocated by arch code, try</span>
<span class="cm">		   non-prefetchable range for both types of PCI memory</span>
<span class="cm">		   resources. */</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
		<span class="n">prefmask</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span> <span class="o">|</span> <span class="n">IORESOURCE_PREFETCH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pbus_size_mem</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">prefmask</span><span class="p">,</span> <span class="n">prefmask</span><span class="p">,</span>
				  <span class="n">realloc_head</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">additional_mem_size</span><span class="p">,</span>
				  <span class="n">additional_mem_size</span><span class="p">,</span> <span class="n">realloc_head</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">prefmask</span><span class="p">;</span> <span class="cm">/* Success, size non-prefetch only. */</span>
		<span class="k">else</span>
			<span class="n">additional_mem_size</span> <span class="o">+=</span> <span class="n">additional_mem_size</span><span class="p">;</span>
		<span class="n">pbus_size_mem</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
				<span class="n">realloc_head</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">additional_mem_size</span><span class="p">,</span>
				<span class="n">additional_mem_size</span><span class="p">,</span> <span class="n">realloc_head</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__ref</span> <span class="nf">pci_bus_size_bridges</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__pci_bus_size_bridges</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_bus_size_bridges</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__ref</span> <span class="nf">__pci_bus_assign_resources</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">realloc_head</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">fail_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">pbus_assign_resources_sorted</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">realloc_head</span><span class="p">,</span> <span class="n">fail_head</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">__pci_bus_assign_resources</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">realloc_head</span><span class="p">,</span> <span class="n">fail_head</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PCI_CLASS_BRIDGE_PCI</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_is_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">pci_setup_bridge</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PCI_CLASS_BRIDGE_CARDBUS</span>:
			<span class="n">pci_setup_cardbus</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;not setting up bridge for bus &quot;</span>
				 <span class="s">&quot;%04x:%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__ref</span> <span class="nf">pci_bus_assign_resources</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__pci_bus_assign_resources</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_bus_assign_resources</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__ref</span> <span class="nf">__pci_bridge_assign_resources</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">add_head</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">fail_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>

	<span class="n">pdev_assign_resources_sorted</span><span class="p">((</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">bridge</span><span class="p">,</span>
					 <span class="n">add_head</span><span class="p">,</span> <span class="n">fail_head</span><span class="p">);</span>

	<span class="n">b</span> <span class="o">=</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">__pci_bus_assign_resources</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">add_head</span><span class="p">,</span> <span class="n">fail_head</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_CLASS_BRIDGE_PCI</span>:
		<span class="n">pci_setup_bridge</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PCI_CLASS_BRIDGE_CARDBUS</span>:
		<span class="n">pci_setup_cardbus</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;not setting up bridge for bus &quot;</span>
			 <span class="s">&quot;%04x:%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_bridge_release_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type_mask</span> <span class="o">=</span> <span class="n">IORESOURCE_IO</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span> <span class="o">|</span>
				  <span class="n">IORESOURCE_PREFETCH</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">PCI_BRIDGE_RESOURCES</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">PCI_BRIDGE_RESOURCE_END</span><span class="p">;</span>
	     <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">type_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * if there are children under that, we should release them</span>
<span class="cm">		 *  all</span>
<span class="cm">		 */</span>
		<span class="n">release_child_resources</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">release_resource</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;resource %d %pR released</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="cm">/* keep the old size */</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* avoiding touch the one without PREF */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_PREFETCH</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">IORESOURCE_PREFETCH</span><span class="p">;</span>
		<span class="n">__pci_setup_bridge</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">release_type</span> <span class="p">{</span>
	<span class="n">leaf_only</span><span class="p">,</span>
	<span class="n">whole_subtree</span><span class="p">,</span>
<span class="p">};</span>
<span class="cm">/*</span>
<span class="cm"> * try to release pci bridge resources that is from leaf bridge,</span>
<span class="cm"> * so we can allocate big new one later</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__ref</span> <span class="nf">pci_bus_release_bridge_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
						   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">,</span>
						   <span class="k">enum</span> <span class="n">release_type</span> <span class="n">rel_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_leaf_bridge</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">is_leaf_bridge</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PCI_CLASS_BRIDGE_PCI</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rel_type</span> <span class="o">==</span> <span class="n">whole_subtree</span><span class="p">)</span>
			<span class="n">pci_bus_release_bridge_resources</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
						 <span class="n">whole_subtree</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_is_root_bus</span><span class="p">(</span><span class="n">bus</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PCI_CLASS_BRIDGE_PCI</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rel_type</span> <span class="o">==</span> <span class="n">whole_subtree</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_leaf_bridge</span><span class="p">)</span>
		<span class="n">pci_bridge_release_resources</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_bus_dump_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pci_bus_for_each_resource</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">||</span> <span class="o">!</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">||</span> <span class="o">!</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
                        <span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resource %d %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_bus_dump_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>


	<span class="n">pci_bus_dump_res</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">pci_bus_dump_resources</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pci_bus_get_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_bus_get_depth</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">depth</span><span class="p">)</span>
			<span class="n">depth</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">depth</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pci_get_max_depth</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_root_buses</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_bus_get_depth</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">depth</span><span class="p">)</span>
			<span class="n">depth</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">depth</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * -1: undefined, will auto detect later</span>
<span class="cm"> *  0: disabled by user</span>
<span class="cm"> *  1: disabled by auto detect</span>
<span class="cm"> *  2: enabled by user</span>
<span class="cm"> *  3: enabled by auto detect</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">enable_type</span> <span class="p">{</span>
	<span class="n">undefined</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">user_disabled</span><span class="p">,</span>
	<span class="n">auto_disabled</span><span class="p">,</span>
	<span class="n">user_enabled</span><span class="p">,</span>
	<span class="n">auto_enabled</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">enable_type</span> <span class="n">pci_realloc_enable</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="n">undefined</span><span class="p">;</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">pci_realloc_get_opt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">pci_realloc_enable</span> <span class="o">=</span> <span class="n">user_disabled</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;on&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">pci_realloc_enable</span> <span class="o">=</span> <span class="n">user_enabled</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">__init</span> <span class="nf">pci_realloc_enabled</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_realloc_enable</span> <span class="o">&gt;=</span> <span class="n">user_enabled</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">pci_realloc_detect</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_PCI_IOV) &amp;&amp; defined(CONFIG_PCI_REALLOC_ENABLE_AUTO)</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_realloc_enable</span> <span class="o">!=</span> <span class="n">undefined</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">for_each_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">PCI_IOV_RESOURCES</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">PCI_IOV_RESOURCE_END</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="cm">/* Not assigned, or rejected by kernel ? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_realloc_enable</span> <span class="o">=</span> <span class="n">auto_enabled</span><span class="p">;</span>

				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * first try will not touch pci bridge res</span>
<span class="cm"> * second  and later try will clear small leaf bridge res</span>
<span class="cm"> * will stop till to the max  deepth if can not find good one</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">pci_assign_unassigned_resources</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">realloc_head</span><span class="p">);</span> <span class="cm">/* list of resources that</span>
<span class="cm">					want additional resources */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">add_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tried_times</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">release_type</span> <span class="n">rel_type</span> <span class="o">=</span> <span class="n">leaf_only</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">fail_head</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev_resource</span> <span class="o">*</span><span class="n">fail_res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type_mask</span> <span class="o">=</span> <span class="n">IORESOURCE_IO</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span> <span class="o">|</span>
				  <span class="n">IORESOURCE_PREFETCH</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pci_try_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* don&#39;t realloc if asked to do so */</span>
	<span class="n">pci_realloc_detect</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_realloc_enabled</span><span class="p">())</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">max_depth</span> <span class="o">=</span> <span class="n">pci_get_max_depth</span><span class="p">();</span>

		<span class="n">pci_try_num</span> <span class="o">=</span> <span class="n">max_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PCI: max bus depth: %d pci_try_num: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">max_depth</span><span class="p">,</span> <span class="n">pci_try_num</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">again:</span>
	<span class="cm">/*</span>
<span class="cm">	 * last try will use add_list, otherwise will try good to have as</span>
<span class="cm">	 * must have, so can realloc parent bridge resource</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tried_times</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">pci_try_num</span><span class="p">)</span>
		<span class="n">add_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">realloc_head</span><span class="p">;</span>
	<span class="cm">/* Depth first, calculate sizes and alignments of all</span>
<span class="cm">	   subordinate buses. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_root_buses</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="n">__pci_bus_size_bridges</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">add_list</span><span class="p">);</span>

	<span class="cm">/* Depth last, allocate resources and update the hardware. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_root_buses</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="n">__pci_bus_assign_resources</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">add_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fail_head</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">add_list</span><span class="p">)</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">add_list</span><span class="p">));</span>
	<span class="n">tried_times</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* any device complain? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fail_head</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">enable_and_dump</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tried_times</span> <span class="o">&gt;=</span> <span class="n">pci_try_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_realloc_enable</span> <span class="o">==</span> <span class="n">undefined</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Some PCI device resources are unassigned, try booting with pci=realloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pci_realloc_enable</span> <span class="o">==</span> <span class="n">auto_enabled</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Automatically enabled pci realloc, if you have problem, try booting with pci=realloc=off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">free_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fail_head</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">enable_and_dump</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PCI: No. %d try to assign unassigned res</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">tried_times</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* third times and later will not check if it is leaf */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tried_times</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">rel_type</span> <span class="o">=</span> <span class="n">whole_subtree</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to release leaf bridge&#39;s resources that doesn&#39;t fit resource of</span>
<span class="cm">	 * child device under that bridge</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fail_res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fail_head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus</span> <span class="o">=</span> <span class="n">fail_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">pci_bus_release_bridge_resources</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span>
						 <span class="n">fail_res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">type_mask</span><span class="p">,</span>
						 <span class="n">rel_type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* restore size and flags */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fail_res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fail_head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">fail_res</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>

		<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">fail_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">fail_res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">fail_res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fail_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">)</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">free_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fail_head</span><span class="p">);</span>

	<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>

<span class="nl">enable_and_dump:</span>
	<span class="cm">/* Depth last, update the hardware. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_root_buses</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="n">pci_enable_bridges</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="cm">/* dump the resource on buses */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_root_buses</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="n">pci_bus_dump_resources</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pci_assign_unassigned_bridge_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">add_list</span><span class="p">);</span> <span class="cm">/* list of resources that</span>
<span class="cm">					want additional resources */</span>
	<span class="kt">int</span> <span class="n">tried_times</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">fail_head</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev_resource</span> <span class="o">*</span><span class="n">fail_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type_mask</span> <span class="o">=</span> <span class="n">IORESOURCE_IO</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span> <span class="o">|</span>
				  <span class="n">IORESOURCE_PREFETCH</span><span class="p">;</span>

<span class="nl">again:</span>
	<span class="n">__pci_bus_size_bridges</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add_list</span><span class="p">);</span>
	<span class="n">__pci_bridge_assign_resources</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fail_head</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">add_list</span><span class="p">));</span>
	<span class="n">tried_times</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fail_head</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">enable_all</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tried_times</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* still fail, don&#39;t need to try more */</span>
		<span class="n">free_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fail_head</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">enable_all</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PCI: No. %d try to assign unassigned res</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">tried_times</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to release leaf bridge&#39;s resources that doesn&#39;t fit resource of</span>
<span class="cm">	 * child device under that bridge</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fail_res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fail_head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">fail_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">fail_res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

		<span class="n">pci_bus_release_bridge_resources</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">type_mask</span><span class="p">,</span>
						 <span class="n">whole_subtree</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* restore size and flags */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fail_res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fail_head</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">fail_res</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>

		<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">fail_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">fail_res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">fail_res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fail_res</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">)</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">free_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fail_head</span><span class="p">);</span>

	<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>

<span class="nl">enable_all:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_reenable_device</span><span class="p">(</span><span class="n">bridge</span><span class="p">);</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">bridge</span><span class="p">);</span>
	<span class="n">pci_enable_bridges</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_assign_unassigned_bridge_resources</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_HOTPLUG</span>
<span class="cm">/**</span>
<span class="cm"> * pci_rescan_bus - scan a PCI bus for devices.</span>
<span class="cm"> * @bus: PCI bus to scan</span>
<span class="cm"> *</span>
<span class="cm"> * Scan a PCI bus and child buses for new devices, adds them,</span>
<span class="cm"> * and enables them.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the max number of subordinate bus discovered.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__ref</span> <span class="nf">pci_rescan_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">add_list</span><span class="p">);</span> <span class="cm">/* list of resources that</span>
<span class="cm">					want additional resources */</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">pci_scan_child_bus</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_bus_sem</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span> <span class="o">||</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_CARDBUS</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">)</span>
				<span class="n">__pci_bus_size_bridges</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">add_list</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_bus_sem</span><span class="p">);</span>
	<span class="n">__pci_bus_assign_resources</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add_list</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">add_list</span><span class="p">));</span>

	<span class="n">pci_enable_bridges</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">pci_bus_add_devices</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">max</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_rescan_bus</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
