<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pci › probe.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>probe.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * probe.c - PCI detection and setup code</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/cpumask.h&gt;</span>
<span class="cp">#include &lt;linux/pci-aspm.h&gt;</span>
<span class="cp">#include &lt;asm-generic/pci-bridge.h&gt;</span>
<span class="cp">#include &quot;pci.h&quot;</span>

<span class="cp">#define CARDBUS_LATENCY_TIMER	176	</span><span class="cm">/* secondary latency timer */</span><span class="cp"></span>
<span class="cp">#define CARDBUS_RESERVE_BUSNR	3</span>

<span class="cm">/* Ugh.  Need to stop exporting this to modules. */</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">pci_root_buses</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_root_buses</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_anything</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Some device drivers need know if pci is initiated.</span>
<span class="cm"> * Basically, we think pci is not initiated when there</span>
<span class="cm"> * is no device to be found on the pci_bus_type.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">no_pci_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">no_devices</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">bus_find_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">find_anything</span><span class="p">);</span>
	<span class="n">no_devices</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">no_devices</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">no_pci_devices</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * PCI Bus Class</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_pcibus_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="n">to_pci_bus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">)</span>
		<span class="n">put_device</span><span class="p">(</span><span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">);</span>
	<span class="n">pci_bus_remove_resources</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">);</span>
	<span class="n">pci_release_bus_of_node</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="n">pcibus_class</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pci_bus&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_release</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">release_pcibus_dev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_attrs</span>	<span class="o">=</span> <span class="n">pcibus_dev_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pcibus_class_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">class_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcibus_class</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">postcore_initcall</span><span class="p">(</span><span class="n">pcibus_class_init</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">pci_size</span><span class="p">(</span><span class="n">u64</span> <span class="n">base</span><span class="p">,</span> <span class="n">u64</span> <span class="n">maxbase</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">size</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">maxbase</span><span class="p">;</span>	<span class="cm">/* Find the significant bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get the lowest of them to find the decode size, and</span>
<span class="cm">	   from that the extent.  */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* base == maxbase can be valid only if the BAR has</span>
<span class="cm">	   already been programmed with all 1s.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="n">maxbase</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">base</span> <span class="o">|</span> <span class="n">size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">decode_bar</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mem_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bar</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_SPACE</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_BASE_ADDRESS_SPACE_IO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">bar</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_BASE_ADDRESS_IO_MASK</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_IO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">flags</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">bar</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_BASE_ADDRESS_MEM_MASK</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_PREFETCH</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_PREFETCH</span><span class="p">;</span>

	<span class="n">mem_type</span> <span class="o">=</span> <span class="n">bar</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mem_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_32</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_1M</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;1M mem BAR treated as 32-bit BAR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span>:
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_MEM_64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;mem unknown type %x treated as 32-bit BAR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mem_type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_read_base - read a PCI BAR</span>
<span class="cm"> * @dev: the PCI device</span>
<span class="cm"> * @type: type of the BAR</span>
<span class="cm"> * @res: resource buffer to be filled in</span>
<span class="cm"> * @pos: BAR position in the config space</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if the BAR is 64-bit, or 0 if 32-bit.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__pci_read_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pci_bar_type</span> <span class="n">type</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">orig_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus_region</span> <span class="n">region</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">type</span> <span class="o">?</span> <span class="n">PCI_ROM_ADDRESS_MASK</span> <span class="o">:</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mmio_always_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_cmd</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span>
			<span class="n">orig_cmd</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_IO</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">l</span> <span class="o">|</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mmio_always_on</span><span class="p">)</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">orig_cmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * All bits set in sz means the device isn&#39;t working properly.</span>
<span class="cm">	 * If the BAR isn&#39;t implemented, all bits must be 0.  If it&#39;s a</span>
<span class="cm">	 * memory BAR or a ROM, bit 0 must be clear; if it&#39;s an io BAR, bit</span>
<span class="cm">	 * 1 must be clear.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sz</span> <span class="o">||</span> <span class="n">sz</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * I don&#39;t know how l can have all bits set.  Copied from old code.</span>
<span class="cm">	 * Maybe it fixes a bug on some ancient platform.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">pci_bar_unknown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">decode_bar</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_SIZEALIGN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l</span> <span class="o">&amp;=</span> <span class="n">PCI_BASE_ADDRESS_IO_MASK</span><span class="p">;</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">PCI_BASE_ADDRESS_IO_MASK</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">IO_SPACE_LIMIT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">l</span> <span class="o">&amp;=</span> <span class="n">PCI_BASE_ADDRESS_MEM_MASK</span><span class="p">;</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">PCI_BASE_ADDRESS_MEM_MASK</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_ROM_ENABLE</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="n">PCI_ROM_ADDRESS_MASK</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">PCI_ROM_ADDRESS_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM_64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">l64</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">sz64</span> <span class="o">=</span> <span class="n">sz</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">mask64</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="o">~</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

		<span class="n">l64</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">l</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">sz64</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">sz</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

		<span class="n">sz64</span> <span class="o">=</span> <span class="n">pci_size</span><span class="p">(</span><span class="n">l64</span><span class="p">,</span> <span class="n">sz64</span><span class="p">,</span> <span class="n">mask64</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sz64</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">resource_size_t</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sz64</span> <span class="o">&gt;</span> <span class="mh">0x100000000ULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reg %x: can&#39;t handle 64-bit BAR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pos</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">resource_size_t</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">l</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Address above 32-bit boundary; disable the BAR */</span>
			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">region</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">sz64</span><span class="p">;</span>
			<span class="n">pcibios_bus_to_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">region</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">l64</span><span class="p">;</span>
			<span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">l64</span> <span class="o">+</span> <span class="n">sz64</span><span class="p">;</span>
			<span class="n">pcibios_bus_to_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">);</span>
			<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reg %x: %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">pos</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">pci_size</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sz</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="n">region</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="n">sz</span><span class="p">;</span>
		<span class="n">pcibios_bus_to_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">);</span>

		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reg %x: %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM_64</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">fail:</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_read_bases</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">howmany</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">howmany</span><span class="p">;</span> <span class="n">pos</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">PCI_BASE_ADDRESS_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">__pci_read_base</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_bar_unknown</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rom</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">PCI_ROM_RESOURCE</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rom_base_reg</span> <span class="o">=</span> <span class="n">rom</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span> <span class="o">|</span> <span class="n">IORESOURCE_PREFETCH</span> <span class="o">|</span>
				<span class="n">IORESOURCE_READONLY</span> <span class="o">|</span> <span class="n">IORESOURCE_CACHEABLE</span> <span class="o">|</span>
				<span class="n">IORESOURCE_SIZEALIGN</span><span class="p">;</span>
		<span class="n">__pci_read_base</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_bar_mem32</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">rom</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pci_read_bridge_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">io_base_lo</span><span class="p">,</span> <span class="n">io_limit_lo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus_region</span> <span class="n">region</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">res2</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_IO_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_base_lo</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_IO_LIMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_limit_lo</span><span class="p">);</span>
	<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">io_base_lo</span> <span class="o">&amp;</span> <span class="n">PCI_IO_RANGE_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">io_limit_lo</span> <span class="o">&amp;</span> <span class="n">PCI_IO_RANGE_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">io_base_lo</span> <span class="o">&amp;</span> <span class="n">PCI_IO_RANGE_TYPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_IO_RANGE_TYPE_32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">io_base_hi</span><span class="p">,</span> <span class="n">io_limit_hi</span><span class="p">;</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_IO_BASE_UPPER16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_base_hi</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_IO_LIMIT_UPPER16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_limit_hi</span><span class="p">);</span>
		<span class="n">base</span> <span class="o">|=</span> <span class="p">(</span><span class="n">io_base_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">limit</span> <span class="o">|=</span> <span class="p">(</span><span class="n">io_limit_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;&amp;</span> <span class="n">base</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">io_base_lo</span> <span class="o">&amp;</span> <span class="n">PCI_IO_RANGE_TYPE_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">IORESOURCE_IO</span><span class="p">;</span>
		<span class="n">res2</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">region</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
		<span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">limit</span> <span class="o">+</span> <span class="mh">0xfff</span><span class="p">;</span>
		<span class="n">pcibios_bus_to_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">res2</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res2</span><span class="p">.</span><span class="n">end</span><span class="p">;</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  bridge window %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pci_read_bridge_mmio</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mem_base_lo</span><span class="p">,</span> <span class="n">mem_limit_lo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus_region</span> <span class="n">region</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_MEMORY_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_base_lo</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_MEMORY_LIMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_limit_lo</span><span class="p">);</span>
	<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_base_lo</span> <span class="o">&amp;</span> <span class="n">PCI_MEMORY_RANGE_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_limit_lo</span> <span class="o">&amp;</span> <span class="n">PCI_MEMORY_RANGE_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;&amp;</span> <span class="n">base</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_base_lo</span> <span class="o">&amp;</span> <span class="n">PCI_MEMORY_RANGE_TYPE_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
		<span class="n">region</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
		<span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">limit</span> <span class="o">+</span> <span class="mh">0xfffff</span><span class="p">;</span>
		<span class="n">pcibios_bus_to_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">);</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  bridge window %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pci_read_bridge_mmio_pref</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mem_base_lo</span><span class="p">,</span> <span class="n">mem_limit_lo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus_region</span> <span class="n">region</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_base_lo</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_LIMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_limit_lo</span><span class="p">);</span>
	<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_base_lo</span> <span class="o">&amp;</span> <span class="n">PCI_PREF_RANGE_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_limit_lo</span> <span class="o">&amp;</span> <span class="n">PCI_PREF_RANGE_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mem_base_lo</span> <span class="o">&amp;</span> <span class="n">PCI_PREF_RANGE_TYPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_PREF_RANGE_TYPE_64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mem_base_hi</span><span class="p">,</span> <span class="n">mem_limit_hi</span><span class="p">;</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_PREF_BASE_UPPER32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_base_hi</span><span class="p">);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_PREF_LIMIT_UPPER32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_limit_hi</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Some bridges set the base &gt; limit by default, and some</span>
<span class="cm">		 * (broken) BIOSes do not initialize them.  If we find</span>
<span class="cm">		 * this, just assume they are not being used.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem_base_hi</span> <span class="o">&lt;=</span> <span class="n">mem_limit_hi</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if BITS_PER_LONG == 64</span>
			<span class="n">base</span> <span class="o">|=</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">mem_base_hi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">limit</span> <span class="o">|=</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">mem_limit_hi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mem_base_hi</span> <span class="o">||</span> <span class="n">mem_limit_hi</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t handle 64-bit &quot;</span>
					<span class="s">&quot;address space for bridge</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;&amp;</span> <span class="n">base</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_base_lo</span> <span class="o">&amp;</span> <span class="n">PCI_PREF_RANGE_TYPE_MASK</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">IORESOURCE_MEM</span> <span class="o">|</span> <span class="n">IORESOURCE_PREFETCH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PCI_PREF_RANGE_TYPE_64</span><span class="p">)</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_MEM_64</span><span class="p">;</span>
		<span class="n">region</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
		<span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">limit</span> <span class="o">+</span> <span class="mh">0xfffff</span><span class="p">;</span>
		<span class="n">pcibios_bus_to_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">);</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  bridge window %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pci_read_bridge_bases</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_is_root_bus</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>	<span class="cm">/* It&#39;s a host bus, nothing to read */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI bridge to [bus %02x-%02x]%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">child</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">,</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">transparent</span> <span class="o">?</span> <span class="s">&quot; (subtractive decode)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">pci_bus_remove_resources</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCI_BRIDGE_RESOURCE_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">child</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">PCI_BRIDGE_RESOURCES</span><span class="o">+</span><span class="n">i</span><span class="p">];</span>

	<span class="n">pci_read_bridge_io</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="n">pci_read_bridge_mmio</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="n">pci_read_bridge_mmio_pref</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transparent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_bus_for_each_resource</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_bus_add_resource</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span>
						     <span class="n">PCI_SUBTRACTIVE_DECODE</span><span class="p">);</span>
				<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;  bridge window %pR (subtractive decode)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">res</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span> <span class="nf">pci_alloc_bus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">b</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">);</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">PCI_SPEED_UNKNOWN</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">=</span> <span class="n">PCI_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_host_bridge</span> <span class="o">*</span><span class="nf">pci_alloc_host_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_host_bridge</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bridge</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bridge</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">windows</span><span class="p">);</span>
		<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bridge</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pcix_bus_speed</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* 0 */</span>
	<span class="n">PCI_SPEED_66MHz_PCIX</span><span class="p">,</span>		<span class="cm">/* 1 */</span>
	<span class="n">PCI_SPEED_100MHz_PCIX</span><span class="p">,</span>		<span class="cm">/* 2 */</span>
	<span class="n">PCI_SPEED_133MHz_PCIX</span><span class="p">,</span>		<span class="cm">/* 3 */</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* 4 */</span>
	<span class="n">PCI_SPEED_66MHz_PCIX_ECC</span><span class="p">,</span>	<span class="cm">/* 5 */</span>
	<span class="n">PCI_SPEED_100MHz_PCIX_ECC</span><span class="p">,</span>	<span class="cm">/* 6 */</span>
	<span class="n">PCI_SPEED_133MHz_PCIX_ECC</span><span class="p">,</span>	<span class="cm">/* 7 */</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* 8 */</span>
	<span class="n">PCI_SPEED_66MHz_PCIX_266</span><span class="p">,</span>	<span class="cm">/* 9 */</span>
	<span class="n">PCI_SPEED_100MHz_PCIX_266</span><span class="p">,</span>	<span class="cm">/* A */</span>
	<span class="n">PCI_SPEED_133MHz_PCIX_266</span><span class="p">,</span>	<span class="cm">/* B */</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* C */</span>
	<span class="n">PCI_SPEED_66MHz_PCIX_533</span><span class="p">,</span>	<span class="cm">/* D */</span>
	<span class="n">PCI_SPEED_100MHz_PCIX_533</span><span class="p">,</span>	<span class="cm">/* E */</span>
	<span class="n">PCI_SPEED_133MHz_PCIX_533</span>	<span class="cm">/* F */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pcie_link_speed</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* 0 */</span>
	<span class="n">PCIE_SPEED_2_5GT</span><span class="p">,</span>		<span class="cm">/* 1 */</span>
	<span class="n">PCIE_SPEED_5_0GT</span><span class="p">,</span>		<span class="cm">/* 2 */</span>
	<span class="n">PCIE_SPEED_8_0GT</span><span class="p">,</span>		<span class="cm">/* 3 */</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* 4 */</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* 5 */</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* 6 */</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* 7 */</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* 8 */</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* 9 */</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* A */</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* B */</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* C */</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* D */</span>
	<span class="n">PCI_SPEED_UNKNOWN</span><span class="p">,</span>		<span class="cm">/* E */</span>
	<span class="n">PCI_SPEED_UNKNOWN</span>		<span class="cm">/* F */</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">pcie_update_link_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">u16</span> <span class="n">linksta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">=</span> <span class="n">pcie_link_speed</span><span class="p">[</span><span class="n">linksta</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pcie_update_link_speed</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">agp_speeds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AGP_UNKNOWN</span><span class="p">,</span>
	<span class="n">AGP_1X</span><span class="p">,</span>
	<span class="n">AGP_2X</span><span class="p">,</span>
	<span class="n">AGP_4X</span><span class="p">,</span>
	<span class="n">AGP_8X</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">pci_bus_speed</span> <span class="nf">agp_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">agp3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">agpstat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agpstat</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">agpstat</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">agpstat</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">agp3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">agp_speeds</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_set_bus_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CAP_ID_AGP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CAP_ID_AGP3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">agpstat</span><span class="p">,</span> <span class="n">agpcmd</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_AGP_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">agpstat</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">agp_speed</span><span class="p">(</span><span class="n">agpstat</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">agpstat</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_AGP_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">agpcmd</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">=</span> <span class="n">agp_speed</span><span class="p">(</span><span class="n">agpstat</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">agpcmd</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CAP_ID_PCIX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">enum</span> <span class="n">pci_bus_speed</span> <span class="n">max</span><span class="p">;</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max</span> <span class="o">=</span> <span class="n">PCI_SPEED_133MHz_PCIX_533</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max</span> <span class="o">=</span> <span class="n">PCI_SPEED_133MHz_PCIX_266</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">max</span> <span class="o">=</span> <span class="n">PCI_SPEED_133MHz_PCIX_ECC</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">max</span> <span class="o">=</span> <span class="n">PCI_SPEED_133MHz_PCIX</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">max</span> <span class="o">=</span> <span class="n">PCI_SPEED_66MHz_PCIX</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">=</span> <span class="n">pcix_bus_speed</span><span class="p">[(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">PCI_CAP_ID_EXP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">linkcap</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">linksta</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKCAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linkcap</span><span class="p">);</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">pcie_link_speed</span><span class="p">[</span><span class="n">linkcap</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKSTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linksta</span><span class="p">);</span>
		<span class="n">pcie_update_link_speed</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">linksta</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="nf">pci_alloc_child_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span><span class="p">,</span> <span class="kt">int</span> <span class="n">busnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate a new bus, and inherit stuff from the parent..</span>
<span class="cm">	 */</span>
	<span class="n">child</span> <span class="o">=</span> <span class="n">pci_alloc_bus</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">child</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">sysdata</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">sysdata</span><span class="p">;</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">bus_flags</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">bus_flags</span><span class="p">;</span>

	<span class="cm">/* initialize some portions of the bus device, but don&#39;t register it</span>
<span class="cm">	 * now as the parent is not properly set up yet.  This device will get</span>
<span class="cm">	 * registered later in pci_bus_add_devices()</span>
<span class="cm">	 */</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcibus_class</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%04x:%02x&quot;</span><span class="p">,</span> <span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">child</span><span class="p">),</span> <span class="n">busnr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up the primary, secondary and subordinate</span>
<span class="cm">	 * bus numbers.</span>
<span class="cm">	 */</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">secondary</span> <span class="o">=</span> <span class="n">busnr</span><span class="p">;</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">primary</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">;</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bridge</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">child</span><span class="p">;</span>

	<span class="n">child</span><span class="o">-&gt;</span><span class="n">self</span> <span class="o">=</span> <span class="n">bridge</span><span class="p">;</span>
	<span class="n">child</span><span class="o">-&gt;</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_set_bus_of_node</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="n">pci_set_bus_speed</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

	<span class="cm">/* Set up default resource pointers and names.. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCI_BRIDGE_RESOURCE_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">child</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">PCI_BRIDGE_RESOURCES</span><span class="o">+</span><span class="n">i</span><span class="p">];</span>
		<span class="n">child</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">child</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">__ref</span> <span class="nf">pci_add_new_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">busnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>

	<span class="n">child</span> <span class="o">=</span> <span class="n">pci_alloc_child_bus</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">busnr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_bus_sem</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_bus_sem</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">child</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_fixup_parent_subordinate_busnr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="cm">/* Attempts to fix that up are really dangerous unless</span>
<span class="cm">	   we&#39;re going to re-assign all bus numbers. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcibios_assign_all_busses</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">,</span> <span class="n">PCI_SUBORDINATE_BUS</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If it&#39;s a bridge, configure it and scan the bus behind it.</span>
<span class="cm"> * For CardBus bridges, we don&#39;t scan behind as the devices will</span>
<span class="cm"> * be handled by the bridge driver itself.</span>
<span class="cm"> *</span>
<span class="cm"> * We need to process bridges in two passes -- first we scan those</span>
<span class="cm"> * already configured by the BIOS and after we are done with all of</span>
<span class="cm"> * them, we proceed to assigning numbers to the remaining buses in</span>
<span class="cm"> * order to avoid overlaps between old and new bus numbers.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pci_scan_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pass</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_cardbus</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_CARDBUS</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">buses</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bctl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">subordinate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">broken</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_PRIMARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buses</span><span class="p">);</span>
	<span class="n">primary</span> <span class="o">=</span> <span class="n">buses</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">secondary</span> <span class="o">=</span> <span class="p">(</span><span class="n">buses</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">subordinate</span> <span class="o">=</span> <span class="p">(</span><span class="n">buses</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;scanning [bus %02x-%02x] behind bridge, pass %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">secondary</span><span class="p">,</span> <span class="n">subordinate</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">primary</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">primary</span> <span class="o">!=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">secondary</span> <span class="o">&amp;&amp;</span> <span class="n">subordinate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Primary bus is hard wired to 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">primary</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if setup is sensible at all */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pass</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">primary</span> <span class="o">!=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">||</span> <span class="n">secondary</span> <span class="o">&lt;=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bus configuration invalid, reconfiguring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">broken</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable MasterAbortMode during probing to avoid reporting</span>
<span class="cm">	   of bus errors (in some architectures) */</span> 
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_BRIDGE_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bctl</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_BRIDGE_CONTROL</span><span class="p">,</span>
			      <span class="n">bctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_BRIDGE_CTL_MASTER_ABORT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">secondary</span> <span class="o">||</span> <span class="n">subordinate</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pcibios_assign_all_busses</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">is_cardbus</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">broken</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmax</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Bus already configured by firmware, process it in the first</span>
<span class="cm">		 * pass and just note the configuration.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pass</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we already got to this bus through a different bridge,</span>
<span class="cm">		 * don&#39;t re-add it. This can happen with the i450NX chipset.</span>
<span class="cm">		 *</span>
<span class="cm">		 * However, we continue to descend down the hierarchy and</span>
<span class="cm">		 * scan remaining child buses.</span>
<span class="cm">		 */</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">pci_find_bus</span><span class="p">(</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">bus</span><span class="p">),</span> <span class="n">secondary</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">child</span> <span class="o">=</span> <span class="n">pci_add_new_bus</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">secondary</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">child</span><span class="o">-&gt;</span><span class="n">primary</span> <span class="o">=</span> <span class="n">primary</span><span class="p">;</span>
			<span class="n">child</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">=</span> <span class="n">subordinate</span><span class="p">;</span>
			<span class="n">child</span><span class="o">-&gt;</span><span class="n">bridge_ctl</span> <span class="o">=</span> <span class="n">bctl</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cmax</span> <span class="o">=</span> <span class="n">pci_scan_child_bus</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmax</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
			<span class="n">max</span> <span class="o">=</span> <span class="n">cmax</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
			<span class="n">max</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We need to assign a number to this bus which we always</span>
<span class="cm">		 * do in the second pass.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pass</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcibios_assign_all_busses</span><span class="p">()</span> <span class="o">||</span> <span class="n">broken</span><span class="p">)</span>
				<span class="cm">/* Temporarily disable forwarding of the</span>
<span class="cm">				   configuration cycles on all bridges in</span>
<span class="cm">				   this bus segment to avoid possible</span>
<span class="cm">				   conflicts in the second pass between two</span>
<span class="cm">				   bridges programmed with overlapping</span>
<span class="cm">				   bus ranges. */</span>
				<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_PRIMARY_BUS</span><span class="p">,</span>
						       <span class="n">buses</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xffffff</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Clear errors */</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

		<span class="cm">/* Prevent assigning a bus number that already exists.</span>
<span class="cm">		 * This can happen when a bridge is hot-plugged, so in</span>
<span class="cm">		 * this case we only re-scan this bus. */</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">pci_find_bus</span><span class="p">(</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">bus</span><span class="p">),</span> <span class="n">max</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">child</span> <span class="o">=</span> <span class="n">pci_add_new_bus</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">++</span><span class="n">max</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buses</span> <span class="o">=</span> <span class="p">(</span><span class="n">buses</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span>
		      <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">primary</span><span class="p">)</span>     <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">)</span>
		      <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">)</span>   <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span>
		      <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * yenta.c forces a secondary latency timer of 176.</span>
<span class="cm">		 * Copy that behaviour here.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_cardbus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buses</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xff000000</span><span class="p">;</span>
			<span class="n">buses</span> <span class="o">|=</span> <span class="n">CARDBUS_LATENCY_TIMER</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * We need to blast all three values with a single write.</span>
<span class="cm">		 */</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_PRIMARY_BUS</span><span class="p">,</span> <span class="n">buses</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cardbus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">child</span><span class="o">-&gt;</span><span class="n">bridge_ctl</span> <span class="o">=</span> <span class="n">bctl</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Adjust subordinate busnr in parent buses.</span>
<span class="cm">			 * We do this before scanning for children because</span>
<span class="cm">			 * some devices may not be detected if the bios</span>
<span class="cm">			 * was lazy.</span>
<span class="cm">			 */</span>
			<span class="n">pci_fixup_parent_subordinate_busnr</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
			<span class="cm">/* Now we can scan all subordinate buses... */</span>
			<span class="n">max</span> <span class="o">=</span> <span class="n">pci_scan_child_bus</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * now fix it up again since we have found</span>
<span class="cm">			 * the real value of max.</span>
<span class="cm">			 */</span>
			<span class="n">pci_fixup_parent_subordinate_busnr</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * For CardBus bridges, we leave 4 bus numbers</span>
<span class="cm">			 * as cards with a PCI-to-PCI bridge can be</span>
<span class="cm">			 * inserted later.</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">CARDBUS_RESERVE_BUSNR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pci_find_bus</span><span class="p">(</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">bus</span><span class="p">),</span>
							<span class="n">max</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">pcibios_assign_all_busses</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
					    <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					    <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">&lt;=</span> <span class="n">max</span><span class="o">+</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * Often, there are two cardbus bridges</span>
<span class="cm">					 * -- try to leave one valid bus number</span>
<span class="cm">					 * for each one.</span>
<span class="cm">					 */</span>
					<span class="n">i</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">max</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">pci_fixup_parent_subordinate_busnr</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set the subordinate bus number to its real value.</span>
<span class="cm">		 */</span>
		<span class="n">child</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_SUBORDINATE_BUS</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="p">(</span><span class="n">is_cardbus</span> <span class="o">?</span> <span class="s">&quot;PCI CardBus %04x:%02x&quot;</span> <span class="o">:</span> <span class="s">&quot;PCI Bus %04x:%02x&quot;</span><span class="p">),</span>
		<span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">bus</span><span class="p">),</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="cm">/* Has only triggered on CardBus, fixup is in yenta_socket */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">&gt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&gt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&lt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">&lt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[bus %02x-%02x] %s &quot;</span>
				<span class="s">&quot;hidden behind%s bridge %s [bus %02x-%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">child</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">,</span>
				<span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&gt;</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">&amp;&amp;</span>
				 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">&lt;</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="o">?</span>
					<span class="s">&quot;wholly&quot;</span> <span class="o">:</span> <span class="s">&quot;partially&quot;</span><span class="p">,</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">transparent</span> <span class="o">?</span> <span class="s">&quot; transparent&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_BRIDGE_CONTROL</span><span class="p">,</span> <span class="n">bctl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read interrupt line and base address registers.</span>
<span class="cm"> * The architecture-dependent code can tweak these, of course.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_read_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_PIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pin</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_pcie_port_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg16</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_EXP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">is_pcie</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">pcie_cap</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_EXP_FLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg16</span><span class="p">);</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">pcie_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg16</span> <span class="o">&amp;</span> <span class="n">PCI_EXP_FLAGS_TYPE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg16</span><span class="p">);</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">pcie_mpss</span> <span class="o">=</span> <span class="n">reg16</span> <span class="o">&amp;</span> <span class="n">PCI_EXP_DEVCAP_PAYLOAD</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_pcie_hotplug_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg16</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg32</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_EXP_FLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg16</span> <span class="o">&amp;</span> <span class="n">PCI_EXP_FLAGS_SLOT</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_EXP_SLTCAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg32</span> <span class="o">&amp;</span> <span class="n">PCI_EXP_SLTCAP_HPC</span><span class="p">)</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">is_hotplug_bridge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define LEGACY_IO_RESOURCE	(IORESOURCE_IO | IORESOURCE_PCI_FIXED)</span>

<span class="cm">/**</span>
<span class="cm"> * pci_setup_device - fill in class and map information of a device</span>
<span class="cm"> * @dev: the device structure to fill</span>
<span class="cm"> *</span>
<span class="cm"> * Initialize the device structure with information about the device&#39;s </span>
<span class="cm"> * vendor,class,memory and IO-space addresses,IRQ lines etc.</span>
<span class="cm"> * Called at initialisation of the PCI subsystem and by CardBus services.</span>
<span class="cm"> * Returns 0 on success and negative if unknown type of device (not normal,</span>
<span class="cm"> * bridge or CardBus).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pci_setup_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">class</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hdr_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus_region</span> <span class="n">region</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sysdata</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sysdata</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci_bus_type</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span> <span class="o">=</span> <span class="n">hdr_type</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">multifunction</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">hdr_type</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">error_state</span> <span class="o">=</span> <span class="n">pci_channel_io_normal</span><span class="p">;</span>
	<span class="n">set_pcie_port_type</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>

	<span class="cm">/* Assume 32-bit PCI; let 64-bit PCI cards (which are far rarer)</span>
<span class="cm">	   set this higher, assuming the system even supports it.  */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%04x:%02x:%02x.%d&quot;</span><span class="p">,</span> <span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">),</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
		     <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_CLASS_REVISION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">class</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">class</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>		    <span class="cm">/* upper 3 bytes */</span>

	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%04x:%04x] type %02x class %#08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">);</span>

	<span class="cm">/* need to have dev-&gt;class ready */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cfg_size</span> <span class="o">=</span> <span class="n">pci_cfg_space_size</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* &quot;Unknown power state&quot; */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">PCI_UNKNOWN</span><span class="p">;</span>

	<span class="cm">/* Early fixups, before probing the BARs */</span>
	<span class="n">pci_fixup_device</span><span class="p">(</span><span class="n">pci_fixup_early</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* device class may be changed after fixup */</span>
	<span class="n">class</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span><span class="p">)</span> <span class="p">{</span>		    <span class="cm">/* header type */</span>
	<span class="k">case</span> <span class="n">PCI_HEADER_TYPE_NORMAL</span>:		    <span class="cm">/* standard header */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">PCI_CLASS_BRIDGE_PCI</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">pci_read_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pci_read_bases</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">PCI_ROM_ADDRESS</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_SUBSYSTEM_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_SUBSYSTEM_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 *	Do the ugly legacy mode stuff here rather than broken chip</span>
<span class="cm">		 *	quirk code. Legacy mode ATA controllers have fixed</span>
<span class="cm">		 *	addresses. These are not always echoed in BAR0-3, and</span>
<span class="cm">		 *	BAR0-3 in a few cases contain junk!</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">PCI_CLASS_STORAGE_IDE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">progif</span><span class="p">;</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_CLASS_PROG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">progif</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">progif</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">region</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x1F0</span><span class="p">;</span>
				<span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x1F7</span><span class="p">;</span>
				<span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LEGACY_IO_RESOURCE</span><span class="p">;</span>
				<span class="n">pcibios_bus_to_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">);</span>
				<span class="n">region</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x3F6</span><span class="p">;</span>
				<span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x3F6</span><span class="p">;</span>
				<span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LEGACY_IO_RESOURCE</span><span class="p">;</span>
				<span class="n">pcibios_bus_to_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">progif</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">region</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x170</span><span class="p">;</span>
				<span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x177</span><span class="p">;</span>
				<span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LEGACY_IO_RESOURCE</span><span class="p">;</span>
				<span class="n">pcibios_bus_to_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">);</span>
				<span class="n">region</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x376</span><span class="p">;</span>
				<span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x376</span><span class="p">;</span>
				<span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LEGACY_IO_RESOURCE</span><span class="p">;</span>
				<span class="n">pcibios_bus_to_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span>:		    <span class="cm">/* bridge header */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">!=</span> <span class="n">PCI_CLASS_BRIDGE_PCI</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="cm">/* The PCI-to-PCI bridge spec requires that subtractive</span>
<span class="cm">		   decoding (i.e. transparent) bridge must have programming</span>
<span class="cm">		   interface code of 0x01. */</span> 
		<span class="n">pci_read_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">transparent</span> <span class="o">=</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pci_read_bases</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PCI_ROM_ADDRESS1</span><span class="p">);</span>
		<span class="n">set_pcie_hotplug_bridge</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_SSVID</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_SSVID_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">);</span>
			<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_SSVID_DEVICE_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PCI_HEADER_TYPE_CARDBUS</span>:		    <span class="cm">/* CardBus bridge header */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">!=</span> <span class="n">PCI_CLASS_BRIDGE_CARDBUS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
		<span class="n">pci_read_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pci_read_bases</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_CB_SUBSYSTEM_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_CB_SUBSYSTEM_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>				    <span class="cm">/* unknown header */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown header type %02x, &quot;</span>
			<span class="s">&quot;ignoring device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="nl">bad:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ignoring class %#08x (doesn&#39;t match header &quot;</span>
			<span class="s">&quot;type %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">PCI_CLASS_NOT_DEFINED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We found a fine healthy device, go go go... */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_release_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_vpd_release</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_iov_release</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_free_cap_save_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_release_dev - free a pci device structure when all users of it are finished.</span>
<span class="cm"> * @dev: device that&#39;s been disconnected</span>
<span class="cm"> *</span>
<span class="cm"> * Will be called only by the device core when all users of this pci device are</span>
<span class="cm"> * done.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_release_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">pci_dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_release_capabilities</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">pci_release_of_node</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_cfg_space_size - get the configuration space size of the PCI device.</span>
<span class="cm"> * @dev: PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * Regular PCI devices have 256 bytes, but PCI-X 2 and PCI Express devices</span>
<span class="cm"> * have 4096 bytes.  Even if the device is capable, that doesn&#39;t mean we can</span>
<span class="cm"> * access it.  Maybe we don&#39;t have a way to generate extended config space</span>
<span class="cm"> * accesses, or the device is behind a reverse Express bridge.  So we try</span>
<span class="cm"> * reading the dword at 0x100 which must either be 0 or a valid extended</span>
<span class="cm"> * capability header.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pci_cfg_space_size_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">PCI_CFG_SPACE_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">PCI_CFG_SPACE_EXP_SIZE</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">PCI_CFG_SPACE_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pci_cfg_space_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">class</span><span class="p">;</span>

	<span class="n">class</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">PCI_CLASS_BRIDGE_HOST</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pci_cfg_space_size_ext</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_PCIX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_X_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCI_X_STATUS_266MHZ</span> <span class="o">|</span> <span class="n">PCI_X_STATUS_533MHZ</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pci_cfg_space_size_ext</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

 <span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">PCI_CFG_SPACE_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_release_bus_bridge_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_host_bridge</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">to_pci_host_bridge</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">release_fn</span><span class="p">)</span>
		<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">release_fn</span><span class="p">(</span><span class="n">bridge</span><span class="p">);</span>

	<span class="n">pci_free_resource_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">windows</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">bridge</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="nf">alloc_pci_dev</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">alloc_pci_dev</span><span class="p">);</span>

<span class="n">bool</span> <span class="nf">pci_bus_read_dev_vendor_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">crs_timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_bus_read_config_dword</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* some broken boards return 0 or ~0 if a slot is empty: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">l</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">||</span> <span class="o">*</span><span class="n">l</span> <span class="o">==</span> <span class="mh">0x00000000</span> <span class="o">||</span>
	    <span class="o">*</span><span class="n">l</span> <span class="o">==</span> <span class="mh">0x0000ffff</span> <span class="o">||</span> <span class="o">*</span><span class="n">l</span> <span class="o">==</span> <span class="mh">0xffff0000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Configuration request Retry Status */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">l</span> <span class="o">==</span> <span class="mh">0xffff0001</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crs_timeout</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
		<span class="n">delay</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_bus_read_config_dword</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="cm">/* Card hasn&#39;t responded in 60 seconds?  Must be stuck. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="n">crs_timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pci %04x:%02x:%02x.%d: not &quot;</span>
					<span class="s">&quot;responding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">bus</span><span class="p">),</span>
					<span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">),</span>
					<span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">devfn</span><span class="p">));</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_bus_read_dev_vendor_id</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Read the config data for a PCI device, sanity-check it</span>
<span class="cm"> * and fill in the dev structure...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="nf">pci_scan_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_bus_read_dev_vendor_id</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_pci_dev</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">=</span> <span class="n">devfn</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">l</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">pci_set_of_node</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_setup_device</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_init_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* MSI/MSI-X list */</span>
	<span class="n">pci_msi_init_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Buffers for saving PCIe and PCI-X capabilities */</span>
	<span class="n">pci_allocate_cap_save_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Power Management */</span>
	<span class="n">pci_pm_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">platform_pci_wakeup_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Vital Product Data */</span>
	<span class="n">pci_vpd_pci22_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Alternative Routing-ID Forwarding */</span>
	<span class="n">pci_enable_ari</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Single Root I/O Virtualization */</span>
	<span class="n">pci_iov_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Enable ACS P2P upstream forwarding */</span>
	<span class="n">pci_enable_acs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pci_device_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">pci_release_dev</span><span class="p">;</span>
	<span class="n">pci_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_parms</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_parms</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">coherent_dma_mask</span> <span class="o">=</span> <span class="mh">0xffffffffull</span><span class="p">;</span>

	<span class="n">pci_set_dma_max_seg_size</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">65536</span><span class="p">);</span>
	<span class="n">pci_set_dma_seg_boundary</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="cm">/* Fix up broken headers */</span>
	<span class="n">pci_fixup_device</span><span class="p">(</span><span class="n">pci_fixup_header</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* moved out from quirk header fixup code */</span>
	<span class="n">pci_reassigndev_resource_alignment</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Clear the state_saved flag. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state_saved</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Initialize various capabilities */</span>
	<span class="n">pci_init_capabilities</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add the device to our list of discovered devices</span>
<span class="cm">	 * and the bus list for fixup functions, etc.</span>
<span class="cm">	 */</span>
	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_bus_sem</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_bus_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">__ref</span> <span class="nf">pci_scan_single_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_slot</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_scan_device</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pci_device_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bus</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_scan_single_device</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">next_ari_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">cap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pos</span><span class="p">,</span> <span class="n">next_fn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_ARI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap</span><span class="p">);</span>
	<span class="n">next_fn</span> <span class="o">=</span> <span class="n">cap</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next_fn</span> <span class="o">&lt;=</span> <span class="n">fn</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">next_fn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">next_trad_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">fn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">no_next_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">only_one_child</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parent</span> <span class="o">||</span> <span class="o">!</span><span class="n">pci_is_pcie</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">pcie_type</span> <span class="o">==</span> <span class="n">PCI_EXP_TYPE_ROOT_PORT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">pcie_type</span> <span class="o">==</span> <span class="n">PCI_EXP_TYPE_DOWNSTREAM</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">pci_has_flag</span><span class="p">(</span><span class="n">PCI_SCAN_ALL_PCIE_DEVS</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_scan_slot - scan a PCI slot on a bus for devices.</span>
<span class="cm"> * @bus: PCI bus to scan</span>
<span class="cm"> * @devfn: slot number to scan (must have zero function.)</span>
<span class="cm"> *</span>
<span class="cm"> * Scan a PCI slot on the specified PCI bus for devices, adding</span>
<span class="cm"> * discovered devices to the @bus-&gt;devices list.  New devices</span>
<span class="cm"> * will not have is_added set.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the number of new devices found.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pci_scan_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">fn</span><span class="p">,</span> <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="p">(</span><span class="o">*</span><span class="n">next_fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">)</span> <span class="o">=</span> <span class="n">no_next_fn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">only_one_child</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devfn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Already scanned the entire slot */</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_scan_single_device</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_added</span><span class="p">)</span>
		<span class="n">nr</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_ari_enabled</span><span class="p">(</span><span class="n">bus</span><span class="p">))</span>
		<span class="n">next_fn</span> <span class="o">=</span> <span class="n">next_ari_fn</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">multifunction</span><span class="p">)</span>
		<span class="n">next_fn</span> <span class="o">=</span> <span class="n">next_trad_fn</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">fn</span> <span class="o">=</span> <span class="n">next_fn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">fn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">next_fn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fn</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_scan_single_device</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span> <span class="o">+</span> <span class="n">fn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_added</span><span class="p">)</span>
				<span class="n">nr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">multifunction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* only one slot has pcie device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span> <span class="o">&amp;&amp;</span> <span class="n">nr</span><span class="p">)</span>
		<span class="n">pcie_aspm_init_link_state</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcie_find_smpss</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">smpss</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_is_pcie</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* For PCIE hotplug enabled slots not connected directly to a</span>
<span class="cm">	 * PCI-E root port, there can be problems when hotplugging</span>
<span class="cm">	 * devices.  This is due to the possibility of hotplugging a</span>
<span class="cm">	 * device into the fabric with a smaller MPS that the devices</span>
<span class="cm">	 * currently running have configured.  Modifying the MPS on the</span>
<span class="cm">	 * running devices could cause a fatal bus error due to an</span>
<span class="cm">	 * incoming frame being larger than the newly configured MPS.</span>
<span class="cm">	 * To work around this, the MPS for the entire fabric must be</span>
<span class="cm">	 * set to the minimum size.  Any devices hotplugged into this</span>
<span class="cm">	 * fabric will have the minimum MPS set.  If the PCI hotplug</span>
<span class="cm">	 * slot is directly connected to the root port and there are not</span>
<span class="cm">	 * other devices on the fabric (which seems to be the most</span>
<span class="cm">	 * common case), then this is not an issue and MPS discovery</span>
<span class="cm">	 * will occur as normal.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_hotplug_bridge</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">list_is_singular</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span> <span class="o">&amp;&amp;</span>
	      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pcie_type</span> <span class="o">!=</span> <span class="n">PCI_EXP_TYPE_ROOT_PORT</span><span class="p">)))</span>
		<span class="o">*</span><span class="n">smpss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">smpss</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcie_mpss</span><span class="p">)</span>
		<span class="o">*</span><span class="n">smpss</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcie_mpss</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcie_write_mps</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcie_bus_config</span> <span class="o">==</span> <span class="n">PCIE_BUS_PERFORMANCE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mps</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcie_mpss</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcie_type</span> <span class="o">!=</span> <span class="n">PCI_EXP_TYPE_ROOT_PORT</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span>
			<span class="cm">/* For &quot;Performance&quot;, the assumption is made that</span>
<span class="cm">			 * downstream communication will never be larger than</span>
<span class="cm">			 * the MRRS.  So, the MPS only needs to be configured</span>
<span class="cm">			 * for the upstream communication.  This being the case,</span>
<span class="cm">			 * walk from the top down and set the MPS of the child</span>
<span class="cm">			 * to that of the parent bus.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Configure the device MPS with the smaller of the</span>
<span class="cm">			 * device MPSS or the bridge MPS (which is assumed to be</span>
<span class="cm">			 * properly configured at this point to the largest</span>
<span class="cm">			 * allowable MPS based on its parent bus).</span>
<span class="cm">			 */</span>
			<span class="n">mps</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">mps</span><span class="p">,</span> <span class="n">pcie_get_mps</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcie_set_mps</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mps</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed attempting to set the MPS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcie_write_mrrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">mrrs</span><span class="p">;</span>

	<span class="cm">/* In the &quot;safe&quot; case, do not configure the MRRS.  There appear to be</span>
<span class="cm">	 * issues with setting MRRS to 0 on a number of devices.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcie_bus_config</span> <span class="o">!=</span> <span class="n">PCIE_BUS_PERFORMANCE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* For Max performance, the MRRS must be set to the largest supported</span>
<span class="cm">	 * value.  However, it cannot be configured larger than the MPS the</span>
<span class="cm">	 * device or the bus can support.  This should already be properly</span>
<span class="cm">	 * configured by a prior call to pcie_write_mps.</span>
<span class="cm">	 */</span>
	<span class="n">mrrs</span> <span class="o">=</span> <span class="n">pcie_get_mps</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* MRRS is a R/W register.  Invalid values can be written, but a</span>
<span class="cm">	 * subsequent read will verify if the value is acceptable or not.</span>
<span class="cm">	 * If the MRRS value provided is not acceptable (e.g., too large),</span>
<span class="cm">	 * shrink the value until it is acceptable to the HW.</span>
<span class="cm"> 	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mrrs</span> <span class="o">!=</span> <span class="n">pcie_get_readrq</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mrrs</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pcie_set_readrq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mrrs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed attempting to set the MRRS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mrrs</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mrrs</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MRRS was unable to be configured with a &quot;</span>
			<span class="s">&quot;safe value.  If problems are experienced, try running &quot;</span>
			<span class="s">&quot;with pci=pcie_bus_safe.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcie_bus_configure_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mps</span><span class="p">,</span> <span class="n">orig_mps</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_is_pcie</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mps</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">orig_mps</span> <span class="o">=</span> <span class="n">pcie_get_mps</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pcie_write_mps</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mps</span><span class="p">);</span>
	<span class="n">pcie_write_mrrs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI-E Max Payload Size set to %4d/%4d (was %4d), &quot;</span>
		 <span class="s">&quot;Max Read Rq %4d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcie_get_mps</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="mi">128</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcie_mpss</span><span class="p">,</span>
		 <span class="n">orig_mps</span><span class="p">,</span> <span class="n">pcie_get_readrq</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* pcie_bus_configure_settings requires that pci_walk_bus work in a top-down,</span>
<span class="cm"> * parents then children fashion.  If this changes, then this code will not</span>
<span class="cm"> * work as designed.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pcie_bus_configure_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mpss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">smpss</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_is_pcie</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcie_bus_config</span> <span class="o">==</span> <span class="n">PCIE_BUS_TUNE_OFF</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* FIXME - Peer to peer DMA is possible, though the endpoint would need</span>
<span class="cm">	 * to be aware to the MPS of the destination.  To work around this,</span>
<span class="cm">	 * simply force the MPS of the entire system to the smallest possible.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcie_bus_config</span> <span class="o">==</span> <span class="n">PCIE_BUS_PEER2PEER</span><span class="p">)</span>
		<span class="n">smpss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcie_bus_config</span> <span class="o">==</span> <span class="n">PCIE_BUS_SAFE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smpss</span> <span class="o">=</span> <span class="n">mpss</span><span class="p">;</span>

		<span class="n">pcie_find_smpss</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smpss</span><span class="p">);</span>
		<span class="n">pci_walk_bus</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">pcie_find_smpss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smpss</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pcie_bus_configure_set</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smpss</span><span class="p">);</span>
	<span class="n">pci_walk_bus</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">pcie_bus_configure_set</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smpss</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pcie_bus_configure_settings</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pci_scan_child_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">pass</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;scanning bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Go find them, Rover! */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">devfn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">devfn</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">devfn</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">pci_scan_slot</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">);</span>

	<span class="cm">/* Reserve buses for SR-IOV capability. */</span>
	<span class="n">max</span> <span class="o">+=</span> <span class="n">pci_iov_bus_range</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * After performing arch-dependent fixup of the bus, look behind</span>
<span class="cm">	 * all PCI-to-PCI bridges on this bus.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">is_added</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fixups for bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pcibios_fixup_bus</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_is_root_bus</span><span class="p">(</span><span class="n">bus</span><span class="p">))</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">is_added</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pass</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">pass</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">pass</span><span class="o">++</span><span class="p">)</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span> <span class="o">||</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_CARDBUS</span><span class="p">)</span>
				<span class="n">max</span> <span class="o">=</span> <span class="n">pci_scan_bridge</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We&#39;ve scanned the bus and so we know all about what&#39;s on</span>
<span class="cm">	 * the other side of any bridges that may be on this bus plus</span>
<span class="cm">	 * any devices.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Return how far we&#39;ve got finding sub-buses.</span>
<span class="cm">	 */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bus scan returning with max=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="nf">pci_create_root_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">pci_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sysdata</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">resources</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_host_bridge</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">b2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_host_bridge_window</span> <span class="o">*</span><span class="n">window</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">bus_addr</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>


	<span class="n">b</span> <span class="o">=</span> <span class="n">pci_alloc_bus</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">b</span><span class="o">-&gt;</span><span class="n">sysdata</span> <span class="o">=</span> <span class="n">sysdata</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
	<span class="n">b2</span> <span class="o">=</span> <span class="n">pci_find_bus</span><span class="p">(</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we already got to this bus through a different bridge, ignore it */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b2</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bus already known</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">pci_alloc_host_bridge</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bridge</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
	<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">pci_release_bus_bridge_dev</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pci%04x:%02x&quot;</span><span class="p">,</span> <span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">bus</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bridge_dev_reg_err</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">device_enable_async_suspend</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">);</span>
	<span class="n">pci_set_bus_of_node</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">set_dev_node</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">,</span> <span class="n">pcibus_to_node</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>

	<span class="n">b</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcibus_class</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%04x:%02x&quot;</span><span class="p">,</span> <span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">bus</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">class_dev_reg_err</span><span class="p">;</span>

	<span class="cm">/* Create legacy_io and legacy_mem files for this bus */</span>
	<span class="n">pci_create_legacy_files</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

	<span class="n">b</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">secondary</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;PCI host bridge to bus %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCI host bridge to bus %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="cm">/* Add initial resources to the bus */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">window</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">windows</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">window</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">window</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">pci_bus_add_resource</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">resource_type</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span>
				<span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot; (bus address [%#06llx-%#06llx])&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot; (bus address [%#010llx-%#010llx])&quot;</span><span class="p">;</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">bus_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bus_addr</span><span class="p">),</span> <span class="n">fmt</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="n">offset</span><span class="p">),</span>
				 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">offset</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bus_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;root bus resource %pR%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">bus_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_bus_sem</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_root_buses</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_bus_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">b</span><span class="p">;</span>

<span class="nl">class_dev_reg_err:</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">bridge_dev_reg_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bridge</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">pci_scan_root_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">pci_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sysdata</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">resources</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">=</span> <span class="n">pci_create_root_bus</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">sysdata</span><span class="p">,</span> <span class="n">resources</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">b</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">=</span> <span class="n">pci_scan_child_bus</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="n">pci_bus_add_devices</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_scan_root_bus</span><span class="p">);</span>

<span class="cm">/* Deprecated; use pci_scan_root_bus() instead */</span>
<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">pci_scan_bus_parented</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sysdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">resources</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>

	<span class="n">pci_add_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resources</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">);</span>
	<span class="n">pci_add_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resources</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">);</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">pci_create_root_bus</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">sysdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resources</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">=</span> <span class="n">pci_scan_child_bus</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pci_free_resource_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resources</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_scan_bus_parented</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">pci_scan_bus</span><span class="p">(</span><span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
					<span class="kt">void</span> <span class="o">*</span><span class="n">sysdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">resources</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>

	<span class="n">pci_add_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resources</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">);</span>
	<span class="n">pci_add_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resources</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">);</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">pci_create_root_bus</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">sysdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resources</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">=</span> <span class="n">pci_scan_child_bus</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
		<span class="n">pci_bus_add_devices</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_free_resource_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resources</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_scan_bus</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_HOTPLUG</span>
<span class="cm">/**</span>
<span class="cm"> * pci_rescan_bus_bridge_resize - scan a PCI bus for devices.</span>
<span class="cm"> * @bridge: PCI bridge for the bus to scan</span>
<span class="cm"> *</span>
<span class="cm"> * Scan a PCI bus and child buses for new devices, add them,</span>
<span class="cm"> * and enable them, resizing bridge mmio/io resource if necessary</span>
<span class="cm"> * and possible.  The caller must ensure the child devices are already</span>
<span class="cm"> * removed for resizing to occur.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the max number of subordinate bus discovered.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__ref</span> <span class="nf">pci_rescan_bus_bridge_resize</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">;</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">pci_scan_child_bus</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="n">pci_assign_unassigned_bridge_resources</span><span class="p">(</span><span class="n">bridge</span><span class="p">);</span>

	<span class="n">pci_bus_add_devices</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_add_new_bus</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_scan_slot</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_scan_bridge</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_scan_child_bus</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pci_sort_bf_cmp</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d_a</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d_b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">d_a</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">d_b</span><span class="p">);</span>

	<span class="k">if</span>      <span class="p">(</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">))</span> <span class="k">return</span>  <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span>      <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="k">return</span>  <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span>      <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="k">return</span>  <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">pci_sort_breadthfirst</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bus_sort_breadthfirst</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_bus_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_sort_bf_cmp</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
