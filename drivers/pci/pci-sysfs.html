<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pci › pci-sysfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pci-sysfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/pci/pci-sysfs.c</span>
<span class="cm"> *</span>
<span class="cm"> * (C) Copyright 2002-2004 Greg Kroah-Hartman &lt;greg@kroah.com&gt;</span>
<span class="cm"> * (C) Copyright 2002-2004 IBM Corp.</span>
<span class="cm"> * (C) Copyright 2003 Matthew Wilcox</span>
<span class="cm"> * (C) Copyright 2003 Hewlett-Packard</span>
<span class="cm"> * (C) Copyright 2004 Jon Smirl &lt;jonsmirl@yahoo.com&gt;</span>
<span class="cm"> * (C) Copyright 2004 Silicon Graphics, Inc. Jesse Barnes &lt;jbarnes@sgi.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * File attributes for PCI devices</span>
<span class="cm"> *</span>
<span class="cm"> * Modeled after usb&#39;s driverfs.c </span>
<span class="cm"> *</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/topology.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/security.h&gt;</span>
<span class="cp">#include &lt;linux/pci-aspm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vgaarb.h&gt;</span>
<span class="cp">#include &quot;pci.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sysfs_initialized</span><span class="p">;</span>	<span class="cm">/* = 0 */</span>

<span class="cm">/* show configuration fields */</span>
<span class="cp">#define pci_config_attr(field, format_string)				\</span>
<span class="cp">static ssize_t								\</span>
<span class="cp">field##_show(struct device *dev, struct device_attribute *attr, char *buf)				\</span>
<span class="cp">{									\</span>
<span class="cp">	struct pci_dev *pdev;						\</span>
<span class="cp">									\</span>
<span class="cp">	pdev = to_pci_dev (dev);					\</span>
<span class="cp">	return sprintf (buf, format_string, pdev-&gt;field);		\</span>
<span class="cp">}</span>

<span class="n">pci_config_attr</span><span class="p">(</span><span class="n">vendor</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">pci_config_attr</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">pci_config_attr</span><span class="p">(</span><span class="n">subsystem_vendor</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">pci_config_attr</span><span class="p">(</span><span class="n">subsystem_device</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">pci_config_attr</span><span class="p">(</span><span class="n">class</span><span class="p">,</span> <span class="s">&quot;0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">pci_config_attr</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">broken_parity_status_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">broken_parity_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">broken_parity_status_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">broken_parity_status</span> <span class="o">=</span> <span class="o">!!</span><span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">local_cpus_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>		
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cpumask</span> <span class="o">*</span><span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_NUMA</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev_to_node</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">cpu_online_mask</span> <span class="o">:</span>
					  <span class="n">cpumask_of_node</span><span class="p">(</span><span class="n">dev_to_node</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">cpumask_of_pcibus</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">cpumask_scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">local_cpulist_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cpumask</span> <span class="o">*</span><span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_NUMA</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev_to_node</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">cpu_online_mask</span> <span class="o">:</span>
					  <span class="n">cpumask_of_node</span><span class="p">(</span><span class="n">dev_to_node</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">cpumask_of_pcibus</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">cpulist_scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PCI Bus Class Devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pci_bus_show_cpuaffinity</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cpumask</span> <span class="o">*</span><span class="n">cpumask</span><span class="p">;</span>

	<span class="n">cpumask</span> <span class="o">=</span> <span class="n">cpumask_of_pcibus</span><span class="p">(</span><span class="n">to_pci_bus</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">type</span> <span class="o">?</span>
		<span class="n">cpulist_scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">cpumask</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">cpumask_scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">cpumask</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">ret</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">ret</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">ssize_t</span> <span class="nf">pci_bus_show_cpumaskaffinity</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_bus_show_cpuaffinity</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">ssize_t</span> <span class="nf">pci_bus_show_cpulistaffinity</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_bus_show_cpuaffinity</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* show resources */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">resource_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span> <span class="n">pci_dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">)</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">DEVICE_COUNT_RESOURCE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">PCI_BRIDGE_RESOURCES</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span>  <span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">pci_resource_to_user</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">);</span>
		<span class="n">str</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="s">&quot;0x%016llx 0x%016llx 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">start</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">end</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">str</span> <span class="o">-</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">modalias_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;pci:v%08Xd%08Xsv%08Xsd%08Xbc%02Xsc%02Xi%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		       <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span>
		       <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">is_enabled_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">result</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* this can crash the machine when done on the &quot;wrong&quot; device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_is_enabled</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">result</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">is_enabled_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">enable_cnt</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NUMA</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">numa_node_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">numa_node</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dma_mask_bits_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fls64</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">consistent_dma_mask_bits_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fls64</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">coherent_dma_mask</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">msi_bus_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">!</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="o">-&gt;</span><span class="n">bus_flags</span> <span class="o">&amp;</span> <span class="n">PCI_BUS_FLAGS_NO_MSI</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">msi_bus_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* bad things may happen if the no_msi flag is changed</span>
<span class="cm">	 * while some drivers are loaded */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* Maybe pci devices without subordinate busses shouldn&#39;t even have this</span>
<span class="cm">	 * attribute in the first place?  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* Is the flag going to change, or keep the value it already had? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="o">-&gt;</span><span class="n">bus_flags</span> <span class="o">&amp;</span> <span class="n">PCI_BUS_FLAGS_NO_MSI</span><span class="p">)</span> <span class="o">^</span>
	    <span class="o">!!</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="o">-&gt;</span><span class="n">bus_flags</span> <span class="o">^=</span> <span class="n">PCI_BUS_FLAGS_NO_MSI</span><span class="p">;</span>

		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;forced subordinate bus to%s support MSI,&quot;</span>
			 <span class="s">&quot; bad things could happen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; not&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HOTPLUG</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">pci_remove_rescan_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bus_rescan_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_type</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_remove_rescan_mutex</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">b</span> <span class="o">=</span> <span class="n">pci_find_next_bus</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">pci_rescan_bus</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_remove_rescan_mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bus_attribute</span> <span class="n">pci_bus_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">rescan</span><span class="p">,</span> <span class="p">(</span><span class="n">S_IWUSR</span><span class="o">|</span><span class="n">S_IWGRP</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bus_rescan_store</span><span class="p">),</span>
	<span class="n">__ATTR_NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dev_rescan_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_remove_rescan_mutex</span><span class="p">);</span>
		<span class="n">pci_rescan_bus</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_remove_rescan_mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_remove_rescan_mutex</span><span class="p">);</span>
	<span class="n">pci_stop_and_remove_bus_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_remove_rescan_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">remove_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">dummy</span><span class="p">,</span>
	     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* An attribute cannot be unregistered by one of its own methods,</span>
<span class="cm">	 * so we have to use this roundabout approach.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">device_schedule_callback</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">remove_callback</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">dev_bus_rescan_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">to_pci_bus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_remove_rescan_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_is_root_bus</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">))</span>
			<span class="n">pci_rescan_bus_bridge_resize</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pci_rescan_bus</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_remove_rescan_mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">pci_dev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">resource</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">vendor</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">subsystem_vendor</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">subsystem_device</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">class</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">irq</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">local_cpus</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">local_cpulist</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">modalias</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_NUMA</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">numa_node</span><span class="p">),</span>
<span class="cp">#endif</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">dma_mask_bits</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">consistent_dma_mask_bits</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">is_enabled_show</span><span class="p">,</span> <span class="n">is_enabled_store</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">broken_parity_status</span><span class="p">,(</span><span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">),</span>
		<span class="n">broken_parity_status_show</span><span class="p">,</span><span class="n">broken_parity_status_store</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">msi_bus</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">msi_bus_show</span><span class="p">,</span> <span class="n">msi_bus_store</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_HOTPLUG</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">remove</span><span class="p">,</span> <span class="p">(</span><span class="n">S_IWUSR</span><span class="o">|</span><span class="n">S_IWGRP</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">remove_store</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">rescan</span><span class="p">,</span> <span class="p">(</span><span class="n">S_IWUSR</span><span class="o">|</span><span class="n">S_IWGRP</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dev_rescan_store</span><span class="p">),</span>
<span class="cp">#endif</span>
	<span class="n">__ATTR_NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">pcibus_dev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_HOTPLUG</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">rescan</span><span class="p">,</span> <span class="p">(</span><span class="n">S_IWUSR</span><span class="o">|</span><span class="n">S_IWGRP</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dev_bus_rescan_store</span><span class="p">),</span>
<span class="cp">#endif</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">cpuaffinity</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">pci_bus_show_cpumaskaffinity</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">cpulistaffinity</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">pci_bus_show_cpulistaffinity</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR_NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">boot_vga_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">vga_dev</span> <span class="o">=</span> <span class="n">vga_default_device</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vga_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pdev</span> <span class="o">==</span> <span class="n">vga_dev</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">!!</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">PCI_ROM_RESOURCE</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span>
		   <span class="n">IORESOURCE_ROM_SHADOW</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">vga_attr</span> <span class="o">=</span> <span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">boot_vga</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">pci_read_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span><span class="k">struct</span> <span class="n">device</span><span class="p">,</span><span class="n">kobj</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">init_off</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* Several chips lock up trying to read undefined config space */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">security_capable</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_cred</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span> <span class="n">CAP_SYS_ADMIN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cfg_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_CARDBUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">off</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">pci_user_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">off</span><span class="o">++</span><span class="p">;</span>
		<span class="n">size</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">pci_user_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">pci_user_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">pci_user_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">pci_user_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">off</span><span class="o">++</span><span class="p">;</span>
		<span class="o">--</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">pci_write_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span><span class="o">*</span> <span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
		 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span><span class="k">struct</span> <span class="n">device</span><span class="p">,</span><span class="n">kobj</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">init_off</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cfg_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cfg_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cfg_size</span> <span class="o">-</span> <span class="n">off</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_user_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span><span class="p">]);</span>
		<span class="n">off</span><span class="o">++</span><span class="p">;</span>
		<span class="n">size</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span><span class="p">];</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
                <span class="n">pci_user_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
                <span class="n">off</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
                <span class="n">size</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span><span class="p">];</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">pci_user_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span><span class="p">];</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">pci_user_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_user_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">off</span> <span class="o">-</span> <span class="n">init_off</span><span class="p">]);</span>
		<span class="n">off</span><span class="o">++</span><span class="p">;</span>
		<span class="o">--</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">read_vpd_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
	      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span>
		<span class="n">to_pci_dev</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="n">bin_attr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">bin_attr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">off</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">bin_attr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pci_read_vpd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">write_vpd_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
	       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span>
		<span class="n">to_pci_dev</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="n">bin_attr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">bin_attr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">off</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">bin_attr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pci_write_vpd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef HAVE_PCI_LEGACY</span>
<span class="cm">/**</span>
<span class="cm"> * pci_read_legacy_io - read byte(s) from legacy I/O port space</span>
<span class="cm"> * @filp: open sysfs file</span>
<span class="cm"> * @kobj: kobject corresponding to file to read from</span>
<span class="cm"> * @bin_attr: struct bin_attribute for this file</span>
<span class="cm"> * @buf: buffer to store results</span>
<span class="cm"> * @off: offset into legacy I/O port space</span>
<span class="cm"> * @count: number of bytes to read</span>
<span class="cm"> *</span>
<span class="cm"> * Reads 1, 2, or 4 bytes from legacy I/O port space using an arch specific</span>
<span class="cm"> * callback routine (pci_legacy_read).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">pci_read_legacy_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
		   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">to_pci_bus</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
                                                      <span class="k">struct</span> <span class="n">device</span><span class="p">,</span>
						      <span class="n">kobj</span><span class="p">));</span>

        <span class="cm">/* Only support 1, 2 or 4 byte accesses */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">pci_legacy_read</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_write_legacy_io - write byte(s) to legacy I/O port space</span>
<span class="cm"> * @filp: open sysfs file</span>
<span class="cm"> * @kobj: kobject corresponding to file to read from</span>
<span class="cm"> * @bin_attr: struct bin_attribute for this file</span>
<span class="cm"> * @buf: buffer containing value to be written</span>
<span class="cm"> * @off: offset into legacy I/O port space</span>
<span class="cm"> * @count: number of bytes to write</span>
<span class="cm"> *</span>
<span class="cm"> * Writes 1, 2, or 4 bytes from legacy I/O port space using an arch specific</span>
<span class="cm"> * callback routine (pci_legacy_write).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">pci_write_legacy_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
		    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">to_pci_bus</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
						      <span class="k">struct</span> <span class="n">device</span><span class="p">,</span>
						      <span class="n">kobj</span><span class="p">));</span>
        <span class="cm">/* Only support 1, 2 or 4 byte accesses */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">pci_legacy_write</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_mmap_legacy_mem - map legacy PCI memory into user memory space</span>
<span class="cm"> * @filp: open sysfs file</span>
<span class="cm"> * @kobj: kobject corresponding to device to be mapped</span>
<span class="cm"> * @attr: struct bin_attribute for this file</span>
<span class="cm"> * @vma: struct vm_area_struct passed to mmap</span>
<span class="cm"> *</span>
<span class="cm"> * Uses an arch specific callback, pci_mmap_legacy_mem_page_range, to mmap</span>
<span class="cm"> * legacy memory space (first meg of bus space) into application virtual</span>
<span class="cm"> * memory space.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pci_mmap_legacy_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
                    <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">to_pci_bus</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
                                                      <span class="k">struct</span> <span class="n">device</span><span class="p">,</span>
						      <span class="n">kobj</span><span class="p">));</span>

        <span class="k">return</span> <span class="n">pci_mmap_legacy_page_range</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">pci_mmap_mem</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_mmap_legacy_io - map legacy PCI IO into user memory space</span>
<span class="cm"> * @filp: open sysfs file</span>
<span class="cm"> * @kobj: kobject corresponding to device to be mapped</span>
<span class="cm"> * @attr: struct bin_attribute for this file</span>
<span class="cm"> * @vma: struct vm_area_struct passed to mmap</span>
<span class="cm"> *</span>
<span class="cm"> * Uses an arch specific callback, pci_mmap_legacy_io_page_range, to mmap</span>
<span class="cm"> * legacy IO space (first meg of bus space) into application virtual</span>
<span class="cm"> * memory space. Returns -ENOSYS if the operation isn&#39;t supported</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pci_mmap_legacy_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">to_pci_bus</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
                                                      <span class="k">struct</span> <span class="n">device</span><span class="p">,</span>
						      <span class="n">kobj</span><span class="p">));</span>

        <span class="k">return</span> <span class="n">pci_mmap_legacy_page_range</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">pci_mmap_io</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_adjust_legacy_attr - adjustment of legacy file attributes</span>
<span class="cm"> * @b: bus to create files under</span>
<span class="cm"> * @mmap_type: I/O port or memory</span>
<span class="cm"> *</span>
<span class="cm"> * Stub implementation. Can be overridden by arch if necessary.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__weak</span>
<span class="nf">pci_adjust_legacy_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pci_mmap_state</span> <span class="n">mmap_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_create_legacy_files - create legacy I/O port and memory files</span>
<span class="cm"> * @b: bus to create files under</span>
<span class="cm"> *</span>
<span class="cm"> * Some platforms allow access to legacy I/O port and ISA memory space on</span>
<span class="cm"> * a per-bus basis.  This routine creates the files and ties them into</span>
<span class="cm"> * their associated read, write and mmap files from pci-sysfs.c</span>
<span class="cm"> *</span>
<span class="cm"> * On error unwind, but don&#39;t propagate the error to the caller</span>
<span class="cm"> * as it is ok to set up the PCI bus without these files.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pci_create_legacy_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bin_attribute</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
			       <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">kzalloc_err</span><span class="p">;</span>

	<span class="n">sysfs_bin_attr_init</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span><span class="p">);</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;legacy_io&quot;</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">pci_read_legacy_io</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">pci_write_legacy_io</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span><span class="o">-&gt;</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">pci_mmap_legacy_io</span><span class="p">;</span>
	<span class="n">pci_adjust_legacy_attr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pci_mmap_io</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">device_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">legacy_io_err</span><span class="p">;</span>

	<span class="cm">/* Allocated above after the legacy_io struct */</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_mem</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sysfs_bin_attr_init</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_mem</span><span class="p">);</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_mem</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;legacy_mem&quot;</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_mem</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_mem</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_mem</span><span class="o">-&gt;</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">pci_mmap_legacy_mem</span><span class="p">;</span>
	<span class="n">pci_adjust_legacy_attr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pci_mmap_mem</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">device_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_mem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">legacy_mem_err</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">legacy_mem_err:</span>
	<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span><span class="p">);</span>
<span class="nl">legacy_io_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span><span class="p">);</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">kzalloc_err:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pci: warning: could not create legacy I/O port &quot;</span>
	       <span class="s">&quot;and ISA memory resources to sysfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pci_remove_legacy_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span><span class="p">);</span>
		<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_mem</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">legacy_io</span><span class="p">);</span> <span class="cm">/* both are allocated here */</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* HAVE_PCI_LEGACY */</span><span class="cp"></span>

<span class="cp">#ifdef HAVE_PCI_MMAP</span>

<span class="kt">int</span> <span class="nf">pci_mmap_fits</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">resno</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span>
		  <span class="k">enum</span> <span class="n">pci_mmap_api</span> <span class="n">mmap_api</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pci_start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">resno</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">resno</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pci_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">mmap_api</span> <span class="o">==</span> <span class="n">PCI_MMAP_PROCFS</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">resno</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">pci_start</span> <span class="o">&amp;&amp;</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">pci_start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&amp;&amp;</span>
			<span class="n">start</span> <span class="o">+</span> <span class="n">nr</span> <span class="o">&lt;=</span> <span class="n">pci_start</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_mmap_resource - map a PCI resource into user memory space</span>
<span class="cm"> * @kobj: kobject for mapping</span>
<span class="cm"> * @attr: struct bin_attribute for the file being mapped</span>
<span class="cm"> * @vma: struct vm_area_struct passed into the mmap</span>
<span class="cm"> * @write_combine: 1 for write_combine mapping</span>
<span class="cm"> *</span>
<span class="cm"> * Use the regular PCI mapping routines to map a PCI resource into userspace.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pci_mmap_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write_combine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
						       <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">pci_mmap_state</span> <span class="n">mmap_type</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_mmap_fits</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">PCI_MMAP_SYSFS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;process </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> tried to map 0x%08lx bytes &quot;</span>
			<span class="s">&quot;at page 0x%08lx on %s BAR %d (start 0x%16Lx, size 0x%16Lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="o">-</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">,</span>
			<span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* pci_mmap_page_range() expects the same kind of entry as coming</span>
<span class="cm">	 * from /proc/bus/pci/ which is a &quot;user visible&quot; value. If this is</span>
<span class="cm">	 * different from the resource itself, arch will do necessary fixup.</span>
<span class="cm">	 */</span>
	<span class="n">pci_resource_to_user</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">);</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">+=</span> <span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">mmap_type</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span> <span class="o">?</span> <span class="n">pci_mmap_mem</span> <span class="o">:</span> <span class="n">pci_mmap_io</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span> <span class="o">&amp;&amp;</span> <span class="n">iomem_is_exclusive</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pci_mmap_page_range</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">mmap_type</span><span class="p">,</span> <span class="n">write_combine</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pci_mmap_resource_uc</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_mmap_resource</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pci_mmap_resource_wc</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_mmap_resource</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">pci_resource_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">bool</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
						       <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">+=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&gt;</span> <span class="n">pci_resource_end</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">pci_resource_end</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span>
			<span class="n">outb</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span>
			<span class="n">outw</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span>
			<span class="n">outl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">pci_read_resource_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		     <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_resource_io</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">kobj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">pci_write_resource_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		      <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_resource_io</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">kobj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_remove_resource_files - cleanup resource files</span>
<span class="cm"> * @pdev: dev to cleanup</span>
<span class="cm"> *</span>
<span class="cm"> * If we created resource files for @pdev, remove them from sysfs and</span>
<span class="cm"> * free their resources.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pci_remove_resource_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">res_attr</span><span class="p">;</span>

		<span class="n">res_attr</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">res_attr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res_attr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">res_attr</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">res_attr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">res_attr</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">res_attr_wc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res_attr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">res_attr</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">res_attr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_create_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write_combine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* allocate attribute structure, piggyback attribute name */</span>
	<span class="kt">int</span> <span class="n">name_len</span> <span class="o">=</span> <span class="n">write_combine</span> <span class="o">?</span> <span class="mi">13</span> <span class="o">:</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">res_attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">res_attr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">res_attr</span><span class="p">)</span> <span class="o">+</span> <span class="n">name_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res_attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">res_attr_name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">res_attr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">sysfs_bin_attr_init</span><span class="p">(</span><span class="n">res_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write_combine</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">res_attr_wc</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_attr</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">res_attr_name</span><span class="p">,</span> <span class="s">&quot;resource%d_wc&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
			<span class="n">res_attr</span><span class="o">-&gt;</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">pci_mmap_resource_wc</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">res_attr</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_attr</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">res_attr_name</span><span class="p">,</span> <span class="s">&quot;resource%d&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
			<span class="n">res_attr</span><span class="o">-&gt;</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">pci_mmap_resource_uc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res_attr</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">pci_read_resource_io</span><span class="p">;</span>
			<span class="n">res_attr</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">pci_write_resource_io</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">res_attr_name</span><span class="p">;</span>
		<span class="n">res_attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
		<span class="n">res_attr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="n">res_attr</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">res_attr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_create_resource_files - create resource files in sysfs for @dev</span>
<span class="cm"> * @pdev: dev in question</span>
<span class="cm"> *</span>
<span class="cm"> * Walk the resources in @pdev creating files for each resource available.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_create_resource_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Expose the PCI resources from this device as files */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* skip empty resources */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_create_attr</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* for prefetchable resources, create a WC mappable file */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_PREFETCH</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_create_attr</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_remove_resource_files</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* !HAVE_PCI_MMAP */</span><span class="cp"></span>
<span class="kt">int</span> <span class="n">__weak</span> <span class="nf">pci_create_resource_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="n">__weak</span> <span class="nf">pci_remove_resource_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* HAVE_PCI_MMAP */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * pci_write_rom - used to enable access to the PCI ROM display</span>
<span class="cm"> * @filp: sysfs file</span>
<span class="cm"> * @kobj: kernel object handle</span>
<span class="cm"> * @bin_attr: struct bin_attribute for this file</span>
<span class="cm"> * @buf: user input</span>
<span class="cm"> * @off: file offset</span>
<span class="cm"> * @count: number of byte in input</span>
<span class="cm"> *</span>
<span class="cm"> * writing anything except 0 enables it</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">pci_write_rom</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
	      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">==</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">rom_attr_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">rom_attr_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_read_rom - read a PCI ROM</span>
<span class="cm"> * @filp: sysfs file</span>
<span class="cm"> * @kobj: kernel object handle</span>
<span class="cm"> * @bin_attr: struct bin_attribute for this file</span>
<span class="cm"> * @buf: where to put the data we read from the ROM</span>
<span class="cm"> * @off: file offset</span>
<span class="cm"> * @count: number of bytes to read</span>
<span class="cm"> *</span>
<span class="cm"> * Put @count bytes starting at @off into @buf from the ROM in the PCI</span>
<span class="cm"> * device corresponding to @kobj.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">pci_read_rom</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
	     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">));</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rom</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">rom_attr_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	
	<span class="n">rom</span> <span class="o">=</span> <span class="n">pci_map_rom</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>	<span class="cm">/* size starts out as PCI window size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rom</span> <span class="o">||</span> <span class="o">!</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">off</span><span class="p">;</span>
		
		<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">rom</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_unmap_rom</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rom</span><span class="p">);</span>
		
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">pci_config_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span>	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;config&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">PCI_CFG_SPACE_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">pci_read_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">pci_write_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">pcie_config_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span>	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;config&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">PCI_CFG_SPACE_EXP_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">pci_read_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">pci_write_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">__attribute__</span> <span class="p">((</span><span class="n">weak</span><span class="p">))</span> <span class="n">pcibios_add_platform_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">reset_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">result</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">pci_reset_function</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">reset_attr</span> <span class="o">=</span> <span class="n">__ATTR</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span> <span class="mo">0200</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">reset_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_create_capabilities_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>

	<span class="cm">/* If the device has VPD, try to expose it in sysfs. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">attr</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attr</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">sysfs_bin_attr_init</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;vpd&quot;</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">read_vpd_attr</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">write_vpd_attr</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Active State Power Management */</span>
	<span class="n">pcie_aspm_create_sysfs_dev_files</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_probe_reset_function</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reset_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">reset_fn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">pcie_aspm_remove_sysfs_dev_files</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vpd</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__must_check</span> <span class="nf">pci_create_sysfs_dev_files</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rom_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sysfs_initialized</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">cfg_size</span> <span class="o">&lt;</span> <span class="n">PCI_CFG_SPACE_EXP_SIZE</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_config_attr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcie_config_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_create_resource_files</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_config_file</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">))</span>
		<span class="n">rom_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">PCI_ROM_RESOURCE</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_ROM_SHADOW</span><span class="p">)</span>
		<span class="n">rom_size</span> <span class="o">=</span> <span class="mh">0x20000</span><span class="p">;</span>

	<span class="cm">/* If the device has a ROM, try to expose it in sysfs. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rom_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">attr</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_resource_files</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sysfs_bin_attr_init</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">rom_size</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rom&quot;</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">pci_read_rom</span><span class="p">;</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">pci_write_rom</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_resource_files</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">rom_attr</span> <span class="o">=</span> <span class="n">attr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_CLASS_DISPLAY_VGA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vga_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_rom_file</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* add platform-specific attributes */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pcibios_add_platform_entries</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_vga_file</span><span class="p">;</span>

	<span class="cm">/* add sysfs entries for various capabilities */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_create_capabilities_sysfs</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_vga_file</span><span class="p">;</span>

	<span class="n">pci_create_firmware_label_files</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_vga_file:</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_CLASS_DISPLAY_VGA</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vga_attr</span><span class="p">);</span>
<span class="nl">err_rom_file:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rom_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">rom_attr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">rom_attr</span><span class="p">);</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">rom_attr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">err_resource_files:</span>
	<span class="n">pci_remove_resource_files</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_config_file:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">cfg_size</span> <span class="o">&lt;</span> <span class="n">PCI_CFG_SPACE_EXP_SIZE</span><span class="p">)</span>
		<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_config_attr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcie_config_attr</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_remove_capabilities_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vpd</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pcie_aspm_remove_sysfs_dev_files</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">reset_fn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reset_attr</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">reset_fn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_remove_sysfs_dev_files - cleanup PCI specific sysfs files</span>
<span class="cm"> * @pdev: device whose entries we should free</span>
<span class="cm"> *</span>
<span class="cm"> * Cleanup when @pdev is removed from sysfs.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pci_remove_sysfs_dev_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rom_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sysfs_initialized</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pci_remove_capabilities_sysfs</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">cfg_size</span> <span class="o">&lt;</span> <span class="n">PCI_CFG_SPACE_EXP_SIZE</span><span class="p">)</span>
		<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_config_attr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcie_config_attr</span><span class="p">);</span>

	<span class="n">pci_remove_resource_files</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">))</span>
		<span class="n">rom_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">PCI_ROM_RESOURCE</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_ROM_SHADOW</span><span class="p">)</span>
		<span class="n">rom_size</span> <span class="o">=</span> <span class="mh">0x20000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rom_size</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">rom_attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">rom_attr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">rom_attr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_remove_firmware_label_files</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pci_sysfs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">sysfs_initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">for_each_pci_dev</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_create_sysfs_dev_files</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">late_initcall</span><span class="p">(</span><span class="n">pci_sysfs_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
