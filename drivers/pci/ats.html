<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pci › ats.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ats.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/pci/ats.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Intel Corporation, Yu Zhao &lt;yu.zhao@intel.com&gt;</span>
<span class="cm"> * Copyright (C) 2011 Advanced Micro Devices,</span>
<span class="cm"> *</span>
<span class="cm"> * PCI Express I/O Virtualization (IOV) support.</span>
<span class="cm"> *   Address Translation Service 1.0</span>
<span class="cm"> *   Page Request Interface added by Joerg Roedel &lt;joerg.roedel@amd.com&gt;</span>
<span class="cm"> *   PASID support added by Joerg Roedel &lt;joerg.roedel@amd.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/pci-ats.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;pci.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ats_alloc_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_ats</span> <span class="o">*</span><span class="n">ats</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_ATS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ats</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ats</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ats</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ats</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">ats</span><span class="o">-&gt;</span><span class="n">stu</span> <span class="o">=</span> <span class="n">ps</span><span class="p">;</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_ATS_CAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap</span><span class="p">);</span>
	<span class="n">ats</span><span class="o">-&gt;</span><span class="n">qdep</span> <span class="o">=</span> <span class="n">PCI_ATS_CAP_QDEP</span><span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="o">?</span> <span class="n">PCI_ATS_CAP_QDEP</span><span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="o">:</span>
					    <span class="n">PCI_ATS_MAX_QDEP</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span> <span class="o">=</span> <span class="n">ats</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ats_free_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_enable_ats - enable the ATS capability</span>
<span class="cm"> * @dev: the PCI device</span>
<span class="cm"> * @ps: the IOMMU page shift</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, or negative on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pci_enable_ats</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="o">-&gt;</span><span class="n">is_enabled</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps</span> <span class="o">&lt;</span> <span class="n">PCI_ATS_MIN_STU</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_physfn</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_virtfn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_physfn</span> <span class="o">?</span> <span class="n">dev</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">physfn</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sriov</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="o">-&gt;</span><span class="n">stu</span> <span class="o">==</span> <span class="n">ps</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ats_alloc_one</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="o">-&gt;</span><span class="n">ref_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sriov</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_physfn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ats_alloc_one</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">PCI_ATS_CTRL_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_virtfn</span><span class="p">)</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PCI_ATS_CTRL_STU</span><span class="p">(</span><span class="n">ps</span> <span class="o">-</span> <span class="n">PCI_ATS_MIN_STU</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_ATS_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="o">-&gt;</span><span class="n">is_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_enable_ats</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pci_disable_ats - disable the ATS capability</span>
<span class="cm"> * @dev: the PCI device</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pci_disable_ats</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="o">-&gt;</span><span class="n">is_enabled</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_ATS_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_ATS_CTRL_ENABLE</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_ATS_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="o">-&gt;</span><span class="n">is_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_physfn</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_virtfn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_physfn</span> <span class="o">?</span> <span class="n">dev</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">physfn</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sriov</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="o">-&gt;</span><span class="n">ref_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="o">-&gt;</span><span class="n">ref_cnt</span><span class="p">)</span>
			<span class="n">ats_free_one</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">sriov</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_physfn</span><span class="p">)</span>
		<span class="n">ats_free_one</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_disable_ats</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">pci_restore_ats_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_ats_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_ATS</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">PCI_ATS_CTRL_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_virtfn</span><span class="p">)</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PCI_ATS_CTRL_STU</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="o">-&gt;</span><span class="n">stu</span> <span class="o">-</span> <span class="n">PCI_ATS_MIN_STU</span><span class="p">);</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_ATS_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_restore_ats_state</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pci_ats_queue_depth - query the ATS Invalidate Queue Depth</span>
<span class="cm"> * @dev: the PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the queue depth on success, or negative on failure.</span>
<span class="cm"> *</span>
<span class="cm"> * The ATS spec uses 0 in the Invalidate Queue Depth field to</span>
<span class="cm"> * indicate that the function can accept 32 Invalidate Request.</span>
<span class="cm"> * But here we use the `real&#39; values (i.e. 1~32) for the Queue</span>
<span class="cm"> * Depth; and 0 indicates the function shares the Queue with</span>
<span class="cm"> * other functions (doesn&#39;t exclusively own a Queue).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pci_ats_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">is_virtfn</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ats</span><span class="o">-&gt;</span><span class="n">qdep</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_ATS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_ATS_CAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PCI_ATS_CAP_QDEP</span><span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="o">?</span> <span class="n">PCI_ATS_CAP_QDEP</span><span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="o">:</span>
				       <span class="n">PCI_ATS_MAX_QDEP</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_ats_queue_depth</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCI_PRI</span>
<span class="cm">/**</span>
<span class="cm"> * pci_enable_pri - Enable PRI capability</span>
<span class="cm"> * @ pdev: PCI device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value on error</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pci_enable_pri</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reqs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_requests</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_PRI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PRI_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PRI_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PCI_PRI_CTRL_ENABLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PCI_PRI_STATUS_STOPPED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PRI_MAX_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_requests</span><span class="p">);</span>
	<span class="n">reqs</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max_requests</span><span class="p">,</span> <span class="n">reqs</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PRI_ALLOC_REQ</span><span class="p">,</span> <span class="n">reqs</span><span class="p">);</span>

	<span class="n">control</span> <span class="o">|=</span> <span class="n">PCI_PRI_CTRL_ENABLE</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PRI_CTRL</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_enable_pri</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pci_disable_pri - Disable PRI capability</span>
<span class="cm"> * @pdev: PCI device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Only clears the enabled-bit, regardless of its former value</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pci_disable_pri</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_PRI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PRI_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_PRI_CTRL_ENABLE</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PRI_CTRL</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_disable_pri</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pci_pri_enabled - Checks if PRI capability is enabled</span>
<span class="cm"> * @pdev: PCI device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if PRI is enabled on the device, false otherwise</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">pci_pri_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_PRI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PRI_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PCI_PRI_CTRL_ENABLE</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_pri_enabled</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pci_reset_pri - Resets device&#39;s PRI state</span>
<span class="cm"> * @pdev: PCI device structure</span>
<span class="cm"> *</span>
<span class="cm"> * The PRI capability must be disabled before this function is called.</span>
<span class="cm"> * Returns 0 on success, negative value on error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pci_reset_pri</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_PRI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PRI_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PCI_PRI_CTRL_ENABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">|=</span> <span class="n">PCI_PRI_CTRL_RESET</span><span class="p">;</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PRI_CTRL</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_reset_pri</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pci_pri_stopped - Checks whether the PRI capability is stopped</span>
<span class="cm"> * @pdev: PCI device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if the PRI capability on the device is disabled and the</span>
<span class="cm"> * device has no outstanding PRI requests, false otherwise. The device</span>
<span class="cm"> * indicates this via the STOPPED bit in the status register of the</span>
<span class="cm"> * capability.</span>
<span class="cm"> * The device internal state can be cleared by resetting the PRI state</span>
<span class="cm"> * with pci_reset_pri(). This can force the capability into the STOPPED</span>
<span class="cm"> * state.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">pci_pri_stopped</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_PRI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PRI_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PRI_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PCI_PRI_CTRL_ENABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PCI_PRI_STATUS_STOPPED</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_pri_stopped</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pci_pri_status - Request PRI status of a device</span>
<span class="cm"> * @pdev: PCI device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns negative value on failure, status on success. The status can</span>
<span class="cm"> * be checked against status-bits. Supported bits are currently:</span>
<span class="cm"> * PCI_PRI_STATUS_RF:      Response failure</span>
<span class="cm"> * PCI_PRI_STATUS_UPRGI:   Unexpected Page Request Group Index</span>
<span class="cm"> * PCI_PRI_STATUS_STOPPED: PRI has stopped</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pci_pri_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">,</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_PRI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PRI_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PRI_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* Stopped bit is undefined when enable == 1, so clear it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PCI_PRI_CTRL_ENABLE</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_PRI_STATUS_STOPPED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_pri_status</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_PRI */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PCI_PASID</span>
<span class="cm">/**</span>
<span class="cm"> * pci_enable_pasid - Enable the PASID capability</span>
<span class="cm"> * @pdev: PCI device structure</span>
<span class="cm"> * @features: Features to enable</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value on error. This function checks</span>
<span class="cm"> * whether the features are actually supported by the device and returns</span>
<span class="cm"> * an error if not.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pci_enable_pasid</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">,</span> <span class="n">supported</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_PASID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PASID_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PASID_CAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">supported</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PCI_PASID_CTRL_ENABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">supported</span> <span class="o">&amp;=</span> <span class="n">PCI_PASID_CAP_EXEC</span> <span class="o">|</span> <span class="n">PCI_PASID_CAP_PRIV</span><span class="p">;</span>

	<span class="cm">/* User wants to enable anything unsupported? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">features</span><span class="p">)</span> <span class="o">!=</span> <span class="n">features</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">PCI_PASID_CTRL_ENABLE</span> <span class="o">|</span> <span class="n">features</span><span class="p">;</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PASID_CTRL</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_enable_pasid</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pci_disable_pasid - Disable the PASID capability</span>
<span class="cm"> * @pdev: PCI device structure</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pci_disable_pasid</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_PASID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PASID_CTRL</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_disable_pasid</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pci_pasid_features - Check which PASID features are supported</span>
<span class="cm"> * @pdev: PCI device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a negative value when no PASI capability is present.</span>
<span class="cm"> * Otherwise is returns a bitmask with supported features. Current</span>
<span class="cm"> * features reported are:</span>
<span class="cm"> * PCI_PASID_CAP_EXEC - Execute permission supported</span>
<span class="cm"> * PCI_PASID_CAP_PRIV - Priviledged mode supported</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pci_pasid_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">supported</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_PASID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PASID_CAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">supported</span><span class="p">);</span>

	<span class="n">supported</span> <span class="o">&amp;=</span> <span class="n">PCI_PASID_CAP_EXEC</span> <span class="o">|</span> <span class="n">PCI_PASID_CAP_PRIV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">supported</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_pasid_features</span><span class="p">);</span>

<span class="cp">#define PASID_NUMBER_SHIFT	8</span>
<span class="cp">#define PASID_NUMBER_MASK	(0x1f &lt;&lt; PASID_NUMBER_SHIFT)</span>
<span class="cm">/**</span>
<span class="cm"> * pci_max_pasid - Get maximum number of PASIDs supported by device</span>
<span class="cm"> * @pdev: PCI device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns negative value when PASID capability is not present.</span>
<span class="cm"> * Otherwise it returns the numer of supported PASIDs.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pci_max_pasids</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">supported</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_PASID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PASID_CAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">supported</span><span class="p">);</span>

	<span class="n">supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">PASID_NUMBER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PASID_NUMBER_SHIFT</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">supported</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_max_pasids</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_PASID */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
