<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pci › pci-acpi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pci-acpi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * File:	pci-acpi.c</span>
<span class="cm"> * Purpose:	Provide PCI support in ACPI</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005 David Shaohua Li &lt;shaohua.li@intel.com&gt;</span>
<span class="cm"> * Copyright (C) 2004 Tom Long Nguyen &lt;tom.l.nguyen@intel.com&gt;</span>
<span class="cm"> * Copyright (C) 2004 Intel Corp.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci-aspm.h&gt;</span>
<span class="cp">#include &lt;acpi/acpi.h&gt;</span>
<span class="cp">#include &lt;acpi/acpi_bus.h&gt;</span>

<span class="cp">#include &lt;linux/pci-acpi.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &quot;pci.h&quot;</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">pci_acpi_pm_notify_mtx</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pci_acpi_wake_bus - Wake-up notification handler for root buses.</span>
<span class="cm"> * @handle: ACPI handle of a device the notification is for.</span>
<span class="cm"> * @event: Type of the signaled event.</span>
<span class="cm"> * @context: PCI root bus to wake up devices on.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_acpi_wake_bus</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">ACPI_NOTIFY_DEVICE_WAKE</span> <span class="o">&amp;&amp;</span> <span class="n">pci_bus</span><span class="p">)</span>
		<span class="n">pci_pme_wakeup_bus</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_acpi_wake_dev - Wake-up notification handler for PCI devices.</span>
<span class="cm"> * @handle: ACPI handle of a device the notification is for.</span>
<span class="cm"> * @event: Type of the signaled event.</span>
<span class="cm"> * @context: PCI device object to wake up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_acpi_wake_dev</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">ACPI_NOTIFY_DEVICE_WAKE</span> <span class="o">||</span> <span class="o">!</span><span class="n">pci_dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">pm_cap</span> <span class="o">||</span> <span class="o">!</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">pme_support</span>
	     <span class="o">||</span> <span class="n">pci_check_pme_status</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">pme_poll</span><span class="p">)</span>
			<span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">pme_poll</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">pci_wakeup_event</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
		<span class="n">pm_runtime_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">)</span>
		<span class="n">pci_pme_wakeup_bus</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * add_pm_notifier - Register PM notifier for given ACPI device.</span>
<span class="cm"> * @dev: ACPI device to add the notifier for.</span>
<span class="cm"> * @context: PCI device or bus to check for PME status if an event is signaled.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: @dev need not be a run-wake or wake-up device to be a valid source of</span>
<span class="cm"> * PM wake-up events.  For example, wake-up events may be generated for bridges</span>
<span class="cm"> * if one of the devices below the bridge is signaling PME, even if the bridge</span>
<span class="cm"> * itself doesn&#39;t have a wake-up GPE associated with it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">add_pm_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">acpi_notify_handler</span> <span class="n">handler</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">AE_ALREADY_EXISTS</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_acpi_pm_notify_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">notifier_present</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_install_notify_handler</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
					     <span class="n">ACPI_SYSTEM_NOTIFY</span><span class="p">,</span>
					     <span class="n">handler</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">notifier_present</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_acpi_pm_notify_mtx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * remove_pm_notifier - Unregister PM notifier from given ACPI device.</span>
<span class="cm"> * @dev: ACPI device to remove the notifier from.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">remove_pm_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="n">acpi_notify_handler</span> <span class="n">handler</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">AE_BAD_PARAMETER</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_acpi_pm_notify_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">notifier_present</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_remove_notify_handler</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
					    <span class="n">ACPI_SYSTEM_NOTIFY</span><span class="p">,</span>
					    <span class="n">handler</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">notifier_present</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_acpi_pm_notify_mtx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_acpi_add_bus_pm_notifier - Register PM notifier for given PCI bus.</span>
<span class="cm"> * @dev: ACPI device to add the notifier for.</span>
<span class="cm"> * @pci_bus: PCI bus to walk checking for PME status if an event is signaled.</span>
<span class="cm"> */</span>
<span class="n">acpi_status</span> <span class="nf">pci_acpi_add_bus_pm_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">pci_bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">add_pm_notifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_acpi_wake_bus</span><span class="p">,</span> <span class="n">pci_bus</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_acpi_remove_bus_pm_notifier - Unregister PCI bus PM notifier.</span>
<span class="cm"> * @dev: ACPI device to remove the notifier from.</span>
<span class="cm"> */</span>
<span class="n">acpi_status</span> <span class="nf">pci_acpi_remove_bus_pm_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">remove_pm_notifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_acpi_wake_bus</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_acpi_add_pm_notifier - Register PM notifier for given PCI device.</span>
<span class="cm"> * @dev: ACPI device to add the notifier for.</span>
<span class="cm"> * @pci_dev: PCI device to check for the PME status if an event is signaled.</span>
<span class="cm"> */</span>
<span class="n">acpi_status</span> <span class="nf">pci_acpi_add_pm_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">add_pm_notifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_acpi_wake_dev</span><span class="p">,</span> <span class="n">pci_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_acpi_remove_pm_notifier - Unregister PCI device PM notifier.</span>
<span class="cm"> * @dev: ACPI device to remove the notifier from.</span>
<span class="cm"> */</span>
<span class="n">acpi_status</span> <span class="nf">pci_acpi_remove_pm_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">remove_pm_notifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_acpi_wake_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * _SxD returns the D-state with the highest power</span>
<span class="cm"> * (lowest D-state number) supported in the S-state &quot;x&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * If the devices does not have a _PRW</span>
<span class="cm"> * (Power Resources for Wake) supporting system wakeup from &quot;x&quot;</span>
<span class="cm"> * then the OS is free to choose a lower power (higher number</span>
<span class="cm"> * D-state) than the return value from _SxD.</span>
<span class="cm"> *</span>
<span class="cm"> * But if _PRW is enabled at S-state &quot;x&quot;, the OS</span>
<span class="cm"> * must not choose a power lower than _SxD --</span>
<span class="cm"> * unless the device has an _SxW method specifying</span>
<span class="cm"> * the lowest power (highest D-state number) the device</span>
<span class="cm"> * may enter while still able to wake the system.</span>
<span class="cm"> *</span>
<span class="cm"> * ie. depending on global OS policy:</span>
<span class="cm"> *</span>
<span class="cm"> * if (_PRW at S-state x)</span>
<span class="cm"> *	choose from highest power _SxD to lowest power _SxW</span>
<span class="cm"> * else // no _PRW at S-state x</span>
<span class="cm"> * 	choose highest power _SxD or any lower power</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">pci_power_t</span> <span class="nf">acpi_pci_choose_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">acpi_state</span><span class="p">;</span>

	<span class="n">acpi_state</span> <span class="o">=</span> <span class="n">acpi_pm_device_sleep_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_state</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCI_POWER_ERROR</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">acpi_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACPI_STATE_D0</span>:
		<span class="k">return</span> <span class="n">PCI_D0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_STATE_D1</span>:
		<span class="k">return</span> <span class="n">PCI_D1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_STATE_D2</span>:
		<span class="k">return</span> <span class="n">PCI_D2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_STATE_D3_HOT</span>:
		<span class="k">return</span> <span class="n">PCI_D3hot</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACPI_STATE_D3_COLD</span>:
		<span class="k">return</span> <span class="n">PCI_D3cold</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PCI_POWER_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">acpi_pci_power_manageable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_handle</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">DEVICE_ACPI_HANDLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">handle</span> <span class="o">?</span> <span class="n">acpi_bus_power_manageable</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_pci_set_power_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_power_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_handle</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">DEVICE_ACPI_HANDLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">acpi_handle</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">state_conv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">PCI_D0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ACPI_STATE_D0</span><span class="p">,</span>
		<span class="p">[</span><span class="n">PCI_D1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ACPI_STATE_D1</span><span class="p">,</span>
		<span class="p">[</span><span class="n">PCI_D2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ACPI_STATE_D2</span><span class="p">,</span>
		<span class="p">[</span><span class="n">PCI_D3hot</span><span class="p">]</span> <span class="o">=</span> <span class="n">ACPI_STATE_D3</span><span class="p">,</span>
		<span class="p">[</span><span class="n">PCI_D3cold</span><span class="p">]</span> <span class="o">=</span> <span class="n">ACPI_STATE_D3</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* If the ACPI device has _EJ0, ignore the device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span> <span class="o">||</span> <span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_EJ0&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_D0</span>:
	<span class="k">case</span> <span class="n">PCI_D1</span>:
	<span class="k">case</span> <span class="n">PCI_D2</span>:
	<span class="k">case</span> <span class="n">PCI_D3hot</span>:
	<span class="k">case</span> <span class="n">PCI_D3cold</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">acpi_bus_set_power</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">state_conv</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;power state changed by ACPI to D%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">acpi_pci_can_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_handle</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">DEVICE_ACPI_HANDLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">handle</span> <span class="o">?</span> <span class="n">acpi_bus_can_wakeup</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_pci_propagate_wakeup_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_pm_device_sleep_wake</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">enable</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We have reached the root bus. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">)</span>
		<span class="n">acpi_pm_device_sleep_wake</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_pci_sleep_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_pci_can_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">acpi_pm_device_sleep_wake</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="n">acpi_pci_propagate_wakeup_enable</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_pci_propagate_run_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">pme_interrupt</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_pm_device_run_wake</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">enable</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We have reached the root bus. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">)</span>
		<span class="n">acpi_pm_device_run_wake</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_pci_run_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pme_interrupt</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_pm_device_run_wake</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">enable</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">acpi_pci_propagate_run_wake</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_platform_pm_ops</span> <span class="n">acpi_pci_platform_pm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">is_manageable</span> <span class="o">=</span> <span class="n">acpi_pci_power_manageable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_state</span> <span class="o">=</span> <span class="n">acpi_pci_set_power_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">choose_state</span> <span class="o">=</span> <span class="n">acpi_pci_choose_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_wakeup</span> <span class="o">=</span> <span class="n">acpi_pci_can_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep_wake</span> <span class="o">=</span> <span class="n">acpi_pci_sleep_wake</span><span class="p">,</span>
	<span class="p">.</span><span class="n">run_wake</span> <span class="o">=</span> <span class="n">acpi_pci_run_wake</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ACPI bus type */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_pci_find_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">acpi_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span> <span class="n">pci_dev</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">addr</span><span class="p">;</span>

	<span class="n">pci_dev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Please ref to ACPI spec for the syntax of _ADR */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">acpi_get_child</span><span class="p">(</span><span class="n">DEVICE_ACPI_HANDLE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">handle</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_pci_find_root_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">acpi_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seg</span><span class="p">,</span> <span class="n">bus</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The string should be the same as root bridge&#39;s name</span>
<span class="cm">	 * Please look at &#39;pci_scan_bus_parented&#39;</span>
<span class="cm">	 */</span>
	<span class="n">num</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="s">&quot;pci%04x:%02x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">acpi_get_pci_rootbridge_handle</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">handle</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">acpi_bus_type</span> <span class="n">acpi_pci_bus</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci_bus_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">find_device</span> <span class="o">=</span> <span class="n">acpi_pci_find_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">find_bridge</span> <span class="o">=</span> <span class="n">acpi_pci_find_root_bridge</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">acpi_pci_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">boot_flags</span> <span class="o">&amp;</span> <span class="n">ACPI_FADT_NO_MSI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;ACPI FADT declares the system doesn&#39;t support MSI, so disable it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_no_msi</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_gbl_FADT</span><span class="p">.</span><span class="n">boot_flags</span> <span class="o">&amp;</span> <span class="n">ACPI_FADT_NO_ASPM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="s">&quot;ACPI FADT declares the system doesn&#39;t support PCIe ASPM, so disable it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pcie_no_aspm</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_acpi_bus_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_pci_bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_set_platform_pm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_pci_platform_pm</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">arch_initcall</span><span class="p">(</span><span class="n">acpi_pci_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
