<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pci › hotplug › cpqphp_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cpqphp_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Compaq Hot Plug Controller Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1995,2001 Compaq Computer Corporation</span>
<span class="cm"> * Copyright (C) 2001 Greg Kroah-Hartman &lt;greg@kroah.com&gt;</span>
<span class="cm"> * Copyright (C) 2001 IBM Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> * your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or</span>
<span class="cm"> * NON INFRINGEMENT.  See the GNU General Public License for more</span>
<span class="cm"> * details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Send feedback to &lt;greg@kroah.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Jan 12, 2003 -	Added 66/100/133MHz PCI-X support,</span>
<span class="cm"> *			Torben Mathiasen &lt;torben.mathiasen@hp.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pci_hotplug.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;cpqphp.h&quot;</span>
<span class="cp">#include &quot;cpqphp_nvram.h&quot;</span>


<span class="cm">/* Global variables */</span>
<span class="kt">int</span> <span class="n">cpqhp_debug</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">cpqhp_legacy_mode</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">cpqhp_ctrl_list</span><span class="p">;</span>	<span class="cm">/* = NULL */</span>
<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="k">struct</span> <span class="n">irq_routing_table</span> <span class="o">*</span><span class="n">cpqhp_routing_table</span><span class="p">;</span>

<span class="cm">/* local variables */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">smbios_table</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">smbios_start</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cpqhp_rom_start</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">power_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">initialized</span><span class="p">;</span>

<span class="cp">#define DRIVER_VERSION	&quot;0.9.8&quot;</span>
<span class="cp">#define DRIVER_AUTHOR	&quot;Dan Zink &lt;dan.zink@compaq.com&gt;, Greg Kroah-Hartman &lt;greg@kroah.com&gt;&quot;</span>
<span class="cp">#define DRIVER_DESC	&quot;Compaq Hot Plug PCI Controller Driver&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">power_mode</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">power_mode</span><span class="p">,</span> <span class="s">&quot;Power mode enabled or not&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debugging mode enabled or not&quot;</span><span class="p">);</span>

<span class="cp">#define CPQHPC_MODULE_MINOR 208</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_slot64bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">p_sm_slot</span> <span class="o">+</span> <span class="n">SMBIOS_SLOT_WIDTH</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_slot66mhz</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">p_sm_slot</span> <span class="o">+</span> <span class="n">SMBIOS_SLOT_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0E</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * detect_SMBIOS_pointer - find the System Management BIOS Table in mem region.</span>
<span class="cm"> * @begin: begin pointer for region to be scanned.</span>
<span class="cm"> * @end: end pointer for region to be scanned.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to the head of the SMBIOS tables (or %NULL).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="nf">detect_SMBIOS_pointer</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">begin</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">endp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">temp2</span><span class="p">,</span> <span class="n">temp3</span><span class="p">,</span> <span class="n">temp4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">endp</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">fp</span> <span class="o">=</span> <span class="n">begin</span><span class="p">;</span> <span class="n">fp</span> <span class="o">&lt;=</span> <span class="n">endp</span><span class="p">;</span> <span class="n">fp</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp1</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="n">temp2</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">temp3</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">temp4</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">fp</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp1</span> <span class="o">==</span> <span class="sc">&#39;_&#39;</span> <span class="o">&amp;&amp;</span>
		    <span class="n">temp2</span> <span class="o">==</span> <span class="sc">&#39;S&#39;</span> <span class="o">&amp;&amp;</span>
		    <span class="n">temp3</span> <span class="o">==</span> <span class="sc">&#39;M&#39;</span> <span class="o">&amp;&amp;</span>
		    <span class="n">temp4</span> <span class="o">==</span> <span class="sc">&#39;_&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Discovered SMBIOS Entry point at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * init_SERR - Initializes the per slot SERR generation.</span>
<span class="cm"> * @ctrl: controller to use</span>
<span class="cm"> *</span>
<span class="cm"> * For unexpected switch opens</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_SERR</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tempdword</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">number_of_slots</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">physical_slot</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">tempdword</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">first_slot</span><span class="p">;</span>

	<span class="n">number_of_slots</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_MASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="cm">/* Loop through slots */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">number_of_slots</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">physical_slot</span> <span class="o">=</span> <span class="n">tempdword</span><span class="p">;</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_SERR</span><span class="p">);</span>
		<span class="n">tempdword</span><span class="o">++</span><span class="p">;</span>
		<span class="n">number_of_slots</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_cpqhp_routing_table</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">cpqhp_routing_table</span> <span class="o">=</span> <span class="n">pcibios_get_irq_routing_table</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpqhp_routing_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">cpqhp_routing_table_length</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cpqhp_routing_table</span><span class="p">);</span>
		<span class="n">cpqhp_routing_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* nice debugging output */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_print_IRQ_route</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tbus</span><span class="p">,</span> <span class="n">tdevice</span><span class="p">,</span> <span class="n">tslot</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">cpqhp_routing_table_length</span><span class="p">();</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bus dev func slot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">loop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tbus</span> <span class="o">=</span> <span class="n">cpqhp_routing_table</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">tdevice</span> <span class="o">=</span> <span class="n">cpqhp_routing_table</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">devfn</span><span class="p">;</span>
		<span class="n">tslot</span> <span class="o">=</span> <span class="n">cpqhp_routing_table</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">slot</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tbus</span><span class="p">,</span> <span class="n">tdevice</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">tdevice</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">,</span> <span class="n">tslot</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * get_subsequent_smbios_entry: get the next entry from bios table.</span>
<span class="cm"> * @smbios_start: where to start in the SMBIOS table</span>
<span class="cm"> * @smbios_table: location of the SMBIOS table</span>
<span class="cm"> * @curr: %NULL or pointer to previously returned structure</span>
<span class="cm"> *</span>
<span class="cm"> * Gets the first entry if previous == NULL;</span>
<span class="cm"> * otherwise, returns the next entry.</span>
<span class="cm"> * Uses global SMBIOS Table pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to an SMBIOS structure or NULL if none found.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">get_subsequent_smbios_entry</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">smbios_start</span><span class="p">,</span>
						<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">smbios_table</span><span class="p">,</span>
						<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">curr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">bail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">previous_byte</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p_temp</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p_max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smbios_table</span> <span class="o">||</span> <span class="o">!</span><span class="n">curr</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* set p_max to the end of the table */</span>
	<span class="n">p_max</span> <span class="o">=</span> <span class="n">smbios_start</span> <span class="o">+</span> <span class="n">readw</span><span class="p">(</span><span class="n">smbios_table</span> <span class="o">+</span> <span class="n">ST_LENGTH</span><span class="p">);</span>

	<span class="n">p_temp</span> <span class="o">=</span> <span class="n">curr</span><span class="p">;</span>
	<span class="n">p_temp</span> <span class="o">+=</span> <span class="n">readb</span><span class="p">(</span><span class="n">curr</span> <span class="o">+</span> <span class="n">SMBIOS_GENERIC_LENGTH</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">p_temp</span> <span class="o">&lt;</span> <span class="n">p_max</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bail</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Look for the double NULL terminator</span>
<span class="cm">		 * The first condition is the previous byte</span>
<span class="cm">		 * and the second is the curr</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">previous_byte</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">p_temp</span><span class="p">)))</span>
			<span class="n">bail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">previous_byte</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">p_temp</span><span class="p">);</span>
		<span class="n">p_temp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_temp</span> <span class="o">&lt;</span> <span class="n">p_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">p_temp</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * get_SMBIOS_entry - return the requested SMBIOS entry or %NULL</span>
<span class="cm"> * @smbios_start: where to start in the SMBIOS table</span>
<span class="cm"> * @smbios_table: location of the SMBIOS table</span>
<span class="cm"> * @type: SMBIOS structure type to be returned</span>
<span class="cm"> * @previous: %NULL or pointer to previously returned structure</span>
<span class="cm"> *</span>
<span class="cm"> * Gets the first entry of the specified type if previous == %NULL;</span>
<span class="cm"> * Otherwise, returns the next entry of the given type.</span>
<span class="cm"> * Uses global SMBIOS Table pointer.</span>
<span class="cm"> * Uses get_subsequent_smbios_entry.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to an SMBIOS structure or %NULL if none found.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">get_SMBIOS_entry</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">smbios_start</span><span class="p">,</span>
					<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">smbios_table</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">type</span><span class="p">,</span>
					<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">previous</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smbios_table</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">previous</span><span class="p">)</span>
		<span class="n">previous</span> <span class="o">=</span> <span class="n">smbios_start</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">previous</span> <span class="o">=</span> <span class="n">get_subsequent_smbios_entry</span><span class="p">(</span><span class="n">smbios_start</span><span class="p">,</span>
					<span class="n">smbios_table</span><span class="p">,</span> <span class="n">previous</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">previous</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">previous</span> <span class="o">+</span> <span class="n">SMBIOS_GENERIC_TYPE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="n">previous</span> <span class="o">=</span> <span class="n">get_subsequent_smbios_entry</span><span class="p">(</span><span class="n">smbios_start</span><span class="p">,</span>
						<span class="n">smbios_table</span><span class="p">,</span> <span class="n">previous</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">previous</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - physical_slot = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot_name</span><span class="p">(</span><span class="n">slot</span><span class="p">));</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">hotplug_slot</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_slot_cleanup</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">old_slot</span><span class="p">,</span> <span class="o">*</span><span class="n">next_slot</span><span class="p">;</span>

	<span class="n">old_slot</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">old_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* memory will be freed by the release_slot callback */</span>
		<span class="n">next_slot</span> <span class="o">=</span> <span class="n">old_slot</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">pci_hp_deregister</span> <span class="p">(</span><span class="n">old_slot</span><span class="o">-&gt;</span><span class="n">hotplug_slot</span><span class="p">);</span>
		<span class="n">old_slot</span> <span class="o">=</span> <span class="n">next_slot</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cpqhp_remove_debugfs_files</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* Free IRQ associated with hot plug device */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="cm">/* Unmap the memory */</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span><span class="p">);</span>
	<span class="cm">/* Finally reclaim PCI mem */</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			   <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * get_slot_mapping - determine logical slot mapping for PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * Won&#39;t work for more than one PCI-PCI bridge in a slot.</span>
<span class="cm"> *</span>
<span class="cm"> * @bus_num - bus number of PCI device</span>
<span class="cm"> * @dev_num - device number of PCI device</span>
<span class="cm"> * @slot - Pointer to u8 where slot number will	be returned</span>
<span class="cm"> *</span>
<span class="cm"> * Output:	SUCCESS or FAILURE</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">get_slot_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bus_num</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dev_num</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">work</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">loop</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">tbus</span><span class="p">,</span> <span class="n">tdevice</span><span class="p">,</span> <span class="n">tslot</span><span class="p">,</span> <span class="n">bridgeSlot</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: %p, %d, %d, %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">bus_num</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="n">bridgeSlot</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">cpqhp_routing_table_length</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">loop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tbus</span> <span class="o">=</span> <span class="n">cpqhp_routing_table</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">tdevice</span> <span class="o">=</span> <span class="n">cpqhp_routing_table</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">devfn</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">tslot</span> <span class="o">=</span> <span class="n">cpqhp_routing_table</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">slot</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tbus</span> <span class="o">==</span> <span class="n">bus_num</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tdevice</span> <span class="o">==</span> <span class="n">dev_num</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">tslot</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Did not get a match on the target PCI device. Check</span>
<span class="cm">			 * if the current IRQ table entry is a PCI-to-PCI</span>
<span class="cm">			 * bridge device.  If so, and it&#39;s secondary bus</span>
<span class="cm">			 * matches the bus number for the target device, I need</span>
<span class="cm">			 * to save the bridge&#39;s slot number.  If I can not find</span>
<span class="cm">			 * an entry for the target device, I will have to</span>
<span class="cm">			 * assume it&#39;s on the other side of the bridge, and</span>
<span class="cm">			 * assign it the bridge&#39;s slot.</span>
<span class="cm">			 */</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">tbus</span><span class="p">;</span>
			<span class="n">pci_bus_read_config_dword</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">tdevice</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
						<span class="n">PCI_CLASS_REVISION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">work</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_TO_PCI_BRIDGE_CLASS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_bus_read_config_dword</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span>
							<span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">tdevice</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
							<span class="n">PCI_PRIMARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>See if bridge's secondary bus matches target bus.</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span> <span class="p">(((</span><span class="n">work</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">bus_num</span><span class="p">)</span>
					<span class="n">bridgeSlot</span> <span class="o">=</span> <span class="n">tslot</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* If we got here, we didn&#39;t find an entry in the IRQ mapping table for</span>
<span class="cm">	 * the target PCI device.  If we did determine that the target device</span>
<span class="cm">	 * is on the other side of a PCI-to-PCI bridge, return the slot number</span>
<span class="cm">	 * for the bridge.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bridgeSlot</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">bridgeSlot</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Couldn&#39;t find an entry in the routing table for this PCI device */</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * cpqhp_set_attention_status - Turns the Amber LED for a slot on or off</span>
<span class="cm"> * @ctrl: struct controller to use</span>
<span class="cm"> * @func: PCI device/function info</span>
<span class="cm"> * @status: LED control flag: 1 = LED on, 0 = LED off</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cpqhp_set_attention_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">hp_slot</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">hp_slot</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">-</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">;</span>

	<span class="cm">/* Wait for exclusive access to hardware */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">amber_LED_on</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">amber_LED_off</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Done with exclusive hardware access */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* Wait for SOBS to be unset */</span>
	<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* Done with exclusive hardware access */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * set_attention_status - Turns the Amber LED for a slot on or off</span>
<span class="cm"> * @hotplug_slot: slot to change LED on</span>
<span class="cm"> * @status: LED control flag</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_attention_status</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">slot_func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bus</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">devfn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - physical_slot = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot_name</span><span class="p">(</span><span class="n">slot</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpqhp_get_bus_dev</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devfn</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">devfn</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">function</span> <span class="o">=</span> <span class="n">devfn</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bus, dev, fn = %d, %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>

	<span class="n">slot_func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot_func</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cpqhp_set_attention_status</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">slot_func</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_SI</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">slot_func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bus</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">devfn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - physical_slot = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot_name</span><span class="p">(</span><span class="n">slot</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpqhp_get_bus_dev</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devfn</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">devfn</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">function</span> <span class="o">=</span> <span class="n">devfn</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bus, dev, fn = %d, %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>

	<span class="n">slot_func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot_func</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">slot_func</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
	<span class="n">slot_func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">slot_func</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span><span class="p">;</span>
	<span class="n">slot_func</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;board_added(%p, %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot_func</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cpqhp_process_SI</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">slot_func</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_SS</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">slot_func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bus</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">devfn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - physical_slot = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot_name</span><span class="p">(</span><span class="n">slot</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpqhp_get_bus_dev</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devfn</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">devfn</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">function</span> <span class="o">=</span> <span class="n">devfn</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bus, dev, fn = %d, %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>

	<span class="n">slot_func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot_func</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;In %s, slot_func = %p, ctrl = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot_func</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cpqhp_process_SS</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">slot_func</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hardware_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - physical_slot = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot_name</span><span class="p">(</span><span class="n">slot</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">cpqhp_hardware_test</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_power_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - physical_slot = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot_name</span><span class="p">(</span><span class="n">slot</span><span class="p">));</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">get_slot_enabled</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_attention_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - physical_slot = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot_name</span><span class="p">(</span><span class="n">slot</span><span class="p">));</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">cpq_get_attention_status</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_latch_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - physical_slot = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot_name</span><span class="p">(</span><span class="n">slot</span><span class="p">));</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">cpq_get_latch_status</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_adapter_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s - physical_slot = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot_name</span><span class="p">(</span><span class="n">slot</span><span class="p">));</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">get_presence_status</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hotplug_slot_ops</span> <span class="n">cpqphp_hotplug_slot_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_attention_status</span> <span class="o">=</span>	<span class="n">set_attention_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_slot</span> <span class="o">=</span>		<span class="n">process_SI</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_slot</span> <span class="o">=</span>		<span class="n">process_SS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hardware_test</span> <span class="o">=</span>	<span class="n">hardware_test</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_power_status</span> <span class="o">=</span>	<span class="n">get_power_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_attention_status</span> <span class="o">=</span>	<span class="n">get_attention_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_latch_status</span> <span class="o">=</span>	<span class="n">get_latch_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_adapter_status</span> <span class="o">=</span>	<span class="n">get_adapter_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define SLOT_NAME_SIZE 10</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_slot_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span>
			<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">smbios_start</span><span class="p">,</span>
			<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">smbios_table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hotplug_slot_info</span> <span class="o">*</span><span class="n">hotplug_slot_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">number_of_slots</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">slot_device</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">slot_number</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl_slot</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tempdword</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">SLOT_NAME_SIZE</span><span class="p">];</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">slot_entry</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">tempdword</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">INT_INPUT_CLEAR</span><span class="p">);</span>

	<span class="n">number_of_slots</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_MASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">slot_device</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">slot_number</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">first_slot</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">number_of_slots</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">slot</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">hotplug_slot</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">hotplug_slot</span><span class="p">)),</span>
						<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">hotplug_slot</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_slot</span><span class="p">;</span>
		<span class="n">hotplug_slot</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">hotplug_slot</span><span class="p">;</span>

		<span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">)),</span>
							<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_hpslot</span><span class="p">;</span>
		<span class="n">hotplug_slot_info</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>

		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">slot_device</span><span class="p">;</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">slot_number</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;slot-&gt;number = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="n">slot_entry</span> <span class="o">=</span> <span class="n">get_SMBIOS_entry</span><span class="p">(</span><span class="n">smbios_start</span><span class="p">,</span> <span class="n">smbios_table</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
					<span class="n">slot_entry</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">slot_entry</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">slot_entry</span> <span class="o">+</span> <span class="n">SMBIOS_SLOT_NUMBER</span><span class="p">)</span> <span class="o">!=</span>
				<span class="n">slot</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">slot_entry</span> <span class="o">=</span> <span class="n">get_SMBIOS_entry</span><span class="p">(</span><span class="n">smbios_start</span><span class="p">,</span>
						<span class="n">smbios_table</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">slot_entry</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">p_sm_slot</span> <span class="o">=</span> <span class="n">slot_entry</span><span class="p">;</span>

		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">task_event</span><span class="p">);</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">task_event</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">task_event</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">cpqhp_pushbutton_thread</span><span class="p">;</span>

		<span class="cm">/*FIXME: these capabilities aren&#39;t used but if they are</span>
<span class="cm">		 *	 they need to be correctly implemented</span>
<span class="cm">		 */</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span> <span class="n">PCISLOT_REPLACE_SUPPORTED</span><span class="p">;</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span> <span class="n">PCISLOT_INTERLOCK_SUPPORTED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_slot64bit</span><span class="p">(</span><span class="n">slot</span><span class="p">))</span>
			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span> <span class="n">PCISLOT_64_BIT_SUPPORTED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_slot66mhz</span><span class="p">(</span><span class="n">slot</span><span class="p">))</span>
			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span> <span class="n">PCISLOT_66_MHZ_SUPPORTED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">==</span> <span class="n">PCI_SPEED_66MHz</span><span class="p">)</span>
			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span> <span class="n">PCISLOT_66_MHZ_OPERATION</span><span class="p">;</span>

		<span class="n">ctrl_slot</span> <span class="o">=</span>
			<span class="n">slot_device</span> <span class="o">-</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

		<span class="cm">/* Check presence */</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span>
			<span class="p">((((</span><span class="o">~</span><span class="n">tempdword</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">((</span><span class="o">~</span><span class="n">tempdword</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">ctrl_slot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="cm">/* Check the switch state */</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span>
			<span class="p">((</span><span class="o">~</span><span class="n">tempdword</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ctrl_slot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="cm">/* Check the slot enable */</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span>
			<span class="p">((</span><span class="n">read_slot_enable</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ctrl_slot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">;</span>

		<span class="cm">/* register this slot with the hotplug pci core */</span>
		<span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">release_slot</span><span class="p">;</span>
		<span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">SLOT_NAME_SIZE</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpqphp_hotplug_slot_ops</span><span class="p">;</span>

		<span class="n">hotplug_slot_info</span><span class="o">-&gt;</span><span class="n">power_status</span> <span class="o">=</span> <span class="n">get_slot_enabled</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">hotplug_slot_info</span><span class="o">-&gt;</span><span class="n">attention_status</span> <span class="o">=</span>
			<span class="n">cpq_get_attention_status</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">hotplug_slot_info</span><span class="o">-&gt;</span><span class="n">latch_status</span> <span class="o">=</span>
			<span class="n">cpq_get_latch_status</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">hotplug_slot_info</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">=</span>
			<span class="n">get_presence_status</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;registering bus %d, dev %d, number %d, &quot;</span>
				<span class="s">&quot;ctrl-&gt;slot_device_offset %d, slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">slot</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				<span class="n">slot</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">,</span>
				<span class="n">slot_number</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">pci_hp_register</span><span class="p">(</span><span class="n">hotplug_slot</span><span class="p">,</span>
					 <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span>
					 <span class="n">slot</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
					 <span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;pci_hp_register failed with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error_info</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>

		<span class="n">number_of_slots</span><span class="o">--</span><span class="p">;</span>
		<span class="n">slot_device</span><span class="o">++</span><span class="p">;</span>
		<span class="n">slot_number</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error_info:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hotplug_slot_info</span><span class="p">);</span>
<span class="nl">error_hpslot:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hotplug_slot</span><span class="p">);</span>
<span class="nl">error_slot:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">one_time_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initialized</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">power_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">init_cpqhp_routing_table</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpqhp_debug</span><span class="p">)</span>
		<span class="n">pci_print_IRQ_route</span><span class="p">();</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Initialize + Start the notification mechanism </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">cpqhp_event_start_thread</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Initialize slot lists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* FIXME: We also need to hook the NMI handler eventually.</span>
<span class="cm">	 * this also needs to be worked with Christoph</span>
<span class="cm">	 * register_NMI_handler();</span>
<span class="cm">	 */</span>
	<span class="cm">/* Map rom address */</span>
	<span class="n">cpqhp_rom_start</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">ROM_PHY_ADDR</span><span class="p">,</span> <span class="n">ROM_PHY_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpqhp_rom_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;Could not ioremap memory region for ROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now, map the int15 entry point if we are on compaq specific</span>
<span class="cm">	 * hardware</span>
<span class="cm">	 */</span>
	<span class="n">compaq_nvram_init</span><span class="p">(</span><span class="n">cpqhp_rom_start</span><span class="p">);</span>

	<span class="cm">/* Map smbios table entry point structure */</span>
	<span class="n">smbios_table</span> <span class="o">=</span> <span class="n">detect_SMBIOS_pointer</span><span class="p">(</span><span class="n">cpqhp_rom_start</span><span class="p">,</span>
					<span class="n">cpqhp_rom_start</span> <span class="o">+</span> <span class="n">ROM_PHY_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smbios_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;Could not find the SMBIOS pointer in memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_rom_start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smbios_start</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">smbios_table</span> <span class="o">+</span> <span class="n">ST_ADDRESS</span><span class="p">),</span>
					<span class="n">readw</span><span class="p">(</span><span class="n">smbios_table</span> <span class="o">+</span> <span class="n">ST_LENGTH</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smbios_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;Could not ioremap memory region taken from SMBIOS values</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_smbios_start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">error_smbios_start:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">smbios_start</span><span class="p">);</span>
<span class="nl">error_rom_start:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">cpqhp_rom_start</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpqhpc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">num_of_slots</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hp_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bus_cap</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temp_word</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vendor_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subsystem_vid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subsystem_deviceid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MY_NAME</span> <span class="s">&quot;: cannot enable PCI device %s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;the device is not a bridge, &quot;</span>
				<span class="s">&quot;skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Need to read VID early b/c it&#39;s used to differentiate CPQ and INTC</span>
<span class="cm">	 * discovery</span>
<span class="cm">	 */</span>
	<span class="n">vendor_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vendor_id</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">vendor_id</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="n">msg_HPC_non_compaq_or_intel</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable_device</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Vendor ID: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vendor_id</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;revision: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vendor_id</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="n">msg_HPC_rev_error</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for the proper subsystem ID&#39;s</span>
<span class="cm">	 * Intel uses a different SSID programming model than Compaq.</span>
<span class="cm">	 * For Intel, each SSID bit identifies a PHP capability.</span>
<span class="cm">	 * Also Intel HPC&#39;s may have RID=0.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vendor_id</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="n">msg_HPC_not_supported</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: This code can be made to support non-Compaq or Intel</span>
<span class="cm">	 * subsystem IDs</span>
<span class="cm">	 */</span>
	<span class="n">subsystem_vid</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Subsystem Vendor ID: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">subsystem_vid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">subsystem_vid</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">subsystem_vid</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="n">msg_HPC_non_compaq_or_intel</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s : out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">subsystem_deviceid</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>

	<span class="n">info</span><span class="p">(</span><span class="s">&quot;Hot Plug Subsystem Device ID: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">subsystem_deviceid</span><span class="p">);</span>

	<span class="cm">/* Set Vendor ID, so it can be accessed later from other</span>
<span class="cm">	 * functions</span>
<span class="cm">	 */</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="n">vendor_id</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">subsystem_vid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_VENDOR_ID_COMPAQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* CIOBX */</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">push_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_switch_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">push_button</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_config_space</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">defeature_PHP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_speed_capability</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus_cap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus_cap</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bus max supports 133MHz PCI-X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">PCI_SPEED_133MHz_PCIX</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus_cap</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bus max supports 100MHz PCI-X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">PCI_SPEED_100MHz_PCIX</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus_cap</span> <span class="o">&amp;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bus max supports 66MHz PCI-X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">PCI_SPEED_66MHz_PCIX</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus_cap</span> <span class="o">&amp;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bus max supports 66MHz PCI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">PCI_SPEED_66MHz</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">subsystem_deviceid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PCI_SUB_HPC_ID</span>:
			<span class="cm">/* Original 6500/7000 implementation */</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_switch_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">PCI_SPEED_33MHz</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">push_button</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_config_space</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">defeature_PHP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_speed_capability</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCI_SUB_HPC_ID2</span>:
			<span class="cm">/* First Pushbutton implementation */</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">push_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_switch_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">PCI_SPEED_33MHz</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">push_button</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_config_space</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">defeature_PHP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_speed_capability</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCI_SUB_HPC_ID_INTC</span>:
			<span class="cm">/* Third party (6500/7000) */</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_switch_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">PCI_SPEED_33MHz</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">push_button</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_config_space</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">defeature_PHP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_speed_capability</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCI_SUB_HPC_ID3</span>:
			<span class="cm">/* First 66 Mhz implementation */</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">push_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_switch_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">PCI_SPEED_66MHz</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">push_button</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_config_space</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">defeature_PHP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_speed_capability</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCI_SUB_HPC_ID4</span>:
			<span class="cm">/* First PCI-X implementation, 100MHz */</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">push_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_switch_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">PCI_SPEED_100MHz_PCIX</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">push_button</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_config_space</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">defeature_PHP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_speed_capability</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span><span class="p">(</span><span class="n">msg_HPC_not_supported</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_free_ctrl</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PCI_VENDOR_ID_INTEL</span>:
		<span class="cm">/* Check for speed capability (0=33, 1=66) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subsystem_deviceid</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">PCI_SPEED_66MHz</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">PCI_SPEED_33MHz</span><span class="p">;</span>

		<span class="cm">/* Check for push button */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subsystem_deviceid</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">)</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">push_button</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">push_button</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Check for slot switch type (0=mechanical, 1=not mechanical) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subsystem_deviceid</span> <span class="o">&amp;</span> <span class="mh">0x0004</span><span class="p">)</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_switch_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_switch_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* PHP Status (0=De-feature PHP, 1=Normal operation) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subsystem_deviceid</span> <span class="o">&amp;</span> <span class="mh">0x0008</span><span class="p">)</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">defeature_PHP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* PHP supported */</span>
		<span class="k">else</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">defeature_PHP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* PHP not supported */</span>

		<span class="cm">/* Alternate Base Address Register Interface</span>
<span class="cm">		 * (0=not supported, 1=supported)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subsystem_deviceid</span> <span class="o">&amp;</span> <span class="mh">0x0010</span><span class="p">)</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">alternate_base_address</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">alternate_base_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* PCI Config Space Index (0=not supported, 1=supported) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subsystem_deviceid</span> <span class="o">&amp;</span> <span class="mh">0x0020</span><span class="p">)</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_config_space</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_config_space</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* PCI-X support */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subsystem_deviceid</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">subsystem_deviceid</span> <span class="o">&amp;</span> <span class="mh">0x0040</span><span class="p">)</span>
				<span class="cm">/* 133MHz PCI-X if bit 7 is 1 */</span>
				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_speed_capability</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="cm">/* 100MHz PCI-X if bit 7 is 1 and bit 0 is 0, */</span>
				<span class="cm">/* 66MHz PCI-X if bit 7 is 1 and bit 0 is 1 */</span>
				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_speed_capability</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Conventional PCI */</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_speed_capability</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">err</span><span class="p">(</span><span class="n">msg_HPC_not_supported</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_ctrl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Tell the user that we found one. */</span>
	<span class="n">info</span><span class="p">(</span><span class="s">&quot;Initializing the PCI hot plug controller residing on PCI bus %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Hotplug controller capabilities:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;    speed_capability       %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;    slot_switch_type       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_switch_type</span> <span class="o">?</span>
					<span class="s">&quot;switch present&quot;</span> <span class="o">:</span> <span class="s">&quot;no switch&quot;</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;    defeature_PHP          %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">defeature_PHP</span> <span class="o">?</span>
					<span class="s">&quot;PHP supported&quot;</span> <span class="o">:</span> <span class="s">&quot;PHP not supported&quot;</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;    alternate_base_address %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">alternate_base_address</span> <span class="o">?</span>
					<span class="s">&quot;supported&quot;</span> <span class="o">:</span> <span class="s">&quot;not supported&quot;</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;    pci_config_space       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_config_space</span> <span class="o">?</span>
					<span class="s">&quot;supported&quot;</span> <span class="o">:</span> <span class="s">&quot;not supported&quot;</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;    pcix_speed_capability  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_speed_capability</span> <span class="o">?</span>
					<span class="s">&quot;supported&quot;</span> <span class="o">:</span> <span class="s">&quot;not supported&quot;</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;    pcix_support           %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_support</span> <span class="o">?</span>
					<span class="s">&quot;supported&quot;</span> <span class="o">:</span> <span class="s">&quot;not supported&quot;</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* make our own copy of the pci bus structure,</span>
<span class="cm">	 * as we like tweaking it a lot */</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_ctrl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bus device function rev: %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span>
		<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="cm">/* initialize our threads if they haven&#39;t already been started up */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">one_time_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">err_free_bus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;pdev = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;pci resource start %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;pci resource len %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">MY_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;cannot reserve MMIO region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_bus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;cannot remap MMIO region %llx @ %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_mem_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for 66Mhz operation */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">=</span> <span class="n">get_controller_speed</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>


	<span class="cm">/********************************************************</span>
<span class="cm">	 *</span>
<span class="cm">	 *              Save configuration headers for this and</span>
<span class="cm">	 *              subordinate PCI buses</span>
<span class="cm">	 *</span>
<span class="cm">	 ********************************************************/</span>

	<span class="cm">/* find the physical slot number of the first hot plug slot */</span>

	<span class="cm">/* Get slot won&#39;t work for devices behind bridges, but</span>
<span class="cm">	 * in this case it will always be called for the &quot;base&quot;</span>
<span class="cm">	 * bus/dev/func of a slot.</span>
<span class="cm">	 * CS: this is leveraging the PCIIRQ routing code from the kernel</span>
<span class="cm">	 * (pci-pc.c: get_irq_routing_table) */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">get_slot_mapping</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				<span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">first_slot</span><span class="p">));</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;get_slot_mapping: first_slot = %d, returned = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">first_slot</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="n">msg_initialization_err</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Store PCI Config Space for all devices on this bus */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cpqhp_save_config</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_MASK</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s: unable to save PCI configuration data, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get IO, memory, and IRQ resources for new devices</span>
<span class="cm">	 */</span>
	<span class="cm">/* The next line is required for cpqhp_find_available_resources */</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">interrupt</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpqhp_legacy_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;System seems to be configured for Full Table Mapped MPS mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cfgspc_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cfgspc_irq</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cpqhp_find_available_resources</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">cpqhp_rom_start</span><span class="p">);</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">add_support</span> <span class="o">=</span> <span class="o">!</span><span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;cpqhp_find_available_resources = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;unable to locate PCI configuration resources for hot plug add.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Finish setting up the hot plug ctrl device</span>
<span class="cm">	 */</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;NumSlots %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">next_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Setup the slot information structures */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ctrl_slot_setup</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">smbios_start</span><span class="p">,</span> <span class="n">smbios_table</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="n">msg_initialization_err</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s: unable to save PCI configuration data, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Mask all general input interrupts */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xFFFFFFFFL</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">INT_MASK</span><span class="p">);</span>

	<span class="cm">/* set up the interrupt */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;HPC interrupt = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">,</span> <span class="n">cpqhp_ctrl_intr</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">MY_NAME</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;Can&#39;t get irq %d for the hotplug pci controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable Shift Out interrupt and clear it, also enable SERR on power</span>
<span class="cm">	 * fault</span>
<span class="cm">	 */</span>
	<span class="n">temp_word</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">MISC</span><span class="p">);</span>
	<span class="n">temp_word</span> <span class="o">|=</span> <span class="mh">0x4006</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">temp_word</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">MISC</span><span class="p">);</span>

	<span class="cm">/* Changed 05/05/97 to clear all interrupts at start */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xFFFFFFFFL</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">INT_INPUT_CLEAR</span><span class="p">);</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">INT_INPUT_CLEAR</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0L</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">INT_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpqhp_ctrl_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpqhp_ctrl_list</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpqhp_ctrl_list</span><span class="p">;</span>
		<span class="n">cpqhp_ctrl_list</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* turn off empty slots here unless command line option &quot;ON&quot; set</span>
<span class="cm">	 * Wait for exclusive access to hardware</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

	<span class="n">num_of_slots</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_MASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>

	<span class="cm">/* find first device number for the ctrl */</span>
	<span class="n">device</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">num_of_slots</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;num_of_slots: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num_of_slots</span><span class="p">);</span>
		<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">hp_slot</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">-</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;hp_slot: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

		<span class="cm">/* We have to save the presence info for these slots */</span>
		<span class="n">temp_word</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">presence_save</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_word</span> <span class="o">&gt;&gt;</span> <span class="n">hp_slot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">presence_save</span> <span class="o">|=</span> <span class="p">(</span><span class="n">temp_word</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">hp_slot</span> <span class="o">+</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1L</span> <span class="o">&lt;&lt;</span> <span class="n">hp_slot</span><span class="p">))</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">switch_save</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">switch_save</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">power_mode</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">is_a_board</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">green_LED_off</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
				<span class="n">slot_disable</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="n">device</span><span class="o">++</span><span class="p">;</span>
		<span class="n">num_of_slots</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">power_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
		<span class="cm">/* Wait for SOBS to be unset */</span>
		<span class="n">wait_for_ctrl_irq</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">init_SERR</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;init_SERR failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Done with exclusive hardware access */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

	<span class="n">cpqhp_create_debugfs_files</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
<span class="nl">err_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span><span class="p">);</span>
<span class="nl">err_free_mem_region:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="nl">err_free_bus:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">);</span>
<span class="nl">err_free_ctrl:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
<span class="nl">err_disable_device:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">unload_cpqphpd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">TempSlot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">tctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">tres</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">compaq_nvram_store</span><span class="p">(</span><span class="n">cpqhp_rom_start</span><span class="p">);</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">cpqhp_ctrl_list</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">misc</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">read_slot_enable</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

			<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_SERR</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0xFFFFFFC0L</span> <span class="o">|</span> <span class="o">~</span><span class="n">rc</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">INT_MASK</span><span class="p">);</span>

			<span class="n">misc</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">MISC</span><span class="p">);</span>
			<span class="n">misc</span> <span class="o">&amp;=</span> <span class="mh">0xFFFD</span><span class="p">;</span>
			<span class="n">writew</span><span class="p">(</span><span class="n">misc</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">MISC</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ctrl_slot_cleanup</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">kfree</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">);</span>

		<span class="n">tctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="n">loop</span><span class="p">];</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">res</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">res</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">res</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">TempSlot</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">TempSlot</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Stop the notification mechanism */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">initialized</span><span class="p">)</span>
		<span class="n">cpqhp_event_stop_thread</span><span class="p">();</span>

	<span class="cm">/* unmap the rom address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpqhp_rom_start</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">cpqhp_rom_start</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smbios_start</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">smbios_start</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">hpcd_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	<span class="cm">/* handle any PCI Hotplug controller */</span>
	<span class="p">.</span><span class="n">class</span> <span class="o">=</span>        <span class="p">((</span><span class="n">PCI_CLASS_SYSTEM_PCI_HOTPLUG</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">),</span>
	<span class="p">.</span><span class="n">class_mask</span> <span class="o">=</span>   <span class="o">~</span><span class="mi">0</span><span class="p">,</span>

	<span class="cm">/* no matter who makes it */</span>
	<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span>       <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span> <span class="o">=</span>       <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span>    <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span>    <span class="n">PCI_ANY_ID</span><span class="p">,</span>

	<span class="p">},</span> <span class="p">{</span> <span class="cm">/* end: all zeroes */</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">hpcd_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">cpqhpc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;compaq_pci_hotplug&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">hpcd_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">cpqhpc_probe</span><span class="p">,</span>
	<span class="cm">/* remove:	cpqhpc_remove_one, */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cpqhpc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">cpqhp_debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

	<span class="n">info</span> <span class="p">(</span><span class="n">DRIVER_DESC</span> <span class="s">&quot; version: &quot;</span> <span class="n">DRIVER_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cpqhp_initialize_debugfs</span><span class="p">();</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpqhpc_driver</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;pci_register_driver = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cpqhpc_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;unload_cpqphpd()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">unload_cpqphpd</span><span class="p">();</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;pci_unregister_driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpqhpc_driver</span><span class="p">);</span>
	<span class="n">cpqhp_shutdown_debugfs</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">cpqhpc_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cpqhpc_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
