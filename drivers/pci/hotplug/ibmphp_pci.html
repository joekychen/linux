<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pci › hotplug › ibmphp_pci.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ibmphp_pci.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * IBM Hot Plug Controller Driver</span>
<span class="cm"> * </span>
<span class="cm"> * Written By: Irene Zubarev, IBM Corporation</span>
<span class="cm"> * </span>
<span class="cm"> * Copyright (C) 2001 Greg Kroah-Hartman (greg@kroah.com)</span>
<span class="cm"> * Copyright (C) 2001,2002 IBM Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> * your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or</span>
<span class="cm"> * NON INFRINGEMENT.  See the GNU General Public License for more</span>
<span class="cm"> * details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Send feedback to &lt;gregkh@us.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &quot;ibmphp.h&quot;</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">configure_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">configure_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">**</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">res_needed</span> <span class="o">*</span><span class="n">scan_behind_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">add_new_bus</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">find_sec_number</span> <span class="p">(</span><span class="n">u8</span> <span class="n">primary_busno</span><span class="p">,</span> <span class="n">u8</span> <span class="n">slotno</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * NOTE..... If BIOS doesn&#39;t provide default routing, we assign:</span>
<span class="cm"> * 9 for SCSI, 10 for LAN adapters, and 11 for everything else. </span>
<span class="cm"> * If adapter is bridged, then we assign 11 to it and devices behind it.</span>
<span class="cm"> * We also assign the same irq numbers for multi function devices.</span>
<span class="cm"> * These are PIC mode, so shouldn&#39;t matter n.e.ways (hopefully)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">assign_alt_irq</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span> <span class="n">cur_func</span><span class="p">,</span> <span class="n">u8</span> <span class="n">class_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">class_code</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">PCI_BASE_CLASS_STORAGE</span>:
					<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCSI_IRQ</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">PCI_BASE_CLASS_NETWORK</span>:
					<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">LAN_IRQ</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">OTHER_IRQ</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configures the device to be added (will allocate needed resources if it</span>
<span class="cm"> * can), the device can be a bridge or a regular pci device, can also be</span>
<span class="cm"> * multi-functional</span>
<span class="cm"> * </span>
<span class="cm"> * Input: function to be added</span>
<span class="cm"> * </span>
<span class="cm"> * TO DO:  The error case with Multifunction device or multi function bridge,</span>
<span class="cm"> * if there is an error, will need to go through all previous functions and </span>
<span class="cm"> * unconfigure....or can add some code into unconfigure_card....</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ibmphp_configure_card</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="n">u8</span> <span class="n">slotno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">vendor_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">class</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">class_code</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hdr_type</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">sec_number</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">newfunc</span><span class="p">;</span>	<span class="cm">/* for multi devices */</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">cur_func</span><span class="p">,</span> <span class="o">*</span><span class="n">prev_func</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cleanup_count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">valid_device</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* to see if we are able to read from card any device info at all */</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;inside configure_card, func-&gt;busno = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">cur_func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>

	<span class="cm">/* We only get bus and device from IRQ routing table.  So at this point,</span>
<span class="cm">	 * func-&gt;busno is correct, and func-&gt;device contains only device (at the 5 </span>
<span class="cm">	 * highest bits)</span>
<span class="cm">	 */</span>

	<span class="cm">/* For every function on the card */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">function</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">function</span> <span class="o">&lt;</span> <span class="mh">0x08</span><span class="p">;</span> <span class="n">function</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
		<span class="n">ibmphp_pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>

		<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span><span class="p">;</span>

		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;inside the loop, cur_func-&gt;busno = %x, cur_func-&gt;device = %x, cur_func-&gt;funcion = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>

		<span class="n">pci_bus_read_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vendor_id</span><span class="p">);</span>

		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;vendor_id is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vendor_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vendor_id</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_NOTVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* found correct device!!! */</span>
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;found valid device, vendor_id = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vendor_id</span><span class="p">);</span>

			<span class="o">++</span><span class="n">valid_device</span><span class="p">;</span>

			<span class="cm">/* header: x x x x x x x x</span>
<span class="cm">			 *         | |___________|=&gt; 1=PPB bridge, 0=normal device, 2=CardBus Bridge</span>
<span class="cm">			 *         |_=&gt; 0 = single function device, 1 = multi-function device</span>
<span class="cm">			 */</span>

			<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr_type</span><span class="p">);</span>
			<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_CLASS_REVISION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">class</span><span class="p">);</span>

			<span class="n">class_code</span> <span class="o">=</span> <span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;hrd_type = %x, class = %x, class_code %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr_type</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="n">class_code</span><span class="p">);</span>
			<span class="n">class</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* to take revision out, class = class.subclass.prog i/f */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">PCI_CLASS_NOT_DEFINED_VGA</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;The device %x is VGA compatible and as is not supported for hot plugging. &quot;</span>
				     <span class="s">&quot;Please choose another device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">PCI_CLASS_DISPLAY_VGA</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;The device %x is not supported for hot plugging. &quot;</span>
				     <span class="s">&quot;Please choose another device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">hdr_type</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">PCI_HEADER_TYPE_NORMAL</span>:
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;single device case.... vendor id = %x, hdr_type = %x, class = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vendor_id</span><span class="p">,</span> <span class="n">hdr_type</span><span class="p">,</span> <span class="n">class</span><span class="p">);</span>
					<span class="n">assign_alt_irq</span> <span class="p">(</span><span class="n">cur_func</span><span class="p">,</span> <span class="n">class_code</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">configure_device</span> <span class="p">(</span><span class="n">cur_func</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* We need to do this in case some other BARs were properly inserted */</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;was not able to configure devfunc %x on bus %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>
						<span class="n">cleanup_count</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
						<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
					<span class="p">}</span>	
					<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">function</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">PCI_HEADER_TYPE_MULTIDEVICE</span>:
					<span class="n">assign_alt_irq</span> <span class="p">(</span><span class="n">cur_func</span><span class="p">,</span> <span class="n">class_code</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">configure_device</span> <span class="p">(</span><span class="n">cur_func</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* We need to do this in case some other BARs were properly inserted */</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;was not able to configure devfunc %x on bus %x...bailing out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>
						<span class="n">cleanup_count</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
						<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">newfunc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">newfunc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newfunc</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">newfunc</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
					<span class="n">newfunc</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
					<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">newfunc</span><span class="p">;</span>
					<span class="n">cur_func</span> <span class="o">=</span> <span class="n">newfunc</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
						<span class="n">newfunc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">PCI_HEADER_TYPE_MULTIBRIDGE</span>:
					<span class="n">class</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">!=</span> <span class="n">PCI_CLASS_BRIDGE_PCI</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;This %x is not PCI-to-PCI bridge, and as is not supported for hot-plugging. &quot;</span>
						     <span class="s">&quot;Please insert another card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">assign_alt_irq</span> <span class="p">(</span><span class="n">cur_func</span><span class="p">,</span> <span class="n">class_code</span><span class="p">);</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">configure_bridge</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cur_func</span><span class="p">,</span> <span class="n">slotno</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;You chose to insert Single Bridge, or nested bridges, this is not supported...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;Bus %x, devfunc %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
						<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* We need to do this in case some other BARs were properly inserted */</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;was not able to hot-add PPB properly.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* To indicate to the unconfigure function that this is a PPB */</span>
						<span class="n">cleanup_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
						<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec_number</span><span class="p">);</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
							<span class="n">newfunc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">newfunc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
							<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newfunc</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
								<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="n">newfunc</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">sec_number</span><span class="p">;</span>
							<span class="n">newfunc</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">i</span><span class="p">;</span>
							<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
								<span class="n">newfunc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">for</span> <span class="p">(</span><span class="n">prev_func</span> <span class="o">=</span> <span class="n">cur_func</span><span class="p">;</span> <span class="n">prev_func</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span> <span class="n">prev_func</span> <span class="o">=</span> <span class="n">prev_func</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">;</span>
								<span class="n">prev_func</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">newfunc</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">else</span>
								<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">newfunc</span><span class="p">;</span>

							<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_configure_card</span> <span class="p">(</span><span class="n">newfunc</span><span class="p">,</span> <span class="n">slotno</span><span class="p">);</span>
							<span class="cm">/* This could only happen if kmalloc failed */</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
								<span class="cm">/* We need to do this in case bridge itself got configured properly, but devices behind it failed */</span>
								<span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* To indicate to the unconfigure function that this is a PPB */</span>
								<span class="n">cleanup_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
								<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>

					<span class="n">newfunc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">newfunc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newfunc</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">newfunc</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
					<span class="n">newfunc</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
						<span class="n">newfunc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">prev_func</span> <span class="o">=</span> <span class="n">cur_func</span><span class="p">;</span> <span class="n">prev_func</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span> <span class="n">prev_func</span> <span class="o">=</span> <span class="n">prev_func</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">;</span>
					<span class="n">prev_func</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">newfunc</span><span class="p">;</span>
					<span class="n">cur_func</span> <span class="o">=</span> <span class="n">newfunc</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span>:
					<span class="n">class</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;class now is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">class</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">!=</span> <span class="n">PCI_CLASS_BRIDGE_PCI</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;This %x is not PCI-to-PCI bridge, and as is not supported for hot-plugging. &quot;</span>
						     <span class="s">&quot;Please insert another card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">assign_alt_irq</span> <span class="p">(</span><span class="n">cur_func</span><span class="p">,</span> <span class="n">class_code</span><span class="p">);</span>

					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;cur_func-&gt;busno b4 configure_bridge is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">configure_bridge</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cur_func</span><span class="p">,</span> <span class="n">slotno</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;You chose to insert Single Bridge, or nested bridges, this is not supported...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;Bus %x, devfunc %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
						<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* We need to do this in case some other BARs were properly inserted */</span>
						<span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* To indicate to the unconfigure function that this is a PPB */</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;was not able to hot-add PPB properly.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">cleanup_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
						<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;cur_func-&gt;busno = %x, device = %x, function = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
					<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec_number</span><span class="p">);</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;after configuring bridge..., sec_number = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sec_number</span><span class="p">);</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
							<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;inside for loop, device is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
							<span class="n">newfunc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">newfunc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
							<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newfunc</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">err</span> <span class="p">(</span><span class="s">&quot; out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
								<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="n">newfunc</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">sec_number</span><span class="p">;</span>
							<span class="n">newfunc</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">i</span><span class="p">;</span>
							<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
								<span class="n">newfunc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">for</span> <span class="p">(</span><span class="n">prev_func</span> <span class="o">=</span> <span class="n">cur_func</span><span class="p">;</span> <span class="n">prev_func</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span> <span class="n">prev_func</span> <span class="o">=</span> <span class="n">prev_func</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">;</span>
								<span class="n">prev_func</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">newfunc</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">else</span>
								<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">newfunc</span><span class="p">;</span>

							<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_configure_card</span> <span class="p">(</span><span class="n">newfunc</span><span class="p">,</span> <span class="n">slotno</span><span class="p">);</span>

							<span class="cm">/* Again, this case should not happen... For complete paranoia, will need to call remove_bus */</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
								<span class="cm">/* We need to do this in case some other BARs were properly inserted */</span>
								<span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* To indicate to the unconfigure function that this is a PPB */</span>
								<span class="n">cleanup_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
								<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>

					<span class="n">function</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;MAJOR PROBLEM!!!!, header type not supported? %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr_type</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/* end of switch */</span>
		<span class="p">}</span>	<span class="cm">/* end of valid device */</span>
	<span class="p">}</span>	<span class="cm">/* end of for */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;Cannot find any valid devices on the card.  Or unable to read from card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cleanup_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function configures the pci BARs of a single device.  </span>
<span class="cm"> * Input: pointer to the pci_func</span>
<span class="cm"> * Output: configured PCI, 0, or error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">configure_device</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bar</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_1</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_2</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_3</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_4</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_5</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">io</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">mem</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">mem_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">pfmem</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - inside</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
	<span class="n">ibmphp_pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">];</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* for 6 BARs */</span>

		<span class="cm">/* not sure if i need this.  per scott, said maybe need smth like this</span>
<span class="cm">		   if devices don&#39;t adhere 100% to the spec, so don&#39;t want to write</span>
<span class="cm">		   to the reserved bits</span>

<span class="cm">		pcibios_read_config_byte(cur_func-&gt;busno, cur_func-&gt;device, </span>
<span class="cm">		PCI_BASE_ADDRESS_0 + 4 * count, &amp;tmp);</span>
<span class="cm">		if (tmp &amp; 0x01) // IO</span>
<span class="cm">			pcibios_write_config_dword(cur_func-&gt;busno, cur_func-&gt;device, </span>
<span class="cm">			PCI_BASE_ADDRESS_0 + 4 * count, 0xFFFFFFFD);</span>
<span class="cm">		else  // Memory</span>
<span class="cm">			pcibios_write_config_dword(cur_func-&gt;busno, cur_func-&gt;device, </span>
<span class="cm">			PCI_BASE_ADDRESS_0 + 4 * count, 0xFFFFFFFF);</span>
<span class="cm">		 */</span>
		<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">])</span>	<span class="cm">/* This BAR is not implemented */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;Device %x BAR %d wants %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_SPACE_IO</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This is IO */</span>
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;inside IO SPACE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFC</span><span class="p">;</span>
			<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;len[count] in IO %x, count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">count</span><span class="p">);</span>

			<span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">IO</span><span class="p">;</span>
			<span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
			<span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
			<span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_check_resource</span><span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot allocate requested io for bus %x device %x function %x len %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
				<span class="n">kfree</span> <span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
	
			<span class="cm">/* _______________This is for debugging purposes only_____________________ */</span> 
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;b4 writing, the IO address is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
			<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;after writing.... the start address is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
			<span class="cm">/* _________________________________________________________________________*/</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* This is Memory */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_PREFETCH</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* pfmem */</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;PFMEM SPACE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
				<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;len[count] in PFMEM %x, count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">count</span><span class="p">);</span>

				<span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PFMEM</span><span class="p">;</span>
				<span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
				<span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
							<span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
				<span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
				<span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">fromMem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_check_resource</span> <span class="p">(</span><span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
					<span class="n">func</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">mem_tmp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mem_tmp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_tmp</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">kfree</span> <span class="p">(</span><span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MEM</span><span class="p">;</span>
					<span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
					<span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devfunc</span><span class="p">;</span>
					<span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;there&#39;s no pfmem... going into mem.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_check_resource</span> <span class="p">(</span><span class="n">mem_tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">mem_tmp</span><span class="p">);</span>
						<span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">fromMem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">;</span>
						<span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
						<span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
						<span class="n">ibmphp_add_pfmem_from_mem</span> <span class="p">(</span><span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
						<span class="n">func</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot allocate requested pfmem for bus %x, device %x, len %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
						<span class="n">kfree</span> <span class="p">(</span><span class="n">mem_tmp</span><span class="p">);</span>
						<span class="n">kfree</span> <span class="p">(</span><span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

				<span class="cm">/*_______________This is for debugging purposes only______________________________*/</span>				
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;b4 writing, start address is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
				<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;after writing, start address is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
				<span class="cm">/*_________________________________________________________________________________*/</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* takes up another dword */</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;inside the mem 64 case, count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
					<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="cm">/* on the 2nd dword, write all 0s, since we can&#39;t handle them n.e.ways */</span>
					<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="mh">0x00000000</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* regular memory */</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;REGULAR MEM SPACE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
				<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;len[count] in Mem %x, count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">count</span><span class="p">);</span>

				<span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MEM</span><span class="p">;</span>
				<span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
				<span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
							<span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
				<span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_check_resource</span> <span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
					<span class="n">func</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot allocate requested mem for bus %x, device %x, len %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
					<span class="n">kfree</span> <span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
				<span class="cm">/* _______________________This is for debugging purposes only _______________________*/</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;b4 writing, start address is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
				<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;after writing, the address is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
				<span class="cm">/* __________________________________________________________________________________*/</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* takes up another dword */</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;inside mem 64 case, reg. mem, count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
					<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="cm">/* on the 2nd dword, write all 0s, since we can&#39;t handle them n.e.ways */</span>
					<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="mh">0x00000000</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>		<span class="cm">/* end of mem */</span>
	<span class="p">}</span>			<span class="cm">/* end of for */</span>

	<span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* To indicate that this is not a PPB */</span>
	<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_PIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mh">0x05</span><span class="p">))</span>
		<span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">irq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>

	<span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="n">CACHE</span><span class="p">);</span>
	<span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="n">LATENCY</span><span class="p">);</span>

	<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_ROM_ADDRESS</span><span class="p">,</span> <span class="mh">0x00L</span><span class="p">);</span>
	<span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">DEVICEENABLE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * This routine configures a PCI-2-PCI bridge and the functions behind it</span>
<span class="cm"> * Parameters: pci_func</span>
<span class="cm"> * Returns: </span>
<span class="cm"> ******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">configure_bridge</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">**</span><span class="n">func_passed</span><span class="p">,</span> <span class="n">u8</span> <span class="n">slotno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sec_number</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">io_base</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pfmem_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bar</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">flag_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flag_mem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flag_pfmem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">need_io_upper</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">need_pfmem_upper</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">res_needed</span> <span class="o">*</span><span class="n">amount_needed</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">bus_io</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">bus_mem</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">mem_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">pfmem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">bus_pfmem</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_1</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span> <span class="o">=</span> <span class="o">*</span><span class="n">func_passed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">ibmphp_pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>

	<span class="cm">/* Configuring necessary info for the bridge so that we could see the devices</span>
<span class="cm">	 * behind it</span>
<span class="cm">	 */</span>

	<span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PRIMARY_BUS</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>

	<span class="cm">/* _____________________For debugging purposes only __________________________</span>
<span class="cm">	pci_bus_config_byte (ibmphp_pci_bus, devfn, PCI_PRIMARY_BUS, &amp;pri_number);</span>
<span class="cm">	debug (&quot;primary # written into the bridge is %x\n&quot;, pri_number);</span>
<span class="cm">	 ___________________________________________________________________________*/</span>

	<span class="cm">/* in EBDA, only get allocated 1 additional bus # per slot */</span>
	<span class="n">sec_number</span> <span class="o">=</span> <span class="n">find_sec_number</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">slotno</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sec_number</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot allocate secondary bus number for the bridged device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;after find_sec_number, the number we got is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sec_number</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;AFTER FIND_SEC_NUMBER, func-&gt;busno IS %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>

	<span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="n">sec_number</span><span class="p">);</span>
	
	<span class="cm">/* __________________For debugging purposes only __________________________________</span>
<span class="cm">	pci_bus_read_config_byte (ibmphp_pci_bus, devfn, PCI_SECONDARY_BUS, &amp;sec_number);</span>
<span class="cm">	debug (&quot;sec_number after write/read is %x\n&quot;, sec_number);</span>
<span class="cm">	 ________________________________________________________________________________*/</span>

	<span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SUBORDINATE_BUS</span><span class="p">,</span> <span class="n">sec_number</span><span class="p">);</span>

	<span class="cm">/* __________________For debugging purposes only ____________________________________</span>
<span class="cm">	pci_bus_read_config_byte (ibmphp_pci_bus, devfn, PCI_SUBORDINATE_BUS, &amp;sec_number);</span>
<span class="cm">	debug (&quot;subordinate number after write/read is %x\n&quot;, sec_number);</span>
<span class="cm">	 __________________________________________________________________________________*/</span>

	<span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="n">CACHE</span><span class="p">);</span>
	<span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="n">LATENCY</span><span class="p">);</span>
	<span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SEC_LATENCY_TIMER</span><span class="p">,</span> <span class="n">LATENCY</span><span class="p">);</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;func-&gt;busno is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;sec_number after writing is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sec_number</span><span class="p">);</span>


	<span class="cm">/* !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<span class="cm">	   !!!!!!!!!!!!!!!NEED TO ADD!!!  FAST BACK-TO-BACK ENABLE!!!!!!!!!!!!!!!!!!!! </span>
<span class="cm">	   !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/</span>


	<span class="cm">/* First we need to allocate mem/io for the bridge itself in case it needs it */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">];</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* for 2 BARs */</span>
		<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* This BAR is not implemented */</span>
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;so we come here then, eh?, count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>tmp_bar = bar[count];</p></td><td class="code"><div class="highlight"><pre>		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;Bar %d wants %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_SPACE_IO</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This is IO */</span>
			<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFC</span><span class="p">;</span>
			<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;len[count] in IO = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>

			<span class="n">bus_io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus_io</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bus_io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">IO</span><span class="p">;</span>
			<span class="n">bus_io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
			<span class="n">bus_io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
							<span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
			<span class="n">bus_io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_check_resource</span> <span class="p">(</span><span class="n">bus_io</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">bus_io</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">bus_io</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot allocate requested io for bus %x, device %x, len %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
				<span class="n">kfree</span> <span class="p">(</span><span class="n">bus_io</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* This is Memory */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_PREFETCH</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* pfmem */</span>
				<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
				<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;len[count] in PFMEM = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>

				<span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PFMEM</span><span class="p">;</span>
				<span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
				<span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
							<span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
				<span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
				<span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">fromMem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_check_resource</span> <span class="p">(</span><span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
					<span class="n">func</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">mem_tmp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mem_tmp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_tmp</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
						<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MEM</span><span class="p">;</span>
					<span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
					<span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devfunc</span><span class="p">;</span>
					<span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_check_resource</span> <span class="p">(</span><span class="n">mem_tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">mem_tmp</span><span class="p">);</span>
						<span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">fromMem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">;</span>
						<span class="n">ibmphp_add_pfmem_from_mem</span> <span class="p">(</span><span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
						<span class="n">func</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot allocate requested pfmem for bus %x, device %x, len %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
						     <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
						<span class="n">kfree</span> <span class="p">(</span><span class="n">mem_tmp</span><span class="p">);</span>
						<span class="n">kfree</span> <span class="p">(</span><span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* takes up another dword */</span>
					<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="cm">/* on the 2nd dword, write all 0s, since we can&#39;t handle them n.e.ways */</span>
					<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="mh">0x00000000</span><span class="p">);</span>

				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* regular memory */</span>
				<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
				<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;len[count] in Memory is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>

				<span class="n">bus_mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus_mem</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">bus_mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MEM</span><span class="p">;</span>
				<span class="n">bus_mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
				<span class="n">bus_mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
							<span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
				<span class="n">bus_mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_check_resource</span> <span class="p">(</span><span class="n">bus_mem</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">bus_mem</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
					<span class="n">func</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">bus_mem</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot allocate requested mem for bus %x, device %x, len %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
					<span class="n">kfree</span> <span class="p">(</span><span class="n">bus_mem</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* takes up another dword */</span>
					<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="cm">/* on the 2nd dword, write all 0s, since we can&#39;t handle them n.e.ways */</span>
					<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="mh">0x00000000</span><span class="p">);</span>

				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>		<span class="cm">/* end of mem */</span>
	<span class="p">}</span>			<span class="cm">/* end of for  */</span>

	<span class="cm">/* Now need to see how much space the devices behind the bridge needed */</span>
	<span class="n">amount_needed</span> <span class="o">=</span> <span class="n">scan_behind_bridge</span> <span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">sec_number</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">amount_needed</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ibmphp_pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;after coming back from scan_behind_bridge</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;amount_needed-&gt;not_correct = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">amount_needed</span><span class="o">-&gt;</span><span class="n">not_correct</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;amount_needed-&gt;io = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">amount_needed</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;amount_needed-&gt;mem = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">amount_needed</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;amount_needed-&gt;pfmem =  %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">amount_needed</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">amount_needed</span><span class="o">-&gt;</span><span class="n">not_correct</span><span class="p">)</span> <span class="p">{</span>		
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;amount_needed is not correct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">];</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* for 2 BARs */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus_io</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">bus_io</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">bus_pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bus_mem</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">bus_mem</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">amount_needed</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">amount_needed</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;it doesn&#39;t want IO?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">flag_io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;it wants %x IO behind the bridge</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">amount_needed</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">);</span>
		<span class="n">io</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">io</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">io</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">IO</span><span class="p">;</span>
		<span class="n">io</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
		<span class="n">io</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
		<span class="n">io</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">amount_needed</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_check_resource</span> <span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;were we able to add io</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">io</span><span class="p">);</span>
			<span class="n">flag_io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">amount_needed</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;it doesn&#39;t want n.e.memory?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">flag_mem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;it wants %x memory behind the bridge</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">amount_needed</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">);</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mem</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MEM</span><span class="p">;</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">amount_needed</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_check_resource</span> <span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">mem</span><span class="p">);</span>
			<span class="n">flag_mem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;were we able to add mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">amount_needed</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;it doesn&#39;t want n.e.pfmem mem?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">flag_pfmem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;it wants %x pfmemory behind the bridge</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">amount_needed</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">);</span>
		<span class="n">pfmem</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pfmem</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfmem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PFMEM</span><span class="p">;</span>
		<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
		<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
		<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">amount_needed</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">;</span>
		<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">fromMem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_check_resource</span> <span class="p">(</span><span class="n">pfmem</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">pfmem</span><span class="p">);</span>
			<span class="n">flag_pfmem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mem_tmp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mem_tmp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_tmp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MEM</span><span class="p">;</span>
			<span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
			<span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">devfunc</span><span class="p">;</span>
			<span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_check_resource</span> <span class="p">(</span><span class="n">mem_tmp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">mem_tmp</span><span class="p">);</span>
				<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">fromMem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="n">mem_tmp</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">;</span>
				<span class="n">ibmphp_add_pfmem_from_mem</span> <span class="p">(</span><span class="n">pfmem</span><span class="p">);</span>
				<span class="n">flag_pfmem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;b4 if (flag_io &amp;&amp; flag_mem &amp;&amp; flag_pfmem)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;flag_io = %x, flag_mem = %x, flag_pfmem = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flag_io</span><span class="p">,</span> <span class="n">flag_mem</span><span class="p">,</span> <span class="n">flag_pfmem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag_io</span> <span class="o">&amp;&amp;</span> <span class="n">flag_mem</span> <span class="o">&amp;&amp;</span> <span class="n">flag_pfmem</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If on bootup, there was a bridged card in this slot,</span>
<span class="cm">		 * then card was removed and ibmphp got unloaded and loaded</span>
<span class="cm">		 * back again, there&#39;s no way for us to remove the bus</span>
<span class="cm">		 * struct, so no need to kmalloc, can use existing node</span>
<span class="cm">		 */</span>
		<span class="n">bus</span> <span class="o">=</span> <span class="n">ibmphp_find_res_bus</span> <span class="p">(</span><span class="n">sec_number</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bus</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bus</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">sec_number</span><span class="p">;</span>
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;b4 adding new bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">add_new_bus</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">pfmem</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rangeIO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rangeMem</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">add_new_bus</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">pfmem</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;expected bus structure not empty?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ibmphp_remove_bus</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>
				<span class="n">kfree</span> <span class="p">(</span><span class="n">amount_needed</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_base</span><span class="p">);</span>
		<span class="n">pci_bus_read_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfmem_base</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">io_base</span> <span class="o">&amp;</span> <span class="n">PCI_IO_RANGE_TYPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_IO_RANGE_TYPE_32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;io 32</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">need_io_upper</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pfmem_base</span> <span class="o">&amp;</span> <span class="n">PCI_PREF_RANGE_TYPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_PREF_RANGE_TYPE_64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;pfmem 64</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">need_pfmem_upper</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">noIORanges</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_BASE</span><span class="p">,</span> <span class="mh">0x00</span> <span class="o">|</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rangeIO</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_LIMIT</span><span class="p">,</span> <span class="mh">0x00</span> <span class="o">|</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rangeIO</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>	

			<span class="cm">/* _______________This is for debugging purposes only ____________________</span>
<span class="cm">			pci_bus_read_config_byte (ibmphp_pci_bus, devfn, PCI_IO_BASE, &amp;temp);</span>
<span class="cm">			debug (&quot;io_base = %x\n&quot;, (temp &amp; PCI_IO_RANGE_TYPE_MASK) &lt;&lt; 8);</span>
<span class="cm">			pci_bus_read_config_byte (ibmphp_pci_bus, devfn, PCI_IO_LIMIT, &amp;temp);</span>
<span class="cm">			debug (&quot;io_limit = %x\n&quot;, (temp &amp; PCI_IO_RANGE_TYPE_MASK) &lt;&lt; 8);</span>
<span class="cm">			 ________________________________________________________________________*/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">need_io_upper</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* since can&#39;t support n.e.ways */</span>
				<span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_BASE_UPPER16</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_LIMIT_UPPER16</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_BASE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_LIMIT</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">noMemRanges</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_MEMORY_BASE</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="o">|</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rangeMem</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_MEMORY_LIMIT</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="o">|</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rangeMem</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			
			<span class="cm">/* ____________________This is for debugging purposes only ________________________</span>
<span class="cm">			pci_bus_read_config_word (ibmphp_pci_bus, devfn, PCI_MEMORY_BASE, &amp;temp);</span>
<span class="cm">			debug (&quot;mem_base = %x\n&quot;, (temp &amp; PCI_MEMORY_RANGE_TYPE_MASK) &lt;&lt; 16);</span>
<span class="cm">			pci_bus_read_config_word (ibmphp_pci_bus, devfn, PCI_MEMORY_LIMIT, &amp;temp);</span>
<span class="cm">			debug (&quot;mem_limit = %x\n&quot;, (temp &amp; PCI_MEMORY_RANGE_TYPE_MASK) &lt;&lt; 16);</span>
<span class="cm">			 __________________________________________________________________________________*/</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_MEMORY_BASE</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
			<span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_MEMORY_LIMIT</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_BASE</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="o">|</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_LIMIT</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="o">|</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

			<span class="cm">/* __________________________This is for debugging purposes only _______________________</span>
<span class="cm">			pci_bus_read_config_word (ibmphp_pci_bus, devfn, PCI_PREF_MEMORY_BASE, &amp;temp);</span>
<span class="cm">			debug (&quot;pfmem_base = %x&quot;, (temp &amp; PCI_MEMORY_RANGE_TYPE_MASK) &lt;&lt; 16);</span>
<span class="cm">			pci_bus_read_config_word (ibmphp_pci_bus, devfn, PCI_PREF_MEMORY_LIMIT, &amp;temp);</span>
<span class="cm">			debug (&quot;pfmem_limit = %x\n&quot;, (temp &amp; PCI_MEMORY_RANGE_TYPE_MASK) &lt;&lt; 16);</span>
<span class="cm">			 ______________________________________________________________________________________*/</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">need_pfmem_upper</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* since can&#39;t support n.e.ways */</span>
				<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_BASE_UPPER32</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
				<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_LIMIT_UPPER32</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_BASE</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
			<span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_LIMIT</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;b4 writing control information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_PIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mh">0x05</span><span class="p">))</span>
			<span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">irq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="cm">/*    </span>
<span class="cm">		pci_bus_write_config_byte (ibmphp_pci_bus, devfn, PCI_BRIDGE_CONTROL, ctrl);</span>
<span class="cm">		pci_bus_write_config_byte (ibmphp_pci_bus, devfn, PCI_BRIDGE_CONTROL, PCI_BRIDGE_CTL_PARITY);</span>
<span class="cm">		pci_bus_write_config_byte (ibmphp_pci_bus, devfn, PCI_BRIDGE_CONTROL, PCI_BRIDGE_CTL_SERR);</span>
<span class="cm">		 */</span>

		<span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">DEVICEENABLE</span><span class="p">);</span>
		<span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_BRIDGE_CONTROL</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">amount_needed</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;device where devices[i] is 1 = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* For unconfiguring, to indicate it&#39;s PPB */</span>
		<span class="n">func_passed</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">;</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;func-&gt;busno b4 returning is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;func-&gt;busno b4 returning in the other structure is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">func_passed</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">amount_needed</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;Configuring bridge was unsuccessful...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mem_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">amount_needed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pfmem</span><span class="p">)</span>
		<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">pfmem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="p">)</span>
		<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">io</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="p">)</span>
		<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">mem</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* for 2 BARs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus_io</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">bus_io</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bus_pfmem</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">bus_pfmem</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bus_mem</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">bus_mem</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * This function adds up the amount of resources needed behind the PPB bridge</span>
<span class="cm"> * and passes it to the configure_bridge function</span>
<span class="cm"> * Input: bridge function</span>
<span class="cm"> * Ouput: amount of resources needed</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">res_needed</span> <span class="o">*</span><span class="nf">scan_behind_bridge</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span> <span class="n">func</span><span class="p">,</span> <span class="n">u8</span> <span class="n">busno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">len</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">vendor_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hdr_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">howmany</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*this is to see if there are any devices behind the bridge */</span>

	<span class="n">u32</span> <span class="n">bar</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">class</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_1</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_2</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_3</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_4</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_5</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">res_needed</span> <span class="o">*</span><span class="n">amount</span><span class="p">;</span>

	<span class="n">amount</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">amount</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ibmphp_pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">busno</span><span class="p">;</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;the bus_no behind the bridge is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">busno</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;scanning devices behind the bridge...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">device</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">device</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">amount</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">function</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">function</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">function</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>

			<span class="n">pci_bus_read_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vendor_id</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">vendor_id</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_NOTVALID</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* found correct device!!! */</span>
				<span class="n">howmany</span><span class="o">++</span><span class="p">;</span>

				<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr_type</span><span class="p">);</span>
				<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_CLASS_REVISION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">class</span><span class="p">);</span>

				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;hdr_type behind the bridge is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr_type</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hdr_type</span> <span class="o">&amp;</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;embedded bridges not supported for hot-plugging.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">amount</span><span class="o">-&gt;</span><span class="n">not_correct</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">return</span> <span class="n">amount</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">class</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* to take revision out, class = class.subclass.prog i/f */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">PCI_CLASS_NOT_DEFINED_VGA</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;The device %x is VGA compatible and as is not supported for hot plugging. &quot;</span>
					     <span class="s">&quot;Please choose another device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
					<span class="n">amount</span><span class="o">-&gt;</span><span class="n">not_correct</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">return</span> <span class="n">amount</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">PCI_CLASS_DISPLAY_VGA</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;The device %x is not supported for hot plugging. &quot;</span>
					     <span class="s">&quot;Please choose another device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
					<span class="n">amount</span><span class="o">-&gt;</span><span class="n">not_correct</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">return</span> <span class="n">amount</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">amount</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">];</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* for 6 BARs */</span>
					<span class="cm">/*</span>
<span class="cm">					pci_bus_read_config_byte (ibmphp_pci_bus, devfn, address[count], &amp;tmp);</span>
<span class="cm">					if (tmp &amp; 0x01) // IO</span>
<span class="cm">						pci_bus_write_config_dword (ibmphp_pci_bus, devfn, address[count], 0xFFFFFFFD);</span>
<span class="cm">					else // MEMORY</span>
<span class="cm">						pci_bus_write_config_dword (ibmphp_pci_bus, devfn, address[count], 0xFFFFFFFF);</span>
<span class="cm">					*/</span>
					<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
					<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>

					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;what is bar[count]? %x, count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">count</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">])</span>	<span class="cm">/* This BAR is not implemented */</span>
						<span class="k">continue</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>tmp_bar = bar[count];</p></td><td class="code"><div class="highlight"><pre>					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;count %d device %x function %x wants %x resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_SPACE_IO</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* This is IO */</span>
						<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFC</span><span class="p">;</span>
						<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">amount</span><span class="o">-&gt;</span><span class="n">io</span> <span class="o">+=</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* This is Memory */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_PREFETCH</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* pfmem */</span>
							<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
							<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">amount</span><span class="o">-&gt;</span><span class="n">pfmem</span> <span class="o">+=</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span><span class="p">)</span>
								<span class="cm">/* takes up another dword */</span>
								<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="cm">/* regular memory */</span>
							<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
							<span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">amount</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+=</span> <span class="n">len</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span><span class="p">)</span> <span class="p">{</span>
								<span class="cm">/* takes up another dword */</span>
								<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>	<span class="cm">/* end for */</span>
			<span class="p">}</span>	<span class="cm">/* end if (valid) */</span>
		<span class="p">}</span>	<span class="cm">/* end for */</span>
	<span class="p">}</span>	<span class="cm">/* end for */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">howmany</span><span class="p">)</span>
		<span class="n">amount</span><span class="o">-&gt;</span><span class="n">not_correct</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">amount</span><span class="o">-&gt;</span><span class="n">not_correct</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">amount</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">amount</span><span class="o">-&gt;</span><span class="n">io</span> <span class="o">&lt;</span> <span class="n">IOBRIDGE</span><span class="p">))</span>
		<span class="n">amount</span><span class="o">-&gt;</span><span class="n">io</span> <span class="o">=</span> <span class="n">IOBRIDGE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">amount</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">amount</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">&lt;</span> <span class="n">MEMBRIDGE</span><span class="p">))</span>
		<span class="n">amount</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">=</span> <span class="n">MEMBRIDGE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">amount</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">amount</span><span class="o">-&gt;</span><span class="n">pfmem</span> <span class="o">&lt;</span> <span class="n">MEMBRIDGE</span><span class="p">))</span>
		<span class="n">amount</span><span class="o">-&gt;</span><span class="n">pfmem</span> <span class="o">=</span> <span class="n">MEMBRIDGE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">amount</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The following 3 unconfigure_boot_ routines deal with the case when we had the card </span>
<span class="cm"> * upon bootup in the system, since we don&#39;t allocate func to such case, we need to read </span>
<span class="cm"> * the start addresses from pci config space and then find the corresponding entries in </span>
<span class="cm"> * our resource lists.  The functions return either 0, -ENODEV, or -1 (general failure)</span>
<span class="cm"> * Change: we also call these functions even if we configured the card ourselves (i.e., not</span>
<span class="cm"> * the bootup case), since it should work same way</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">unconfigure_boot_device</span> <span class="p">(</span><span class="n">u8</span> <span class="n">busno</span><span class="p">,</span> <span class="n">u8</span> <span class="n">device</span><span class="p">,</span> <span class="n">u8</span> <span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">start_address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_1</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_2</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_3</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_4</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_5</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">io</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">pfmem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">end_address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_end</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp_address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">ibmphp_find_res_bus</span> <span class="p">(</span><span class="n">busno</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;cannot find corresponding bus.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
	<span class="n">ibmphp_pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">busno</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">];</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* for 6 BARs */</span>
		<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">start_address</span><span class="p">);</span>

		<span class="cm">/* We can do this here, b/c by that time the device driver of the card has been stopped */</span>

		<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">start_address</span><span class="p">);</span>

		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;start_address is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start_address</span><span class="p">);</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;busno, device, function %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">busno</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This BAR is not implemented */</span>
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;is this bar no implemented?, count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp_address</span> <span class="o">=</span> <span class="n">start_address</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start_address</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_SPACE_IO</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This is IO */</span>
			<span class="n">start_address</span> <span class="o">&amp;=</span> <span class="n">PCI_BASE_ADDRESS_IO_MASK</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFC</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="o">~</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">end_address</span> <span class="o">=</span> <span class="n">start_address</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_find_resource</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="p">,</span> <span class="n">IO</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot find corresponding IO resource to remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;io-&gt;start = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
			<span class="n">temp_end</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
			<span class="n">start_address</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">io</span><span class="p">);</span>
			<span class="cm">/* This is needed b/c of the old I/O restrictions in the BIOS */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">temp_end</span> <span class="o">&lt;</span> <span class="n">end_address</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_find_resource</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="p">,</span> <span class="n">IO</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot find corresponding IO resource to remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;io-&gt;start = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
				<span class="n">temp_end</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
				<span class="n">start_address</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">io</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* ????????? DO WE NEED TO WRITE ANYTHING INTO THE PCI CONFIG SPACE BACK ?????????? */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* This is Memory */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">start_address</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_PREFETCH</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* pfmem */</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;start address of pfmem is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start_address</span><span class="p">);</span>
				<span class="n">start_address</span> <span class="o">&amp;=</span> <span class="n">PCI_BASE_ADDRESS_MEM_MASK</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_find_resource</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfmem</span><span class="p">,</span> <span class="n">PFMEM</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot find corresponding PFMEM resource to remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pfmem</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;pfmem-&gt;start = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

					<span class="n">ibmphp_remove_resource</span><span class="p">(</span><span class="n">pfmem</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* regular memory */</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;start address of mem is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start_address</span><span class="p">);</span>
				<span class="n">start_address</span> <span class="o">&amp;=</span> <span class="n">PCI_BASE_ADDRESS_MEM_MASK</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_find_resource</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="p">,</span> <span class="n">MEM</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot find corresponding MEM resource to remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;mem-&gt;start = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

					<span class="n">ibmphp_remove_resource</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp_address</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* takes up another dword */</span>
				<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>	<span class="cm">/* end of mem */</span>
	<span class="p">}</span>	<span class="cm">/* end of for */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">unconfigure_boot_bridge</span> <span class="p">(</span><span class="n">u8</span> <span class="n">busno</span><span class="p">,</span> <span class="n">u8</span> <span class="n">device</span><span class="p">,</span> <span class="n">u8</span> <span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bus_no</span><span class="p">,</span> <span class="n">pri_no</span><span class="p">,</span> <span class="n">sub_no</span><span class="p">,</span> <span class="n">sec_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start_address</span><span class="p">,</span> <span class="n">tmp_address</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sec_number</span><span class="p">,</span> <span class="n">sub_number</span><span class="p">,</span> <span class="n">pri_number</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">pfmem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span>
		<span class="n">PCI_BASE_ADDRESS_1</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>

	<span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
	<span class="n">ibmphp_pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">busno</span><span class="p">;</span>
	<span class="n">bus_no</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">busno</span><span class="p">;</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;busno is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">busno</span><span class="p">);</span>
	<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PRIMARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pri_number</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - busno = %x, primary_number = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">busno</span><span class="p">,</span> <span class="n">pri_number</span><span class="p">);</span>

	<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec_number</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;sec_number is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sec_number</span><span class="p">);</span>
	<span class="n">sec_no</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sec_number</span><span class="p">;</span>
	<span class="n">pri_no</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">pri_number</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pri_no</span> <span class="o">!=</span> <span class="n">bus_no</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;primary numbers in our structures and pci config space don&#39;t match.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SUBORDINATE_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sub_number</span><span class="p">);</span>
	<span class="n">sub_no</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sub_number</span><span class="p">;</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;sub_no is %d, sec_no is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sub_no</span><span class="p">,</span> <span class="n">sec_no</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sec_no</span> <span class="o">!=</span> <span class="n">sub_number</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;there&#39;re more buses behind this bridge.  Hot removal is not supported.  Please choose another card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">ibmphp_find_res_bus</span> <span class="p">(</span><span class="n">sec_number</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot find Bus structure for the bridged device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;bus-&gt;busno is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;sec_number is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sec_number</span><span class="p">);</span>

	<span class="n">ibmphp_remove_bus</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">busno</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">];</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for 2 BARs */</span>
		<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">start_address</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">start_address</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This BAR is not implemented */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tmp_address</span> <span class="o">=</span> <span class="n">start_address</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">start_address</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_SPACE_IO</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This is IO */</span>
			<span class="n">start_address</span> <span class="o">&amp;=</span> <span class="n">PCI_BASE_ADDRESS_IO_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_find_resource</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="p">,</span> <span class="n">IO</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot find corresponding IO resource to remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="p">)</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;io-&gt;start = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

			<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">io</span><span class="p">);</span>

			<span class="cm">/* ????????? DO WE NEED TO WRITE ANYTHING INTO THE PCI CONFIG SPACE BACK ?????????? */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* This is Memory */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">start_address</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_PREFETCH</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* pfmem */</span>
				<span class="n">start_address</span> <span class="o">&amp;=</span> <span class="n">PCI_BASE_ADDRESS_MEM_MASK</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_find_resource</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfmem</span><span class="p">,</span> <span class="n">PFMEM</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot find corresponding PFMEM resource to remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pfmem</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;pfmem-&gt;start = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

					<span class="n">ibmphp_remove_resource</span><span class="p">(</span><span class="n">pfmem</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* regular memory */</span>
				<span class="n">start_address</span> <span class="o">&amp;=</span> <span class="n">PCI_BASE_ADDRESS_MEM_MASK</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_find_resource</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="p">,</span> <span class="n">MEM</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot find corresponding MEM resource to remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;mem-&gt;start = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

					<span class="n">ibmphp_remove_resource</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp_address</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* takes up another dword */</span>
				<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>	<span class="cm">/* end of mem */</span>
	<span class="p">}</span>	<span class="cm">/* end of for */</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - exiting, returning success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">unconfigure_boot_card</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot_cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">vendor_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">class</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hdr_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">busno</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">valid_device</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* To see if we are ever able to find valid device and read it */</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">busno</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;b4 for loop, device is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="cm">/* For every function on the card */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">function</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="n">function</span> <span class="o">&lt;</span> <span class="mh">0x08</span><span class="p">;</span> <span class="n">function</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
		<span class="n">ibmphp_pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">busno</span><span class="p">;</span>

		<span class="n">pci_bus_read_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vendor_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vendor_id</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_NOTVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* found correct device!!! */</span>
			<span class="o">++</span><span class="n">valid_device</span><span class="p">;</span>

			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - found correct device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

			<span class="cm">/* header: x x x x x x x x</span>
<span class="cm">			 *         | |___________|=&gt; 1=PPB bridge, 0=normal device, 2=CardBus Bridge</span>
<span class="cm">			 *         |_=&gt; 0 = single function device, 1 = multi-function device</span>
<span class="cm">			 */</span>

			<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr_type</span><span class="p">);</span>
			<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_CLASS_REVISION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">class</span><span class="p">);</span>

			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;hdr_type %x, class %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr_type</span><span class="p">,</span> <span class="n">class</span><span class="p">);</span>
			<span class="n">class</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* to take revision out, class = class.subclass.prog i/f */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">PCI_CLASS_NOT_DEFINED_VGA</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;The device %x function %x is VGA compatible and is not supported for hot removing. &quot;</span>
				     <span class="s">&quot;Please choose another device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="n">PCI_CLASS_DISPLAY_VGA</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;The device %x function %x is not supported for hot removing. &quot;</span>
				     <span class="s">&quot;Please choose another device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">hdr_type</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">PCI_HEADER_TYPE_NORMAL</span>:
					<span class="n">rc</span> <span class="o">=</span> <span class="n">unconfigure_boot_device</span> <span class="p">(</span><span class="n">busno</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;was not able to unconfigure device %x func %x on bus %x. bailing out...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">busno</span><span class="p">);</span>
						<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">function</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">PCI_HEADER_TYPE_MULTIDEVICE</span>:
					<span class="n">rc</span> <span class="o">=</span> <span class="n">unconfigure_boot_device</span> <span class="p">(</span><span class="n">busno</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;was not able to unconfigure device %x func %x on bus %x. bailing out...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">busno</span><span class="p">);</span>
						<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span>:
					<span class="n">class</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">!=</span> <span class="n">PCI_CLASS_BRIDGE_PCI</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;This device %x function %x is not PCI-to-PCI bridge, &quot;</span>
						     <span class="s">&quot;and is not supported for hot-removing. &quot;</span>
						     <span class="s">&quot;Please try another card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">unconfigure_boot_bridge</span> <span class="p">(</span><span class="n">busno</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;was not able to hot-remove PPB properly.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">function</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">PCI_HEADER_TYPE_MULTIBRIDGE</span>:
					<span class="n">class</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">!=</span> <span class="n">PCI_CLASS_BRIDGE_PCI</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;This device %x function %x is not PCI-to-PCI bridge, &quot;</span>
						     <span class="s">&quot;and is not supported for hot-removing. &quot;</span>
						     <span class="s">&quot;Please try another card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">unconfigure_boot_bridge</span> <span class="p">(</span><span class="n">busno</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;was not able to hot-remove PPB properly.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;MAJOR PROBLEM!!!! Cannot read device&#39;s header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/* end of switch */</span>
		<span class="p">}</span>	<span class="cm">/* end of valid device */</span>
	<span class="p">}</span>	<span class="cm">/* end of for */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;Could not find device to unconfigure.  Or could not read the card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * free the resources of the card (multi, single, or bridged)</span>
<span class="cm"> * Parameters: slot, flag to say if this is for removing entire module or just</span>
<span class="cm"> * unconfiguring the device</span>
<span class="cm"> * TO DO:  will probably need to add some code in case there was some resource,</span>
<span class="cm"> * to remove it... this is from when we have errors in the configure_card...</span>
<span class="cm"> * 			!!!!!!!!!!!!!!!!!!!!!!!!!FOR BUSES!!!!!!!!!!!!</span>
<span class="cm"> * Returns: 0, -1, -ENODEV </span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ibmphp_unconfigure_card</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">**</span><span class="n">slot_cur</span><span class="p">,</span> <span class="kt">int</span> <span class="n">the_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">sl</span> <span class="o">=</span> <span class="o">*</span><span class="n">slot_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">cur_func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">temp_func</span><span class="p">;</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">the_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Need to unconfigure the card */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">unconfigure_boot_card</span> <span class="p">(</span><span class="n">sl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* In all other cases, will still need to get rid of func structure if it exists */</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur_func</span> <span class="o">=</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cur_func</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* TO DO: WILL MOST LIKELY NEED TO GET RID OF THE BUS STRUCTURE FROM RESOURCES AS WELL */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* in other words, it&#39;s a PPB */</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;io[%d] exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">the_end</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
					<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;mem[%d] exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">the_end</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
					<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;pfmem[%d] exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">the_end</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
					<span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">pfmem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">temp_func</span> <span class="o">=</span> <span class="n">cur_func</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">cur_func</span><span class="p">);</span>
			<span class="n">cur_func</span> <span class="o">=</span> <span class="n">temp_func</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sl</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">slot_cur</span> <span class="o">=</span> <span class="n">sl</span><span class="p">;</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * add a new bus resulting from hot-plugging a PPB bridge with devices</span>
<span class="cm"> *</span>
<span class="cm"> * Input: bus and the amount of resources needed (we know we can assign those,</span>
<span class="cm"> *        since they&#39;ve been checked already</span>
<span class="cm"> * Output: bus added to the correct spot</span>
<span class="cm"> *         0, -1, error </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_new_bus</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">pfmem</span><span class="p">,</span> <span class="n">u8</span> <span class="n">parent_busno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">io_range</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">mem_range</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">pfmem_range</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">cur_bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Trying to find the parent bus number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent_busno</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur_bus</span>	<span class="o">=</span> <span class="n">ibmphp_find_res_bus</span> <span class="p">(</span><span class="n">parent_busno</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cur_bus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;strange, cannot find bus which is supposed to be at the system... something is terribly wrong...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	
		<span class="n">list_add</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bus_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_bus</span><span class="o">-&gt;</span><span class="n">bus_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io_range</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">io_range</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_range</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">io_range</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">io_range</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
		<span class="n">io_range</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">noIORanges</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rangeIO</span> <span class="o">=</span> <span class="n">io_range</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mem_range</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mem_range</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_range</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mem_range</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">mem_range</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
		<span class="n">mem_range</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">noMemRanges</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rangeMem</span> <span class="o">=</span> <span class="n">mem_range</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pfmem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pfmem_range</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pfmem_range</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfmem_range</span><span class="p">)</span> <span class="p">{</span>	
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pfmem_range</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="n">pfmem_range</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
		<span class="n">pfmem_range</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">rangePFMem</span> <span class="o">=</span> <span class="n">pfmem_range</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * find the 1st available bus number for PPB to set as its secondary bus</span>
<span class="cm"> * Parameters: bus_number of the primary bus</span>
<span class="cm"> * Returns: bus_number of the secondary bus or 0xff in case of failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">find_sec_number</span> <span class="p">(</span><span class="n">u8</span> <span class="n">primary_busno</span><span class="p">,</span> <span class="n">u8</span> <span class="n">slotno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">busno</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_info</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span><span class="p">;</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">ibmphp_find_same_bus_num</span> <span class="p">(</span><span class="n">primary_busno</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot get slot range of the bus from the BIOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">slot_max</span><span class="p">;</span>
	<span class="n">min</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">slot_min</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">slotno</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">slotno</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;got the wrong range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">busno</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">slotno</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">min</span><span class="p">);</span>
	<span class="n">busno</span> <span class="o">+=</span> <span class="n">primary_busno</span> <span class="o">+</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">bus_cur</span> <span class="o">=</span> <span class="n">ibmphp_find_res_bus</span> <span class="p">(</span><span class="n">busno</span><span class="p">);</span>
	<span class="cm">/* either there is no such bus number, or there are no ranges, which</span>
<span class="cm">	 * can only happen if we removed the bridged device in previous load</span>
<span class="cm">	 * of the driver, and now only have the skeleton bus struct</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">bus_cur</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeIO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeMem</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">busno</span><span class="p">;</span>
	<span class="k">return</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
