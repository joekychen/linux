<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pci › hotplug › acpiphp_ibm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>acpiphp_ibm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ACPI PCI Hot Plug IBM Extension</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 Vernon Mauery &lt;vernux@us.ibm.com&gt;</span>
<span class="cm"> * Copyright (C) 2004 IBM Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> * your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or</span>
<span class="cm"> * NON INFRINGEMENT.  See the GNU General Public License for more</span>
<span class="cm"> * details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Send feedback to &lt;vernux@us.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;acpi/acpi_bus.h&gt;</span>
<span class="cp">#include &lt;linux/sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/kobject.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>

<span class="cp">#include &quot;acpiphp.h&quot;</span>
<span class="cp">#include &quot;../pci.h&quot;</span>

<span class="cp">#define DRIVER_VERSION	&quot;1.0.1&quot;</span>
<span class="cp">#define DRIVER_AUTHOR	&quot;Irene Zubarev &lt;zubarev@us.ibm.com&gt;, Vernon Mauery &lt;vernux@us.ibm.com&gt;&quot;</span>
<span class="cp">#define DRIVER_DESC	&quot;ACPI Hot Plug PCI Controller Driver IBM extension&quot;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRIVER_VERSION</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot; Debugging mode enabled or not&quot;</span><span class="p">);</span>
<span class="cp">#define MY_NAME &quot;acpiphp_ibm&quot;</span>

<span class="cp">#undef dbg</span>
<span class="cp">#define dbg(format, arg...)				\</span>
<span class="cp">do {							\</span>
<span class="cp">	if (debug)					\</span>
<span class="cp">		printk(KERN_DEBUG &quot;%s: &quot; format,	\</span>
<span class="cp">				MY_NAME , ## arg);	\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define FOUND_APCI 0x61504349</span>
<span class="cm">/* these are the names for the IBM ACPI pseudo-device */</span>
<span class="cp">#define IBM_HARDWARE_ID1 &quot;IBM37D0&quot;</span>
<span class="cp">#define IBM_HARDWARE_ID2 &quot;IBM37D4&quot;</span>

<span class="cp">#define hpslot_to_sun(A) (((struct slot *)((A)-&gt;private))-&gt;acpi_slot-&gt;sun)</span>

<span class="cm">/* union apci_descriptor - allows access to the</span>
<span class="cm"> * various device descriptors that are embedded in the</span>
<span class="cm"> * aPCI table</span>
<span class="cm"> */</span>
<span class="k">union</span> <span class="n">apci_descriptor</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">u8</span>   <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span>  <span class="n">type</span><span class="p">;</span>
		<span class="n">u8</span>  <span class="n">len</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">slot_id</span><span class="p">;</span>
		<span class="n">u8</span>  <span class="n">bus_id</span><span class="p">;</span>
		<span class="n">u8</span>  <span class="n">dev_num</span><span class="p">;</span>
		<span class="n">u8</span>  <span class="n">slot_num</span><span class="p">;</span>
		<span class="n">u8</span>  <span class="n">slot_attr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">u8</span>  <span class="n">attn</span><span class="p">;</span>
		<span class="n">u8</span>  <span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">u8</span>  <span class="n">sun</span><span class="p">;</span>
		<span class="n">u8</span>  <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">generic</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* struct notification - keeps info about the device</span>
<span class="cm"> * that cause the ACPI notification event</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">notification</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="n">u8</span>                  <span class="n">event</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ibm_set_attention_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ibm_get_attention_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">status</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ibm_handle_events</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ibm_get_table_from_acpi</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">bufp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ibm_read_apci_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="k">static</span> <span class="n">acpi_status</span> <span class="n">__init</span> <span class="n">ibm_find_acpi_device</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">lvl</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">rv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">ibm_acpiphp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="n">ibm_acpiphp_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="n">acpi_handle</span> <span class="n">ibm_acpi_handle</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">notification</span> <span class="n">ibm_note</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">ibm_apci_table_attr</span> <span class="o">=</span> <span class="p">{</span>
	    <span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;apci_table&quot;</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">,</span>
	    <span class="p">},</span>
	    <span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ibm_read_apci_table</span><span class="p">,</span>
	    <span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">acpiphp_attention_info</span> <span class="n">ibm_attention_info</span> <span class="o">=</span> 
<span class="p">{</span>
	<span class="p">.</span><span class="n">set_attn</span> <span class="o">=</span> <span class="n">ibm_set_attention_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_attn</span> <span class="o">=</span> <span class="n">ibm_get_attention_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ibm_slot_from_id - workaround for bad ibm hardware</span>
<span class="cm"> * @id: the slot number that linux refers to the slot by</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This method returns the aCPI slot descriptor</span>
<span class="cm"> * corresponding to the Linux slot number.  This descriptor</span>
<span class="cm"> * has info about the aPCI slot id and attention status.</span>
<span class="cm"> * This descriptor must be freed using kfree when done.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">union</span> <span class="n">apci_descriptor</span> <span class="o">*</span><span class="nf">ibm_slot_from_id</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">apci_descriptor</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">des</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">ibm_get_table_from_acpi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">);</span>
	<span class="n">des</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">apci_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">table</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">des</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">sig</span><span class="p">,</span> <span class="s">&quot;aPCI&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ibm_slot_done</span><span class="p">;</span>

	<span class="n">des</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">apci_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="n">ind</span> <span class="o">+=</span> <span class="n">des</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">];</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ind</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">des</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="mh">0x82</span> <span class="o">||</span>
			<span class="n">des</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">.</span><span class="n">slot_num</span> <span class="o">!=</span> <span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">des</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">apci_descriptor</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="n">ind</span> <span class="o">+=</span> <span class="n">des</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">.</span><span class="n">len</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ind</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">des</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">.</span><span class="n">slot_num</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">des</span><span class="p">;</span>

<span class="nl">ibm_slot_done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">apci_descriptor</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">des</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">apci_descriptor</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ibm_set_attention_status - callback method to set the attention LED</span>
<span class="cm"> * @slot: the hotplug_slot to work with</span>
<span class="cm"> * @status: what to set the LED to (0 or 1)</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This method is registered with the acpiphp module as a</span>
<span class="cm"> * callback to do the device specific task of setting the LED status.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ibm_set_attention_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> 
	<span class="k">struct</span> <span class="n">acpi_object_list</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">args</span><span class="p">,</span> <span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">};</span>
	<span class="n">acpi_status</span> <span class="n">stat</span><span class="p">;</span> 
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">apci_descriptor</span> <span class="o">*</span><span class="n">ibm_slot</span><span class="p">;</span>

	<span class="n">ibm_slot</span> <span class="o">=</span> <span class="n">ibm_slot_from_id</span><span class="p">(</span><span class="n">hpslot_to_sun</span><span class="p">(</span><span class="n">slot</span><span class="p">));</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: set slot %d (%d) attention status to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">ibm_slot</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">.</span><span class="n">slot_num</span><span class="p">,</span> <span class="n">ibm_slot</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">.</span><span class="n">slot_id</span><span class="p">,</span>
			<span class="p">(</span><span class="n">status</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">ibm_slot</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">.</span><span class="n">slot_id</span><span class="p">;</span>
	<span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ibm_slot</span><span class="p">);</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">ibm_acpi_handle</span><span class="p">,</span> <span class="s">&quot;APLS&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">stat</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;APLS evaluation failed:  0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;APLS method failed:  0x%08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ibm_get_attention_status - callback method to get attention LED status</span>
<span class="cm"> * @slot: the hotplug_slot to work with</span>
<span class="cm"> * @status: returns what the LED is set to (0 or 1)</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This method is registered with the acpiphp module as a</span>
<span class="cm"> * callback to do the device specific task of getting the LED status.</span>
<span class="cm"> * </span>
<span class="cm"> * Because there is no direct method of getting the LED status directly</span>
<span class="cm"> * from an ACPI call, we read the aPCI table and parse out our</span>
<span class="cm"> * slot descriptor to read the status from that.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ibm_get_attention_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">apci_descriptor</span> <span class="o">*</span><span class="n">ibm_slot</span><span class="p">;</span>

	<span class="n">ibm_slot</span> <span class="o">=</span> <span class="n">ibm_slot_from_id</span><span class="p">(</span><span class="n">hpslot_to_sun</span><span class="p">(</span><span class="n">slot</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibm_slot</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">.</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="mh">0xa0</span> <span class="o">||</span> <span class="n">ibm_slot</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: get slot %d (%d) attention status is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">ibm_slot</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">.</span><span class="n">slot_num</span><span class="p">,</span> <span class="n">ibm_slot</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">.</span><span class="n">slot_id</span><span class="p">,</span>
			<span class="o">*</span><span class="n">status</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ibm_slot</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ibm_handle_events - listens for ACPI events for the IBM37D0 device</span>
<span class="cm"> * @handle: an ACPI handle to the device that caused the event</span>
<span class="cm"> * @event: the event info (device specific)</span>
<span class="cm"> * @context: passed context (our notification struct)</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This method is registered as a callback with the ACPI</span>
<span class="cm"> * subsystem it is called when this device has an event to notify the OS of.</span>
<span class="cm"> *</span>
<span class="cm"> * The events actually come from the device as two events that get</span>
<span class="cm"> * synthesized into one event with data by this function.  The event</span>
<span class="cm"> * ID comes first and then the slot number that caused it.  We report</span>
<span class="cm"> * this as one event to the OS.</span>
<span class="cm"> *</span>
<span class="cm"> * From section 5.6.2.2 of the ACPI 2.0 spec, I understand that the OSPM will</span>
<span class="cm"> * only re-enable the interrupt that causes this event AFTER this method</span>
<span class="cm"> * has returned, thereby enforcing serial access for the notification struct.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ibm_handle_events</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">detail</span> <span class="o">=</span> <span class="n">event</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">subevent</span> <span class="o">=</span> <span class="n">event</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">notification</span> <span class="o">*</span><span class="n">note</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: Received notification %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subevent</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: generationg bus event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">acpi_bus_generate_proc_event</span><span class="p">(</span><span class="n">note</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">note</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">detail</span><span class="p">);</span>
		<span class="n">acpi_bus_generate_netlink_event</span><span class="p">(</span><span class="n">note</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">device_class</span><span class="p">,</span>
						  <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">note</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
						  <span class="n">note</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">detail</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">note</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ibm_get_table_from_acpi - reads the APLS buffer from ACPI</span>
<span class="cm"> * @bufp: address to pointer to allocate for the table</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This method reads the APLS buffer in from ACPI and</span>
<span class="cm"> * stores the &quot;stripped&quot; table into a single buffer</span>
<span class="cm"> * it allocates and passes the address back in bufp.</span>
<span class="cm"> *</span>
<span class="cm"> * If NULL is passed in as buffer, this method only calculates</span>
<span class="cm"> * the size of the table and returns that without filling</span>
<span class="cm"> * in the buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns &lt; 0 on error or the size of the table on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ibm_get_table_from_acpi</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">bufp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">package</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">lbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">ibm_acpi_handle</span><span class="p">,</span> <span class="s">&quot;APCI&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s:  APCI evaluation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">package</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">package</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">package</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_PACKAGE</span><span class="p">)</span> <span class="o">||</span>
			<span class="o">!</span><span class="p">(</span><span class="n">package</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s:  Invalid APCI object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">read_table_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">package</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">package</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s:  Invalid APCI element %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">read_table_done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">package</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bufp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">read_table_done</span><span class="p">;</span>

	<span class="n">lbuf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: element count: %i, ASL table size: %i, &amp;table = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">package</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">lbuf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">bufp</span> <span class="o">=</span> <span class="n">lbuf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">read_table_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">package</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lbuf</span><span class="p">[</span><span class="n">size</span><span class="p">],</span>
				<span class="n">package</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span>
				<span class="n">package</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">package</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">read_table_done:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ibm_read_apci_table - callback for the sysfs apci_table file</span>
<span class="cm"> * @filp: the open sysfs file</span>
<span class="cm"> * @kobj: the kobject this binary attribute is a part of</span>
<span class="cm"> * @bin_attr: struct bin_attribute for this file</span>
<span class="cm"> * @buffer: the kernel space buffer to fill</span>
<span class="cm"> * @pos: the offset into the file</span>
<span class="cm"> * @size: the number of bytes requested</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Gets registered with sysfs as the reader callback</span>
<span class="cm"> * to be executed when /sys/bus/pci/slots/apci_table gets read.</span>
<span class="cm"> *</span>
<span class="cm"> * Since we don&#39;t get notified on open and close for this file,</span>
<span class="cm"> * things get really tricky here...</span>
<span class="cm"> * our solution is to only allow reading the table in all at once.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ibm_read_apci_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bytes_read</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: pos = %d, size = %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bytes_read</span> <span class="o">=</span> <span class="n">ibm_get_table_from_acpi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_read</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">bytes_read</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">bytes_read</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">bytes_read</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ibm_find_acpi_device - callback to find our ACPI device</span>
<span class="cm"> * @handle: the ACPI handle of the device we are inspecting</span>
<span class="cm"> * @lvl: depth into the namespace tree</span>
<span class="cm"> * @context: a pointer to our handle to fill when we find the device</span>
<span class="cm"> * @rv: a return value to fill if desired</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Used as a callback when calling acpi_walk_namespace</span>
<span class="cm"> * to find our device.  When this method returns non-zero</span>
<span class="cm"> * acpi_walk_namespace quits its search and returns our value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">acpi_status</span> <span class="n">__init</span> <span class="nf">ibm_find_acpi_device</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">lvl</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">rv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_handle</span> <span class="o">*</span><span class="n">phandle</span> <span class="o">=</span> <span class="p">(</span><span class="n">acpi_handle</span> <span class="o">*</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span> 
	<span class="k">struct</span> <span class="n">acpi_device_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_object_info</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s:  Failed to get device information status=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">current_status</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">ACPI_VALID_HID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hardware_id</span><span class="p">.</span><span class="n">string</span><span class="p">,</span> <span class="n">IBM_HARDWARE_ID1</span><span class="p">)</span> <span class="o">||</span>
			 <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hardware_id</span><span class="p">.</span><span class="n">string</span><span class="p">,</span> <span class="n">IBM_HARDWARE_ID2</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;found hardware: %s, handle: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">hardware_id</span><span class="p">.</span><span class="n">string</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="o">*</span><span class="n">phandle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
		<span class="cm">/* returning non-zero causes the search to stop</span>
<span class="cm">		 * and returns this value to the caller of </span>
<span class="cm">		 * acpi_walk_namespace, but it also causes some warnings</span>
<span class="cm">		 * in the acpi debug code to print...</span>
<span class="cm">		 */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">FOUND_APCI</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ibm_acpiphp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">sysdir</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci_slots_kset</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_walk_namespace</span><span class="p">(</span><span class="n">ACPI_TYPE_DEVICE</span><span class="p">,</span> <span class="n">ACPI_ROOT_OBJECT</span><span class="p">,</span>
			<span class="n">ACPI_UINT32_MAX</span><span class="p">,</span> <span class="n">ibm_find_acpi_device</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ibm_acpi_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FOUND_APCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s: acpi_walk_namespace failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: found IBM aPCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_bus_get_device</span><span class="p">(</span><span class="n">ibm_acpi_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s: acpi_bus_get_device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpiphp_register_attention</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ibm_attention_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ibm_note</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_install_notify_handler</span><span class="p">(</span><span class="n">ibm_acpi_handle</span><span class="p">,</span>
			<span class="n">ACPI_DEVICE_NOTIFY</span><span class="p">,</span> <span class="n">ibm_handle_events</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ibm_note</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s: Failed to register notification handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ibm_apci_table_attr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">ibm_get_table_from_acpi</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="n">sysdir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ibm_apci_table_attr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">init_cleanup:</span>
	<span class="n">acpiphp_unregister_attention</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ibm_attention_info</span><span class="p">);</span>
<span class="nl">init_return:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ibm_acpiphp_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">sysdir</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci_slots_kset</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpiphp_unregister_attention</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ibm_attention_info</span><span class="p">))</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s: attention info deregistration failed&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_remove_notify_handler</span><span class="p">(</span>
			   <span class="n">ibm_acpi_handle</span><span class="p">,</span>
			   <span class="n">ACPI_DEVICE_NOTIFY</span><span class="p">,</span>
			   <span class="n">ibm_handle_events</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s: Notification handler removal failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/* remove the /sys entries */</span>
	<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="n">sysdir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ibm_apci_table_attr</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ibm_acpiphp_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ibm_acpiphp_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
