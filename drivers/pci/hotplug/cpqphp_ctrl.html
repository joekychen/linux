<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pci › hotplug › cpqphp_ctrl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cpqphp_ctrl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Compaq Hot Plug Controller Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1995,2001 Compaq Computer Corporation</span>
<span class="cm"> * Copyright (C) 2001 Greg Kroah-Hartman (greg@kroah.com)</span>
<span class="cm"> * Copyright (C) 2001 IBM Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> * your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or</span>
<span class="cm"> * NON INFRINGEMENT.  See the GNU General Public License for more</span>
<span class="cm"> * details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Send feedback to &lt;greg@kroah.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pci_hotplug.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &quot;cpqphp.h&quot;</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">configure_new_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span><span class="o">*</span> <span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">behind_bridge</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource_lists</span> <span class="o">*</span><span class="n">resources</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">configure_new_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span><span class="o">*</span> <span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">behind_bridge</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource_lists</span> <span class="o">*</span><span class="n">resources</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">interrupt_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">cpqhp_event_thread</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pushbutton_pending</span><span class="p">;</span>	<span class="cm">/* = 0 */</span>

<span class="cm">/* delay is in jiffies to wait for */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">long_delay</span><span class="p">(</span><span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * XXX(hch): if someone is bored please convert all callers</span>
<span class="cm">	 * to call msleep_interruptible directly.  They really want</span>
<span class="cm">	 * to specify timeouts in natural units and spend a lot of</span>
<span class="cm">	 * effort converting them to jiffies..</span>
<span class="cm">	 */</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">delay</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/* FIXME: The following line needs to be somewhere else... */</span>
<span class="cp">#define WRONG_BUS_FREQUENCY 0x07</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">handle_switch_change</span><span class="p">(</span><span class="n">u8</span> <span class="n">change</span><span class="p">,</span> <span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hp_slot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temp_word</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_info</span> <span class="o">*</span><span class="n">taskInfo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">change</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Switch Change */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;cpqsbd:  Switch interrupt received.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">hp_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hp_slot</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">hp_slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">change</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1L</span> <span class="o">&lt;&lt;</span> <span class="n">hp_slot</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * this one changed.</span>
<span class="cm">			 */</span>
			<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span>
				<span class="p">(</span><span class="n">hp_slot</span> <span class="o">+</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* this is the structure that tells the worker thread</span>
<span class="cm">			 * what to do</span>
<span class="cm">			 */</span>
			<span class="n">taskInfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">next_event</span><span class="p">]);</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">next_event</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">next_event</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">taskInfo</span><span class="o">-&gt;</span><span class="n">hp_slot</span> <span class="o">=</span> <span class="n">hp_slot</span><span class="p">;</span>

			<span class="n">rc</span><span class="o">++</span><span class="p">;</span>

			<span class="n">temp_word</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">presence_save</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_word</span> <span class="o">&gt;&gt;</span> <span class="n">hp_slot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">presence_save</span> <span class="o">|=</span> <span class="p">(</span><span class="n">temp_word</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">hp_slot</span> <span class="o">+</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1L</span> <span class="o">&lt;&lt;</span> <span class="n">hp_slot</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Switch opened</span>
<span class="cm">				 */</span>

				<span class="n">func</span><span class="o">-&gt;</span><span class="n">switch_save</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">taskInfo</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">INT_SWITCH_OPEN</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Switch closed</span>
<span class="cm">				 */</span>

				<span class="n">func</span><span class="o">-&gt;</span><span class="n">switch_save</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>

				<span class="n">taskInfo</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">INT_SWITCH_CLOSE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cpqhp_find_slot - find the struct slot of given device</span>
<span class="cm"> * @ctrl: scan lots of this controller</span>
<span class="cm"> * @device: the device id to find</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="nf">cpqhp_find_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">device</span><span class="p">))</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">slot</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">u8</span> <span class="nf">handle_presence_change</span><span class="p">(</span><span class="n">u16</span> <span class="n">change</span><span class="p">,</span> <span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hp_slot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">temp_byte</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temp_word</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_info</span> <span class="o">*</span><span class="n">taskInfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">p_slot</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">change</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Presence Change</span>
<span class="cm">	 */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;cpqsbd:  Presence/Notify input change.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;         Changed bits are 0x%4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">change</span> <span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">hp_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hp_slot</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">hp_slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">change</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x0101</span> <span class="o">&lt;&lt;</span> <span class="n">hp_slot</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * this one changed.</span>
<span class="cm">			 */</span>
			<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span>
				<span class="p">(</span><span class="n">hp_slot</span> <span class="o">+</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">taskInfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">next_event</span><span class="p">]);</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">next_event</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">next_event</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">taskInfo</span><span class="o">-&gt;</span><span class="n">hp_slot</span> <span class="o">=</span> <span class="n">hp_slot</span><span class="p">;</span>

			<span class="n">rc</span><span class="o">++</span><span class="p">;</span>

			<span class="n">p_slot</span> <span class="o">=</span> <span class="n">cpqhp_find_slot</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span> <span class="o">+</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_slot</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* If the switch closed, must be a button</span>
<span class="cm">			 * If not in button mode, nevermind</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">switch_save</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">push_button</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">temp_word</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">temp_byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_word</span> <span class="o">&gt;&gt;</span> <span class="n">hp_slot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="n">temp_byte</span> <span class="o">|=</span> <span class="p">(</span><span class="n">temp_word</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">hp_slot</span> <span class="o">+</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">temp_byte</span> <span class="o">!=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">presence_save</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * button Pressed (doesn&#39;t do anything)</span>
<span class="cm">					 */</span>
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;hp_slot %d button pressed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
					<span class="n">taskInfo</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">INT_BUTTON_PRESS</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * button Released - TAKE ACTION!!!!</span>
<span class="cm">					 */</span>
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;hp_slot %d button released</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
					<span class="n">taskInfo</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">INT_BUTTON_RELEASE</span><span class="p">;</span>

					<span class="cm">/* Cancel if we are still blinking */</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BLINKINGON_STATE</span><span class="p">)</span>
					    <span class="o">||</span> <span class="p">(</span><span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BLINKINGOFF_STATE</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">taskInfo</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">INT_BUTTON_CANCEL</span><span class="p">;</span>
						<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;hp_slot %d button cancel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">POWERON_STATE</span><span class="p">)</span>
						   <span class="o">||</span> <span class="p">(</span><span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">POWEROFF_STATE</span><span class="p">))</span> <span class="p">{</span>
						<span class="cm">/* info(msg_button_ignore, p_slot-&gt;number); */</span>
						<span class="n">taskInfo</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">INT_BUTTON_IGNORE</span><span class="p">;</span>
						<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;hp_slot %d button ignore</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Switch is open, assume a presence change</span>
<span class="cm">				 * Save the presence state</span>
<span class="cm">				 */</span>
				<span class="n">temp_word</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">presence_save</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_word</span> <span class="o">&gt;&gt;</span> <span class="n">hp_slot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">presence_save</span> <span class="o">|=</span> <span class="p">(</span><span class="n">temp_word</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">hp_slot</span> <span class="o">+</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x010000</span> <span class="o">&lt;&lt;</span> <span class="n">hp_slot</span><span class="p">)))</span> <span class="o">||</span>
				    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x01000000</span> <span class="o">&lt;&lt;</span> <span class="n">hp_slot</span><span class="p">))))</span> <span class="p">{</span>
					<span class="cm">/* Present */</span>
					<span class="n">taskInfo</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">INT_PRESENCE_ON</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Not Present */</span>
					<span class="n">taskInfo</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">INT_PRESENCE_OFF</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">u8</span> <span class="nf">handle_power_fault</span><span class="p">(</span><span class="n">u8</span> <span class="n">change</span><span class="p">,</span> <span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hp_slot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_info</span> <span class="o">*</span><span class="n">taskInfo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">change</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * power fault</span>
<span class="cm">	 */</span>

	<span class="n">info</span><span class="p">(</span><span class="s">&quot;power fault interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">hp_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hp_slot</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">hp_slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">change</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">hp_slot</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * this one changed.</span>
<span class="cm">			 */</span>
			<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span>
				<span class="p">(</span><span class="n">hp_slot</span> <span class="o">+</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">taskInfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">next_event</span><span class="p">]);</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">next_event</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">next_event</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">taskInfo</span><span class="o">-&gt;</span><span class="n">hp_slot</span> <span class="o">=</span> <span class="n">hp_slot</span><span class="p">;</span>

			<span class="n">rc</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x00000100</span> <span class="o">&lt;&lt;</span> <span class="n">hp_slot</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * power fault Cleared</span>
<span class="cm">				 */</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

				<span class="n">taskInfo</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">INT_POWER_FAULT_CLEAR</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * power fault</span>
<span class="cm">				 */</span>
				<span class="n">taskInfo</span><span class="o">-&gt;</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">INT_POWER_FAULT</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">amber_LED_on</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
					<span class="n">green_LED_off</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
					<span class="n">set_SOGO</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

					<span class="cm">/* this is a fatal condition, we want</span>
<span class="cm">					 * to crash the machine to protect from</span>
<span class="cm">					 * data corruption. simulated_NMI</span>
<span class="cm">					 * shouldn&#39;t ever return */</span>
					<span class="cm">/* FIXME</span>
<span class="cm">					simulated_NMI(hp_slot, ctrl); */</span>

					<span class="cm">/* The following code causes a software</span>
<span class="cm">					 * crash just in case simulated_NMI did</span>
<span class="cm">					 * return */</span>
					<span class="cm">/*FIXME</span>
<span class="cm">					panic(msg_power_fault); */</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* set power fault status for this board */</span>
					<span class="n">func</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
					<span class="n">info</span><span class="p">(</span><span class="s">&quot;power fault bit %x set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * sort_by_size - sort nodes on the list by their length, smallest first.</span>
<span class="cm"> * @head: list to sort</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sort_by_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">**</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">current_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">next_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">out_of_order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">out_of_order</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_of_order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Special case for swapping list head */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">out_of_order</span><span class="o">++</span><span class="p">;</span>
			<span class="n">current_res</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
			<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">current_res</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">current_res</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">&amp;&amp;</span> <span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">out_of_order</span><span class="o">++</span><span class="p">;</span>
				<span class="n">next_res</span> <span class="o">=</span> <span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">current_res</span> <span class="o">=</span> <span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">next_res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">next_res</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">current_res</span> <span class="o">=</span> <span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>  <span class="cm">/* End of out_of_order loop */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * sort_by_max_size - sort nodes on the list by their length, largest first.</span>
<span class="cm"> * @head: list to sort</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sort_by_max_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">**</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">current_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">next_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">out_of_order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">out_of_order</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_of_order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Special case for swapping list head */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">out_of_order</span><span class="o">++</span><span class="p">;</span>
			<span class="n">current_res</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
			<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">current_res</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">current_res</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">&amp;&amp;</span> <span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">out_of_order</span><span class="o">++</span><span class="p">;</span>
				<span class="n">next_res</span> <span class="o">=</span> <span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">current_res</span> <span class="o">=</span> <span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">next_res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">next_res</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">current_res</span> <span class="o">=</span> <span class="n">current_res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>  <span class="cm">/* End of out_of_order loop */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * do_pre_bridge_resource_split - find node of resources that are unused</span>
<span class="cm"> * @head: new list head</span>
<span class="cm"> * @orig_head: original list head</span>
<span class="cm"> * @alignment: max node size (?)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="nf">do_pre_bridge_resource_split</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">**</span><span class="n">head</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">**</span><span class="n">orig_head</span><span class="p">,</span> <span class="n">u32</span> <span class="n">alignment</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">prevnode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">split_node</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_dword</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;do_pre_bridge_resource_split</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">orig_head</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">!=</span> <span class="p">(</span><span class="o">*</span><span class="n">orig_head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="p">(</span><span class="o">*</span><span class="n">orig_head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>


	<span class="cm">/* If we got here, there the bridge requires some of the resource, but</span>
<span class="cm">	 * we may be able to split some off of the front</span>
<span class="cm">	 */</span>

	<span class="n">node</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">alignment</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* this one isn&#39;t an aligned length, so we&#39;ll make a new entry</span>
<span class="cm">		 * and split it up.</span>
<span class="cm">		 */</span>
		<span class="n">split_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">split_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">split_node</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">temp_dword</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">|</span> <span class="p">(</span><span class="n">alignment</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alignment</span><span class="p">;</span>

		<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
		<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">temp_dword</span><span class="p">;</span>

		<span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-=</span> <span class="n">temp_dword</span><span class="p">;</span>
		<span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+=</span> <span class="n">split_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

		<span class="cm">/* Put it in the list */</span>
		<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">split_node</span><span class="p">;</span>
		<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">alignment</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Now unlink it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span> <span class="o">==</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">prevnode</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">prevnode</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">node</span><span class="p">)</span>
			<span class="n">prevnode</span> <span class="o">=</span> <span class="n">prevnode</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="n">prevnode</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">node</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * do_bridge_resource_split - find one node of resources that aren&#39;t in use</span>
<span class="cm"> * @head: list head</span>
<span class="cm"> * @alignment: max node size (?)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="nf">do_bridge_resource_split</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">**</span><span class="n">head</span><span class="p">,</span> <span class="n">u32</span> <span class="n">alignment</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">prevnode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_dword</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">node</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prevnode</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">prevnode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">alignment</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">alignment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Short circuit if adjusted size is too small */</span>
		<span class="n">temp_dword</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">|</span> <span class="p">(</span><span class="n">alignment</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="p">(</span><span class="n">temp_dword</span> <span class="o">-</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">alignment</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-=</span> <span class="p">(</span><span class="n">temp_dword</span> <span class="o">-</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">temp_dword</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">alignment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="cm">/* There&#39;s stuff in use after this node */</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">node</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * get_io_resource - find first node of given size not in ISA aliasing window.</span>
<span class="cm"> * @head: list to search</span>
<span class="cm"> * @size: size of node to find, must be a power of two.</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function sorts the resource list by size and then returns</span>
<span class="cm"> * returns the first node of &quot;size&quot; length that is not in the ISA aliasing</span>
<span class="cm"> * window.  If it finds a node larger than &quot;size&quot; it will split it up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="nf">get_io_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">**</span><span class="n">head</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">prevnode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">split_node</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_dword</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sort_by_size</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">node</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span> <span class="n">node</span><span class="p">;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* this one isn&#39;t base aligned properly</span>
<span class="cm">			 * so we&#39;ll make a new entry and split it up</span>
<span class="cm">			 */</span>
			<span class="n">temp_dword</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">|</span> <span class="p">(</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* Short circuit if adjusted size is too small */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="p">(</span><span class="n">temp_dword</span> <span class="o">-</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">split_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">split_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">split_node</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">temp_dword</span> <span class="o">-</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">temp_dword</span><span class="p">;</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-=</span> <span class="n">split_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

			<span class="cm">/* Put it in the list */</span>
			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">split_node</span><span class="p">;</span>
		<span class="p">}</span> <span class="cm">/* End of non-aligned base */</span>

		<span class="cm">/* Don&#39;t need to check if too small since we already did */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* this one is longer than we need</span>
<span class="cm">			 * so we&#39;ll make a new entry and split it up</span>
<span class="cm">			 */</span>
			<span class="n">split_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">split_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">split_node</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

			<span class="cm">/* Put it in the list */</span>
			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">split_node</span><span class="p">;</span>
		<span class="p">}</span>  <span class="cm">/* End of too big on top end */</span>

		<span class="cm">/* For IO make sure it&#39;s not in the ISA aliasing space */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x300L</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* If we got here, then it is the right size</span>
<span class="cm">		 * Now take it out of the list and break</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span> <span class="o">==</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">prevnode</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">prevnode</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">node</span><span class="p">)</span>
				<span class="n">prevnode</span> <span class="o">=</span> <span class="n">prevnode</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

			<span class="n">prevnode</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">node</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * get_max_resource - get largest node which has at least the given size.</span>
<span class="cm"> * @head: the list to search the node in</span>
<span class="cm"> * @size: the minimum size of the node to find</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Gets the largest node that is at least &quot;size&quot; big from the</span>
<span class="cm"> * list pointed to by head.  It aligns the node on top and bottom</span>
<span class="cm"> * to &quot;size&quot; alignment before returning it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="nf">get_max_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">**</span><span class="n">head</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">max</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">split_node</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_dword</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sort_by_max_size</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">max</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span> <span class="n">max</span><span class="p">;</span> <span class="n">max</span> <span class="o">=</span> <span class="n">max</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If not big enough we could probably just bail,</span>
<span class="cm">		 * instead we&#39;ll continue to the next.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* this one isn&#39;t base aligned properly</span>
<span class="cm">			 * so we&#39;ll make a new entry and split it up</span>
<span class="cm">			 */</span>
			<span class="n">temp_dword</span> <span class="o">=</span> <span class="p">(</span><span class="n">max</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">|</span> <span class="p">(</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* Short circuit if adjusted size is too small */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">max</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="p">(</span><span class="n">temp_dword</span> <span class="o">-</span> <span class="n">max</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">split_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">split_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">split_node</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">max</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">temp_dword</span> <span class="o">-</span> <span class="n">max</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
			<span class="n">max</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">temp_dword</span><span class="p">;</span>
			<span class="n">max</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-=</span> <span class="n">split_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">max</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">max</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">split_node</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">max</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">max</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* this one isn&#39;t end aligned properly at the top</span>
<span class="cm">			 * so we&#39;ll make a new entry and split it up</span>
<span class="cm">			 */</span>
			<span class="n">split_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">split_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">split_node</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">temp_dword</span> <span class="o">=</span> <span class="p">((</span><span class="n">max</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">max</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">temp_dword</span><span class="p">;</span>
			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">max</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="n">max</span><span class="o">-&gt;</span><span class="n">base</span>
					     <span class="o">-</span> <span class="n">split_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
			<span class="n">max</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-=</span> <span class="n">split_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">max</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">max</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">split_node</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Make sure it didn&#39;t shrink too much when we aligned it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Now take it out of the list */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">max</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;&amp;</span> <span class="n">temp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">temp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">max</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">max</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">max</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * get_resource - find resource of given size and split up larger ones.</span>
<span class="cm"> * @head: the list to search for resources</span>
<span class="cm"> * @size: the size limit to use</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function sorts the resource list by size and then</span>
<span class="cm"> * returns the first node of &quot;size&quot; length.  If it finds a node</span>
<span class="cm"> * larger than &quot;size&quot; it will split it up.</span>
<span class="cm"> *</span>
<span class="cm"> * size must be a power of two.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="nf">get_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">**</span><span class="n">head</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">prevnode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">split_node</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_dword</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sort_by_size</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">node</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span> <span class="n">node</span><span class="p">;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: req_size =%x node=%p, base=%x, length=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: not aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="cm">/* this one isn&#39;t base aligned properly</span>
<span class="cm">			 * so we&#39;ll make a new entry and split it up</span>
<span class="cm">			 */</span>
			<span class="n">temp_dword</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">|</span> <span class="p">(</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* Short circuit if adjusted size is too small */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="p">(</span><span class="n">temp_dword</span> <span class="o">-</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">split_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">split_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">split_node</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">temp_dword</span> <span class="o">-</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">temp_dword</span><span class="p">;</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-=</span> <span class="n">split_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">split_node</span><span class="p">;</span>
		<span class="p">}</span> <span class="cm">/* End of non-aligned base */</span>

		<span class="cm">/* Don&#39;t need to check if too small since we already did */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: too big</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="cm">/* this one is longer than we need</span>
<span class="cm">			 * so we&#39;ll make a new entry and split it up</span>
<span class="cm">			 */</span>
			<span class="n">split_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">split_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">split_node</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

			<span class="cm">/* Put it in the list */</span>
			<span class="n">split_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">split_node</span><span class="p">;</span>
		<span class="p">}</span>  <span class="cm">/* End of too big on top end */</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: got one!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="cm">/* If we got here, then it is the right size</span>
<span class="cm">		 * Now take it out of the list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span> <span class="o">==</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">prevnode</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">prevnode</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">node</span><span class="p">)</span>
				<span class="n">prevnode</span> <span class="o">=</span> <span class="n">prevnode</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

			<span class="n">prevnode</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">node</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * cpqhp_resource_sort_and_combine - sort nodes by base addresses and clean up</span>
<span class="cm"> * @head: the list to sort and clean up</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Sorts all of the nodes in the list in ascending order by</span>
<span class="cm"> * their base addresses.  Also does garbage collection by</span>
<span class="cm"> * combining adjacent nodes.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns %0 if success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">**</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">node1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">node2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">out_of_order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: head = %p, *head = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">head</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;*head-&gt;next = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* only one item on the list, already sorted! */</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;*head-&gt;base = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;*head-&gt;next-&gt;base = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">out_of_order</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_of_order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Special case for swapping list head */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">node1</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">node1</span><span class="p">;</span>
			<span class="n">out_of_order</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">node1</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">&amp;&amp;</span> <span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&gt;</span> <span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">out_of_order</span><span class="o">++</span><span class="p">;</span>
				<span class="n">node2</span> <span class="o">=</span> <span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">node1</span> <span class="o">=</span> <span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">node2</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">node2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">node1</span> <span class="o">=</span> <span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>  <span class="cm">/* End of out_of_order loop */</span>

	<span class="n">node1</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">node1</span> <span class="o">&amp;&amp;</span> <span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">node1</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">node1</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">==</span> <span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Combine */</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;8..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">node1</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+=</span> <span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
			<span class="n">node2</span> <span class="o">=</span> <span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">node2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">node1</span> <span class="o">=</span> <span class="n">node1</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">irqreturn_t</span> <span class="nf">cpqhp_ctrl_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">IRQ</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">schedule_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">misc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">Diff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_dword</span><span class="p">;</span>


	<span class="n">misc</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">MISC</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check to see if it was our interrupt</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="mh">0x000C</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="mh">0x0004</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Serial Output interrupt Pending</span>
<span class="cm">		 */</span>

		<span class="cm">/* Clear the interrupt */</span>
		<span class="n">misc</span> <span class="o">|=</span> <span class="mh">0x0004</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">misc</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">MISC</span><span class="p">);</span>

		<span class="cm">/* Read to clear posted writes */</span>
		<span class="n">misc</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">MISC</span><span class="p">);</span>

		<span class="n">dbg</span> <span class="p">(</span><span class="s">&quot;%s - waking up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="mh">0x0008</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* General-interrupt-input interrupt Pending */</span>
		<span class="n">Diff</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">INT_INPUT_CLEAR</span><span class="p">)</span> <span class="o">^</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span><span class="p">;</span>

		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">INT_INPUT_CLEAR</span><span class="p">);</span>

		<span class="cm">/* Clear the interrupt */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">Diff</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">INT_INPUT_CLEAR</span><span class="p">);</span>

		<span class="cm">/* Read it back to clear any posted writes */</span>
		<span class="n">temp_dword</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">INT_INPUT_CLEAR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Diff</span><span class="p">)</span>
			<span class="cm">/* Clear all interrupts */</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">INT_INPUT_CLEAR</span><span class="p">);</span>

		<span class="n">schedule_flag</span> <span class="o">+=</span> <span class="n">handle_switch_change</span><span class="p">((</span><span class="n">u8</span><span class="p">)(</span><span class="n">Diff</span> <span class="o">&amp;</span> <span class="mh">0xFFL</span><span class="p">),</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="n">schedule_flag</span> <span class="o">+=</span> <span class="n">handle_presence_change</span><span class="p">((</span><span class="n">u16</span><span class="p">)((</span><span class="n">Diff</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000L</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="n">schedule_flag</span> <span class="o">+=</span> <span class="n">handle_power_fault</span><span class="p">((</span><span class="n">u8</span><span class="p">)((</span><span class="n">Diff</span> <span class="o">&amp;</span> <span class="mh">0xFF00L</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">reset</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">RESET_FREQ_MODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Bus reset has completed */</span>
		<span class="n">reset</span> <span class="o">&amp;=</span> <span class="mh">0xCF</span><span class="p">;</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">RESET_FREQ_MODE</span><span class="p">);</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">RESET_FREQ_MODE</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">schedule_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wake_up_process</span><span class="p">(</span><span class="n">cpqhp_event_thread</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Waking even thread&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * cpqhp_slot_create - Creates a node and adds it to the proper bus.</span>
<span class="cm"> * @busnumber: bus where new node is to be located</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to the new node or %NULL if unsuccessful.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="nf">cpqhp_slot_create</span><span class="p">(</span><span class="n">u8</span> <span class="n">busnumber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">new_slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">new_slot</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_slot</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_slot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">new_slot</span><span class="p">;</span>

	<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="n">busnumber</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="n">busnumber</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_slot</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="n">busnumber</span><span class="p">];</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">new_slot</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">new_slot</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * slot_remove - Removes a node from the linked list of slots.</span>
<span class="cm"> * @old_slot: slot to remove</span>
<span class="cm"> *</span>
<span class="cm"> * Returns %0 if successful, !0 otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">slot_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span> <span class="n">old_slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_slot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">next</span> <span class="o">=</span> <span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="n">old_slot</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="n">old_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="n">old_slot</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_slot</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">cpqhp_destroy_board_resources</span><span class="p">(</span><span class="n">old_slot</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">old_slot</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">old_slot</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">old_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">old_slot</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">cpqhp_destroy_board_resources</span><span class="p">(</span><span class="n">old_slot</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">old_slot</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bridge_slot_remove - Removes a node from the linked list of slots.</span>
<span class="cm"> * @bridge: bridge to remove</span>
<span class="cm"> *</span>
<span class="cm"> * Returns %0 if successful, !0 otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bridge_slot_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">bridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">subordinateBus</span><span class="p">,</span> <span class="n">secondaryBus</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tempBus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">secondaryBus</span> <span class="o">=</span> <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">config_space</span><span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">subordinateBus</span> <span class="o">=</span> <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">config_space</span><span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tempBus</span> <span class="o">=</span> <span class="n">secondaryBus</span><span class="p">;</span> <span class="n">tempBus</span> <span class="o">&lt;=</span> <span class="n">subordinateBus</span><span class="p">;</span> <span class="n">tempBus</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="n">tempBus</span><span class="p">];</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">slot_remove</span><span class="p">(</span><span class="n">next</span><span class="p">))</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="n">tempBus</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">next</span> <span class="o">=</span> <span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="n">bridge</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">]</span> <span class="o">=</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">bridge</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">bridge</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bridge</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * cpqhp_slot_find - Looks for a node by bus, and device, multiple functions accessed</span>
<span class="cm"> * @bus: bus to find</span>
<span class="cm"> * @device: device to find</span>
<span class="cm"> * @index: is %0 for first function found, %1 for the second...</span>
<span class="cm"> *</span>
<span class="cm"> * Returns pointer to the node if successful, %NULL otherwise.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="nf">cpqhp_slot_find</span><span class="p">(</span><span class="n">u8</span> <span class="n">bus</span><span class="p">,</span> <span class="n">u8</span> <span class="n">device</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>

	<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="n">bus</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">device</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">func</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">device</span><span class="p">)</span>
		<span class="n">found</span><span class="o">++</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">device</span><span class="p">)</span>
			<span class="n">found</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">func</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* DJZ: I don&#39;t think is_bridge will work as is.</span>
<span class="cm"> * FIXME */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Check the header type */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">config_space</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * set_controller_speed - set the frequency and/or mode of a specific controller segment.</span>
<span class="cm"> * @ctrl: controller to change frequency/mode for.</span>
<span class="cm"> * @adapter_speed: the speed of the adapter we want to match.</span>
<span class="cm"> * @hp_slot: the slot number where the adapter is installed.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns %0 if we successfully change frequency and/or mode to match the</span>
<span class="cm"> * adapter speed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">set_controller_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">adapter_speed</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hp_slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">slot_power</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_POWER</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">reg16</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">leds</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">LED_CONTROL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">==</span> <span class="n">adapter_speed</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t allow freq/mode changes if we find another adapter running</span>
<span class="cm">	 * in another slot on this controller</span>
<span class="cm">	 */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">slot</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">;</span> <span class="n">slot</span><span class="p">;</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="p">(</span><span class="n">hp_slot</span> <span class="o">+</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">hotplug_slot</span> <span class="o">||</span> <span class="o">!</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* If another adapter is running on the same segment but at a</span>
<span class="cm">		 * lower speed/mode, we allow the new adapter to function at</span>
<span class="cm">		 * this rate if supported</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">&lt;</span> <span class="n">adapter_speed</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If the controller doesn&#39;t support freq/mode changes and the</span>
<span class="cm">	 * controller is running at a higher mode, we bail</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">&gt;</span> <span class="n">adapter_speed</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_speed_capability</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* But we allow the adapter to run at a lower rate if possible */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">&lt;</span> <span class="n">adapter_speed</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pcix_speed_capability</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We try to set the max speed supported by both the adapter and</span>
<span class="cm">	 * controller</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">&lt;</span> <span class="n">adapter_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">==</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">adapter_speed</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0L</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">LED_CONTROL</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_ENABLE</span><span class="p">);</span>

	<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">wait_for_ctrl_irq</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter_speed</span> <span class="o">!=</span> <span class="n">PCI_SPEED_133MHz_PCIX</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0xF5</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0xF4</span><span class="p">;</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg16</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">NEXT_CURR_FREQ</span><span class="p">);</span>
	<span class="n">reg16</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x000F</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">adapter_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span><span class="p">(</span><span class="n">PCI_SPEED_133MHz_PCIX</span><span class="p">)</span>:
			<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x75</span><span class="p">;</span>
			<span class="n">reg16</span> <span class="o">|=</span> <span class="mh">0xB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span><span class="p">(</span><span class="n">PCI_SPEED_100MHz_PCIX</span><span class="p">)</span>:
			<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x74</span><span class="p">;</span>
			<span class="n">reg16</span> <span class="o">|=</span> <span class="mh">0xA</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span><span class="p">(</span><span class="n">PCI_SPEED_66MHz_PCIX</span><span class="p">)</span>:
			<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x73</span><span class="p">;</span>
			<span class="n">reg16</span> <span class="o">|=</span> <span class="mh">0x9</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span><span class="p">(</span><span class="n">PCI_SPEED_66MHz</span><span class="p">)</span>:
			<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x73</span><span class="p">;</span>
			<span class="n">reg16</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="cm">/* 33MHz PCI 2.2 */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x71</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">reg16</span> <span class="o">|=</span> <span class="mh">0xB</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">reg16</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">NEXT_CURR_FREQ</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Reenable interrupts */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">INT_MASK</span><span class="p">);</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Restart state machine */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="o">~</span><span class="mh">0xF</span><span class="p">;</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Only if mode change...*/</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">==</span> <span class="n">PCI_SPEED_66MHz</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">adapter_speed</span> <span class="o">==</span> <span class="n">PCI_SPEED_66MHz_PCIX</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">==</span> <span class="n">PCI_SPEED_66MHz_PCIX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">adapter_speed</span> <span class="o">==</span> <span class="n">PCI_SPEED_66MHz</span><span class="p">)))</span> 
			<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">wait_for_ctrl_irq</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1100</span><span class="p">);</span>

	<span class="cm">/* Restore LED/Slot state */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">leds</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">LED_CONTROL</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">slot_power</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_ENABLE</span><span class="p">);</span>

	<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">wait_for_ctrl_irq</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">=</span> <span class="n">adapter_speed</span><span class="p">;</span>
	<span class="n">slot</span> <span class="o">=</span> <span class="n">cpqhp_find_slot</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span> <span class="o">+</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">);</span>

	<span class="n">info</span><span class="p">(</span><span class="s">&quot;Successfully changed frequency/mode for adapter in slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* the following routines constitute the bulk of the</span>
<span class="cm"> * hotplug controller logic</span>
<span class="cm"> */</span>


<span class="cm">/**</span>
<span class="cm"> * board_replaced - Called after a board has been replaced in the system.</span>
<span class="cm"> * @func: PCI device/function information</span>
<span class="cm"> * @ctrl: hotplug controller</span>
<span class="cm"> *</span>
<span class="cm"> * This is only used if we don&#39;t have resources for hot add.</span>
<span class="cm"> * Turns power on for the board.</span>
<span class="cm"> * Checks to see if board is the same.</span>
<span class="cm"> * If board is same, reconfigures it.</span>
<span class="cm"> * If board isn&#39;t same, turns it back off.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">board_replaced</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hp_slot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">temp_byte</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">adapter_speed</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hp_slot</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">-</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The switch is open.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">INT_INPUT_CLEAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x01L</span> <span class="o">&lt;&lt;</span> <span class="n">hp_slot</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">INTERLOCK_OPEN</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The board is already on</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_slot_enabled</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">CARD_FUNCTIONING</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

		<span class="cm">/* turn on board without attaching to the bus */</span>
		<span class="n">enable_slot_power</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

		<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/* Wait for SOBS to be unset */</span>
		<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/* Change bits in slot power register to force another shift out</span>
<span class="cm">		 * NOTE: this is to work around the timer bug */</span>
		<span class="n">temp_byte</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_POWER</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_POWER</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">temp_byte</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_POWER</span><span class="p">);</span>

		<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/* Wait for SOBS to be unset */</span>
		<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="n">adapter_speed</span> <span class="o">=</span> <span class="n">get_adapter_speed</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">!=</span> <span class="n">adapter_speed</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">set_controller_speed</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">adapter_speed</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">))</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">WRONG_BUS_FREQUENCY</span><span class="p">;</span>

		<span class="cm">/* turn off board without attaching to the bus */</span>
		<span class="n">disable_slot_power</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

		<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/* Wait for SOBS to be unset */</span>
		<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

		<span class="n">slot_enable</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
		<span class="n">green_LED_blink</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

		<span class="n">amber_LED_off</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

		<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/* Wait for SOBS to be unset */</span>
		<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

		<span class="cm">/* Wait for ~1 second because of hot plug spec */</span>
		<span class="n">long_delay</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

		<span class="cm">/* Check for a power fault */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* power fault occurred, but it was benign */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">POWER_FAILURE</span><span class="p">;</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">cpqhp_valid_replace</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* It must be the same board */</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="n">cpqhp_configure_board</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>

			<span class="cm">/* If configuration fails, turn it off</span>
<span class="cm">			 * Get slot won&#39;t work for devices behind</span>
<span class="cm">			 * bridges, but in this case it will always be</span>
<span class="cm">			 * called for the &quot;base&quot; bus/dev/func of an</span>
<span class="cm">			 * adapter.</span>
<span class="cm">			 */</span>

			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

			<span class="n">amber_LED_on</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
			<span class="n">green_LED_off</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
			<span class="n">slot_disable</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

			<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

			<span class="cm">/* Wait for SOBS to be unset */</span>
			<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Something is wrong</span>

<span class="cm">			 * Get slot won&#39;t work for devices behind bridges, but</span>
<span class="cm">			 * in this case it will always be called for the &quot;base&quot;</span>
<span class="cm">			 * bus/dev/func of an adapter.</span>
<span class="cm">			 */</span>

			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

			<span class="n">amber_LED_on</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
			<span class="n">green_LED_off</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
			<span class="n">slot_disable</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

			<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

			<span class="cm">/* Wait for SOBS to be unset */</span>
			<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * board_added - Called after a board has been added to the system.</span>
<span class="cm"> * @func: PCI device/function info</span>
<span class="cm"> * @ctrl: hotplug controller</span>
<span class="cm"> *</span>
<span class="cm"> * Turns power on for the board.</span>
<span class="cm"> * Configures board.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">board_added</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">hp_slot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">temp_byte</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">adapter_speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_register</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">new_slot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">p_slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_lists</span> <span class="n">res_lists</span><span class="p">;</span>

	<span class="n">hp_slot</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">-</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: func-&gt;device, slot_offset, hp_slot = %d, %d ,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

	<span class="cm">/* turn on board without attaching to the bus */</span>
	<span class="n">enable_slot_power</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

	<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* Wait for SOBS to be unset */</span>
	<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* Change bits in slot power register to force another shift out</span>
<span class="cm">	 * NOTE: this is to work around the timer bug</span>
<span class="cm">	 */</span>
	<span class="n">temp_byte</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_POWER</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_POWER</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">temp_byte</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_POWER</span><span class="p">);</span>

	<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* Wait for SOBS to be unset */</span>
	<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">adapter_speed</span> <span class="o">=</span> <span class="n">get_adapter_speed</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">!=</span> <span class="n">adapter_speed</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_controller_speed</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">adapter_speed</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">WRONG_BUS_FREQUENCY</span><span class="p">;</span>

	<span class="cm">/* turn off board without attaching to the bus */</span>
	<span class="n">disable_slot_power</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

	<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* Wait for SOBS to be unset */</span>
	<span class="n">wait_for_ctrl_irq</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">p_slot</span> <span class="o">=</span> <span class="n">cpqhp_find_slot</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span> <span class="o">+</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">);</span>

	<span class="cm">/* turn on board and blink green LED */</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: before down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: after down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: before slot_enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">slot_enable</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: before green_LED_blink</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">green_LED_blink</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: before amber_LED_blink</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">amber_LED_off</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: before set_SOGO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* Wait for SOBS to be unset */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: before wait_for_ctrl_irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: after wait_for_ctrl_irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: before up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: after up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Wait for ~1 second because of hot plug spec */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: before long_delay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">long_delay</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: after long_delay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: func status = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="cm">/* Check for a power fault */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* power fault occurred, but it was benign */</span>
		<span class="n">temp_register</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: temp register set to %x by power fault</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">temp_register</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">POWER_FAILURE</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Get vendor/device ID u32 */</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">),</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_register</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: pci_read_config_dword returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: temp_register is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">temp_register</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Something&#39;s wrong here */</span>
			<span class="n">temp_register</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: temp register set to %x by error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">temp_register</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Preset return code.  It will be changed later if things go okay. */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">NO_ADAPTER_PRESENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* All F&#39;s is an empty slot or an invalid board */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp_register</span> <span class="o">!=</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res_lists</span><span class="p">.</span><span class="n">io_head</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
		<span class="n">res_lists</span><span class="p">.</span><span class="n">mem_head</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
		<span class="n">res_lists</span><span class="p">.</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
		<span class="n">res_lists</span><span class="p">.</span><span class="n">bus_head</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">;</span>
		<span class="n">res_lists</span><span class="p">.</span><span class="n">irqs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">configure_new_device</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res_lists</span><span class="p">);</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: back from configure_new_device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">io_head</span> <span class="o">=</span> <span class="n">res_lists</span><span class="p">.</span><span class="n">io_head</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">=</span> <span class="n">res_lists</span><span class="p">.</span><span class="n">mem_head</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="n">res_lists</span><span class="p">.</span><span class="n">p_mem_head</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus_head</span> <span class="o">=</span> <span class="n">res_lists</span><span class="p">.</span><span class="n">bus_head</span><span class="p">;</span>

		<span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">));</span>
		<span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">));</span>
		<span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">));</span>
		<span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

			<span class="n">amber_LED_on</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
			<span class="n">green_LED_off</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
			<span class="n">slot_disable</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

			<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

			<span class="cm">/* Wait for SOBS to be unset */</span>
			<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cpqhp_save_slot_config</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
		<span class="p">}</span>


		<span class="n">func</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">switch_save</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">is_a_board</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

		<span class="cm">/* next, we will instantiate the linux pci_dev structures (with</span>
<span class="cm">		 * appropriate driver notification, if already present) */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: configure linux pci_dev structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">new_slot</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_slot</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">)</span>
				<span class="n">cpqhp_configure_device</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">new_slot</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">new_slot</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

		<span class="n">green_LED_on</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

		<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/* Wait for SOBS to be unset */</span>
		<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

		<span class="n">amber_LED_on</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
		<span class="n">green_LED_off</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
		<span class="n">slot_disable</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

		<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/* Wait for SOBS to be unset */</span>
		<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * remove_board - Turns off slot and LEDs</span>
<span class="cm"> * @func: PCI device/function info</span>
<span class="cm"> * @replace_flag: whether replacing or adding a new device</span>
<span class="cm"> * @ctrl: target controller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">remove_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span> <span class="n">func</span><span class="p">,</span> <span class="n">u32</span> <span class="n">replace_flag</span><span class="p">,</span> <span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hp_slot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">temp_byte</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_lists</span> <span class="n">res_lists</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">temp_func</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpqhp_unconfigure_device</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="n">hp_slot</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">-</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;In %s, hp_slot = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

	<span class="cm">/* When we get here, it is safe to change base address registers.</span>
<span class="cm">	 * We will attempt to save the base address register lengths */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">replace_flag</span> <span class="o">||</span> <span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">add_support</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cpqhp_save_base_addr_length</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus_head</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">&amp;&amp;</span>
		 <span class="o">!</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Here we check to see if we&#39;ve saved any of the board&#39;s</span>
<span class="cm">		 * resources already.  If so, we&#39;ll skip the attempt to</span>
<span class="cm">		 * determine what&#39;s being used. */</span>
		<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">temp_func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">temp_func</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp_func</span><span class="o">-&gt;</span><span class="n">bus_head</span> <span class="o">||</span> <span class="n">temp_func</span><span class="o">-&gt;</span><span class="n">mem_head</span>
			    <span class="o">||</span> <span class="n">temp_func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">||</span> <span class="n">temp_func</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">temp_func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">temp_func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">temp_func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skip</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">cpqhp_save_used_resources</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Change status to shutdown */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">is_a_board</span><span class="p">)</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">func</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

	<span class="n">green_LED_off</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
	<span class="n">slot_disable</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

	<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* turn off SERR for slot */</span>
	<span class="n">temp_byte</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_SERR</span><span class="p">);</span>
	<span class="n">temp_byte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">hp_slot</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">temp_byte</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_SERR</span><span class="p">);</span>

	<span class="cm">/* Wait for SOBS to be unset */</span>
	<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">replace_flag</span> <span class="o">&amp;&amp;</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">add_support</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res_lists</span><span class="p">.</span><span class="n">io_head</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
			<span class="n">res_lists</span><span class="p">.</span><span class="n">mem_head</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
			<span class="n">res_lists</span><span class="p">.</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
			<span class="n">res_lists</span><span class="p">.</span><span class="n">bus_head</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">;</span>

			<span class="n">cpqhp_return_board_resources</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res_lists</span><span class="p">);</span>

			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">io_head</span> <span class="o">=</span> <span class="n">res_lists</span><span class="p">.</span><span class="n">io_head</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">=</span> <span class="n">res_lists</span><span class="p">.</span><span class="n">mem_head</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="n">res_lists</span><span class="p">.</span><span class="n">p_mem_head</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus_head</span> <span class="o">=</span> <span class="n">res_lists</span><span class="p">.</span><span class="n">bus_head</span><span class="p">;</span>

			<span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">));</span>
			<span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">));</span>
			<span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">));</span>
			<span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_bridge</span><span class="p">(</span><span class="n">func</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bridge_slot_remove</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">slot_remove</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>

			<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Setup slot structure with entry for empty slot */</span>
		<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_create</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">switch_save</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">is_a_board</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">p_task_event</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pushbutton_helper_thread</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pushbutton_pending</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">wake_up_process</span><span class="p">(</span><span class="n">cpqhp_event_thread</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* this is the main worker thread */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">event_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;!!!!event_thread sleeping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Do stuff here */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pushbutton_pending</span><span class="p">)</span>
			<span class="n">cpqhp_pushbutton_thread</span><span class="p">(</span><span class="n">pushbutton_pending</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">cpqhp_ctrl_list</span><span class="p">;</span> <span class="n">ctrl</span><span class="p">;</span> <span class="n">ctrl</span><span class="o">=</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
				<span class="n">interrupt_event_handler</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;event_thread signals exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cpqhp_event_start_thread</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpqhp_event_thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">event_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;phpd_event&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cpqhp_event_thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;Can&#39;t start up our event thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cpqhp_event_thread</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">cpqhp_event_stop_thread</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">cpqhp_event_thread</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_slot_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hotplug_slot_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">power_status</span> <span class="o">=</span> <span class="n">get_slot_enabled</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">attention_status</span> <span class="o">=</span> <span class="n">cpq_get_attention_status</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">latch_status</span> <span class="o">=</span> <span class="n">cpq_get_latch_status</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">=</span> <span class="n">get_presence_status</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">pci_hp_change_slot_info</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">hotplug_slot</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">interrupt_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hp_slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">p_slot</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* dbg(&quot;loop %d\n&quot;, loop); */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">event_type</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hp_slot</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">hp_slot</span><span class="p">;</span>

				<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="p">(</span><span class="n">hp_slot</span> <span class="o">+</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="p">)</span>
					<span class="k">return</span><span class="p">;</span>

				<span class="n">p_slot</span> <span class="o">=</span> <span class="n">cpqhp_find_slot</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span> <span class="o">+</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_slot</span><span class="p">)</span>
					<span class="k">return</span><span class="p">;</span>

				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;hp_slot %d, func %p, p_slot %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">hp_slot</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">p_slot</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">event_type</span> <span class="o">==</span> <span class="n">INT_BUTTON_PRESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;button pressed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">event_type</span> <span class="o">==</span> 
					   <span class="n">INT_BUTTON_CANCEL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;button cancel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">task_event</span><span class="p">);</span>

					<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BLINKINGOFF_STATE</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* slot is on */</span>
						<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;turn on green LED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">green_LED_on</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BLINKINGON_STATE</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* slot is off */</span>
						<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;turn off green LED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">green_LED_off</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="n">info</span><span class="p">(</span><span class="n">msg_button_cancel</span><span class="p">,</span> <span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

					<span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATIC_STATE</span><span class="p">;</span>

					<span class="n">amber_LED_off</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

					<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

					<span class="cm">/* Wait for SOBS to be unset */</span>
					<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

					<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="cm">/*** button Released (No action on press...) */</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">event_type</span> <span class="o">==</span> <span class="n">INT_BUTTON_RELEASE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;button release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">is_slot_enabled</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;slot is on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BLINKINGOFF_STATE</span><span class="p">;</span>
						<span class="n">info</span><span class="p">(</span><span class="n">msg_button_off</span><span class="p">,</span> <span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;slot is off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BLINKINGON_STATE</span><span class="p">;</span>
						<span class="n">info</span><span class="p">(</span><span class="n">msg_button_on</span><span class="p">,</span> <span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>

					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;blink green LED and turn off amber</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

					<span class="n">amber_LED_off</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
					<span class="n">green_LED_blink</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

					<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

					<span class="cm">/* Wait for SOBS to be unset */</span>
					<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

					<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">crit_sect</span><span class="p">);</span>
					<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">task_event</span><span class="p">);</span>
					<span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">hp_slot</span> <span class="o">=</span> <span class="n">hp_slot</span><span class="p">;</span>
					<span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
<span class="cm">/*					p_slot-&gt;physical_slot = physical_slot; */</span>
					<span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">task_event</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>   <span class="cm">/* 5 second delay */</span>
					<span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">task_event</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">pushbutton_helper_thread</span><span class="p">;</span>
					<span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">task_event</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">p_slot</span><span class="p">;</span>

					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;add_timer p_slot = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p_slot</span><span class="p">);</span>
					<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">task_event</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="cm">/***********POWER FAULT */</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">event_type</span> <span class="o">==</span> <span class="n">INT_POWER_FAULT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;power fault</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* refresh notification */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">p_slot</span><span class="p">)</span>
						<span class="n">update_slot_info</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">p_slot</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">event_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>		<span class="cm">/* End of FOR loop */</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * cpqhp_pushbutton_thread - handle pushbutton events</span>
<span class="cm"> * @slot: target slot (struct)</span>
<span class="cm"> *</span>
<span class="cm"> * Scheduled procedure to handle blocking stuff for the pushbuttons.</span>
<span class="cm"> * Handles all pending events and exits.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cpqhp_pushbutton_thread</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">hp_slot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">p_slot</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="p">)</span> <span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="p">)</span> <span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="n">pushbutton_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hp_slot</span> <span class="o">=</span> <span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">hp_slot</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_slot_enabled</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">POWEROFF_STATE</span><span class="p">;</span>
		<span class="cm">/* power Down board */</span>
		<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;In power_down_board, func = %p, ctrl = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Error! func NULL in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpqhp_process_SS</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">amber_LED_on</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
			<span class="n">green_LED_on</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

			<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

			<span class="cm">/* Wait for SOBS to be unset */</span>
			<span class="n">wait_for_ctrl_irq</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATIC_STATE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">POWERON_STATE</span><span class="p">;</span>
		<span class="cm">/* slot is off */</span>

		<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;In add_board, func = %p, ctrl = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Error! func NULL in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpqhp_process_SI</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">amber_LED_on</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>
				<span class="n">green_LED_off</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">);</span>

				<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

				<span class="cm">/* Wait for SOBS to be unset */</span>
				<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATIC_STATE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">cpqhp_process_SI</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">device</span><span class="p">,</span> <span class="n">hp_slot</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temp_word</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tempdword</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span><span class="o">*</span> <span class="n">p_slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">physical_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tempdword</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">hp_slot</span> <span class="o">=</span> <span class="n">device</span> <span class="o">-</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">slot_device_offset</span><span class="p">;</span>
	<span class="n">p_slot</span> <span class="o">=</span> <span class="n">cpqhp_find_slot</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_slot</span><span class="p">)</span>
		<span class="n">physical_slot</span> <span class="o">=</span> <span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="cm">/* Check to see if the interlock is closed */</span>
	<span class="n">tempdword</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">INT_INPUT_CLEAR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tempdword</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">hp_slot</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">is_a_board</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">board_replaced</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* add board */</span>
		<span class="n">slot_remove</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>

		<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_create</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">is_a_board</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* We have to save the presence info for these slots */</span>
		<span class="n">temp_word</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">presence_save</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_word</span> <span class="o">&gt;&gt;</span> <span class="n">hp_slot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">presence_save</span> <span class="o">|=</span> <span class="p">(</span><span class="n">temp_word</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">hp_slot</span> <span class="o">+</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1L</span> <span class="o">&lt;&lt;</span> <span class="n">hp_slot</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">switch_save</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">switch_save</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">board_added</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_bridge</span><span class="p">(</span><span class="n">func</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bridge_slot_remove</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">slot_remove</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>

			<span class="cm">/* Setup slot structure with entry for empty slot */</span>
			<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_create</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">is_a_board</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* We have to save the presence info for these slots */</span>
			<span class="n">temp_word</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">presence_save</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_word</span> <span class="o">&gt;&gt;</span> <span class="n">hp_slot</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">presence_save</span> <span class="o">|=</span>
			<span class="p">(</span><span class="n">temp_word</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">hp_slot</span> <span class="o">+</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_int_comp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1L</span> <span class="o">&lt;&lt;</span> <span class="n">hp_slot</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">switch_save</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">switch_save</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: rc = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_slot</span><span class="p">)</span>
		<span class="n">update_slot_info</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">p_slot</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">cpqhp_process_SS</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">device</span><span class="p">,</span> <span class="n">class_code</span><span class="p">,</span> <span class="n">header_type</span><span class="p">,</span> <span class="n">BCR</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">replace_flag</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span><span class="o">*</span> <span class="n">p_slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">physical_slot</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
	<span class="n">p_slot</span> <span class="o">=</span> <span class="n">cpqhp_find_slot</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">physical_slot</span> <span class="o">=</span> <span class="n">p_slot</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure there are no video controllers here */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">func</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>

		<span class="cm">/* Check the Class Code */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">class_code</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">class_code</span> <span class="o">==</span> <span class="n">PCI_BASE_CLASS_DISPLAY</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Display/Video adapter (not supported) */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">REMOVE_NOT_SUPPORTED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* See if it&#39;s a bridge */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header_type</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

			<span class="cm">/* If it&#39;s a bridge, check the VGA Enable bit */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">header_type</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_BRIDGE_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BCR</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

				<span class="cm">/* If the VGA Enable bit is set, remove isn&#39;t</span>
<span class="cm">				 * supported */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">BCR</span> <span class="o">&amp;</span> <span class="n">PCI_BRIDGE_CTL_VGA</span><span class="p">)</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">REMOVE_NOT_SUPPORTED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME: Replace flag should be passed into process_SS */</span>
		<span class="n">replace_flag</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">add_support</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">remove_board</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">replace_flag</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_slot</span><span class="p">)</span>
		<span class="n">update_slot_info</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">p_slot</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * switch_leds - switch the leds, go from one site to the other.</span>
<span class="cm"> * @ctrl: controller to use</span>
<span class="cm"> * @num_of_slots: number of slots to use</span>
<span class="cm"> * @work_LED: LED control value</span>
<span class="cm"> * @direction: 1 to start from the left side, 0 to start right.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">switch_leds</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">num_of_slots</span><span class="p">,</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">work_LED</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">num_of_slots</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">direction</span><span class="p">)</span>
			<span class="o">*</span><span class="n">work_LED</span> <span class="o">=</span> <span class="o">*</span><span class="n">work_LED</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">work_LED</span> <span class="o">=</span> <span class="o">*</span><span class="n">work_LED</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="o">*</span><span class="n">work_LED</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">LED_CONTROL</span><span class="p">);</span>

		<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/* Wait for SOGO interrupt */</span>
		<span class="n">wait_for_ctrl_irq</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/* Get ready for next iteration */</span>
		<span class="n">long_delay</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cpqhp_hardware_test - runs hardware tests</span>
<span class="cm"> * @ctrl: target controller</span>
<span class="cm"> * @test_num: the number written to the &quot;test&quot; file in sysfs.</span>
<span class="cm"> *</span>
<span class="cm"> * For hot plug ctrl folks to play with.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpqhp_hardware_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">test_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">save_LED</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">work_LED</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_of_slots</span><span class="p">;</span>

	<span class="n">num_of_slots</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">SLOT_MASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">test_num</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* Do stuff here! */</span>

		<span class="cm">/* Do that funky LED thing */</span>
		<span class="cm">/* so we can restore them later */</span>
		<span class="n">save_LED</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">LED_CONTROL</span><span class="p">);</span>
		<span class="n">work_LED</span> <span class="o">=</span> <span class="mh">0x01010101</span><span class="p">;</span>
		<span class="n">switch_leds</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">num_of_slots</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_LED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">switch_leds</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">num_of_slots</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_LED</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">switch_leds</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">num_of_slots</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_LED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">switch_leds</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">num_of_slots</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_LED</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">work_LED</span> <span class="o">=</span> <span class="mh">0x01010000</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">work_LED</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">LED_CONTROL</span><span class="p">);</span>
		<span class="n">switch_leds</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">num_of_slots</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_LED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">switch_leds</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">num_of_slots</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_LED</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">work_LED</span> <span class="o">=</span> <span class="mh">0x00000101</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">work_LED</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">LED_CONTROL</span><span class="p">);</span>
		<span class="n">switch_leds</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">num_of_slots</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_LED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">switch_leds</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">num_of_slots</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_LED</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">work_LED</span> <span class="o">=</span> <span class="mh">0x01010000</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">work_LED</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">LED_CONTROL</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">num_of_slots</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

			<span class="cm">/* Wait for SOGO interrupt */</span>
			<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

			<span class="cm">/* Get ready for next iteration */</span>
			<span class="n">long_delay</span><span class="p">((</span><span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">work_LED</span> <span class="o">=</span> <span class="n">work_LED</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">work_LED</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">LED_CONTROL</span><span class="p">);</span>

			<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

			<span class="cm">/* Wait for SOGO interrupt */</span>
			<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

			<span class="cm">/* Get ready for next iteration */</span>
			<span class="n">long_delay</span><span class="p">((</span><span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">work_LED</span> <span class="o">=</span> <span class="n">work_LED</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">work_LED</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">LED_CONTROL</span><span class="p">);</span>
			<span class="n">work_LED</span> <span class="o">=</span> <span class="n">work_LED</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">work_LED</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">LED_CONTROL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* put it back the way it was */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">save_LED</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">hpc_reg</span> <span class="o">+</span> <span class="n">LED_CONTROL</span><span class="p">);</span>

		<span class="n">set_SOGO</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/* Wait for SOBS to be unset */</span>
		<span class="n">wait_for_ctrl_irq</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/* Do other stuff here! */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/* and more... */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * configure_new_device - Configures the PCI header information of one board.</span>
<span class="cm"> * @ctrl: pointer to controller structure</span>
<span class="cm"> * @func: pointer to function structure</span>
<span class="cm"> * @behind_bridge: 1 if this is a recursive call, 0 if not</span>
<span class="cm"> * @resources: pointer to set of resource lists</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">configure_new_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span> <span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span> <span class="n">func</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">behind_bridge</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource_lists</span> <span class="o">*</span> <span class="n">resources</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">temp_byte</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">max_functions</span><span class="p">,</span> <span class="n">stop_it</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ID</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">new_slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">new_slot</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/* Check for Multi-function device */</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">),</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_byte</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: rc = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp_byte</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>	<span class="cm">/* Multi-function device */</span>
		<span class="n">max_functions</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max_functions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">function</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">configure_new_function</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">new_slot</span><span class="p">,</span> <span class="n">behind_bridge</span><span class="p">,</span> <span class="n">resources</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;configure_new_function failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">rc</span><span class="p">);</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">new_slot</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">new_slot</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">new_slot</span><span class="p">)</span>
					<span class="n">cpqhp_return_board_resources</span><span class="p">(</span><span class="n">new_slot</span><span class="p">,</span> <span class="n">resources</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">function</span><span class="o">++</span><span class="p">;</span>

		<span class="n">stop_it</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* The following loop skips to the next present function</span>
<span class="cm">		 * and creates a board structure */</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">function</span> <span class="o">&lt;</span> <span class="n">max_functions</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">stop_it</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ID</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ID</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">function</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Setup slot structure. */</span>
				<span class="n">new_slot</span> <span class="o">=</span> <span class="n">cpqhp_slot_create</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">new_slot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span><span class="p">;</span>
				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">is_a_board</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">stop_it</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">function</span> <span class="o">&lt;</span> <span class="n">max_functions</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;returning from configure_new_device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Configuration logic that involves the hotplug data structures and</span>
<span class="cm"> * their bookkeeping</span>
<span class="cm"> */</span>


<span class="cm">/**</span>
<span class="cm"> * configure_new_function - Configures the PCI header information of one device</span>
<span class="cm"> * @ctrl: pointer to controller structure</span>
<span class="cm"> * @func: pointer to function structure</span>
<span class="cm"> * @behind_bridge: 1 if this is a recursive call, 0 if not</span>
<span class="cm"> * @resources: pointer to set of resource lists</span>
<span class="cm"> *</span>
<span class="cm"> * Calls itself recursively for bridged devices.</span>
<span class="cm"> * Returns 0 if success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">configure_new_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">behind_bridge</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">resource_lists</span> <span class="o">*</span><span class="n">resources</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cloop</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">IRQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">temp_byte</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">class_code</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temp_word</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_dword</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_register</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ID</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">mem_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">p_mem_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">io_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">bus_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">hold_mem_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">hold_p_mem_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">hold_IO_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">hold_bus_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_mapping</span> <span class="n">irqs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">new_slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">pci_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_lists</span> <span class="n">temp_resources</span><span class="p">;</span>

	<span class="n">pci_bus</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">;</span>
	<span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>

	<span class="cm">/* Check for Bridge */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_byte</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">temp_byte</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set Primary bus */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;set Primary bus = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PRIMARY_BUS</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* find range of busses to use */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;find ranges of buses to use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bus_node</span> <span class="o">=</span> <span class="n">get_max_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* If we don&#39;t have any busses to allocate, we can&#39;t continue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus_node</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="cm">/* set Secondary bus */</span>
		<span class="n">temp_byte</span> <span class="o">=</span> <span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;set Secondary bus = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="n">temp_byte</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* set subordinate bus */</span>
		<span class="n">temp_byte</span> <span class="o">=</span> <span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;set subordinate bus = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SUBORDINATE_BUS</span><span class="p">,</span> <span class="n">temp_byte</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* set subordinate Latency Timer and base Latency Timer */</span>
		<span class="n">temp_byte</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SEC_LATENCY_TIMER</span><span class="p">,</span> <span class="n">temp_byte</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="n">temp_byte</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* set Cache Line size */</span>
		<span class="n">temp_byte</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="n">temp_byte</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* Setup the IO, memory, and prefetchable windows */</span>
		<span class="n">io_node</span> <span class="o">=</span> <span class="n">get_max_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">),</span> <span class="mh">0x1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_node</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">mem_node</span> <span class="o">=</span> <span class="n">get_max_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">),</span> <span class="mh">0x100000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_node</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">p_mem_node</span> <span class="o">=</span> <span class="n">get_max_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">),</span> <span class="mh">0x100000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_mem_node</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Setup the IO, memory, and prefetchable windows</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;io_node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;(base, len, next) (%x, %x, %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">io_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
					<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">io_node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;mem_node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;(base, len, next) (%x, %x, %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
					<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;p_mem_node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;(base, len, next) (%x, %x, %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
					<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

		<span class="cm">/* set up the IRQ info */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">irqs</span><span class="p">.</span><span class="n">barber_pole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">irqs</span><span class="p">.</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">irqs</span><span class="p">.</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">irqs</span><span class="p">.</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">irqs</span><span class="p">.</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">irqs</span><span class="p">.</span><span class="n">valid_INT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">irqs</span><span class="p">.</span><span class="n">barber_pole</span> <span class="o">=</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">barber_pole</span><span class="p">;</span>
			<span class="n">irqs</span><span class="p">.</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">irqs</span><span class="p">.</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">irqs</span><span class="p">.</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">irqs</span><span class="p">.</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">irqs</span><span class="p">.</span><span class="n">valid_INT</span> <span class="o">=</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">valid_INT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* set up resource lists that are now aligned on top and bottom</span>
<span class="cm">		 * for anything behind the bridge. */</span>
		<span class="n">temp_resources</span><span class="p">.</span><span class="n">bus_head</span> <span class="o">=</span> <span class="n">bus_node</span><span class="p">;</span>
		<span class="n">temp_resources</span><span class="p">.</span><span class="n">io_head</span> <span class="o">=</span> <span class="n">io_node</span><span class="p">;</span>
		<span class="n">temp_resources</span><span class="p">.</span><span class="n">mem_head</span> <span class="o">=</span> <span class="n">mem_node</span><span class="p">;</span>
		<span class="n">temp_resources</span><span class="p">.</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="n">p_mem_node</span><span class="p">;</span>
		<span class="n">temp_resources</span><span class="p">.</span><span class="n">irqs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">irqs</span><span class="p">;</span>

		<span class="cm">/* Make copies of the nodes we are going to pass down so that</span>
<span class="cm">		 * if there is a problem,we can just use these to free resources</span>
<span class="cm">		 */</span>
		<span class="n">hold_bus_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hold_bus_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">hold_IO_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hold_IO_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">hold_mem_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hold_mem_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">hold_p_mem_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hold_p_mem_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hold_bus_node</span> <span class="o">||</span> <span class="o">!</span><span class="n">hold_IO_node</span> <span class="o">||</span> <span class="o">!</span><span class="n">hold_mem_node</span> <span class="o">||</span> <span class="o">!</span><span class="n">hold_p_mem_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">hold_bus_node</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">hold_IO_node</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">hold_mem_node</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">hold_p_mem_node</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">hold_bus_node</span><span class="p">,</span> <span class="n">bus_node</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_resource</span><span class="p">));</span>

		<span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* If we have IO resources copy them and fill in the bridge&#39;s</span>
<span class="cm">		 * IO range registers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">io_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hold_IO_node</span><span class="p">,</span> <span class="n">io_node</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_resource</span><span class="p">));</span>
			<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/* set IO base and Limit registers */</span>
			<span class="n">temp_byte</span> <span class="o">=</span> <span class="n">io_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_BASE</span><span class="p">,</span> <span class="n">temp_byte</span><span class="p">);</span>

			<span class="n">temp_byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">io_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">io_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_LIMIT</span><span class="p">,</span> <span class="n">temp_byte</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">hold_IO_node</span><span class="p">);</span>
			<span class="n">hold_IO_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If we have memory resources copy them and fill in the</span>
<span class="cm">		 * bridge&#39;s memory range registers.  Otherwise, fill in the</span>
<span class="cm">		 * range registers with values that disable them. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hold_mem_node</span><span class="p">,</span> <span class="n">mem_node</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_resource</span><span class="p">));</span>
			<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/* set Mem base and Limit registers */</span>
			<span class="n">temp_word</span> <span class="o">=</span> <span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_MEMORY_BASE</span><span class="p">,</span> <span class="n">temp_word</span><span class="p">);</span>

			<span class="n">temp_word</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_MEMORY_LIMIT</span><span class="p">,</span> <span class="n">temp_word</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">temp_word</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_MEMORY_BASE</span><span class="p">,</span> <span class="n">temp_word</span><span class="p">);</span>

			<span class="n">temp_word</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_MEMORY_LIMIT</span><span class="p">,</span> <span class="n">temp_word</span><span class="p">);</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">hold_mem_node</span><span class="p">);</span>
			<span class="n">hold_mem_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">hold_p_mem_node</span><span class="p">,</span> <span class="n">p_mem_node</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_resource</span><span class="p">));</span>
		<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* set Pre Mem base and Limit registers */</span>
		<span class="n">temp_word</span> <span class="o">=</span> <span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_BASE</span><span class="p">,</span> <span class="n">temp_word</span><span class="p">);</span>

		<span class="n">temp_word</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_LIMIT</span><span class="p">,</span> <span class="n">temp_word</span><span class="p">);</span>

		<span class="cm">/* Adjust this to compensate for extra adjustment in first loop</span>
<span class="cm">		 */</span>
		<span class="n">irqs</span><span class="p">.</span><span class="n">barber_pole</span><span class="o">--</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Here we actually find the devices and configure them */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">device</span> <span class="o">&lt;=</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rc</span><span class="p">;</span> <span class="n">device</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">irqs</span><span class="p">.</span><span class="n">barber_pole</span> <span class="o">=</span> <span class="p">(</span><span class="n">irqs</span><span class="p">.</span><span class="n">barber_pole</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>

			<span class="n">ID</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
			<span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">hold_bus_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
			<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ID</span><span class="p">);</span>
			<span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ID</span> <span class="o">!=</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>	  <span class="cm">/*  device present */</span>
				<span class="cm">/* Setup slot structure. */</span>
				<span class="n">new_slot</span> <span class="o">=</span> <span class="n">cpqhp_slot_create</span><span class="p">(</span><span class="n">hold_bus_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">new_slot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">hold_bus_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">is_a_board</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">rc</span> <span class="o">=</span> <span class="n">configure_new_device</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">new_slot</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_resources</span><span class="p">);</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;configure_new_device rc=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">rc</span><span class="p">);</span>
			<span class="p">}</span>	<span class="cm">/* End of IF (device in slot?) */</span>
		<span class="p">}</span>		<span class="cm">/* End of FOR loop */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free_and_out</span><span class="p">;</span>
		<span class="cm">/* save the interrupt routing information */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">irqs</span><span class="p">.</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">irqs</span><span class="p">.</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">irqs</span><span class="p">.</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">irqs</span><span class="p">.</span><span class="n">interrupt</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">valid_INT</span> <span class="o">=</span> <span class="n">irqs</span><span class="p">.</span><span class="n">valid_INT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">behind_bridge</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We need to hook up the interrupts here */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cloop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">cloop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">irqs</span><span class="p">.</span><span class="n">valid_INT</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">cloop</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">cpqhp_set_irq</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
							   <span class="n">cloop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">irqs</span><span class="p">.</span><span class="n">interrupt</span><span class="p">[</span><span class="n">cloop</span><span class="p">]);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">free_and_out</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>	<span class="cm">/* end of for loop */</span>
		<span class="p">}</span>
		<span class="cm">/* Return unused bus resources</span>
<span class="cm">		 * First use the temporary node to store information for</span>
<span class="cm">		 * the board */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hold_bus_node</span> <span class="o">&amp;&amp;</span> <span class="n">bus_node</span> <span class="o">&amp;&amp;</span> <span class="n">temp_resources</span><span class="p">.</span><span class="n">bus_head</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hold_bus_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">-</span> <span class="n">hold_bus_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

			<span class="n">hold_bus_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">;</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">bus_head</span> <span class="o">=</span> <span class="n">hold_bus_node</span><span class="p">;</span>

			<span class="n">temp_byte</span> <span class="o">=</span> <span class="n">temp_resources</span><span class="p">.</span><span class="n">bus_head</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* set subordinate bus */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SUBORDINATE_BUS</span><span class="p">,</span> <span class="n">temp_byte</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">temp_resources</span><span class="p">.</span><span class="n">bus_head</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">temp_resources</span><span class="p">.</span><span class="n">bus_head</span><span class="p">);</span>
				<span class="n">temp_resources</span><span class="p">.</span><span class="n">bus_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">),</span> <span class="n">temp_resources</span><span class="p">.</span><span class="n">bus_head</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* If we have IO space available and there is some left,</span>
<span class="cm">		 * return the unused portion */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hold_IO_node</span> <span class="o">&amp;&amp;</span> <span class="n">temp_resources</span><span class="p">.</span><span class="n">io_head</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">io_node</span> <span class="o">=</span> <span class="n">do_pre_bridge_resource_split</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">temp_resources</span><span class="p">.</span><span class="n">io_head</span><span class="p">),</span>
							       <span class="o">&amp;</span><span class="n">hold_IO_node</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>

			<span class="cm">/* Check if we were able to split something off */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">io_node</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hold_IO_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">io_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">io_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

				<span class="n">temp_byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">hold_IO_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_BASE</span><span class="p">,</span> <span class="n">temp_byte</span><span class="p">);</span>

				<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">),</span> <span class="n">io_node</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">io_node</span> <span class="o">=</span> <span class="n">do_bridge_resource_split</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">temp_resources</span><span class="p">.</span><span class="n">io_head</span><span class="p">),</span> <span class="mh">0x1000</span><span class="p">);</span>

			<span class="cm">/* Check if we were able to split something off */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">io_node</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* First use the temporary node to store</span>
<span class="cm">				 * information for the board */</span>
				<span class="n">hold_IO_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">io_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">-</span> <span class="n">hold_IO_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

				<span class="cm">/* If we used any, add it to the board&#39;s list */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hold_IO_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hold_IO_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
					<span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span> <span class="o">=</span> <span class="n">hold_IO_node</span><span class="p">;</span>

					<span class="n">temp_byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">io_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_LIMIT</span><span class="p">,</span> <span class="n">temp_byte</span><span class="p">);</span>

					<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">),</span> <span class="n">io_node</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* it doesn&#39;t need any IO */</span>
					<span class="n">temp_word</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_LIMIT</span><span class="p">,</span> <span class="n">temp_word</span><span class="p">);</span>

					<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">),</span> <span class="n">io_node</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">hold_IO_node</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* it used most of the range */</span>
				<span class="n">hold_IO_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span> <span class="o">=</span> <span class="n">hold_IO_node</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hold_IO_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* it used the whole range */</span>
			<span class="n">hold_IO_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span> <span class="o">=</span> <span class="n">hold_IO_node</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* If we have memory space available and there is some left,</span>
<span class="cm">		 * return the unused portion */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hold_mem_node</span> <span class="o">&amp;&amp;</span> <span class="n">temp_resources</span><span class="p">.</span><span class="n">mem_head</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mem_node</span> <span class="o">=</span> <span class="n">do_pre_bridge_resource_split</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">temp_resources</span><span class="p">.</span>  <span class="n">mem_head</span><span class="p">),</span>
								<span class="o">&amp;</span><span class="n">hold_mem_node</span><span class="p">,</span> <span class="mh">0x100000</span><span class="p">);</span>

			<span class="cm">/* Check if we were able to split something off */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mem_node</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hold_mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

				<span class="n">temp_word</span> <span class="o">=</span> <span class="p">(</span><span class="n">hold_mem_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_MEMORY_BASE</span><span class="p">,</span> <span class="n">temp_word</span><span class="p">);</span>

				<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">),</span> <span class="n">mem_node</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">mem_node</span> <span class="o">=</span> <span class="n">do_bridge_resource_split</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">temp_resources</span><span class="p">.</span><span class="n">mem_head</span><span class="p">),</span> <span class="mh">0x100000</span><span class="p">);</span>

			<span class="cm">/* Check if we were able to split something off */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mem_node</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* First use the temporary node to store</span>
<span class="cm">				 * information for the board */</span>
				<span class="n">hold_mem_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">-</span> <span class="n">hold_mem_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">hold_mem_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hold_mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
					<span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">=</span> <span class="n">hold_mem_node</span><span class="p">;</span>

					<span class="cm">/* configure end address */</span>
					<span class="n">temp_word</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_MEMORY_LIMIT</span><span class="p">,</span> <span class="n">temp_word</span><span class="p">);</span>

					<span class="cm">/* Return unused resources to the pool */</span>
					<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">),</span> <span class="n">mem_node</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* it doesn&#39;t need any Mem */</span>
					<span class="n">temp_word</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_MEMORY_LIMIT</span><span class="p">,</span> <span class="n">temp_word</span><span class="p">);</span>

					<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">),</span> <span class="n">mem_node</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">hold_mem_node</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* it used most of the range */</span>
				<span class="n">hold_mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">=</span> <span class="n">hold_mem_node</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hold_mem_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* it used the whole range */</span>
			<span class="n">hold_mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">=</span> <span class="n">hold_mem_node</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* If we have prefetchable memory space available and there</span>
<span class="cm">		 * is some left at the end, return the unused portion */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hold_p_mem_node</span> <span class="o">&amp;&amp;</span> <span class="n">temp_resources</span><span class="p">.</span><span class="n">p_mem_head</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p_mem_node</span> <span class="o">=</span> <span class="n">do_pre_bridge_resource_split</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">temp_resources</span><span class="p">.</span><span class="n">p_mem_head</span><span class="p">),</span>
								  <span class="o">&amp;</span><span class="n">hold_p_mem_node</span><span class="p">,</span> <span class="mh">0x100000</span><span class="p">);</span>

			<span class="cm">/* Check if we were able to split something off */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p_mem_node</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hold_p_mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

				<span class="n">temp_word</span> <span class="o">=</span> <span class="p">(</span><span class="n">hold_p_mem_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_BASE</span><span class="p">,</span> <span class="n">temp_word</span><span class="p">);</span>

				<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">),</span> <span class="n">p_mem_node</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">p_mem_node</span> <span class="o">=</span> <span class="n">do_bridge_resource_split</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">temp_resources</span><span class="p">.</span><span class="n">p_mem_head</span><span class="p">),</span> <span class="mh">0x100000</span><span class="p">);</span>

			<span class="cm">/* Check if we were able to split something off */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p_mem_node</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* First use the temporary node to store</span>
<span class="cm">				 * information for the board */</span>
				<span class="n">hold_p_mem_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">-</span> <span class="n">hold_p_mem_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

				<span class="cm">/* If we used any, add it to the board&#39;s list */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hold_p_mem_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hold_p_mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
					<span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="n">hold_p_mem_node</span><span class="p">;</span>

					<span class="n">temp_word</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_LIMIT</span><span class="p">,</span> <span class="n">temp_word</span><span class="p">);</span>

					<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">),</span> <span class="n">p_mem_node</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* it doesn&#39;t need any PMem */</span>
					<span class="n">temp_word</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_LIMIT</span><span class="p">,</span> <span class="n">temp_word</span><span class="p">);</span>

					<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">),</span> <span class="n">p_mem_node</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">hold_p_mem_node</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* it used the most of the range */</span>
				<span class="n">hold_p_mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="n">hold_p_mem_node</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hold_p_mem_node</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* it used the whole range */</span>
			<span class="n">hold_p_mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="n">hold_p_mem_node</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* We should be configuring an IRQ and the bridge&#39;s base address</span>
<span class="cm">		 * registers if it needs them.  Although we have never seen such</span>
<span class="cm">		 * a device */</span>

		<span class="cm">/* enable card */</span>
		<span class="n">command</span> <span class="o">=</span> <span class="mh">0x0157</span><span class="p">;</span>	<span class="cm">/* = PCI_COMMAND_IO |</span>
<span class="cm">					 *   PCI_COMMAND_MEMORY |</span>
<span class="cm">					 *   PCI_COMMAND_MASTER |</span>
<span class="cm">					 *   PCI_COMMAND_INVALIDATE |</span>
<span class="cm">					 *   PCI_COMMAND_PARITY |</span>
<span class="cm">					 *   PCI_COMMAND_SERR */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>

		<span class="cm">/* set Bridge Control Register */</span>
		<span class="n">command</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>		<span class="cm">/* = PCI_BRIDGE_CTL_PARITY |</span>
<span class="cm">					 *   PCI_BRIDGE_CTL_SERR |</span>
<span class="cm">					 *   PCI_BRIDGE_CTL_NO_ISA */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_BRIDGE_CONTROL</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">temp_byte</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_NORMAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Standard device */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">class_code</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">class_code</span> <span class="o">==</span> <span class="n">PCI_BASE_CLASS_DISPLAY</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Display (video) adapter (not supported) */</span>
			<span class="k">return</span> <span class="n">DEVICE_TYPE_NOT_SUPPORTED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Figure out IO and memory needs */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cloop</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">&lt;=</span> <span class="mh">0x24</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp_register</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>

			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;CND: bus=%d, devfn=%d, offset=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="n">temp_register</span><span class="p">);</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_register</span><span class="p">);</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;CND: base = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp_register</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">temp_register</span><span class="p">)</span> <span class="p">{</span>	  <span class="cm">/* If this register is implemented */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">temp_register</span> <span class="o">&amp;</span> <span class="mh">0x03L</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Map IO */</span>

					<span class="cm">/* set base = amount of IO space */</span>
					<span class="n">base</span> <span class="o">=</span> <span class="n">temp_register</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFC</span><span class="p">;</span>
					<span class="n">base</span> <span class="o">=</span> <span class="o">~</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;CND:      length = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
					<span class="n">io_node</span> <span class="o">=</span> <span class="n">get_io_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">),</span> <span class="n">base</span><span class="p">);</span>
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Got io_node start = %8.8x, length = %8.8x next (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">io_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">io_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">io_node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;func (%p) io_head (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">);</span>

					<span class="cm">/* allocate the resource to the board */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">io_node</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">base</span> <span class="o">=</span> <span class="n">io_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

						<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
						<span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span> <span class="o">=</span> <span class="n">io_node</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">temp_register</span> <span class="o">&amp;</span> <span class="mh">0x0BL</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Map prefetchable memory */</span>
					<span class="n">base</span> <span class="o">=</span> <span class="n">temp_register</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
					<span class="n">base</span> <span class="o">=</span> <span class="o">~</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;CND:      length = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
					<span class="n">p_mem_node</span> <span class="o">=</span> <span class="n">get_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">),</span> <span class="n">base</span><span class="p">);</span>

					<span class="cm">/* allocate the resource to the board */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">p_mem_node</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">base</span> <span class="o">=</span> <span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

						<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
						<span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="n">p_mem_node</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">temp_register</span> <span class="o">&amp;</span> <span class="mh">0x0BL</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Map memory */</span>
					<span class="n">base</span> <span class="o">=</span> <span class="n">temp_register</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
					<span class="n">base</span> <span class="o">=</span> <span class="o">~</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;CND:      length = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
					<span class="n">mem_node</span> <span class="o">=</span> <span class="n">get_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">),</span> <span class="n">base</span><span class="p">);</span>

					<span class="cm">/* allocate the resource to the board */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mem_node</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">base</span> <span class="o">=</span> <span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

						<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
						<span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">=</span> <span class="n">mem_node</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">temp_register</span> <span class="o">&amp;</span> <span class="mh">0x0BL</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Map memory */</span>
					<span class="n">base</span> <span class="o">=</span> <span class="n">temp_register</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
					<span class="n">base</span> <span class="o">=</span> <span class="o">~</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;CND:      length = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
					<span class="n">mem_node</span> <span class="o">=</span> <span class="n">get_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">),</span> <span class="n">base</span><span class="p">);</span>

					<span class="cm">/* allocate the resource to the board */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mem_node</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">base</span> <span class="o">=</span> <span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

						<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
						<span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">=</span> <span class="n">mem_node</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">temp_register</span> <span class="o">&amp;</span> <span class="mh">0x0BL</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x06</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Those bits are reserved, we can&#39;t handle this */</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Requesting space below 1M */</span>
					<span class="k">return</span> <span class="n">NOT_ENOUGH_RESOURCES</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_dword</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

				<span class="cm">/* Check for 64-bit base */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">temp_register</span> <span class="o">&amp;</span> <span class="mh">0x07L</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cloop</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

					<span class="cm">/* Upper 32 bits of address always zero</span>
<span class="cm">					 * on today&#39;s systems */</span>
					<span class="cm">/* FIXME this is probably not true on</span>
<span class="cm">					 * Alpha and ia64??? */</span>
					<span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_dword</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>		<span class="cm">/* End of base register loop */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpqhp_legacy_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Figure out which interrupt pin this function uses */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span>
				<span class="n">PCI_INTERRUPT_PIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_byte</span><span class="p">);</span>

			<span class="cm">/* If this function needs an interrupt and we are behind</span>
<span class="cm">			 * a bridge and the pin is tied to something that&#39;s</span>
<span class="cm">			 * alread mapped, set this one the same */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp_byte</span> <span class="o">&amp;&amp;</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">valid_INT</span> <span class="o">&amp;</span>
			     <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">temp_byte</span> <span class="o">+</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">barber_pole</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">))))</span> <span class="p">{</span>
				<span class="cm">/* We have to share with something already set up */</span>
				<span class="n">IRQ</span> <span class="o">=</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">[(</span><span class="n">temp_byte</span> <span class="o">+</span>
					<span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">barber_pole</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Program IRQ based on card type */</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">class_code</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">class_code</span> <span class="o">==</span> <span class="n">PCI_BASE_CLASS_STORAGE</span><span class="p">)</span>
					<span class="n">IRQ</span> <span class="o">=</span> <span class="n">cpqhp_disk_irq</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">IRQ</span> <span class="o">=</span> <span class="n">cpqhp_nic_irq</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* IRQ Line */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_byte</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">behind_bridge</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">cpqhp_set_irq</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">temp_byte</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* TBD - this code may also belong in the other clause</span>
<span class="cm">			 * of this If statement */</span>
			<span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">[(</span><span class="n">temp_byte</span> <span class="o">+</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">barber_pole</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="n">IRQ</span><span class="p">;</span>
			<span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">valid_INT</span> <span class="o">|=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">temp_byte</span> <span class="o">+</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="o">-&gt;</span><span class="n">barber_pole</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Latency Timer */</span>
		<span class="n">temp_byte</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span>
					<span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="n">temp_byte</span><span class="p">);</span>

		<span class="cm">/* Cache Line size */</span>
		<span class="n">temp_byte</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span>
					<span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="n">temp_byte</span><span class="p">);</span>

		<span class="cm">/* disable ROM base Address */</span>
		<span class="n">temp_dword</span> <span class="o">=</span> <span class="mh">0x00L</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span>
					<span class="n">PCI_ROM_ADDRESS</span><span class="p">,</span> <span class="n">temp_dword</span><span class="p">);</span>

		<span class="cm">/* enable card */</span>
		<span class="n">temp_word</span> <span class="o">=</span> <span class="mh">0x0157</span><span class="p">;</span>	<span class="cm">/* = PCI_COMMAND_IO |</span>
<span class="cm">					 *   PCI_COMMAND_MEMORY |</span>
<span class="cm">					 *   PCI_COMMAND_MASTER |</span>
<span class="cm">					 *   PCI_COMMAND_INVALIDATE |</span>
<span class="cm">					 *   PCI_COMMAND_PARITY |</span>
<span class="cm">					 *   PCI_COMMAND_SERR */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_write_config_word</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span>
					<span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">temp_word</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* End of Not-A-Bridge else */</span>
		<span class="cm">/* It&#39;s some strange type of PCI adapter (Cardbus?) */</span>
		<span class="k">return</span> <span class="n">DEVICE_TYPE_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">func</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">free_and_out:</span>
	<span class="n">cpqhp_destroy_resource_list</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">temp_resources</span><span class="p">);</span>

	<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span> <span class="n">bus_head</span><span class="p">),</span> <span class="n">hold_bus_node</span><span class="p">);</span>
	<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span> <span class="n">io_head</span><span class="p">),</span> <span class="n">hold_IO_node</span><span class="p">);</span>
	<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span> <span class="n">mem_head</span><span class="p">),</span> <span class="n">hold_mem_node</span><span class="p">);</span>
	<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span> <span class="n">p_mem_head</span><span class="p">),</span> <span class="n">hold_p_mem_node</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
