<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pci › hotplug › ibmphp_hpc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ibmphp_hpc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * IBM Hot Plug Controller Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Written By: Jyoti Shah, IBM Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2001-2003 IBM Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> * your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or</span>
<span class="cm"> * NON INFRINGEMENT.  See the GNU General Public License for more</span>
<span class="cm"> * details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Send feedback to &lt;gregkh@us.ibm.com&gt;</span>
<span class="cm"> *                  &lt;jshah@us.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &quot;ibmphp.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">to_debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#define debug_polling(fmt, arg...)	do { if (to_debug) debug (fmt, arg); } while (0)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><hr />

<h2>timeout values</h2></td><td class="code"><div class="highlight"><pre><span class="cp">#define CMD_COMPLETE_TOUT_SEC	60	</span><span class="c1">// give HPC 60 sec to finish cmd</span>
<span class="cp">#define HPC_CTLR_WORKING_TOUT	60	</span><span class="c1">// give HPC 60 sec to finish cmd</span>
<span class="cp">#define HPC_GETACCESS_TIMEOUT	60	</span><span class="c1">// seconds</span>
<span class="cp">#define POLL_INTERVAL_SEC	2	</span><span class="c1">// poll HPC every 2 seconds</span>
<span class="cp">#define POLL_LATCH_CNT		5	</span><span class="c1">// poll latch 5 times, then poll slots</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><hr />

<h2>Winnipeg Architected Register Offsets</h2></td><td class="code"><div class="highlight"><pre><span class="cp">#define WPG_I2CMBUFL_OFFSET	0x08	</span><span class="c1">// I2C Message Buffer Low</span>
<span class="cp">#define WPG_I2CMOSUP_OFFSET	0x10	</span><span class="c1">// I2C Master Operation Setup Reg</span>
<span class="cp">#define WPG_I2CMCNTL_OFFSET	0x20	</span><span class="c1">// I2C Master Control Register</span>
<span class="cp">#define WPG_I2CPARM_OFFSET	0x40	</span><span class="c1">// I2C Parameter Register</span>
<span class="cp">#define WPG_I2CSTAT_OFFSET	0x70	</span><span class="c1">// I2C Status Register</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><hr />

<h2>Winnipeg Store Type commands (Add this commands to the register offset)</h2></td><td class="code"><div class="highlight"><pre><span class="cp">#define WPG_I2C_AND		0x1000	</span><span class="c1">// I2C AND operation</span>
<span class="cp">#define WPG_I2C_OR		0x2000	</span><span class="c1">// I2C OR operation</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><hr />

<h2>Command set for I2C Master Operation Setup Register</h2></td><td class="code"><div class="highlight"><pre><span class="cp">#define WPG_READATADDR_MASK	0x00010000	</span><span class="c1">// read,bytes,I2C shifted,index</span>
<span class="cp">#define WPG_WRITEATADDR_MASK	0x40010000	</span><span class="c1">// write,bytes,I2C shifted,index</span>
<span class="cp">#define WPG_READDIRECT_MASK	0x10010000</span>
<span class="cp">#define WPG_WRITEDIRECT_MASK	0x60010000</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><hr />

<h2>bit masks for I2C Master Control Register</h2></td><td class="code"><div class="highlight"><pre><span class="cp">#define WPG_I2CMCNTL_STARTOP_MASK	0x00000002	</span><span class="c1">// Start the Operation</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><hr />

<hr /></td><td class="code"><div class="highlight"><pre><span class="cp">#define WPG_I2C_IOREMAP_SIZE	0x2044	</span><span class="c1">// size of linear address interval</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><hr />

<h2>command index</h2></td><td class="code"><div class="highlight"><pre><span class="cp">#define WPG_1ST_SLOT_INDEX	0x01	</span><span class="c1">// index - 1st slot for ctlr</span>
<span class="cp">#define WPG_CTLR_INDEX		0x0F	</span><span class="c1">// index - ctlr</span>
<span class="cp">#define WPG_1ST_EXTSLOT_INDEX	0x10	</span><span class="c1">// index - 1st ext slot for ctlr</span>
<span class="cp">#define WPG_1ST_BUS_INDEX	0x1F	</span><span class="c1">// index - 1st bus for ctlr</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><hr />

<h2>macro utilities</h2>

<p>if bits 20,22,25,26,27,29,30 are OFF return 1</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define HPC_I2CSTATUS_CHECK(s)	((u8)((s &amp; 0x00000A76) ? 0 : 1))</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><hr />

<h2>global variables</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="k">struct</span> <span class="n">mutex</span> <span class="n">sem_hpcaccess</span><span class="p">;</span>	<span class="c1">// lock access to HPC</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">semaphore</span> <span class="n">semOperations</span><span class="p">;</span>	<span class="c1">// lock all operations and</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>access to data structures</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="k">struct</span> <span class="n">semaphore</span> <span class="n">sem_exit</span><span class="p">;</span>	<span class="c1">// make sure polling thread goes away</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">ibmphp_poll_thread</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><hr />

<h2>local function prototypes</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">u8</span> <span class="n">i2c_ctrl_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">i2c_ctrl_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">hpc_writecmdtoindex</span> <span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">hpc_readcmdtoindex</span> <span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">get_hpc_access</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">free_hpc_access</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">poll_hpc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">process_changeinstatus</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">process_changeinlatch</span> <span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">u8</span><span class="p">,</span> <span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hpc_wait_ctlr_notworking</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><hr /></td><td class="code"><div class="highlight"><pre><span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    ibmphp_hpc_initvars</span>
<span class="cm">*</span>
<span class="cm">* Action:  initialize semaphores and variables</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">ibmphp_hpc_initvars</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - Entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem_hpcaccess</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">semOperations</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem_exit</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">to_debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    i2c_ctrl_read</span>
<span class="cm">*</span>
<span class="cm">* Action:  read from HPC over I2C</span>
<span class="cm">*</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">i2c_ctrl_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">WPGBbar</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">wpg_addr</span><span class="p">;</span>	<span class="c1">// base addr + offset</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wpg_data</span><span class="p">;</span>	<span class="c1">// data to/from WPG LOHI format</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ultemp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">;</span>	<span class="c1">// actual data HILO format</span>

	<span class="n">debug_polling</span> <span class="p">(</span><span class="s">&quot;%s - Entry WPGBbar[%p] index[%x] </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">WPGBbar</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><hr />

<p>READ - step 1
read at address, byte length, I2C address (shifted), index
or read direct, byte length, index</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">ctlr_type</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">WPG_READATADDR_MASK</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>fill in I2C address</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ultemp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpeg_ctlr</span><span class="p">.</span><span class="n">i2c_addr</span><span class="p">;</span>
		<span class="n">ultemp</span> <span class="o">=</span> <span class="n">ultemp</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ultemp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>fill in index</p></td><td class="code"><div class="highlight"><pre>		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">index</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">ctlr_type</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">WPG_READDIRECT_MASK</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>fill in index</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ultemp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">index</span><span class="p">;</span>
		<span class="n">ultemp</span> <span class="o">=</span> <span class="n">ultemp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">ultemp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;this controller type is not supported </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">HPC_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wpg_data</span> <span class="o">=</span> <span class="n">swab32</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>	<span class="c1">// swap data before writing</span>
	<span class="n">wpg_addr</span> <span class="o">=</span> <span class="n">WPGBbar</span> <span class="o">+</span> <span class="n">WPG_I2CMOSUP_OFFSET</span><span class="p">;</span>
	<span class="n">writel</span> <span class="p">(</span><span class="n">wpg_data</span><span class="p">,</span> <span class="n">wpg_addr</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><hr />

<p>READ - step 2 : clear the message buffer</p></td><td class="code"><div class="highlight"><pre>	<span class="n">data</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">wpg_data</span> <span class="o">=</span> <span class="n">swab32</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">wpg_addr</span> <span class="o">=</span> <span class="n">WPGBbar</span> <span class="o">+</span> <span class="n">WPG_I2CMBUFL_OFFSET</span><span class="p">;</span>
	<span class="n">writel</span> <span class="p">(</span><span class="n">wpg_data</span><span class="p">,</span> <span class="n">wpg_addr</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><hr />

<p>READ - step 3 : issue start operation, I2C master control bit 30:ON
                2020 : [20] OR operation at [20] offset 0x20</p></td><td class="code"><div class="highlight"><pre>	<span class="n">data</span> <span class="o">=</span> <span class="n">WPG_I2CMCNTL_STARTOP_MASK</span><span class="p">;</span>
	<span class="n">wpg_data</span> <span class="o">=</span> <span class="n">swab32</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">wpg_addr</span> <span class="o">=</span> <span class="n">WPGBbar</span> <span class="o">+</span> <span class="n">WPG_I2CMCNTL_OFFSET</span> <span class="o">+</span> <span class="n">WPG_I2C_OR</span><span class="p">;</span>
	<span class="n">writel</span> <span class="p">(</span><span class="n">wpg_data</span><span class="p">,</span> <span class="n">wpg_addr</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><hr />

<p>READ - step 4 : wait until start operation bit clears</p></td><td class="code"><div class="highlight"><pre>	<span class="n">i</span> <span class="o">=</span> <span class="n">CMD_COMPLETE_TOUT_SEC</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">wpg_addr</span> <span class="o">=</span> <span class="n">WPGBbar</span> <span class="o">+</span> <span class="n">WPG_I2CMCNTL_OFFSET</span><span class="p">;</span>
		<span class="n">wpg_data</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="n">wpg_addr</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">swab32</span> <span class="p">(</span><span class="n">wpg_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">WPG_I2CMCNTL_STARTOP_MASK</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - Error : WPG timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">HPC_ERROR</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><hr />

<p>READ - step 5 : read I2C status register</p></td><td class="code"><div class="highlight"><pre>	<span class="n">i</span> <span class="o">=</span> <span class="n">CMD_COMPLETE_TOUT_SEC</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">wpg_addr</span> <span class="o">=</span> <span class="n">WPGBbar</span> <span class="o">+</span> <span class="n">WPG_I2CSTAT_OFFSET</span><span class="p">;</span>
		<span class="n">wpg_data</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="n">wpg_addr</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">swab32</span> <span class="p">(</span><span class="n">wpg_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HPC_I2CSTATUS_CHECK</span> <span class="p">(</span><span class="n">data</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;ctrl_read - Exit Error:I2C timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">HPC_ERROR</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><hr />

<p>READ - step 6 : get DATA</p></td><td class="code"><div class="highlight"><pre>	<span class="n">wpg_addr</span> <span class="o">=</span> <span class="n">WPGBbar</span> <span class="o">+</span> <span class="n">WPG_I2CMBUFL_OFFSET</span><span class="p">;</span>
	<span class="n">wpg_data</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="n">wpg_addr</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">swab32</span> <span class="p">(</span><span class="n">wpg_data</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">debug_polling</span> <span class="p">(</span><span class="s">&quot;%s - Exit index[%x] status[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    i2c_ctrl_write</span>
<span class="cm">*</span>
<span class="cm">* Action:  write to HPC over I2C</span>
<span class="cm">*</span>
<span class="cm">* Return   0 or error codes</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">i2c_ctrl_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">WPGBbar</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">wpg_addr</span><span class="p">;</span>	<span class="c1">// base addr + offset</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wpg_data</span><span class="p">;</span>	<span class="c1">// data to/from WPG LOHI format </span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ultemp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">;</span>	<span class="c1">// actual data HILO format</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">debug_polling</span> <span class="p">(</span><span class="s">&quot;%s - Entry WPGBbar[%p] index[%x] cmd[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">WPGBbar</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><hr />

<p>WRITE - step 1
write at address, byte length, I2C address (shifted), index
or write direct, byte length, index</p></td><td class="code"><div class="highlight"><pre>	<span class="n">data</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">ctlr_type</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">WPG_WRITEATADDR_MASK</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>fill in I2C address</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ultemp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpeg_ctlr</span><span class="p">.</span><span class="n">i2c_addr</span><span class="p">;</span>
		<span class="n">ultemp</span> <span class="o">=</span> <span class="n">ultemp</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ultemp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>fill in index</p></td><td class="code"><div class="highlight"><pre>		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">index</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">ctlr_type</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">WPG_WRITEDIRECT_MASK</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>fill in index</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ultemp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">index</span><span class="p">;</span>
		<span class="n">ultemp</span> <span class="o">=</span> <span class="n">ultemp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">ultemp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;this controller type is not supported </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">HPC_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wpg_data</span> <span class="o">=</span> <span class="n">swab32</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>	<span class="c1">// swap data before writing</span>
	<span class="n">wpg_addr</span> <span class="o">=</span> <span class="n">WPGBbar</span> <span class="o">+</span> <span class="n">WPG_I2CMOSUP_OFFSET</span><span class="p">;</span>
	<span class="n">writel</span> <span class="p">(</span><span class="n">wpg_data</span><span class="p">,</span> <span class="n">wpg_addr</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><hr />

<p>WRITE - step 2 : clear the message buffer</p></td><td class="code"><div class="highlight"><pre>	<span class="n">data</span> <span class="o">=</span> <span class="mh">0x00000000</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">wpg_data</span> <span class="o">=</span> <span class="n">swab32</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">wpg_addr</span> <span class="o">=</span> <span class="n">WPGBbar</span> <span class="o">+</span> <span class="n">WPG_I2CMBUFL_OFFSET</span><span class="p">;</span>
	<span class="n">writel</span> <span class="p">(</span><span class="n">wpg_data</span><span class="p">,</span> <span class="n">wpg_addr</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><hr />

<p>WRITE - step 3 : issue start operation,I2C master control bit 30:ON
                2020 : [20] OR operation at [20] offset 0x20</p></td><td class="code"><div class="highlight"><pre>	<span class="n">data</span> <span class="o">=</span> <span class="n">WPG_I2CMCNTL_STARTOP_MASK</span><span class="p">;</span>
	<span class="n">wpg_data</span> <span class="o">=</span> <span class="n">swab32</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">wpg_addr</span> <span class="o">=</span> <span class="n">WPGBbar</span> <span class="o">+</span> <span class="n">WPG_I2CMCNTL_OFFSET</span> <span class="o">+</span> <span class="n">WPG_I2C_OR</span><span class="p">;</span>
	<span class="n">writel</span> <span class="p">(</span><span class="n">wpg_data</span><span class="p">,</span> <span class="n">wpg_addr</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><hr />

<p>WRITE - step 4 : wait until start operation bit clears</p></td><td class="code"><div class="highlight"><pre>	<span class="n">i</span> <span class="o">=</span> <span class="n">CMD_COMPLETE_TOUT_SEC</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">wpg_addr</span> <span class="o">=</span> <span class="n">WPGBbar</span> <span class="o">+</span> <span class="n">WPG_I2CMCNTL_OFFSET</span><span class="p">;</span>
		<span class="n">wpg_data</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="n">wpg_addr</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">swab32</span> <span class="p">(</span><span class="n">wpg_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">WPG_I2CMCNTL_STARTOP_MASK</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - Exit Error:WPG timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">HPC_ERROR</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><hr />

<p>WRITE - step 5 : read I2C status register</p></td><td class="code"><div class="highlight"><pre>	<span class="n">i</span> <span class="o">=</span> <span class="n">CMD_COMPLETE_TOUT_SEC</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">wpg_addr</span> <span class="o">=</span> <span class="n">WPGBbar</span> <span class="o">+</span> <span class="n">WPG_I2CSTAT_OFFSET</span><span class="p">;</span>
		<span class="n">wpg_data</span> <span class="o">=</span> <span class="n">readl</span> <span class="p">(</span><span class="n">wpg_addr</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">swab32</span> <span class="p">(</span><span class="n">wpg_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HPC_I2CSTATUS_CHECK</span> <span class="p">(</span><span class="n">data</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;ctrl_read - Error : I2C timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">HPC_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debug_polling</span> <span class="p">(</span><span class="s">&quot;%s Exit rc[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><hr />

<h2> Read from ISA type HPC </h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">u8</span> <span class="nf">isa_ctrl_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">start_address</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">end_address</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">start_address</span> <span class="o">=</span> <span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isa_ctlr</span><span class="p">.</span><span class="n">io_start</span><span class="p">;</span>
	<span class="n">end_address</span> <span class="o">=</span> <span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isa_ctlr</span><span class="p">.</span><span class="n">io_end</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">inb</span> <span class="p">(</span><span class="n">start_address</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><hr />

<h2>Write to ISA type HPC</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">isa_ctrl_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">start_address</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">port_address</span><span class="p">;</span>
	
	<span class="n">start_address</span> <span class="o">=</span> <span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">isa_ctlr</span><span class="p">.</span><span class="n">io_start</span><span class="p">;</span>
	<span class="n">port_address</span> <span class="o">=</span> <span class="n">start_address</span> <span class="o">+</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">outb</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">port_address</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">pci_ctrl_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;inside pci_ctrl_read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_dev</span><span class="p">)</span>
		<span class="n">pci_read_config_byte</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_dev</span><span class="p">,</span> <span class="n">HPC_PCI_OFFSET</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">pci_ctrl_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;inside pci_ctrl_write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_write_config_byte</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctrl_dev</span><span class="p">,</span> <span class="n">HPC_PCI_OFFSET</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ctrl_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ctlr_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">isa_ctrl_read</span> <span class="p">(</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_ctrl_read</span> <span class="p">(</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_ctrl_read</span> <span class="p">(</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ctrl_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctlr</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ctlr_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">isa_ctrl_write</span><span class="p">(</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_ctrl_write</span> <span class="p">(</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_ctrl_write</span><span class="p">(</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    hpc_writecmdtoindex()</span>
<span class="cm">*</span>
<span class="cm">* Action:  convert a write command to proper index within a controller</span>
<span class="cm">*</span>
<span class="cm">* Return   index, HPC_ERROR</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">hpc_writecmdtoindex</span> <span class="p">(</span><span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPC_CTLR_ENABLEIRQ</span>:	<span class="c1">// 0x00.N.15</span>
	<span class="k">case</span> <span class="n">HPC_CTLR_CLEARIRQ</span>:	<span class="c1">// 0x06.N.15</span>
	<span class="k">case</span> <span class="n">HPC_CTLR_RESET</span>:	<span class="c1">// 0x07.N.15</span>
	<span class="k">case</span> <span class="n">HPC_CTLR_IRQSTEER</span>:	<span class="c1">// 0x08.N.15</span>
	<span class="k">case</span> <span class="n">HPC_CTLR_DISABLEIRQ</span>:	<span class="c1">// 0x01.N.15</span>
	<span class="k">case</span> <span class="n">HPC_ALLSLOT_ON</span>:	<span class="c1">// 0x11.N.15</span>
	<span class="k">case</span> <span class="n">HPC_ALLSLOT_OFF</span>:	<span class="c1">// 0x12.N.15</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HPC_SLOT_OFF</span>:	<span class="c1">// 0x02.Y.0-14</span>
	<span class="k">case</span> <span class="n">HPC_SLOT_ON</span>:	<span class="c1">// 0x03.Y.0-14</span>
	<span class="k">case</span> <span class="n">HPC_SLOT_ATTNOFF</span>:	<span class="c1">// 0x04.N.0-14</span>
	<span class="k">case</span> <span class="n">HPC_SLOT_ATTNON</span>:	<span class="c1">// 0x05.N.0-14</span>
	<span class="k">case</span> <span class="n">HPC_SLOT_BLINKLED</span>:	<span class="c1">// 0x13.N.0-14</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HPC_BUS_33CONVMODE</span>:
	<span class="k">case</span> <span class="n">HPC_BUS_66CONVMODE</span>:
	<span class="k">case</span> <span class="n">HPC_BUS_66PCIXMODE</span>:
	<span class="k">case</span> <span class="n">HPC_BUS_100PCIXMODE</span>:
	<span class="k">case</span> <span class="n">HPC_BUS_133PCIXMODE</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="n">WPG_1ST_BUS_INDEX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;hpc_writecmdtoindex - Error invalid cmd[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">HPC_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    hpc_readcmdtoindex()</span>
<span class="cm">*</span>
<span class="cm">* Action:  convert a read command to proper index within a controller</span>
<span class="cm">*</span>
<span class="cm">* Return   index, HPC_ERROR</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">hpc_readcmdtoindex</span> <span class="p">(</span><span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">READ_CTLRSTATUS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_SLOTSTATUS</span>:
	<span class="k">case</span> <span class="n">READ_ALLSTAT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_EXTSLOTSTATUS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="n">WPG_1ST_EXTSLOT_INDEX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_BUSSTATUS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="n">WPG_1ST_BUS_INDEX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_SLOTLATCHLOWREG</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_REVLEVEL</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="mh">0x25</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_HPCOPTIONS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="mh">0x27</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">HPC_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    HPCreadslot()</span>
<span class="cm">*</span>
<span class="cm">* Action:  issue a READ command to HPC</span>
<span class="cm">*</span>
<span class="cm">* Input:   pslot   - cannot be NULL for READ_ALLSTAT</span>
<span class="cm">*          pstatus - can be NULL for READ_ALLSTAT</span>
<span class="cm">*</span>
<span class="cm">* Return   0 or error codes</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="kt">int</span> <span class="nf">ibmphp_hpc_readslot</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">pstatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">wpg_bbar</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctlr_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pslotlist</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">busindex</span><span class="p">;</span>

	<span class="n">debug_polling</span> <span class="p">(</span><span class="s">&quot;%s - Entry pslot[%p] cmd[%x] pstatus[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">pstatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pslot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">pstatus</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">READ_ALLSTAT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">READ_BUSSTATUS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;%s - Error invalid pointer, rc[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">READ_BUSSTATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">busindex</span> <span class="o">=</span> <span class="n">ibmphp_get_bus_index</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">busindex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;%s - Exit Error:invalid bus, rc[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">busindex</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">ctlr_index</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">hpc_readcmdtoindex</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">HPC_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;%s - Exit Error:invalid index, rc[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctlr_ptr</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="n">get_hpc_access</span> <span class="p">();</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><hr />

<h2>map physical address to logical address</h2></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">ctlr_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">ctlr_type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">wpg_bbar</span> <span class="o">=</span> <span class="n">ioremap</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpeg_ctlr</span><span class="p">.</span><span class="n">wpegbbar</span><span class="p">,</span> <span class="n">WPG_I2C_IOREMAP_SIZE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><hr />

<h2>check controller status before reading</h2></td><td class="code"><div class="highlight"><pre>	<span class="n">rc</span> <span class="o">=</span> <span class="n">hpc_wait_ctlr_notworking</span> <span class="p">(</span><span class="n">HPC_CTLR_WORKING_TOUT</span><span class="p">,</span> <span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">READ_ALLSTAT</span>:</pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>update the slot structure</p></td><td class="code"><div class="highlight"><pre>			<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ctrl_read</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">hpc_wait_ctlr_notworking</span> <span class="p">(</span><span class="n">HPC_CTLR_WORKING_TOUT</span><span class="p">,</span> <span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
				<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">ext_status</span> <span class="o">=</span> <span class="n">ctrl_read</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="n">WPG_1ST_EXTSLOT_INDEX</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">READ_SLOTSTATUS</span>:</pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>DO NOT update the slot structure</p></td><td class="code"><div class="highlight"><pre>			<span class="o">*</span><span class="n">pstatus</span> <span class="o">=</span> <span class="n">ctrl_read</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">READ_EXTSLOTSTATUS</span>:</pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>DO NOT update the slot structure</p></td><td class="code"><div class="highlight"><pre>			<span class="o">*</span><span class="n">pstatus</span> <span class="o">=</span> <span class="n">ctrl_read</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">READ_CTLRSTATUS</span>:</pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>DO NOT update the slot structure</p></td><td class="code"><div class="highlight"><pre>			<span class="o">*</span><span class="n">pstatus</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">READ_BUSSTATUS</span>:
			<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">busstatus</span> <span class="o">=</span> <span class="n">ctrl_read</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">READ_REVLEVEL</span>:
			<span class="o">*</span><span class="n">pstatus</span> <span class="o">=</span> <span class="n">ctrl_read</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">READ_HPCOPTIONS</span>:
			<span class="o">*</span><span class="n">pstatus</span> <span class="o">=</span> <span class="n">ctrl_read</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">READ_SLOTLATCHLOWREG</span>:</pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>DO NOT update the slot structure</p></td><td class="code"><div class="highlight"><pre>			<span class="o">*</span><span class="n">pstatus</span> <span class="o">=</span> <span class="n">ctrl_read</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>Not used</p></td><td class="code"><div class="highlight"><pre>		<span class="k">case</span> <span class="n">READ_ALLSLOT</span>:
			<span class="n">list_for_each</span> <span class="p">(</span><span class="n">pslotlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ibmphp_slot_head</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pslot</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">pslotlist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slot</span><span class="p">,</span> <span class="n">ibm_slot_list</span><span class="p">);</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">ctlr_index</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">hpc_wait_ctlr_notworking</span> <span class="p">(</span><span class="n">HPC_CTLR_WORKING_TOUT</span><span class="p">,</span> <span class="n">ctlr_ptr</span><span class="p">,</span>
								<span class="n">wpg_bbar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ctrl_read</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">hpc_wait_ctlr_notworking</span> <span class="p">(</span><span class="n">HPC_CTLR_WORKING_TOUT</span><span class="p">,</span>
									<span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
						<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">ext_status</span> <span class="o">=</span>
						    <span class="n">ctrl_read</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span>
								<span class="n">index</span> <span class="o">+</span> <span class="n">WPG_1ST_EXTSLOT_INDEX</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;%s - Error ctrl_read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><hr />

<h2>cleanup</h2></td><td class="code"><div class="highlight"><pre>	</pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>remove physical to logical address mapping</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">ctlr_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">ctlr_type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">iounmap</span> <span class="p">(</span><span class="n">wpg_bbar</span><span class="p">);</span>
	
	<span class="n">free_hpc_access</span> <span class="p">();</span>

	<span class="n">debug_polling</span> <span class="p">(</span><span class="s">&quot;%s - Exit rc[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    ibmphp_hpc_writeslot()</span>
<span class="cm">*</span>
<span class="cm">* Action: issue a WRITE command to HPC</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="kt">int</span> <span class="nf">ibmphp_hpc_writeslot</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">wpg_bbar</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctlr_ptr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">busindex</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">done</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">debug_polling</span> <span class="p">(</span><span class="s">&quot;%s - Entry pslot[%p] cmd[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;%s - Error Exit rc[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">HPC_BUS_33CONVMODE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">HPC_BUS_66CONVMODE</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">HPC_BUS_66PCIXMODE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">HPC_BUS_100PCIXMODE</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">HPC_BUS_133PCIXMODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">busindex</span> <span class="o">=</span> <span class="n">ibmphp_get_bus_index</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">busindex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;%s - Exit Error:invalid bus, rc[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">busindex</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">ctlr_index</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">hpc_writecmdtoindex</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">HPC_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;%s - Error Exit rc[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctlr_ptr</span> <span class="o">=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="n">get_hpc_access</span> <span class="p">();</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><hr />

<h2>map physical address to logical address</h2></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">ctlr_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">ctlr_type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wpg_bbar</span> <span class="o">=</span> <span class="n">ioremap</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpeg_ctlr</span><span class="p">.</span><span class="n">wpegbbar</span><span class="p">,</span> <span class="n">WPG_I2C_IOREMAP_SIZE</span><span class="p">);</span>

		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - ctlr id[%x] physical[%lx] logical[%lx] i2c[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">ctlr_id</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpeg_ctlr</span><span class="p">.</span><span class="n">wpegbbar</span><span class="p">),</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">wpg_bbar</span><span class="p">,</span>
		<span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wpeg_ctlr</span><span class="p">.</span><span class="n">i2c_addr</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><hr />

<h2>check controller status before writing</h2></td><td class="code"><div class="highlight"><pre>	<span class="n">rc</span> <span class="o">=</span> <span class="n">hpc_wait_ctlr_notworking</span> <span class="p">(</span><span class="n">HPC_CTLR_WORKING_TOUT</span><span class="p">,</span> <span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ctrl_write</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><hr />

<h2>check controller is still not working on the command</h2></td><td class="code"><div class="highlight"><pre>		<span class="n">timeout</span> <span class="o">=</span> <span class="n">CMD_COMPLETE_TOUT_SEC</span><span class="p">;</span>
		<span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">hpc_wait_ctlr_notworking</span> <span class="p">(</span><span class="n">HPC_CTLR_WORKING_TOUT</span><span class="p">,</span> <span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">NEEDTOCHECK_CMDSTATUS</span> <span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">CTLR_FINISHED</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">HPC_CTLR_FINISHED_YES</span><span class="p">)</span>
						<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;%s - Error command complete timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>cleanup</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>remove physical to logical address mapping</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">ctlr_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="o">-&gt;</span><span class="n">ctlr_type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">iounmap</span> <span class="p">(</span><span class="n">wpg_bbar</span><span class="p">);</span>
	<span class="n">free_hpc_access</span> <span class="p">();</span>

	<span class="n">debug_polling</span> <span class="p">(</span><span class="s">&quot;%s - Exit rc[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    get_hpc_access()</span>
<span class="cm">*</span>
<span class="cm">* Action: make sure only one process can access HPC at one time</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_hpc_access</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem_hpcaccess</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    free_hpc_access()</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="kt">void</span> <span class="nf">free_hpc_access</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sem_hpcaccess</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    ibmphp_lock_operations()</span>
<span class="cm">*</span>
<span class="cm">* Action: make sure only one process can change the data structure</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="kt">void</span> <span class="nf">ibmphp_lock_operations</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">semOperations</span><span class="p">);</span>
	<span class="n">to_debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    ibmphp_unlock_operations()</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="kt">void</span> <span class="nf">ibmphp_unlock_operations</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - Entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">semOperations</span><span class="p">);</span>
	<span class="n">to_debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    poll_hpc()</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="cp">#define POLL_LATCH_REGISTER	0</span>
<span class="cp">#define POLL_SLOTS		1</span>
<span class="cp">#define POLL_SLEEP		2</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">poll_hpc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="n">myslot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">pslot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pslotlist</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">poll_state</span> <span class="o">=</span> <span class="n">POLL_LATCH_REGISTER</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">oldlatchlow</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">curlatchlow</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">poll_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl_count</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - Entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/* try to get the lock to do some kind of hardware access */</span>
		<span class="n">down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">semOperations</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">poll_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">POLL_LATCH_REGISTER</span>: 
			<span class="n">oldlatchlow</span> <span class="o">=</span> <span class="n">curlatchlow</span><span class="p">;</span>
			<span class="n">ctrl_count</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">list_for_each</span> <span class="p">(</span><span class="n">pslotlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ibmphp_slot_head</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ctrl_count</span> <span class="o">&gt;=</span> <span class="n">ibmphp_get_total_controllers</span><span class="p">())</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">pslot</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">pslotlist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slot</span><span class="p">,</span> <span class="n">ibm_slot_list</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctlr_relative_id</span> <span class="o">==</span> <span class="n">ctrl_count</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ctrl_count</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">READ_SLOT_LATCH</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_hpc_readslot</span> <span class="p">(</span><span class="n">pslot</span><span class="p">,</span>
									  <span class="n">READ_SLOTLATCHLOWREG</span><span class="p">,</span>
									  <span class="o">&amp;</span><span class="n">curlatchlow</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">oldlatchlow</span> <span class="o">!=</span> <span class="n">curlatchlow</span><span class="p">)</span>
							<span class="n">process_changeinlatch</span> <span class="p">(</span><span class="n">oldlatchlow</span><span class="p">,</span>
									       <span class="n">curlatchlow</span><span class="p">,</span>
									       <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="o">++</span><span class="n">poll_count</span><span class="p">;</span>
			<span class="n">poll_state</span> <span class="o">=</span> <span class="n">POLL_SLEEP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">POLL_SLOTS</span>:
			<span class="n">list_for_each</span> <span class="p">(</span><span class="n">pslotlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ibmphp_slot_head</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pslot</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">pslotlist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slot</span><span class="p">,</span> <span class="n">ibm_slot_list</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>make a copy of the old status</p></td><td class="code"><div class="highlight"><pre>				<span class="n">memcpy</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">myslot</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pslot</span><span class="p">,</span>
					<span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slot</span><span class="p">));</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_hpc_readslot</span> <span class="p">(</span><span class="n">pslot</span><span class="p">,</span> <span class="n">READ_ALLSTAT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">myslot</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
				    <span class="o">||</span> <span class="p">(</span><span class="n">myslot</span><span class="p">.</span><span class="n">ext_status</span> <span class="o">!=</span> <span class="n">pslot</span><span class="o">-&gt;</span><span class="n">ext_status</span><span class="p">))</span>
					<span class="n">process_changeinstatus</span> <span class="p">(</span><span class="n">pslot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">myslot</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ctrl_count</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">list_for_each</span> <span class="p">(</span><span class="n">pslotlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ibmphp_slot_head</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ctrl_count</span> <span class="o">&gt;=</span> <span class="n">ibmphp_get_total_controllers</span><span class="p">())</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">pslot</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">pslotlist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slot</span><span class="p">,</span> <span class="n">ibm_slot_list</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ctlr_relative_id</span> <span class="o">==</span> <span class="n">ctrl_count</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ctrl_count</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">READ_SLOT_LATCH</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">))</span>
						<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_hpc_readslot</span> <span class="p">(</span><span class="n">pslot</span><span class="p">,</span>
									  <span class="n">READ_SLOTLATCHLOWREG</span><span class="p">,</span>
									  <span class="o">&amp;</span><span class="n">curlatchlow</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="o">++</span><span class="n">poll_count</span><span class="p">;</span>
			<span class="n">poll_state</span> <span class="o">=</span> <span class="n">POLL_SLEEP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">POLL_SLEEP</span>:
			<span class="cm">/* don&#39;t sleep with a lock on the hardware */</span>
			<span class="n">up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">semOperations</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">POLL_INTERVAL_SEC</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
				<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
			
			<span class="n">down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">semOperations</span><span class="p">);</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">poll_count</span> <span class="o">&gt;=</span> <span class="n">POLL_LATCH_CNT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">poll_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">poll_state</span> <span class="o">=</span> <span class="n">POLL_SLOTS</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">poll_state</span> <span class="o">=</span> <span class="n">POLL_LATCH_REGISTER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>	
		<span class="cm">/* give up the hardware semaphore */</span>
		<span class="n">up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">semOperations</span><span class="p">);</span>
		<span class="cm">/* sleep for a short time just for good measure */</span>
<span class="nl">out_sleep:</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sem_exit</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    process_changeinstatus</span>
<span class="cm">*</span>
<span class="cm">* Action:  compare old and new slot status, process the change in status</span>
<span class="cm">*</span>
<span class="cm">* Input:   pointer to slot struct, old slot struct</span>
<span class="cm">*</span>
<span class="cm">* Return   0 or error codes</span>
<span class="cm">* Value:</span>
<span class="cm">*</span>
<span class="cm">* Side</span>
<span class="cm">* Effects: None.</span>
<span class="cm">*</span>
<span class="cm">* Notes:</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_changeinstatus</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">poldslot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;process_changeinstatus - Entry pslot[%p], poldslot[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="n">poldslot</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>bit 0 - HPC<em>SLOT</em>POWER</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">poldslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="n">update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>bit 1 - HPC<em>SLOT</em>CONNECT
ignore</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>bit 2 - HPC<em>SLOT</em>ATTN</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">poldslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">))</span>
		<span class="n">update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>bit 3 - HPC<em>SLOT</em>PRSNT2
bit 4 - HPC<em>SLOT</em>PRSNT1</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(((</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">poldslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span>
		<span class="o">||</span> <span class="p">((</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">poldslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)))</span>
		<span class="n">update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>bit 5 - HPC<em>SLOT</em>PWRGD</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">poldslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>OFF -> ON: ignore, ON -> OFF: disable slot</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">((</span><span class="n">poldslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SLOT_CONNECT</span> <span class="p">(</span><span class="n">poldslot</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">HPC_SLOT_CONNECTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SLOT_PRESENT</span> <span class="p">(</span><span class="n">poldslot</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)))</span> 
			<span class="n">disable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>bit 6 - HPC<em>SLOT</em>BUS_SPEED
ignore</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>bit 7 - HPC<em>SLOT</em>LATCH</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">poldslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>OPEN -> CLOSE</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SLOT_PWRGD</span> <span class="p">(</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>power goes on and off after closing latch
check again to make sure power is still ON</p></td><td class="code"><div class="highlight"><pre>				<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_hpc_readslot</span> <span class="p">(</span><span class="n">pslot</span><span class="p">,</span> <span class="n">READ_SLOTSTATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">SLOT_PWRGD</span> <span class="p">(</span><span class="n">status</span><span class="p">))</span>
					<span class="n">update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span>	<span class="c1">// overwrite power in pslot to OFF</span>
					<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HPC_SLOT_POWER</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>CLOSE -> OPEN </p></td><td class="code"><div class="highlight"><pre>		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">SLOT_PWRGD</span> <span class="p">(</span><span class="n">poldslot</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">HPC_SLOT_PWRGD_GOOD</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SLOT_CONNECT</span> <span class="p">(</span><span class="n">poldslot</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">HPC_SLOT_CONNECTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SLOT_PRESENT</span> <span class="p">(</span><span class="n">poldslot</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">disable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>else - ignore</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>bit 4 - HPC<em>SLOT</em>BLINK_ATTN</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">pslot</span><span class="o">-&gt;</span><span class="n">ext_status</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">poldslot</span><span class="o">-&gt;</span><span class="n">ext_status</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span>
		<span class="n">update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;process_changeinstatus - disable slot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pslot</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_do_disable_slot</span> <span class="p">(</span><span class="n">pslot</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">update</span> <span class="o">||</span> <span class="n">disable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ibmphp_update_slot_info</span> <span class="p">(</span><span class="n">pslot</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - Exit rc[%d] disable[%x] update[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">disable</span><span class="p">,</span> <span class="n">update</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    process_changeinlatch</span>
<span class="cm">*</span>
<span class="cm">* Action:  compare old and new latch reg status, process the change</span>
<span class="cm">*</span>
<span class="cm">* Input:   old and current latch register status</span>
<span class="cm">*</span>
<span class="cm">* Return   0 or error codes</span>
<span class="cm">* Value:</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_changeinlatch</span> <span class="p">(</span><span class="n">u8</span> <span class="n">old</span><span class="p">,</span> <span class="n">u8</span> <span class="n">new</span><span class="p">,</span> <span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="n">myslot</span><span class="p">,</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - Entry old[%x], new[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>bit 0 reserved, 0 is LSB, check bit 1-6 for 6 slots</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">starting_slot_num</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ending_slot_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">old</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">new</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pslot</span> <span class="o">=</span> <span class="n">ibmphp_get_slot_from_physical_num</span> <span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">myslot</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pslot</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slot</span><span class="p">));</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_hpc_readslot</span> <span class="p">(</span><span class="n">pslot</span><span class="p">,</span> <span class="n">READ_ALLSTAT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - call process_changeinstatus for slot[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">process_changeinstatus</span> <span class="p">(</span><span class="n">pslot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">myslot</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;%s - Error bad pointer for slot[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - Exit rc[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    ibmphp_hpc_start_poll_thread</span>
<span class="cm">*</span>
<span class="cm">* Action:  start polling thread</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">ibmphp_hpc_start_poll_thread</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - Entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ibmphp_poll_thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">poll_hpc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;hpc_poll&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ibmphp_poll_thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;%s - Error, thread not started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ibmphp_poll_thread</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    ibmphp_hpc_stop_poll_thread</span>
<span class="cm">*</span>
<span class="cm">* Action:  stop polling thread and cleanup</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ibmphp_hpc_stop_poll_thread</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - Entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">ibmphp_poll_thread</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;before locking operations </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ibmphp_lock_operations</span> <span class="p">();</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;after locking operations </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	</pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>wait for poll thread to exit</p></td><td class="code"><div class="highlight"><pre>	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;before sem_exit down </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">down</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sem_exit</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;after sem_exit down </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>cleanup</p></td><td class="code"><div class="highlight"><pre>	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;before free_hpc_access </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">free_hpc_access</span> <span class="p">();</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;after free_hpc_access </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ibmphp_unlock_operations</span> <span class="p">();</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;after unlock operations </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">up</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sem_exit</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;after sem exit up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------</span>
<span class="cm">* Name:    hpc_wait_ctlr_notworking</span>
<span class="cm">*</span>
<span class="cm">* Action:  wait until the controller is in a not working state</span>
<span class="cm">*</span>
<span class="cm">* Return   0, HPC_ERROR</span>
<span class="cm">* Value:</span>
<span class="cm">*---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hpc_wait_ctlr_notworking</span> <span class="p">(</span><span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">wpg_bbar</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="o">*</span> <span class="n">pstatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">debug_polling</span> <span class="p">(</span><span class="s">&quot;hpc_wait_ctlr_notworking - Entry timeout[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pstatus</span> <span class="o">=</span> <span class="n">ctrl_read</span> <span class="p">(</span><span class="n">ctlr_ptr</span><span class="p">,</span> <span class="n">wpg_bbar</span><span class="p">,</span> <span class="n">WPG_CTLR_INDEX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pstatus</span> <span class="o">==</span> <span class="n">HPC_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">HPC_ERROR</span><span class="p">;</span>
			<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CTLR_WORKING</span> <span class="p">(</span><span class="o">*</span><span class="n">pstatus</span><span class="p">)</span> <span class="o">==</span> <span class="n">HPC_CTLR_WORKING_NO</span><span class="p">)</span>
			<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;HPCreadslot - Error ctlr timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">HPC_ERROR</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">debug_polling</span> <span class="p">(</span><span class="s">&quot;hpc_wait_ctlr_notworking - Exit rc[%x] status[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="o">*</span><span class="n">pstatus</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
