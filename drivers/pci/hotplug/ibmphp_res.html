<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pci › hotplug › ibmphp_res.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ibmphp_res.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * IBM Hot Plug Controller Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Written By: Irene Zubarev, IBM Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2001 Greg Kroah-Hartman (greg@kroah.com)</span>
<span class="cm"> * Copyright (C) 2001,2002 IBM Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> * your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or</span>
<span class="cm"> * NON INFRINGEMENT.  See the GNU General Public License for more</span>
<span class="cm"> * details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Send feedback to &lt;gregkh@us.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &quot;ibmphp.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* for testing */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">update_resources</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rangeno</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">once_over</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">remove_ranges</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">update_bridge_ranges</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span> <span class="o">**</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">add_bus_range</span> <span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fix_resources</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">find_bus_wprev</span> <span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bus_node</span> <span class="o">**</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">gbuses</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">alloc_error_bus</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ebda_pci_rsrc</span> <span class="o">*</span> <span class="n">curr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">busno</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span> <span class="n">newbus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;NULL pointer passed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">newbus</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newbus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span>
		<span class="n">newbus</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">busno</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">newbus</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">bus_num</span><span class="p">;</span>
	<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">newbus</span><span class="o">-&gt;</span><span class="n">bus_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gbuses</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">newbus</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">alloc_resources</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ebda_pci_rsrc</span> <span class="o">*</span> <span class="n">curr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">rs</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;NULL passed to allocate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">bus_num</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">dev_fun</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">start_addr</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">end_addr</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">end_addr</span> <span class="o">-</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">start_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">alloc_bus_range</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span> <span class="o">**</span><span class="n">new_bus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">range_node</span> <span class="o">**</span><span class="n">new_range</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ebda_pci_rsrc</span> <span class="o">*</span><span class="n">curr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="n">u8</span> <span class="n">first_bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span> <span class="n">newbus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">newrange</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_ranges</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first_bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newbus</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newbus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">newbus</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">bus_num</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">newbus</span> <span class="o">=</span> <span class="o">*</span><span class="n">new_bus</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">MEM</span>:
				<span class="n">num_ranges</span> <span class="o">=</span> <span class="n">newbus</span><span class="o">-&gt;</span><span class="n">noMemRanges</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PFMEM</span>:
				<span class="n">num_ranges</span> <span class="o">=</span> <span class="n">newbus</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IO</span>:
				<span class="n">num_ranges</span> <span class="o">=</span> <span class="n">newbus</span><span class="o">-&gt;</span><span class="n">noIORanges</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">newrange</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">range_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newrange</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first_bus</span><span class="p">)</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">newbus</span><span class="p">);</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">newrange</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">start_addr</span><span class="p">;</span>
	<span class="n">newrange</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">end_addr</span><span class="p">;</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="n">first_bus</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">num_ranges</span><span class="p">))</span>
		<span class="n">newrange</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* need to insert our range */</span>
		<span class="n">add_bus_range</span> <span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">newrange</span><span class="p">,</span> <span class="n">newbus</span><span class="p">);</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%d resource Primary Bus inserted on bus %x [%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">newbus</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MEM</span>:
			<span class="n">newbus</span><span class="o">-&gt;</span><span class="n">rangeMem</span> <span class="o">=</span> <span class="n">newrange</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first_bus</span><span class="p">)</span>
				<span class="n">newbus</span><span class="o">-&gt;</span><span class="n">noMemRanges</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;First Memory Primary on bus %x, [%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">newbus</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
				<span class="o">++</span><span class="n">newbus</span><span class="o">-&gt;</span><span class="n">noMemRanges</span><span class="p">;</span>
				<span class="n">fix_resources</span> <span class="p">(</span><span class="n">newbus</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IO</span>:
			<span class="n">newbus</span><span class="o">-&gt;</span><span class="n">rangeIO</span> <span class="o">=</span> <span class="n">newrange</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first_bus</span><span class="p">)</span>
				<span class="n">newbus</span><span class="o">-&gt;</span><span class="n">noIORanges</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;First IO Primary on bus %x, [%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">newbus</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
				<span class="o">++</span><span class="n">newbus</span><span class="o">-&gt;</span><span class="n">noIORanges</span><span class="p">;</span>
				<span class="n">fix_resources</span> <span class="p">(</span><span class="n">newbus</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PFMEM</span>:
			<span class="n">newbus</span><span class="o">-&gt;</span><span class="n">rangePFMem</span> <span class="o">=</span> <span class="n">newrange</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first_bus</span><span class="p">)</span>
				<span class="n">newbus</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>	
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;1st PFMemory Primary on Bus %x [%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">newbus</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
				<span class="o">++</span><span class="n">newbus</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span><span class="p">;</span>
				<span class="n">fix_resources</span> <span class="p">(</span><span class="n">newbus</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">new_bus</span> <span class="o">=</span> <span class="n">newbus</span><span class="p">;</span>
	<span class="o">*</span><span class="n">new_range</span> <span class="o">=</span> <span class="n">newrange</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Notes:</span>
<span class="cm"> * 1. The ranges are ordered.  The buses are not ordered.  (First come)</span>
<span class="cm"> *</span>
<span class="cm"> * 2. If cannot allocate out of PFMem range, allocate from Mem ranges.  PFmemFromMem</span>
<span class="cm"> * are not sorted. (no need since use mem node). To not change the entire code, we</span>
<span class="cm"> * also add mem node whenever this case happens so as not to change</span>
<span class="cm"> * ibmphp_check_mem_resource etc (and since it really is taking Mem resource)</span>
<span class="cm"> */</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * This is the Resource Management initialization function.  It will go through</span>
<span class="cm"> * the Resource list taken from EBDA and fill in this module&#39;s data structures</span>
<span class="cm"> *</span>
<span class="cm"> * THIS IS NOT TAKING INTO CONSIDERATION IO RESTRICTIONS OF PRIMARY BUSES, </span>
<span class="cm"> * SINCE WE&#39;RE GOING TO ASSUME FOR NOW WE DON&#39;T HAVE THOSE ON OUR BUSES FOR NOW</span>
<span class="cm"> *</span>
<span class="cm"> * Input: ptr to the head of the resource list from EBDA</span>
<span class="cm"> * Output: 0, -1 or error codes</span>
<span class="cm"> ***************************************************************************/</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">ibmphp_rsrc_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ebda_pci_rsrc</span> <span class="o">*</span><span class="n">curr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">newrange</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">newbus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">new_io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">new_mem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">new_pfmem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp_ebda</span><span class="p">;</span>

	<span class="n">list_for_each</span> <span class="p">(</span><span class="n">tmp_ebda</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ibmphp_ebda_pci_rsrc_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">curr</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">tmp_ebda</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ebda_pci_rsrc</span><span class="p">,</span> <span class="n">ebda_pci_rsrc_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">rsrc_type</span> <span class="o">&amp;</span> <span class="n">PCIDEVMASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* EBDA still lists non PCI devices, so ignore... */</span>
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;this is not a PCI DEVICE in rsrc_init, please take care</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>continue;</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>

		<span class="cm">/* this is a primary bus resource */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">rsrc_type</span> <span class="o">&amp;</span> <span class="n">PRIMARYBUSMASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* memory */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">rsrc_type</span> <span class="o">&amp;</span> <span class="n">RESTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">MMASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* no bus structure exists in place yet */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">gbuses</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">alloc_bus_range</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">newbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newrange</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
						<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
					<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">newbus</span><span class="o">-&gt;</span><span class="n">bus_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gbuses</span><span class="p">);</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;gbuses = NULL, Memory Primary Bus %x [%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">newbus</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">bus_cur</span> <span class="o">=</span> <span class="n">find_bus_wprev</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">bus_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus_prev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="cm">/* found our bus */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">rc</span> <span class="o">=</span> <span class="n">alloc_bus_range</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">bus_cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newrange</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
							<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* went through all the buses and didn&#39;t find ours, need to create a new bus node */</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">alloc_bus_range</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">newbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newrange</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
							<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

						<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">newbus</span><span class="o">-&gt;</span><span class="n">bus_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gbuses</span><span class="p">);</span>
						<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;New Bus, Memory Primary Bus %x [%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">newbus</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">rsrc_type</span> <span class="o">&amp;</span> <span class="n">RESTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">PFMASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* prefetchable memory */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">gbuses</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* no bus structure exists in place yet */</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">alloc_bus_range</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">newbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newrange</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">PFMEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
						<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
					<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">newbus</span><span class="o">-&gt;</span><span class="n">bus_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gbuses</span><span class="p">);</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;gbuses = NULL, PFMemory Primary Bus %x [%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">newbus</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">bus_cur</span> <span class="o">=</span> <span class="n">find_bus_wprev</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">bus_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus_prev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* found our bus */</span>
						<span class="n">rc</span> <span class="o">=</span> <span class="n">alloc_bus_range</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">bus_cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newrange</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">PFMEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
							<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* went through all the buses and didn&#39;t find ours, need to create a new bus node */</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">alloc_bus_range</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">newbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newrange</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">PFMEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
							<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
						<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">newbus</span><span class="o">-&gt;</span><span class="n">bus_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gbuses</span><span class="p">);</span>
						<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;1st Bus, PFMemory Primary Bus %x [%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">newbus</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">rsrc_type</span> <span class="o">&amp;</span> <span class="n">RESTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IOMASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* IO */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">gbuses</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* no bus structure exists in place yet */</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">alloc_bus_range</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">newbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newrange</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">IO</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
						<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
					<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">newbus</span><span class="o">-&gt;</span><span class="n">bus_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gbuses</span><span class="p">);</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;gbuses = NULL, IO Primary Bus %x [%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">newbus</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">bus_cur</span> <span class="o">=</span> <span class="n">find_bus_wprev</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">bus_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus_prev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">rc</span> <span class="o">=</span> <span class="n">alloc_bus_range</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">bus_cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newrange</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">IO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
							<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* went through all the buses and didn&#39;t find ours, need to create a new bus node */</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">alloc_bus_range</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">newbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newrange</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">IO</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
							<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
						<span class="n">list_add_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">newbus</span><span class="o">-&gt;</span><span class="n">bus_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gbuses</span><span class="p">);</span>
						<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;1st Bus, IO Primary Bus %x [%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">newbus</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">newrange</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="p">;</span>	<span class="cm">/* type is reserved  WHAT TO DO IN THIS CASE???</span>
<span class="cm">					   NOTHING TO DO??? */</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* regular pci device resource */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">rsrc_type</span> <span class="o">&amp;</span> <span class="n">RESTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">MMASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Memory resource */</span>
				<span class="n">new_mem</span> <span class="o">=</span> <span class="n">alloc_resources</span> <span class="p">(</span><span class="n">curr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_mem</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">new_mem</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MEM</span><span class="p">;</span>
				<span class="cm">/*</span>
<span class="cm">				 * if it didn&#39;t find the bus, means PCI dev</span>
<span class="cm">				 * came b4 the Primary Bus info, so need to</span>
<span class="cm">				 * create a bus rangeno becomes a problem...</span>
<span class="cm">				 * assign a -1 and then update once the range</span>
<span class="cm">				 * actually appears...</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">new_mem</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">newbus</span> <span class="o">=</span> <span class="n">alloc_error_bus</span> <span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newbus</span><span class="p">)</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="n">newbus</span><span class="o">-&gt;</span><span class="n">firstMem</span> <span class="o">=</span> <span class="n">new_mem</span><span class="p">;</span>
					<span class="o">++</span><span class="n">newbus</span><span class="o">-&gt;</span><span class="n">needMemUpdate</span><span class="p">;</span>
					<span class="n">new_mem</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;Memory resource for device %x, bus %x, [%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new_mem</span><span class="o">-&gt;</span><span class="n">devfunc</span><span class="p">,</span> <span class="n">new_mem</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">new_mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">new_mem</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">rsrc_type</span> <span class="o">&amp;</span> <span class="n">RESTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">PFMASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* PFMemory resource */</span>
				<span class="n">new_pfmem</span> <span class="o">=</span> <span class="n">alloc_resources</span> <span class="p">(</span><span class="n">curr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_pfmem</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">new_pfmem</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PFMEM</span><span class="p">;</span>
				<span class="n">new_pfmem</span><span class="o">-&gt;</span><span class="n">fromMem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">new_pfmem</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">newbus</span> <span class="o">=</span> <span class="n">alloc_error_bus</span> <span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newbus</span><span class="p">)</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="n">newbus</span><span class="o">-&gt;</span><span class="n">firstPFMem</span> <span class="o">=</span> <span class="n">new_pfmem</span><span class="p">;</span>
					<span class="o">++</span><span class="n">newbus</span><span class="o">-&gt;</span><span class="n">needPFMemUpdate</span><span class="p">;</span>
					<span class="n">new_pfmem</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;PFMemory resource for device %x, bus %x, [%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new_pfmem</span><span class="o">-&gt;</span><span class="n">devfunc</span><span class="p">,</span> <span class="n">new_pfmem</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">new_pfmem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">new_pfmem</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">rsrc_type</span> <span class="o">&amp;</span> <span class="n">RESTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IOMASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* IO resource */</span>
				<span class="n">new_io</span> <span class="o">=</span> <span class="n">alloc_resources</span> <span class="p">(</span><span class="n">curr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_io</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">new_io</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">IO</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * if it didn&#39;t find the bus, means PCI dev</span>
<span class="cm">				 * came b4 the Primary Bus info, so need to</span>
<span class="cm">				 * create a bus rangeno becomes a problem...</span>
<span class="cm">				 * Can assign a -1 and then update once the</span>
<span class="cm">				 * range actually appears...</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">new_io</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">newbus</span> <span class="o">=</span> <span class="n">alloc_error_bus</span> <span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newbus</span><span class="p">)</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="n">newbus</span><span class="o">-&gt;</span><span class="n">firstIO</span> <span class="o">=</span> <span class="n">new_io</span><span class="p">;</span>
					<span class="o">++</span><span class="n">newbus</span><span class="o">-&gt;</span><span class="n">needIOUpdate</span><span class="p">;</span>
					<span class="n">new_io</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;IO resource for device %x, bus %x, [%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new_io</span><span class="o">-&gt;</span><span class="n">devfunc</span><span class="p">,</span> <span class="n">new_io</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">new_io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">new_io</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_for_each</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gbuses</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus_cur</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bus_node</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">);</span>
		<span class="cm">/* This is to get info about PPB resources, since EBDA doesn&#39;t put this info into the primary bus info */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">update_bridge_ranges</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">bus_cur</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">once_over</span> <span class="p">();</span>  <span class="cm">/* This is to align ranges (so no -1) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************************************</span>
<span class="cm"> * This function adds a range into a sorted list of ranges per bus for a particular</span>
<span class="cm"> * range type, it then calls another routine to update the range numbers on the</span>
<span class="cm"> * pci devices&#39; resources for the appropriate resource</span>
<span class="cm"> *</span>
<span class="cm"> * Input: type of the resource, range to add, current bus</span>
<span class="cm"> * Output: 0 or -1, bus and range ptrs </span>
<span class="cm"> ********************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_bus_range</span> <span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">range</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">range_cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">range_prev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i_init</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">noRanges</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MEM</span>:
			<span class="n">range_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeMem</span><span class="p">;</span>
			<span class="n">noRanges</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noMemRanges</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PFMEM</span>:
			<span class="n">range_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="p">;</span>
			<span class="n">noRanges</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IO</span>:
			<span class="n">range_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeIO</span><span class="p">;</span>
			<span class="n">noRanges</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noIORanges</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">range_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">range_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">range_prev</span> <span class="o">=</span> <span class="n">range_cur</span><span class="p">;</span>
		<span class="n">range_cur</span> <span class="o">=</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* our range will go at the beginning of the list */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">MEM</span>:
				<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeMem</span> <span class="o">=</span> <span class="n">range</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PFMEM</span>:
				<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangePFMem</span> <span class="o">=</span> <span class="n">range</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IO</span>:
				<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeIO</span> <span class="o">=</span> <span class="n">range</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">range_cur</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">i_init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">range_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* our range will go at the end of the list */</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">range_prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">range</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="n">range_prev</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* the range is in the middle */</span>
		<span class="n">range_prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">range</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">range_cur</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">;</span>
		<span class="n">i_init</span> <span class="o">=</span> <span class="n">range_prev</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="n">i_init</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">noRanges</span><span class="p">;</span> <span class="o">++</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">;</span>
		<span class="n">range_cur</span> <span class="o">=</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">update_resources</span> <span class="p">(</span><span class="n">bus_cur</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">i_init</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************************</span>
<span class="cm"> * This routine goes through the list of resources of type &#39;type&#39; and updates</span>
<span class="cm"> * the range numbers that they correspond to.  It was called from add_bus_range fnc</span>
<span class="cm"> *</span>
<span class="cm"> * Input: bus, type of the resource, the rangeno starting from which to update</span>
<span class="cm"> ******************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_resources</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rangeno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">eol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* end of list indicator */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MEM</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span><span class="p">)</span> 
				<span class="n">res</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PFMEM</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IO</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">==</span> <span class="n">rangeno</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">eol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eol</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* found the range */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">++</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">;</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fix_me</span> <span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span><span class="p">,</span> <span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">range</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="n">str</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IO</span>:
			<span class="n">str</span> <span class="o">=</span> <span class="s">&quot;io&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM</span>:
			<span class="n">str</span> <span class="o">=</span> <span class="s">&quot;mem&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PFMEM</span>:
			<span class="n">str</span> <span class="o">=</span> <span class="s">&quot;pfmem&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">range</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">;</span>
					<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s-&gt;rangeno in fix_resources is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">);</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">case</span> <span class="n">IO</span>:
							<span class="o">--</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">needIOUpdate</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="k">case</span> <span class="n">MEM</span>:
							<span class="o">--</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">needMemUpdate</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="k">case</span> <span class="n">PFMEM</span>:
							<span class="o">--</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">needPFMemUpdate</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">range</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * This routine reassigns the range numbers to the resources that had a -1</span>
<span class="cm"> * This case can happen only if upon initialization, resources taken by pci dev</span>
<span class="cm"> * appear in EBDA before the resources allocated for that bus, since we don&#39;t</span>
<span class="cm"> * know the range, we assign -1, and this routine is called after a new range</span>
<span class="cm"> * is assigned to see the resources with unknown range belong to the added range</span>
<span class="cm"> *</span>
<span class="cm"> * Input: current bus</span>
<span class="cm"> * Output: none, list of resources for that bus are fixed if can be</span>
<span class="cm"> *******************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fix_resources</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">range</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - bus_cur-&gt;busno = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">needIOUpdate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span><span class="p">;</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeIO</span><span class="p">;</span>
		<span class="n">fix_me</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">bus_cur</span><span class="p">,</span> <span class="n">range</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">needMemUpdate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span><span class="p">;</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeMem</span><span class="p">;</span>
		<span class="n">fix_me</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">bus_cur</span><span class="p">,</span> <span class="n">range</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">needPFMemUpdate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">;</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="p">;</span>
		<span class="n">fix_me</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">bus_cur</span><span class="p">,</span> <span class="n">range</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************************</span>
<span class="cm"> * This routine adds a resource to the list of resources to the appropriate bus </span>
<span class="cm"> * based on their resource type and sorted by their starting addresses.  It assigns</span>
<span class="cm"> * the ptrs to next and nextRange if needed.</span>
<span class="cm"> *</span>
<span class="cm"> * Input: resource ptr</span>
<span class="cm"> * Output: ptrs assigned (to the node)</span>
<span class="cm"> * 0 or -1</span>
<span class="cm"> *******************************************************************************/</span>
<span class="kt">int</span> <span class="nf">ibmphp_add_resource</span> <span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res_prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">range_cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res_start</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;NULL passed to add</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">bus_cur</span> <span class="o">=</span> <span class="n">find_bus_wprev</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* didn&#39;t find a bus, smth&#39;s wrong!!! */</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;no bus in the system, either pci_dev&#39;s wrong or allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Normal case */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IO</span>:
			<span class="n">range_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeIO</span><span class="p">;</span>
			<span class="n">res_start</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM</span>:
			<span class="n">range_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeMem</span><span class="p">;</span>
			<span class="n">res_start</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PFMEM</span>:
			<span class="n">range_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="p">;</span>
			<span class="n">res_start</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot read the type of the resource to add... problem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">range_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">range_cur</span> <span class="o">=</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<span class="cm">	 * this is again the case of rangeno = -1</span>
<span class="cm">	 * !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">range_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">IO</span>:
				<span class="o">++</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">needIOUpdate</span><span class="p">;</span>					
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MEM</span>:
				<span class="o">++</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">needMemUpdate</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PFMEM</span>:
				<span class="o">++</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">needPFMemUpdate</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;The range is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no first{IO,Mem,Pfmem} on the bus, 1st IO/Mem/Pfmem resource ever */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">IO</span>:
				<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>					
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MEM</span>:
				<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PFMEM</span>:
				<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>	
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_start</span><span class="p">;</span>
		<span class="n">res_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;res_cur-&gt;rangeno is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">&gt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">res_prev</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
				<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* at the end of the resource list */</span>
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;i should be here, [%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
			<span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">nextRange</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">==</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* in the same range */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">res_prev</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
				<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* the last resource in this range */</span>
				<span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span> <span class="o">=</span> <span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
				<span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">nextRange</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* at the beginning or middle of the range */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_prev</span><span class="p">)</span>	<span class="p">{</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">case</span> <span class="n">IO</span>:
							<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="k">case</span> <span class="n">MEM</span>:
							<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="k">case</span> <span class="n">PFMEM</span>:
							<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">==</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">)</span>
					<span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">nextRange</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>

				<span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* this is the case where it is 1st occurrence of the range */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_prev</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* at the beginning of the resource list */</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">IO</span>:
						<span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span><span class="p">;</span>
						<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">MEM</span>:
						<span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span><span class="p">;</span>
						<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">PFMEM</span>:
						<span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">;</span>
						<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">&gt;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* in the middle of the resource list */</span>
				<span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">nextRange</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * This routine will remove the resource from the list of resources</span>
<span class="cm"> *</span>
<span class="cm"> * Input: io, mem, and/or pfmem resource to be deleted</span>
<span class="cm"> * Ouput: modified resource list</span>
<span class="cm"> *        0 or error code</span>
<span class="cm"> ****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">ibmphp_remove_resource</span> <span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res_cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res_prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">mem_cur</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;resource to remove is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bus_cur</span> <span class="o">=</span> <span class="n">find_bus_wprev</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot find corresponding bus of the io resource to remove  &quot;</span>
			<span class="s">&quot;bailing out...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IO</span>:
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;io&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM</span>:
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;mem&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PFMEM</span>:
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;pfmem&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;unknown type for resource to remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">res_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">==</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">res_prev</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PFMEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* </span>
<span class="cm">			 * case where pfmem might be in the PFMemFromMem list</span>
<span class="cm">			 * so will also need to remove the corresponding mem</span>
<span class="cm">			 * entry</span>
<span class="cm">			 */</span>
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span><span class="p">;</span>
			<span class="n">res_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">==</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">mem_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span><span class="p">;</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">mem_cur</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">mem_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mem_cur</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">==</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">))</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">mem_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
							<span class="n">mem_cur</span> <span class="o">=</span> <span class="n">mem_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
						<span class="k">else</span>
							<span class="n">mem_cur</span> <span class="o">=</span> <span class="n">mem_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_cur</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot find corresponding mem node for pfmem...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">mem_cur</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_prev</span><span class="p">)</span>
						<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
					<span class="n">kfree</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">res_prev</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
					<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot find pfmem to delete...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;the %s resource is not in the list to be deleted...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_prev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* first device to be deleted */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">IO</span>:
					<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">MEM</span>:
					<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">PFMEM</span>:
					<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">IO</span>:
					<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">MEM</span>:
					<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">PFMEM</span>:
					<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">IO</span>:
					<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">MEM</span>:
					<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">PFMEM</span>:
					<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">==</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">)</span>
				<span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">nextRange</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">nextRange</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">nextRange</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span> <span class="nf">find_range</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span> <span class="n">range</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IO</span>:
			<span class="n">range</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM</span>:
			<span class="n">range</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeMem</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PFMEM</span>:
			<span class="n">range</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot read resource type in find_range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">range</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">==</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">range</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * This routine will check to make sure the io/mem/pfmem-&gt;len that the device asked for </span>
<span class="cm"> * can fit w/i our list of available IO/MEM/PFMEM resources.  If cannot, returns -EINVAL,</span>
<span class="cm"> * otherwise, returns 0</span>
<span class="cm"> *</span>
<span class="cm"> * Input: resource</span>
<span class="cm"> * Ouput: the correct start and end address are inputted into the resource node,</span>
<span class="cm"> *        0 or -EINVAL</span>
<span class="cm"> *****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">ibmphp_check_resource</span> <span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">range</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res_prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res_cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len_cur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">start_cur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len_tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">noranges</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp_start</span><span class="p">;</span>		<span class="cm">/* this is to make sure start address is divisible by the length needed */</span>
	<span class="n">u32</span> <span class="n">tmp_divide</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bridge</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The rules for bridges are different, 4K divisible for IO, 1M for (pf)mem*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IO</span><span class="p">)</span>
			<span class="n">tmp_divide</span> <span class="o">=</span> <span class="n">IOBRIDGE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tmp_divide</span> <span class="o">=</span> <span class="n">MEMBRIDGE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tmp_divide</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">bus_cur</span> <span class="o">=</span> <span class="n">find_bus_wprev</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* didn&#39;t find a bus, smth&#39;s wrong!!! */</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;no bus in the system, either pci_dev&#39;s wrong or allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;bus_cur-&gt;busno is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>

	<span class="cm">/* This is a quick fix to not mess up with the code very much.  i.e.,</span>
<span class="cm">	 * 2000-2fff, len = 1000, but when we compare, we need it to be fff */</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IO</span>:
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span><span class="p">;</span>
			<span class="n">noranges</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noIORanges</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM</span>:
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span><span class="p">;</span>
			<span class="n">noranges</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noMemRanges</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PFMEM</span>:
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">;</span>
			<span class="n">noranges</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;wrong type of resource to check</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">res_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">find_range</span> <span class="p">(</span><span class="n">bus_cur</span><span class="p">,</span> <span class="n">res_cur</span><span class="p">);</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;%s - rangeno = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">range</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;no range for the device exists... bailing out...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* found our range */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* first time in the loop */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">!=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;len_tmp = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len_tmp</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">&lt;</span> <span class="n">len_cur</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len_cur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">((</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* just perfect, starting address is divisible by length */</span>
						<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">len_cur</span> <span class="o">=</span> <span class="n">len_tmp</span><span class="p">;</span>
						<span class="n">start_cur</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* Needs adjusting */</span>
						<span class="n">tmp_start</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
						<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

						<span class="k">while</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tmp_start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">((</span><span class="n">tmp_start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
								<span class="n">len_cur</span> <span class="o">=</span> <span class="n">len_tmp</span><span class="p">;</span>
								<span class="n">start_cur</span> <span class="o">=</span> <span class="n">tmp_start</span><span class="p">;</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="n">tmp_start</span> <span class="o">+=</span> <span class="n">tmp_divide</span> <span class="o">-</span> <span class="n">tmp_start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">tmp_start</span> <span class="o">&gt;=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
								<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
			
					<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;&amp;</span> <span class="n">len_cur</span> <span class="o">==</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;but we are not here, right?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_cur</span><span class="p">;</span>
						<span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* To restore the balance */</span>
						<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* last device on the range */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">!=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;len_tmp = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len_tmp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">&lt;</span> <span class="n">len_cur</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len_cur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(((</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* just perfect, starting address is divisible by length */</span>
						<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">len_cur</span> <span class="o">=</span> <span class="n">len_tmp</span><span class="p">;</span>
						<span class="n">start_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* Needs adjusting */</span>
						<span class="n">tmp_start</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

						<span class="k">while</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">tmp_start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">((</span><span class="n">tmp_start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
								<span class="n">len_cur</span> <span class="o">=</span> <span class="n">len_tmp</span><span class="p">;</span>
								<span class="n">start_cur</span> <span class="o">=</span> <span class="n">tmp_start</span><span class="p">;</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="n">tmp_start</span> <span class="o">+=</span> <span class="n">tmp_divide</span> <span class="o">-</span> <span class="n">tmp_start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">tmp_start</span> <span class="o">&gt;=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
								<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;&amp;</span> <span class="n">len_cur</span> <span class="o">==</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_cur</span><span class="p">;</span>
						<span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* To restore the balance */</span>
						<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res_prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">!=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* 1st device on this range */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">!=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
					<span class="p">((</span><span class="n">len_tmp</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">&lt;</span> <span class="n">len_cur</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len_cur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	
							<span class="cm">/* just perfect, starting address is divisible by length */</span>
							<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">len_cur</span> <span class="o">=</span> <span class="n">len_tmp</span><span class="p">;</span>
							<span class="n">start_cur</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="cm">/* Needs adjusting */</span>
							<span class="n">tmp_start</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
							<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

							<span class="k">while</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tmp_start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">if</span> <span class="p">((</span><span class="n">tmp_start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
									<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
									<span class="n">len_cur</span> <span class="o">=</span> <span class="n">len_tmp</span><span class="p">;</span>
									<span class="n">start_cur</span> <span class="o">=</span> <span class="n">tmp_start</span><span class="p">;</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="p">}</span>
								<span class="n">tmp_start</span> <span class="o">+=</span> <span class="n">tmp_divide</span> <span class="o">-</span> <span class="n">tmp_start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">;</span>
								<span class="k">if</span> <span class="p">(</span><span class="n">tmp_start</span> <span class="o">&gt;=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
									<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;&amp;</span> <span class="n">len_cur</span> <span class="o">==</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_cur</span><span class="p">;</span>
							<span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* To restore the balance */</span>
							<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
							<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* in the same range */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">&lt;</span> <span class="n">len_cur</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len_cur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(((</span><span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* just perfect, starting address&#39;s divisible by length */</span>
							<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">len_cur</span> <span class="o">=</span> <span class="n">len_tmp</span><span class="p">;</span>
							<span class="n">start_cur</span> <span class="o">=</span> <span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="cm">/* Needs adjusting */</span>
							<span class="n">tmp_start</span> <span class="o">=</span> <span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

							<span class="k">while</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tmp_start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">if</span> <span class="p">((</span><span class="n">tmp_start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
									<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
									<span class="n">len_cur</span> <span class="o">=</span> <span class="n">len_tmp</span><span class="p">;</span>
									<span class="n">start_cur</span> <span class="o">=</span> <span class="n">tmp_start</span><span class="p">;</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="p">}</span>
								<span class="n">tmp_start</span> <span class="o">+=</span> <span class="n">tmp_divide</span> <span class="o">-</span> <span class="n">tmp_start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">;</span>
								<span class="k">if</span> <span class="p">(</span><span class="n">tmp_start</span> <span class="o">&gt;=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
									<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;&amp;</span> <span class="n">len_cur</span> <span class="o">==</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_cur</span><span class="p">;</span>
							<span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* To restore the balance */</span>
							<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
							<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* end if (res_prev) */</span>
		<span class="n">res_prev</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
	<span class="p">}</span>	<span class="cm">/* end of while */</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_prev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 1st device ever */</span>
		<span class="cm">/* need to find appropriate range */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">IO</span>:
				<span class="n">range</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeIO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MEM</span>:
				<span class="n">range</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeMem</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PFMEM</span>:
				<span class="n">range</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">range</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">&lt;</span> <span class="n">len_cur</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len_cur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* just perfect, starting address&#39;s divisible by length */</span>
						<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">len_cur</span> <span class="o">=</span> <span class="n">len_tmp</span><span class="p">;</span>
						<span class="n">start_cur</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* Needs adjusting */</span>
						<span class="n">tmp_start</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
						<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

						<span class="k">while</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">tmp_start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">((</span><span class="n">tmp_start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
								<span class="n">len_cur</span> <span class="o">=</span> <span class="n">len_tmp</span><span class="p">;</span>
								<span class="n">start_cur</span> <span class="o">=</span> <span class="n">tmp_start</span><span class="p">;</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="n">tmp_start</span> <span class="o">+=</span> <span class="n">tmp_divide</span> <span class="o">-</span> <span class="n">tmp_start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">tmp_start</span> <span class="o">&gt;=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
								<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;&amp;</span> <span class="n">len_cur</span> <span class="o">==</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_cur</span><span class="p">;</span>
						<span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* To restore the balance */</span>
						<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">range</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>		<span class="cm">/* end of while */</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">range</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len_cur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* have gone through the list of devices and ranges and haven&#39;t found n.e.thing */</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;no appropriate range.. bailing out...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len_cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_cur</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* To restore the balance */</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;prev-&gt;rangeno = %d, noranges = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">,</span> <span class="n">noranges</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res_prev</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">&lt;</span> <span class="n">noranges</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* if there&#39;re more ranges out there to check */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">IO</span>:
					<span class="n">range</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeIO</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">MEM</span>:
					<span class="n">range</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeMem</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">PFMEM</span>:
					<span class="n">range</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">range</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">&lt;</span> <span class="n">len_cur</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len_cur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* just perfect, starting address&#39;s divisible by length */</span>
							<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">len_cur</span> <span class="o">=</span> <span class="n">len_tmp</span><span class="p">;</span>
							<span class="n">start_cur</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="cm">/* Needs adjusting */</span>
							<span class="n">tmp_start</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
							<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

							<span class="k">while</span> <span class="p">((</span><span class="n">len_tmp</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">tmp_start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">if</span> <span class="p">((</span><span class="n">tmp_start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
									<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
									<span class="n">len_cur</span> <span class="o">=</span> <span class="n">len_tmp</span><span class="p">;</span>
									<span class="n">start_cur</span> <span class="o">=</span> <span class="n">tmp_start</span><span class="p">;</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="p">}</span>
								<span class="n">tmp_start</span> <span class="o">+=</span> <span class="n">tmp_divide</span> <span class="o">-</span> <span class="n">tmp_start</span> <span class="o">%</span> <span class="n">tmp_divide</span><span class="p">;</span>
								<span class="k">if</span> <span class="p">(</span><span class="n">tmp_start</span> <span class="o">&gt;=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
									<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;&amp;</span> <span class="n">len_cur</span> <span class="o">==</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_cur</span><span class="p">;</span>
							<span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* To restore the balance */</span>
							<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
							<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">range</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/* end of while */</span>

			<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">range</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len_cur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* have gone through the list of devices and ranges and haven&#39;t found n.e.thing */</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;no appropriate range.. bailing out...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len_cur</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_cur</span><span class="p">;</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* To restore the balance */</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* no more ranges to check on */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len_cur</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_cur</span><span class="p">;</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* To restore the balance */</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* have gone through the list of devices and haven&#39;t found n.e.thing */</span>
				<span class="n">err</span> <span class="p">(</span><span class="s">&quot;no appropriate range.. bailing out...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>	<span class="cm">/* end if(!res_cur) */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************************************</span>
<span class="cm"> * This routine is called from remove_card if the card contained PPB.</span>
<span class="cm"> * It will remove all the resources on the bus as well as the bus itself</span>
<span class="cm"> * Input: Bus</span>
<span class="cm"> * Ouput: 0, -ENODEV</span>
<span class="cm"> ********************************************************************************/</span>
<span class="kt">int</span> <span class="nf">ibmphp_remove_bus</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">u8</span> <span class="n">parent_busno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">prev_bus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">prev_bus</span> <span class="o">=</span> <span class="n">find_bus_wprev</span> <span class="p">(</span><span class="n">parent_busno</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prev_bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;something terribly wrong. Cannot find parent bus to the one to remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;In ibmphp_remove_bus... prev_bus-&gt;busno is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prev_bus</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">remove_ranges</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">prev_bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstIO</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res_tmp</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
				<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">res_tmp</span><span class="p">);</span>
			<span class="n">res_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstIO</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstMem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstMem</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res_tmp</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
				<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">res_tmp</span><span class="p">);</span>
			<span class="n">res_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstMem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res_tmp</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
				<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">res_tmp</span><span class="p">);</span>
			<span class="n">res_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstPFMem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res_tmp</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

			<span class="n">kfree</span> <span class="p">(</span><span class="n">res_tmp</span><span class="p">);</span>
			<span class="n">res_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_del</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bus_list</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * This routine deletes the ranges from a given bus, and the entries from the </span>
<span class="cm"> * parent&#39;s bus in the resources</span>
<span class="cm"> * Input: current bus, previous bus</span>
<span class="cm"> * Output: 0, -EINVAL</span>
<span class="cm"> ******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">remove_ranges</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_prev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">range_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">range_tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noIORanges</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">range_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeIO</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noIORanges</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_find_resource</span> <span class="p">(</span><span class="n">bus_prev</span><span class="p">,</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="n">IO</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">res</span><span class="p">);</span>

			<span class="n">range_tmp</span> <span class="o">=</span> <span class="n">range_cur</span><span class="p">;</span>
			<span class="n">range_cur</span> <span class="o">=</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">range_tmp</span><span class="p">);</span>
			<span class="n">range_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeIO</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noMemRanges</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">range_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeMem</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noMemRanges</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_find_resource</span> <span class="p">(</span><span class="n">bus_prev</span><span class="p">,</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="n">MEM</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">res</span><span class="p">);</span>
			<span class="n">range_tmp</span> <span class="o">=</span> <span class="n">range_cur</span><span class="p">;</span>
			<span class="n">range_cur</span> <span class="o">=</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">range_tmp</span><span class="p">);</span>
			<span class="n">range_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeMem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">range_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_find_resource</span> <span class="p">(</span><span class="n">bus_prev</span><span class="p">,</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="n">PFMEM</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">ibmphp_remove_resource</span> <span class="p">(</span><span class="n">res</span><span class="p">);</span>
			<span class="n">range_tmp</span> <span class="o">=</span> <span class="n">range_cur</span><span class="p">;</span>
			<span class="n">range_cur</span> <span class="o">=</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">range_tmp</span><span class="p">);</span>
			<span class="n">range_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangePFMem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * find the resource node in the bus </span>
<span class="cm"> * Input: Resource needed, start address of the resource, type of resource</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ibmphp_find_resource</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">u32</span> <span class="n">start_address</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource_node</span> <span class="o">**</span><span class="n">res</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res_cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;The bus passed in NULL to find resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IO</span>:
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstIO</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;io&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM</span>:
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstMem</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;mem&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PFMEM</span>:
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;pfmem&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;wrong type of flag</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">while</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="n">start_address</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">PFMEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="n">start_address</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;SOS...cannot find %s resource in the bus.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;SOS... cannot find %s resource in the bus.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">)</span>
		<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;*res-&gt;start = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * This routine will free the resource structures used by the</span>
<span class="cm"> * system.  It is called from cleanup routine for the module</span>
<span class="cm"> * Parameters: none</span>
<span class="cm"> * Returns: none</span>
<span class="cm"> ***********************************************************************/</span>
<span class="kt">void</span> <span class="nf">ibmphp_free_resources</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">range_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">range_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gbuses</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus_cur</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bus_node</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noIORanges</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">range_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeIO</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noIORanges</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">range_cur</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">range_tmp</span> <span class="o">=</span> <span class="n">range_cur</span><span class="p">;</span>
				<span class="n">range_cur</span> <span class="o">=</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">kfree</span> <span class="p">(</span><span class="n">range_tmp</span><span class="p">);</span>
				<span class="n">range_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noMemRanges</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">range_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeMem</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noMemRanges</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">range_cur</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">range_tmp</span> <span class="o">=</span> <span class="n">range_cur</span><span class="p">;</span>
				<span class="n">range_cur</span> <span class="o">=</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">kfree</span> <span class="p">(</span><span class="n">range_tmp</span><span class="p">);</span>
				<span class="n">range_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">range_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">range_cur</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">range_tmp</span> <span class="o">=</span> <span class="n">range_cur</span><span class="p">;</span>
				<span class="n">range_cur</span> <span class="o">=</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">kfree</span> <span class="p">(</span><span class="n">range_tmp</span><span class="p">);</span>
				<span class="n">range_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">res_tmp</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
					<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
				<span class="n">kfree</span> <span class="p">(</span><span class="n">res_tmp</span><span class="p">);</span>
				<span class="n">res_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">res_tmp</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
					<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
				<span class="n">kfree</span> <span class="p">(</span><span class="n">res_tmp</span><span class="p">);</span>
				<span class="n">res_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">res_tmp</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
					<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
				<span class="n">kfree</span> <span class="p">(</span><span class="n">res_tmp</span><span class="p">);</span>
				<span class="n">res_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res_cur</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">res_tmp</span> <span class="o">=</span> <span class="n">res_cur</span><span class="p">;</span>
				<span class="n">res_cur</span> <span class="o">=</span> <span class="n">res_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

				<span class="n">kfree</span> <span class="p">(</span><span class="n">res_tmp</span><span class="p">);</span>
				<span class="n">res_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bus_tmp</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="p">;</span>
		<span class="n">list_del</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">bus_list</span><span class="p">);</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">bus_tmp</span><span class="p">);</span>
		<span class="n">bus_tmp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************************************************</span>
<span class="cm"> * This function will go over the PFmem resources to check if the EBDA allocated</span>
<span class="cm"> * pfmem out of memory buckets of the bus.  If so, it will change the range numbers</span>
<span class="cm"> * and a flag to indicate that this resource is out of memory. It will also move the</span>
<span class="cm"> * Pfmem out of the pfmem resource list to the PFMemFromMem list, and will create</span>
<span class="cm"> * a new Mem node</span>
<span class="cm"> * This routine is called right after initialization</span>
<span class="cm"> *******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">once_over</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">pfmem_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">pfmem_prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gbuses</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus_cur</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bus_node</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">pfmem_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">,</span> <span class="n">pfmem_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">pfmem_cur</span><span class="p">;</span> <span class="n">pfmem_prev</span> <span class="o">=</span> <span class="n">pfmem_cur</span><span class="p">,</span> <span class="n">pfmem_cur</span> <span class="o">=</span> <span class="n">pfmem_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pfmem_cur</span><span class="o">-&gt;</span><span class="n">fromMem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pfmem_prev</span><span class="p">)</span>
					<span class="n">pfmem_prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pfmem_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span> <span class="o">=</span> <span class="n">pfmem_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span><span class="p">)</span>
					<span class="n">pfmem_cur</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="cm">/* we don&#39;t need to sort PFMemFromMem since we&#39;re using mem node for</span>
<span class="cm">					   all the real work anyways, so just insert at the beginning of the</span>
<span class="cm">					   list</span>
<span class="cm">					 */</span>
					<span class="n">pfmem_cur</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span><span class="p">;</span>

				<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span> <span class="o">=</span> <span class="n">pfmem_cur</span><span class="p">;</span>

				<span class="n">mem</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">mem</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MEM</span><span class="p">;</span>
				<span class="n">mem</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">pfmem_cur</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
				<span class="n">mem</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="n">pfmem_cur</span><span class="o">-&gt;</span><span class="n">devfunc</span><span class="p">;</span>
				<span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">pfmem_cur</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
				<span class="n">mem</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">pfmem_cur</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
				<span class="n">mem</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">pfmem_cur</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">err</span> <span class="p">(</span><span class="s">&quot;Trouble...trouble... EBDA allocated pfmem from mem, but system doesn&#39;t display it has this space... unless not PCI device...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">pfmem_cur</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/* end for pfmem */</span>
		<span class="p">}</span>	<span class="cm">/* end if */</span>
	<span class="p">}</span>	<span class="cm">/* end list_for_each bus */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> 
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ibmphp_add_pfmem_from_mem</span> <span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">pfmem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span> <span class="o">=</span> <span class="n">find_bus_wprev</span> <span class="p">(</span><span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;cannot find bus of pfmem to add...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span><span class="p">)</span>
		<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span> <span class="o">=</span> <span class="n">pfmem</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This routine just goes through the buses to see if the bus already exists.</span>
<span class="cm"> * It is called from ibmphp_find_sec_number, to find out a secondary bus number for</span>
<span class="cm"> * bridged cards</span>
<span class="cm"> * Parameters: bus_number</span>
<span class="cm"> * Returns: Bus pointer or NULL</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="nf">ibmphp_find_res_bus</span> <span class="p">(</span><span class="n">u8</span> <span class="n">bus_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">find_bus_wprev</span> <span class="p">(</span><span class="n">bus_number</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="nf">find_bus_wprev</span> <span class="p">(</span><span class="n">u8</span> <span class="n">bus_number</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bus_node</span> <span class="o">**</span><span class="n">prev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp_prev</span><span class="p">;</span>

	<span class="n">list_for_each</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gbuses</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_prev</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
		<span class="n">bus_cur</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bus_node</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> 
			<span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">tmp_prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bus_node</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">==</span> <span class="n">bus_number</span><span class="p">)</span> 
			<span class="k">return</span> <span class="n">bus_cur</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ibmphp_print_test</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">range</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	
	<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;*****************START**********************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gbuses</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="p">(</span><span class="s">&quot;The GBUSES is not NULL?!?!?!?!?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gbuses</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus_cur</span> <span class="o">=</span> <span class="n">list_entry</span> <span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bus_node</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">);</span>
		<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;This is bus # %d.  There are</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>
		<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;IORanges = %d</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noIORanges</span><span class="p">);</span>
		<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;MemRanges = %d</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noMemRanges</span><span class="p">);</span>
		<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;PFMemRanges = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span><span class="p">);</span>
		<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;The IO Ranges are as follows:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">range</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeIO</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noIORanges</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;rangeno is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">);</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;[%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
				<span class="n">range</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;The Mem Ranges are as follows:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeMem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">range</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeMem</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noMemRanges</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;rangeno is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">);</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;[%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
				<span class="n">range</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;The PFMem Ranges are as follows:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">range</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;rangeno is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">);</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;[%x - %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
				<span class="n">range</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;The resources on this bus are as follows</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;IO...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstIO</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;The range # is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">);</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;The bus, devfnc is %d, %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">devfunc</span><span class="p">);</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;[%x - %x], len=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">)</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;Mem...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstMem</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;The range # is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">);</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;The bus, devfnc is %d, %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">devfunc</span><span class="p">);</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;[%x - %x], len=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">)</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;PFMem...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMem</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;The range # is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">);</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;The bus, devfnc is %d, %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">devfunc</span><span class="p">);</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;[%x - %x], len=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">)</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">nextRange</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;PFMemFromMem...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">firstPFMemFromMem</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;The range # is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">rangeno</span><span class="p">);</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;The bus, devfnc is %d, %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">devfunc</span><span class="p">);</span>
				<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;[%x - %x], len=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">debug_pci</span> <span class="p">(</span><span class="s">&quot;***********************END***********************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">range_exists_already</span> <span class="p">(</span><span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span> <span class="n">range</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span> <span class="n">bus_cur</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span> <span class="n">range_cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IO</span>:
			<span class="n">range_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM</span>:
			<span class="n">range_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangeMem</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PFMEM</span>:
			<span class="n">range_cur</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">rangePFMem</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="p">(</span><span class="s">&quot;wrong type passed to find out if range already exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">range_cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">==</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">range_cur</span> <span class="o">=</span> <span class="n">range_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This routine will read the windows for any PPB we have and update the</span>
<span class="cm"> * range info for the secondary bus, and will also input this info into</span>
<span class="cm"> * primary bus, since BIOS doesn&#39;t. This is for PPB that are in the system</span>
<span class="cm"> * on bootup.  For bridged cards that were added during previous load of the</span>
<span class="cm"> * driver, only the ranges and the bus structure are added, the devices are</span>
<span class="cm"> * added from NVRAM</span>
<span class="cm"> * Input: primary busno</span>
<span class="cm"> * Returns: none</span>
<span class="cm"> * Note: this function doesn&#39;t take into account IO restrictions etc,</span>
<span class="cm"> *	 so will only work for bridges with no video/ISA devices behind them It</span>
<span class="cm"> *	 also will not work for onboard PPB&#39;s that can have more than 1 *bus</span>
<span class="cm"> *	 behind them All these are TO DO.</span>
<span class="cm"> *	 Also need to add more error checkings... (from fnc returns etc)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">update_bridge_ranges</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bus_node</span> <span class="o">**</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">sec_busno</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">hdr_type</span><span class="p">,</span> <span class="n">start_io_address</span><span class="p">,</span> <span class="n">end_io_address</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vendor_id</span><span class="p">,</span> <span class="n">upper_io_start</span><span class="p">,</span> <span class="n">upper_io_end</span><span class="p">,</span> <span class="n">start_mem_address</span><span class="p">,</span> <span class="n">end_mem_address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start_address</span><span class="p">,</span> <span class="n">end_address</span><span class="p">,</span> <span class="n">upper_start</span><span class="p">,</span> <span class="n">upper_end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_sec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bus_node</span> <span class="o">*</span><span class="n">bus_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">io</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_node</span> <span class="o">*</span><span class="n">pfmem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">range_node</span> <span class="o">*</span><span class="n">range</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>

	<span class="n">bus_cur</span> <span class="o">=</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus_cur</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">ibmphp_pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>

	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;inside %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">debug</span> <span class="p">(</span><span class="s">&quot;bus_cur-&gt;busno = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">device</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">device</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">function</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">function</span> <span class="o">&lt;</span> <span class="mh">0x08</span><span class="p">;</span> <span class="n">function</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
			<span class="n">pci_bus_read_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vendor_id</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">vendor_id</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_NOTVALID</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* found correct device!!! */</span>
				<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr_type</span><span class="p">);</span>

				<span class="k">switch</span> <span class="p">(</span><span class="n">hdr_type</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">PCI_HEADER_TYPE_NORMAL</span>:
						<span class="n">function</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">PCI_HEADER_TYPE_MULTIDEVICE</span>:
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span>:
						<span class="n">function</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">PCI_HEADER_TYPE_MULTIBRIDGE</span>:
						<span class="cm">/* We assume here that only 1 bus behind the bridge </span>
<span class="cm">						   TO DO: add functionality for several:</span>
<span class="cm">						   temp = secondary;</span>
<span class="cm">						   while (temp &lt; subordinate) {</span>
<span class="cm">						   ...</span>
<span class="cm">						   temp++;</span>
<span class="cm">						   }</span>
<span class="cm">						 */</span>
						<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sec_busno</span><span class="p">);</span>
						<span class="n">bus_sec</span> <span class="o">=</span> <span class="n">find_bus_wprev</span> <span class="p">(</span><span class="n">sec_busno</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> 
						<span class="cm">/* this bus structure doesn&#39;t exist yet, PPB was configured during previous loading of ibmphp */</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus_sec</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">bus_sec</span> <span class="o">=</span> <span class="n">alloc_error_bus</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sec_busno</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
							<span class="cm">/* the rest will be populated during NVRAM call */</span>
							<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start_io_address</span><span class="p">);</span>
						<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_LIMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end_io_address</span><span class="p">);</span>
						<span class="n">pci_bus_read_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_BASE_UPPER16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">upper_io_start</span><span class="p">);</span>
						<span class="n">pci_bus_read_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_LIMIT_UPPER16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">upper_io_end</span><span class="p">);</span>
						<span class="n">start_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_io_address</span> <span class="o">&amp;</span> <span class="n">PCI_IO_RANGE_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
						<span class="n">start_address</span> <span class="o">|=</span> <span class="p">(</span><span class="n">upper_io_start</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
						<span class="n">end_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_io_address</span> <span class="o">&amp;</span> <span class="n">PCI_IO_RANGE_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
						<span class="n">end_address</span> <span class="o">|=</span> <span class="p">(</span><span class="n">upper_io_end</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

						<span class="k">if</span> <span class="p">((</span><span class="n">start_address</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">start_address</span> <span class="o">&lt;=</span> <span class="n">end_address</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">range</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">range_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
							<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">range</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
								<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_address</span><span class="p">;</span>
							<span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">end_address</span> <span class="o">+</span> <span class="mh">0xfff</span><span class="p">;</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">bus_sec</span><span class="o">-&gt;</span><span class="n">noIORanges</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">range_exists_already</span> <span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="n">bus_sec</span><span class="p">,</span> <span class="n">IO</span><span class="p">))</span> <span class="p">{</span>
									<span class="n">add_bus_range</span> <span class="p">(</span><span class="n">IO</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">bus_sec</span><span class="p">);</span>
									<span class="o">++</span><span class="n">bus_sec</span><span class="o">-&gt;</span><span class="n">noIORanges</span><span class="p">;</span>
								<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
									<span class="n">kfree</span> <span class="p">(</span><span class="n">range</span><span class="p">);</span>
									<span class="n">range</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
								<span class="p">}</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="cm">/* 1st IO Range on the bus */</span>
								<span class="n">range</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
								<span class="n">bus_sec</span><span class="o">-&gt;</span><span class="n">rangeIO</span> <span class="o">=</span> <span class="n">range</span><span class="p">;</span>
								<span class="o">++</span><span class="n">bus_sec</span><span class="o">-&gt;</span><span class="n">noIORanges</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="n">fix_resources</span> <span class="p">(</span><span class="n">bus_sec</span><span class="p">);</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_find_resource</span> <span class="p">(</span><span class="n">bus_cur</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="p">,</span> <span class="n">IO</span><span class="p">))</span> <span class="p">{</span>
								<span class="n">io</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
								<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io</span><span class="p">)</span> <span class="p">{</span>
									<span class="n">kfree</span> <span class="p">(</span><span class="n">range</span><span class="p">);</span>
									<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
									<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
								<span class="p">}</span>
								<span class="n">io</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">IO</span><span class="p">;</span>
								<span class="n">io</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
								<span class="n">io</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="p">((</span><span class="n">device</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">function</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">));</span>
								<span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_address</span><span class="p">;</span>
								<span class="n">io</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">end_address</span> <span class="o">+</span> <span class="mh">0xfff</span><span class="p">;</span>
								<span class="n">io</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
								<span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">io</span><span class="p">);</span>
							<span class="p">}</span>
						<span class="p">}</span>	

						<span class="n">pci_bus_read_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_MEMORY_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start_mem_address</span><span class="p">);</span>
						<span class="n">pci_bus_read_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_MEMORY_LIMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end_mem_address</span><span class="p">);</span>

						<span class="n">start_address</span> <span class="o">=</span> <span class="mh">0x00000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">start_mem_address</span> <span class="o">&amp;</span> <span class="n">PCI_MEMORY_RANGE_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
						<span class="n">end_address</span> <span class="o">=</span> <span class="mh">0x00000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">end_mem_address</span> <span class="o">&amp;</span> <span class="n">PCI_MEMORY_RANGE_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

						<span class="k">if</span> <span class="p">((</span><span class="n">start_address</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">start_address</span> <span class="o">&lt;=</span> <span class="n">end_address</span><span class="p">))</span> <span class="p">{</span>

							<span class="n">range</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">range_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
							<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">range</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
								<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_address</span><span class="p">;</span>
							<span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">end_address</span> <span class="o">+</span> <span class="mh">0xfffff</span><span class="p">;</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">bus_sec</span><span class="o">-&gt;</span><span class="n">noMemRanges</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">range_exists_already</span> <span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="n">bus_sec</span><span class="p">,</span> <span class="n">MEM</span><span class="p">))</span> <span class="p">{</span>
									<span class="n">add_bus_range</span> <span class="p">(</span><span class="n">MEM</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">bus_sec</span><span class="p">);</span>
									<span class="o">++</span><span class="n">bus_sec</span><span class="o">-&gt;</span><span class="n">noMemRanges</span><span class="p">;</span>
								<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
									<span class="n">kfree</span> <span class="p">(</span><span class="n">range</span><span class="p">);</span>
									<span class="n">range</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
								<span class="p">}</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="cm">/* 1st Mem Range on the bus */</span>
								<span class="n">range</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
								<span class="n">bus_sec</span><span class="o">-&gt;</span><span class="n">rangeMem</span> <span class="o">=</span> <span class="n">range</span><span class="p">;</span>
								<span class="o">++</span><span class="n">bus_sec</span><span class="o">-&gt;</span><span class="n">noMemRanges</span><span class="p">;</span>
							<span class="p">}</span>

							<span class="n">fix_resources</span> <span class="p">(</span><span class="n">bus_sec</span><span class="p">);</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_find_resource</span> <span class="p">(</span><span class="n">bus_cur</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="p">,</span> <span class="n">MEM</span><span class="p">))</span> <span class="p">{</span>
								<span class="n">mem</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
								<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
									<span class="n">kfree</span> <span class="p">(</span><span class="n">range</span><span class="p">);</span>
									<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
									<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
								<span class="p">}</span>
								<span class="n">mem</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MEM</span><span class="p">;</span>
								<span class="n">mem</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
								<span class="n">mem</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="p">((</span><span class="n">device</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">function</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">));</span>
								<span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_address</span><span class="p">;</span>
								<span class="n">mem</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">end_address</span> <span class="o">+</span> <span class="mh">0xfffff</span><span class="p">;</span>
								<span class="n">mem</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
								<span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">mem</span><span class="p">);</span>
							<span class="p">}</span>
						<span class="p">}</span>
						<span class="n">pci_bus_read_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start_mem_address</span><span class="p">);</span>
						<span class="n">pci_bus_read_config_word</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_LIMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end_mem_address</span><span class="p">);</span>
						<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_BASE_UPPER32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">upper_start</span><span class="p">);</span>
						<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_LIMIT_UPPER32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">upper_end</span><span class="p">);</span>
						<span class="n">start_address</span> <span class="o">=</span> <span class="mh">0x00000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">start_mem_address</span> <span class="o">&amp;</span> <span class="n">PCI_MEMORY_RANGE_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
						<span class="n">end_address</span> <span class="o">=</span> <span class="mh">0x00000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">end_mem_address</span> <span class="o">&amp;</span> <span class="n">PCI_MEMORY_RANGE_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="cp">#if BITS_PER_LONG == 64</span>
						<span class="n">start_address</span> <span class="o">|=</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">upper_start</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
						<span class="n">end_address</span> <span class="o">|=</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">upper_end</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
<span class="cp">#endif</span>

						<span class="k">if</span> <span class="p">((</span><span class="n">start_address</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">start_address</span> <span class="o">&lt;=</span> <span class="n">end_address</span><span class="p">))</span> <span class="p">{</span>

							<span class="n">range</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">range_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
							<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">range</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
								<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="n">range</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_address</span><span class="p">;</span>
							<span class="n">range</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">end_address</span> <span class="o">+</span> <span class="mh">0xfffff</span><span class="p">;</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">bus_sec</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
								<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">range_exists_already</span> <span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="n">bus_sec</span><span class="p">,</span> <span class="n">PFMEM</span><span class="p">))</span> <span class="p">{</span>
									<span class="n">add_bus_range</span> <span class="p">(</span><span class="n">PFMEM</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">bus_sec</span><span class="p">);</span>
									<span class="o">++</span><span class="n">bus_sec</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span><span class="p">;</span>
								<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
									<span class="n">kfree</span> <span class="p">(</span><span class="n">range</span><span class="p">);</span>
									<span class="n">range</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
								<span class="p">}</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="cm">/* 1st PFMem Range on the bus */</span>
								<span class="n">range</span><span class="o">-&gt;</span><span class="n">rangeno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
								<span class="n">bus_sec</span><span class="o">-&gt;</span><span class="n">rangePFMem</span> <span class="o">=</span> <span class="n">range</span><span class="p">;</span>
								<span class="o">++</span><span class="n">bus_sec</span><span class="o">-&gt;</span><span class="n">noPFMemRanges</span><span class="p">;</span>
							<span class="p">}</span>

							<span class="n">fix_resources</span> <span class="p">(</span><span class="n">bus_sec</span><span class="p">);</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_find_resource</span> <span class="p">(</span><span class="n">bus_cur</span><span class="p">,</span> <span class="n">start_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfmem</span><span class="p">,</span> <span class="n">PFMEM</span><span class="p">))</span> <span class="p">{</span>
								<span class="n">pfmem</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
								<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pfmem</span><span class="p">)</span> <span class="p">{</span>
									<span class="n">kfree</span> <span class="p">(</span><span class="n">range</span><span class="p">);</span>
									<span class="n">err</span> <span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
									<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
								<span class="p">}</span>
								<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PFMEM</span><span class="p">;</span>
								<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">bus_cur</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">;</span>
								<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">devfunc</span> <span class="o">=</span> <span class="p">((</span><span class="n">device</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">function</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">));</span>
								<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_address</span><span class="p">;</span>
								<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">end_address</span> <span class="o">+</span> <span class="mh">0xfffff</span><span class="p">;</span>
								<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
								<span class="n">pfmem</span><span class="o">-&gt;</span><span class="n">fromMem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

								<span class="n">ibmphp_add_resource</span> <span class="p">(</span><span class="n">pfmem</span><span class="p">);</span>
							<span class="p">}</span>
						<span class="p">}</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>	<span class="cm">/* end of switch */</span>
			<span class="p">}</span>	<span class="cm">/* end if vendor */</span>
		<span class="p">}</span>	<span class="cm">/* end for function */</span>
	<span class="p">}</span>	<span class="cm">/* end for device */</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bus_cur</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
