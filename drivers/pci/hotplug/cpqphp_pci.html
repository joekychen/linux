<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pci › hotplug › cpqphp_pci.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cpqphp_pci.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Compaq Hot Plug Controller Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1995,2001 Compaq Computer Corporation</span>
<span class="cm"> * Copyright (C) 2001 Greg Kroah-Hartman (greg@kroah.com)</span>
<span class="cm"> * Copyright (C) 2001 IBM Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> * your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or</span>
<span class="cm"> * NON INFRINGEMENT.  See the GNU General Public License for more</span>
<span class="cm"> * details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Send feedback to &lt;greg@kroah.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pci_hotplug.h&gt;</span>
<span class="cp">#include &quot;../pci.h&quot;</span>
<span class="cp">#include &quot;cpqphp.h&quot;</span>
<span class="cp">#include &quot;cpqphp_nvram.h&quot;</span>


<span class="n">u8</span> <span class="n">cpqhp_nic_irq</span><span class="p">;</span>
<span class="n">u8</span> <span class="n">cpqhp_disk_irq</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">unused_IRQ</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * detect_HRT_floating_pointer</span>
<span class="cm"> *</span>
<span class="cm"> * find the Hot Plug Resource Table in the specified region of memory.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">detect_HRT_floating_pointer</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">begin</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">endp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">temp2</span><span class="p">,</span> <span class="n">temp3</span><span class="p">,</span> <span class="n">temp4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">endp</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hrt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">fp</span> <span class="o">=</span> <span class="n">begin</span><span class="p">;</span> <span class="n">fp</span> <span class="o">&lt;=</span> <span class="n">endp</span><span class="p">;</span> <span class="n">fp</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp1</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">SIG0</span><span class="p">);</span>
		<span class="n">temp2</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">SIG1</span><span class="p">);</span>
		<span class="n">temp3</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">SIG2</span><span class="p">);</span>
		<span class="n">temp4</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">SIG3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp1</span> <span class="o">==</span> <span class="sc">&#39;$&#39;</span> <span class="o">&amp;&amp;</span>
		    <span class="n">temp2</span> <span class="o">==</span> <span class="sc">&#39;H&#39;</span> <span class="o">&amp;&amp;</span>
		    <span class="n">temp3</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span> <span class="o">&amp;&amp;</span>
		    <span class="n">temp4</span> <span class="o">==</span> <span class="sc">&#39;T&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Discovered Hotplug Resource Table at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fp</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">cpqhp_configure_device</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span><span class="o">*</span> <span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_func</span><span class="o">*</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span><span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">));</span>

	<span class="cm">/* No pci device, we need to create it then */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;INFO: pci_dev still null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">num</span> <span class="o">=</span> <span class="n">pci_scan_slot</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span>
			<span class="n">pci_bus_add_devices</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>

		<span class="n">func</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;ERROR: pci_dev still null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="p">);</span>
		<span class="n">child</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span><span class="o">*</span><span class="p">)</span> <span class="n">pci_add_new_bus</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">),</span> <span class="n">bus</span><span class="p">);</span>
		<span class="n">pci_do_scan_bus</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">cpqhp_unconfigure_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span><span class="o">*</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: bus/dev/func = %x/%x/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="mi">8</span> <span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
			<span class="n">pci_stop_and_remove_bus_device</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">PCI_RefinedAccessConfig</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">vendID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vendID</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vendID</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * cpqhp_set_irq</span>
<span class="cm"> *</span>
<span class="cm"> * @bus_num: bus number of PCI device</span>
<span class="cm"> * @dev_num: device number of PCI device</span>
<span class="cm"> * @slot: pointer to u8 where slot number will be returned</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpqhp_set_irq</span> <span class="p">(</span><span class="n">u8</span> <span class="n">bus_num</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dev_num</span><span class="p">,</span> <span class="n">u8</span> <span class="n">int_pin</span><span class="p">,</span> <span class="n">u8</span> <span class="n">irq_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpqhp_legacy_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">fakedev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">fakebus</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">temp_word</span><span class="p">;</span>

		<span class="n">fakedev</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fakedev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">fakebus</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fakebus</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fakedev</span> <span class="o">||</span> <span class="o">!</span><span class="n">fakebus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">fakedev</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">fakebus</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fakedev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">=</span> <span class="n">dev_num</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">fakedev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">fakebus</span><span class="p">;</span>
		<span class="n">fakebus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">bus_num</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: dev %d, bus %d, pin %d, num %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">,</span> <span class="n">bus_num</span><span class="p">,</span> <span class="n">int_pin</span><span class="p">,</span> <span class="n">irq_num</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pcibios_set_irq_routing</span><span class="p">(</span><span class="n">fakedev</span><span class="p">,</span> <span class="n">int_pin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">irq_num</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fakedev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fakebus</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s: rc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">!</span><span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* set the Edge Level Control Register (ELCR) */</span>
		<span class="n">temp_word</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x4d0</span><span class="p">);</span>
		<span class="n">temp_word</span> <span class="o">|=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x4d1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">temp_word</span> <span class="o">|=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">irq_num</span><span class="p">;</span>

		<span class="cm">/* This should only be for x86 as it sets the Edge Level</span>
<span class="cm">		 * Control Register</span>
<span class="cm">		 */</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">temp_word</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span> <span class="mh">0x4d0</span><span class="p">);</span> <span class="n">outb</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">temp_word</span> <span class="o">&amp;</span>
		<span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="mh">0x4d1</span><span class="p">);</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">PCI_ScanBusForNonBridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bus_num</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">dev_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tdevice</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">work</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tbus</span><span class="p">;</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">bus_num</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tdevice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tdevice</span> <span class="o">&lt;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">tdevice</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Scan for access first */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PCI_RefinedAccessConfig</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">tdevice</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Looking for nonbridge bus_num %d dev_num %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus_num</span><span class="p">,</span> <span class="n">tdevice</span><span class="p">);</span>
		<span class="cm">/* Yep we got one. Not a bridge ? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">work</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PCI_TO_PCI_BRIDGE_CLASS</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dev_num</span> <span class="o">=</span> <span class="n">tdevice</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;found it !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tdevice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tdevice</span> <span class="o">&lt;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="n">tdevice</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Scan for access first */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PCI_RefinedAccessConfig</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">tdevice</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Looking for bridge bus_num %d dev_num %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus_num</span><span class="p">,</span> <span class="n">tdevice</span><span class="p">);</span>
		<span class="cm">/* Yep we got one. bridge ? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">work</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_TO_PCI_BRIDGE_CLASS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">tdevice</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tbus</span><span class="p">);</span>
			<span class="cm">/* XXX: no recursion, wtf? */</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Recurse on bus_num %d tdevice %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tbus</span><span class="p">,</span> <span class="n">tdevice</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">PCI_GetBusDevHelper</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bus_num</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dev_num</span><span class="p">,</span> <span class="n">u8</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">nobridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">work</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tbus</span><span class="p">,</span> <span class="n">tdevice</span><span class="p">,</span> <span class="n">tslot</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">cpqhp_routing_table_length</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">loop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tbus</span> <span class="o">=</span> <span class="n">cpqhp_routing_table</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">tdevice</span> <span class="o">=</span> <span class="n">cpqhp_routing_table</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">devfn</span><span class="p">;</span>
		<span class="n">tslot</span> <span class="o">=</span> <span class="n">cpqhp_routing_table</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">slot</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tslot</span> <span class="o">==</span> <span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">bus_num</span> <span class="o">=</span> <span class="n">tbus</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dev_num</span> <span class="o">=</span> <span class="n">tdevice</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">tbus</span><span class="p">;</span>
			<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="o">*</span><span class="n">dev_num</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nobridge</span> <span class="o">||</span> <span class="p">(</span><span class="n">work</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bus_num %d devfn %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">bus_num</span><span class="p">,</span> <span class="o">*</span><span class="n">dev_num</span><span class="p">);</span>
			<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="o">*</span><span class="n">dev_num</span><span class="p">,</span> <span class="n">PCI_CLASS_REVISION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work</span><span class="p">);</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;work &gt;&gt; 8 (%x) = BRIDGE (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">work</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">PCI_TO_PCI_BRIDGE_CLASS</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">work</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_TO_PCI_BRIDGE_CLASS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="o">*</span><span class="n">dev_num</span><span class="p">,</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tbus</span><span class="p">);</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Scan bus for Non Bridge: bus %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tbus</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">PCI_ScanBusForNonBridge</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">tbus</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">bus_num</span> <span class="o">=</span> <span class="n">tbus</span><span class="p">;</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">cpqhp_get_bus_dev</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">bus_num</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">dev_num</span><span class="p">,</span> <span class="n">u8</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* plain (bridges allowed) */</span>
	<span class="k">return</span> <span class="n">PCI_GetBusDevHelper</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">bus_num</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* More PCI configuration routines; this time centered around hotplug</span>
<span class="cm"> * controller</span>
<span class="cm"> */</span>


<span class="cm">/*</span>
<span class="cm"> * cpqhp_save_config</span>
<span class="cm"> *</span>
<span class="cm"> * Reads configuration for all slots in a PCI bus and saves info.</span>
<span class="cm"> *</span>
<span class="cm"> * Note:  For non-hot plug busses, the slot # saved is the device #</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpqhp_save_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">busnumber</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_hot_plug</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">class_code</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">header_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ID</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">secondary_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">new_slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sub_bus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">FirstSupported</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">LastSupported</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_functions</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">function</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">DevError</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cloop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stop_it</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="cm">/* Decide which slots are supported */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_hot_plug</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * is_hot_plug is the slot mask</span>
<span class="cm">		 */</span>
		<span class="n">FirstSupported</span> <span class="o">=</span> <span class="n">is_hot_plug</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">LastSupported</span> <span class="o">=</span> <span class="n">FirstSupported</span> <span class="o">+</span> <span class="p">(</span><span class="n">is_hot_plug</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">FirstSupported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">LastSupported</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Save PCI configuration space for all devices in supported slots */</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">busnumber</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">device</span> <span class="o">=</span> <span class="n">FirstSupported</span><span class="p">;</span> <span class="n">device</span> <span class="o">&lt;=</span> <span class="n">LastSupported</span><span class="p">;</span> <span class="n">device</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ID</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_dword</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ID</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ID</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_hot_plug</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Setup slot structure with entry for empty</span>
<span class="cm">				 * slot</span>
<span class="cm">				 */</span>
				<span class="n">new_slot</span> <span class="o">=</span> <span class="n">cpqhp_slot_create</span><span class="p">(</span><span class="n">busnumber</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">new_slot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">busnumber</span><span class="p">;</span>
				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">device</span><span class="p">;</span>
				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">is_a_board</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">presence_save</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">switch_save</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_byte</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">class_code</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_byte</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* If multi-function device, set max_functions to 8 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">header_type</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">max_functions</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">max_functions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">function</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">DevError</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">header_type</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Recurse the subordinate bus</span>
<span class="cm">				 * get the subordinate bus number</span>
<span class="cm">				 */</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_byte</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">),</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">secondary_bus</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">sub_bus</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">secondary_bus</span><span class="p">;</span>

					<span class="cm">/* Save secondary bus cfg spc</span>
<span class="cm">					 * with this recursive call.</span>
<span class="cm">					 */</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="n">cpqhp_save_config</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">sub_bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
						<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
					<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">busnumber</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">new_slot</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">busnumber</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">new_slot</span> <span class="o">&amp;&amp;</span>
			       <span class="p">(</span><span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">function</span><span class="p">))</span>
				<span class="n">new_slot</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">busnumber</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_slot</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Setup slot structure. */</span>
				<span class="n">new_slot</span> <span class="o">=</span> <span class="n">cpqhp_slot_create</span><span class="p">(</span><span class="n">busnumber</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">new_slot</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">busnumber</span><span class="p">;</span>
			<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">device</span><span class="p">;</span>
			<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">function</span><span class="p">;</span>
			<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">is_a_board</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">switch_save</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="cm">/* In case of unsupported board */</span>
			<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DevError</span><span class="p">;</span>
			<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="p">(</span><span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">cloop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">cloop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_dword</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">),</span> <span class="n">cloop</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">new_slot</span><span class="o">-&gt;</span> <span class="n">config_space</span> <span class="p">[</span><span class="n">cloop</span><span class="p">]));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>

			<span class="n">function</span><span class="o">++</span><span class="p">;</span>

			<span class="n">stop_it</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* this loop skips to the next present function</span>
<span class="cm">			 * reading in Class Code and Header type.</span>
<span class="cm">			 */</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">function</span> <span class="o">&lt;</span> <span class="n">max_functions</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">stop_it</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_dword</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">),</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ID</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ID</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">function</span><span class="o">++</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_byte</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">),</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">class_code</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

				<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_bus_read_config_byte</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">),</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header_type</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

				<span class="n">stop_it</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">function</span> <span class="o">&lt;</span> <span class="n">max_functions</span><span class="p">);</span>
	<span class="p">}</span>			<span class="cm">/* End of FOR loop */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * cpqhp_save_slot_config</span>
<span class="cm"> *</span>
<span class="cm"> * Saves configuration info for all PCI devices in a given slot</span>
<span class="cm"> * including subordinate busses.</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpqhp_save_slot_config</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span> <span class="n">new_slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">class_code</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">header_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ID</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">secondary_bus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sub_bus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_functions</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">function</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cloop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stop_it</span><span class="p">;</span>

	<span class="n">ID</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ID</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">pci_bus_read_config_byte</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">class_code</span><span class="p">);</span>
	<span class="n">pci_bus_read_config_byte</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header_type</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>	<span class="cm">/* Multi-function device */</span>
		<span class="n">max_functions</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max_functions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">function</span> <span class="o">&lt;</span> <span class="n">max_functions</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">header_type</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  Recurse the subordinate bus */</span>
			<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">),</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">secondary_bus</span><span class="p">);</span>

			<span class="n">sub_bus</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">secondary_bus</span><span class="p">;</span>

			<span class="cm">/* Save the config headers for the secondary</span>
<span class="cm">			 * bus.</span>
<span class="cm">			 */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">cpqhp_save_config</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">sub_bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">cloop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">cloop</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pci_bus_read_config_dword</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">),</span> <span class="n">cloop</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">new_slot</span><span class="o">-&gt;</span> <span class="n">config_space</span> <span class="p">[</span><span class="n">cloop</span><span class="p">]));</span>

		<span class="n">function</span><span class="o">++</span><span class="p">;</span>

		<span class="n">stop_it</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* this loop skips to the next present function</span>
<span class="cm">		 * reading in the Class Code and the Header type.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">function</span> <span class="o">&lt;</span> <span class="n">max_functions</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">stop_it</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pci_bus_read_config_dword</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">),</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ID</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ID</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
				<span class="n">function</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">pci_bus_read_config_byte</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">),</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">class_code</span><span class="p">);</span>
				<span class="n">pci_bus_read_config_byte</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">function</span><span class="p">),</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header_type</span><span class="p">);</span>
				<span class="n">stop_it</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * cpqhp_save_base_addr_length</span>
<span class="cm"> *</span>
<span class="cm"> * Saves the length of all base address registers for the</span>
<span class="cm"> * specified slot.  this is for hot plug REPLACE</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpqhp_save_base_addr_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cloop</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">header_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">secondary_bus</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sub_bus</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_register</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>

	<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>

		<span class="cm">/* Check for Bridge */</span>
		<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header_type</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">header_type</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">secondary_bus</span><span class="p">);</span>

			<span class="n">sub_bus</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">secondary_bus</span><span class="p">;</span>

			<span class="n">next</span> <span class="o">=</span> <span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="n">sub_bus</span><span class="p">];</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">cpqhp_save_base_addr_length</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

				<span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

			<span class="cm">/* FIXME: this loop is duplicated in the non-bridge</span>
<span class="cm">			 * case.  The two could be rolled together Figure out</span>
<span class="cm">			 * IO and memory base lengths</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cloop</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">&lt;=</span> <span class="mh">0x14</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">temp_register</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
				<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="n">temp_register</span><span class="p">);</span>
				<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="p">);</span>
				<span class="cm">/* If this register is implemented */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x01L</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* IO base</span>
<span class="cm">						 * set base = amount of IO space</span>
<span class="cm">						 * requested</span>
<span class="cm">						 */</span>
						<span class="n">base</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFE</span><span class="p">;</span>
						<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">base</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

						<span class="n">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* memory base */</span>
						<span class="n">base</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
						<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">base</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

						<span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">base</span> <span class="o">=</span> <span class="mh">0x0L</span><span class="p">;</span>
					<span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* Save information in slot structure */</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">base_length</span><span class="p">[(</span><span class="n">cloop</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">base</span><span class="p">;</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">base_type</span><span class="p">[(</span><span class="n">cloop</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

			<span class="p">}</span>	<span class="cm">/* End of base register loop */</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">header_type</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Figure out IO and memory base lengths */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cloop</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">&lt;=</span> <span class="mh">0x24</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">temp_register</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
				<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="n">temp_register</span><span class="p">);</span>
				<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="p">);</span>

				<span class="cm">/* If this register is implemented */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x01L</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* IO base</span>
<span class="cm">						 * base = amount of IO space</span>
<span class="cm">						 * requested</span>
<span class="cm">						 */</span>
						<span class="n">base</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFE</span><span class="p">;</span>
						<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">base</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

						<span class="n">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* memory base</span>
<span class="cm">						 * base = amount of memory</span>
<span class="cm">						 * space requested</span>
<span class="cm">						 */</span>
						<span class="n">base</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
						<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">base</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

						<span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">base</span> <span class="o">=</span> <span class="mh">0x0L</span><span class="p">;</span>
					<span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* Save information in slot structure */</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">base_length</span><span class="p">[(</span><span class="n">cloop</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">base_type</span><span class="p">[(</span><span class="n">cloop</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

			<span class="p">}</span>	<span class="cm">/* End of base register loop */</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	  <span class="cm">/* Some other unknown header type */</span>
		<span class="p">}</span>

		<span class="cm">/* find the next device in this slot */</span>
		<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * cpqhp_save_used_resources</span>
<span class="cm"> *</span>
<span class="cm"> * Stores used resource information for existing boards.  this is</span>
<span class="cm"> * for boards that were in the system when this driver was loaded.</span>
<span class="cm"> * this function is for hot plug ADD</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpqhp_save_used_resources</span> <span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cloop</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">header_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">secondary_bus</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">temp_byte</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b_base</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b_length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">save_command</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w_base</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">w_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_register</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">mem_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">p_mem_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">io_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">bus_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>

	<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">is_a_board</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>

		<span class="cm">/* Save the command register */</span>
		<span class="n">pci_bus_read_config_word</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save_command</span><span class="p">);</span>

		<span class="cm">/* disable card */</span>
		<span class="n">command</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">pci_bus_write_config_word</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>

		<span class="cm">/* Check for Bridge */</span>
		<span class="n">pci_bus_read_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header_type</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">header_type</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Clear Bridge Control Register */</span>
			<span class="n">command</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">pci_bus_write_config_word</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_BRIDGE_CONTROL</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
			<span class="n">pci_bus_read_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">secondary_bus</span><span class="p">);</span>
			<span class="n">pci_bus_read_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SUBORDINATE_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_byte</span><span class="p">);</span>

			<span class="n">bus_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bus_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus_node</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

			<span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">secondary_bus</span><span class="p">;</span>
			<span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">temp_byte</span> <span class="o">-</span> <span class="n">secondary_bus</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">;</span>
			<span class="n">func</span><span class="o">-&gt;</span><span class="n">bus_head</span> <span class="o">=</span> <span class="n">bus_node</span><span class="p">;</span>

			<span class="cm">/* Save IO base and Limit registers */</span>
			<span class="n">pci_bus_read_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b_base</span><span class="p">);</span>
			<span class="n">pci_bus_read_config_byte</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_IO_LIMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b_length</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">b_base</span> <span class="o">&lt;=</span> <span class="n">b_length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">save_command</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">io_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">io_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_node</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

				<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">b_base</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">b_length</span> <span class="o">-</span> <span class="n">b_base</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

				<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span> <span class="o">=</span> <span class="n">io_node</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Save memory base and Limit registers */</span>
			<span class="n">pci_bus_read_config_word</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_MEMORY_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w_base</span><span class="p">);</span>
			<span class="n">pci_bus_read_config_word</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_MEMORY_LIMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w_length</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">w_base</span> <span class="o">&lt;=</span> <span class="n">w_length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">save_command</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mem_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mem_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_node</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

				<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">w_base</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_length</span> <span class="o">-</span> <span class="n">w_base</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

				<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">=</span> <span class="n">mem_node</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Save prefetchable memory base and Limit registers */</span>
			<span class="n">pci_bus_read_config_word</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w_base</span><span class="p">);</span>
			<span class="n">pci_bus_read_config_word</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PREF_MEMORY_LIMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w_length</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">w_base</span> <span class="o">&lt;=</span> <span class="n">w_length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">save_command</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">p_mem_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p_mem_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_mem_node</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

				<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">w_base</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_length</span> <span class="o">-</span> <span class="n">w_base</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

				<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="n">p_mem_node</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Figure out IO and memory base lengths */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cloop</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">&lt;=</span> <span class="mh">0x14</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save_base</span><span class="p">);</span>

				<span class="n">temp_register</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
				<span class="n">pci_bus_write_config_dword</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="n">temp_register</span><span class="p">);</span>
				<span class="n">pci_bus_read_config_dword</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="p">);</span>

				<span class="n">temp_register</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>

				<span class="cm">/* If this register is implemented */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(((</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x03L</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">save_command</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
						<span class="cm">/* IO base</span>
<span class="cm">						 * set temp_register = amount</span>
<span class="cm">						 * of IO space requested</span>
<span class="cm">						 */</span>
						<span class="n">temp_register</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFE</span><span class="p">;</span>
						<span class="n">temp_register</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">temp_register</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

						<span class="n">io_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">io_node</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_node</span><span class="p">)</span>
							<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

						<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span>
						<span class="n">save_base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x03L</span><span class="p">);</span>
						<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">temp_register</span><span class="p">;</span>

						<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
						<span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span> <span class="o">=</span> <span class="n">io_node</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="k">if</span> <span class="p">(((</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x0BL</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">save_command</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
						<span class="cm">/* prefetchable memory base */</span>
						<span class="n">temp_register</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
						<span class="n">temp_register</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">temp_register</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

						<span class="n">p_mem_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p_mem_node</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_mem_node</span><span class="p">)</span>
							<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

						<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">save_base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x0FL</span><span class="p">);</span>
						<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">temp_register</span><span class="p">;</span>

						<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
						<span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="n">p_mem_node</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="k">if</span> <span class="p">(((</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x0BL</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">save_command</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
						<span class="cm">/* prefetchable memory base */</span>
						<span class="n">temp_register</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
						<span class="n">temp_register</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">temp_register</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

						<span class="n">mem_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mem_node</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_node</span><span class="p">)</span>
							<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

						<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">save_base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x0FL</span><span class="p">);</span>
						<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">temp_register</span><span class="p">;</span>

						<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
						<span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">=</span> <span class="n">mem_node</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>	<span class="cm">/* End of base register loop */</span>
		<span class="cm">/* Standard header */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">header_type</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Figure out IO and memory base lengths */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cloop</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">&lt;=</span> <span class="mh">0x24</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_bus_read_config_dword</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save_base</span><span class="p">);</span>

				<span class="n">temp_register</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
				<span class="n">pci_bus_write_config_dword</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="n">temp_register</span><span class="p">);</span>
				<span class="n">pci_bus_read_config_dword</span><span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="p">);</span>

				<span class="n">temp_register</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>

				<span class="cm">/* If this register is implemented */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(((</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x03L</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">save_command</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
						<span class="cm">/* IO base</span>
<span class="cm">						 * set temp_register = amount</span>
<span class="cm">						 * of IO space requested</span>
<span class="cm">						 */</span>
						<span class="n">temp_register</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFE</span><span class="p">;</span>
						<span class="n">temp_register</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">temp_register</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

						<span class="n">io_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">io_node</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_node</span><span class="p">)</span>
							<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

						<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">save_base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x01L</span><span class="p">);</span>
						<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">temp_register</span><span class="p">;</span>

						<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
						<span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span> <span class="o">=</span> <span class="n">io_node</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="k">if</span> <span class="p">(((</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x0BL</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">save_command</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
						<span class="cm">/* prefetchable memory base */</span>
						<span class="n">temp_register</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
						<span class="n">temp_register</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">temp_register</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

						<span class="n">p_mem_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p_mem_node</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_mem_node</span><span class="p">)</span>
							<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

						<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">save_base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x0FL</span><span class="p">);</span>
						<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">temp_register</span><span class="p">;</span>

						<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
						<span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="n">p_mem_node</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="k">if</span> <span class="p">(((</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x0BL</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">save_command</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
						<span class="cm">/* prefetchable memory base */</span>
						<span class="n">temp_register</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
						<span class="n">temp_register</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">temp_register</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

						<span class="n">mem_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mem_node</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_node</span><span class="p">)</span>
							<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

						<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">save_base</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x0FL</span><span class="p">);</span>
						<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">temp_register</span><span class="p">;</span>

						<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
						<span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">=</span> <span class="n">mem_node</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>	<span class="cm">/* End of base register loop */</span>
		<span class="p">}</span>

		<span class="cm">/* find the next device in this slot */</span>
		<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * cpqhp_configure_board</span>
<span class="cm"> *</span>
<span class="cm"> * Copies saved configuration information to one slot.</span>
<span class="cm"> * this is called recursively for bridge devices.</span>
<span class="cm"> * this is for hot plug REPLACE!</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpqhp_configure_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cloop</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">header_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">secondary_bus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sub_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>

	<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>

		<span class="cm">/* Start at the top of config space so that the control</span>
<span class="cm">		 * registers are programmed last</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cloop</span> <span class="o">=</span> <span class="mh">0x3C</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">config_space</span><span class="p">[</span><span class="n">cloop</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]);</span>

		<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header_type</span><span class="p">);</span>

		<span class="cm">/* If this is a bridge device, restore subordinate devices */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">header_type</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">secondary_bus</span><span class="p">);</span>

			<span class="n">sub_bus</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">secondary_bus</span><span class="p">;</span>

			<span class="n">next</span> <span class="o">=</span> <span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="n">sub_bus</span><span class="p">];</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">cpqhp_configure_board</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

				<span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="cm">/* Check all the base Address Registers to make sure</span>
<span class="cm">			 * they are the same.  If not, the board is different.</span>
<span class="cm">			 */</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">cloop</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">config_space</span><span class="p">[</span><span class="n">cloop</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Config space compare failure!!! offset = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cloop</span><span class="p">);</span>
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;bus = %x, device = %x, function = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
					<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;temp = %x, config space = %x</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">config_space</span><span class="p">[</span><span class="n">cloop</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]);</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">func</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * cpqhp_valid_replace</span>
<span class="cm"> *</span>
<span class="cm"> * this function checks to see if a board is the same as the</span>
<span class="cm"> * one it is replacing.  this check will detect if the device&#39;s</span>
<span class="cm"> * vendor or device id&#39;s are the same</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if the board is the same nonzero otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpqhp_valid_replace</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cloop</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">header_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">secondary_bus</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_register</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">pci_bus</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">is_a_board</span><span class="p">)</span>
		<span class="k">return</span><span class="p">(</span><span class="n">ADD_NOT_SUPPORTED</span><span class="p">);</span>

	<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">devfn</span> <span class="o">=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>

		<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_register</span><span class="p">);</span>

		<span class="cm">/* No adapter present */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp_register</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
			<span class="k">return</span><span class="p">(</span><span class="n">NO_ADAPTER_PRESENT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">temp_register</span> <span class="o">!=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">config_space</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">return</span><span class="p">(</span><span class="n">ADAPTER_NOT_SAME</span><span class="p">);</span>

		<span class="cm">/* Check for same revision number and class code */</span>
		<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_CLASS_REVISION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_register</span><span class="p">);</span>

		<span class="cm">/* Adapter not the same */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp_register</span> <span class="o">!=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">config_space</span><span class="p">[</span><span class="mh">0x08</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">])</span>
			<span class="k">return</span><span class="p">(</span><span class="n">ADAPTER_NOT_SAME</span><span class="p">);</span>

		<span class="cm">/* Check for Bridge */</span>
		<span class="n">pci_bus_read_config_byte</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header_type</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">header_type</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* In order to continue checking, we must program the</span>
<span class="cm">			 * bus registers in the bridge to respond to accesses</span>
<span class="cm">			 * for its subordinate bus(es)</span>
<span class="cm">			 */</span>

			<span class="n">temp_register</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">config_space</span><span class="p">[</span><span class="mh">0x18</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">];</span>
			<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_PRIMARY_BUS</span><span class="p">,</span> <span class="n">temp_register</span><span class="p">);</span>

			<span class="n">secondary_bus</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_register</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

			<span class="n">next</span> <span class="o">=</span> <span class="n">cpqhp_slot_list</span><span class="p">[</span><span class="n">secondary_bus</span><span class="p">];</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">cpqhp_valid_replace</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

				<span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
		<span class="cm">/* Check to see if it is a standard config header */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">header_type</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_NORMAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check subsystem vendor and ID */</span>
			<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_SUBSYSTEM_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_register</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">temp_register</span> <span class="o">!=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">config_space</span><span class="p">[</span><span class="mh">0x2C</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
				<span class="cm">/* If it&#39;s a SMART-2 and the register isn&#39;t</span>
<span class="cm">				 * filled in, ignore the difference because</span>
<span class="cm">				 * they just have an old rev of the firmware</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">config_space</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xAE100E11</span><span class="p">)</span>
				      <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp_register</span> <span class="o">==</span> <span class="mh">0x00L</span><span class="p">)))</span>
					<span class="k">return</span><span class="p">(</span><span class="n">ADAPTER_NOT_SAME</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* Figure out IO and memory base lengths */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cloop</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">&lt;=</span> <span class="mh">0x24</span><span class="p">;</span> <span class="n">cloop</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">temp_register</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
				<span class="n">pci_bus_write_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="n">temp_register</span><span class="p">);</span>
				<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">cloop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="p">);</span>

				<span class="cm">/* If this register is implemented */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x01L</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* IO base</span>
<span class="cm">						 * set base = amount of IO</span>
<span class="cm">						 * space requested</span>
<span class="cm">						 */</span>
						<span class="n">base</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFE</span><span class="p">;</span>
						<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">base</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

						<span class="n">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* memory base */</span>
						<span class="n">base</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
						<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">base</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

						<span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">base</span> <span class="o">=</span> <span class="mh">0x0L</span><span class="p">;</span>
					<span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* Check information in slot structure */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">base_length</span><span class="p">[(</span><span class="n">cloop</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">base</span><span class="p">)</span>
					<span class="k">return</span><span class="p">(</span><span class="n">ADAPTER_NOT_SAME</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">base_type</span><span class="p">[(</span><span class="n">cloop</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
					<span class="k">return</span><span class="p">(</span><span class="n">ADAPTER_NOT_SAME</span><span class="p">);</span>

			<span class="p">}</span>	<span class="cm">/* End of base register loop */</span>

		<span class="p">}</span>		<span class="cm">/* End of (type 0 config space) else */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* this is not a type 0 or 1 config space header so</span>
<span class="cm">			 * we don&#39;t know how to do it</span>
<span class="cm">			 */</span>
			<span class="k">return</span><span class="p">(</span><span class="n">DEVICE_TYPE_NOT_SUPPORTED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Get the next function */</span>
		<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * cpqhp_find_available_resources</span>
<span class="cm"> *</span>
<span class="cm"> * Finds available memory, IO, and IRQ resources for programming</span>
<span class="cm"> * devices which may be added to the system</span>
<span class="cm"> * this function is for hot plug ADD!</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpqhp_find_available_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">controller</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rom_start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">populated_slot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bridged_slot</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">one_slot</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rom_resource_table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_dword</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">mem_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">p_mem_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">io_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">bus_node</span><span class="p">;</span>

	<span class="n">rom_resource_table</span> <span class="o">=</span> <span class="n">detect_HRT_floating_pointer</span><span class="p">(</span><span class="n">rom_start</span><span class="p">,</span> <span class="n">rom_start</span><span class="o">+</span><span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;rom_resource_table = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rom_resource_table</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rom_resource_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Sum all resources and setup resource maps */</span>
	<span class="n">unused_IRQ</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">rom_resource_table</span> <span class="o">+</span> <span class="n">UNUSED_IRQ</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;unused_IRQ = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unused_IRQ</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">unused_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unused_IRQ</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpqhp_disk_irq</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">unused_IRQ</span> <span class="o">=</span> <span class="n">unused_IRQ</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">temp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;cpqhp_disk_irq= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpqhp_disk_irq</span><span class="p">);</span>
	<span class="n">unused_IRQ</span> <span class="o">=</span> <span class="n">unused_IRQ</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">temp</span><span class="o">++</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">unused_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unused_IRQ</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpqhp_nic_irq</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">unused_IRQ</span> <span class="o">=</span> <span class="n">unused_IRQ</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">temp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;cpqhp_nic_irq= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpqhp_nic_irq</span><span class="p">);</span>
	<span class="n">unused_IRQ</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">rom_resource_table</span> <span class="o">+</span> <span class="n">PCIIRQ</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpqhp_nic_irq</span><span class="p">)</span>
		<span class="n">cpqhp_nic_irq</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cfgspc_irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpqhp_disk_irq</span><span class="p">)</span>
		<span class="n">cpqhp_disk_irq</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cfgspc_irq</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;cpqhp_disk_irq, cpqhp_nic_irq= %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpqhp_disk_irq</span><span class="p">,</span> <span class="n">cpqhp_nic_irq</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">compaq_nvram_load</span><span class="p">(</span><span class="n">rom_start</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">one_slot</span> <span class="o">=</span> <span class="n">rom_resource_table</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hrt</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">rom_resource_table</span> <span class="o">+</span> <span class="n">NUMBER_OF_ENTRIES</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;number_of_entries = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">readb</span><span class="p">(</span><span class="n">one_slot</span> <span class="o">+</span> <span class="n">SECONDARY_BUS</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;dev|IO base|length|Mem base|length|Pre base|length|PB SB MB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">readb</span><span class="p">(</span><span class="n">one_slot</span> <span class="o">+</span> <span class="n">SECONDARY_BUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">dev_func</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">one_slot</span> <span class="o">+</span> <span class="n">DEV_FUNC</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">primary_bus</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">one_slot</span> <span class="o">+</span> <span class="n">PRIMARY_BUS</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">secondary_bus</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">one_slot</span> <span class="o">+</span> <span class="n">SECONDARY_BUS</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">max_bus</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">one_slot</span> <span class="o">+</span> <span class="n">MAX_BUS</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">io_base</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">one_slot</span> <span class="o">+</span> <span class="n">IO_BASE</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">io_length</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">one_slot</span> <span class="o">+</span> <span class="n">IO_LENGTH</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">mem_base</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">one_slot</span> <span class="o">+</span> <span class="n">MEM_BASE</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">mem_length</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">one_slot</span> <span class="o">+</span> <span class="n">MEM_LENGTH</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">pre_mem_base</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">one_slot</span> <span class="o">+</span> <span class="n">PRE_MEM_BASE</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">pre_mem_length</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">one_slot</span> <span class="o">+</span> <span class="n">PRE_MEM_LENGTH</span><span class="p">);</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%2.2x | %4.4x  | %4.4x | %4.4x   | %4.4x | %4.4x   | %4.4x |%2.2x %2.2x %2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">dev_func</span><span class="p">,</span> <span class="n">io_base</span><span class="p">,</span> <span class="n">io_length</span><span class="p">,</span> <span class="n">mem_base</span><span class="p">,</span> <span class="n">mem_length</span><span class="p">,</span> <span class="n">pre_mem_base</span><span class="p">,</span> <span class="n">pre_mem_length</span><span class="p">,</span>
		    <span class="n">primary_bus</span><span class="p">,</span> <span class="n">secondary_bus</span><span class="p">,</span> <span class="n">max_bus</span><span class="p">);</span>

		<span class="cm">/* If this entry isn&#39;t for our controller&#39;s bus, ignore it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">primary_bus</span> <span class="o">!=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">--</span><span class="p">;</span>
			<span class="n">one_slot</span> <span class="o">+=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slot_rt</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* find out if this entry is for an occupied slot */</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">primary_bus</span><span class="p">;</span>
		<span class="n">pci_bus_read_config_dword</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">pci_bus</span><span class="p">,</span> <span class="n">dev_func</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_dword</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;temp_D_word = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp_dword</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">temp_dword</span> <span class="o">!=</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">primary_bus</span><span class="p">,</span> <span class="n">dev_func</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">func</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">!=</span> <span class="p">(</span><span class="n">dev_func</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;func = %p (bus, dev, fun) = (%d, %d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">primary_bus</span><span class="p">,</span> <span class="n">dev_func</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
				<span class="n">func</span> <span class="o">=</span> <span class="n">cpqhp_slot_find</span><span class="p">(</span><span class="n">primary_bus</span><span class="p">,</span> <span class="n">dev_func</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* If we can&#39;t find a match, skip this table entry */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span>
				<span class="n">one_slot</span> <span class="o">+=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slot_rt</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* this may not work and shouldn&#39;t be used */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">secondary_bus</span> <span class="o">!=</span> <span class="n">primary_bus</span><span class="p">)</span>
				<span class="n">bridged_slot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">bridged_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">populated_slot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">populated_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bridged_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="cm">/* If we&#39;ve got a valid IO base, use it */</span>

		<span class="n">temp_dword</span> <span class="o">=</span> <span class="n">io_base</span> <span class="o">+</span> <span class="n">io_length</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">io_base</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp_dword</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">io_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">io_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_node</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

			<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">io_base</span><span class="p">;</span>
			<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">io_length</span><span class="p">;</span>

			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;found io_node(base, length) = %x, %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">io_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;populated slot =%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">populated_slot</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">populated_slot</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">io_head</span> <span class="o">=</span> <span class="n">io_node</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">io_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span> <span class="o">=</span> <span class="n">io_node</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* If we&#39;ve got a valid memory base, use it */</span>
		<span class="n">temp_dword</span> <span class="o">=</span> <span class="n">mem_base</span> <span class="o">+</span> <span class="n">mem_length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mem_base</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp_dword</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mem_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mem_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_node</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

			<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">mem_base</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

			<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">mem_length</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;found mem_node(base, length) = %x, %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;populated slot =%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">populated_slot</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">populated_slot</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">=</span> <span class="n">mem_node</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">=</span> <span class="n">mem_node</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* If we&#39;ve got a valid prefetchable memory base, and</span>
<span class="cm">		 * the base + length isn&#39;t greater than 0xFFFF</span>
<span class="cm">		 */</span>
		<span class="n">temp_dword</span> <span class="o">=</span> <span class="n">pre_mem_base</span> <span class="o">+</span> <span class="n">pre_mem_length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pre_mem_base</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp_dword</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">p_mem_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p_mem_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_mem_node</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

			<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">pre_mem_base</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

			<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">pre_mem_length</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;found p_mem_node(base, length) = %x, %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;populated slot =%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">populated_slot</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">populated_slot</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="n">p_mem_node</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">p_mem_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="n">p_mem_node</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* If we&#39;ve got a valid bus number, use it</span>
<span class="cm">		 * The second condition is to ignore bus numbers on</span>
<span class="cm">		 * populated slots that don&#39;t have PCI-PCI bridges</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">secondary_bus</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">secondary_bus</span> <span class="o">!=</span> <span class="n">primary_bus</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bus_node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bus_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus_node</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

			<span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">secondary_bus</span><span class="p">;</span>
			<span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">max_bus</span> <span class="o">-</span> <span class="n">secondary_bus</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;found bus_node(base, length) = %x, %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;populated slot =%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">populated_slot</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">populated_slot</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">;</span>
				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus_head</span> <span class="o">=</span> <span class="n">bus_node</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bus_node</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">;</span>
				<span class="n">func</span><span class="o">-&gt;</span><span class="n">bus_head</span> <span class="o">=</span> <span class="n">bus_node</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="n">one_slot</span> <span class="o">+=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slot_rt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If all of the following fail, we don&#39;t have any resources for</span>
<span class="cm">	 * hot plug add</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">&amp;=</span> <span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">&amp;=</span> <span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">&amp;=</span> <span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">&amp;=</span> <span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * cpqhp_return_board_resources</span>
<span class="cm"> *</span>
<span class="cm"> * this routine returns all resources allocated to a board to</span>
<span class="cm"> * the available pool.</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if success</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cpqhp_return_board_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span> <span class="n">func</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource_lists</span> <span class="o">*</span> <span class="n">resources</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">t_node</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
	<span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">),</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">t_node</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
	<span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">),</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">t_node</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
	<span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">),</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">t_node</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">;</span>
	<span class="n">func</span><span class="o">-&gt;</span><span class="n">bus_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">return_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">),</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">t_node</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">|=</span> <span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">|=</span> <span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">|=</span> <span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">|=</span> <span class="n">cpqhp_resource_sort_and_combine</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * cpqhp_destroy_resource_list</span>
<span class="cm"> *</span>
<span class="cm"> * Puts node back in the resource list pointed to by head</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cpqhp_destroy_resource_list</span> <span class="p">(</span><span class="k">struct</span> <span class="n">resource_lists</span> <span class="o">*</span> <span class="n">resources</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="o">*</span><span class="n">tres</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
	<span class="n">resources</span><span class="o">-&gt;</span><span class="n">io_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
	<span class="n">resources</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
	<span class="n">resources</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">;</span>
	<span class="n">resources</span><span class="o">-&gt;</span><span class="n">bus_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * cpqhp_destroy_board_resources</span>
<span class="cm"> *</span>
<span class="cm"> * Puts node back in the resource list pointed to by head</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cpqhp_destroy_board_resources</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="o">*</span><span class="n">tres</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span><span class="p">;</span>
	<span class="n">func</span><span class="o">-&gt;</span><span class="n">io_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span><span class="p">;</span>
	<span class="n">func</span><span class="o">-&gt;</span><span class="n">mem_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span><span class="p">;</span>
	<span class="n">func</span><span class="o">-&gt;</span><span class="n">p_mem_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">bus_head</span><span class="p">;</span>
	<span class="n">func</span><span class="o">-&gt;</span><span class="n">bus_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tres</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
