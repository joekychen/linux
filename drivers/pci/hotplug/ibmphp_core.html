<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pci › hotplug › ibmphp_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ibmphp_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * IBM Hot Plug Controller Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Written By: Chuck Cole, Jyoti Shah, Tong Yu, Irene Zubarev, IBM Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2001,2003 Greg Kroah-Hartman (greg@kroah.com)</span>
<span class="cm"> * Copyright (C) 2001-2003 IBM Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> * your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or</span>
<span class="cm"> * NON INFRINGEMENT.  See the GNU General Public License for more</span>
<span class="cm"> * details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Send feedback to &lt;gregkh@us.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &quot;../pci.h&quot;</span>
<span class="cp">#include &lt;asm/pci_x86.h&gt;		</span><span class="cm">/* for struct irq_routing_table */</span><span class="cp"></span>
<span class="cp">#include &quot;ibmphp.h&quot;</span>

<span class="cp">#define attn_on(sl)  ibmphp_hpc_writeslot (sl, HPC_SLOT_ATTNON)</span>
<span class="cp">#define attn_off(sl) ibmphp_hpc_writeslot (sl, HPC_SLOT_ATTNOFF)</span>
<span class="cp">#define attn_LED_blink(sl) ibmphp_hpc_writeslot (sl, HPC_SLOT_BLINKLED)</span>
<span class="cp">#define get_ctrl_revision(sl, rev) ibmphp_hpc_readslot (sl, READ_REVLEVEL, rev)</span>
<span class="cp">#define get_hpc_options(sl, opt) ibmphp_hpc_readslot (sl, READ_HPCOPTIONS, opt)</span>

<span class="cp">#define DRIVER_VERSION	&quot;0.6&quot;</span>
<span class="cp">#define DRIVER_DESC	&quot;IBM Hot Plug PCI Controller Driver&quot;</span>

<span class="kt">int</span> <span class="n">ibmphp_debug</span><span class="p">;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span> <span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debugging mode enabled or not&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span> <span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span> <span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">ibmphp_pci_bus</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_slots</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">irqs</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>    <span class="cm">/* PIC mode IRQ&#39;s we&#39;re using so far (in case MPS</span>
<span class="cm">			 * tables don&#39;t provide default info for empty slots */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">init_flag</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">static int get_max_adapter_speed_1 (struct hotplug_slot *, u8 *, u8);</span>

<span class="cm">static inline int get_max_adapter_speed (struct hotplug_slot *hs, u8 *value)</span>
<span class="cm">{</span>
<span class="cm">	return get_max_adapter_speed_1 (hs, value, 1);</span>
<span class="cm">}</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_cur_bus_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">**</span><span class="n">sl</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span> <span class="n">slot_cur</span> <span class="o">=</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;options = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">);</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;revision = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>	

	<span class="k">if</span> <span class="p">(</span><span class="n">READ_BUS_STATUS</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">))</span> 
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_hpc_readslot</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">,</span> <span class="n">READ_BUSSTATUS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> 
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	  
	<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">current_speed</span> <span class="o">=</span> <span class="n">CURRENT_BUS_SPEED</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">busstatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">READ_BUS_MODE</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">))</span>
		<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">current_bus_mode</span> <span class="o">=</span>
				<span class="n">CURRENT_BUS_MODE</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">busstatus</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">current_bus_mode</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;busstatus = %x, bus_speed = %x, bus_mode = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">busstatus</span><span class="p">,</span>
			<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">current_speed</span><span class="p">,</span>
			<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">current_bus_mode</span><span class="p">);</span>
	
	<span class="o">*</span><span class="n">sl</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">slot_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">**</span><span class="n">sl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
 	<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_hpc_readslot</span><span class="p">(</span><span class="o">*</span><span class="n">sl</span><span class="p">,</span> <span class="n">READ_ALLSTAT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> 
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init_flag</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">get_cur_bus_info</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">get_max_slots</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span> <span class="n">slot_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">slot_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ibmphp_slot_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot_cur</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slot</span><span class="p">,</span> <span class="n">ibm_slot_list</span><span class="p">);</span>
		<span class="cm">/* sometimes the hot-pluggable slots start with 4 (not always from 1) */</span>
		<span class="n">slot_count</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">slot_count</span><span class="p">,</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">slot_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This routine will put the correct slot-&gt;device information per slot.  It&#39;s</span>
<span class="cm"> * called from initialization of the slot structures. It will also assign</span>
<span class="cm"> * interrupt numbers per each slot.</span>
<span class="cm"> * Parameters: struct slot</span>
<span class="cm"> * Returns 0 or errors</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ibmphp_init_devno</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">**</span><span class="n">cur_slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irq_routing_table</span> <span class="o">*</span><span class="n">rtable</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rtable</span> <span class="o">=</span> <span class="n">pcibios_get_irq_routing_table</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;no BIOS routing table...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">rtable</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_routing_table</span><span class="p">))</span> <span class="o">/</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rtable</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">cur_slot</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">rtable</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">slot</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">*</span><span class="n">cur_slot</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">rtable</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">io_apic_irq_attr</span> <span class="n">irq_attr</span><span class="p">;</span>

			<span class="p">(</span><span class="o">*</span><span class="n">cur_slot</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">rtable</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">devfn</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">cur_slot</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IO_APIC_get_PCI_irq_vector</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">cur_slot</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">cur_slot</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">irq_attr</span><span class="p">);</span>

			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;(*cur_slot)-&gt;irq[0] = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="o">*</span><span class="n">cur_slot</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;(*cur_slot)-&gt;irq[1] = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="o">*</span><span class="n">cur_slot</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;(*cur_slot)-&gt;irq[2] = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="o">*</span><span class="n">cur_slot</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;(*cur_slot)-&gt;irq[3] = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="o">*</span><span class="n">cur_slot</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;rtable-&gt;exlusive_irqs = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rtable</span><span class="o">-&gt;</span><span class="n">exclusive_irqs</span><span class="p">);</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;rtable-&gt;slots[loop].irq[0].bitmap = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rtable</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bitmap</span><span class="p">);</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;rtable-&gt;slots[loop].irq[1].bitmap = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rtable</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">irq</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bitmap</span><span class="p">);</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;rtable-&gt;slots[loop].irq[2].bitmap = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rtable</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">irq</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">bitmap</span><span class="p">);</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;rtable-&gt;slots[loop].irq[3].bitmap = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rtable</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">irq</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">bitmap</span><span class="p">);</span>

			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;rtable-&gt;slots[loop].irq[0].link = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rtable</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">link</span><span class="p">);</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;rtable-&gt;slots[loop].irq[1].link = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rtable</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">irq</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">link</span><span class="p">);</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;rtable-&gt;slots[loop].irq[2].link = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rtable</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">irq</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">link</span><span class="p">);</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;rtable-&gt;slots[loop].irq[3].link = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rtable</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">loop</span><span class="p">].</span><span class="n">irq</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">link</span><span class="p">);</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;end of init_devno</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">rtable</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rtable</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot_cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_SLOT_ON</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ibmphp_hpc_writeslot</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;power on failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CTLR_RESULT</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;command not completed successfully in power_on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>	<span class="cm">/* For ServeRAID cards, and some 66 PCI */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">power_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot_cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_SLOT_OFF</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ibmphp_hpc_writeslot</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;power off failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CTLR_RESULT</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;command not completed successfully in power_off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_attention_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>     <span class="cm">/* avoid compiler warning */</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;set_attention_status - Entry hotplug_slot[%lx] value[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">hotplug_slot</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">ibmphp_lock_operations</span><span class="p">();</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">hotplug_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HPC_SLOT_ATTN_OFF</span>:
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_SLOT_ATTNOFF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HPC_SLOT_ATTN_ON</span>:
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_SLOT_ATTNON</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HPC_SLOT_ATTN_BLINK</span>:
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_SLOT_BLINKLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;set_attention_status - Error : invalid input [%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">value</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pslot</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="p">)</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_hpc_writeslot</span><span class="p">(</span><span class="n">pslot</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>	
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ibmphp_unlock_operations</span><span class="p">();</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;set_attention_status - Exit rc[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_attention_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="n">myslot</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_attention_status - Entry hotplug_slot[%lx] pvalue[%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">hotplug_slot</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
        
	<span class="n">ibmphp_lock_operations</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hotplug_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pslot</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myslot</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span><span class="p">));</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_hpc_readslot</span><span class="p">(</span><span class="n">pslot</span><span class="p">,</span> <span class="n">READ_SLOTSTATUS</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="p">(</span><span class="n">myslot</span><span class="p">.</span><span class="n">status</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_hpc_readslot</span><span class="p">(</span><span class="n">pslot</span><span class="p">,</span>
						<span class="n">READ_EXTSLOTSTATUS</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="p">(</span><span class="n">myslot</span><span class="p">.</span><span class="n">ext_status</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
				<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">SLOT_ATTN</span><span class="p">(</span><span class="n">myslot</span><span class="p">.</span><span class="n">status</span><span class="p">,</span>
						<span class="n">myslot</span><span class="p">.</span><span class="n">ext_status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ibmphp_unlock_operations</span><span class="p">();</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_attention_status - Exit rc[%d] value[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_latch_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="n">myslot</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_latch_status - Entry hotplug_slot[%lx] pvalue[%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">hotplug_slot</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">ibmphp_lock_operations</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hotplug_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pslot</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myslot</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span><span class="p">));</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_hpc_readslot</span><span class="p">(</span><span class="n">pslot</span><span class="p">,</span> <span class="n">READ_SLOTSTATUS</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="p">(</span><span class="n">myslot</span><span class="p">.</span><span class="n">status</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
				<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">SLOT_LATCH</span><span class="p">(</span><span class="n">myslot</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ibmphp_unlock_operations</span><span class="p">();</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_latch_status - Exit rc[%d] rc[%x] value[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rc</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_power_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="n">myslot</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_power_status - Entry hotplug_slot[%lx] pvalue[%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">hotplug_slot</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">ibmphp_lock_operations</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hotplug_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pslot</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myslot</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span><span class="p">));</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_hpc_readslot</span><span class="p">(</span><span class="n">pslot</span><span class="p">,</span> <span class="n">READ_SLOTSTATUS</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="p">(</span><span class="n">myslot</span><span class="p">.</span><span class="n">status</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
				<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">SLOT_PWRGD</span><span class="p">(</span><span class="n">myslot</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ibmphp_unlock_operations</span><span class="p">();</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_power_status - Exit rc[%d] rc[%x] value[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rc</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_adapter_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">pslot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">present</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="n">myslot</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_adapter_status - Entry hotplug_slot[%lx] pvalue[%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">hotplug_slot</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">ibmphp_lock_operations</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hotplug_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pslot</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pslot</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myslot</span><span class="p">,</span> <span class="n">pslot</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span><span class="p">));</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_hpc_readslot</span><span class="p">(</span><span class="n">pslot</span><span class="p">,</span> <span class="n">READ_SLOTSTATUS</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="p">(</span><span class="n">myslot</span><span class="p">.</span><span class="n">status</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">present</span> <span class="o">=</span> <span class="n">SLOT_PRESENT</span><span class="p">(</span><span class="n">myslot</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">present</span> <span class="o">==</span> <span class="n">HPC_SLOT_EMPTY</span><span class="p">)</span>
					<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ibmphp_unlock_operations</span><span class="p">();</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_adapter_present - Exit rc[%d] value[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_max_bus_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">pci_bus_speed</span> <span class="n">speed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">pci_slot</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;%s - Entry slot[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="n">ibmphp_lock_operations</span><span class="p">();</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">supported_bus_mode</span><span class="p">;</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">supported_speed</span><span class="p">;</span> 
	<span class="n">ibmphp_unlock_operations</span><span class="p">();</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BUS_SPEED_33</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BUS_SPEED_66</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BUS_MODE_PCIX</span><span class="p">)</span> 
			<span class="n">speed</span> <span class="o">+=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BUS_SPEED_100</span>:
	<span class="k">case</span> <span class="n">BUS_SPEED_133</span>:
		<span class="n">speed</span> <span class="o">+=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Note (will need to change): there would be soon 256, 512 also */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">max_bus_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;%s - Exit rc[%d] speed[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">static int get_max_adapter_speed_1(struct hotplug_slot *hotplug_slot, u8 * value, u8 flag)</span>
<span class="cm">{</span>
<span class="cm">	int rc = -ENODEV;</span>
<span class="cm">	struct slot *pslot;</span>
<span class="cm">	struct slot myslot;</span>

<span class="cm">	debug(&quot;get_max_adapter_speed_1 - Entry hotplug_slot[%lx] pvalue[%lx]\n&quot;,</span>
<span class="cm">						(ulong)hotplug_slot, (ulong) value);</span>

<span class="cm">	if (flag)</span>
<span class="cm">		ibmphp_lock_operations();</span>

<span class="cm">	if (hotplug_slot &amp;&amp; value) {</span>
<span class="cm">		pslot = hotplug_slot-&gt;private;</span>
<span class="cm">		if (pslot) {</span>
<span class="cm">			memcpy(&amp;myslot, pslot, sizeof(struct slot));</span>
<span class="cm">			rc = ibmphp_hpc_readslot(pslot, READ_SLOTSTATUS,</span>
<span class="cm">						&amp;(myslot.status));</span>

<span class="cm">			if (!(SLOT_LATCH (myslot.status)) &amp;&amp;</span>
<span class="cm">					(SLOT_PRESENT (myslot.status))) {</span>
<span class="cm">				rc = ibmphp_hpc_readslot(pslot,</span>
<span class="cm">						READ_EXTSLOTSTATUS,</span>
<span class="cm">						&amp;(myslot.ext_status));</span>
<span class="cm">				if (!rc)</span>
<span class="cm">					*value = SLOT_SPEED(myslot.ext_status);</span>
<span class="cm">			} else</span>
<span class="cm">				*value = MAX_ADAPTER_NONE;</span>
<span class="cm">                }</span>
<span class="cm">	}</span>

<span class="cm">	if (flag)</span>
<span class="cm">		ibmphp_unlock_operations();</span>

<span class="cm">	debug(&quot;get_max_adapter_speed_1 - Exit rc[%d] value[%x]\n&quot;, rc, *value);</span>
<span class="cm">	return rc;</span>
<span class="cm">}</span>

<span class="cm">static int get_bus_name(struct hotplug_slot *hotplug_slot, char * value)</span>
<span class="cm">{</span>
<span class="cm">	int rc = -ENODEV;</span>
<span class="cm">	struct slot *pslot = NULL;</span>

<span class="cm">	debug(&quot;get_bus_name - Entry hotplug_slot[%lx]\n&quot;, (ulong)hotplug_slot);</span>

<span class="cm">	ibmphp_lock_operations();</span>

<span class="cm">	if (hotplug_slot) {</span>
<span class="cm">		pslot = hotplug_slot-&gt;private;</span>
<span class="cm">		if (pslot) {</span>
<span class="cm">			rc = 0;</span>
<span class="cm">			snprintf(value, 100, &quot;Bus %x&quot;, pslot-&gt;bus);</span>
<span class="cm">		}</span>
<span class="cm">	} else</span>
<span class="cm">		rc = -ENODEV;</span>

<span class="cm">	ibmphp_unlock_operations();</span>
<span class="cm">	debug(&quot;get_bus_name - Exit rc[%d] value[%x]\n&quot;, rc, *value);</span>
<span class="cm">	return rc;</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * This routine will initialize the ops data structure used in the validate</span>
<span class="cm"> * function. It will also power off empty slots that are powered on since BIOS</span>
<span class="cm"> * leaves those on, albeit disconnected</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_ops</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ibmphp_slot_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot_cur</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slot</span><span class="p">,</span> <span class="n">ibm_slot_list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot_cur</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;BEFORE GETTING SLOT STATUS, slot # %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> 
			<span class="k">if</span> <span class="p">(</span><span class="n">get_ctrl_revision</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">current_speed</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> 
			<span class="k">if</span> <span class="p">(</span><span class="n">get_cur_bus_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot_cur</span><span class="p">))</span> 
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">get_max_bus_speed</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_hpc_options</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">slot_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot_cur</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;status = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;ext_status = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ext_status</span><span class="p">);</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;SLOT_POWER = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SLOT_POWER</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;SLOT_PRESENT = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SLOT_PRESENT</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;SLOT_LATCH = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SLOT_LATCH</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">SLOT_PWRGD</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;&amp;</span> 
		    <span class="o">!</span><span class="p">(</span><span class="n">SLOT_PRESENT</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;&amp;</span> 
		    <span class="o">!</span><span class="p">(</span><span class="n">SLOT_LATCH</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;BEFORE POWER OFF COMMAND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">power_off</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*		retval = slot_update(&amp;slot_cur);</span>
<span class="cm">	 *		if (retval)</span>
<span class="cm">	 *			return retval;</span>
<span class="cm">	 *		ibmphp_update_slot_info(slot_cur);</span>
<span class="cm">	 */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">init_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This operation will check whether the slot is within the bounds and</span>
<span class="cm"> * the operation is valid to perform on that slot</span>
<span class="cm"> * Parameters: slot, operation</span>
<span class="cm"> * Returns: 0 or error codes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot_cur</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot_cur</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">number</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">number</span> <span class="o">&gt;</span> <span class="n">max_slots</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">number</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADSLT</span><span class="p">;</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;slot_number in validate is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">slot_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ENABLE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SLOT_PWRGD</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;&amp;</span> 
			     <span class="p">(</span><span class="n">SLOT_PRESENT</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;&amp;</span> 
			     <span class="o">!</span><span class="p">(</span><span class="n">SLOT_LATCH</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DISABLE</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">SLOT_PWRGD</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;&amp;</span> 
			    <span class="p">(</span><span class="n">SLOT_PRESENT</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">SLOT_LATCH</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span><span class="p">(</span><span class="s">&quot;validate failed....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * This routine is for updating the data structures in the hotplug core</span>
<span class="cm"> * Parameters: struct slot</span>
<span class="cm"> * Returns: 0 or error</span>
<span class="cm"> ****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">ibmphp_update_slot_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot_cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hotplug_slot_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">pci_slot</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bus_speed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
        
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">power_status</span> <span class="o">=</span> <span class="n">SLOT_PWRGD</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">attention_status</span> <span class="o">=</span> <span class="n">SLOT_ATTN</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
						<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ext_status</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">latch_status</span> <span class="o">=</span> <span class="n">SLOT_LATCH</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SLOT_PRESENT</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">info</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*		info-&gt;max_adapter_speed_status = MAX_ADAPTER_NONE; */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">info</span><span class="o">-&gt;</span><span class="n">adapter_status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cm">/*		get_max_adapter_speed_1(slot_cur-&gt;hotplug_slot,</span>
<span class="cm">					&amp;info-&gt;max_adapter_speed_status, 0); */</span>
	<span class="p">}</span>

	<span class="n">bus_speed</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">current_speed</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">current_bus_mode</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bus_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BUS_SPEED_33</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BUS_SPEED_66</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BUS_MODE_PCIX</span><span class="p">)</span> 
				<span class="n">bus_speed</span> <span class="o">+=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BUS_MODE_PCI</span><span class="p">)</span>
				<span class="p">;</span>
			<span class="k">else</span>
				<span class="n">bus_speed</span> <span class="o">=</span> <span class="n">PCI_SPEED_UNKNOWN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BUS_SPEED_100</span>:
		<span class="k">case</span> <span class="n">BUS_SPEED_133</span>:
			<span class="n">bus_speed</span> <span class="o">+=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">bus_speed</span> <span class="o">=</span> <span class="n">PCI_SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">cur_bus_speed</span> <span class="o">=</span> <span class="n">bus_speed</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>To do: bus_names </p></td><td class="code"><div class="highlight"><pre>	
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_hp_change_slot_info</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">hotplug_slot</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/******************************************************************************</span>
<span class="cm"> * This function will return the pci_func, given bus and devfunc, or NULL.  It</span>
<span class="cm"> * is called from visit routines</span>
<span class="cm"> ******************************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="nf">ibm_slot_find</span><span class="p">(</span><span class="n">u8</span> <span class="n">busno</span><span class="p">,</span> <span class="n">u8</span> <span class="n">device</span><span class="p">,</span> <span class="n">u8</span> <span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ibmphp_slot_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot_cur</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slot</span><span class="p">,</span> <span class="n">ibm_slot_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">func_cur</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">func_cur</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">func_cur</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">==</span> <span class="n">busno</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">func_cur</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">device</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">func_cur</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">function</span><span class="p">))</span>
					<span class="k">return</span> <span class="n">func_cur</span><span class="p">;</span>
				<span class="n">func_cur</span> <span class="o">=</span> <span class="n">func_cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*************************************************************</span>
<span class="cm"> * This routine frees up memory used by struct slot, including</span>
<span class="cm"> * the pointers to pci_func, bus, hotplug_slot, controller,</span>
<span class="cm"> * and deregistering from the hotplug core</span>
<span class="cm"> *************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_slots</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span> <span class="n">next</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;%s -- enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ibmphp_slot_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot_cur</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slot</span><span class="p">,</span> <span class="n">ibm_slot_list</span><span class="p">);</span>
		<span class="n">pci_hp_deregister</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">hotplug_slot</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;%s -- exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ibm_unconfigure_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;inside %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;func-&gt;device = %x, func-&gt;function = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">);</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;func-&gt;device &lt;&lt; 3 | 0x0  = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="o">|</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0x08</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">j</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_stop_and_remove_bus_device</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The following function is to fix kernel bug regarding </span>
<span class="cm"> * getting bus entries, here we manually add those primary </span>
<span class="cm"> * bus entries to kernel bus structure whenever apply</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">bus_structure_fixup</span><span class="p">(</span><span class="n">u8</span> <span class="n">busno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_find_bus</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">busno</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">ibmphp_find_same_bus_num</span><span class="p">(</span><span class="n">busno</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bus</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">busno</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ibmphp_pci_bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">l</span> <span class="o">!=</span> <span class="mh">0x0000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&quot;%s - Inside bus_struture_fixup()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">);</span>
			<span class="n">pci_scan_bus</span><span class="p">(</span><span class="n">busno</span><span class="p">,</span> <span class="n">ibmphp_pci_bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ibm_configure_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* this is to make sure we don&#39;t double scan the bus,</span>
<span class="cm">					for bridged devices primarily */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bus_structure_fixup</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">)))</span>
		<span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span>
				<span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">pci_find_bus</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">num</span> <span class="o">=</span> <span class="n">pci_scan_slot</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span>
				<span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span>
			<span class="n">pci_bus_add_devices</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

		<span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span>
				<span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;ERROR... : pci_dev still NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span> <span class="o">==</span> <span class="n">PCI_HEADER_TYPE_BRIDGE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="p">);</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">pci_add_new_bus</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bus</span><span class="p">);</span>
		<span class="n">pci_do_scan_bus</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*******************************************************</span>
<span class="cm"> * Returns whether the bus is empty or not </span>
<span class="cm"> *******************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_bus_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span> <span class="n">slot_cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span> <span class="n">tmp_slot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">slot_min</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">slot_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp_slot</span> <span class="o">=</span> <span class="n">ibmphp_get_slot_from_physical_num</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_slot</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">slot_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_slot</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SLOT_PRESENT</span><span class="p">(</span><span class="n">tmp_slot</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">SLOT_PWRGD</span><span class="p">(</span><span class="n">tmp_slot</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***********************************************************</span>
<span class="cm"> * If the HPC permits and the bus currently empty, tries to set the </span>
<span class="cm"> * bus speed and mode at the maximum card and bus capability</span>
<span class="cm"> * Parameters: slot</span>
<span class="cm"> * Returns: bus is set (0) or error code</span>
<span class="cm"> ***********************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span> <span class="n">slot_cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">speed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">ciobx</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SERVERWORKS</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">)</span> <span class="p">},</span>
	        <span class="p">{</span> <span class="p">},</span>
	<span class="p">};</span>	

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;%s - entry slot # %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SET_BUS_STATUS</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_bus_empty</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">slot_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot_cur</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">SLOT_SPEED</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ext_status</span><span class="p">);</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;ext_status = %x, speed = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ext_status</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HPC_SLOT_SPEED_33</span>:
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_BUS_33CONVMODE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HPC_SLOT_SPEED_66</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">SLOT_PCIX</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ext_status</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">supported_speed</span> <span class="o">&gt;=</span> <span class="n">BUS_SPEED_66</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">supported_bus_mode</span> <span class="o">==</span> <span class="n">BUS_MODE_PCIX</span><span class="p">))</span>
					<span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_BUS_66PCIXMODE</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SLOT_BUS_MODE</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ext_status</span><span class="p">))</span>
					<span class="cm">/* if max slot/bus capability is 66 pci</span>
<span class="cm">					and there&#39;s no bus mode mismatch, then</span>
<span class="cm">					the adapter supports 66 pci */</span> 
					<span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_BUS_66CONVMODE</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_BUS_33CONVMODE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">supported_speed</span> <span class="o">&gt;=</span> <span class="n">BUS_SPEED_66</span><span class="p">)</span>
					<span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_BUS_66CONVMODE</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_BUS_33CONVMODE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HPC_SLOT_SPEED_133</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">supported_speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">BUS_SPEED_33</span>:
				<span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_BUS_33CONVMODE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BUS_SPEED_66</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">supported_bus_mode</span> <span class="o">==</span> <span class="n">BUS_MODE_PCIX</span><span class="p">)</span>
					<span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_BUS_66PCIXMODE</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_BUS_66CONVMODE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BUS_SPEED_100</span>:
				<span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_BUS_100PCIXMODE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">BUS_SPEED_133</span>:
				<span class="cm">/* This is to take care of the bug in CIOBX chip */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pci_dev_present</span><span class="p">(</span><span class="n">ciobx</span><span class="p">))</span>
					<span class="n">ibmphp_hpc_writeslot</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">,</span>
							<span class="n">HPC_BUS_100PCIXMODE</span><span class="p">);</span>
				<span class="n">cmd</span> <span class="o">=</span> <span class="n">HPC_BUS_133PCIXMODE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">err</span><span class="p">(</span><span class="s">&quot;Wrong bus speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;wrong slot speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;setting bus speed for slot %d, cmd %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ibmphp_hpc_writeslot</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;setting bus speed failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CTLR_RESULT</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;command not completed successfully in set_bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* This is for x440, once Brandon fixes the firmware, </span>
<span class="cm">	will not need this delay */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;%s -Exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This routine checks the bus limitations that the slot is on from the BIOS.</span>
<span class="cm"> * This is used in deciding whether or not to power up the slot.  </span>
<span class="cm"> * (electrical/spec limitations. For example, &gt;1 133 MHz or &gt;2 66 PCI cards on</span>
<span class="cm"> * same bus) </span>
<span class="cm"> * Parameters: slot</span>
<span class="cm"> * Returns: 0 = no limitations, -EINVAL = exceeded limitations on the bus</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_limitations</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot_cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span> <span class="n">tmp_slot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">limitation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">slot_min</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">slot_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_slot</span> <span class="o">=</span> <span class="n">ibmphp_get_slot_from_physical_num</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_slot</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">SLOT_PWRGD</span><span class="p">(</span><span class="n">tmp_slot</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span><span class="p">(</span><span class="n">SLOT_CONNECT</span><span class="p">(</span><span class="n">tmp_slot</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)))</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">get_cur_bus_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">current_speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BUS_SPEED_33</span>:
		<span class="n">limitation</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">slots_at_33_conv</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BUS_SPEED_66</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">current_bus_mode</span> <span class="o">==</span> <span class="n">BUS_MODE_PCIX</span><span class="p">)</span>
			<span class="n">limitation</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">slots_at_66_pcix</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">limitation</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">slots_at_66_conv</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BUS_SPEED_100</span>:
		<span class="n">limitation</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">slots_at_100_pcix</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BUS_SPEED_133</span>:
		<span class="n">limitation</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">slots_at_133_pcix</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limitation</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">print_card_capability</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot_cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="p">(</span><span class="s">&quot;capability of the card is &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ext_status</span> <span class="o">&amp;</span> <span class="n">CARD_INFO</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCIX133</span><span class="p">)</span> 
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;   133 MHz PCI-X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ext_status</span> <span class="o">&amp;</span> <span class="n">CARD_INFO</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCIX66</span><span class="p">)</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;    66 MHz PCI-X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ext_status</span> <span class="o">&amp;</span> <span class="n">CARD_INFO</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI66</span><span class="p">)</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;    66 MHz PCI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;    33 MHz PCI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* This routine will power on the slot, configure the device(s) and find the</span>
<span class="cm"> * drivers for them.</span>
<span class="cm"> * Parameters: hotplug_slot</span>
<span class="cm"> * Returns: 0 or failure codes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">enable_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rcpr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot_cur</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_func</span> <span class="o">*</span><span class="n">tmp_func</span><span class="p">;</span>

	<span class="n">ibmphp_lock_operations</span><span class="p">();</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;ENABLING SLOT........</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">slot_cur</span> <span class="o">=</span> <span class="n">hs</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">,</span> <span class="n">ENABLE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;validate function failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_nopower</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">attn_LED_blink</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
	
	<span class="n">rc</span> <span class="o">=</span> <span class="n">set_bus</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;was not able to set the bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_nopower</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*-----------------debugging------------------------------*/</span>
	<span class="n">get_cur_bus_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;the current bus speed right after set_bus = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">current_speed</span><span class="p">);</span>
	<span class="cm">/*----------------------------------------------------------*/</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">check_limitations</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;Adding this card exceeds the limitations of this bus.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;(i.e., &gt;1 133MHz cards running on same bus, or &quot;</span>
		     <span class="s">&quot;&gt;2 66 PCI cards running on same bus.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;Try hot-adding into another bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_nopower</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">power_on</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;something wrong when powering up... please see below for details</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* need to turn off before on, otherwise, blinking overwrites */</span>
		<span class="n">attn_off</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
		<span class="n">attn_on</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot_cur</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">attn_off</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
			<span class="n">attn_on</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Check to see the error of why it failed */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">SLOT_POWER</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span><span class="p">(</span><span class="n">SLOT_PWRGD</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)))</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;power fault occurred trying to power up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SLOT_BUS_SPEED</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;bus speed mismatch occurred.  please check &quot;</span>
				<span class="s">&quot;current bus speed and card capability</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">print_card_capability</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SLOT_BUS_MODE</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ext_status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;bus mode mismatch occurred.  please check &quot;</span>
				<span class="s">&quot;current bus mode and card capability</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">print_card_capability</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ibmphp_update_slot_info</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;after power_on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/*-----------------------debugging---------------------------*/</span>
	<span class="n">get_cur_bus_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;the current bus speed right after power_on = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus_on</span><span class="o">-&gt;</span><span class="n">current_speed</span><span class="p">);</span>
	<span class="cm">/*----------------------------------------------------------*/</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">slot_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_power</span><span class="p">;</span>
	
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SLOT_POWER</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">SLOT_PWRGD</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;power fault occurred trying to power up...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_power</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SLOT_POWER</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SLOT_BUS_SPEED</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;bus speed mismatch occurred.  please check current bus &quot;</span>
					<span class="s">&quot;speed and card capability</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">print_card_capability</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_power</span><span class="p">;</span>
	<span class="p">}</span> 
	<span class="cm">/* Don&#39;t think this case will happen after above checks...</span>
<span class="cm">	 * but just in case, for paranoia sake */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SLOT_POWER</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;power on failed...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_power</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We cannot do update_slot_info here, since no memory for</span>
<span class="cm">		 * kmalloc n.e.ways, and update_slot_info allocates some */</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_power</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;b4 configure_card, slot_cur-&gt;bus = %x, slot_cur-&gt;device = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibmphp_configure_card</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;configure_card was unsuccessful...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* true because don&#39;t need to actually deallocate resources,</span>
<span class="cm">		 * just remove references */</span>
		<span class="n">ibmphp_unconfigure_card</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot_cur</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&quot;after unconfigure_card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_power</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">function</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tmp_func</span> <span class="o">=</span> <span class="n">ibm_slot_find</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
							<span class="n">function</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_func</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">tmp_func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">ibm_configure_device</span><span class="p">(</span><span class="n">tmp_func</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp_func</span><span class="p">);</span>

	<span class="n">attn_off</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot_cur</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ibmphp_print_test</span><span class="p">();</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_update_slot_info</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">ibmphp_unlock_operations</span><span class="p">();</span> 
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">error_nopower:</span>
	<span class="n">attn_off</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>	<span class="cm">/* need to turn off if was blinking b4 */</span>
	<span class="n">attn_on</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
<span class="nl">error_cont:</span>
	<span class="n">rcpr</span> <span class="o">=</span> <span class="n">slot_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcpr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rcpr</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ibmphp_update_slot_info</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

<span class="nl">error_power:</span>
	<span class="n">attn_off</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>	<span class="cm">/* need to turn off if was blinking b4 */</span>
	<span class="n">attn_on</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="n">rcpr</span> <span class="o">=</span> <span class="n">power_off</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcpr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rcpr</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">error_cont</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************</span>
<span class="cm">* HOT REMOVING ADAPTER CARD                                   *</span>
<span class="cm">* INPUT: POINTER TO THE HOTPLUG SLOT STRUCTURE                *</span>
<span class="cm">* OUTPUT: SUCCESS 0 ; FAILURE: UNCONFIGURE , VALIDATE         *</span>
<span class="cm">          DISABLE POWER ,                                    *</span>
<span class="cm">**************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ibmphp_disable_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">hotplug_slot</span> <span class="o">*</span><span class="n">hotplug_slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">hotplug_slot</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	
	<span class="n">ibmphp_lock_operations</span><span class="p">();</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_do_disable_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>
	<span class="n">ibmphp_unlock_operations</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ibmphp_do_disable_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">slot</span> <span class="o">*</span><span class="n">slot_cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flag</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;DISABLING SLOT...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
		
	<span class="k">if</span> <span class="p">((</span><span class="n">slot_cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">flag</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">;</span>
	<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">,</span> <span class="n">DISABLE</span><span class="p">);</span>
			<span class="cm">/* checking if powered off already &amp; valid slot # */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">attn_LED_blink</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We need this for fncs&#39;s that were there on bootup */</span>
		<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_func</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;out of system memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">busno</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ibm_unconfigure_device</span><span class="p">(</span><span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
        
	<span class="cm">/* If we got here from latch suddenly opening on operating card or </span>
<span class="cm">	a power fault, there&#39;s no power to the card, so cannot</span>
<span class="cm">	read from it to determine what resources it occupied.  This operation</span>
<span class="cm">	is forbidden anyhow.  The best we can do is remove it from kernel</span>
<span class="cm">	lists at least */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attn_off</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_unconfigure_card</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot_cur</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">slot_cur</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;in disable_slot. after unconfigure_card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;could not unconfigure card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_hpc_writeslot</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">,</span> <span class="n">HPC_SLOT_OFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">attn_off</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">slot_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_update_slot_info</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="n">ibmphp_print_test</span><span class="p">();</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="cm">/*  Need to turn off if was blinking b4 */</span>
	<span class="n">attn_off</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="n">attn_on</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot_cur</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span>		
		<span class="n">ibmphp_update_slot_info</span><span class="p">(</span><span class="n">slot_cur</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">hotplug_slot_ops</span> <span class="n">ibmphp_hotplug_slot_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_attention_status</span> <span class="o">=</span>		<span class="n">set_attention_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_slot</span> <span class="o">=</span>			<span class="n">enable_slot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_slot</span> <span class="o">=</span>			<span class="n">ibmphp_disable_slot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hardware_test</span> <span class="o">=</span>		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_power_status</span> <span class="o">=</span>		<span class="n">get_power_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_attention_status</span> <span class="o">=</span>		<span class="n">get_attention_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_latch_status</span> <span class="o">=</span>		<span class="n">get_latch_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_adapter_status</span> <span class="o">=</span>		<span class="n">get_adapter_present</span><span class="p">,</span>
<span class="cm">/*	.get_max_adapter_speed =	get_max_adapter_speed,</span>
<span class="cm">	.get_bus_name_status =		get_bus_name,</span>
<span class="cm">*/</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ibmphp_unload</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_slots</span><span class="p">();</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;after slots</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ibmphp_free_resources</span><span class="p">();</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;after resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ibmphp_free_bus_info_queue</span><span class="p">();</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;after bus info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ibmphp_free_ebda_hpc_queue</span><span class="p">();</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;after ebda hpc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ibmphp_free_ebda_pci_rsrc_queue</span><span class="p">();</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;after ebda pci rsrc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ibmphp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">info</span><span class="p">(</span><span class="n">DRIVER_DESC</span> <span class="s">&quot; version: &quot;</span> <span class="n">DRIVER_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ibmphp_pci_bus</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ibmphp_pci_bus</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibmphp_pci_bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">pci_find_bus</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;Can&#39;t find the root pci bus, can not continue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ibmphp_pci_bus</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ibmphp_pci_bus</span><span class="p">));</span>

	<span class="n">ibmphp_debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

	<span class="n">ibmphp_hpc_initvars</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">irqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_access_ebda</span><span class="p">()))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;after ibmphp_access_ebda()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_rsrc_init</span><span class="p">()))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;AFTER Resource &amp; EBDA INITIALIZATIONS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">max_slots</span> <span class="o">=</span> <span class="n">get_max_slots</span><span class="p">();</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_register_pci</span><span class="p">()))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init_ops</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ibmphp_print_test</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">ibmphp_hpc_start_poll_thread</span><span class="p">()))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">ibmphp_unload</span><span class="p">();</span>
	<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ibmphp_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ibmphp_hpc_stop_poll_thread</span><span class="p">();</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;after polling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ibmphp_unload</span><span class="p">();</span>
	<span class="n">debug</span><span class="p">(</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ibmphp_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ibmphp_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
