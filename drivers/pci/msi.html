<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pci › msi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>msi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * File:	msi.c</span>
<span class="cm"> * Purpose:	PCI Message Signaled Interrupt (MSI)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003-2004 Intel</span>
<span class="cm"> * Copyright (C) Tom Long Nguyen (tom.l.nguyen@intel.com)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/msi.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;pci.h&quot;</span>
<span class="cp">#include &quot;msi.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pci_msi_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/* Arch hooks */</span>

<span class="cp">#ifndef arch_msi_check_device</span>
<span class="kt">int</span> <span class="nf">arch_msi_check_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nvec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef arch_setup_msi_irqs</span>
<span class="cp"># define arch_setup_msi_irqs default_setup_msi_irqs</span>
<span class="cp"># define HAVE_DEFAULT_MSI_SETUP_IRQS</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef HAVE_DEFAULT_MSI_SETUP_IRQS</span>
<span class="kt">int</span> <span class="nf">default_setup_msi_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nvec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If an architecture wants to support multiple MSI, it needs to</span>
<span class="cm">	 * override arch_setup_msi_irqs()</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PCI_CAP_ID_MSI</span> <span class="o">&amp;&amp;</span> <span class="n">nvec</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">arch_setup_msi_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef arch_teardown_msi_irqs</span>
<span class="cp"># define arch_teardown_msi_irqs default_teardown_msi_irqs</span>
<span class="cp"># define HAVE_DEFAULT_MSI_TEARDOWN_IRQS</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef HAVE_DEFAULT_MSI_TEARDOWN_IRQS</span>
<span class="kt">void</span> <span class="nf">default_teardown_msi_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nvec</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">nvec</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">multiple</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nvec</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">arch_teardown_msi_irq</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef arch_restore_msi_irqs</span>
<span class="cp"># define arch_restore_msi_irqs default_restore_msi_irqs</span>
<span class="cp"># define HAVE_DEFAULT_MSI_RESTORE_IRQS</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef HAVE_DEFAULT_MSI_RESTORE_IRQS</span>
<span class="kt">void</span> <span class="nf">default_restore_msi_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_enabled</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">irq_get_msi_desc</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span>
		<span class="n">write_msi_msg</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msi_set_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSI_FLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_MSI_FLAGS_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">PCI_MSI_FLAGS_ENABLE</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSI_FLAGS</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msix_set_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSIX_FLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
		<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_MSIX_FLAGS_ENABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">PCI_MSIX_FLAGS_ENABLE</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSIX_FLAGS</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__attribute_const__</span> <span class="n">u32</span> <span class="nf">msi_mask</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Don&#39;t shift by &gt;= width of type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">x</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__attribute_const__</span> <span class="n">u32</span> <span class="nf">msi_capable_mask</span><span class="p">(</span><span class="n">u16</span> <span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">msi_mask</span><span class="p">((</span><span class="n">control</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__attribute_const__</span> <span class="n">u32</span> <span class="nf">msi_enabled_mask</span><span class="p">(</span><span class="n">u16</span> <span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">msi_mask</span><span class="p">((</span><span class="n">control</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PCI 2.3 does not specify mask bits for each MSI interrupt.  Attempting to</span>
<span class="cm"> * mask all MSI interrupts by clearing the MSI enable bit does not work</span>
<span class="cm"> * reliably as devices without an INTx disable bit will then generate a</span>
<span class="cm"> * level IRQ which will never be cleared.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">__msi_mask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask_bits</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">masked</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">maskbit</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mask_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">mask_bits</span> <span class="o">|=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">mask_pos</span><span class="p">,</span> <span class="n">mask_bits</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mask_bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msi_mask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">masked</span> <span class="o">=</span> <span class="n">__msi_mask_irq</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This internal function does not flush PCI writes to the device.</span>
<span class="cm"> * All users must ensure that they read from the device before either</span>
<span class="cm"> * assuming that the device state is up to date, or returning out of this</span>
<span class="cm"> * file.  This saves a few milliseconds when initialising devices with lots</span>
<span class="cm"> * of MSI-X interrupts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">__msix_mask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask_bits</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">masked</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">entry_nr</span> <span class="o">*</span> <span class="n">PCI_MSIX_ENTRY_SIZE</span> <span class="o">+</span>
						<span class="n">PCI_MSIX_ENTRY_VECTOR_CTRL</span><span class="p">;</span>
	<span class="n">mask_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_MSIX_ENTRY_CTRL_MASKBIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span>
		<span class="n">mask_bits</span> <span class="o">|=</span> <span class="n">PCI_MSIX_ENTRY_CTRL_MASKBIT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">mask_bits</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">mask_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mask_bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msix_mask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">masked</span> <span class="o">=</span> <span class="n">__msix_mask_irq</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msi_set_mask_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">irq_data_get_msi</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">is_msix</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msix_mask_irq</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">mask_base</span><span class="p">);</span>		<span class="cm">/* Flush write to device */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">msi_mask_irq</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">,</span> <span class="n">flag</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mask_msi_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">msi_set_mask_bit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">unmask_msi_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">msi_set_mask_bit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__read_msi_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msi_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">!=</span> <span class="n">PCI_D0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">is_msix</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">mask_base</span> <span class="o">+</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">entry_nr</span> <span class="o">*</span> <span class="n">PCI_MSIX_ENTRY_SIZE</span><span class="p">;</span>

		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_lo</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">PCI_MSIX_ENTRY_LOWER_ADDR</span><span class="p">);</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_hi</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">PCI_MSIX_ENTRY_UPPER_ADDR</span><span class="p">);</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">PCI_MSIX_ENTRY_DATA</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">pos</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msi_lower_address_reg</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_lo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">is_64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msi_upper_address_reg</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span>
						<span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_hi</span><span class="p">);</span>
			<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msi_data_reg</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msi_data_reg</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">read_msi_msg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msi_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">irq_get_msi_desc</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">__read_msi_msg</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__get_cached_msi_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msi_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Assert that the cache is valid, assuming that</span>
<span class="cm">	 * valid messages are not all-zeroes. */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">address_hi</span> <span class="o">|</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">address_lo</span> <span class="o">|</span>
		 <span class="n">entry</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data</span><span class="p">));</span>

	<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">get_cached_msi_msg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msi_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">irq_get_msi_desc</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">__get_cached_msi_msg</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__write_msi_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msi_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">!=</span> <span class="n">PCI_D0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t touch the hardware now */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">is_msix</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">mask_base</span> <span class="o">+</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">entry_nr</span> <span class="o">*</span> <span class="n">PCI_MSIX_ENTRY_SIZE</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_lo</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PCI_MSIX_ENTRY_LOWER_ADDR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_hi</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PCI_MSIX_ENTRY_UPPER_ADDR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PCI_MSIX_ENTRY_DATA</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">pos</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">msgctl</span><span class="p">;</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msi_control_reg</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">msgctl</span><span class="p">);</span>
		<span class="n">msgctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_MSI_FLAGS_QSIZE</span><span class="p">;</span>
		<span class="n">msgctl</span> <span class="o">|=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">multiple</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msi_control_reg</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="n">msgctl</span><span class="p">);</span>

		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msi_lower_address_reg</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span>
					<span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_lo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">is_64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msi_upper_address_reg</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span>
						<span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_hi</span><span class="p">);</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msi_data_reg</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
						<span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msi_data_reg</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
						<span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">msg</span> <span class="o">=</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">write_msi_msg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msi_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">irq_get_msi_desc</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">__write_msi_msg</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_msi_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nvec</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">nvec</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">multiple</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nvec</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">irq_has_action</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">arch_teardown_msi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">is_msix</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">))</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">mask_base</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Its possible that we get into this path</span>
<span class="cm">		 * When populate_msi_sysfs fails, which means the entries</span>
<span class="cm">		 * were not registered with sysfs.  In that case don&#39;t</span>
<span class="cm">		 * unregister them.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kobject_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
			<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="nf">alloc_msi_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_intx_for_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">PCI_DEV_FLAGS_MSI_INTX_DISABLE_BUG</span><span class="p">))</span>
		<span class="n">pci_intx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__pci_restore_msi_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">irq_get_msi_desc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">pos</span><span class="p">;</span>

	<span class="n">pci_intx_for_msi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msi_set_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">arch_restore_msi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSI_FLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
	<span class="n">msi_mask_irq</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">msi_capable_mask</span><span class="p">(</span><span class="n">control</span><span class="p">),</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">masked</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_MSI_FLAGS_QSIZE</span><span class="p">;</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">multiple</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">PCI_MSI_FLAGS_ENABLE</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSI_FLAGS</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__pci_restore_msix_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">));</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msi_desc</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSIX_FLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>

	<span class="cm">/* route the table */</span>
	<span class="n">pci_intx_for_msi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">PCI_MSIX_FLAGS_ENABLE</span> <span class="o">|</span> <span class="n">PCI_MSIX_FLAGS_MASKALL</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSIX_FLAGS</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arch_restore_msi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">msix_mask_irq</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">masked</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_MSIX_FLAGS_MASKALL</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSIX_FLAGS</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pci_restore_msi_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__pci_restore_msi_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">__pci_restore_msix_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pci_restore_msi_state</span><span class="p">);</span>


<span class="cp">#define to_msi_attr(obj) container_of(obj, struct msi_attribute, attr)</span>
<span class="cp">#define to_msi_desc(obj) container_of(obj, struct msi_desc, kobj)</span>

<span class="k">struct</span> <span class="n">msi_attribute</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">attribute</span>        <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">show</span><span class="p">)(</span><span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msi_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">store</span><span class="p">)(</span><span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msi_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_msi_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msi_attribute</span> <span class="o">*</span><span class="n">atr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">is_msix</span> <span class="o">?</span> <span class="s">&quot;msix&quot;</span> <span class="o">:</span> <span class="s">&quot;msi&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">msi_irq_attr_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_attribute</span> <span class="o">*</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">to_msi_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">to_msi_desc</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attribute</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">attribute</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sysfs_ops</span> <span class="n">msi_irq_sysfs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">msi_irq_attr_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">msi_attribute</span> <span class="n">mode_attribute</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_msi_mode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>


<span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">msi_irq_default_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">mode_attribute</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">msi_kobj_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">to_msi_desc</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>

	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="n">msi_irq_ktype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">msi_kobj_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sysfs_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msi_irq_sysfs_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_attrs</span> <span class="o">=</span> <span class="n">msi_irq_default_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">populate_msi_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">msi_kset</span> <span class="o">=</span> <span class="n">kset_create_and_add</span><span class="p">(</span><span class="s">&quot;msi_irqs&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">msi_kset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kobj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">;</span>
		<span class="n">kobj</span><span class="o">-&gt;</span><span class="n">kset</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">msi_kset</span><span class="p">;</span>
		<span class="n">pci_dev_get</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">kobject_init_and_add</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msi_irq_ktype</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				     <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unroll</span><span class="p">;</span>

		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unroll:</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">kobject_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
		<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * msi_capability_init - configure device&#39;s MSI capability structure</span>
<span class="cm"> * @dev: pointer to the pci_dev data structure of MSI device function</span>
<span class="cm"> * @nvec: number of interrupts to allocate</span>
<span class="cm"> *</span>
<span class="cm"> * Setup the MSI capability structure of the device with the requested</span>
<span class="cm"> * number of interrupts.  A return value of zero indicates the successful</span>
<span class="cm"> * setup of an entry with the new MSI irq.  A negative return value indicates</span>
<span class="cm"> * an error, and a positive return value indicates the number of interrupts</span>
<span class="cm"> * which could have been allocated.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">msi_capability_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nvec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSI</span><span class="p">);</span>
	<span class="n">msi_set_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Disable MSI during set up */</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msi_control_reg</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
	<span class="cm">/* MSI Entry Initialization */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">alloc_msi_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">is_msix</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">is_64</span>		<span class="o">=</span> <span class="n">is_64bit_address</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">entry_nr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">maskbit</span>	<span class="o">=</span> <span class="n">is_mask_bit_support</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">default_irq</span>	<span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>	<span class="cm">/* Save IOAPIC IRQ */</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">pos</span>		<span class="o">=</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mask_pos</span> <span class="o">=</span> <span class="n">msi_mask_reg</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">is_64</span><span class="p">);</span>
	<span class="cm">/* All MSIs are unmasked by default, Mask them all */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">maskbit</span><span class="p">)</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">mask_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">masked</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">msi_capable_mask</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>
	<span class="n">msi_mask_irq</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">);</span>

	<span class="cm">/* Configure MSI capability structure */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">arch_setup_msi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nvec</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msi_mask_irq</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="o">~</span><span class="n">mask</span><span class="p">);</span>
		<span class="n">free_msi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">populate_msi_sysfs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msi_mask_irq</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="o">~</span><span class="n">mask</span><span class="p">);</span>
		<span class="n">free_msi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set MSI enabled bits	 */</span>
	<span class="n">pci_intx_for_msi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msi_set_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">msix_map_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pos</span><span class="p">,</span>
							<span class="kt">unsigned</span> <span class="n">nr_entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">resource_size_t</span> <span class="n">phys_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">table_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bir</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msix_table_offset_reg</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">table_offset</span><span class="p">);</span>
	<span class="n">bir</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">table_offset</span> <span class="o">&amp;</span> <span class="n">PCI_MSIX_FLAGS_BIRMASK</span><span class="p">);</span>
	<span class="n">table_offset</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_MSIX_FLAGS_BIRMASK</span><span class="p">;</span>
	<span class="n">phys_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bir</span><span class="p">)</span> <span class="o">+</span> <span class="n">table_offset</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">,</span> <span class="n">nr_entries</span> <span class="o">*</span> <span class="n">PCI_MSIX_ENTRY_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msix_setup_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pos</span><span class="p">,</span>
				<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msix_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">nvec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nvec</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">alloc_msi_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">free_msi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="cm">/* No enough memory. Don&#39;t try again */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">is_msix</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">is_64</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">entry_nr</span>	<span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">default_irq</span>	<span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">pos</span>		<span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mask_base</span>		<span class="o">=</span> <span class="n">base</span><span class="p">;</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msix_program_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">msix_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">*</span> <span class="n">PCI_MSIX_ENTRY_SIZE</span> <span class="o">+</span>
						<span class="n">PCI_MSIX_ENTRY_VECTOR_CTRL</span><span class="p">;</span>

		<span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">irq_set_msi_desc</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">masked</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">mask_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">msix_mask_irq</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * msix_capability_init - configure device&#39;s MSI-X capability</span>
<span class="cm"> * @dev: pointer to the pci_dev data structure of MSI-X device function</span>
<span class="cm"> * @entries: pointer to an array of struct msix_entry entries</span>
<span class="cm"> * @nvec: number of @entries</span>
<span class="cm"> *</span>
<span class="cm"> * Setup the MSI-X capability structure of device function with a</span>
<span class="cm"> * single MSI-X irq. A return of zero indicates the successful setup of</span>
<span class="cm"> * requested MSI-X entries with allocated irqs or non-zero for otherwise.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">msix_capability_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">msix_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nvec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSIX_FLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>

	<span class="cm">/* Ensure MSI-X is disabled while it is set up */</span>
	<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_MSIX_FLAGS_ENABLE</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSIX_FLAGS</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

	<span class="cm">/* Request &amp; Map MSI-X table region */</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">msix_map_region</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">multi_msix_capable</span><span class="p">(</span><span class="n">control</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">msix_setup_entries</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">nvec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">arch_setup_msi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nvec</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some devices require MSI-X to be enabled before we can touch the</span>
<span class="cm">	 * MSI-X registers.  We need to mask all the vectors to prevent</span>
<span class="cm">	 * interrupts coming in before they&#39;re fully set up.</span>
<span class="cm">	 */</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">PCI_MSIX_FLAGS_MASKALL</span> <span class="o">|</span> <span class="n">PCI_MSIX_FLAGS_ENABLE</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSIX_FLAGS</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

	<span class="n">msix_program_entries</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">populate_msi_sysfs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set MSI-X enabled bits and unmask the function */</span>
	<span class="n">pci_intx_for_msi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">msix_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_MSIX_FLAGS_MASKALL</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSIX_FLAGS</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we had some success, report the number of irqs</span>
<span class="cm">		 * we succeeded in setting up.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">avail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">avail</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avail</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">avail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free_msi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_msi_check_device - check whether MSI may be enabled on a device</span>
<span class="cm"> * @dev: pointer to the pci_dev data structure of MSI device function</span>
<span class="cm"> * @nvec: how many MSIs have been requested ?</span>
<span class="cm"> * @type: are we checking for MSI or MSI-X ?</span>
<span class="cm"> *</span>
<span class="cm"> * Look at global flags, the device itself, and its parent busses</span>
<span class="cm"> * to determine if MSI/-X are supported for the device. If MSI/-X is</span>
<span class="cm"> * supported return 0, else return an error code.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_msi_check_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nvec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* MSI must be globally enabled and supported by the device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_msi_enable</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">no_msi</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * You can&#39;t ask to have 0 or less MSIs configured.</span>
<span class="cm">	 *  a) it&#39;s stupid ..</span>
<span class="cm">	 *  b) the list manipulation code assumes nvec &gt;= 1.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nvec</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Any bridge which does NOT route MSI transactions from its</span>
<span class="cm">	 * secondary bus to its primary bus must set NO_MSI flag on</span>
<span class="cm">	 * the secondary pci_bus.</span>
<span class="cm">	 * We expect only arch-specific PCI host bus controller driver</span>
<span class="cm">	 * or quirks for specific PCI bridges to be setting NO_MSI.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span> <span class="n">bus</span><span class="p">;</span> <span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bus_flags</span> <span class="o">&amp;</span> <span class="n">PCI_BUS_FLAGS_NO_MSI</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">arch_msi_check_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nvec</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_find_capability</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_enable_msi_block - configure device&#39;s MSI capability structure</span>
<span class="cm"> * @dev: device to configure</span>
<span class="cm"> * @nvec: number of interrupts to configure</span>
<span class="cm"> *</span>
<span class="cm"> * Allocate IRQs for a device with the MSI capability.</span>
<span class="cm"> * This function returns a negative errno if an error occurs.  If it</span>
<span class="cm"> * is unable to allocate the number of interrupts requested, it returns</span>
<span class="cm"> * the number of interrupts it might be able to allocate.  If it successfully</span>
<span class="cm"> * allocates at least the number of interrupts requested, it returns 0 and</span>
<span class="cm"> * updates the @dev&#39;s irq member to the lowest new interrupt number; the</span>
<span class="cm"> * other interrupt numbers allocated to this device are consecutive.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pci_enable_msi_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nvec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">maxvec</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">msgctl</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSI_FLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgctl</span><span class="p">);</span>
	<span class="n">maxvec</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">msgctl</span> <span class="o">&amp;</span> <span class="n">PCI_MSI_FLAGS_QMASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nvec</span> <span class="o">&gt;</span> <span class="n">maxvec</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">maxvec</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">pci_msi_check_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nvec</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_enabled</span><span class="p">);</span>

	<span class="cm">/* Check whether driver already requested MSI-X irqs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t enable MSI &quot;</span>
			 <span class="s">&quot;(MSI-X already enabled)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">msi_capability_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nvec</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_enable_msi_block</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">pci_msi_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_msi_enable</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">));</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msi_desc</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">pos</span><span class="p">;</span>

	<span class="n">msi_set_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_intx_for_msi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Return the device with MSI unmasked as initial states */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_MSI_FLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">msi_capable_mask</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="cm">/* Keep cached state to be restored */</span>
	<span class="n">__msi_mask_irq</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="o">~</span><span class="n">mask</span><span class="p">);</span>

	<span class="cm">/* Restore dev-&gt;irq to its default pin-assertion irq */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">default_irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pci_disable_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_msi_enable</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pci_msi_shutdown</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_msi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kset_unregister</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_kset</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_kset</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_disable_msi</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pci_msix_table_size - return the number of device&#39;s MSI-X table entries</span>
<span class="cm"> * @dev: pointer to the pci_dev data structure of MSI-X device function</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pci_msix_table_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msi_control_reg</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">multi_msix_capable</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_enable_msix - configure device&#39;s MSI-X capability structure</span>
<span class="cm"> * @dev: pointer to the pci_dev data structure of MSI-X device function</span>
<span class="cm"> * @entries: pointer to an array of MSI-X entries</span>
<span class="cm"> * @nvec: number of MSI-X irqs requested for allocation by device driver</span>
<span class="cm"> *</span>
<span class="cm"> * Setup the MSI-X capability structure of device function with the number</span>
<span class="cm"> * of requested irqs upon its software driver call to request for</span>
<span class="cm"> * MSI-X mode enabled on its hardware device function. A return of zero</span>
<span class="cm"> * indicates the successful configuration of MSI-X capability structure</span>
<span class="cm"> * with new allocated MSI-X irqs. A return of &lt; 0 indicates a failure.</span>
<span class="cm"> * Or a return of &gt; 0 indicates that driver request is exceeding the number</span>
<span class="cm"> * of irqs or MSI-X vectors available. Driver should use the returned value to</span>
<span class="cm"> * re-send its request.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">pci_enable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msix_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nvec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">nr_entries</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entries</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">pci_msi_check_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nvec</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">nr_entries</span> <span class="o">=</span> <span class="n">pci_msix_table_size</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nvec</span> <span class="o">&gt;</span> <span class="n">nr_entries</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nr_entries</span><span class="p">;</span>

	<span class="cm">/* Check for any invalid entries */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nvec</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">&gt;=</span> <span class="n">nr_entries</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>		<span class="cm">/* invalid entry */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nvec</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">==</span> <span class="n">entries</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">entry</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* duplicate entry */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">);</span>

	<span class="cm">/* Check whether driver already requested for MSI irq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t enable MSI-X &quot;</span>
		       <span class="s">&quot;(MSI IRQ already assigned)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">msix_capability_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">nvec</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_enable_msix</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">pci_msix_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_msi_enable</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Return the device with MSI-X masked as initial states */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Keep cached states to be restored */</span>
		<span class="n">__msix_mask_irq</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">msix_set_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_intx_for_msi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">msix_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pci_disable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_msi_enable</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pci_msix_shutdown</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_msi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kset_unregister</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_kset</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_kset</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_disable_msix</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * msi_remove_pci_irq_vectors - reclaim MSI(X) irqs to unused state</span>
<span class="cm"> * @dev: pointer to the pci_dev data structure of MSI(X) device function</span>
<span class="cm"> *</span>
<span class="cm"> * Being called during hotplug remove, from which the device function</span>
<span class="cm"> * is hot-removed. All previous assigned MSI/MSI-X irqs, if</span>
<span class="cm"> * allocated for this device function, are reclaimed to unused state,</span>
<span class="cm"> * which may be used later on.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">msi_remove_pci_irq_vectors</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_msi_enable</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_enabled</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">msix_enabled</span><span class="p">)</span>
		<span class="n">free_msi_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pci_no_msi</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_msi_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pci_msi_enabled - is MSI enabled?</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if MSI has not been disabled by the command-line option</span>
<span class="cm"> * pci=nomsi.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">pci_msi_enabled</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_msi_enable</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_msi_enabled</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">pci_msi_init_pci_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">);</span>

	<span class="cm">/* Disable the msi hardware to avoid screaming interrupts</span>
<span class="cm">	 * during boot.  This is the power on reset default so</span>
<span class="cm">	 * usually this should be a noop.</span>
<span class="cm">	 */</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span>
		<span class="n">msi_set_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msix_set_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
