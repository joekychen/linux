<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › pktcdvd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pktcdvd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2000 Jens Axboe &lt;axboe@suse.de&gt;</span>
<span class="cm"> * Copyright (C) 2001-2004 Peter Osterlund &lt;petero2@telia.com&gt;</span>
<span class="cm"> * Copyright (C) 2006 Thomas Maier &lt;balagi@justmail.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * May be copied or modified under the terms of the GNU General Public</span>
<span class="cm"> * License.  See linux/COPYING for more information.</span>
<span class="cm"> *</span>
<span class="cm"> * Packet writing layer for ATAPI and SCSI CD-RW, DVD+RW, DVD-RW and</span>
<span class="cm"> * DVD-RAM devices.</span>
<span class="cm"> *</span>
<span class="cm"> * Theory of operation:</span>
<span class="cm"> *</span>
<span class="cm"> * At the lowest level, there is the standard driver for the CD/DVD device,</span>
<span class="cm"> * typically ide-cd.c or sr.c. This driver can handle read and write requests,</span>
<span class="cm"> * but it doesn&#39;t know anything about the special restrictions that apply to</span>
<span class="cm"> * packet writing. One restriction is that write requests must be aligned to</span>
<span class="cm"> * packet boundaries on the physical media, and the size of a write request</span>
<span class="cm"> * must be equal to the packet size. Another restriction is that a</span>
<span class="cm"> * GPCMD_FLUSH_CACHE command has to be issued to the drive before a read</span>
<span class="cm"> * command, if the previous command was a write.</span>
<span class="cm"> *</span>
<span class="cm"> * The purpose of the packet writing driver is to hide these restrictions from</span>
<span class="cm"> * higher layers, such as file systems, and present a block device that can be</span>
<span class="cm"> * randomly read and written using 2kB-sized blocks.</span>
<span class="cm"> *</span>
<span class="cm"> * The lowest layer in the packet writing driver is the packet I/O scheduler.</span>
<span class="cm"> * Its data is defined by the struct packet_iosched and includes two bio</span>
<span class="cm"> * queues with pending read and write requests. These queues are processed</span>
<span class="cm"> * by the pkt_iosched_process_queue() function. The write requests in this</span>
<span class="cm"> * queue are already properly aligned and sized. This layer is responsible for</span>
<span class="cm"> * issuing the flush cache commands and scheduling the I/O in a good order.</span>
<span class="cm"> *</span>
<span class="cm"> * The next layer transforms unaligned write requests to aligned writes. This</span>
<span class="cm"> * transformation requires reading missing pieces of data from the underlying</span>
<span class="cm"> * block device, assembling the pieces to full packets and queuing them to the</span>
<span class="cm"> * packet I/O scheduler.</span>
<span class="cm"> *</span>
<span class="cm"> * At the top layer there is a custom make_request_fn function that forwards</span>
<span class="cm"> * read requests directly to the iosched queue and puts write requests in the</span>
<span class="cm"> * unaligned write queue. A kernel thread performs the necessary read</span>
<span class="cm"> * gathering to convert the unaligned writes to aligned writes and then feeds</span>
<span class="cm"> * them to the packet I/O scheduler.</span>
<span class="cm"> *</span>
<span class="cm"> *************************************************************************/</span>

<span class="cp">#include &lt;linux/pktcdvd.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_ioctl.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#define DRIVER_NAME	&quot;pktcdvd&quot;</span>

<span class="cp">#if PACKET_DEBUG</span>
<span class="cp">#define DPRINTK(fmt, args...) printk(KERN_NOTICE fmt, ##args)</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTK(fmt, args...)</span>
<span class="cp">#endif</span>

<span class="cp">#if PACKET_DEBUG &gt; 1</span>
<span class="cp">#define VPRINTK(fmt, args...) printk(KERN_NOTICE fmt, ##args)</span>
<span class="cp">#else</span>
<span class="cp">#define VPRINTK(fmt, args...)</span>
<span class="cp">#endif</span>

<span class="cp">#define MAX_SPEED 0xffff</span>

<span class="cp">#define ZONE(sector, pd) (((sector) + (pd)-&gt;offset) &amp; ~((pd)-&gt;settings.size - 1))</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">pktcdvd_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pkt_devs</span><span class="p">[</span><span class="n">MAX_WRITERS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">pkt_proc</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pktdev_major</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">write_congestion_on</span>  <span class="o">=</span> <span class="n">PKT_WRITE_CONGESTION_ON</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">write_congestion_off</span> <span class="o">=</span> <span class="n">PKT_WRITE_CONGESTION_OFF</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mutex</span> <span class="n">ctl_mutex</span><span class="p">;</span>	<span class="cm">/* Serialize open/close/setup/teardown */</span>
<span class="k">static</span> <span class="n">mempool_t</span> <span class="o">*</span><span class="n">psd_pool</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span>	<span class="o">*</span><span class="n">class_pktcdvd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>    <span class="cm">/* /sys/class/pktcdvd */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span>	<span class="o">*</span><span class="n">pkt_debugfs_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* /sys/kernel/debug/pktcdvd */</span>

<span class="cm">/* forward declaration */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pkt_setup_dev</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dev_t</span><span class="o">*</span> <span class="n">pkt_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pkt_remove_dev</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">pkt_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pkt_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>



<span class="cm">/*</span>
<span class="cm"> * create and register a pktcdvd kernel object.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pktcdvd_kobj</span><span class="o">*</span> <span class="nf">pkt_kobj_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">kobject</span><span class="o">*</span> <span class="n">parent</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">kobj_type</span><span class="o">*</span> <span class="n">ktype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktcdvd_kobj</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">pd</span> <span class="o">=</span> <span class="n">pd</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">kobject_init_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">ktype</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_ADD</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * remove a pktcdvd kernel object.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_kobj_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_kobj</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * default release function for pktcdvd kernel objects.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_kobj_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">to_pktcdvdkobj</span><span class="p">(</span><span class="n">kobj</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/**********************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * sysfs interface for pktcdvd</span>
<span class="cm"> * by (C) 2006  Thomas Maier &lt;balagi@justmail.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> **********************************************************/</span>

<span class="cp">#define DEF_ATTR(_obj,_name,_mode) \</span>
<span class="cp">	static struct attribute _obj = { .name = _name, .mode = _mode }</span>

<span class="cm">/**********************************************************</span>
<span class="cm">  /sys/class/pktcdvd/pktcdvd[0-7]/</span>
<span class="cm">                     stat/reset</span>
<span class="cm">                     stat/packets_started</span>
<span class="cm">                     stat/packets_finished</span>
<span class="cm">                     stat/kb_written</span>
<span class="cm">                     stat/kb_read</span>
<span class="cm">                     stat/kb_read_gather</span>
<span class="cm">                     write_queue/size</span>
<span class="cm">                     write_queue/congestion_off</span>
<span class="cm">                     write_queue/congestion_on</span>
<span class="cm"> **********************************************************/</span>

<span class="n">DEF_ATTR</span><span class="p">(</span><span class="n">kobj_pkt_attr_st1</span><span class="p">,</span> <span class="s">&quot;reset&quot;</span><span class="p">,</span> <span class="mo">0200</span><span class="p">);</span>
<span class="n">DEF_ATTR</span><span class="p">(</span><span class="n">kobj_pkt_attr_st2</span><span class="p">,</span> <span class="s">&quot;packets_started&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">DEF_ATTR</span><span class="p">(</span><span class="n">kobj_pkt_attr_st3</span><span class="p">,</span> <span class="s">&quot;packets_finished&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">DEF_ATTR</span><span class="p">(</span><span class="n">kobj_pkt_attr_st4</span><span class="p">,</span> <span class="s">&quot;kb_written&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">DEF_ATTR</span><span class="p">(</span><span class="n">kobj_pkt_attr_st5</span><span class="p">,</span> <span class="s">&quot;kb_read&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">DEF_ATTR</span><span class="p">(</span><span class="n">kobj_pkt_attr_st6</span><span class="p">,</span> <span class="s">&quot;kb_read_gather&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">kobj_pkt_attrs_stat</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">kobj_pkt_attr_st1</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">kobj_pkt_attr_st2</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">kobj_pkt_attr_st3</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">kobj_pkt_attr_st4</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">kobj_pkt_attr_st5</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">kobj_pkt_attr_st6</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="n">DEF_ATTR</span><span class="p">(</span><span class="n">kobj_pkt_attr_wq1</span><span class="p">,</span> <span class="s">&quot;size&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">DEF_ATTR</span><span class="p">(</span><span class="n">kobj_pkt_attr_wq2</span><span class="p">,</span> <span class="s">&quot;congestion_off&quot;</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">DEF_ATTR</span><span class="p">(</span><span class="n">kobj_pkt_attr_wq3</span><span class="p">,</span> <span class="s">&quot;congestion_on&quot;</span><span class="p">,</span>  <span class="mo">0644</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">kobj_pkt_attrs_wqueue</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">kobj_pkt_attr_wq1</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">kobj_pkt_attr_wq2</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">kobj_pkt_attr_wq3</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">kobj_pkt_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">to_pktcdvdkobj</span><span class="p">(</span><span class="n">kobj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;packets_started&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pkt_started</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;packets_finished&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pkt_ended</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;kb_written&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">secs_w</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;kb_read&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">secs_r</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;kb_read_gather&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">secs_rg</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;size&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue_size</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;congestion_off&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_off</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;congestion_on&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_on</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_write_congestion_marks</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">lo</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">hi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">hi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">hi</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="o">*</span><span class="n">hi</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
		<span class="o">*</span><span class="n">hi</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="o">*</span><span class="n">hi</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">lo</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">lo</span> <span class="o">=</span> <span class="o">*</span><span class="n">hi</span> <span class="o">-</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">lo</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="o">*</span><span class="n">lo</span><span class="p">,</span> <span class="o">*</span><span class="n">hi</span> <span class="o">-</span> <span class="mi">100</span><span class="p">);</span>
			<span class="o">*</span><span class="n">lo</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="o">*</span><span class="n">lo</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">hi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">lo</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">kobj_pkt_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">to_pktcdvdkobj</span><span class="p">(</span><span class="n">kobj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;reset&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pkt_started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pkt_ended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">secs_w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">secs_rg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">secs_r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;congestion_off&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
		   <span class="o">&amp;&amp;</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_off</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">init_write_congestion_marks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_off</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_on</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;congestion_on&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
		   <span class="o">&amp;&amp;</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_on</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">init_write_congestion_marks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_off</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_on</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sysfs_ops</span> <span class="n">kobj_pkt_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">kobj_pkt_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">kobj_pkt_store</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="n">kobj_pkt_type_stat</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">pkt_kobj_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sysfs_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">kobj_pkt_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_attrs</span> <span class="o">=</span> <span class="n">kobj_pkt_attrs_stat</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="n">kobj_pkt_type_wqueue</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">pkt_kobj_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sysfs_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">kobj_pkt_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_attrs</span> <span class="o">=</span> <span class="n">kobj_pkt_attrs_wqueue</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_sysfs_dev_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class_pktcdvd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">class_pktcdvd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span>
					<span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">kobj_stat</span> <span class="o">=</span> <span class="n">pkt_kobj_create</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="s">&quot;stat&quot;</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">kobj_pkt_type_stat</span><span class="p">);</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">kobj_wqueue</span> <span class="o">=</span> <span class="n">pkt_kobj_create</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="s">&quot;write_queue&quot;</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">kobj_pkt_type_wqueue</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_sysfs_dev_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pkt_kobj_remove</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">kobj_stat</span><span class="p">);</span>
	<span class="n">pkt_kobj_remove</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">kobj_wqueue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class_pktcdvd</span><span class="p">)</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/********************************************************************</span>
<span class="cm">  /sys/class/pktcdvd/</span>
<span class="cm">                     add            map block device</span>
<span class="cm">                     remove         unmap packet dev</span>
<span class="cm">                     device_map     show mappings</span>
<span class="cm"> *******************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">class_pktcdvd_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">cls</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cls</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">class_pktcdvd_show_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">class_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">MAX_WRITERS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">pkt_devs</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">data</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="s">&quot;%s %u:%u %u:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">MAJOR</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pkt_dev</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pkt_dev</span><span class="p">),</span>
			<span class="n">MAJOR</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">),</span>
			<span class="n">MINOR</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">class_pktcdvd_store_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">class_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
					<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u:%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">major</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* pkt_setup_dev() expects caller to hold reference to self */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

		<span class="n">pkt_setup_dev</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">class_pktcdvd_store_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">class_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
					<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u:%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">major</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt_remove_dev</span><span class="p">(</span><span class="n">MKDEV</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class_attribute</span> <span class="n">class_pktcdvd_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
 <span class="n">__ATTR</span><span class="p">(</span><span class="n">add</span><span class="p">,</span>            <span class="mo">0200</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">class_pktcdvd_store_add</span><span class="p">),</span>
 <span class="n">__ATTR</span><span class="p">(</span><span class="n">remove</span><span class="p">,</span>         <span class="mo">0200</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">class_pktcdvd_store_remove</span><span class="p">),</span>
 <span class="n">__ATTR</span><span class="p">(</span><span class="n">device_map</span><span class="p">,</span>     <span class="mo">0444</span><span class="p">,</span> <span class="n">class_pktcdvd_show_map</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
 <span class="n">__ATTR_NULL</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_sysfs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * create control files in sysfs</span>
<span class="cm">	 * /sys/class/pktcdvd/...</span>
<span class="cm">	 */</span>
	<span class="n">class_pktcdvd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">class_pktcdvd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">class_pktcdvd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">class_pktcdvd</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">;</span>
	<span class="n">class_pktcdvd</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">class_pktcdvd</span><span class="o">-&gt;</span><span class="n">class_release</span> <span class="o">=</span> <span class="n">class_pktcdvd_release</span><span class="p">;</span>
	<span class="n">class_pktcdvd</span><span class="o">-&gt;</span><span class="n">class_attrs</span> <span class="o">=</span> <span class="n">class_pktcdvd_attrs</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">class_register</span><span class="p">(</span><span class="n">class_pktcdvd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">class_pktcdvd</span><span class="p">);</span>
		<span class="n">class_pktcdvd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: failed to create class pktcdvd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_sysfs_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class_pktcdvd</span><span class="p">)</span>
		<span class="n">class_destroy</span><span class="p">(</span><span class="n">class_pktcdvd</span><span class="p">);</span>
	<span class="n">class_pktcdvd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************************</span>
<span class="cm">  entries in debugfs</span>

<span class="cm">  /sys/kernel/debug/pktcdvd[0-7]/</span>
<span class="cm">			info</span>

<span class="cm"> *******************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_debugfs_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pkt_seq_show</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_debugfs_fops_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">pkt_debugfs_seq_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">debug_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">pkt_debugfs_fops_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_debugfs_dev_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_debugfs_root</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">dfs_f_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">dfs_d_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt_debugfs_root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">dfs_d_root</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">dfs_d_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">dfs_f_info</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;info&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">dfs_d_root</span><span class="p">,</span> <span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">dfs_f_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">dfs_f_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_debugfs_dev_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_debugfs_root</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">dfs_f_info</span><span class="p">)</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">dfs_f_info</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">dfs_f_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">dfs_d_root</span><span class="p">)</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">dfs_d_root</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">dfs_d_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_debugfs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pkt_debugfs_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pkt_debugfs_root</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pkt_debugfs_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_debugfs_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_debugfs_root</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">pkt_debugfs_root</span><span class="p">);</span>
	<span class="n">pkt_debugfs_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------*/</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_bio_finished</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pending_bios</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pending_bios</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: queue empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">attention</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">wqueue</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_bio_destructor</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="nf">pkt_bio_alloc</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr_iovecs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>

	<span class="n">bio</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_bio</span><span class="p">;</span>
	<span class="n">bio_init</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>

	<span class="n">bvl</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">nr_iovecs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio_vec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bvl</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_bvl</span><span class="p">;</span>

	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_max_vecs</span> <span class="o">=</span> <span class="n">nr_iovecs</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span> <span class="o">=</span> <span class="n">bvl</span><span class="p">;</span>
	<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_destructor</span> <span class="o">=</span> <span class="n">pkt_bio_destructor</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bio</span><span class="p">;</span>

 <span class="nl">no_bvl:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
 <span class="nl">no_bio:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate a packet_data struct</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="nf">pkt_alloc_packet_data</span><span class="p">(</span><span class="kt">int</span> <span class="n">frames</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>

	<span class="n">pkt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_pkt</span><span class="p">;</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">frames</span> <span class="o">=</span> <span class="n">frames</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span> <span class="o">=</span> <span class="n">pkt_bio_alloc</span><span class="p">(</span><span class="n">frames</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_bio</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frames</span> <span class="o">/</span> <span class="n">FRAMES_PER_PAGE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="o">|</span><span class="n">__GFP_ZERO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">no_page</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">bio_list_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">orig_bios</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frames</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">pkt_bio_alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_rd_bio</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">r_bios</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pkt</span><span class="p">;</span>

<span class="nl">no_rd_bio:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frames</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">r_bios</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="p">)</span>
			<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">no_page:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frames</span> <span class="o">/</span> <span class="n">FRAMES_PER_PAGE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">__free_page</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">bio_put</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="p">);</span>
<span class="nl">no_bio:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
<span class="nl">no_pkt:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free a packet_data struct</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_free_packet_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">r_bios</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="p">)</span>
			<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">frames</span> <span class="o">/</span> <span class="n">FRAMES_PER_PAGE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">__free_page</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">bio_put</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_shrink_pktlist</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_active_list</span><span class="p">));</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_free_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt_free_packet_data</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_free_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_grow_pktlist</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_packets</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_free_list</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">nr_packets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt</span> <span class="o">=</span> <span class="n">pkt_alloc_packet_data</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_shrink_pktlist</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">nr_packets</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pd</span> <span class="o">=</span> <span class="n">pd</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_free_list</span><span class="p">);</span>
		<span class="n">nr_packets</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">pkt_rb_node</span> <span class="o">*</span><span class="nf">pkt_rbtree_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">pkt_rb_node</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">rb_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pkt_rb_node</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_rbtree_erase</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pkt_rb_node</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rb_erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue</span><span class="p">);</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">rb_pool</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue_size</span><span class="o">--</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find the first node in the pd-&gt;bio_queue rb tree with a starting sector &gt;= s.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pkt_rb_node</span> <span class="o">*</span><span class="nf">pkt_rbtree_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pkt_rb_node</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pkt_rb_node</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">)</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">pkt_rbtree_next</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Insert a node into the pd-&gt;bio_queue rb tree.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_rbtree_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pkt_rb_node</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue</span><span class="p">.</span><span class="n">rb_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">s</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pkt_rb_node</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pkt_rb_node</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_left</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rb_right</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rb_link_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">rb_insert_color</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">rb_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue_size</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send a packet_command to the underlying block device and</span>
<span class="cm"> * wait for completion.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_generic_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rq</span> <span class="o">=</span> <span class="n">blk_get_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">==</span> <span class="n">CGC_DATA_WRITE</span><span class="p">)</span> <span class="o">?</span>
			     <span class="n">WRITE</span> <span class="o">:</span> <span class="n">READ</span><span class="p">,</span> <span class="n">__GFP_WAIT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blk_rq_map_kern</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">,</span> <span class="n">__GFP_WAIT</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">COMMAND_SIZE</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">CDROM_PACKET_SIZE</span><span class="p">);</span>

	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">60</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">quiet</span><span class="p">)</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_QUIET</span><span class="p">;</span>

	<span class="n">blk_execute_rq</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * A generic sense dump / resolve mechanism should be implemented across</span>
<span class="cm"> * all ATAPI + SCSI devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_dump_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">info</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;No sense&quot;</span><span class="p">,</span> <span class="s">&quot;Recovered error&quot;</span><span class="p">,</span> <span class="s">&quot;Not ready&quot;</span><span class="p">,</span>
				 <span class="s">&quot;Medium error&quot;</span><span class="p">,</span> <span class="s">&quot;Hardware error&quot;</span><span class="p">,</span> <span class="s">&quot;Illegal request&quot;</span><span class="p">,</span>
				 <span class="s">&quot;Unit attention&quot;</span><span class="p">,</span> <span class="s">&quot;Data protect&quot;</span><span class="p">,</span> <span class="s">&quot;Blank check&quot;</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_sense</span> <span class="o">*</span><span class="n">sense</span> <span class="o">=</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CDROM_PACKET_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; - &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;no sense</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sense %02x.%02x.%02x&quot;</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">asc</span><span class="p">,</span> <span class="n">sense</span><span class="o">-&gt;</span><span class="n">ascq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; (INVALID)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * flush the drive cache to media</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_flush_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CGC_DATA_NONE</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_FLUSH_CACHE</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * the IMMED bit -- we default to not setting it, although that</span>
<span class="cm">	 * would allow a much faster close, this is safer</span>
<span class="cm">	 */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	cgc.cmd[1] = 1 &lt;&lt; 1;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">pkt_generic_packet</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * speed is given as the normal factor, e.g. 4 for 4x</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span> <span class="nf">pkt_set_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="n">write_speed</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">read_speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_sense</span> <span class="n">sense</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CGC_DATA_NONE</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_SET_SPEED</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_speed</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_speed</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">write_speed</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">write_speed</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_generic_packet</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
		<span class="n">pkt_dump_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Queue a bio for processing by the low-level CD device. Must be called</span>
<span class="cm"> * from process context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_queue_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
		<span class="n">bio_list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">read_queue</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bio_list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">write_queue</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">attention</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">wqueue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process the queued read/write requests. This function handles special</span>
<span class="cm"> * requirements for CDRW drives:</span>
<span class="cm"> * - A cache flush command must be inserted before a read request if the</span>
<span class="cm"> *   previous request was a write.</span>
<span class="cm"> * - Switching between reading and writing is slow, so don&#39;t do it more often</span>
<span class="cm"> *   than necessary.</span>
<span class="cm"> * - Optimize for throughput at the expense of latency. This means that streaming</span>
<span class="cm"> *   writes will never be interrupted by a read, but if the drive has to seek</span>
<span class="cm"> *   before the next write, switch to reading instead if there are any pending</span>
<span class="cm"> *   read requests.</span>
<span class="cm"> * - Set the read speed according to current usage pattern. When only reading</span>
<span class="cm"> *   from the device, it&#39;s best to use the highest possible read speed, but</span>
<span class="cm"> *   when switching often between reading and writing, it&#39;s better to have the</span>
<span class="cm"> *   same read and write speeds.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_iosched_process_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">attention</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">attention</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">reads_queued</span><span class="p">,</span> <span class="n">writes_queued</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">reads_queued</span> <span class="o">=</span> <span class="o">!</span><span class="n">bio_list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">read_queue</span><span class="p">);</span>
		<span class="n">writes_queued</span> <span class="o">=</span> <span class="o">!</span><span class="n">bio_list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">write_queue</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reads_queued</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">writes_queued</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">writing</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">need_write_seek</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_list_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">write_queue</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bio</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">==</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">last_write</span><span class="p">))</span>
				<span class="n">need_write_seek</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">need_write_seek</span> <span class="o">&amp;&amp;</span> <span class="n">reads_queued</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pending_bios</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">VPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: write, waiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pkt_flush_cache</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">writing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reads_queued</span> <span class="o">&amp;&amp;</span> <span class="n">writes_queued</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pending_bios</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">VPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: read, waiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">writing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">writing</span><span class="p">)</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_list_pop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">write_queue</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bio</span> <span class="o">=</span> <span class="n">bio_list_pop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">read_queue</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">successive_reads</span> <span class="o">+=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">successive_reads</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">last_write</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">bio_sectors</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">successive_reads</span> <span class="o">&gt;=</span> <span class="n">HI_SPEED_SWITCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">read_speed</span> <span class="o">==</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_speed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">read_speed</span> <span class="o">=</span> <span class="n">MAX_SPEED</span><span class="p">;</span>
				<span class="n">pkt_set_speed</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_speed</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">read_speed</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">read_speed</span> <span class="o">!=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_speed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">read_speed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_speed</span><span class="p">;</span>
				<span class="n">pkt_set_speed</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_speed</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">read_speed</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pending_bios</span><span class="p">);</span>
		<span class="n">generic_make_request</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Special care is needed if the underlying block device has a small</span>
<span class="cm"> * max_phys_segments value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_set_segment_merging</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="n">CD_FRAMESIZE</span>
	    <span class="o">&lt;=</span> <span class="n">queue_max_segments</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The cdrom device can handle one segment/frame</span>
<span class="cm">		 */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">PACKET_MERGE_SEGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span>
		   <span class="o">&lt;=</span> <span class="n">queue_max_segments</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We can handle this case at the expense of some extra memory</span>
<span class="cm">		 * copies during write operations</span>
<span class="cm">		 */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">PACKET_MERGE_SEGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: cdrom max_phys_segments too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy CD_FRAMESIZE bytes from src_bio into a destination page</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_copy_bio_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">src_bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">dst_page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_offs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">copy_size</span> <span class="o">=</span> <span class="n">CD_FRAMESIZE</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">copy_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">src_bvl</span> <span class="o">=</span> <span class="n">bio_iovec_idx</span><span class="p">(</span><span class="n">src_bio</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">vfrom</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">src_bvl</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">src_bvl</span><span class="o">-&gt;</span><span class="n">bv_offset</span> <span class="o">+</span> <span class="n">offs</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">vto</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">dst_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">dst_offs</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">copy_size</span><span class="p">,</span> <span class="n">src_bvl</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">-</span> <span class="n">offs</span><span class="p">);</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">vto</span><span class="p">,</span> <span class="n">vfrom</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">vfrom</span><span class="p">);</span>

		<span class="n">seg</span><span class="o">++</span><span class="p">;</span>
		<span class="n">offs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dst_offs</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">copy_size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy all data for this packet to pkt-&gt;pages[], so that</span>
<span class="cm"> * a) The number of required segments for the write bio is minimized, which</span>
<span class="cm"> *    is necessary for some scsi controllers.</span>
<span class="cm"> * b) The data can be used as cache to avoid read requests if we receive a</span>
<span class="cm"> *    new write request for the same zone.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_make_local_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">f</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">offs</span><span class="p">;</span>

	<span class="cm">/* Copy all data to pkt-&gt;pages[] */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">offs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bvec</span><span class="p">[</span><span class="n">f</span><span class="p">].</span><span class="n">bv_page</span> <span class="o">!=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">p</span><span class="p">])</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">vfrom</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">bvec</span><span class="p">[</span><span class="n">f</span><span class="p">].</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">bvec</span><span class="p">[</span><span class="n">f</span><span class="p">].</span><span class="n">bv_offset</span><span class="p">;</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">vto</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">p</span><span class="p">])</span> <span class="o">+</span> <span class="n">offs</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">vto</span><span class="p">,</span> <span class="n">vfrom</span><span class="p">,</span> <span class="n">CD_FRAMESIZE</span><span class="p">);</span>
			<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">vfrom</span><span class="p">);</span>
			<span class="n">bvec</span><span class="p">[</span><span class="n">f</span><span class="p">].</span><span class="n">bv_page</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
			<span class="n">bvec</span><span class="p">[</span><span class="n">f</span><span class="p">].</span><span class="n">bv_offset</span> <span class="o">=</span> <span class="n">offs</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bvec</span><span class="p">[</span><span class="n">f</span><span class="p">].</span><span class="n">bv_offset</span> <span class="o">!=</span> <span class="n">offs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">offs</span> <span class="o">+=</span> <span class="n">CD_FRAMESIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offs</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">offs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_end_io_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="p">);</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;pkt_end_io_read: bio=%p sec0=%llx sec=%llx err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">io_errors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">io_wait</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">run_sm</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">wqueue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pkt_bio_finished</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_end_io_packet_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="p">);</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;pkt_end_io_packet_write: id=%d, err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pkt_ended</span><span class="o">++</span><span class="p">;</span>

	<span class="n">pkt_bio_finished</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">io_wait</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">run_sm</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">wqueue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Schedule reads for the holes in a packet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_gather_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">frames_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">written</span><span class="p">[</span><span class="n">PACKET_MAX_SIZE</span><span class="p">];</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bio_list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">orig_bios</span><span class="p">));</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">io_wait</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">io_errors</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Figure out which frames we need to read before we can write.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">written</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">written</span><span class="p">));</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">bio_list_for_each</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">orig_bios</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">first_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">-</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">CD_FRAMESIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">num_frames</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">/</span> <span class="n">CD_FRAMESIZE</span><span class="p">;</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">secs_w</span> <span class="o">+=</span> <span class="n">num_frames</span> <span class="o">*</span> <span class="p">(</span><span class="n">CD_FRAMESIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">first_frame</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">first_frame</span> <span class="o">+</span> <span class="n">num_frames</span> <span class="o">&gt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="n">first_frame</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">first_frame</span> <span class="o">+</span> <span class="n">num_frames</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span>
			<span class="n">written</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cache_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;pkt_gather_data: zone %llx cached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_account</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Schedule reads for missing parts of the packet.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">vec</span><span class="p">;</span>

		<span class="kt">int</span> <span class="n">p</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">written</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">r_bios</span><span class="p">[</span><span class="n">f</span><span class="p">];</span>
		<span class="n">vec</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">;</span>
		<span class="n">bio_init</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_max_vecs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+</span> <span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="n">CD_FRAMESIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">pkt_end_io_read</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span> <span class="o">=</span> <span class="n">vec</span><span class="p">;</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_destructor</span> <span class="o">=</span> <span class="n">pkt_bio_destructor</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">CD_FRAMESIZE</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">CD_FRAMESIZE</span><span class="p">)</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;pkt_gather_data: Adding frame %d, page:%p offs:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">f</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio_add_page</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">CD_FRAMESIZE</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>
			<span class="n">BUG</span><span class="p">();</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">io_wait</span><span class="p">);</span>
		<span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">READ</span><span class="p">;</span>
		<span class="n">pkt_queue_bio</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
		<span class="n">frames_read</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_account:</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;pkt_gather_data: need %d frames for zone %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">frames_read</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pkt_started</span><span class="o">++</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">secs_rg</span> <span class="o">+=</span> <span class="n">frames_read</span> <span class="o">*</span> <span class="p">(</span><span class="n">CD_FRAMESIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find a packet matching zone, or the least recently used packet if</span>
<span class="cm"> * there is no match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="nf">pkt_get_packet_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">zone</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_free_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">==</span> <span class="n">zone</span> <span class="o">||</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_free_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">!=</span> <span class="n">zone</span><span class="p">)</span>
				<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cache_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">pkt</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_put_packet_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cache_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_free_list</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_free_list</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * recover a failed write, query for relocation if possible</span>
<span class="cm"> *</span>
<span class="cm"> * returns 1 if recovery is possible, or 0 if not</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_start_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * FIXME. We need help from the file system to implement</span>
<span class="cm">	 * recovery handling.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	struct request *rq = pkt-&gt;rq;</span>
<span class="c">	struct pktcdvd_device *pd = rq-&gt;rq_disk-&gt;private_data;</span>
<span class="c">	struct block_device *pkt_bdev;</span>
<span class="c">	struct super_block *sb = NULL;</span>
<span class="c">	unsigned long old_block, new_block;</span>
<span class="c">	sector_t new_sector;</span>

<span class="c">	pkt_bdev = bdget(kdev_t_to_nr(pd-&gt;pkt_dev));</span>
<span class="c">	if (pkt_bdev) {</span>
<span class="c">		sb = get_super(pkt_bdev);</span>
<span class="c">		bdput(pkt_bdev);</span>
<span class="c">	}</span>

<span class="c">	if (!sb)</span>
<span class="c">		return 0;</span>

<span class="c">	if (!sb-&gt;s_op-&gt;relocate_blocks)</span>
<span class="c">		goto out;</span>

<span class="c">	old_block = pkt-&gt;sector / (CD_FRAMESIZE &gt;&gt; 9);</span>
<span class="c">	if (sb-&gt;s_op-&gt;relocate_blocks(sb, old_block, &amp;new_block))</span>
<span class="c">		goto out;</span>

<span class="c">	new_sector = new_block * (CD_FRAMESIZE &gt;&gt; 9);</span>
<span class="c">	pkt-&gt;sector = new_sector;</span>

<span class="c">	pkt-&gt;bio-&gt;bi_sector = new_sector;</span>
<span class="c">	pkt-&gt;bio-&gt;bi_next = NULL;</span>
<span class="c">	pkt-&gt;bio-&gt;bi_flags = 1 &lt;&lt; BIO_UPTODATE;</span>
<span class="c">	pkt-&gt;bio-&gt;bi_idx = 0;</span>

<span class="c">	BUG_ON(pkt-&gt;bio-&gt;bi_rw != REQ_WRITE);</span>
<span class="c">	BUG_ON(pkt-&gt;bio-&gt;bi_vcnt != pkt-&gt;frames);</span>
<span class="c">	BUG_ON(pkt-&gt;bio-&gt;bi_size != pkt-&gt;frames * CD_FRAMESIZE);</span>
<span class="c">	BUG_ON(pkt-&gt;bio-&gt;bi_end_io != pkt_end_io_packet_write);</span>
<span class="c">	BUG_ON(pkt-&gt;bio-&gt;bi_private != pkt);</span>

<span class="c">	drop_super(sb);</span>
<span class="c">	return 1;</span>

<span class="c">out:</span>
<span class="c">	drop_super(sb);</span>
<span class="c">	return 0;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pkt_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="k">enum</span> <span class="n">packet_data_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if PACKET_DEBUG &gt; 1</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">state_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;IDLE&quot;</span><span class="p">,</span> <span class="s">&quot;WAITING&quot;</span><span class="p">,</span> <span class="s">&quot;READ_WAIT&quot;</span><span class="p">,</span> <span class="s">&quot;WRITE_WAIT&quot;</span><span class="p">,</span> <span class="s">&quot;RECOVERY&quot;</span><span class="p">,</span> <span class="s">&quot;FINISHED&quot;</span>
	<span class="p">};</span>
	<span class="k">enum</span> <span class="n">packet_data_state</span> <span class="n">old_state</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;pkt %2d : s=%6llx %s -&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
		<span class="n">state_name</span><span class="p">[</span><span class="n">old_state</span><span class="p">],</span> <span class="n">state_name</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Scan the work queue to see if we can start a new packet.</span>
<span class="cm"> * returns non-zero if any work was done.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_handle_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">zone</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Suppress gcc warning */</span>
	<span class="k">struct</span> <span class="n">pkt_rb_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">first_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wakeup</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;handle_queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">scan_queue</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_free_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;handle_queue: no pkt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to find a zone we are not already working on.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">first_node</span> <span class="o">=</span> <span class="n">pkt_rbtree_find</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">current_sector</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
			<span class="n">first_node</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pkt_rb_node</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">first_node</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">;</span>
		<span class="n">zone</span> <span class="o">=</span> <span class="n">ZONE</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_active_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">==</span> <span class="n">zone</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">try_next_bio</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="nl">try_next_bio:</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">pkt_rbtree_next</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">rb_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
				<span class="n">node</span> <span class="o">=</span> <span class="n">rb_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pkt_rb_node</span><span class="p">,</span> <span class="n">rb_node</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">first_node</span><span class="p">)</span>
			<span class="n">node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;handle_queue: no bio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pkt</span> <span class="o">=</span> <span class="n">pkt_get_packet_data</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">zone</span><span class="p">);</span>

	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">current_sector</span> <span class="o">=</span> <span class="n">zone</span> <span class="o">+</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">zone</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">frames</span> <span class="o">!=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">write_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Scan work queue for bios in the same zone and link them</span>
<span class="cm">	 * to this packet.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;pkt_handle_queue: looking for zone %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">zone</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">node</span> <span class="o">=</span> <span class="n">pkt_rbtree_find</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">zone</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">;</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;pkt_handle_queue: found zone=%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ZONE</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span> <span class="n">pd</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ZONE</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span> <span class="n">pd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">zone</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pkt_rbtree_erase</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">bio_list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">orig_bios</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">write_size</span> <span class="o">+=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">/</span> <span class="n">CD_FRAMESIZE</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* check write congestion marks, and if bio_queue_size is</span>
<span class="cm">	   below, wake up any waiters */</span>
	<span class="n">wakeup</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_on</span> <span class="o">&gt;</span> <span class="mi">0</span>
	 		<span class="o">&amp;&amp;</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue_size</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_off</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wakeup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bdi_congested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">,</span>
					<span class="n">BLK_RW_ASYNC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sleep_time</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">PACKET_WAIT_TIME</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pkt_set_state</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">PACKET_WAITING_STATE</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">run_sm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">active_list_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_active_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">active_list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Assemble a bio to write one packet and queue the bio for processing</span>
<span class="cm"> * by the underlying block device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_start_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frames_write</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bvec</span><span class="p">[</span><span class="n">f</span><span class="p">].</span><span class="n">bv_page</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[(</span><span class="n">f</span> <span class="o">*</span> <span class="n">CD_FRAMESIZE</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">];</span>
		<span class="n">bvec</span><span class="p">[</span><span class="n">f</span><span class="p">].</span><span class="n">bv_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">CD_FRAMESIZE</span><span class="p">)</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill-in bvec with data from orig_bios.</span>
<span class="cm">	 */</span>
	<span class="n">frames_write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">bio_list_for_each</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">orig_bios</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">segment</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_idx</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">src_offs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">first_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">-</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">CD_FRAMESIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">num_frames</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">/</span> <span class="n">CD_FRAMESIZE</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">first_frame</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">first_frame</span> <span class="o">+</span> <span class="n">num_frames</span> <span class="o">&gt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="n">first_frame</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">first_frame</span> <span class="o">+</span> <span class="n">num_frames</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">src_bvl</span> <span class="o">=</span> <span class="n">bio_iovec_idx</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">segment</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">src_offs</span> <span class="o">&gt;=</span> <span class="n">src_bvl</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">src_offs</span> <span class="o">-=</span> <span class="n">src_bvl</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
				<span class="n">segment</span><span class="o">++</span><span class="p">;</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="n">segment</span> <span class="o">&gt;=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">);</span>
				<span class="n">src_bvl</span> <span class="o">=</span> <span class="n">bio_iovec_idx</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">segment</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">src_bvl</span><span class="o">-&gt;</span><span class="n">bv_len</span> <span class="o">-</span> <span class="n">src_offs</span> <span class="o">&gt;=</span> <span class="n">CD_FRAMESIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bvec</span><span class="p">[</span><span class="n">f</span><span class="p">].</span><span class="n">bv_page</span> <span class="o">=</span> <span class="n">src_bvl</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">;</span>
				<span class="n">bvec</span><span class="p">[</span><span class="n">f</span><span class="p">].</span><span class="n">bv_offset</span> <span class="o">=</span> <span class="n">src_bvl</span><span class="o">-&gt;</span><span class="n">bv_offset</span> <span class="o">+</span> <span class="n">src_offs</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pkt_copy_bio_data</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">src_offs</span><span class="p">,</span>
						  <span class="n">bvec</span><span class="p">[</span><span class="n">f</span><span class="p">].</span><span class="n">bv_page</span><span class="p">,</span> <span class="n">bvec</span><span class="p">[</span><span class="n">f</span><span class="p">].</span><span class="n">bv_offset</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">src_offs</span> <span class="o">+=</span> <span class="n">CD_FRAMESIZE</span><span class="p">;</span>
			<span class="n">frames_write</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pkt_set_state</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">PACKET_WRITE_WAIT_STATE</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;pkt_start_write: Writing %d frames for zone %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">frames_write</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">frames_write</span> <span class="o">!=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">write_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PACKET_MERGE_SEGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">write_size</span> <span class="o">&lt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pkt_make_local_copy</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">bvec</span><span class="p">);</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cache_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cache_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start the write request */</span>
	<span class="n">bio_init</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="o">-&gt;</span><span class="n">bi_max_vecs</span> <span class="o">=</span> <span class="n">PACKET_MAX_SIZE</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">pkt_end_io_packet_write</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="o">-&gt;</span><span class="n">bi_io_vec</span> <span class="o">=</span> <span class="n">bvec</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="o">-&gt;</span><span class="n">bi_destructor</span> <span class="o">=</span> <span class="n">pkt_bio_destructor</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio_add_page</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="p">,</span> <span class="n">bvec</span><span class="p">[</span><span class="n">f</span><span class="p">].</span><span class="n">bv_page</span><span class="p">,</span> <span class="n">CD_FRAMESIZE</span><span class="p">,</span> <span class="n">bvec</span><span class="p">[</span><span class="n">f</span><span class="p">].</span><span class="n">bv_offset</span><span class="p">))</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: vcnt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">io_wait</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span> <span class="o">=</span> <span class="n">WRITE</span><span class="p">;</span>
	<span class="n">pkt_queue_bio</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_finish_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">uptodate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uptodate</span><span class="p">)</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cache_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Finish all bios corresponding to this packet */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio_list_pop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">orig_bios</span><span class="p">)))</span>
		<span class="n">bio_endio</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">uptodate</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_run_state_machine</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">uptodate</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;run_state_machine: pkt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PACKET_WAITING_STATE</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">write_size</span> <span class="o">&lt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sleep_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pkt_gather_data</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
			<span class="n">pkt_set_state</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">PACKET_READ_WAIT_STATE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PACKET_READ_WAIT_STATE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">io_wait</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">io_errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pkt_set_state</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">PACKET_RECOVERY_STATE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pkt_start_write</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PACKET_WRITE_WAIT_STATE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">io_wait</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pkt_set_state</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">PACKET_FINISHED_STATE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pkt_set_state</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">PACKET_RECOVERY_STATE</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PACKET_RECOVERY_STATE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_start_recovery</span><span class="p">(</span><span class="n">pkt</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pkt_start_write</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;No recovery possible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">pkt_set_state</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">PACKET_FINISHED_STATE</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PACKET_FINISHED_STATE</span>:
			<span class="n">uptodate</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BIO_UPTODATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">w_bio</span><span class="o">-&gt;</span><span class="n">bi_flags</span><span class="p">);</span>
			<span class="n">pkt_finish_packet</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">uptodate</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_handle_packets</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;pkt_handle_packets</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Run state machine for active packets</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_active_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">run_sm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">run_sm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">pkt_run_state_machine</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Move no longer active packets to the free list</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">active_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_active_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PACKET_FINISHED_STATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">pkt_put_packet_data</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
			<span class="n">pkt_set_state</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">PACKET_IDLE_STATE</span><span class="p">);</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">scan_queue</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">active_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_count_states</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">states</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PACKET_NUM_STATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">active_list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_active_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">states</span><span class="p">[</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">active_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kcdrwd is woken up when writes have been queued for one of our</span>
<span class="cm"> * registered devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kcdrwd</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">foobar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">foobar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">min_sleep_time</span><span class="p">,</span> <span class="n">residue</span><span class="p">;</span>

	<span class="n">set_user_nice</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">set_freezable</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Wait until there is something to do</span>
<span class="cm">		 */</span>
		<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">wqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

			<span class="cm">/* Check if we need to run pkt_handle_queue */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">scan_queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">work_to_do</span><span class="p">;</span>

			<span class="cm">/* Check if we need to run the state machine for some packet */</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_active_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">run_sm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">work_to_do</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Check if we need to process the iosched queues */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">attention</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">work_to_do</span><span class="p">;</span>

			<span class="cm">/* Otherwise, go to sleep */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">PACKET_DEBUG</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">states</span><span class="p">[</span><span class="n">PACKET_NUM_STATES</span><span class="p">];</span>
				<span class="n">pkt_count_states</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">states</span><span class="p">);</span>
				<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;kcdrwd: i:%d ow:%d rw:%d ww:%d rec:%d fin:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">states</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">states</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">states</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
					<span class="n">states</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">states</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="p">}</span>

			<span class="n">min_sleep_time</span> <span class="o">=</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">;</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_active_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sleep_time</span> <span class="o">&amp;&amp;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sleep_time</span> <span class="o">&lt;</span> <span class="n">min_sleep_time</span><span class="p">)</span>
					<span class="n">min_sleep_time</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sleep_time</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;kcdrwd: sleeping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">residue</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="n">min_sleep_time</span><span class="p">);</span>
			<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;kcdrwd: wake up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* make swsusp happy with our thread */</span>
			<span class="n">try_to_freeze</span><span class="p">();</span>

			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_active_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sleep_time</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sleep_time</span> <span class="o">-=</span> <span class="n">min_sleep_time</span> <span class="o">-</span> <span class="n">residue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sleep_time</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">run_sm</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">work_to_do:</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
		<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">wqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * if pkt_handle_queue returns true, we can queue</span>
<span class="cm">		 * another request.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pkt_handle_queue</span><span class="p">(</span><span class="n">pd</span><span class="p">))</span>
			<span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Handle packet state machine</span>
<span class="cm">		 */</span>
		<span class="n">pkt_handle_packets</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Handle iosched queues</span>
<span class="cm">		 */</span>
		<span class="n">pkt_iosched_process_queue</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_print_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: %s packets, &quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">fp</span> <span class="o">?</span> <span class="s">&quot;Fixed&quot;</span> <span class="o">:</span> <span class="s">&quot;Variable&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%u blocks, &quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Mode-%c disc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">block_mode</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;2&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_mode_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page_code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page_control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_MODE_SENSE_10</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_code</span> <span class="o">|</span> <span class="p">(</span><span class="n">page_control</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">CGC_DATA_READ</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pkt_generic_packet</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_mode_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_MODE_SELECT_10</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>		<span class="cm">/* PF */</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">CGC_DATA_WRITE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pkt_generic_packet</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_get_disc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="n">disc_information</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set up command and get the disc info */</span>
	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">di</span><span class="p">),</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_DISC_INFO</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_generic_packet</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* not all drives have the same disc_info length, so requeue</span>
<span class="cm">	 * packet with the length the drive tells us it can supply</span>
<span class="cm">	 */</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">disc_information_length</span><span class="p">)</span> <span class="o">+</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">disc_information_length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disc_information</span><span class="p">))</span>
		<span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disc_information</span><span class="p">);</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pkt_generic_packet</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_get_track_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">track</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">track_information</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_TRACK_RZONE_INFO</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">track</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">track</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_generic_packet</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">track_information_length</span><span class="p">)</span> <span class="o">+</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">track_information_length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">track_information</span><span class="p">))</span>
		<span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">track_information</span><span class="p">);</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pkt_generic_packet</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span> <span class="nf">pkt_get_last_written</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
						<span class="kt">long</span> <span class="o">*</span><span class="n">last_written</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disc_information</span> <span class="n">di</span><span class="p">;</span>
	<span class="n">track_information</span> <span class="n">ti</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">last_track</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_get_disc_info</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">last_track</span> <span class="o">=</span> <span class="p">(</span><span class="n">di</span><span class="p">.</span><span class="n">last_track_msb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">di</span><span class="p">.</span><span class="n">last_track_lsb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_get_track_info</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">last_track</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* if this track is blank, try the previous. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">last_track</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_get_track_info</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">last_track</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if last recorded field is valid, return it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">lra_v</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">last_written</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">last_rec_address</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* make it up instead */</span>
		<span class="o">*</span><span class="n">last_written</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">track_start</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">track_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">free_blocks</span><span class="p">)</span>
			<span class="o">*</span><span class="n">last_written</span> <span class="o">-=</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">free_blocks</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write mode select package based on pd-&gt;settings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span> <span class="nf">pkt_set_write_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_sense</span> <span class="n">sense</span><span class="p">;</span>
	<span class="n">write_param_page</span> <span class="o">*</span><span class="n">wp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* doesn&#39;t apply to DVD+RW or DVD-RAM */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">mmc3_profile</span> <span class="o">==</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">mmc3_profile</span> <span class="o">==</span> <span class="mh">0x12</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wp</span><span class="p">),</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sense</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_mode_sense</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">GPMODE_WRITE_PARMS_PAGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pkt_dump_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">mode_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * now get it all</span>
<span class="cm">	 */</span>
	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sense</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_mode_sense</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">GPMODE_WRITE_PARMS_PAGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pkt_dump_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * write page is offset header + block descriptor length</span>
<span class="cm">	 */</span>
	<span class="n">wp</span> <span class="o">=</span> <span class="p">(</span><span class="n">write_param_page</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mode_page_header</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">mode_offset</span><span class="p">];</span>

	<span class="n">wp</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">fp</span><span class="p">;</span>
	<span class="n">wp</span><span class="o">-&gt;</span><span class="n">track_mode</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">track_mode</span><span class="p">;</span>
	<span class="n">wp</span><span class="o">-&gt;</span><span class="n">write_type</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">write_type</span><span class="p">;</span>
	<span class="n">wp</span><span class="o">-&gt;</span><span class="n">data_block_type</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">block_mode</span><span class="p">;</span>

	<span class="n">wp</span><span class="o">-&gt;</span><span class="n">multi_session</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef PACKET_USE_LS</span>
	<span class="n">wp</span><span class="o">-&gt;</span><span class="n">link_size</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">wp</span><span class="o">-&gt;</span><span class="n">ls_v</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">data_block_type</span> <span class="o">==</span> <span class="n">PACKET_BLOCK_MODE1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wp</span><span class="o">-&gt;</span><span class="n">session_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wp</span><span class="o">-&gt;</span><span class="n">subhdr2</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">data_block_type</span> <span class="o">==</span> <span class="n">PACKET_BLOCK_MODE2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wp</span><span class="o">-&gt;</span><span class="n">session_format</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">wp</span><span class="o">-&gt;</span><span class="n">subhdr2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		wp-&gt;mcn[0] = 0x80;</span>
<span class="c">		memcpy(&amp;wp-&gt;mcn[1], PACKET_MCN, sizeof(wp-&gt;mcn) - 1);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * paranoia</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: write mode wrong %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wp</span><span class="o">-&gt;</span><span class="n">data_block_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wp</span><span class="o">-&gt;</span><span class="n">packet_size</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_mode_select</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pkt_dump_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pkt_print_settings</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * 1 -- we can write to this track, 0 -- we can&#39;t</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_writable_track</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="n">track_information</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">mmc3_profile</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x1a</span>: <span class="cm">/* DVD+RW */</span>
		<span class="k">case</span> <span class="mh">0x12</span>: <span class="cm">/* DVD-RAM */</span>
			<span class="cm">/* The track is always writable on DVD+RW/DVD-RAM */</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">packet</span> <span class="o">||</span> <span class="o">!</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * &quot;good&quot; settings as per Mt Fuji.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">rt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">blank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">rt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">blank</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">rt</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">blank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: bad state %d-%d-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">rt</span><span class="p">,</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">blank</span><span class="p">,</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * 1 -- we can write to this disc, 0 -- we can&#39;t</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_writable_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="n">disc_information</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">mmc3_profile</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x0a</span>: <span class="cm">/* CD-RW */</span>
		<span class="k">case</span> <span class="mh">0xffff</span>: <span class="cm">/* MMC3 not supported */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1a</span>: <span class="cm">/* DVD+RW */</span>
		<span class="k">case</span> <span class="mh">0x13</span>: <span class="cm">/* DVD-RW */</span>
		<span class="k">case</span> <span class="mh">0x12</span>: <span class="cm">/* DVD-RAM */</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">VPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: Wrong disc profile (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">mmc3_profile</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * for disc type 0xff we should probably reserve a new track.</span>
<span class="cm">	 * but i&#39;m not sure, should we leave this to user apps? probably.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">disc_type</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: Unknown disc. No track?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">disc_type</span> <span class="o">!=</span> <span class="mh">0x20</span> <span class="o">&amp;&amp;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">disc_type</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: Wrong disc type (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">disc_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">erasable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: Disc not erasable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">border_status</span> <span class="o">==</span> <span class="n">PACKET_SESSION_RESERVED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: Can&#39;t write to last track (reserved)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span> <span class="nf">pkt_probe_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">disc_information</span> <span class="n">di</span><span class="p">;</span>
	<span class="n">track_information</span> <span class="n">ti</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">track</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_GET_CONFIGURATION</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_generic_packet</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">mmc3_profile</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">?</span> <span class="mh">0xffff</span> <span class="o">:</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disc_information</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ti</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">track_information</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_get_disc_info</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;failed get_disc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_writable_disc</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>

	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">di</span><span class="p">.</span><span class="n">erasable</span> <span class="o">?</span> <span class="n">PACKET_CDRW</span> <span class="o">:</span> <span class="n">PACKET_CDR</span><span class="p">;</span>

	<span class="n">track</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* (di.last_track_msb &lt;&lt; 8) | di.last_track_lsb; */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_get_track_info</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">track</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: failed get_track</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_writable_track</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: can&#39;t write to this track</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * we keep packet size in 512 byte units, makes it easier to</span>
<span class="cm">	 * deal with request calculations.</span>
<span class="cm">	 */</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">fixed_packet_size</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: detected zero packet size!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">PACKET_MAX_SECTORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: packet size is too big</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">ti</span><span class="p">.</span><span class="n">fp</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">track_start</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">nwa_v</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">nwa</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">next_writable</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">PACKET_NWA_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * in theory we could use lra on -RW media as well and just zero</span>
<span class="cm">	 * blocks that haven&#39;t been written yet, but in practice that</span>
<span class="cm">	 * is just a no-go. we&#39;ll use that for -R, naturally.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">lra_v</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">lra</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">last_rec_address</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">PACKET_LRA_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">lra</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">PACKET_LRA_VALID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * fine for now</span>
<span class="cm">	 */</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">link_loss</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">write_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* packet */</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">track_mode</span> <span class="o">=</span> <span class="n">ti</span><span class="p">.</span><span class="n">track_mode</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * mode1 or mode2 disc</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">data_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PACKET_MODE1</span>:
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">block_mode</span> <span class="o">=</span> <span class="n">PACKET_BLOCK_MODE1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PACKET_MODE2</span>:
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">block_mode</span> <span class="o">=</span> <span class="n">PACKET_BLOCK_MODE2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: unknown data mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * enable/disable write caching on drive</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span> <span class="nf">pkt_write_caching</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_sense</span> <span class="n">sense</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">mode_offset</span> <span class="o">+</span> <span class="mi">12</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * caching mode page might not be there, so quiet this command</span>
<span class="cm">	 */</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_mode_sense</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">GPMODE_WCACHING_PAGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">mode_offset</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="o">!!</span><span class="n">set</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_mode_select</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: write caching control failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pkt_dump_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">set</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: enabled write caching on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_lock_door</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lockflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CGC_DATA_NONE</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_PREVENT_ALLOW_MEDIUM_REMOVAL</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lockflag</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pkt_generic_packet</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns drive maximum write speed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span> <span class="nf">pkt_get_max_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="o">*</span><span class="n">write_speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_sense</span> <span class="n">sense</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="o">+</span><span class="mi">18</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cap_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">cap_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mode_page_header</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">mode_offset</span><span class="p">];</span>
	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">CGC_DATA_UNKNOWN</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sense</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_mode_sense</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">GPMODE_CAPABILITIES_PAGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">mode_offset</span> <span class="o">+</span> <span class="n">cap_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mode_page_header</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_mode_sense</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">GPMODE_CAPABILITIES_PAGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkt_dump_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>			    <span class="cm">/* Obsoleted field, used by older drives */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">28</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">28</span><span class="p">;</span>		    <span class="cm">/* Current write speed selected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If the drive reports at least one &quot;Logical Unit Write</span>
<span class="cm">		 * Speed Performance Descriptor Block&quot;, use the information</span>
<span class="cm">		 * in the first block. (contains the highest speed)</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">num_spdb</span> <span class="o">=</span> <span class="p">(</span><span class="n">cap_buf</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">cap_buf</span><span class="p">[</span><span class="mi">31</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_spdb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="mi">34</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">write_speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">cap_buf</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">cap_buf</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* These tables from cdrecord - I don&#39;t have orange book */</span>
<span class="cm">/* standard speed CD-RW (1-4x) */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">clv_to_speed</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 */</span>
	   <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>
<span class="cm">/* high speed CD-RW (-10x) */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">hs_clv_to_speed</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 */</span>
	   <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>
<span class="cm">/* ultra high speed CD-RW */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">us_clv_to_speed</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 */</span>
	   <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * reads the maximum media speed from ATIP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span> <span class="nf">pkt_media_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="o">*</span><span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_sense</span> <span class="n">sense</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">sp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_TOC_PMA_ATIP</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* READ ATIP */</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_generic_packet</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt_dump_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_TOC_PMA_ATIP</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_generic_packet</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt_dump_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: Disc type is not CD-RW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: A1 values on media are not valid, maybe not CDRW?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">st</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span> <span class="cm">/* disc sub-type */</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span> <span class="cm">/* max speed from ATIP A1 field */</span>

	<span class="cm">/* Info from cdrecord */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* standard speed */</span>
			<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">clv_to_speed</span><span class="p">[</span><span class="n">sp</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* high speed */</span>
			<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">hs_clv_to_speed</span><span class="p">[</span><span class="n">sp</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* ultra high speed */</span>
			<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">us_clv_to_speed</span><span class="p">[</span><span class="n">sp</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: Unknown disc sub-type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">st</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: Max. media speed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">speed</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: Unknown speed %d for sub-type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="n">st</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline_for_stack</span> <span class="kt">int</span> <span class="nf">pkt_perform_opc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_sense</span> <span class="n">sense</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: Performing OPC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CGC_DATA_NONE</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">60</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_SEND_OPC</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_generic_packet</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
		<span class="n">pkt_dump_sense</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_open_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">write_speed</span><span class="p">,</span> <span class="n">media_write_speed</span><span class="p">,</span> <span class="n">read_speed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_probe_settings</span><span class="p">(</span><span class="n">pd</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: %s failed probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_set_write_settings</span><span class="p">(</span><span class="n">pd</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: %s failed saving write settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pkt_write_caching</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">USE_WCACHING</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_get_max_speed</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">write_speed</span><span class="p">)))</span>
		<span class="n">write_speed</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">177</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">mmc3_profile</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x13</span>: <span class="cm">/* DVD-RW */</span>
		<span class="k">case</span> <span class="mh">0x1a</span>: <span class="cm">/* DVD+RW */</span>
		<span class="k">case</span> <span class="mh">0x12</span>: <span class="cm">/* DVD-RAM */</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: write speed %ukB/s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">write_speed</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_media_speed</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">media_write_speed</span><span class="p">)))</span>
				<span class="n">media_write_speed</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">write_speed</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">write_speed</span><span class="p">,</span> <span class="n">media_write_speed</span> <span class="o">*</span> <span class="mi">177</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: write speed %ux</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">write_speed</span> <span class="o">/</span> <span class="mi">176</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_speed</span> <span class="o">=</span> <span class="n">write_speed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_set_speed</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">write_speed</span><span class="p">,</span> <span class="n">read_speed</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: %s couldn&#39;t set write speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_speed</span> <span class="o">=</span> <span class="n">write_speed</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">read_speed</span> <span class="o">=</span> <span class="n">read_speed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_perform_opc</span><span class="p">(</span><span class="n">pd</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: %s Optimum Power Calibration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called at open time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_open_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">lba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to re-open the cdrom device without O_NONBLOCK to be able</span>
<span class="cm">	 * to read/write from/to it. It is already opened in O_NONBLOCK mode</span>
<span class="cm">	 * so bdget() can&#39;t fail.</span>
<span class="cm">	 */</span>
	<span class="n">bdget</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">blkdev_get</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_EXCL</span><span class="p">,</span> <span class="n">pd</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_get_last_written</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lba</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: pkt_get_last_written failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_putdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_capacity</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">,</span> <span class="n">lba</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">set_capacity</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">,</span> <span class="n">lba</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">bd_set_size</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">lba</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_open_write</span><span class="p">(</span><span class="n">pd</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out_putdev</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Some CDRW drives can not handle writes larger than one packet,</span>
<span class="cm">		 * even if the size is a multiple of the packet size.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
		<span class="n">blk_queue_max_hw_sectors</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">PACKET_WRITABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pkt_set_speed</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">MAX_SPEED</span><span class="p">,</span> <span class="n">MAX_SPEED</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">PACKET_WRITABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_set_segment_merging</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">q</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_putdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_grow_pktlist</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">CONFIG_CDROM_PKTCDVD_BUFFERS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: not enough memory for buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_putdev</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: %lukB available on disc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lba</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_putdev:</span>
	<span class="n">blkdev_put</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_EXCL</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called when the device is closed. makes sure that the device flushes</span>
<span class="cm"> * the internal cache before we close.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_release_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flush</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flush</span> <span class="o">&amp;&amp;</span> <span class="n">pkt_flush_cache</span><span class="p">(</span><span class="n">pd</span><span class="p">))</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: %s not flushing cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">pkt_lock_door</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pkt_set_speed</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">MAX_SPEED</span><span class="p">,</span> <span class="n">MAX_SPEED</span><span class="p">);</span>
	<span class="n">blkdev_put</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_EXCL</span><span class="p">);</span>

	<span class="n">pkt_shrink_pktlist</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="nf">pkt_find_dev_from_minor</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_minor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_minor</span> <span class="o">&gt;=</span> <span class="n">MAX_WRITERS</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pkt_devs</span><span class="p">[</span><span class="n">dev_minor</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: entering open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktcdvd_mutex</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
	<span class="n">pd</span> <span class="o">=</span> <span class="n">pkt_find_dev_from_minor</span><span class="p">(</span><span class="n">MINOR</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">refcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">refcnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PACKET_WRITABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_dec</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_open_dev</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_dec</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * needed here as well, since ext2 (among others) may change</span>
<span class="cm">		 * the blocksize at mount time</span>
<span class="cm">		 */</span>
		<span class="n">set_blocksize</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">CD_FRAMESIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktcdvd_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_dec:</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="o">--</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: failed open (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktcdvd_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktcdvd_mutex</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">refcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">refcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">flush</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">PACKET_WRITABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">pkt_release_dev</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">flush</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktcdvd_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_end_io_read_cloned</span><span class="p">(</span><span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_stacked_data</span> <span class="o">*</span><span class="n">psd</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">psd</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">;</span>

	<span class="n">bio_put</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="n">bio_endio</span><span class="p">(</span><span class="n">psd</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">psd</span><span class="p">,</span> <span class="n">psd_pool</span><span class="p">);</span>
	<span class="n">pkt_bio_finished</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_make_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="n">sector_t</span> <span class="n">zone</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_data</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">was_empty</span><span class="p">,</span> <span class="n">blocked_bio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pkt_rb_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="n">pd</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: %s incorrect request queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bdevname</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">end_io</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clone READ bios so we can have our own bi_end_io callback.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">cloned_bio</span> <span class="o">=</span> <span class="n">bio_clone</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">packet_stacked_data</span> <span class="o">*</span><span class="n">psd</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">psd_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>

		<span class="n">psd</span><span class="o">-&gt;</span><span class="n">pd</span> <span class="o">=</span> <span class="n">pd</span><span class="p">;</span>
		<span class="n">psd</span><span class="o">-&gt;</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
		<span class="n">cloned_bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">;</span>
		<span class="n">cloned_bio</span><span class="o">-&gt;</span><span class="n">bi_private</span> <span class="o">=</span> <span class="n">psd</span><span class="p">;</span>
		<span class="n">cloned_bio</span><span class="o">-&gt;</span><span class="n">bi_end_io</span> <span class="o">=</span> <span class="n">pkt_end_io_read_cloned</span><span class="p">;</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">secs_r</span> <span class="o">+=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">pkt_queue_bio</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">cloned_bio</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">PACKET_WRITABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: WRITE for ro device %s (%llu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">end_io</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">||</span> <span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">%</span> <span class="n">CD_FRAMESIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: wrong bio size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">end_io</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">blk_queue_bounce</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bio</span><span class="p">);</span>

	<span class="n">zone</span> <span class="o">=</span> <span class="n">ZONE</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;pkt_make_request: start = %6llx stop = %6llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">bio_sectors</span><span class="p">(</span><span class="n">bio</span><span class="p">)));</span>

	<span class="cm">/* Check if we have to split the bio */</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">bio_pair</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
		<span class="n">sector_t</span> <span class="n">last_zone</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">first_sectors</span><span class="p">;</span>

		<span class="n">last_zone</span> <span class="o">=</span> <span class="n">ZONE</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">+</span> <span class="n">bio_sectors</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_zone</span> <span class="o">!=</span> <span class="n">zone</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">last_zone</span> <span class="o">!=</span> <span class="n">zone</span> <span class="o">+</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
			<span class="n">first_sectors</span> <span class="o">=</span> <span class="n">last_zone</span> <span class="o">-</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">;</span>
			<span class="n">bp</span> <span class="o">=</span> <span class="n">bio_split</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">first_sectors</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="p">);</span>
			<span class="n">pkt_make_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">bio1</span><span class="p">);</span>
			<span class="n">pkt_make_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">bio2</span><span class="p">);</span>
			<span class="n">bio_pair_release</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we find a matching packet in state WAITING or READ_WAIT, we can</span>
<span class="cm">	 * just append this bio to that packet.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">active_list_lock</span><span class="p">);</span>
	<span class="n">blocked_bio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_active_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">==</span> <span class="n">zone</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PACKET_WAITING_STATE</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PACKET_READ_WAIT_STATE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bio_list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">orig_bios</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
				<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">write_size</span> <span class="o">+=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">/</span> <span class="n">CD_FRAMESIZE</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">write_size</span> <span class="o">&gt;=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PACKET_WAITING_STATE</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">run_sm</span><span class="p">);</span>
					<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">wqueue</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">active_list_lock</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">blocked_bio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">active_list_lock</span><span class="p">);</span>

 	<span class="cm">/*</span>
<span class="cm">	 * Test if there is enough room left in the bio work queue</span>
<span class="cm">	 * (queue size &gt;= congestion on mark).</span>
<span class="cm">	 * If not, wait till the work queue size is below the congestion off mark.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_on</span> <span class="o">&gt;</span> <span class="mi">0</span>
	    <span class="o">&amp;&amp;</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue_size</span> <span class="o">&gt;=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bdi_congested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">backing_dev_info</span><span class="p">,</span> <span class="n">BLK_RW_ASYNC</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">congestion_wait</span><span class="p">(</span><span class="n">BLK_RW_ASYNC</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue_size</span> <span class="o">&gt;</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_off</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * No matching packet found. Store the bio in the work queue.</span>
<span class="cm">	 */</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rb_pool</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="n">node</span><span class="o">-&gt;</span><span class="n">bio</span> <span class="o">=</span> <span class="n">bio</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">was_empty</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pkt_rbtree_insert</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wake up the worker thread.</span>
<span class="cm">	 */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">scan_queue</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">was_empty</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This wake_up is required for correct operation */</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">wqueue</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_free_list</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">blocked_bio</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This wake up is not required for correct operation,</span>
<span class="cm">		 * but improves performance in some cases.</span>
<span class="cm">		 */</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">wqueue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">end_io:</span>
	<span class="n">bio_io_error</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_merge_bvec</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bvec_merge_data</span> <span class="o">*</span><span class="n">bmd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bvec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">zone</span> <span class="o">=</span> <span class="n">ZONE</span><span class="p">(</span><span class="n">bmd</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">used</span> <span class="o">=</span> <span class="p">((</span><span class="n">bmd</span><span class="o">-&gt;</span><span class="n">bi_sector</span> <span class="o">-</span> <span class="n">zone</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">+</span> <span class="n">bmd</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">remaining</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="n">used</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">remaining2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * A bio &lt;= PAGE_SIZE must be allowed. If it crosses a packet</span>
<span class="cm">	 * boundary, pkt_make_request() will split the bio.</span>
<span class="cm">	 */</span>
	<span class="n">remaining2</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">bmd</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="p">;</span>
	<span class="n">remaining</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="n">remaining2</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">remaining</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_init_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>

	<span class="n">blk_queue_make_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">pkt_make_request</span><span class="p">);</span>
	<span class="n">blk_queue_logical_block_size</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">CD_FRAMESIZE</span><span class="p">);</span>
	<span class="n">blk_queue_max_hw_sectors</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">PACKET_MAX_SECTORS</span><span class="p">);</span>
	<span class="n">blk_queue_merge_bvec</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">pkt_merge_bvec</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span> <span class="o">=</span> <span class="n">pd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">bdev_buf</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">states</span><span class="p">[</span><span class="n">PACKET_NUM_STATES</span><span class="p">];</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Writer %s mapped to %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		   <span class="n">bdevname</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">bdev_buf</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Settings:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">packet size:</span><span class="se">\t\t</span><span class="s">%dkB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">write_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Packet&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">write type:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">packet type:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">fp</span> <span class="o">?</span> <span class="s">&quot;Fixed&quot;</span> <span class="o">:</span> <span class="s">&quot;Variable&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">link loss:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">link_loss</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">track mode:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">track_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">block_mode</span> <span class="o">==</span> <span class="n">PACKET_BLOCK_MODE1</span><span class="p">)</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Mode 1&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">.</span><span class="n">block_mode</span> <span class="o">==</span> <span class="n">PACKET_BLOCK_MODE2</span><span class="p">)</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Mode 2&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">block mode:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Statistics:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">packets started:</span><span class="se">\t</span><span class="s">%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pkt_started</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">packets ended:</span><span class="se">\t\t</span><span class="s">%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pkt_ended</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">written:</span><span class="se">\t\t</span><span class="s">%lukB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">secs_w</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">read gather:</span><span class="se">\t\t</span><span class="s">%lukB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">secs_rg</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">read:</span><span class="se">\t\t\t</span><span class="s">%lukB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">secs_r</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Misc:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">reference count:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">flags:</span><span class="se">\t\t\t</span><span class="s">0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">read speed:</span><span class="se">\t\t</span><span class="s">%ukB/s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">read_speed</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">write speed:</span><span class="se">\t\t</span><span class="s">%ukB/s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_speed</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">start offset:</span><span class="se">\t\t</span><span class="s">%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">mode page offset:</span><span class="se">\t</span><span class="s">%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">mode_offset</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Queue state:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">bios queued:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue_size</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">bios pending:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pending_bios</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">current sector:</span><span class="se">\t\t</span><span class="s">0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">current_sector</span><span class="p">);</span>

	<span class="n">pkt_count_states</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">states</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">state:</span><span class="se">\t\t\t</span><span class="s">i:%d ow:%d rw:%d ww:%d rec:%d fin:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">states</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">states</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">states</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">states</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">states</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">write congestion marks:</span><span class="se">\t</span><span class="s">off=%d on=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_off</span><span class="p">,</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_on</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">pkt_seq_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">pkt_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>	<span class="o">=</span> <span class="n">pkt_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>	<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_new_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pkt_dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: Recursive setup not allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_WRITERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd2</span> <span class="o">=</span> <span class="n">pkt_devs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd2</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd2</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: %s already setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bdevname</span><span class="p">(</span><span class="n">pd2</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd2</span><span class="o">-&gt;</span><span class="n">pkt_dev</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: Can&#39;t chain pktcdvd devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bdev</span> <span class="o">=</span> <span class="n">bdget</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">blkdev_get</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_NDELAY</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* This is safe, since we have a reference from open(). */</span>
	<span class="n">__module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>

	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span> <span class="o">=</span> <span class="n">bdev</span><span class="p">;</span>
	<span class="n">set_blocksize</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">CD_FRAMESIZE</span><span class="p">);</span>

	<span class="n">pkt_init_queue</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pending_bios</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">kcdrwd</span><span class="p">,</span> <span class="n">pd</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="kr">thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: can&#39;t start kernel thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">proc_create_data</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pkt_proc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt_proc_fops</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: writer %s mapped to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bdevname</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_mem:</span>
	<span class="n">blkdev_put</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_NDELAY</span><span class="p">);</span>
	<span class="cm">/* This is safe: open() is still holding a reference. */</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;pkt_ioctl: cmd %x, dev %d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
		<span class="n">MAJOR</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktcdvd_mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CDROMEJECT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * The door gets locked when the device is opened, so we</span>
<span class="cm">		 * have to unlock it or else the eject command fails.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">refcnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">pkt_lock_door</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* fallthru */</span>
	<span class="cm">/*</span>
<span class="cm">	 * forward selected CDROM ioctls to CD-ROM, for UDF</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">CDROMMULTISESSION</span>:
	<span class="k">case</span> <span class="n">CDROMREADTOCENTRY</span>:
	<span class="k">case</span> <span class="n">CDROM_LAST_WRITTEN</span>:
	<span class="k">case</span> <span class="n">CDROM_SEND_PACKET</span>:
	<span class="k">case</span> <span class="n">SCSI_IOCTL_SEND_COMMAND</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__blkdev_driver_ioctl</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: Unknown ioctl for %s (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pktcdvd_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pkt_check_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clearing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">attached_disk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">attached_disk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attached_disk</span> <span class="o">||</span> <span class="o">!</span><span class="n">attached_disk</span><span class="o">-&gt;</span><span class="n">fops</span><span class="o">-&gt;</span><span class="n">check_events</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">attached_disk</span><span class="o">-&gt;</span><span class="n">fops</span><span class="o">-&gt;</span><span class="n">check_events</span><span class="p">(</span><span class="n">attached_disk</span><span class="p">,</span> <span class="n">clearing</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">pktcdvd_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>		<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">pkt_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>		<span class="n">pkt_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">pkt_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_events</span> <span class="o">=</span>		<span class="n">pkt_check_events</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pktcdvd_devnode</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">gd</span><span class="p">,</span> <span class="n">umode_t</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kasprintf</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="s">&quot;pktcdvd/%s&quot;</span><span class="p">,</span> <span class="n">gd</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up mapping from pktcdvd device to CD-ROM device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_setup_dev</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dev_t</span><span class="o">*</span> <span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">MAX_WRITERS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt_devs</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">MAX_WRITERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: max %d writers supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MAX_WRITERS</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mutex</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pktcdvd_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_mutex</span><span class="p">;</span>

	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">rb_pool</span> <span class="o">=</span> <span class="n">mempool_create_kmalloc_pool</span><span class="p">(</span><span class="n">PKT_RB_POOL_SIZE</span><span class="p">,</span>
						  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pkt_rb_node</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rb_pool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_mem</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_free_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">pkt_active_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="n">active_list_lock</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">bio_list_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">read_queue</span><span class="p">);</span>
	<span class="n">bio_list_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">iosched</span><span class="p">.</span><span class="n">write_queue</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">wqueue</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">bio_queue</span> <span class="o">=</span> <span class="n">RB_ROOT</span><span class="p">;</span>

	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_on</span>  <span class="o">=</span> <span class="n">write_congestion_on</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">write_congestion_off</span> <span class="o">=</span> <span class="n">write_congestion_off</span><span class="p">;</span>

	<span class="n">disk</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_mem</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">disk</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">pktdev_major</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pktcdvd_ops</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GENHD_FL_REMOVABLE</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">devnode</span> <span class="o">=</span> <span class="n">pktcdvd_devnode</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">blk_alloc_queue</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_mem2</span><span class="p">;</span>

	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pkt_dev</span> <span class="o">=</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">pktdev_major</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_new_dev</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_new_dev</span><span class="p">;</span>

	<span class="cm">/* inherit events of the host device */</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">async_events</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">async_events</span><span class="p">;</span>

	<span class="n">add_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>

	<span class="n">pkt_sysfs_dev_new</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="n">pkt_debugfs_dev_new</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>

	<span class="n">pkt_devs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_dev</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pkt_dev</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pkt_dev</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_new_dev:</span>
	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
<span class="nl">out_mem2:</span>
	<span class="n">put_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
<span class="nl">out_mem:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rb_pool</span><span class="p">)</span>
		<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rb_pool</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
<span class="nl">out_mutex:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: setup of pktcdvd device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Tear down mapping from pktcdvd device to CD-ROM device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pkt_remove_dev</span><span class="p">(</span><span class="n">dev_t</span> <span class="n">pkt_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">MAX_WRITERS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pd</span> <span class="o">=</span> <span class="n">pkt_devs</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pkt_dev</span> <span class="o">==</span> <span class="n">pkt_dev</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">MAX_WRITERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: dev not setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">refcnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="kr">thread</span><span class="p">))</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">cdrw</span><span class="p">.</span><span class="kr">thread</span><span class="p">);</span>

	<span class="n">pkt_devs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pkt_debugfs_dev_remove</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="n">pkt_sysfs_dev_remove</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>

	<span class="n">blkdev_put</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_NDELAY</span><span class="p">);</span>

	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt_proc</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: writer %s unmapped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">del_gendisk</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">);</span>
	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">put_disk</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">);</span>

	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rb_pool</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>

	<span class="cm">/* This is safe: open() is still holding a reference. */</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pkt_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">pkt_ctrl_command</span> <span class="o">*</span><span class="n">ctrl_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pktcdvd_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>

	<span class="n">mutex_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>

	<span class="n">pd</span> <span class="o">=</span> <span class="n">pkt_find_dev_from_minor</span><span class="p">(</span><span class="n">ctrl_cmd</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl_cmd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">new_encode_dev</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">);</span>
		<span class="n">ctrl_cmd</span><span class="o">-&gt;</span><span class="n">pkt_dev</span> <span class="o">=</span> <span class="n">new_encode_dev</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pkt_dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ctrl_cmd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctrl_cmd</span><span class="o">-&gt;</span><span class="n">pkt_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ctrl_cmd</span><span class="o">-&gt;</span><span class="n">num_devices</span> <span class="o">=</span> <span class="n">MAX_WRITERS</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">pkt_ctl_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pkt_ctrl_command</span> <span class="n">ctrl_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_t</span> <span class="n">pkt_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">PACKET_CTRL_CMD</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl_cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pkt_ctrl_command</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl_cmd</span><span class="p">.</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PKT_CTRL_CMD_SETUP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_setup_dev</span><span class="p">(</span><span class="n">new_decode_dev</span><span class="p">(</span><span class="n">ctrl_cmd</span><span class="p">.</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pkt_dev</span><span class="p">);</span>
		<span class="n">ctrl_cmd</span><span class="p">.</span><span class="n">pkt_dev</span> <span class="o">=</span> <span class="n">new_encode_dev</span><span class="p">(</span><span class="n">pkt_dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PKT_CTRL_CMD_TEARDOWN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_remove_dev</span><span class="p">(</span><span class="n">new_decode_dev</span><span class="p">(</span><span class="n">ctrl_cmd</span><span class="p">.</span><span class="n">pkt_dev</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PKT_CTRL_CMD_STATUS</span>:
		<span class="n">pkt_get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl_cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl_cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pkt_ctrl_command</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">pkt_ctl_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pkt_ctl_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">pkt_ctl_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">nonseekable_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">pkt_ctl_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span>	<span class="o">=</span> <span class="n">pkt_ctl_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">pkt_misc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">minor</span> 		<span class="o">=</span> <span class="n">MISC_DYNAMIC_MINOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>  		<span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nodename</span>	<span class="o">=</span> <span class="s">&quot;pktcdvd/control&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>  		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pkt_ctl_fops</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pkt_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_mutex</span><span class="p">);</span>

	<span class="n">psd_pool</span> <span class="o">=</span> <span class="n">mempool_create_kmalloc_pool</span><span class="p">(</span><span class="n">PSD_POOL_SIZE</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_stacked_data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psd_pool</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_blkdev</span><span class="p">(</span><span class="n">pktdev_major</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: Unable to register block device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pktdev_major</span><span class="p">)</span>
		<span class="n">pktdev_major</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pkt_sysfs_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">pkt_debugfs_init</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt_misc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="s">&quot;: Unable to register misc device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_misc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pkt_proc</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;driver/&quot;</span><span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_misc:</span>
	<span class="n">pkt_debugfs_cleanup</span><span class="p">();</span>
	<span class="n">pkt_sysfs_cleanup</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">pktdev_major</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
<span class="nl">out2:</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">psd_pool</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pkt_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;driver/&quot;</span><span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt_misc</span><span class="p">);</span>

	<span class="n">pkt_debugfs_cleanup</span><span class="p">();</span>
	<span class="n">pkt_sysfs_cleanup</span><span class="p">();</span>

	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">pktdev_major</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
	<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">psd_pool</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Packet writing layer for CD/DVD drives&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jens Axboe &lt;axboe@suse.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">pkt_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pkt_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
