<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › aoe › aoecmd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>aoecmd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Copyright (c) 2007 Coraid, Inc.  See COPYING for GPL terms. */</span>
<span class="cm">/*</span>
<span class="cm"> * aoecmd.c</span>
<span class="cm"> * Filesystem request handling methods</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/ata.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/genhd.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &quot;aoe.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">aoe_deadsecs</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">aoe_deadsecs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">aoe_deadsecs</span><span class="p">,</span> <span class="s">&quot;After aoe_deadsecs seconds, give up and fail dev.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">aoe_maxout</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">aoe_maxout</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">aoe_maxout</span><span class="p">,</span>
	<span class="s">&quot;Only aoe_maxout outstanding packets for every MAC on eX.Y.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">new_skb</span><span class="p">(</span><span class="n">ulong</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_AOE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span>
<span class="nf">getframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">f</span><span class="o">&lt;</span><span class="n">e</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">==</span> <span class="n">tag</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Leave the top bit clear so we have tagspace for userland.</span>
<span class="cm"> * The bottom 16 bits are the xmit tick for rexmit/rttavg processing.</span>
<span class="cm"> * This driver reserves tag -1 to mean &quot;unused frame.&quot;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">newtag</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">ulong</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">n</span> <span class="o">|=</span> <span class="p">(</span><span class="o">++</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">lasttag</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aoehdr_atainit</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">host_tag</span> <span class="o">=</span> <span class="n">newtag</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_AOE</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">verfl</span> <span class="o">=</span> <span class="n">AOE_HVER</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">aoemajor</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">aoeminor</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">AOECMD_ATA</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">host_tag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">host_tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">put_lba</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoe_atahdr</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">lba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">lba0</span> <span class="o">=</span> <span class="n">lba</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">lba1</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">lba2</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">lba3</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">lba4</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">lba5</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ifrotate</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">ifp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">ifp</span> <span class="o">&gt;=</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">ifs</span><span class="p">[</span><span class="n">NAOEIFS</span><span class="p">]</span> <span class="o">||</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">nd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">ifp</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ifs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">nd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aoe: no interface to rotate to</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">skb_pool_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">skbpool</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">skb_pool_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">skbpool</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">&amp;&amp;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dataref</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">skbpool</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">skbpool</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">NSKBPOOLMAX</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">(</span><span class="n">ETH_ZLEN</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* freeframe is where we do our load balancing so it&#39;s a little hairy. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span>
<span class="nf">freeframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">rf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">**</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* shouldn&#39;t happen, but I&#39;m paranoid */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aoe: NULL TARGETS!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">;</span>
	<span class="n">t</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">targets</span><span class="p">[</span><span class="n">NTARGETS</span><span class="p">]</span> <span class="o">||</span> <span class="o">!*</span><span class="n">t</span><span class="p">)</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">targets</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nout</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">maxout</span>
		<span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">htgt</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">nd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">;</span>
			<span class="n">e</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">FREETAG</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">(</span><span class="n">ETH_ZLEN</span><span class="p">)))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dataref</span><span class="p">)</span>
					<span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rf</span><span class="p">)</span>
						<span class="n">rf</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
<span class="nl">gotone:</span>				<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
				<span class="n">ifrotate</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">f</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Work can be done, but the network layer is</span>
<span class="cm">			   holding our precious packets.  Try to grab</span>
<span class="cm">			   one from the pool. */</span>
			<span class="n">f</span> <span class="o">=</span> <span class="n">rf</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* more paranoia */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
					<span class="s">&quot;aoe: freeframe: %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="s">&quot;unexpected null rf&quot;</span><span class="p">);</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVFL_KICKME</span><span class="p">;</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_pool_get</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_pool_put</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">gotone</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dataref</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVFL_KICKME</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">)</span>	<span class="cm">/* we&#39;ve looped and found nada */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">t</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">targets</span><span class="p">[</span><span class="n">NTARGETS</span><span class="p">]</span> <span class="o">||</span> <span class="o">!*</span><span class="n">t</span><span class="p">)</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">targets</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aoecmd_ata_rw</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoe_atahdr</span> <span class="o">*</span><span class="n">ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio_vec</span> <span class="o">*</span><span class="n">bv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">bcnt</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">writebit</span><span class="p">,</span> <span class="n">extbit</span><span class="p">;</span>

	<span class="n">writebit</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">extbit</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">freeframe</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="o">*</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">inprocess</span><span class="p">;</span>
	<span class="n">bv</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bv</span><span class="p">;</span>
	<span class="n">bcnt</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">maxbcnt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bcnt</span> <span class="o">=</span> <span class="n">DEFAULTBCNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcnt</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bv_resid</span><span class="p">)</span>
		<span class="n">bcnt</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bv_resid</span><span class="p">;</span>
	<span class="cm">/* initialize the headers &amp; frame */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_atahdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">h</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">h</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">aoehdr_atainit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">nout</span><span class="o">++</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">waited</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">bufaddr</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bv_off</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">bcnt</span> <span class="o">=</span> <span class="n">bcnt</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">lba</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>

	<span class="cm">/* set up ata header */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">scnt</span> <span class="o">=</span> <span class="n">bcnt</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">put_lba</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVFL_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">aflags</span> <span class="o">|=</span> <span class="n">AOEAFL_EXT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">extbit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">lba3</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">lba3</span> <span class="o">|=</span> <span class="mh">0xe0</span><span class="p">;</span>	<span class="cm">/* LBA bit + obsolete 0xa0 */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bio_data_dir</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_page</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bv_off</span><span class="p">,</span> <span class="n">bcnt</span><span class="p">);</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">aflags</span> <span class="o">|=</span> <span class="n">AOEAFL_WRITE</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">bcnt</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">bcnt</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">wpkts</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">rpkts</span><span class="o">++</span><span class="p">;</span>
		<span class="n">writebit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">cmdstat</span> <span class="o">=</span> <span class="n">ATA_CMD_PIO_READ</span> <span class="o">|</span> <span class="n">writebit</span> <span class="o">|</span> <span class="n">extbit</span><span class="p">;</span>

	<span class="cm">/* mark all tracking fields and load out */</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">nframesout</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">bv_off</span> <span class="o">+=</span> <span class="n">bcnt</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">bv_resid</span> <span class="o">-=</span> <span class="n">bcnt</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">resid</span> <span class="o">-=</span> <span class="n">bcnt</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">+=</span> <span class="n">bcnt</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">resid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">inprocess</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bv_resid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">bv</span> <span class="o">=</span> <span class="o">++</span><span class="n">bv</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">bv_resid</span> <span class="o">=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_len</span><span class="p">;</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bv_resid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">bv_off</span> <span class="o">=</span> <span class="n">bv</span><span class="o">-&gt;</span><span class="n">bv_offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">nd</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">sendq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* some callers cannot sleep, and they can call this function,</span>
<span class="cm"> * transmitting the packets later, when interrupts are on</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">aoecmd_cfg_pkts</span><span class="p">(</span><span class="n">ushort</span> <span class="n">aoemajor</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">aoeminor</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoe_cfghdr</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ifp</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_each_netdev_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">ifp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_hold</span><span class="p">(</span><span class="n">ifp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_aoe_netif</span><span class="p">(</span><span class="n">ifp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">cont</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">h</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">ch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aoe: skb alloc failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">cont</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">h</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">ch</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ifp</span><span class="p">;</span>
		<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">h</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">ch</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">__constant_cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_AOE</span><span class="p">);</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">verfl</span> <span class="o">=</span> <span class="n">AOE_HVER</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">aoemajor</span><span class="p">);</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">aoeminor</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">AOECMD_CFG</span><span class="p">;</span>

<span class="nl">cont:</span>
		<span class="n">dev_put</span><span class="p">(</span><span class="n">ifp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">resend</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoe_atahdr</span> <span class="o">*</span><span class="n">ah</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">ifrotate</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">newtag</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_atahdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">h</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span>
		<span class="s">&quot;%15s e%ld.%d oldtag=%08x@%08lx newtag=%08x s=%pm d=%pm nout=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="s">&quot;retransmit&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">aoemajor</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">aoeminor</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">nout</span><span class="p">);</span>
	<span class="n">aoechr_error</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_CMD_PIO_READ</span>:
	<span class="k">case</span> <span class="n">ATA_CMD_PIO_READ_EXT</span>:
	<span class="k">case</span> <span class="n">ATA_CMD_PIO_WRITE</span>:
	<span class="k">case</span> <span class="n">ATA_CMD_PIO_WRITE_EXT</span>:
		<span class="n">put_lba</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">lba</span><span class="p">);</span>

		<span class="n">n</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">bcnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">DEFAULTBCNT</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">DEFAULTBCNT</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">scnt</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">aflags</span> <span class="o">&amp;</span> <span class="n">AOEAFL_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">bufaddr</span><span class="p">),</span>
				<span class="n">offset_in_page</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">bufaddr</span><span class="p">),</span> <span class="n">n</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">h</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">ah</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">nd</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">sendq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tsince</span><span class="p">(</span><span class="kt">int</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">-=</span> <span class="n">tag</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">aoeif</span> <span class="o">*</span>
<span class="nf">getif</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aoeif</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ifs</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">NAOEIFS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nd</span> <span class="o">==</span> <span class="n">nd</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">aoeif</span> <span class="o">*</span>
<span class="nf">addif</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">nd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aoeif</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">getif</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">nd</span> <span class="o">=</span> <span class="n">nd</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">maxbcnt</span> <span class="o">=</span> <span class="n">DEFAULTBCNT</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">lost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">lostjumbo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ejectif</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aoeif</span> <span class="o">*</span><span class="n">ifp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aoeif</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ifs</span> <span class="o">+</span> <span class="n">NAOEIFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">ifp</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">ifp</span><span class="p">;</span>
	<span class="n">memmove</span><span class="p">(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">ifp</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">nd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sthtith</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">nf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">ht</span> <span class="o">=</span> <span class="o">*</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">htgt</span><span class="p">;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">ht</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="n">ht</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">==</span> <span class="n">FREETAG</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">nf</span> <span class="o">=</span> <span class="n">freeframe</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nf</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">nf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="o">*</span><span class="n">nf</span> <span class="o">=</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">FREETAG</span><span class="p">;</span>
		<span class="n">nf</span><span class="o">-&gt;</span><span class="n">waited</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ht</span><span class="o">-&gt;</span><span class="n">nout</span><span class="o">--</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nout</span><span class="o">++</span><span class="p">;</span>
		<span class="n">resend</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">,</span> <span class="n">nf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* he&#39;s clean, he&#39;s useless.  take away his interfaces */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ht</span><span class="o">-&gt;</span><span class="n">ifs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">ht</span><span class="o">-&gt;</span><span class="n">ifs</span><span class="p">);</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">htgt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">ata_scnt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoe_atahdr</span> <span class="o">*</span><span class="n">ah</span><span class="p">;</span>

	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">packet</span><span class="p">;</span>
	<span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_atahdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">h</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">scnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rexmit_timer</span><span class="p">(</span><span class="n">ulong</span> <span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">tt</span><span class="p">,</span> <span class="o">**</span><span class="n">te</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoeif</span> <span class="o">*</span><span class="n">ifp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">flags</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="p">)</span> <span class="n">vp</span><span class="p">;</span>

	<span class="cm">/* timeout is always ~150% of the moving average */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">rttavg</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">+=</span> <span class="n">timeout</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVFL_TKILL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tt</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">targets</span><span class="p">;</span>
	<span class="n">te</span> <span class="o">=</span> <span class="n">tt</span> <span class="o">+</span> <span class="n">NTARGETS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">tt</span> <span class="o">&lt;</span> <span class="n">te</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">tt</span><span class="p">;</span> <span class="n">tt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span> <span class="o">=</span> <span class="o">*</span><span class="n">tt</span><span class="p">;</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">;</span>
		<span class="n">e</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">==</span> <span class="n">FREETAG</span>
			<span class="o">||</span> <span class="n">tsince</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">waited</span> <span class="o">+=</span> <span class="n">timeout</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">/=</span> <span class="n">HZ</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">aoe_deadsecs</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* waited too long.  device failure. */</span>
				<span class="n">aoedev_downdev</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">HELPWAIT</span> <span class="cm">/* see if another target can help */</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tt</span> <span class="o">!=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">targets</span> <span class="o">||</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">targets</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">htgt</span> <span class="o">=</span> <span class="n">tt</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">nout</span> <span class="o">==</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">maxout</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">maxout</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">t</span><span class="o">-&gt;</span><span class="n">maxout</span><span class="o">--</span><span class="p">;</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">lastwadj</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ifp</span> <span class="o">=</span> <span class="n">getif</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ifp</span> <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">lost</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">nframes</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ifp</span> <span class="o">!=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ifs</span> <span class="o">||</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ifs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">nd</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ejectif</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ifp</span><span class="p">);</span>
				<span class="n">ifp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ata_scnt</span><span class="p">(</span><span class="n">skb_mac_header</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">DEFAULTBCNT</span> <span class="o">/</span> <span class="mi">512</span>
			<span class="o">&amp;&amp;</span> <span class="n">ifp</span> <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">lostjumbo</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">nframes</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">maxbcnt</span> <span class="o">!=</span> <span class="n">DEFAULTBCNT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					<span class="s">&quot;aoe: e%ld.%d: &quot;</span>
					<span class="s">&quot;too many lost jumbo on &quot;</span>
					<span class="s">&quot;%s:%pm - &quot;</span>
					<span class="s">&quot;falling back to %d frames.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">d</span><span class="o">-&gt;</span><span class="n">aoemajor</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">aoeminor</span><span class="p">,</span>
					<span class="n">ifp</span><span class="o">-&gt;</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
					<span class="n">DEFAULTBCNT</span><span class="p">);</span>
				<span class="n">ifp</span><span class="o">-&gt;</span><span class="n">maxbcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">resend</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* window check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">nout</span> <span class="o">==</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">maxout</span>
		<span class="o">&amp;&amp;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">maxout</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">nframes</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">lastwadj</span><span class="p">)</span><span class="o">/</span><span class="n">HZ</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">maxout</span><span class="o">++</span><span class="p">;</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">lastwadj</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">sendq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">rttavg</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">MAXTIMER</span><span class="p">)</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">rttavg</span> <span class="o">=</span> <span class="n">MAXTIMER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVFL_KICKME</span> <span class="o">||</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">htgt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DEVFL_KICKME</span><span class="p">;</span>
		<span class="n">aoecmd_work</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">skb_queue_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">sendq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">d</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">TIMERTICK</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">aoenet_xmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* enters with d-&gt;lock held */</span>
<span class="kt">void</span>
<span class="nf">aoecmd_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<span class="nl">loop:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">htgt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sthtith</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">inprocess</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">bufq</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">bufq</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bufs</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">bufq</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">inprocess</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aoecmd_ata_rw</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">loop</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function performs work that has been deferred until sleeping is OK</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">aoecmd_sleepwork</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aoedev</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVFL_GDALLOC</span><span class="p">)</span>
		<span class="n">aoeblk_gdalloc</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEVFL_NEWSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">ssize</span><span class="p">;</span>

		<span class="n">ssize</span> <span class="o">=</span> <span class="n">get_capacity</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">);</span>
		<span class="n">bd</span> <span class="o">=</span> <span class="n">bdget_disk</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
			<span class="n">i_size_write</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">,</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">ssize</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="o">-&gt;</span><span class="n">i_mutex</span><span class="p">);</span>
			<span class="n">bdput</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVFL_UP</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DEVFL_NEWSIZE</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ataid_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">ssize</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">n</span><span class="p">;</span>

	<span class="cm">/* word 83: command set supported */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="mi">83</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/* word 86: command set/feature enabled */</span>
	<span class="n">n</span> <span class="o">|=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="mi">86</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* bit 10: LBA 48 */</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVFL_EXT</span><span class="p">;</span>

		<span class="cm">/* word 100: number lba48 sectors */</span>
		<span class="n">ssize</span> <span class="o">=</span> <span class="n">get_unaligned_le64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="mi">100</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]);</span>

		<span class="cm">/* set as in ide-disk.c:init_idedisk_capacity */</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">ssize</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">cylinders</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="mi">63</span><span class="p">);</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DEVFL_EXT</span><span class="p">;</span>

		<span class="cm">/* number lba28 sectors */</span>
		<span class="n">ssize</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="mi">60</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]);</span>

		<span class="cm">/* NOTE: obsolete in ATA 6 */</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="mi">54</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">heads</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="mi">55</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">[</span><span class="mi">56</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">ssize</span> <span class="o">!=</span> <span class="n">ssize</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;aoe: %pm e%ld.%d v%04x has %llu sectors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">aoemajor</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">aoeminor</span><span class="p">,</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ssize</span><span class="p">);</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">ssize</span> <span class="o">=</span> <span class="n">ssize</span><span class="p">;</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DEVFL_GDALLOC</span><span class="o">|</span><span class="n">DEVFL_NEWSIZE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">gd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_capacity</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">,</span> <span class="n">ssize</span><span class="p">);</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVFL_NEWSIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DEVFL_GDALLOC</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">calc_rttavg</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rtt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">long</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">rtt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="n">rtt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">MINTIMER</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">MINTIMER</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">MAXTIMER</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">MAXTIMER</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">mintimer</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">mintimer</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">mintimer</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">mintimer</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">MAXTIMER</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">MAXTIMER</span><span class="p">;</span>

	<span class="cm">/* g == .25; cf. Congestion Avoidance and Control, Jacobson &amp; Karels; 1988 */</span>
	<span class="n">n</span> <span class="o">-=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">rttavg</span><span class="p">;</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">rttavg</span> <span class="o">+=</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span>
<span class="nf">gettgt</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">**</span><span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">e</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">targets</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">NTARGETS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">((</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">((</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">diskstats</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">duration</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n_sect</span> <span class="o">=</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">rw</span> <span class="o">=</span> <span class="n">bio_data_dir</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hd_struct</span> <span class="o">*</span><span class="n">part</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">cpu</span> <span class="o">=</span> <span class="n">part_stat_lock</span><span class="p">();</span>
	<span class="n">part</span> <span class="o">=</span> <span class="n">disk_map_sector_rcu</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">sector</span><span class="p">);</span>

	<span class="n">part_stat_inc</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">ios</span><span class="p">[</span><span class="n">rw</span><span class="p">]);</span>
	<span class="n">part_stat_add</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">ticks</span><span class="p">[</span><span class="n">rw</span><span class="p">],</span> <span class="n">duration</span><span class="p">);</span>
	<span class="n">part_stat_add</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">sectors</span><span class="p">[</span><span class="n">rw</span><span class="p">],</span> <span class="n">n_sect</span><span class="p">);</span>
	<span class="n">part_stat_add</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">io_ticks</span><span class="p">,</span> <span class="n">duration</span><span class="p">);</span>

	<span class="n">part_stat_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">aoecmd_ata_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="n">hin</span><span class="p">,</span> <span class="o">*</span><span class="n">hout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoe_atahdr</span> <span class="o">*</span><span class="n">ahin</span><span class="p">,</span> <span class="o">*</span><span class="n">ahout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoeif</span> <span class="o">*</span><span class="n">ifp</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">long</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ebuf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">aoemajor</span><span class="p">;</span>

	<span class="n">hin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">aoemajor</span> <span class="o">=</span> <span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hin</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">);</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">aoedev_by_aoeaddr</span><span class="p">(</span><span class="n">aoemajor</span><span class="p">,</span> <span class="n">hin</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">ebuf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">ebuf</span><span class="p">,</span> <span class="s">&quot;aoecmd_ata_rsp: ata response &quot;</span>
			<span class="s">&quot;for unknown device %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">aoemajor</span><span class="p">,</span> <span class="n">hin</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="n">aoechr_error</span><span class="p">(</span><span class="n">ebuf</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hin</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">gettgt</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">hin</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aoe: can&#39;t find target e%ld.%d:%pm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">aoemajor</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">aoeminor</span><span class="p">,</span> <span class="n">hin</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">getframe</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">calc_rttavg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">-</span><span class="n">tsince</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">ebuf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">ebuf</span><span class="p">,</span>
			<span class="s">&quot;%15s e%d.%d    tag=%08x@%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;unexpected rsp&quot;</span><span class="p">,</span>
			<span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hin</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">),</span>
			<span class="n">hin</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span>
			<span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hin</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">),</span>
			<span class="n">jiffies</span><span class="p">);</span>
		<span class="n">aoechr_error</span><span class="p">(</span><span class="n">ebuf</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">calc_rttavg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">tsince</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">));</span>

	<span class="n">ahin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_atahdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">hin</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">hout</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_mac_header</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">ahout</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_atahdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">hout</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ahin</span><span class="o">-&gt;</span><span class="n">cmdstat</span> <span class="o">&amp;</span> <span class="mh">0xa9</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* these bits cleared on success */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;aoe: ata error cmd=%2.2Xh stat=%2.2Xh from e%ld.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ahout</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">,</span> <span class="n">ahin</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">,</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">aoemajor</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">aoeminor</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BUFFL_FAIL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">htgt</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">==</span> <span class="o">*</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">htgt</span><span class="p">)</span> <span class="cm">/* I&#39;ll help myself, thank you. */</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">htgt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">ahout</span><span class="o">-&gt;</span><span class="n">scnt</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ahout</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ATA_CMD_PIO_READ</span>:
		<span class="k">case</span> <span class="n">ATA_CMD_PIO_READ_EXT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">hin</span> <span class="o">-</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">ahin</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
					<span class="s">&quot;aoe: %s.  skb-&gt;len=%d need=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="s">&quot;runt data size in read&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
				<span class="cm">/* fail frame f?  just returning will rexmit. */</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">bufaddr</span><span class="p">,</span> <span class="n">ahin</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">ATA_CMD_PIO_WRITE</span>:
		<span class="k">case</span> <span class="n">ATA_CMD_PIO_WRITE_EXT</span>:
			<span class="n">ifp</span> <span class="o">=</span> <span class="n">getif</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ifp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ifp</span><span class="o">-&gt;</span><span class="n">lost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">DEFAULTBCNT</span><span class="p">)</span>
					<span class="n">ifp</span><span class="o">-&gt;</span><span class="n">lostjumbo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">bcnt</span> <span class="o">-=</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">lba</span> <span class="o">+=</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">bufaddr</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
				<span class="n">resend</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">xmit</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATA_CMD_ID_ATA</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">hin</span> <span class="o">-</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">ahin</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					<span class="s">&quot;aoe: runt data size in ataid.  skb-&gt;len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ataid_complete</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ahin</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				<span class="s">&quot;aoe: unrecognized ata command %2.2Xh for %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ahout</span><span class="o">-&gt;</span><span class="n">cmdstat</span><span class="p">,</span>
				<span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hin</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">),</span>
				<span class="n">hin</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">nframesout</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">resid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diskstats</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">stime</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BUFFL_FAIL</span><span class="p">)</span>
			<span class="n">bio_endio</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">bio_flush_dcache_pages</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">);</span>
			<span class="n">bio_endio</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mempool_free</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">bufpool</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">FREETAG</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">nout</span><span class="o">--</span><span class="p">;</span>

	<span class="n">aoecmd_work</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="nl">xmit:</span>
	<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">skb_queue_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">sendq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">aoenet_xmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">aoecmd_cfg</span><span class="p">(</span><span class="n">ushort</span> <span class="n">aoemajor</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">aoeminor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">queue</span><span class="p">;</span>

	<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">aoecmd_cfg_pkts</span><span class="p">(</span><span class="n">aoemajor</span><span class="p">,</span> <span class="n">aoeminor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">aoenet_xmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">aoecmd_ata_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoe_atahdr</span> <span class="o">*</span><span class="n">ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">freeframe</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="o">*</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">tgt</span><span class="p">;</span>

	<span class="cm">/* initialize the headers &amp; frame */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_atahdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">h</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">h</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">aoehdr_atainit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">nout</span><span class="o">++</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">waited</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set up ata header */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">scnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">cmdstat</span> <span class="o">=</span> <span class="n">ATA_CMD_ID_ATA</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">lba3</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">nd</span><span class="p">;</span>

	<span class="n">d</span><span class="o">-&gt;</span><span class="n">rttavg</span> <span class="o">=</span> <span class="n">MAXTIMER</span><span class="p">;</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">rexmit_timer</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span>
<span class="nf">addtgt</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">nframes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">tt</span><span class="p">,</span> <span class="o">**</span><span class="n">te</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">tt</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">targets</span><span class="p">;</span>
	<span class="n">te</span> <span class="o">=</span> <span class="n">tt</span> <span class="o">+</span> <span class="n">NTARGETS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">tt</span> <span class="o">&lt;</span> <span class="n">te</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">tt</span><span class="p">;</span> <span class="n">tt</span><span class="o">++</span><span class="p">)</span>
		<span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tt</span> <span class="o">==</span> <span class="n">te</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;aoe: device addtgt failure; too many targets</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">nframes</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span> <span class="o">||</span> <span class="o">!</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aoe: cannot allocate memory to add target</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">nframes</span> <span class="o">=</span> <span class="n">nframes</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">frames</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="n">nframes</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">FREETAG</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">ifp</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">ifs</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">maxout</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">tt</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">aoecmd_cfg_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoe_cfghdr</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoeif</span> <span class="o">*</span><span class="n">ifp</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">flags</span><span class="p">,</span> <span class="n">sysminor</span><span class="p">,</span> <span class="n">aoemajor</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_cfghdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">h</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enough people have their dip switches set backwards to</span>
<span class="cm">	 * warrant a loud message for this special case.</span>
<span class="cm">	 */</span>
	<span class="n">aoemajor</span> <span class="o">=</span> <span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aoemajor</span> <span class="o">==</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aoe: Warning: shelf address is all ones.  &quot;</span>
			<span class="s">&quot;Check shelf dip switches.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sysminor</span> <span class="o">=</span> <span class="n">SYSMINOR</span><span class="p">(</span><span class="n">aoemajor</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sysminor</span> <span class="o">*</span> <span class="n">AOE_PARTITIONS</span> <span class="o">+</span> <span class="n">AOE_PARTITIONS</span> <span class="o">&gt;</span> <span class="n">MINORMASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aoe: e%ld.%d: minor number too large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">aoemajor</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">bufcnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">aoe_maxout</span><span class="p">)</span>	<span class="cm">/* keep it reasonable */</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">aoe_maxout</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">aoedev_by_sysminor_m</span><span class="p">(</span><span class="n">sysminor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aoe: device sysminor_m failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">gettgt</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">addtgt</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ifp</span> <span class="o">=</span> <span class="n">getif</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ifp</span> <span class="o">=</span> <span class="n">addif</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				<span class="s">&quot;aoe: device addif failure; &quot;</span>
				<span class="s">&quot;too many interfaces?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">maxbcnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">-=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">aoe_atahdr</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">/=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">scnt</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">scnt</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">?</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">:</span> <span class="n">DEFAULTBCNT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">maxbcnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				<span class="s">&quot;aoe: e%ld.%d: setting %d%s%s:%pm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">aoemajor</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">aoeminor</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
				<span class="s">&quot; byte data frames on &quot;</span><span class="p">,</span> <span class="n">ifp</span><span class="o">-&gt;</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">ifp</span><span class="o">-&gt;</span><span class="n">maxbcnt</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* don&#39;t change users&#39; perspective */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">nopen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">fwver</span><span class="p">);</span>

	<span class="n">sl</span> <span class="o">=</span> <span class="n">aoecmd_ata_id</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">queue</span><span class="p">;</span>
		<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">,</span> <span class="n">sl</span><span class="p">);</span>
		<span class="n">aoenet_xmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">aoecmd_cleanslate</span><span class="p">(</span><span class="k">struct</span> <span class="n">aoedev</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aoetgt</span> <span class="o">**</span><span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">te</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aoeif</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">d</span><span class="o">-&gt;</span><span class="n">mintimer</span> <span class="o">=</span> <span class="n">MINTIMER</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">targets</span><span class="p">;</span>
	<span class="n">te</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">NTARGETS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">te</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">maxout</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ifs</span><span class="p">;</span>
		<span class="n">e</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">NAOEIFS</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">lostjumbo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">lost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">maxbcnt</span> <span class="o">=</span> <span class="n">DEFAULTBCNT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
