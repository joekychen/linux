<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › swim3.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>swim3.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for the SWIM3 (Super Woz Integrated Machine 3)</span>
<span class="cm"> * floppy controller found on Power Macintoshes.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1996 Paul Mackerras.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * TODO:</span>
<span class="cm"> * handle 2 drives</span>
<span class="cm"> * handle GCR disks</span>
<span class="cm"> */</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/fd.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dbdma.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/mediabay.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/pmac_feature.h&gt;</span>

<span class="cp">#define MAX_FLOPPIES	2</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">swim3_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disks</span><span class="p">[</span><span class="n">MAX_FLOPPIES</span><span class="p">];</span>

<span class="k">enum</span> <span class="n">swim_state</span> <span class="p">{</span>
	<span class="n">idle</span><span class="p">,</span>
	<span class="n">locating</span><span class="p">,</span>
	<span class="n">seeking</span><span class="p">,</span>
	<span class="n">settling</span><span class="p">,</span>
	<span class="n">do_transfer</span><span class="p">,</span>
	<span class="n">jogging</span><span class="p">,</span>
	<span class="n">available</span><span class="p">,</span>
	<span class="n">revalidating</span><span class="p">,</span>
	<span class="n">ejecting</span>
<span class="p">};</span>

<span class="cp">#define REG(x)	unsigned char x; char x ## _pad[15];</span>

<span class="cm">/*</span>
<span class="cm"> * The names for these registers mostly represent speculation on my part.</span>
<span class="cm"> * It will be interesting to see how close they are to the names Apple uses.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">swim3</span> <span class="p">{</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>		<span class="cm">/* counts down at 1MHz */</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">select</span><span class="p">);</span>		<span class="cm">/* controls CA0, CA1, CA2 and LSTRB signals */</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">setup</span><span class="p">);</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>		<span class="cm">/* writing bits clears them */</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>		<span class="cm">/* writing bits sets them in control */</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">intr</span><span class="p">);</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">nseek</span><span class="p">);</span>		<span class="cm">/* # tracks to seek */</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">ctrack</span><span class="p">);</span>		<span class="cm">/* current track number */</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">csect</span><span class="p">);</span>		<span class="cm">/* current sector number */</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">gap3</span><span class="p">);</span>		<span class="cm">/* size of gap 3 in track format */</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">sector</span><span class="p">);</span>		<span class="cm">/* sector # to read or write */</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">nsect</span><span class="p">);</span>		<span class="cm">/* # sectors to read or write */</span>
	<span class="n">REG</span><span class="p">(</span><span class="n">intr_enable</span><span class="p">);</span>
<span class="p">};</span>

<span class="cp">#define control_bic	control</span>
<span class="cp">#define control_bis	status</span>

<span class="cm">/* Bits in select register */</span>
<span class="cp">#define CA_MASK		7</span>
<span class="cp">#define LSTRB		8</span>

<span class="cm">/* Bits in control register */</span>
<span class="cp">#define DO_SEEK		0x80</span>
<span class="cp">#define FORMAT		0x40</span>
<span class="cp">#define SELECT		0x20</span>
<span class="cp">#define WRITE_SECTORS	0x10</span>
<span class="cp">#define DO_ACTION	0x08</span>
<span class="cp">#define DRIVE2_ENABLE	0x04</span>
<span class="cp">#define DRIVE_ENABLE	0x02</span>
<span class="cp">#define INTR_ENABLE	0x01</span>

<span class="cm">/* Bits in status register */</span>
<span class="cp">#define FIFO_1BYTE	0x80</span>
<span class="cp">#define FIFO_2BYTE	0x40</span>
<span class="cp">#define ERROR		0x20</span>
<span class="cp">#define DATA		0x08</span>
<span class="cp">#define RDDATA		0x04</span>
<span class="cp">#define INTR_PENDING	0x02</span>
<span class="cp">#define MARK_BYTE	0x01</span>

<span class="cm">/* Bits in intr and intr_enable registers */</span>
<span class="cp">#define ERROR_INTR	0x20</span>
<span class="cp">#define DATA_CHANGED	0x10</span>
<span class="cp">#define TRANSFER_DONE	0x08</span>
<span class="cp">#define SEEN_SECTOR	0x04</span>
<span class="cp">#define SEEK_DONE	0x02</span>
<span class="cp">#define TIMER_DONE	0x01</span>

<span class="cm">/* Bits in error register */</span>
<span class="cp">#define ERR_DATA_CRC	0x80</span>
<span class="cp">#define ERR_ADDR_CRC	0x40</span>
<span class="cp">#define ERR_OVERRUN	0x04</span>
<span class="cp">#define ERR_UNDERRUN	0x01</span>

<span class="cm">/* Bits in setup register */</span>
<span class="cp">#define S_SW_RESET	0x80</span>
<span class="cp">#define S_GCR_WRITE	0x40</span>
<span class="cp">#define S_IBM_DRIVE	0x20</span>
<span class="cp">#define S_TEST_MODE	0x10</span>
<span class="cp">#define S_FCLK_DIV2	0x08</span>
<span class="cp">#define S_GCR		0x04</span>
<span class="cp">#define S_COPY_PROT	0x02</span>
<span class="cp">#define S_INV_WDATA	0x01</span>

<span class="cm">/* Select values for swim3_action */</span>
<span class="cp">#define SEEK_POSITIVE	0</span>
<span class="cp">#define SEEK_NEGATIVE	4</span>
<span class="cp">#define STEP		1</span>
<span class="cp">#define MOTOR_ON	2</span>
<span class="cp">#define MOTOR_OFF	6</span>
<span class="cp">#define INDEX		3</span>
<span class="cp">#define EJECT		7</span>
<span class="cp">#define SETMFM		9</span>
<span class="cp">#define SETGCR		13</span>

<span class="cm">/* Select values for swim3_select and swim3_readbit */</span>
<span class="cp">#define STEP_DIR	0</span>
<span class="cp">#define STEPPING	1</span>
<span class="cp">#define MOTOR_ON	2</span>
<span class="cp">#define RELAX		3	</span><span class="cm">/* also eject in progress */</span><span class="cp"></span>
<span class="cp">#define READ_DATA_0	4</span>
<span class="cp">#define TWOMEG_DRIVE	5</span>
<span class="cp">#define SINGLE_SIDED	6	</span><span class="cm">/* drive or diskette is 4MB type? */</span><span class="cp"></span>
<span class="cp">#define DRIVE_PRESENT	7</span>
<span class="cp">#define DISK_IN		8</span>
<span class="cp">#define WRITE_PROT	9</span>
<span class="cp">#define TRACK_ZERO	10</span>
<span class="cp">#define TACHO		11</span>
<span class="cp">#define READ_DATA_1	12</span>
<span class="cp">#define MFM_MODE	13</span>
<span class="cp">#define SEEK_COMPLETE	14</span>
<span class="cp">#define ONEMEG_MEDIA	15</span>

<span class="cm">/* Definitions of values used in writing and formatting */</span>
<span class="cp">#define DATA_ESCAPE	0x99</span>
<span class="cp">#define GCR_SYNC_EXC	0x3f</span>
<span class="cp">#define GCR_SYNC_CONV	0x80</span>
<span class="cp">#define GCR_FIRST_MARK	0xd5</span>
<span class="cp">#define GCR_SECOND_MARK	0xaa</span>
<span class="cp">#define GCR_ADDR_MARK	&quot;\xd5\xaa\x00&quot;</span>
<span class="cp">#define GCR_DATA_MARK	&quot;\xd5\xaa\x0b&quot;</span>
<span class="cp">#define GCR_SLIP_BYTE	&quot;\x27\xaa&quot;</span>
<span class="cp">#define GCR_SELF_SYNC	&quot;\x3f\xbf\x1e\x34\x3c\x3f&quot;</span>

<span class="cp">#define DATA_99		&quot;\x99\x99&quot;</span>
<span class="cp">#define MFM_ADDR_MARK	&quot;\x99\xa1\x99\xa1\x99\xa1\x99\xfe&quot;</span>
<span class="cp">#define MFM_INDEX_MARK	&quot;\x99\xc2\x99\xc2\x99\xc2\x99\xfc&quot;</span>
<span class="cp">#define MFM_GAP_LEN	12</span>

<span class="k">struct</span> <span class="n">floppy_state</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">swim_state</span>	<span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">swim3</span><span class="p">;</span>	<span class="cm">/* hardware registers */</span>
	<span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dma</span><span class="p">;</span>	<span class="cm">/* DMA controller registers */</span>
	<span class="kt">int</span>	<span class="n">swim3_intr</span><span class="p">;</span>	<span class="cm">/* interrupt number for SWIM3 */</span>
	<span class="kt">int</span>	<span class="n">dma_intr</span><span class="p">;</span>	<span class="cm">/* interrupt number for DMA channel */</span>
	<span class="kt">int</span>	<span class="n">cur_cyl</span><span class="p">;</span>	<span class="cm">/* cylinder head is on, or -1 */</span>
	<span class="kt">int</span>	<span class="n">cur_sector</span><span class="p">;</span>	<span class="cm">/* last sector we saw go past */</span>
	<span class="kt">int</span>	<span class="n">req_cyl</span><span class="p">;</span>	<span class="cm">/* the cylinder for the current r/w request */</span>
	<span class="kt">int</span>	<span class="n">head</span><span class="p">;</span>		<span class="cm">/* head number ditto */</span>
	<span class="kt">int</span>	<span class="n">req_sector</span><span class="p">;</span>	<span class="cm">/* sector number ditto */</span>
	<span class="kt">int</span>	<span class="n">scount</span><span class="p">;</span>		<span class="cm">/* # sectors we&#39;re transferring at present */</span>
	<span class="kt">int</span>	<span class="n">retries</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">settle_time</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">secpercyl</span><span class="p">;</span>	<span class="cm">/* disk geometry information */</span>
	<span class="kt">int</span>	<span class="n">secpertrack</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">total_secs</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">write_prot</span><span class="p">;</span>	<span class="cm">/* 1 if write-protected, 0 if not, -1 dunno */</span>
	<span class="k">struct</span> <span class="n">dbdma_cmd</span> <span class="o">*</span><span class="n">dma_cmd</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ref_count</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">expect_cyl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">timeout_pending</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ejected</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">wait</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">wanted</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">macio_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">dbdma_cmd_space</span><span class="p">[</span><span class="mi">5</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbdma_cmd</span><span class="p">)];</span>
	<span class="kt">int</span>	<span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">cur_req</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define swim3_err(fmt, arg...)	dev_err(&amp;fs-&gt;mdev-&gt;ofdev.dev, &quot;[fd%d] &quot; fmt, fs-&gt;index, arg)</span>
<span class="cp">#define swim3_warn(fmt, arg...)	dev_warn(&amp;fs-&gt;mdev-&gt;ofdev.dev, &quot;[fd%d] &quot; fmt, fs-&gt;index, arg)</span>
<span class="cp">#define swim3_info(fmt, arg...)	dev_info(&amp;fs-&gt;mdev-&gt;ofdev.dev, &quot;[fd%d] &quot; fmt, fs-&gt;index, arg)</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define swim3_dbg(fmt, arg...)	dev_dbg(&amp;fs-&gt;mdev-&gt;ofdev.dev, &quot;[fd%d] &quot; fmt, fs-&gt;index, arg)</span>
<span class="cp">#else</span>
<span class="cp">#define swim3_dbg(fmt, arg...)	do { } while(0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">floppy_state</span> <span class="n">floppy_states</span><span class="p">[</span><span class="n">MAX_FLOPPIES</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">floppy_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">swim3_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">write_preamble</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x4e4e</span><span class="p">,</span> <span class="mh">0x4e4e</span><span class="p">,</span> <span class="mh">0x4e4e</span><span class="p">,</span> <span class="mh">0x4e4e</span><span class="p">,</span> <span class="mh">0x4e4e</span><span class="p">,</span>	<span class="cm">/* gap field */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>			<span class="cm">/* sync field */</span>
	<span class="mh">0x99a1</span><span class="p">,</span> <span class="mh">0x99a1</span><span class="p">,</span> <span class="mh">0x99a1</span><span class="p">,</span> <span class="mh">0x99fb</span><span class="p">,</span>		<span class="cm">/* data address mark */</span>
	<span class="mh">0x990f</span>					<span class="cm">/* no escape for 512 bytes */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">write_postamble</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x9904</span><span class="p">,</span>					<span class="cm">/* insert CRC */</span>
	<span class="mh">0x4e4e</span><span class="p">,</span> <span class="mh">0x4e4e</span><span class="p">,</span>
	<span class="mh">0x9908</span><span class="p">,</span>					<span class="cm">/* stop writing */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">seek_track</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbdma_cmd</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">act</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">scan_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">seek_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">settle_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">xfer_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">swim3_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="cm">/*static void fd_dma_interrupt(int irq, void *dev_id);*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">grab_drive</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">,</span> <span class="k">enum</span> <span class="n">swim_state</span> <span class="n">state</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">interruptible</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">release_drive</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fd_eject</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">floppy_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">floppy_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">floppy_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">floppy_check_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clearing</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">floppy_revalidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">swim3_end_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;  end request, err=%d nr_bytes=%d, cur_req=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">err</span><span class="p">,</span> <span class="n">nr_bytes</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">nr_bytes</span> <span class="o">=</span> <span class="n">blk_rq_cur_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">__blk_end_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">nr_bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">swim3_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">;</span>

	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">select</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bis</span><span class="p">,</span> <span class="n">SELECT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bic</span><span class="p">,</span> <span class="n">SELECT</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">select</span><span class="p">,</span> <span class="n">sel</span> <span class="o">&amp;</span> <span class="n">CA_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">swim3_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">;</span>

	<span class="n">swim3_select</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">select</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">select</span> <span class="o">|</span> <span class="n">LSTRB</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">select</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">select</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LSTRB</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">swim3_readbit</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">swim3_select</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DATA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;start request, initial state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">idle</span> <span class="o">&amp;&amp;</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">wanted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">available</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">idle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;start request, idle loop, cur_req=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_req</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_req</span> <span class="o">=</span> <span class="n">blk_fetch_request</span><span class="p">(</span><span class="n">disks</span><span class="p">[</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
			<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;  fetched request %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_req</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_req</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_req</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span> <span class="o">&amp;&amp;</span>
		    <span class="n">check_media_bay</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MB_FD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;  media bay absent, dropping req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">swim3_end_request</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* This is really too verbose */</span>
<span class="c">		swim3_dbg(&quot;do_fd_req: dev=%s cmd=%d sec=%ld nr_sec=%u buf=%p\n&quot;,</span>
<span class="c">			  req-&gt;rq_disk-&gt;disk_name, req-&gt;cmd,</span>
<span class="c">			  (long)blk_rq_pos(req), blk_rq_sectors(req),</span>
<span class="c">			  req-&gt;buffer);</span>
<span class="c">		swim3_dbg(&quot;           errors=%d current_nr_sectors=%u\n&quot;,</span>
<span class="c">			  req-&gt;errors, blk_rq_cur_sectors(req));</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">total_secs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;  pos out of bounds (%ld, max is %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">total_secs</span><span class="p">);</span>
			<span class="n">swim3_end_request</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ejected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;  disk ejected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">swim3_end_request</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">write_prot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">fs</span><span class="o">-&gt;</span><span class="n">write_prot</span> <span class="o">=</span> <span class="n">swim3_readbit</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">WRITE_PROT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">write_prot</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;  try to write, disk write protected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">swim3_end_request</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Do not remove the cast. blk_rq_pos(req) is now a</span>
<span class="cm">		 * sector_t and can be 64 bits, but it will never go</span>
<span class="cm">		 * past 32 bits for this driver anyway, so we can</span>
<span class="cm">		 * safely cast it down and not have to do a 64/32</span>
<span class="cm">		 * division</span>
<span class="cm">		 */</span>
		<span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_cyl</span> <span class="o">=</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="o">/</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">secpercyl</span><span class="p">;</span>
		<span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="o">%</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">secpercyl</span><span class="p">;</span>
		<span class="n">fs</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">secpertrack</span><span class="p">;</span>
		<span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_sector</span> <span class="o">=</span> <span class="n">x</span> <span class="o">%</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">secpertrack</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">do_transfer</span><span class="p">;</span>
		<span class="n">fs</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">act</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_fd_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">start_request</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nticks</span><span class="p">,</span>
			<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">proc</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout_pending</span><span class="p">)</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">nticks</span><span class="p">;</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">proc</span><span class="p">;</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">fs</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">scan_track</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">;</span>

	<span class="n">swim3_select</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">READ_DATA_0</span><span class="p">);</span>
	<span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">);</span>		<span class="cm">/* clear SEEN_SECTOR bit */</span>
	<span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="n">SEEN_SECTOR</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bis</span><span class="p">,</span> <span class="n">DO_ACTION</span><span class="p">);</span>
	<span class="cm">/* enable intr when track found */</span>
	<span class="n">set_timeout</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">HZ</span><span class="p">,</span> <span class="n">scan_timeout</span><span class="p">);</span>	<span class="cm">/* enable timeout */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">seek_track</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swim3_action</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">SEEK_POSITIVE</span><span class="p">);</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">nseek</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">swim3_action</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">SEEK_NEGATIVE</span><span class="p">);</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">nseek</span> <span class="o">=</span> <span class="o">-</span><span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">expect_cyl</span> <span class="o">=</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">?</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span> <span class="o">+</span> <span class="n">n</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">swim3_select</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">STEP</span><span class="p">);</span>
	<span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
	<span class="cm">/* enable intr when seek finished */</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="n">SEEK_DONE</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bis</span><span class="p">,</span> <span class="n">DO_SEEK</span><span class="p">);</span>
	<span class="n">set_timeout</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="n">seek_timeout</span><span class="p">);</span>	<span class="cm">/* enable timeout */</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">settle_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">init_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbdma_cmd</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">req_count</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">st_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">xfer_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">setup_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbdma_cmd</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">dma_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dr</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blk_rq_cur_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swim3_warn</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Transfer 0 sectors ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">secpertrack</span> <span class="o">-</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_sector</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">blk_rq_cur_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">blk_rq_cur_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;  setup xfer at sect %d (of %d) head %d for %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_sector</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">secpertrack</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">scount</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">swim3_select</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">?</span> <span class="n">READ_DATA_1</span><span class="o">:</span> <span class="n">READ_DATA_0</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_sector</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">nsect</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">gap3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="p">,</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set up 3 dma commands: write preamble, data, postamble */</span>
		<span class="n">init_dma</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">OUTPUT_MORE</span><span class="p">,</span> <span class="n">write_preamble</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">write_preamble</span><span class="p">));</span>
		<span class="o">++</span><span class="n">cp</span><span class="p">;</span>
		<span class="n">init_dma</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">OUTPUT_MORE</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
		<span class="o">++</span><span class="n">cp</span><span class="p">;</span>
		<span class="n">init_dma</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">OUTPUT_LAST</span><span class="p">,</span> <span class="n">write_postamble</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">write_postamble</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">init_dma</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">INPUT_LAST</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">512</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">++</span><span class="n">cp</span><span class="p">;</span>
	<span class="n">out_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">DBDMA_STOP</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bic</span><span class="p">,</span> <span class="n">DO_ACTION</span> <span class="o">|</span> <span class="n">WRITE_SECTORS</span><span class="p">);</span>
	<span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bic</span><span class="p">,</span> <span class="n">DO_ACTION</span> <span class="o">|</span> <span class="n">WRITE_SECTORS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bis</span><span class="p">,</span> <span class="n">WRITE_SECTORS</span><span class="p">);</span>
	<span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">);</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="p">(</span><span class="n">RUN</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">RUN</span><span class="p">);</span>
	<span class="cm">/* enable intr when transfer complete */</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="n">TRANSFER_DONE</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bis</span><span class="p">,</span> <span class="n">DO_ACTION</span><span class="p">);</span>
	<span class="n">set_timeout</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="n">xfer_timeout</span><span class="p">);</span>	<span class="cm">/* enable timeout */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">act</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;  act loop, state=%d, req_cyl=%d, cur_cyl=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_cyl</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">idle</span>:
			<span class="k">return</span><span class="p">;</span>		<span class="cm">/* XXX shouldn&#39;t get here */</span>

		<span class="k">case</span> <span class="n">locating</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">swim3_readbit</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">TRACK_ZERO</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;    locate track 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_cyl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">do_transfer</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">seeking</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">scan_track</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">seeking</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fs</span><span class="o">-&gt;</span><span class="n">expect_cyl</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">locating</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_cyl</span> <span class="o">==</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">swim3_warn</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Whoops, seeking 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">do_transfer</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">seek_track</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_cyl</span> <span class="o">-</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">settling</span>:
			<span class="cm">/* check for SEEK_COMPLETE after 30ms */</span>
			<span class="n">fs</span><span class="o">-&gt;</span><span class="n">settle_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">+</span> <span class="mi">32</span><span class="p">)</span> <span class="o">/</span> <span class="mi">33</span><span class="p">;</span>
			<span class="n">set_timeout</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">settle_time</span><span class="p">,</span> <span class="n">settle_timeout</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">do_transfer</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span> <span class="o">!=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_cyl</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;Wrong cylinder in transfer, want: %d got %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_cyl</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span><span class="p">);</span>
					<span class="n">swim3_end_request</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">seeking</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">setup_transfer</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">jogging</span>:
			<span class="n">seek_track</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;Unknown state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scan_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;* scan timeout, state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bic</span><span class="p">,</span> <span class="n">DO_ACTION</span> <span class="o">|</span> <span class="n">WRITE_SECTORS</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">select</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swim3_end_request</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
		<span class="n">start_request</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">jogging</span><span class="p">;</span>
		<span class="n">act</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seek_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;* seek timeout, state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bic</span><span class="p">,</span> <span class="n">DO_SEEK</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">select</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Seek timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">swim3_end_request</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
	<span class="n">start_request</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">settle_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;* settle timeout, state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">swim3_readbit</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">SEEK_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">select</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>
		<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">locating</span><span class="p">;</span>
		<span class="n">act</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">select</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">settle_time</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">settle_time</span><span class="p">;</span>
		<span class="n">set_timeout</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">settle_timeout</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Seek settle timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">swim3_end_request</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
	<span class="n">start_request</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
 <span class="nl">unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xfer_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dr</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;* xfer timeout, state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="n">RUN</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="cm">/* We must wait a bit for dbdma to stop */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ACTIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bic</span><span class="p">,</span> <span class="n">WRITE_SECTORS</span> <span class="o">|</span> <span class="n">DO_ACTION</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">select</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>
	<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;Timeout %sing sector %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_req</span><span class="p">)</span><span class="o">==</span><span class="n">WRITE</span><span class="o">?</span> <span class="s">&quot;writ&quot;</span><span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">),</span>
	       <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_req</span><span class="p">));</span>
	<span class="n">swim3_end_request</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
	<span class="n">start_request</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">swim3_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intr</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">,</span> <span class="n">resid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbdma_cmd</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_req</span><span class="p">;</span>

	<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;* interrupt, state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">intr</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">ERROR_INTR</span><span class="p">)</span><span class="o">?</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">ERROR_INTR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">do_transfer</span><span class="p">)</span>
		<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;Non-transfer error interrupt: state=%d, dir=%x, intr=%x, err=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="n">intr</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">locating</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">SEEN_SECTOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bic</span><span class="p">,</span> <span class="n">DO_ACTION</span> <span class="o">|</span> <span class="n">WRITE_SECTORS</span><span class="p">);</span>
			<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">select</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>
			<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
			<span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">ctrack</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Seen sector but cyl=ff?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">swim3_end_request</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
					<span class="n">start_request</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">jogging</span><span class="p">;</span>
					<span class="n">act</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">ctrack</span><span class="p">;</span>
			<span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_sector</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">csect</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">expect_cyl</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">expect_cyl</span> <span class="o">!=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span><span class="p">)</span>
				<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;Expected cyl %d, got %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">fs</span><span class="o">-&gt;</span><span class="n">expect_cyl</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span><span class="p">);</span>
			<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">do_transfer</span><span class="p">;</span>
			<span class="n">act</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">seeking</span>:
	<span class="k">case</span> <span class="n">jogging</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">nseek</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bic</span><span class="p">,</span> <span class="n">DO_SEEK</span><span class="p">);</span>
			<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">select</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>
			<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
			<span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">seeking</span><span class="p">)</span>
				<span class="o">++</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">;</span>
			<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">settling</span><span class="p">;</span>
			<span class="n">act</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">settling</span>:
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
		<span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">act</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">do_transfer</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ERROR_INTR</span> <span class="o">|</span> <span class="n">TRANSFER_DONE</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bic</span><span class="p">,</span> <span class="n">WRITE_SECTORS</span> <span class="o">|</span> <span class="n">DO_ACTION</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">select</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
		<span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dr</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">dma_cmd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span>
			<span class="o">++</span><span class="n">cp</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check that the main data transfer has finished.</span>
<span class="cm">		 * On writing, the swim3 sometimes doesn&#39;t use</span>
<span class="cm">		 * up all the bytes of the postamble, so we can still</span>
<span class="cm">		 * see DMA active here.  That doesn&#39;t matter as long</span>
<span class="cm">		 * as all the sector data has been transferred.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">ERROR_INTR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">xfer_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* wait a little while for DMA to complete */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">xfer_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">barrier</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* turn off DMA */</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dr</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="p">(</span><span class="n">RUN</span> <span class="o">|</span> <span class="n">PAUSE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">ld_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">xfer_status</span><span class="p">);</span>
		<span class="n">resid</span> <span class="o">=</span> <span class="n">ld_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">res_count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">ERROR_INTR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">scount</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">resid</span> <span class="o">/</span> <span class="mi">512</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">blk_update_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
				<span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_sector</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">++</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">;</span>
				<span class="n">act</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;Error %sing block %ld (err=%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="o">?</span> <span class="s">&quot;writ&quot;</span><span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">,</span>
				       <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="n">err</span><span class="p">);</span>
				<span class="n">swim3_end_request</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ACTIVE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">resid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* musta been an error */</span>
				<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;fd dma error: stat=%x resid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">resid</span><span class="p">);</span>
				<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;  state=%d, dir=%x, intr=%x, err=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="n">intr</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
				<span class="n">swim3_end_request</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
				<span class="n">start_request</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fs</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">swim3_end_request</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">scount</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_sector</span> <span class="o">+=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">scount</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_sector</span> <span class="o">&gt;</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">secpertrack</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_sector</span> <span class="o">-=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">secpertrack</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">fs</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="o">++</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">req_cyl</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">act</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">idle</span><span class="p">)</span>
			<span class="n">start_request</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;Don&#39;t know what to do in state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">static void fd_dma_interrupt(int irq, void *dev_id)</span>
<span class="cm">{</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="cm">/* Called under the mutex to grab exclusive access to a drive */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">grab_drive</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">,</span> <span class="k">enum</span> <span class="n">swim_state</span> <span class="n">state</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">interruptible</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;-&gt; grab drive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">idle</span> <span class="o">&amp;&amp;</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">available</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">wanted</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">available</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">interruptible</span> <span class="o">&amp;&amp;</span> <span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">wanted</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="o">--</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">wanted</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_drive</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">swim3_dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;-&gt; release drive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
	<span class="n">start_request</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fd_eject</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">grab_drive</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">ejecting</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">swim3_action</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">EJECT</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">swim3_select</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">swim3_readbit</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">DISK_IN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">swim3_select</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">ejected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">release_drive</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">floppy_struct</span> <span class="n">floppy_type</span> <span class="o">=</span>
	<span class="p">{</span> <span class="mi">2880</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1B</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xCF</span><span class="p">,</span><span class="mh">0x6C</span><span class="p">,</span><span class="nb">NULL</span> <span class="p">};</span>	<span class="cm">/*  7 1.44MB 3.5&quot;   */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">floppy_locked_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span> <span class="o">&amp;&amp;</span>
	    <span class="n">check_media_bay</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MB_FD</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FDEJECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">fd_eject</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDGETPRM</span>:
	        <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">floppy_type</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_struct</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">floppy_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">floppy_locked_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">floppy_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span> <span class="o">&amp;&amp;</span>
		    <span class="n">check_media_bay</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MB_FD</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">,</span> <span class="n">S_IBM_DRIVE</span> <span class="o">|</span> <span class="n">S_FCLK_DIV2</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bic</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bis</span><span class="p">,</span> <span class="n">DRIVE_ENABLE</span> <span class="o">|</span> <span class="n">INTR_ENABLE</span><span class="p">);</span>
		<span class="n">swim3_action</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MOTOR_ON</span><span class="p">);</span>
		<span class="n">fs</span><span class="o">-&gt;</span><span class="n">write_prot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">30</span> <span class="o">&amp;&amp;</span> <span class="n">swim3_readbit</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">SEEK_COMPLETE</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">swim3_select</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">swim3_readbit</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">SEEK_COMPLETE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
				 <span class="o">||</span> <span class="n">swim3_readbit</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">DISK_IN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="n">swim3_action</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">SETMFM</span><span class="p">);</span>
		<span class="n">swim3_select</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_EXCL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_NDELAY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FMODE_READ</span><span class="o">|</span><span class="n">FMODE_WRITE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">check_disk_change</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ejected</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">write_prot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fs</span><span class="o">-&gt;</span><span class="n">write_prot</span> <span class="o">=</span> <span class="n">swim3_readbit</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">WRITE_PROT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">write_prot</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">swim3_action</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MOTOR_OFF</span><span class="p">);</span>
			<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bic</span><span class="p">,</span> <span class="n">DRIVE_ENABLE</span> <span class="o">|</span> <span class="n">INTR_ENABLE</span><span class="p">);</span>
			<span class="n">swim3_select</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_EXCL</span><span class="p">)</span>
		<span class="n">fs</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">++</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">floppy_unlocked_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">floppy_open</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">floppy_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swim3_action</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MOTOR_OFF</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bic</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">swim3_select</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">floppy_check_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clearing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">ejected</span> <span class="o">?</span> <span class="n">DISK_EVENT_MEDIA_CHANGE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">floppy_revalidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span> <span class="o">&amp;&amp;</span>
	    <span class="n">check_media_bay</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MB_FD</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">sw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">;</span>
	<span class="n">grab_drive</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">revalidating</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">control_bis</span><span class="p">,</span> <span class="n">DRIVE_ENABLE</span><span class="p">);</span>
	<span class="n">swim3_action</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MOTOR_ON</span><span class="p">);</span>	<span class="cm">/* necessary? */</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">write_prot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">swim3_readbit</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">SEEK_COMPLETE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">swim3_select</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">swim3_readbit</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">SEEK_COMPLETE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
		<span class="o">||</span> <span class="n">swim3_readbit</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">DISK_IN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">swim3_action</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MOTOR_OFF</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">fs</span><span class="o">-&gt;</span><span class="n">ejected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">swim3_action</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">SETMFM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">swim3_select</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">RELAX</span><span class="p">);</span>

	<span class="n">release_drive</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">floppy_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">floppy_unlocked_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">floppy_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">floppy_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_events</span>	<span class="o">=</span> <span class="n">floppy_check_events</span><span class="p">,</span>
	<span class="p">.</span><span class="n">revalidate_disk</span><span class="o">=</span> <span class="n">floppy_revalidate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">swim3_mb_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">macio_dev</span><span class="o">*</span> <span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mb_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="n">macio_get_drvdata</span><span class="p">(</span><span class="n">mdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fs</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mb_state</span> <span class="o">!=</span> <span class="n">MB_FD</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Clear state */</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">);</span>
	<span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">swim3_add_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">macio_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">swim</span> <span class="o">=</span> <span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">floppy_state</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">floppy_states</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Do this first for message macros */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fs</span><span class="p">));</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">mdev</span> <span class="o">=</span> <span class="n">mdev</span><span class="p">;</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="cm">/* Check &amp; Request resources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio_resource_count</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;No address in device-tree</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio_irq_count</span><span class="p">(</span><span class="n">mdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;No interrupt in device-tree</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio_request_resource</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;swim3 (mmio)&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Can&#39;t request mmio resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio_request_resource</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;swim3 (dma)&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Can&#39;t request dma resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">macio_release_resource</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">ofdev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">fs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pmac_call_feature</span><span class="p">(</span><span class="n">PMAC_FTR_SWIM3_ENABLE</span><span class="p">,</span> <span class="n">swim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">swim3</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">ioremap</span><span class="p">(</span><span class="n">macio_resource_start</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x200</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t map mmio registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">ioremap</span><span class="p">(</span><span class="n">macio_resource_start</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mh">0x200</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t map dma registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3_intr</span> <span class="o">=</span> <span class="n">macio_irq</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">dma_intr</span> <span class="o">=</span> <span class="n">macio_irq</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_cyl</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">cur_sector</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">secpercyl</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">secpertrack</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">total_secs</span> <span class="o">=</span> <span class="mi">2880</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">fs</span><span class="o">-&gt;</span><span class="n">dma_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbdma_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">DBDMA_ALIGN</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">dbdma_cmd_space</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">dma_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbdma_cmd</span><span class="p">));</span>
	<span class="n">st_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">dma_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">command</span><span class="p">,</span> <span class="n">DBDMA_STOP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">check_media_bay</span><span class="p">(</span><span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span><span class="p">)</span> <span class="o">==</span> <span class="n">MB_FD</span><span class="p">)</span>
		<span class="n">swim3_mb_event</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">MB_FD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3_intr</span><span class="p">,</span> <span class="n">swim3_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;SWIM3&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">swim3_err</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t request interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pmac_call_feature</span><span class="p">(</span><span class="n">PMAC_FTR_SWIM3_ENABLE</span><span class="p">,</span> <span class="n">swim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unmap</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>

	<span class="n">swim3_info</span><span class="p">(</span><span class="s">&quot;SWIM3 floppy controller %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mdev</span><span class="o">-&gt;</span><span class="n">media_bay</span> <span class="o">?</span> <span class="s">&quot;in media bay&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">swim3</span><span class="p">);</span>

 <span class="nl">out_release:</span>
	<span class="n">macio_release_resource</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">macio_release_resource</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">swim3_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">macio_dev</span> <span class="o">*</span><span class="n">mdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="o">*</span><span class="n">match</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">floppy_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">MAX_FLOPPIES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* Add the drive */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">swim3_add_device</span><span class="p">(</span><span class="n">mdev</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* Now register that disk. Same comment about failure handling */</span>
	<span class="n">disk</span> <span class="o">=</span> <span class="n">disks</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">blk_init_queue</span><span class="p">(</span><span class="n">do_fd_request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">swim3_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">queuedata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">floppy_states</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we failed, there isn&#39;t much we can do as the driver is still</span>
<span class="cm">		 * too dumb to remove the device, just bail out</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">register_blkdev</span><span class="p">(</span><span class="n">FLOPPY_MAJOR</span><span class="p">,</span> <span class="s">&quot;fd&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">FLOPPY_MAJOR</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">floppy_fops</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">floppy_states</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">GENHD_FL_REMOVABLE</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="s">&quot;fd%d&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">set_capacity</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="mi">2880</span><span class="p">);</span>
	<span class="n">add_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">swim3_match</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;swim3&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	<span class="p">.</span><span class="n">compatible</span>	<span class="o">=</span> <span class="s">&quot;ohare-swim3&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span>
	<span class="p">.</span><span class="n">compatible</span>	<span class="o">=</span> <span class="s">&quot;swim3&quot;</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* end of list */</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">macio_driver</span> <span class="n">swim3_driver</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> 		<span class="o">=</span> <span class="s">&quot;swim3&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span>	<span class="o">=</span> <span class="n">swim3_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">swim3_attach</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PMAC_MEDIABAY</span>
	<span class="p">.</span><span class="n">mediabay_event</span>	<span class="o">=</span> <span class="n">swim3_mb_event</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	.suspend	= swim3_suspend,</span>
<span class="c">	.resume		= swim3_resume,</span>
<span class="cp">#endif</span>
<span class="p">};</span>


<span class="kt">int</span> <span class="nf">swim3_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">macio_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swim3_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">swim3_init</span><span class="p">)</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Paul Mackerras&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_BLOCKDEV_MAJOR</span><span class="p">(</span><span class="n">FLOPPY_MAJOR</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
