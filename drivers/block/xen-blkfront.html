<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › xen-blkfront.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>xen-blkfront.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * blkfront.c</span>
<span class="cm"> *</span>
<span class="cm"> * XenLinux virtual block device driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2003-2004, Keir Fraser &amp; Steve Hand</span>
<span class="cm"> * Modifications by Mark A. Williamson are (c) Intel Research Cambridge</span>
<span class="cm"> * Copyright (c) 2004, Christian Limpach</span>
<span class="cm"> * Copyright (c) 2004, Andrew Warfield</span>
<span class="cm"> * Copyright (c) 2005, Christopher Clark</span>
<span class="cm"> * Copyright (c) 2005, XenSource Ltd</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version 2</span>
<span class="cm"> * as published by the Free Software Foundation; or, when distributed</span>
<span class="cm"> * separately from the Linux kernel or incorporated into other</span>
<span class="cm"> * software packages, subject to the following license:</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm"> * of this source file (the &quot;Software&quot;), to deal in the Software without</span>
<span class="cm"> * restriction, including without limitation the rights to use, copy, modify,</span>
<span class="cm"> * merge, publish, distribute, sublicense, and/or sell copies of the Software,</span>
<span class="cm"> * and to permit persons to whom the Software is furnished to do so, subject to</span>
<span class="cm"> * the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice shall be included in</span>
<span class="cm"> * all copies or substantial portions of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm"> * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="cm"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS</span>
<span class="cm"> * IN THE SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/cdrom.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/bitmap.h&gt;</span>

<span class="cp">#include &lt;xen/xen.h&gt;</span>
<span class="cp">#include &lt;xen/xenbus.h&gt;</span>
<span class="cp">#include &lt;xen/grant_table.h&gt;</span>
<span class="cp">#include &lt;xen/events.h&gt;</span>
<span class="cp">#include &lt;xen/page.h&gt;</span>
<span class="cp">#include &lt;xen/platform_pci.h&gt;</span>

<span class="cp">#include &lt;xen/interface/grant_table.h&gt;</span>
<span class="cp">#include &lt;xen/interface/io/blkif.h&gt;</span>
<span class="cp">#include &lt;xen/interface/io/protocols.h&gt;</span>

<span class="cp">#include &lt;asm/xen/hypervisor.h&gt;</span>

<span class="k">enum</span> <span class="n">blkif_state</span> <span class="p">{</span>
	<span class="n">BLKIF_STATE_DISCONNECTED</span><span class="p">,</span>
	<span class="n">BLKIF_STATE_CONNECTED</span><span class="p">,</span>
	<span class="n">BLKIF_STATE_SUSPENDED</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">blk_shadow</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">blkif_request</span> <span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">frame</span><span class="p">[</span><span class="n">BLKIF_MAX_SEGMENTS_PER_REQUEST</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">blkfront_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">xlvbd_block_fops</span><span class="p">;</span>

<span class="cp">#define BLK_RING_SIZE __CONST_RING_SIZE(blkif, PAGE_SIZE)</span>

<span class="cm">/*</span>
<span class="cm"> * We have one of these per vbd, whether ide, scsi or &#39;other&#39;.  They</span>
<span class="cm"> * hang in private_data off the gendisk structure. We may end up</span>
<span class="cm"> * putting all kinds of interesting stuff here :-)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">blkfront_info</span>
<span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">io_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xenbus_device</span> <span class="o">*</span><span class="n">xbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">gd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vdevice</span><span class="p">;</span>
	<span class="n">blkif_vdev_t</span> <span class="n">handle</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">blkif_state</span> <span class="n">connected</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ring_ref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blkif_front_ring</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">[</span><span class="n">BLKIF_MAX_SEGMENTS_PER_REQUEST</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">evtchn</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gnttab_free_callback</span> <span class="n">callback</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blk_shadow</span> <span class="n">shadow</span><span class="p">[</span><span class="n">BLK_RING_SIZE</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">shadow_free</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">feature_flush</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flush_op</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">feature_discard</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">feature_secdiscard</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">discard_granularity</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">discard_alignment</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_ready</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_minors</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">minors</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">minor_lock</span><span class="p">);</span>

<span class="cp">#define MAXIMUM_OUTSTANDING_BLOCK_REQS \</span>
<span class="cp">	(BLKIF_MAX_SEGMENTS_PER_REQUEST * BLK_RING_SIZE)</span>
<span class="cp">#define GRANT_INVALID_REF	0</span>

<span class="cp">#define PARTS_PER_DISK		16</span>
<span class="cp">#define PARTS_PER_EXT_DISK      256</span>

<span class="cp">#define BLKIF_MAJOR(dev) ((dev)&gt;&gt;8)</span>
<span class="cp">#define BLKIF_MINOR(dev) ((dev) &amp; 0xff)</span>

<span class="cp">#define EXT_SHIFT 28</span>
<span class="cp">#define EXTENDED (1&lt;&lt;EXT_SHIFT)</span>
<span class="cp">#define VDEV_IS_EXTENDED(dev) ((dev)&amp;(EXTENDED))</span>
<span class="cp">#define BLKIF_MINOR_EXT(dev) ((dev)&amp;(~EXTENDED))</span>
<span class="cp">#define EMULATED_HD_DISK_MINOR_OFFSET (0)</span>
<span class="cp">#define EMULATED_HD_DISK_NAME_OFFSET (EMULATED_HD_DISK_MINOR_OFFSET / 256)</span>
<span class="cp">#define EMULATED_SD_DISK_MINOR_OFFSET (0)</span>
<span class="cp">#define EMULATED_SD_DISK_NAME_OFFSET (EMULATED_SD_DISK_MINOR_OFFSET / 256)</span>

<span class="cp">#define DEV_NAME	&quot;xvd&quot;	</span><span class="cm">/* name in /dev */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_id_from_freelist</span><span class="p">(</span><span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">free</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow_free</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">free</span> <span class="o">&gt;=</span> <span class="n">BLK_RING_SIZE</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow_free</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">free</span><span class="p">].</span><span class="n">req</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">free</span><span class="p">].</span><span class="n">req</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x0fffffee</span><span class="p">;</span> <span class="cm">/* debug */</span>
	<span class="k">return</span> <span class="n">free</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_id_to_freelist</span><span class="p">(</span><span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">req</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">id</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">req</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">id</span>  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow_free</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow_free</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">op_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">BLKIF_OP_READ</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;read&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">BLKIF_OP_WRITE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;write&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">BLKIF_OP_WRITE_BARRIER</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;barrier&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">BLKIF_OP_FLUSH_DISKCACHE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;flush&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="n">BLKIF_OP_DISCARD</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;discard&quot;</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">op</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>
		<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">names</span><span class="p">[</span><span class="n">op</span><span class="p">])</span>
		<span class="k">return</span> <span class="s">&quot;reserved&quot;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">names</span><span class="p">[</span><span class="n">op</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xlbd_reserve_minors</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minor</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="n">minor</span> <span class="o">+</span> <span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">nr_minors</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>

		<span class="n">bitmap</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">end</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bitmap</span><span class="p">),</span>
				 <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minor_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">nr_minors</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">old</span> <span class="o">=</span> <span class="n">minors</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">minors</span><span class="p">,</span>
			       <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">nr_minors</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bitmap</span><span class="p">));</span>
			<span class="n">minors</span> <span class="o">=</span> <span class="n">bitmap</span><span class="p">;</span>
			<span class="n">nr_minors</span> <span class="o">=</span> <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">*</span> <span class="n">BITS_PER_LONG</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">old</span> <span class="o">=</span> <span class="n">bitmap</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minor_lock</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minor_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">find_next_bit</span><span class="p">(</span><span class="n">minors</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">minor</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bitmap_set</span><span class="p">(</span><span class="n">minors</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minor_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xlbd_release_minors</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minor</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="n">minor</span> <span class="o">+</span> <span class="n">nr</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">nr_minors</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minor_lock</span><span class="p">);</span>
	<span class="n">bitmap_clear</span><span class="p">(</span><span class="n">minors</span><span class="p">,</span>  <span class="n">minor</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minor_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blkif_restart_queue_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blkif_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">hg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We don&#39;t have real geometry info, but let&#39;s at least return</span>
<span class="cm">	   values consistent with the size of the device */</span>
	<span class="n">sector_t</span> <span class="n">nsect</span> <span class="o">=</span> <span class="n">get_capacity</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">);</span>
	<span class="n">sector_t</span> <span class="n">cylinders</span> <span class="o">=</span> <span class="n">nsect</span><span class="p">;</span>

	<span class="n">hg</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">hg</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">cylinders</span><span class="p">,</span> <span class="n">hg</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">*</span> <span class="n">hg</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">);</span>
	<span class="n">hg</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">cylinders</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sector_t</span><span class="p">)(</span><span class="n">hg</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">hg</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">*</span> <span class="n">hg</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">&lt;</span> <span class="n">nsect</span><span class="p">)</span>
		<span class="n">hg</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blkif_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="n">command</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">argument</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;command: 0x%x, argument: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">argument</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CDROMMULTISESSION</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FIXME: support multisession CDs later</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_multisession</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">argument</span> <span class="o">+</span> <span class="n">i</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CDROM_GET_CAPABILITY</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">gd</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GENHD_FL_CD</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="cm">/*printk(KERN_ALERT &quot;ioctl %08x not supported by Xen blkdev\n&quot;,</span>
<span class="cm">		  command);*/</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* same return as native Linux */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Generate a Xen blkfront IO request from a blk layer request.  Reads</span>
<span class="cm"> * and writes are handled as expected.</span>
<span class="cm"> *</span>
<span class="cm"> * @req: a request struct</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">blkif_queue_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buffer_mfn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blkif_request</span> <span class="o">*</span><span class="n">ring_req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fsect</span><span class="p">,</span> <span class="n">lsect</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ref</span><span class="p">;</span>
	<span class="n">grant_ref_t</span> <span class="n">gref_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">!=</span> <span class="n">BLKIF_STATE_CONNECTED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gnttab_alloc_grant_references</span><span class="p">(</span>
		<span class="n">BLKIF_MAX_SEGMENTS_PER_REQUEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gref_head</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gnttab_request_free_callback</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">,</span>
			<span class="n">blkif_restart_queue_callback</span><span class="p">,</span>
			<span class="n">info</span><span class="p">,</span>
			<span class="n">BLKIF_MAX_SEGMENTS_PER_REQUEST</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill out a communications ring structure. */</span>
	<span class="n">ring_req</span> <span class="o">=</span> <span class="n">RING_GET_REQUEST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">req_prod_pvt</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">get_id_from_freelist</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">request</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>

	<span class="n">ring_req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">ring_req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">sector_number</span> <span class="o">=</span> <span class="p">(</span><span class="n">blkif_sector_t</span><span class="p">)</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">ring_req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>

	<span class="n">ring_req</span><span class="o">-&gt;</span><span class="n">operation</span> <span class="o">=</span> <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">BLKIF_OP_WRITE</span> <span class="o">:</span> <span class="n">BLKIF_OP_READ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">REQ_FLUSH</span> <span class="o">|</span> <span class="n">REQ_FUA</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Ideally we can do an unordered flush-to-disk. In case the</span>
<span class="cm">		 * backend onlysupports barriers, use that. A barrier request</span>
<span class="cm">		 * a superset of FUA, so we can implement it the same</span>
<span class="cm">		 * way.  (It&#39;s also a FLUSH+FUA, since it is</span>
<span class="cm">		 * guaranteed ordered WRT previous writes.)</span>
<span class="cm">		 */</span>
		<span class="n">ring_req</span><span class="o">-&gt;</span><span class="n">operation</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">flush_op</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">REQ_DISCARD</span> <span class="o">|</span> <span class="n">REQ_SECURE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* id, sector_number and handle are set above. */</span>
		<span class="n">ring_req</span><span class="o">-&gt;</span><span class="n">operation</span> <span class="o">=</span> <span class="n">BLKIF_OP_DISCARD</span><span class="p">;</span>
		<span class="n">ring_req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">nr_sectors</span> <span class="o">=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">REQ_SECURE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">feature_secdiscard</span><span class="p">)</span>
			<span class="n">ring_req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">BLKIF_DISCARD_SECURE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ring_req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ring_req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">nr_segments</span> <span class="o">=</span> <span class="n">blk_rq_map_sg</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span>
							   <span class="n">info</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ring_req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">nr_segments</span> <span class="o">&gt;</span>
		       <span class="n">BLKIF_MAX_SEGMENTS_PER_REQUEST</span><span class="p">);</span>

		<span class="n">for_each_sg</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">ring_req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">nr_segments</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buffer_mfn</span> <span class="o">=</span> <span class="n">pfn_to_mfn</span><span class="p">(</span><span class="n">page_to_pfn</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">)));</span>
			<span class="n">fsect</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
			<span class="n">lsect</span> <span class="o">=</span> <span class="n">fsect</span> <span class="o">+</span> <span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* install a grant reference. */</span>
			<span class="n">ref</span> <span class="o">=</span> <span class="n">gnttab_claim_grant_reference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gref_head</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ref</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>

			<span class="n">gnttab_grant_foreign_access_ref</span><span class="p">(</span>
					<span class="n">ref</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">otherend_id</span><span class="p">,</span>
					<span class="n">buffer_mfn</span><span class="p">,</span>
					<span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>

			<span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfn_to_pfn</span><span class="p">(</span><span class="n">buffer_mfn</span><span class="p">);</span>
			<span class="n">ring_req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">seg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">blkif_request_segment</span><span class="p">)</span> <span class="p">{</span>
						<span class="p">.</span><span class="n">gref</span>       <span class="o">=</span> <span class="n">ref</span><span class="p">,</span>
						<span class="p">.</span><span class="n">first_sect</span> <span class="o">=</span> <span class="n">fsect</span><span class="p">,</span>
						<span class="p">.</span><span class="n">last_sect</span>  <span class="o">=</span> <span class="n">lsect</span> <span class="p">};</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">req_prod_pvt</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Keep a private copy so we can reissue requests when recovering. */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">req</span> <span class="o">=</span> <span class="o">*</span><span class="n">ring_req</span><span class="p">;</span>

	<span class="n">gnttab_free_grant_references</span><span class="p">(</span><span class="n">gref_head</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">flush_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">notify</span><span class="p">;</span>

	<span class="n">RING_PUSH_REQUESTS_AND_CHECK_NOTIFY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="n">notify</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify</span><span class="p">)</span>
		<span class="n">notify_remote_via_irq</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * do_blkif_request</span>
<span class="cm"> *  read a block; request is in a request queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_blkif_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">queued</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Entered do_blkif_request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">req</span> <span class="o">=</span> <span class="n">blk_peek_request</span><span class="p">(</span><span class="n">rq</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RING_FULL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">wait</span><span class="p">;</span>

		<span class="n">blk_start_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">REQ_FLUSH</span> <span class="o">|</span> <span class="n">REQ_FUA</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flush_op</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">__blk_end_request_all</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;do_blk_req %p: cmd %p, sec %lx, &quot;</span>
			 <span class="s">&quot;(%u/%u) buffer:%p [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
			 <span class="n">blk_rq_cur_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
			 <span class="n">req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">blkif_queue_request</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">blk_requeue_request</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">wait:</span>
			<span class="cm">/* Avoid pointless unplugs. */</span>
			<span class="n">blk_stop_queue</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">queued</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queued</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">flush_requests</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xlvbd_init_blk_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">gd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sector_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">gd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">rq</span> <span class="o">=</span> <span class="n">blk_init_queue</span><span class="p">(</span><span class="n">do_blkif_request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">queue_flag_set_unlocked</span><span class="p">(</span><span class="n">QUEUE_FLAG_VIRT</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">feature_discard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue_flag_set_unlocked</span><span class="p">(</span><span class="n">QUEUE_FLAG_DISCARD</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
		<span class="n">blk_queue_max_discard_sectors</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">get_capacity</span><span class="p">(</span><span class="n">gd</span><span class="p">));</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">discard_granularity</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">discard_granularity</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">.</span><span class="n">discard_alignment</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">discard_alignment</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">feature_secdiscard</span><span class="p">)</span>
			<span class="n">queue_flag_set_unlocked</span><span class="p">(</span><span class="n">QUEUE_FLAG_SECDISCARD</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Hard sector size and max sectors impersonate the equiv. hardware. */</span>
	<span class="n">blk_queue_logical_block_size</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">sector_size</span><span class="p">);</span>
	<span class="n">blk_queue_max_hw_sectors</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>

	<span class="cm">/* Each segment in a request is up to an aligned page in size. */</span>
	<span class="n">blk_queue_segment_boundary</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">blk_queue_max_segment_size</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="cm">/* Ensure a merged request will fit in a single I/O ring slot. */</span>
	<span class="n">blk_queue_max_segments</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">BLKIF_MAX_SEGMENTS_PER_REQUEST</span><span class="p">);</span>

	<span class="cm">/* Make sure buffer addresses are sector-aligned. */</span>
	<span class="n">blk_queue_dma_alignment</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="mi">511</span><span class="p">);</span>

	<span class="cm">/* Make sure we don&#39;t use bounce buffers. */</span>
	<span class="n">blk_queue_bounce_limit</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">BLK_BOUNCE_ANY</span><span class="p">);</span>

	<span class="n">gd</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">rq</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">xlvbd_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_queue_flush</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">feature_flush</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;blkfront: %s: %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">flush_op</span> <span class="o">==</span> <span class="n">BLKIF_OP_WRITE_BARRIER</span> <span class="o">?</span>
		<span class="s">&quot;barrier&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flush_op</span> <span class="o">==</span> <span class="n">BLKIF_OP_FLUSH_DISKCACHE</span> <span class="o">?</span>
		<span class="s">&quot;flush diskcache&quot;</span> <span class="o">:</span> <span class="s">&quot;barrier or flush&quot;</span><span class="p">),</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">feature_flush</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xen_translate_vdev</span><span class="p">(</span><span class="kt">int</span> <span class="n">vdevice</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">minor</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">major</span><span class="p">;</span>
	<span class="n">major</span> <span class="o">=</span> <span class="n">BLKIF_MAJOR</span><span class="p">(</span><span class="n">vdevice</span><span class="p">);</span>
	<span class="o">*</span><span class="n">minor</span> <span class="o">=</span> <span class="n">BLKIF_MINOR</span><span class="p">(</span><span class="n">vdevice</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">major</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">XEN_IDE0_MAJOR</span>:
			<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">minor</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">+</span> <span class="n">EMULATED_HD_DISK_NAME_OFFSET</span><span class="p">;</span>
			<span class="o">*</span><span class="n">minor</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">minor</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">*</span> <span class="n">PARTS_PER_DISK</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">EMULATED_HD_DISK_MINOR_OFFSET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XEN_IDE1_MAJOR</span>:
			<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">minor</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">EMULATED_HD_DISK_NAME_OFFSET</span><span class="p">;</span>
			<span class="o">*</span><span class="n">minor</span> <span class="o">=</span> <span class="p">(((</span><span class="o">*</span><span class="n">minor</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">PARTS_PER_DISK</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">EMULATED_HD_DISK_MINOR_OFFSET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK0_MAJOR</span>:
			<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">minor</span> <span class="o">/</span> <span class="n">PARTS_PER_DISK</span><span class="p">)</span> <span class="o">+</span> <span class="n">EMULATED_SD_DISK_NAME_OFFSET</span><span class="p">;</span>
			<span class="o">*</span><span class="n">minor</span> <span class="o">=</span> <span class="o">*</span><span class="n">minor</span> <span class="o">+</span> <span class="n">EMULATED_SD_DISK_MINOR_OFFSET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK1_MAJOR</span>:
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK2_MAJOR</span>:
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK3_MAJOR</span>:
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK4_MAJOR</span>:
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK5_MAJOR</span>:
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK6_MAJOR</span>:
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK7_MAJOR</span>:
			<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">minor</span> <span class="o">/</span> <span class="n">PARTS_PER_DISK</span><span class="p">)</span> <span class="o">+</span> 
				<span class="p">((</span><span class="n">major</span> <span class="o">-</span> <span class="n">XEN_SCSI_DISK1_MAJOR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">EMULATED_SD_DISK_NAME_OFFSET</span><span class="p">;</span>
			<span class="o">*</span><span class="n">minor</span> <span class="o">=</span> <span class="o">*</span><span class="n">minor</span> <span class="o">+</span>
				<span class="p">((</span><span class="n">major</span> <span class="o">-</span> <span class="n">XEN_SCSI_DISK1_MAJOR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">PARTS_PER_DISK</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">EMULATED_SD_DISK_MINOR_OFFSET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK8_MAJOR</span>:
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK9_MAJOR</span>:
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK10_MAJOR</span>:
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK11_MAJOR</span>:
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK12_MAJOR</span>:
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK13_MAJOR</span>:
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK14_MAJOR</span>:
		<span class="k">case</span> <span class="n">XEN_SCSI_DISK15_MAJOR</span>:
			<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">minor</span> <span class="o">/</span> <span class="n">PARTS_PER_DISK</span><span class="p">)</span> <span class="o">+</span> 
				<span class="p">((</span><span class="n">major</span> <span class="o">-</span> <span class="n">XEN_SCSI_DISK8_MAJOR</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">EMULATED_SD_DISK_NAME_OFFSET</span><span class="p">;</span>
			<span class="o">*</span><span class="n">minor</span> <span class="o">=</span> <span class="o">*</span><span class="n">minor</span> <span class="o">+</span>
				<span class="p">((</span><span class="n">major</span> <span class="o">-</span> <span class="n">XEN_SCSI_DISK8_MAJOR</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">PARTS_PER_DISK</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">EMULATED_SD_DISK_MINOR_OFFSET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XENVBD_MAJOR</span>:
			<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="o">*</span><span class="n">minor</span> <span class="o">/</span> <span class="n">PARTS_PER_DISK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;blkfront: your disk configuration is &quot;</span>
					<span class="s">&quot;incorrect, please use an xvd device instead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">encode_disk_name</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">26</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">encode_disk_name</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">26</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">26</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xlvbd_alloc_gendisk</span><span class="p">(</span><span class="n">blkif_sector_t</span> <span class="n">capacity</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">vdisk_info</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sector_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">gd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_minors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">minor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_parts</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vdevice</span><span class="o">&gt;&gt;</span><span class="n">EXT_SHIFT</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* this is above the extended range; something is wrong */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;blkfront: vdevice 0x%x is above the extended range; ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">vdevice</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">VDEV_IS_EXTENDED</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vdevice</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">xen_translate_vdev</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vdevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>		
 		<span class="n">nr_parts</span> <span class="o">=</span> <span class="n">PARTS_PER_DISK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">minor</span> <span class="o">=</span> <span class="n">BLKIF_MINOR_EXT</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vdevice</span><span class="p">);</span>
		<span class="n">nr_parts</span> <span class="o">=</span> <span class="n">PARTS_PER_EXT_DISK</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">minor</span> <span class="o">/</span> <span class="n">nr_parts</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xen_hvm_domain</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">EMULATED_HD_DISK_NAME_OFFSET</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;blkfront: vdevice 0x%x might conflict with &quot;</span>
					<span class="s">&quot;emulated IDE disks,</span><span class="se">\n\t</span><span class="s"> choose an xvd device name&quot;</span>
					<span class="s">&quot;from xvde on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">vdevice</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">&gt;&gt;</span> <span class="n">MINORBITS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;blkfront: %#x&#39;s minor (%#x) out of range; ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">vdevice</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">minor</span> <span class="o">%</span> <span class="n">nr_parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nr_minors</span> <span class="o">=</span> <span class="n">nr_parts</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xlbd_reserve_minors</span><span class="p">(</span><span class="n">minor</span><span class="p">,</span> <span class="n">nr_minors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">gd</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="n">nr_minors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">DEV_NAME</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">encode_disk_name</span><span class="p">(</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">disk_name</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DEV_NAME</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="n">gd</span><span class="o">-&gt;</span><span class="n">disk_name</span> <span class="o">+</span> <span class="n">DISK_NAME_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_minors</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">gd</span><span class="o">-&gt;</span><span class="n">disk_name</span> <span class="o">+</span> <span class="n">DISK_NAME_LEN</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">,</span>
			 <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">minor</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nr_parts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">gd</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">XENVBD_MAJOR</span><span class="p">;</span>
	<span class="n">gd</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="n">minor</span><span class="p">;</span>
	<span class="n">gd</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xlvbd_block_fops</span><span class="p">;</span>
	<span class="n">gd</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">gd</span><span class="o">-&gt;</span><span class="n">driverfs_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">set_capacity</span><span class="p">(</span><span class="n">gd</span><span class="p">,</span> <span class="n">capacity</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xlvbd_init_blk_queue</span><span class="p">(</span><span class="n">gd</span><span class="p">,</span> <span class="n">sector_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">del_gendisk</span><span class="p">(</span><span class="n">gd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">=</span> <span class="n">gd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span> <span class="o">=</span> <span class="n">gd</span><span class="p">;</span>

	<span class="n">xlvbd_flush</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdisk_info</span> <span class="o">&amp;</span> <span class="n">VDISK_READONLY</span><span class="p">)</span>
		<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">gd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdisk_info</span> <span class="o">&amp;</span> <span class="n">VDISK_REMOVABLE</span><span class="p">)</span>
		<span class="n">gd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">GENHD_FL_REMOVABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdisk_info</span> <span class="o">&amp;</span> <span class="n">VDISK_CDROM</span><span class="p">)</span>
		<span class="n">gd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">GENHD_FL_CD</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">release:</span>
	<span class="n">xlbd_release_minors</span><span class="p">(</span><span class="n">minor</span><span class="p">,</span> <span class="n">nr_minors</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xlvbd_release_gendisk</span><span class="p">(</span><span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minor</span><span class="p">,</span> <span class="n">nr_minors</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* No more blkif_request(). */</span>
	<span class="n">blk_stop_queue</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">);</span>

	<span class="cm">/* No more gnttab callback work. */</span>
	<span class="n">gnttab_cancel_free_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Flush gnttab callback work. Must be done with no locks held. */</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="n">del_gendisk</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">);</span>

	<span class="n">minor</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">first_minor</span><span class="p">;</span>
	<span class="n">nr_minors</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">minors</span><span class="p">;</span>
	<span class="n">xlbd_release_minors</span><span class="p">(</span><span class="n">minor</span><span class="p">,</span> <span class="n">nr_minors</span><span class="p">);</span>

	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">put_disk</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kick_pending_request_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RING_FULL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Re-enable calldowns. */</span>
		<span class="n">blk_start_queue</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">);</span>
		<span class="cm">/* Kick things off immediately. */</span>
		<span class="n">do_blkif_request</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blkif_restart_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">blkfront_info</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">==</span> <span class="n">BLKIF_STATE_CONNECTED</span><span class="p">)</span>
		<span class="n">kick_pending_request_queues</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blkif_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">suspend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Prevent new requests being issued until we fix things up. */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="n">suspend</span> <span class="o">?</span>
		<span class="n">BLKIF_STATE_SUSPENDED</span> <span class="o">:</span> <span class="n">BLKIF_STATE_DISCONNECTED</span><span class="p">;</span>
	<span class="cm">/* No more blkif_request(). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">)</span>
		<span class="n">blk_stop_queue</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">);</span>
	<span class="cm">/* No more gnttab callback work. */</span>
	<span class="n">gnttab_cancel_free_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="cm">/* Flush gnttab callback work. Must be done with no locks held. */</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="cm">/* Free resources associated with old device channel. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ring_ref</span> <span class="o">!=</span> <span class="n">GRANT_INVALID_REF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gnttab_end_foreign_access</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ring_ref</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">sring</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ring_ref</span> <span class="o">=</span> <span class="n">GRANT_INVALID_REF</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">sring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">unbind_from_irqhandler</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">evtchn</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blkif_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">blk_shadow</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* Do not let BLKIF_OP_DISCARD as nr_segment is in the same place</span>
<span class="cm">	 * flag. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">nr_segments</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">gnttab_end_foreign_access</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">seg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gref</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0UL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">blkif_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blkif_response</span> <span class="o">*</span><span class="n">bret</span><span class="p">;</span>
	<span class="n">RING_IDX</span> <span class="n">i</span><span class="p">,</span> <span class="n">rp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">!=</span> <span class="n">BLKIF_STATE_CONNECTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">again:</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">sring</span><span class="o">-&gt;</span><span class="n">rsp_prod</span><span class="p">;</span>
	<span class="n">rmb</span><span class="p">();</span> <span class="cm">/* Ensure we see queued responses up to &#39;rp&#39;. */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">rsp_cons</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">rp</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">id</span><span class="p">;</span>

		<span class="n">bret</span> <span class="o">=</span> <span class="n">RING_GET_RESPONSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">id</span>   <span class="o">=</span> <span class="n">bret</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * The backend has messed up and given us an id that we would</span>
<span class="cm">		 * never have given to it (we stamp it up to BLK_RING_SIZE -</span>
<span class="cm">		 * look in get_id_from_freelist.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">BLK_RING_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: response to %s has incorrect id (%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">op_name</span><span class="p">(</span><span class="n">bret</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">),</span> <span class="n">id</span><span class="p">);</span>
			<span class="cm">/* We can&#39;t safely get the &#39;struct request&#39; as</span>
<span class="cm">			 * the id is busted. */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">req</span>  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">request</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bret</span><span class="o">-&gt;</span><span class="n">operation</span> <span class="o">!=</span> <span class="n">BLKIF_OP_DISCARD</span><span class="p">)</span>
			<span class="n">blkif_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">add_id_to_freelist</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: response to %s (id %ld) couldn&#39;t be recycled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">op_name</span><span class="p">(</span><span class="n">bret</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">),</span> <span class="n">id</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">bret</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">BLKIF_RSP_OKAY</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">bret</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BLKIF_OP_DISCARD</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bret</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">BLKIF_RSP_EOPNOTSUPP</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;blkfront: %s: %s op failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">op_name</span><span class="p">(</span><span class="n">bret</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">));</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">feature_discard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">feature_secdiscard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">queue_flag_clear</span><span class="p">(</span><span class="n">QUEUE_FLAG_DISCARD</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
				<span class="n">queue_flag_clear</span><span class="p">(</span><span class="n">QUEUE_FLAG_SECDISCARD</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">__blk_end_request_all</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BLKIF_OP_FLUSH_DISKCACHE</span>:
		<span class="k">case</span> <span class="n">BLKIF_OP_WRITE_BARRIER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bret</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">BLKIF_RSP_EOPNOTSUPP</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;blkfront: %s: %s op failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">op_name</span><span class="p">(</span><span class="n">bret</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">));</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bret</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">BLKIF_RSP_ERROR</span> <span class="o">&amp;&amp;</span>
				     <span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">req</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">nr_segments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;blkfront: %s: empty %s op failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">op_name</span><span class="p">(</span><span class="n">bret</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">));</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span>
					<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">feature_flush</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">flush_op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">xlvbd_flush</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">BLKIF_OP_READ</span>:
		<span class="k">case</span> <span class="n">BLKIF_OP_WRITE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bret</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">BLKIF_RSP_OKAY</span><span class="p">))</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Bad return from blkdev data &quot;</span>
					<span class="s">&quot;request: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bret</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

			<span class="n">__blk_end_request_all</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">rsp_cons</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">req_prod_pvt</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">more_to_do</span><span class="p">;</span>
		<span class="n">RING_FINAL_CHECK_FOR_RESPONSES</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="n">more_to_do</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">more_to_do</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">sring</span><span class="o">-&gt;</span><span class="n">rsp_event</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">kick_pending_request_queues</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_blkring</span><span class="p">(</span><span class="k">struct</span> <span class="n">xenbus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blkif_sring</span> <span class="o">*</span><span class="n">sring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ring_ref</span> <span class="o">=</span> <span class="n">GRANT_INVALID_REF</span><span class="p">;</span>

	<span class="n">sring</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">blkif_sring</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_NOIO</span> <span class="o">|</span> <span class="n">__GFP_HIGH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xenbus_dev_fatal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span> <span class="s">&quot;allocating shared ring&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">SHARED_RING_INIT</span><span class="p">(</span><span class="n">sring</span><span class="p">);</span>
	<span class="n">FRONT_RING_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="n">sring</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">BLKIF_MAX_SEGMENTS_PER_REQUEST</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_grant_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">virt_to_mfn</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">sring</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sring</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">sring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ring_ref</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_alloc_evtchn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">evtchn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bind_evtchn_to_irqhandler</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">evtchn</span><span class="p">,</span>
					<span class="n">blkif_interrupt</span><span class="p">,</span>
					<span class="n">IRQF_SAMPLE_RANDOM</span><span class="p">,</span> <span class="s">&quot;blkif&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xenbus_dev_fatal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span>
				 <span class="s">&quot;bind_evtchn_to_irqhandler failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">blkif_free</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Common code used when first setting up, and when resuming. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">talk_to_blkback</span><span class="p">(</span><span class="k">struct</span> <span class="n">xenbus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xenbus_transaction</span> <span class="n">xbt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Create shared ring, alloc event channel. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">setup_blkring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">again:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_transaction_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xbt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xenbus_dev_fatal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s">&quot;starting transaction&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">destroy_blkring</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_printf</span><span class="p">(</span><span class="n">xbt</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span>
			    <span class="s">&quot;ring-ref&quot;</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ring_ref</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">message</span> <span class="o">=</span> <span class="s">&quot;writing ring-ref&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">abort_transaction</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_printf</span><span class="p">(</span><span class="n">xbt</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span>
			    <span class="s">&quot;event-channel&quot;</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">evtchn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">message</span> <span class="o">=</span> <span class="s">&quot;writing event-channel&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">abort_transaction</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_printf</span><span class="p">(</span><span class="n">xbt</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span> <span class="s">&quot;protocol&quot;</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			    <span class="n">XEN_IO_PROTO_ABI_NATIVE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">message</span> <span class="o">=</span> <span class="s">&quot;writing protocol&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">abort_transaction</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_transaction_end</span><span class="p">(</span><span class="n">xbt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="n">xenbus_dev_fatal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s">&quot;completing transaction&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">destroy_blkring</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xenbus_switch_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">XenbusStateInitialised</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">abort_transaction:</span>
	<span class="n">xenbus_transaction_end</span><span class="p">(</span><span class="n">xbt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="p">)</span>
		<span class="n">xenbus_dev_fatal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
 <span class="nl">destroy_blkring:</span>
	<span class="n">blkif_free</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Entry point to this code when a new device is created.  Allocate the basic</span>
<span class="cm"> * structures and the ring buffer for communication with the backend, and</span>
<span class="cm"> * inform the backend of the appropriate details for those.  Switch to</span>
<span class="cm"> * Initialised state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">blkfront_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">xenbus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">xenbus_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">vdevice</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="cm">/* FIXME: Use dynamic device id if this is not set. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_scanf</span><span class="p">(</span><span class="n">XBT_NIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span>
			   <span class="s">&quot;virtual-device&quot;</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdevice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* go looking in the extended area instead */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_scanf</span><span class="p">(</span><span class="n">XBT_NIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span> <span class="s">&quot;virtual-device-ext&quot;</span><span class="p">,</span>
				   <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdevice</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xenbus_dev_fatal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s">&quot;reading virtual-device&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xen_hvm_domain</span><span class="p">())</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
		<span class="cm">/* no unplug has been done: do not hook devices != xen vbds */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xen_platform_pci_unplug</span> <span class="o">&amp;</span> <span class="n">XEN_UNPLUG_UNNECESSARY</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">major</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">VDEV_IS_EXTENDED</span><span class="p">(</span><span class="n">vdevice</span><span class="p">))</span>
				<span class="n">major</span> <span class="o">=</span> <span class="n">BLKIF_MAJOR</span><span class="p">(</span><span class="n">vdevice</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">major</span> <span class="o">=</span> <span class="n">XENVBD_MAJOR</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">major</span> <span class="o">!=</span> <span class="n">XENVBD_MAJOR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
						<span class="s">&quot;%s: HVM does not support vbd %d as xen block device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">vdevice</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* do not create a PV cdrom device if we are an HVM guest */</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">xenbus_read</span><span class="p">(</span><span class="n">XBT_NIL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span> <span class="s">&quot;device-type&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">type</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;cdrom&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xenbus_dev_fatal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span> <span class="s">&quot;allocating info structure&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">vdevice</span> <span class="o">=</span> <span class="n">vdevice</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="n">BLKIF_STATE_DISCONNECTED</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">blkif_restart_queue</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BLK_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">BLK_RING_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">req</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x0fffffff</span><span class="p">;</span>

	<span class="cm">/* Front end dir is a number, which is used as the id. */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">strrchr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">talk_to_blkback</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">blkif_recover</span><span class="p">(</span><span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blkif_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blk_shadow</span> <span class="o">*</span><span class="n">copy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/* Stage 1: Make a safe copy of the shadow state. */</span>
	<span class="n">copy</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">),</span>
		       <span class="n">GFP_NOIO</span> <span class="o">|</span> <span class="n">__GFP_REPEAT</span> <span class="o">|</span> <span class="n">__GFP_HIGH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">copy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">copy</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">));</span>

	<span class="cm">/* Stage 2: Set up free list. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BLK_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow_free</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">req_prod_pvt</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">BLK_RING_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">req</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x0fffffff</span><span class="p">;</span>

	<span class="cm">/* Stage 3: Find pending requests and requeue them. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BLK_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Not in use? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">copy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Grab a request slot and copy shadow state into it. */</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">RING_GET_REQUEST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">req_prod_pvt</span><span class="p">);</span>
		<span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">copy</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req</span><span class="p">;</span>

		<span class="cm">/* We get a new request id, and must reset the shadow state. */</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">get_id_from_freelist</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">id</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">copy</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">copy</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">operation</span> <span class="o">!=</span> <span class="n">BLKIF_OP_DISCARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Rewrite any grant references invalidated by susp/resume. */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">nr_segments</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">gnttab_grant_foreign_access_ref</span><span class="p">(</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">seg</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">gref</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">otherend_id</span><span class="p">,</span>
					<span class="n">pfn_to_mfn</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">id</span><span class="p">].</span><span class="n">frame</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span>
					<span class="n">rq_data_dir</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">id</span><span class="p">].</span><span class="n">request</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">[</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rw</span><span class="p">.</span><span class="n">id</span><span class="p">].</span><span class="n">req</span> <span class="o">=</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">req_prod_pvt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">copy</span><span class="p">);</span>

	<span class="n">xenbus_switch_state</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="p">,</span> <span class="n">XenbusStateConnected</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="cm">/* Now safe for us to use the shared ring */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="n">BLKIF_STATE_CONNECTED</span><span class="p">;</span>

	<span class="cm">/* Send off requeued requests */</span>
	<span class="n">flush_requests</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* Kick any other new requests queued since we resumed */</span>
	<span class="n">kick_pending_request_queues</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * We are reconnecting to the backend, due to a suspend/resume, or a backend</span>
<span class="cm"> * driver restart.  We tear down our blkif structure and recreate it, but</span>
<span class="cm"> * leave the device-layer structures intact so that this is transparent to the</span>
<span class="cm"> * rest of the kernel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">blkfront_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">xenbus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;blkfront_resume: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">);</span>

	<span class="n">blkif_free</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">==</span> <span class="n">BLKIF_STATE_CONNECTED</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">talk_to_blkback</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">==</span> <span class="n">BLKIF_STATE_SUSPENDED</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">blkif_recover</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">blkfront_closing</span><span class="p">(</span><span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xenbus_device</span> <span class="o">*</span><span class="n">xbdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">XenbusStateClosing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">)</span>
		<span class="n">bdev</span> <span class="o">=</span> <span class="n">bdget_disk</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xenbus_frontend_closed</span><span class="p">(</span><span class="n">xbdev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_openers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xenbus_dev_error</span><span class="p">(</span><span class="n">xbdev</span><span class="p">,</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">,</span>
				 <span class="s">&quot;Device in use; refusing to close&quot;</span><span class="p">);</span>
		<span class="n">xenbus_switch_state</span><span class="p">(</span><span class="n">xbdev</span><span class="p">,</span> <span class="n">XenbusStateClosing</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">xlvbd_release_gendisk</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">xenbus_frontend_closed</span><span class="p">(</span><span class="n">xbdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_mutex</span><span class="p">);</span>
	<span class="n">bdput</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blkfront_setup_discard</span><span class="p">(</span><span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">discard_granularity</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">discard_alignment</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">discard_secure</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">xenbus_read</span><span class="p">(</span><span class="n">XBT_NIL</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">otherend</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">type</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">feature_secdiscard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;phy&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_gather</span><span class="p">(</span><span class="n">XBT_NIL</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">otherend</span><span class="p">,</span>
			<span class="s">&quot;discard-granularity&quot;</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">discard_granularity</span><span class="p">,</span>
			<span class="s">&quot;discard-alignment&quot;</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">discard_alignment</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">feature_discard</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">discard_granularity</span> <span class="o">=</span> <span class="n">discard_granularity</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">discard_alignment</span> <span class="o">=</span> <span class="n">discard_alignment</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_gather</span><span class="p">(</span><span class="n">XBT_NIL</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">otherend</span><span class="p">,</span>
			    <span class="s">&quot;discard-secure&quot;</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">discard_secure</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">feature_secdiscard</span> <span class="o">=</span> <span class="n">discard_secure</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;file&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">feature_discard</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Invoked when the backend is finally &#39;ready&#39; (and has told produced</span>
<span class="cm"> * the details about the physical device - #sectors, size, etc).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">blkfront_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sector_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">binfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">flush</span><span class="p">,</span> <span class="n">discard</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BLKIF_STATE_CONNECTED</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Potentially, the back-end may be signalling</span>
<span class="cm">		 * a capacity change; update the capacity.</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_scanf</span><span class="p">(</span><span class="n">XBT_NIL</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">otherend</span><span class="p">,</span>
				   <span class="s">&quot;sectors&quot;</span><span class="p">,</span> <span class="s">&quot;%Lu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sectors</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">XENBUS_EXIST_ERR</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Setting capacity to %Lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sectors</span><span class="p">);</span>
		<span class="n">set_capacity</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">,</span> <span class="n">sectors</span><span class="p">);</span>
		<span class="n">revalidate_disk</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">);</span>

		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">BLKIF_STATE_SUSPENDED</span>:
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">otherend</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_gather</span><span class="p">(</span><span class="n">XBT_NIL</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">otherend</span><span class="p">,</span>
			    <span class="s">&quot;sectors&quot;</span><span class="p">,</span> <span class="s">&quot;%llu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sectors</span><span class="p">,</span>
			    <span class="s">&quot;info&quot;</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">binfo</span><span class="p">,</span>
			    <span class="s">&quot;sector-size&quot;</span><span class="p">,</span> <span class="s">&quot;%lu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sector_size</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xenbus_dev_fatal</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span>
				 <span class="s">&quot;reading backend fields at %s&quot;</span><span class="p">,</span>
				 <span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">otherend</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">feature_flush</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flush_op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_gather</span><span class="p">(</span><span class="n">XBT_NIL</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">otherend</span><span class="p">,</span>
			    <span class="s">&quot;feature-barrier&quot;</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">barrier</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there&#39;s no &quot;feature-barrier&quot; defined, then it means</span>
<span class="cm">	 * we&#39;re dealing with a very old backend which writes</span>
<span class="cm">	 * synchronously; nothing to do.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If there are barriers, then we use flush.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">barrier</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">feature_flush</span> <span class="o">=</span> <span class="n">REQ_FLUSH</span> <span class="o">|</span> <span class="n">REQ_FUA</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flush_op</span> <span class="o">=</span> <span class="n">BLKIF_OP_WRITE_BARRIER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * And if there is &quot;feature-flush-cache&quot; use that above</span>
<span class="cm">	 * barriers.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_gather</span><span class="p">(</span><span class="n">XBT_NIL</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">otherend</span><span class="p">,</span>
			    <span class="s">&quot;feature-flush-cache&quot;</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flush</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">flush</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">feature_flush</span> <span class="o">=</span> <span class="n">REQ_FLUSH</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flush_op</span> <span class="o">=</span> <span class="n">BLKIF_OP_FLUSH_DISKCACHE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xenbus_gather</span><span class="p">(</span><span class="n">XBT_NIL</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">otherend</span><span class="p">,</span>
			    <span class="s">&quot;feature-discard&quot;</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">discard</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">discard</span><span class="p">)</span>
		<span class="n">blkfront_setup_discard</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">xlvbd_alloc_gendisk</span><span class="p">(</span><span class="n">sectors</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">binfo</span><span class="p">,</span> <span class="n">sector_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xenbus_dev_fatal</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s">&quot;xlvbd_add at %s&quot;</span><span class="p">,</span>
				 <span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">otherend</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xenbus_switch_state</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="p">,</span> <span class="n">XenbusStateConnected</span><span class="p">);</span>

	<span class="cm">/* Kick pending requests. */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="n">BLKIF_STATE_CONNECTED</span><span class="p">;</span>
	<span class="n">kick_pending_request_queues</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">io_lock</span><span class="p">);</span>

	<span class="n">add_disk</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">is_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Callback received when the backend&#39;s state changes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">blkback_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">xenbus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">xenbus_state</span> <span class="n">backend_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;blkfront:blkback_changed to state %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">backend_state</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">backend_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XenbusStateInitialising</span>:
	<span class="k">case</span> <span class="n">XenbusStateInitWait</span>:
	<span class="k">case</span> <span class="n">XenbusStateInitialised</span>:
	<span class="k">case</span> <span class="n">XenbusStateReconfiguring</span>:
	<span class="k">case</span> <span class="n">XenbusStateReconfigured</span>:
	<span class="k">case</span> <span class="n">XenbusStateUnknown</span>:
	<span class="k">case</span> <span class="n">XenbusStateClosed</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">XenbusStateConnected</span>:
		<span class="n">blkfront_connect</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">XenbusStateClosing</span>:
		<span class="n">blkfront_closing</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blkfront_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">xenbus_device</span> <span class="o">*</span><span class="n">xbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s removed&quot;</span><span class="p">,</span> <span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">);</span>

	<span class="n">blkif_free</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">disk</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="p">)</span>
		<span class="n">bdev</span> <span class="o">=</span> <span class="n">bdget_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The xbdev was removed before we reached the Closed</span>
<span class="cm">	 * state. See if it&#39;s safe to remove the disk. If the bdev</span>
<span class="cm">	 * isn&#39;t closed yet, we let release take care of it.</span>
<span class="cm">	 */</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_mutex</span><span class="p">);</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">dev_warn</span><span class="p">(</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">disk</span><span class="p">),</span>
		 <span class="s">&quot;%s was hot-unplugged, %d stale handles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_openers</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_openers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xlvbd_release_gendisk</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_mutex</span><span class="p">);</span>
	<span class="n">bdput</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blkfront_is_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">xenbus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">is_ready</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blkif_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blkfront_mutex</span><span class="p">);</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* xbdev gone */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">)</span>
		<span class="cm">/* xbdev is closed */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blkfront_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blkif_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blkfront_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xenbus_device</span> <span class="o">*</span><span class="n">xbdev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blkfront_mutex</span><span class="p">);</span>

	<span class="n">bdev</span> <span class="o">=</span> <span class="n">bdget_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_openers</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if we have been instructed to close. We will have</span>
<span class="cm">	 * deferred this request, because the bdev was still open.</span>
<span class="cm">	 */</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">xbdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xbdev</span> <span class="o">&amp;&amp;</span> <span class="n">xbdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">XenbusStateClosing</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* pending switch to state closed */</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">),</span> <span class="s">&quot;releasing disk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">xlvbd_release_gendisk</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">xenbus_frontend_closed</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xbdev</span><span class="p">);</span>
 	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xbdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* sudden device removal */</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">),</span> <span class="s">&quot;releasing disk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">xlvbd_release_gendisk</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">bdput</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blkfront_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">xlvbd_block_fops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">blkif_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">blkif_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getgeo</span> <span class="o">=</span> <span class="n">blkif_getgeo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">blkif_ioctl</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">xenbus_device_id</span> <span class="n">blkfront_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;vbd&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_XENBUS_DRIVER</span><span class="p">(</span><span class="n">blkfront</span><span class="p">,</span> <span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">blkfront_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">blkfront_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">blkfront_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">otherend_changed</span> <span class="o">=</span> <span class="n">blkback_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_ready</span> <span class="o">=</span> <span class="n">blkfront_is_ready</span><span class="p">,</span>
<span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">xlblk_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_domain</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xen_hvm_domain</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">xen_platform_pci_unplug</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_blkdev</span><span class="p">(</span><span class="n">XENVBD_MAJOR</span><span class="p">,</span> <span class="n">DEV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;xen_blk: can&#39;t get major %d with name %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">XENVBD_MAJOR</span><span class="p">,</span> <span class="n">DEV_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xenbus_register_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blkfront_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">XENVBD_MAJOR</span><span class="p">,</span> <span class="n">DEV_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">xlblk_init</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">xlblk_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xenbus_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blkfront_driver</span><span class="p">);</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">XENVBD_MAJOR</span><span class="p">,</span> <span class="n">DEV_NAME</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">minors</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">xlblk_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Xen virtual block device frontend&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_BLOCKDEV_MAJOR</span><span class="p">(</span><span class="n">XENVBD_MAJOR</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;xen:vbd&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;xenblk&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
