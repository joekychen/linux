<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › DAC960.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>DAC960.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>

<span class="cm">  Linux Driver for Mylex DAC960/AcceleRAID/eXtremeRAID PCI RAID Controllers</span>

<span class="cm">  Copyright 1998-2001 by Leonard N. Zubkoff &lt;lnz@dandelion.com&gt;</span>
<span class="cm">  Portions Copyright 2002 by Mylex (An IBM Business Unit)</span>

<span class="cm">  This program is free software; you may redistribute and/or modify it under</span>
<span class="cm">  the terms of the GNU General Public License Version 2 as published by the</span>
<span class="cm">  Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope that it will be useful, but</span>
<span class="cm">  WITHOUT ANY WARRANTY, without even the implied warranty of MERCHANTABILITY</span>
<span class="cm">  or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
<span class="cm">  for complete details.</span>

<span class="cm">*/</span>


<span class="cp">#define DAC960_DriverVersion			&quot;2.5.49&quot;</span>
<span class="cp">#define DAC960_DriverDate			&quot;21 Aug 2007&quot;</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/bio.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/genhd.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/blkpg.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &quot;DAC960.h&quot;</span>

<span class="cp">#define DAC960_GAM_MINOR	252</span>


<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">DAC960_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">DAC960_Controllers</span><span class="p">[</span><span class="n">DAC960_MaxControllers</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">DAC960_ControllerCount</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">DAC960_ProcDirectoryEntry</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">disk_size</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">drive_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">==</span> <span class="n">DAC960_V1_Controller</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drive_nr</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">LogicalDriveCount</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LogicalDriveInformation</span><span class="p">[</span><span class="n">drive_nr</span><span class="p">].</span>
			<span class="n">LogicalDriveSize</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DAC960_V2_LogicalDeviceInfo_T</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDeviceInformation</span><span class="p">[</span><span class="n">drive_nr</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">ConfigurableDeviceSize</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DAC960_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">;</span>
	<span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drive_nr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAC960_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">==</span> <span class="n">DAC960_V1_Controller</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LogicalDriveInformation</span><span class="p">[</span><span class="n">drive_nr</span><span class="p">].</span>
		    <span class="n">LogicalDriveState</span> <span class="o">==</span> <span class="n">DAC960_V1_LogicalDrive_Offline</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DAC960_V2_LogicalDeviceInfo_T</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDeviceInformation</span><span class="p">[</span><span class="n">drive_nr</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span> <span class="o">||</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">LogicalDeviceState</span> <span class="o">==</span> <span class="n">DAC960_V2_LogicalDevice_Offline</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">check_disk_change</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_capacity</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">drive_nr</span><span class="p">]))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAC960_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DAC960_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">;</span>
	<span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drive_nr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">==</span> <span class="n">DAC960_V1_Controller</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">GeometryTranslationHeads</span><span class="p">;</span>
		<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">GeometryTranslationSectors</span><span class="p">;</span>
		<span class="n">geo</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LogicalDriveInformation</span><span class="p">[</span><span class="n">drive_nr</span><span class="p">].</span>
			<span class="n">LogicalDriveSize</span> <span class="o">/</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">*</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DAC960_V2_LogicalDeviceInfo_T</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDeviceInformation</span><span class="p">[</span><span class="n">drive_nr</span><span class="p">];</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">DriveGeometry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DAC960_V2_Geometry_128_32</span>:
			<span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
			<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DAC960_V2_Geometry_255_63</span>:
			<span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
			<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Illegal Logical Device Geometry %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">DriveGeometry</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">geo</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">ConfigurableDeviceSize</span> <span class="o">/</span>
			<span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">*</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">DAC960_check_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clearing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drive_nr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">LogicalDriveInitiallyAccessible</span><span class="p">[</span><span class="n">drive_nr</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">DISK_EVENT_MEDIA_CHANGE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DAC960_revalidate_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unit</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">set_capacity</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">disk_size</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">unit</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">DAC960_BlockDeviceOperations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">DAC960_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getgeo</span>			<span class="o">=</span> <span class="n">DAC960_getgeo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_events</span>		<span class="o">=</span> <span class="n">DAC960_check_events</span><span class="p">,</span>
	<span class="p">.</span><span class="n">revalidate_disk</span>	<span class="o">=</span> <span class="n">DAC960_revalidate_disk</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_AnnounceDriver announces the Driver Version and Date, Author&#39;s Name,</span>
<span class="cm">  Copyright Notice, and Electronic Mail Address.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_AnnounceDriver</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Announce</span><span class="p">(</span><span class="s">&quot;***** DAC960 RAID Driver Version &quot;</span>
		  <span class="n">DAC960_DriverVersion</span> <span class="s">&quot; of &quot;</span>
		  <span class="n">DAC960_DriverDate</span> <span class="s">&quot; *****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
  <span class="n">DAC960_Announce</span><span class="p">(</span><span class="s">&quot;Copyright 1998-2001 by Leonard N. Zubkoff &quot;</span>
		  <span class="s">&quot;&lt;lnz@dandelion.com&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_Failure prints a standardized error message, and then returns false.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_Failure</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ErrorMessage</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;While configuring DAC960 PCI RAID Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">Controller</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;PCI Bus %d Device %d Function %d I/O Address N/A &quot;</span>
		 <span class="s">&quot;PCI Address 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		 <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Device</span><span class="p">,</span>
		 <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Function</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCI_Address</span><span class="p">);</span>
  <span class="k">else</span> <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;PCI Bus %d Device %d Function %d I/O Address &quot;</span>
		    <span class="s">&quot;0x%X PCI Address 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Device</span><span class="p">,</span>
		    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Function</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span>
		    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCI_Address</span><span class="p">);</span>
  <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;%s FAILED - DETACHING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">ErrorMessage</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  init_dma_loaf() and slice_dma_loaf() are helper functions for</span>
<span class="cm">  aggregating the dma-mapped memory for a well-known collection of</span>
<span class="cm">  data structures that are of different lengths.</span>

<span class="cm">  These routines don&#39;t guarantee any alignment.  The caller must</span>
<span class="cm">  include any space needed for alignment in the sizes of the structures</span>
<span class="cm">  that are passed in.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">init_dma_loaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_loaf</span> <span class="o">*</span><span class="n">loaf</span><span class="p">,</span>
								 <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cpu_addr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>

	<span class="n">cpu_addr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	
	<span class="n">loaf</span><span class="o">-&gt;</span><span class="n">cpu_free</span> <span class="o">=</span> <span class="n">loaf</span><span class="o">-&gt;</span><span class="n">cpu_base</span> <span class="o">=</span> <span class="n">cpu_addr</span><span class="p">;</span>
	<span class="n">loaf</span><span class="o">-&gt;</span><span class="n">dma_free</span> <span class="o">=</span><span class="n">loaf</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">loaf</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cpu_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">slice_dma_loaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_loaf</span> <span class="o">*</span><span class="n">loaf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
					<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">dma_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cpu_end</span> <span class="o">=</span> <span class="n">loaf</span><span class="o">-&gt;</span><span class="n">cpu_free</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cpu_addr</span> <span class="o">=</span> <span class="n">loaf</span><span class="o">-&gt;</span><span class="n">cpu_free</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">cpu_end</span> <span class="o">&gt;</span> <span class="n">loaf</span><span class="o">-&gt;</span><span class="n">cpu_base</span> <span class="o">+</span> <span class="n">loaf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="o">*</span><span class="n">dma_handle</span> <span class="o">=</span> <span class="n">loaf</span><span class="o">-&gt;</span><span class="n">dma_free</span><span class="p">;</span>
	<span class="n">loaf</span><span class="o">-&gt;</span><span class="n">cpu_free</span> <span class="o">=</span> <span class="n">cpu_end</span><span class="p">;</span>
	<span class="n">loaf</span><span class="o">-&gt;</span><span class="n">dma_free</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cpu_addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_dma_loaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_loaf</span> <span class="o">*</span><span class="n">loaf_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">loaf_handle</span><span class="o">-&gt;</span><span class="n">cpu_base</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">loaf_handle</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
			<span class="n">loaf_handle</span><span class="o">-&gt;</span><span class="n">cpu_base</span><span class="p">,</span> <span class="n">loaf_handle</span><span class="o">-&gt;</span><span class="n">dma_base</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_CreateAuxiliaryStructures allocates and initializes the auxiliary</span>
<span class="cm">  data structures for Controller.  It returns true on success and false on</span>
<span class="cm">  failure.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_CreateAuxiliaryStructures</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">CommandAllocationLength</span><span class="p">,</span> <span class="n">CommandAllocationGroupSize</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">CommandsRemaining</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CommandIdentifier</span><span class="p">,</span> <span class="n">CommandGroupByteCount</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">AllocationPointer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">ScatterGatherCPU</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">dma_addr_t</span> <span class="n">ScatterGatherDMA</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">pci_pool</span> <span class="o">*</span><span class="n">ScatterGatherPool</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">RequestSenseCPU</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">dma_addr_t</span> <span class="n">RequestSenseDMA</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">pci_pool</span> <span class="o">*</span><span class="n">RequestSensePool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">==</span> <span class="n">DAC960_V1_Controller</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">CommandAllocationLength</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">DAC960_Command_T</span><span class="p">,</span> <span class="n">V1</span><span class="p">.</span><span class="n">EndMarker</span><span class="p">);</span>
      <span class="n">CommandAllocationGroupSize</span> <span class="o">=</span> <span class="n">DAC960_V1_CommandAllocationGroupSize</span><span class="p">;</span>
      <span class="n">ScatterGatherPool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;DAC960_V1_ScatterGather&quot;</span><span class="p">,</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span>
	<span class="n">DAC960_V1_ScatterGatherLimit</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_ScatterGatherSegment_T</span><span class="p">),</span>
	<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_ScatterGatherSegment_T</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ScatterGatherPool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span>
			<span class="s">&quot;AUXILIARY STRUCTURE CREATION (SG)&quot;</span><span class="p">);</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ScatterGatherPool</span> <span class="o">=</span> <span class="n">ScatterGatherPool</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">CommandAllocationLength</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">DAC960_Command_T</span><span class="p">,</span> <span class="n">V2</span><span class="p">.</span><span class="n">EndMarker</span><span class="p">);</span>
      <span class="n">CommandAllocationGroupSize</span> <span class="o">=</span> <span class="n">DAC960_V2_CommandAllocationGroupSize</span><span class="p">;</span>
      <span class="n">ScatterGatherPool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;DAC960_V2_ScatterGather&quot;</span><span class="p">,</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span>
	<span class="n">DAC960_V2_ScatterGatherLimit</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_ScatterGatherSegment_T</span><span class="p">),</span>
	<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_ScatterGatherSegment_T</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ScatterGatherPool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span>
			<span class="s">&quot;AUXILIARY STRUCTURE CREATION (SG)&quot;</span><span class="p">);</span>
      <span class="n">RequestSensePool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;DAC960_V2_RequestSense&quot;</span><span class="p">,</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_RequestSense_T</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">RequestSensePool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">ScatterGatherPool</span><span class="p">);</span>
	    <span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span>
			<span class="s">&quot;AUXILIARY STRUCTURE CREATION (SG)&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ScatterGatherPool</span> <span class="o">=</span> <span class="n">ScatterGatherPool</span><span class="p">;</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSensePool</span> <span class="o">=</span> <span class="n">RequestSensePool</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CommandAllocationGroupSize</span> <span class="o">=</span> <span class="n">CommandAllocationGroupSize</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FreeCommands</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">CommandIdentifier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
       <span class="n">CommandIdentifier</span> <span class="o">&lt;=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span><span class="p">;</span>
       <span class="n">CommandIdentifier</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">CommandsRemaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">CommandsRemaining</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span> <span class="o">-</span> <span class="n">CommandIdentifier</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">CommandsRemaining</span> <span class="o">&gt;</span> <span class="n">CommandAllocationGroupSize</span><span class="p">)</span>
		<span class="n">CommandsRemaining</span> <span class="o">=</span> <span class="n">CommandAllocationGroupSize</span><span class="p">;</span>
	  <span class="n">CommandGroupByteCount</span> <span class="o">=</span>
		<span class="n">CommandsRemaining</span> <span class="o">*</span> <span class="n">CommandAllocationLength</span><span class="p">;</span>
	  <span class="n">AllocationPointer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">CommandGroupByteCount</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">AllocationPointer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span>
					<span class="s">&quot;AUXILIARY STRUCTURE CREATION&quot;</span><span class="p">);</span>
	 <span class="p">}</span>
      <span class="n">Command</span> <span class="o">=</span> <span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="p">)</span> <span class="n">AllocationPointer</span><span class="p">;</span>
      <span class="n">AllocationPointer</span> <span class="o">+=</span> <span class="n">CommandAllocationLength</span><span class="p">;</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandIdentifier</span> <span class="o">=</span> <span class="n">CommandIdentifier</span><span class="p">;</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Controller</span><span class="p">;</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Next</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FreeCommands</span><span class="p">;</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FreeCommands</span> <span class="o">=</span> <span class="n">Command</span><span class="p">;</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Commands</span><span class="p">[</span><span class="n">CommandIdentifier</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Command</span><span class="p">;</span>
      <span class="n">ScatterGatherCPU</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">ScatterGatherPool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">ScatterGatherDMA</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ScatterGatherCPU</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	  <span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;AUXILIARY STRUCTURE CREATION&quot;</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">RequestSensePool</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
  	  <span class="n">RequestSenseCPU</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">RequestSensePool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">RequestSenseDMA</span><span class="p">);</span>
  	  <span class="k">if</span> <span class="p">(</span><span class="n">RequestSenseCPU</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pci_pool_free</span><span class="p">(</span><span class="n">ScatterGatherPool</span><span class="p">,</span> <span class="n">ScatterGatherCPU</span><span class="p">,</span>
                                <span class="n">ScatterGatherDMA</span><span class="p">);</span>
    		<span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span>
					<span class="s">&quot;AUXILIARY STRUCTURE CREATION&quot;</span><span class="p">);</span>
	  <span class="p">}</span>
        <span class="p">}</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">==</span> <span class="n">DAC960_V1_Controller</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Command</span><span class="o">-&gt;</span><span class="n">cmd_sglist</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">ScatterList</span><span class="p">;</span>
	<span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">ScatterGatherList</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">DAC960_V1_ScatterGatherSegment_T</span> <span class="o">*</span><span class="p">)</span><span class="n">ScatterGatherCPU</span><span class="p">;</span>
	<span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">ScatterGatherListDMA</span> <span class="o">=</span> <span class="n">ScatterGatherDMA</span><span class="p">;</span>
	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">cmd_sglist</span><span class="p">,</span> <span class="n">DAC960_V1_ScatterGatherLimit</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">Command</span><span class="o">-&gt;</span><span class="n">cmd_sglist</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">ScatterList</span><span class="p">;</span>
	<span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">ScatterGatherList</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">DAC960_V2_ScatterGatherSegment_T</span> <span class="o">*</span><span class="p">)</span><span class="n">ScatterGatherCPU</span><span class="p">;</span>
	<span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">ScatterGatherListDMA</span> <span class="o">=</span> <span class="n">ScatterGatherDMA</span><span class="p">;</span>
	<span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSense</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">DAC960_SCSI_RequestSense_T</span> <span class="o">*</span><span class="p">)</span><span class="n">RequestSenseCPU</span><span class="p">;</span>
	<span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSenseDMA</span> <span class="o">=</span> <span class="n">RequestSenseDMA</span><span class="p">;</span>
	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">cmd_sglist</span><span class="p">,</span> <span class="n">DAC960_V2_ScatterGatherLimit</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_DestroyAuxiliaryStructures deallocates the auxiliary data</span>
<span class="cm">  structures for Controller.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_DestroyAuxiliaryStructures</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">pci_pool</span> <span class="o">*</span><span class="n">ScatterGatherPool</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ScatterGatherPool</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">pci_pool</span> <span class="o">*</span><span class="n">RequestSensePool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">ScatterGatherCPU</span><span class="p">;</span>
  <span class="n">dma_addr_t</span> <span class="n">ScatterGatherDMA</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">RequestSenseCPU</span><span class="p">;</span>
  <span class="n">dma_addr_t</span> <span class="n">RequestSenseDMA</span><span class="p">;</span>
  <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">CommandGroup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  

  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">==</span> <span class="n">DAC960_V2_Controller</span><span class="p">)</span>
        <span class="n">RequestSensePool</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSensePool</span><span class="p">;</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FreeCommands</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Commands</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">Command</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	  <span class="k">continue</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">==</span> <span class="n">DAC960_V1_Controller</span><span class="p">)</span> <span class="p">{</span>
	  <span class="n">ScatterGatherCPU</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">ScatterGatherList</span><span class="p">;</span>
	  <span class="n">ScatterGatherDMA</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">ScatterGatherListDMA</span><span class="p">;</span>
	  <span class="n">RequestSenseCPU</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	  <span class="n">RequestSenseDMA</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">ScatterGatherCPU</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">ScatterGatherList</span><span class="p">;</span>
	  <span class="n">ScatterGatherDMA</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">ScatterGatherListDMA</span><span class="p">;</span>
	  <span class="n">RequestSenseCPU</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSense</span><span class="p">;</span>
	  <span class="n">RequestSenseDMA</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSenseDMA</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ScatterGatherCPU</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
          <span class="n">pci_pool_free</span><span class="p">(</span><span class="n">ScatterGatherPool</span><span class="p">,</span> <span class="n">ScatterGatherCPU</span><span class="p">,</span> <span class="n">ScatterGatherDMA</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">RequestSenseCPU</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
          <span class="n">pci_pool_free</span><span class="p">(</span><span class="n">RequestSensePool</span><span class="p">,</span> <span class="n">RequestSenseCPU</span><span class="p">,</span> <span class="n">RequestSenseDMA</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">((</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandIdentifier</span>
	   <span class="o">%</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CommandAllocationGroupSize</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	   <span class="cm">/*</span>
<span class="cm">	    * We can&#39;t free the group of commands until all of the</span>
<span class="cm">	    * request sense and scatter gather dma structures are free.</span>
<span class="cm">            * Remember the beginning of the group, but don&#39;t free it</span>
<span class="cm">	    * until we&#39;ve reached the beginning of the next group.</span>
<span class="cm">	    */</span>
	   <span class="n">kfree</span><span class="p">(</span><span class="n">CommandGroup</span><span class="p">);</span>
	   <span class="n">CommandGroup</span> <span class="o">=</span> <span class="n">Command</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Commands</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">kfree</span><span class="p">(</span><span class="n">CommandGroup</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBuffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">kfree</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBuffer</span><span class="p">);</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ScatterGatherPool</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
  	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">ScatterGatherPool</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">==</span> <span class="n">DAC960_V1_Controller</span><span class="p">)</span>
  	<span class="k">return</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">RequestSensePool</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">RequestSensePool</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DAC960_MaxLogicalDrives</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDeviceInformation</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDeviceInformation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DAC960_V2_MaxPhysicalDevices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">kfree</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceInformation</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceInformation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">kfree</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V1_ClearCommand clears critical fields of Command for DAC960 V1</span>
<span class="cm">  Firmware Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">DAC960_V1_ClearCommand</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">CommandMailbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_CommandMailbox_T</span><span class="p">));</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_ClearCommand clears critical fields of Command for DAC960 V2</span>
<span class="cm">  Firmware Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">DAC960_V2_ClearCommand</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">CommandMailbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_CommandMailbox_T</span><span class="p">));</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_AllocateCommand allocates a Command structure from Controller&#39;s</span>
<span class="cm">  free list.  During driver initialization, a special initialization command</span>
<span class="cm">  has been placed on the free list to guarantee that command allocation can</span>
<span class="cm">  never fail.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="nf">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">DAC960_Controller_T</span>
						       <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FreeCommands</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Command</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FreeCommands</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">;</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">Command</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_DeallocateCommand deallocates Command, returning it to Controller&#39;s</span>
<span class="cm">  free list.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>

  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Next</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FreeCommands</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FreeCommands</span> <span class="o">=</span> <span class="n">Command</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_WaitForCommand waits for a wake_up on Controller&#39;s Command Wait Queue.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_WaitForCommand</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
  <span class="n">__wait_event</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CommandWaitQueue</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FreeCommands</span><span class="p">);</span>
  <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  DAC960_GEM_QueueCommand queues Command for DAC960 GEM Series Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_GEM_QueueCommand</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">NextCommandMailbox</span> <span class="o">=</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextCommandMailbox</span><span class="p">;</span>

  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandIdentifier</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandIdentifier</span><span class="p">;</span>
  <span class="n">DAC960_GEM_WriteCommandMailbox</span><span class="p">(</span><span class="n">NextCommandMailbox</span><span class="p">,</span> <span class="n">CommandMailbox</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">DAC960_GEM_MemoryMailboxNewCommand</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span> <span class="o">=</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span> <span class="o">=</span> <span class="n">NextCommandMailbox</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">NextCommandMailbox</span> <span class="o">&gt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LastCommandMailbox</span><span class="p">)</span>
      <span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">FirstCommandMailbox</span><span class="p">;</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">NextCommandMailbox</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  DAC960_BA_QueueCommand queues Command for DAC960 BA Series Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_BA_QueueCommand</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">NextCommandMailbox</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextCommandMailbox</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandIdentifier</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandIdentifier</span><span class="p">;</span>
  <span class="n">DAC960_BA_WriteCommandMailbox</span><span class="p">(</span><span class="n">NextCommandMailbox</span><span class="p">,</span> <span class="n">CommandMailbox</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">DAC960_BA_MemoryMailboxNewCommand</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span> <span class="o">=</span> <span class="n">NextCommandMailbox</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">NextCommandMailbox</span> <span class="o">&gt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LastCommandMailbox</span><span class="p">)</span>
    <span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">FirstCommandMailbox</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">NextCommandMailbox</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_LP_QueueCommand queues Command for DAC960 LP Series Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_LP_QueueCommand</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">NextCommandMailbox</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextCommandMailbox</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandIdentifier</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandIdentifier</span><span class="p">;</span>
  <span class="n">DAC960_LP_WriteCommandMailbox</span><span class="p">(</span><span class="n">NextCommandMailbox</span><span class="p">,</span> <span class="n">CommandMailbox</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">DAC960_LP_MemoryMailboxNewCommand</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span> <span class="o">=</span> <span class="n">NextCommandMailbox</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">NextCommandMailbox</span> <span class="o">&gt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LastCommandMailbox</span><span class="p">)</span>
    <span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">FirstCommandMailbox</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">NextCommandMailbox</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_LA_QueueCommandDualMode queues Command for DAC960 LA Series</span>
<span class="cm">  Controllers with Dual Mode Firmware.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_LA_QueueCommandDualMode</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">NextCommandMailbox</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NextCommandMailbox</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandIdentifier</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandIdentifier</span><span class="p">;</span>
  <span class="n">DAC960_LA_WriteCommandMailbox</span><span class="p">(</span><span class="n">NextCommandMailbox</span><span class="p">,</span> <span class="n">CommandMailbox</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">DAC960_LA_MemoryMailboxNewCommand</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span> <span class="o">=</span> <span class="n">NextCommandMailbox</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">NextCommandMailbox</span> <span class="o">&gt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastCommandMailbox</span><span class="p">)</span>
    <span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">FirstCommandMailbox</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">NextCommandMailbox</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_LA_QueueCommandSingleMode queues Command for DAC960 LA Series</span>
<span class="cm">  Controllers with Single Mode Firmware.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_LA_QueueCommandSingleMode</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">NextCommandMailbox</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NextCommandMailbox</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandIdentifier</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandIdentifier</span><span class="p">;</span>
  <span class="n">DAC960_LA_WriteCommandMailbox</span><span class="p">(</span><span class="n">NextCommandMailbox</span><span class="p">,</span> <span class="n">CommandMailbox</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">DAC960_LA_HardwareMailboxNewCommand</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span> <span class="o">=</span> <span class="n">NextCommandMailbox</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">NextCommandMailbox</span> <span class="o">&gt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastCommandMailbox</span><span class="p">)</span>
    <span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">FirstCommandMailbox</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">NextCommandMailbox</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_PG_QueueCommandDualMode queues Command for DAC960 PG Series</span>
<span class="cm">  Controllers with Dual Mode Firmware.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_PG_QueueCommandDualMode</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">NextCommandMailbox</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NextCommandMailbox</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandIdentifier</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandIdentifier</span><span class="p">;</span>
  <span class="n">DAC960_PG_WriteCommandMailbox</span><span class="p">(</span><span class="n">NextCommandMailbox</span><span class="p">,</span> <span class="n">CommandMailbox</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">DAC960_PG_MemoryMailboxNewCommand</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span> <span class="o">=</span> <span class="n">NextCommandMailbox</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">NextCommandMailbox</span> <span class="o">&gt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastCommandMailbox</span><span class="p">)</span>
    <span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">FirstCommandMailbox</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">NextCommandMailbox</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_PG_QueueCommandSingleMode queues Command for DAC960 PG Series</span>
<span class="cm">  Controllers with Single Mode Firmware.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_PG_QueueCommandSingleMode</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">NextCommandMailbox</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NextCommandMailbox</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandIdentifier</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandIdentifier</span><span class="p">;</span>
  <span class="n">DAC960_PG_WriteCommandMailbox</span><span class="p">(</span><span class="n">NextCommandMailbox</span><span class="p">,</span> <span class="n">CommandMailbox</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">DAC960_PG_HardwareMailboxNewCommand</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span> <span class="o">=</span> <span class="n">NextCommandMailbox</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">NextCommandMailbox</span> <span class="o">&gt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastCommandMailbox</span><span class="p">)</span>
    <span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">FirstCommandMailbox</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">NextCommandMailbox</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_PD_QueueCommand queues Command for DAC960 PD Series Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_PD_QueueCommand</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandIdentifier</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandIdentifier</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">DAC960_PD_MailboxFullP</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">))</span>
    <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">DAC960_PD_WriteCommandMailbox</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">,</span> <span class="n">CommandMailbox</span><span class="p">);</span>
  <span class="n">DAC960_PD_NewCommand</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_P_QueueCommand queues Command for DAC960 P Series Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_P_QueueCommand</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandIdentifier</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandIdentifier</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">DAC960_V1_Enquiry</span>:
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_Enquiry_Old</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_GetDeviceState</span>:
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_GetDeviceState_Old</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_Read</span>:
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_Read_Old</span><span class="p">;</span>
      <span class="n">DAC960_PD_To_P_TranslateReadWriteCommand</span><span class="p">(</span><span class="n">CommandMailbox</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_Write</span>:
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_Write_Old</span><span class="p">;</span>
      <span class="n">DAC960_PD_To_P_TranslateReadWriteCommand</span><span class="p">(</span><span class="n">CommandMailbox</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_ReadWithScatterGather</span>:
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span>
	<span class="n">DAC960_V1_ReadWithScatterGather_Old</span><span class="p">;</span>
      <span class="n">DAC960_PD_To_P_TranslateReadWriteCommand</span><span class="p">(</span><span class="n">CommandMailbox</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_WriteWithScatterGather</span>:
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span>
	<span class="n">DAC960_V1_WriteWithScatterGather_Old</span><span class="p">;</span>
      <span class="n">DAC960_PD_To_P_TranslateReadWriteCommand</span><span class="p">(</span><span class="n">CommandMailbox</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">DAC960_PD_MailboxFullP</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">))</span>
    <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">DAC960_PD_WriteCommandMailbox</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">,</span> <span class="n">CommandMailbox</span><span class="p">);</span>
  <span class="n">DAC960_PD_NewCommand</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_ExecuteCommand executes Command and waits for completion.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">Completion</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Completion</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Completion</span><span class="p">;</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
 
  <span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span>
	  <span class="k">return</span><span class="p">;</span>
  <span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Completion</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V1_ExecuteType3 executes a DAC960 V1 Firmware Controller Type 3</span>
<span class="cm">  Command and waits for completion.  It returns true on success and false</span>
<span class="cm">  on failure.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V1_ExecuteType3</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
				      <span class="n">DAC960_V1_CommandOpcode_T</span> <span class="n">CommandOpcode</span><span class="p">,</span>
				      <span class="n">dma_addr_t</span> <span class="n">DataDMA</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandStatus_T</span> <span class="n">CommandStatus</span><span class="p">;</span>
  <span class="n">DAC960_V1_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">CommandOpcode</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span> <span class="n">DataDMA</span><span class="p">;</span>
  <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
  <span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V1_NormalCompletion</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V1_ExecuteTypeB executes a DAC960 V1 Firmware Controller Type 3B</span>
<span class="cm">  Command and waits for completion.  It returns true on success and false</span>
<span class="cm">  on failure.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V1_ExecuteType3B</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
				       <span class="n">DAC960_V1_CommandOpcode_T</span> <span class="n">CommandOpcode</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">CommandOpcode2</span><span class="p">,</span>
				       <span class="n">dma_addr_t</span> <span class="n">DataDMA</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandStatus_T</span> <span class="n">CommandStatus</span><span class="p">;</span>
  <span class="n">DAC960_V1_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3B</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">CommandOpcode</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3B</span><span class="p">.</span><span class="n">CommandOpcode2</span> <span class="o">=</span> <span class="n">CommandOpcode2</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3B</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span> <span class="n">DataDMA</span><span class="p">;</span>
  <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
  <span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V1_NormalCompletion</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V1_ExecuteType3D executes a DAC960 V1 Firmware Controller Type 3D</span>
<span class="cm">  Command and waits for completion.  It returns true on success and false</span>
<span class="cm">  on failure.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V1_ExecuteType3D</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
				       <span class="n">DAC960_V1_CommandOpcode_T</span> <span class="n">CommandOpcode</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Channel</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TargetID</span><span class="p">,</span>
				       <span class="n">dma_addr_t</span> <span class="n">DataDMA</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandStatus_T</span> <span class="n">CommandStatus</span><span class="p">;</span>
  <span class="n">DAC960_V1_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3D</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">CommandOpcode</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3D</span><span class="p">.</span><span class="n">Channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3D</span><span class="p">.</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">TargetID</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3D</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span> <span class="n">DataDMA</span><span class="p">;</span>
  <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
  <span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V1_NormalCompletion</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_GeneralInfo executes a DAC960 V2 Firmware General Information</span>
<span class="cm">  Reading IOCTL Command and waits for completion.  It returns true on success</span>
<span class="cm">  and false on failure.</span>

<span class="cm">  Return data in The controller&#39;s HealthStatusBuffer, which is dma-able memory</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V2_GeneralInfo</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandStatus_T</span> <span class="n">CommandStatus</span><span class="p">;</span>
  <span class="n">DAC960_V2_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V2_IOCTL</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandControlBits</span>
			<span class="p">.</span><span class="n">DataTransferControllerToHost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandControlBits</span>
			<span class="p">.</span><span class="n">NoAutoRequestSense</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">DataTransferSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_HealthStatusBuffer_T</span><span class="p">);</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span> <span class="n">DAC960_V2_GetHealthStatus</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
			<span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="p">.</span><span class="n">SegmentDataPointer</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">HealthStatusBufferDMA</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
			<span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="p">.</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
    <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">DataTransferSize</span><span class="p">;</span>
  <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
  <span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_ControllerInfo executes a DAC960 V2 Firmware Controller</span>
<span class="cm">  Information Reading IOCTL Command and waits for completion.  It returns</span>
<span class="cm">  true on success and false on failure.</span>

<span class="cm">  Data is returned in the controller&#39;s V2.NewControllerInformation dma-able</span>
<span class="cm">  memory buffer.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V2_NewControllerInfo</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandStatus_T</span> <span class="n">CommandStatus</span><span class="p">;</span>
  <span class="n">DAC960_V2_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V2_IOCTL</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">CommandControlBits</span>
				<span class="p">.</span><span class="n">DataTransferControllerToHost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">CommandControlBits</span>
				<span class="p">.</span><span class="n">NoAutoRequestSense</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">DataTransferSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_ControllerInfo_T</span><span class="p">);</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">ControllerNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span> <span class="n">DAC960_V2_GetControllerInfo</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
				<span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="p">.</span><span class="n">SegmentDataPointer</span> <span class="o">=</span>
    	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewControllerInformationDMA</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
				<span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="p">.</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
    <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">DataTransferSize</span><span class="p">;</span>
  <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
  <span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_LogicalDeviceInfo executes a DAC960 V2 Firmware Controller Logical</span>
<span class="cm">  Device Information Reading IOCTL Command and waits for completion.  It</span>
<span class="cm">  returns true on success and false on failure.</span>

<span class="cm">  Data is returned in the controller&#39;s V2.NewLogicalDeviceInformation</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V2_NewLogicalDeviceInfo</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">LogicalDeviceNumber</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandStatus_T</span> <span class="n">CommandStatus</span><span class="p">;</span>

  <span class="n">DAC960_V2_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span>
				<span class="n">DAC960_V2_IOCTL</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">CommandControlBits</span>
				   <span class="p">.</span><span class="n">DataTransferControllerToHost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">CommandControlBits</span>
				   <span class="p">.</span><span class="n">NoAutoRequestSense</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferSize</span> <span class="o">=</span> 
				<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_LogicalDeviceInfo_T</span><span class="p">);</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">LogicalDevice</span><span class="p">.</span><span class="n">LogicalDeviceNumber</span> <span class="o">=</span>
    <span class="n">LogicalDeviceNumber</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span> <span class="n">DAC960_V2_GetLogicalDeviceInfoValid</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
				   <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				   <span class="p">.</span><span class="n">SegmentDataPointer</span> <span class="o">=</span>
    	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewLogicalDeviceInformationDMA</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
				   <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				   <span class="p">.</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
    <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferSize</span><span class="p">;</span>
  <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
  <span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_PhysicalDeviceInfo executes a DAC960 V2 Firmware Controller &quot;Read</span>
<span class="cm">  Physical Device Information&quot; IOCTL Command and waits for completion.  It</span>
<span class="cm">  returns true on success and false on failure.</span>

<span class="cm">  The Channel, TargetID, LogicalUnit arguments should be 0 the first time</span>
<span class="cm">  this function is called for a given controller.  This will return data</span>
<span class="cm">  for the &quot;first&quot; device on that controller.  The returned data includes a</span>
<span class="cm">  Channel, TargetID, LogicalUnit that can be passed in to this routine to</span>
<span class="cm">  get data for the NEXT device on that controller.</span>

<span class="cm">  Data is stored in the controller&#39;s V2.NewPhysicalDeviceInfo dma-able</span>
<span class="cm">  memory buffer.</span>

<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V2_NewPhysicalDeviceInfo</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Channel</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TargetID</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">LogicalUnit</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandStatus_T</span> <span class="n">CommandStatus</span><span class="p">;</span>

  <span class="n">DAC960_V2_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V2_IOCTL</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">CommandControlBits</span>
				    <span class="p">.</span><span class="n">DataTransferControllerToHost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">CommandControlBits</span>
				    <span class="p">.</span><span class="n">NoAutoRequestSense</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferSize</span> <span class="o">=</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_PhysicalDeviceInfo_T</span><span class="p">);</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">LogicalUnit</span> <span class="o">=</span> <span class="n">LogicalUnit</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">TargetID</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">Channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span>
					<span class="n">DAC960_V2_GetPhysicalDeviceInfoValid</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
				    <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				    <span class="p">.</span><span class="n">SegmentDataPointer</span> <span class="o">=</span>
    					<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewPhysicalDeviceInformationDMA</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
				    <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				    <span class="p">.</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
    <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferSize</span><span class="p">;</span>
  <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
  <span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_V2_ConstructNewUnitSerialNumber</span><span class="p">(</span>
	<span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
	<span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">TargetID</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">LogicalUnit</span><span class="p">)</span>
<span class="p">{</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V2_SCSI_10_Passthru</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">CommandControlBits</span>
			     <span class="p">.</span><span class="n">DataTransferControllerToHost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">CommandControlBits</span>
			     <span class="p">.</span><span class="n">NoAutoRequestSense</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">DataTransferSize</span> <span class="o">=</span>
	<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">);</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">LogicalUnit</span> <span class="o">=</span> <span class="n">LogicalUnit</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">TargetID</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">Channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">CDBLength</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">SCSI_CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span> <span class="cm">/* INQUIRY */</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">SCSI_CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* EVPD = 1 */</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">SCSI_CDB</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* Page Code */</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">SCSI_CDB</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Reserved */</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">SCSI_CDB</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
	<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">);</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">SCSI_CDB</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Control */</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
			     <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			     <span class="p">.</span><span class="n">SegmentDataPointer</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewInquiryUnitSerialNumberDMA</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
			     <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			     <span class="p">.</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
		<span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">DataTransferSize</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_NewUnitSerialNumber executes an SCSI pass-through</span>
<span class="cm">  Inquiry command to a SCSI device identified by Channel number,</span>
<span class="cm">  Target id, Logical Unit Number.  This function Waits for completion</span>
<span class="cm">  of the command.</span>

<span class="cm">  The return data includes Unit Serial Number information for the</span>
<span class="cm">  specified device.</span>

<span class="cm">  Data is stored in the controller&#39;s V2.NewPhysicalDeviceInfo dma-able</span>
<span class="cm">  memory buffer.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V2_NewInquiryUnitSerialNumber</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">Channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">TargetID</span><span class="p">,</span> <span class="kt">int</span> <span class="n">LogicalUnit</span><span class="p">)</span>
<span class="p">{</span>
      <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">;</span>
      <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span><span class="p">;</span>
      <span class="n">DAC960_V2_CommandStatus_T</span> <span class="n">CommandStatus</span><span class="p">;</span>

      <span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
      <span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
      <span class="n">DAC960_V2_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">;</span>

      <span class="n">DAC960_V2_ConstructNewUnitSerialNumber</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">CommandMailbox</span><span class="p">,</span>
			<span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span> <span class="n">LogicalUnit</span><span class="p">);</span>

      <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
      <span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_DeviceOperation executes a DAC960 V2 Firmware Controller Device</span>
<span class="cm">  Operation IOCTL Command and waits for completion.  It returns true on</span>
<span class="cm">  success and false on failure.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V2_DeviceOperation</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
					 <span class="n">DAC960_V2_IOCTL_Opcode_T</span> <span class="n">IOCTL_Opcode</span><span class="p">,</span>
					 <span class="n">DAC960_V2_OperationDevice_T</span>
					   <span class="n">OperationDevice</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandStatus_T</span> <span class="n">CommandStatus</span><span class="p">;</span>
  <span class="n">DAC960_V2_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">DeviceOperation</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V2_IOCTL</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">DeviceOperation</span><span class="p">.</span><span class="n">CommandControlBits</span>
				 <span class="p">.</span><span class="n">DataTransferControllerToHost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">DeviceOperation</span><span class="p">.</span><span class="n">CommandControlBits</span>
    				 <span class="p">.</span><span class="n">NoAutoRequestSense</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">DeviceOperation</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span> <span class="n">IOCTL_Opcode</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">DeviceOperation</span><span class="p">.</span><span class="n">OperationDevice</span> <span class="o">=</span> <span class="n">OperationDevice</span><span class="p">;</span>
  <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
  <span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V1_EnableMemoryMailboxInterface enables the Memory Mailbox Interface</span>
<span class="cm">  for DAC960 V1 Firmware Controllers.</span>

<span class="cm">  PD and P controller types have no memory mailbox, but still need the</span>
<span class="cm">  other dma mapped memory.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V1_EnableMemoryMailboxInterface</span><span class="p">(</span><span class="n">DAC960_Controller_T</span>
						      <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">DAC960_HardwareType_T</span> <span class="n">hw_type</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">HardwareType</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">dma_loaf</span> <span class="o">*</span><span class="n">DmaPages</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DmaPages</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">DmaPagesSize</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">CommandMailboxesSize</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">StatusMailboxesSize</span><span class="p">;</span>

  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailboxesMemory</span><span class="p">;</span>
  <span class="n">dma_addr_t</span> <span class="n">CommandMailboxesMemoryDMA</span><span class="p">;</span>

  <span class="n">DAC960_V1_StatusMailbox_T</span> <span class="o">*</span><span class="n">StatusMailboxesMemory</span><span class="p">;</span>
  <span class="n">dma_addr_t</span> <span class="n">StatusMailboxesMemoryDMA</span><span class="p">;</span>

  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandStatus_T</span> <span class="n">CommandStatus</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">TimeoutCounter</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CommandMailbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_CommandMailbox_T</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span>
	<span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;DMA mask out of range&quot;</span><span class="p">);</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BounceBufferLimit</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">((</span><span class="n">hw_type</span> <span class="o">==</span> <span class="n">DAC960_PD_Controller</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">hw_type</span> <span class="o">==</span> <span class="n">DAC960_P_Controller</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">CommandMailboxesSize</span> <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
    <span class="n">StatusMailboxesSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">CommandMailboxesSize</span> <span class="o">=</span>  <span class="n">DAC960_V1_CommandMailboxCount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_CommandMailbox_T</span><span class="p">);</span>
    <span class="n">StatusMailboxesSize</span> <span class="o">=</span> <span class="n">DAC960_V1_StatusMailboxCount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_StatusMailbox_T</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">DmaPagesSize</span> <span class="o">=</span> <span class="n">CommandMailboxesSize</span> <span class="o">+</span> <span class="n">StatusMailboxesSize</span> <span class="o">+</span> 
	<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_DCDB_T</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_Enquiry_T</span><span class="p">)</span> <span class="o">+</span>
	<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_ErrorTable_T</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_EventLogEntry_T</span><span class="p">)</span> <span class="o">+</span>
	<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_RebuildProgress_T</span><span class="p">)</span> <span class="o">+</span>
	<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_LogicalDriveInformationArray_T</span><span class="p">)</span> <span class="o">+</span>
	<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_BackgroundInitializationStatus_T</span><span class="p">)</span> <span class="o">+</span>
	<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_DeviceState_T</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_T</span><span class="p">)</span> <span class="o">+</span>
	<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init_dma_loaf</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="n">DmaPages</span><span class="p">,</span> <span class="n">DmaPagesSize</span><span class="p">))</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>


  <span class="k">if</span> <span class="p">((</span><span class="n">hw_type</span> <span class="o">==</span> <span class="n">DAC960_PD_Controller</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">hw_type</span> <span class="o">==</span> <span class="n">DAC960_P_Controller</span><span class="p">))</span> 
	<span class="k">goto</span> <span class="n">skip_mailboxes</span><span class="p">;</span>

  <span class="n">CommandMailboxesMemory</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="n">CommandMailboxesSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">CommandMailboxesMemoryDMA</span><span class="p">);</span>
  
  <span class="cm">/* These are the base addresses for the command memory mailbox array */</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">FirstCommandMailbox</span> <span class="o">=</span> <span class="n">CommandMailboxesMemory</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">FirstCommandMailboxDMA</span> <span class="o">=</span> <span class="n">CommandMailboxesMemoryDMA</span><span class="p">;</span>

  <span class="n">CommandMailboxesMemory</span> <span class="o">+=</span> <span class="n">DAC960_V1_CommandMailboxCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastCommandMailbox</span> <span class="o">=</span> <span class="n">CommandMailboxesMemory</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">FirstCommandMailbox</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastCommandMailbox</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span> <span class="o">=</span>
	  				<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastCommandMailbox</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

  <span class="cm">/* These are the base addresses for the status memory mailbox array */</span>
  <span class="n">StatusMailboxesMemory</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="n">StatusMailboxesSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">StatusMailboxesMemoryDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">FirstStatusMailbox</span> <span class="o">=</span> <span class="n">StatusMailboxesMemory</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">FirstStatusMailboxDMA</span> <span class="o">=</span> <span class="n">StatusMailboxesMemoryDMA</span><span class="p">;</span>
  <span class="n">StatusMailboxesMemory</span> <span class="o">+=</span> <span class="n">DAC960_V1_StatusMailboxCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastStatusMailbox</span> <span class="o">=</span> <span class="n">StatusMailboxesMemory</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">FirstStatusMailbox</span><span class="p">;</span>

<span class="nl">skip_mailboxes:</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">MonitoringDCDB</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_DCDB_T</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">MonitoringDCDB_DMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewEnquiry</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_Enquiry_T</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewEnquiryDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewErrorTable</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_ErrorTable_T</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewErrorTableDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">EventLogEntry</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_EventLogEntry_T</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">EventLogEntryDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildProgress</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_RebuildProgress_T</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildProgressDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewLogicalDriveInformation</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_LogicalDriveInformationArray_T</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewLogicalDriveInformationDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatus</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_BackgroundInitializationStatus_T</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatusDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewDeviceState</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_DeviceState_T</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewDeviceStateDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewInquiryStandardData</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_T</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewInquiryStandardDataDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewInquiryUnitSerialNumber</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewInquiryUnitSerialNumberDMA</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">((</span><span class="n">hw_type</span> <span class="o">==</span> <span class="n">DAC960_PD_Controller</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">hw_type</span> <span class="o">==</span> <span class="n">DAC960_P_Controller</span><span class="p">))</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
 
  <span class="cm">/* Enable the Memory Mailbox Interface. */</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DualModeMemoryMailboxInterface</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="p">.</span><span class="n">TypeX</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="mh">0x2B</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="p">.</span><span class="n">TypeX</span><span class="p">.</span><span class="n">CommandIdentifier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="p">.</span><span class="n">TypeX</span><span class="p">.</span><span class="n">CommandOpcode2</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="p">.</span><span class="n">TypeX</span><span class="p">.</span><span class="n">CommandMailboxesBusAddress</span> <span class="o">=</span>
    				<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">FirstCommandMailboxDMA</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="p">.</span><span class="n">TypeX</span><span class="p">.</span><span class="n">StatusMailboxesBusAddress</span> <span class="o">=</span>
    				<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">FirstStatusMailboxDMA</span><span class="p">;</span>
<span class="cp">#define TIMEOUT_COUNT 1000000</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">HardwareType</span><span class="p">)</span>
      <span class="p">{</span>
      <span class="k">case</span> <span class="n">DAC960_LA_Controller</span>:
	<span class="n">TimeoutCounter</span> <span class="o">=</span> <span class="n">TIMEOUT_COUNT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">TimeoutCounter</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_LA_HardwareMailboxFullP</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">))</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	  <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TimeoutCounter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">DAC960_LA_WriteHardwareMailbox</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">CommandMailbox</span><span class="p">);</span>
	<span class="n">DAC960_LA_HardwareMailboxNewCommand</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
	<span class="n">TimeoutCounter</span> <span class="o">=</span> <span class="n">TIMEOUT_COUNT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">TimeoutCounter</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">DAC960_LA_HardwareMailboxStatusAvailableP</span><span class="p">(</span>
		  <span class="n">ControllerBaseAddress</span><span class="p">))</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	  <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TimeoutCounter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">DAC960_LA_ReadStatusRegister</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
	<span class="n">DAC960_LA_AcknowledgeHardwareMailboxInterrupt</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
	<span class="n">DAC960_LA_AcknowledgeHardwareMailboxStatus</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V1_NormalCompletion</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DualModeMemoryMailboxInterface</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">CommandMailbox</span><span class="p">.</span><span class="n">TypeX</span><span class="p">.</span><span class="n">CommandOpcode2</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">DAC960_PG_Controller</span>:
	<span class="n">TimeoutCounter</span> <span class="o">=</span> <span class="n">TIMEOUT_COUNT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">TimeoutCounter</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_PG_HardwareMailboxFullP</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">))</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	  <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TimeoutCounter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">DAC960_PG_WriteHardwareMailbox</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">CommandMailbox</span><span class="p">);</span>
	<span class="n">DAC960_PG_HardwareMailboxNewCommand</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>

	<span class="n">TimeoutCounter</span> <span class="o">=</span> <span class="n">TIMEOUT_COUNT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">TimeoutCounter</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">DAC960_PG_HardwareMailboxStatusAvailableP</span><span class="p">(</span>
		  <span class="n">ControllerBaseAddress</span><span class="p">))</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	  <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TimeoutCounter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">DAC960_PG_ReadStatusRegister</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
	<span class="n">DAC960_PG_AcknowledgeHardwareMailboxInterrupt</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
	<span class="n">DAC960_PG_AcknowledgeHardwareMailboxStatus</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V1_NormalCompletion</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DualModeMemoryMailboxInterface</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">CommandMailbox</span><span class="p">.</span><span class="n">TypeX</span><span class="p">.</span><span class="n">CommandOpcode2</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="nl">default:</span>
        <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;Unknown Controller Type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_EnableMemoryMailboxInterface enables the Memory Mailbox Interface</span>
<span class="cm">  for DAC960 V2 Firmware Controllers.</span>

<span class="cm">  Aggregate the space needed for the controller&#39;s memory mailbox and</span>
<span class="cm">  the other data structures that will be targets of dma transfers with</span>
<span class="cm">  the controller.  Allocate a dma-mapped region of memory to hold these</span>
<span class="cm">  structures.  Then, save CPU pointers and dma_addr_t values to reference</span>
<span class="cm">  the structures that are contained in that region.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V2_EnableMemoryMailboxInterface</span><span class="p">(</span><span class="n">DAC960_Controller_T</span>
						      <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">dma_loaf</span> <span class="o">*</span><span class="n">DmaPages</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DmaPages</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">DmaPagesSize</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">CommandMailboxesSize</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">StatusMailboxesSize</span><span class="p">;</span>

  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailboxesMemory</span><span class="p">;</span>
  <span class="n">dma_addr_t</span> <span class="n">CommandMailboxesMemoryDMA</span><span class="p">;</span>

  <span class="n">DAC960_V2_StatusMailbox_T</span> <span class="o">*</span><span class="n">StatusMailboxesMemory</span><span class="p">;</span>
  <span class="n">dma_addr_t</span> <span class="n">StatusMailboxesMemoryDMA</span><span class="p">;</span>

  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">dma_addr_t</span>	<span class="n">CommandMailboxDMA</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandStatus_T</span> <span class="n">CommandStatus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BounceBufferLimit</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BounceBufferLimit</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;DMA mask out of range&quot;</span><span class="p">);</span>

  <span class="cm">/* This is a temporary dma mapping, used only in the scope of this function */</span>
  <span class="n">CommandMailbox</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_CommandMailbox_T</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">CommandMailboxDMA</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">CommandMailbox</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

  <span class="n">CommandMailboxesSize</span> <span class="o">=</span> <span class="n">DAC960_V2_CommandMailboxCount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_CommandMailbox_T</span><span class="p">);</span>
  <span class="n">StatusMailboxesSize</span> <span class="o">=</span> <span class="n">DAC960_V2_StatusMailboxCount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_StatusMailbox_T</span><span class="p">);</span>
  <span class="n">DmaPagesSize</span> <span class="o">=</span>
    <span class="n">CommandMailboxesSize</span> <span class="o">+</span> <span class="n">StatusMailboxesSize</span> <span class="o">+</span>
    <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_HealthStatusBuffer_T</span><span class="p">)</span> <span class="o">+</span>
    <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_ControllerInfo_T</span><span class="p">)</span> <span class="o">+</span>
    <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_LogicalDeviceInfo_T</span><span class="p">)</span> <span class="o">+</span>
    <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_PhysicalDeviceInfo_T</span><span class="p">)</span> <span class="o">+</span>
    <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">)</span> <span class="o">+</span>
    <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_Event_T</span><span class="p">)</span> <span class="o">+</span>
    <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_PhysicalToLogicalDevice_T</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init_dma_loaf</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="n">DmaPages</span><span class="p">,</span> <span class="n">DmaPagesSize</span><span class="p">))</span> <span class="p">{</span>
  	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_CommandMailbox_T</span><span class="p">),</span>
					<span class="n">CommandMailbox</span><span class="p">,</span> <span class="n">CommandMailboxDMA</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">CommandMailboxesMemory</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
		<span class="n">CommandMailboxesSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">CommandMailboxesMemoryDMA</span><span class="p">);</span>

  <span class="cm">/* These are the base addresses for the command memory mailbox array */</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">FirstCommandMailbox</span> <span class="o">=</span> <span class="n">CommandMailboxesMemory</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">FirstCommandMailboxDMA</span> <span class="o">=</span> <span class="n">CommandMailboxesMemoryDMA</span><span class="p">;</span>

  <span class="n">CommandMailboxesMemory</span> <span class="o">+=</span> <span class="n">DAC960_V2_CommandMailboxCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LastCommandMailbox</span> <span class="o">=</span> <span class="n">CommandMailboxesMemory</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextCommandMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">FirstCommandMailbox</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox1</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LastCommandMailbox</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PreviousCommandMailbox2</span> <span class="o">=</span>
    					<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LastCommandMailbox</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

  <span class="cm">/* These are the base addresses for the status memory mailbox array */</span>
  <span class="n">StatusMailboxesMemory</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
		<span class="n">StatusMailboxesSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">StatusMailboxesMemoryDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">FirstStatusMailbox</span> <span class="o">=</span> <span class="n">StatusMailboxesMemory</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">FirstStatusMailboxDMA</span> <span class="o">=</span> <span class="n">StatusMailboxesMemoryDMA</span><span class="p">;</span>
  <span class="n">StatusMailboxesMemory</span> <span class="o">+=</span> <span class="n">DAC960_V2_StatusMailboxCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LastStatusMailbox</span> <span class="o">=</span> <span class="n">StatusMailboxesMemory</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">FirstStatusMailbox</span><span class="p">;</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">HealthStatusBuffer</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_HealthStatusBuffer_T</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">HealthStatusBufferDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewControllerInformation</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_ControllerInfo_T</span><span class="p">),</span> 
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewControllerInformationDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewLogicalDeviceInformation</span> <span class="o">=</span>  <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_LogicalDeviceInfo_T</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewLogicalDeviceInformationDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewPhysicalDeviceInformation</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_PhysicalDeviceInfo_T</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewPhysicalDeviceInformationDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewInquiryUnitSerialNumber</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewInquiryUnitSerialNumberDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">Event</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_Event_T</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">EventDMA</span><span class="p">);</span>

  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalToLogicalDevice</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="n">DmaPages</span><span class="p">,</span>
                <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_PhysicalToLogicalDevice_T</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalToLogicalDeviceDMA</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">    Enable the Memory Mailbox Interface.</span>
<span class="cm">    </span>
<span class="cm">    I don&#39;t know why we can&#39;t just use one of the memory mailboxes</span>
<span class="cm">    we just allocated to do this, instead of using this temporary one.</span>
<span class="cm">    Try this change later.</span>
<span class="cm">  */</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">CommandMailbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_CommandMailbox_T</span><span class="p">));</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetMemoryMailbox</span><span class="p">.</span><span class="n">CommandIdentifier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetMemoryMailbox</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V2_IOCTL</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetMemoryMailbox</span><span class="p">.</span><span class="n">CommandControlBits</span><span class="p">.</span><span class="n">NoAutoRequestSense</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetMemoryMailbox</span><span class="p">.</span><span class="n">FirstCommandMailboxSizeKB</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">DAC960_V2_CommandMailboxCount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_CommandMailbox_T</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetMemoryMailbox</span><span class="p">.</span><span class="n">FirstStatusMailboxSizeKB</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">DAC960_V2_StatusMailboxCount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_StatusMailbox_T</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetMemoryMailbox</span><span class="p">.</span><span class="n">SecondCommandMailboxSizeKB</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetMemoryMailbox</span><span class="p">.</span><span class="n">SecondStatusMailboxSizeKB</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetMemoryMailbox</span><span class="p">.</span><span class="n">RequestSenseSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetMemoryMailbox</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span> <span class="n">DAC960_V2_SetMemoryMailbox</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetMemoryMailbox</span><span class="p">.</span><span class="n">HealthStatusBufferSizeKB</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetMemoryMailbox</span><span class="p">.</span><span class="n">HealthStatusBufferBusAddress</span> <span class="o">=</span>
    					<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">HealthStatusBufferDMA</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetMemoryMailbox</span><span class="p">.</span><span class="n">FirstCommandMailboxBusAddress</span> <span class="o">=</span>
    					<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">FirstCommandMailboxDMA</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetMemoryMailbox</span><span class="p">.</span><span class="n">FirstStatusMailboxBusAddress</span> <span class="o">=</span>
    					<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">FirstStatusMailboxDMA</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">HardwareType</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">DAC960_GEM_Controller</span>:
      <span class="k">while</span> <span class="p">(</span><span class="n">DAC960_GEM_HardwareMailboxFullP</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">))</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">DAC960_GEM_WriteHardwareMailbox</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">,</span> <span class="n">CommandMailboxDMA</span><span class="p">);</span>
      <span class="n">DAC960_GEM_HardwareMailboxNewCommand</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_GEM_HardwareMailboxStatusAvailableP</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">))</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">DAC960_GEM_ReadCommandStatus</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="n">DAC960_GEM_AcknowledgeHardwareMailboxInterrupt</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="n">DAC960_GEM_AcknowledgeHardwareMailboxStatus</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_BA_Controller</span>:
      <span class="k">while</span> <span class="p">(</span><span class="n">DAC960_BA_HardwareMailboxFullP</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">))</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">DAC960_BA_WriteHardwareMailbox</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">,</span> <span class="n">CommandMailboxDMA</span><span class="p">);</span>
      <span class="n">DAC960_BA_HardwareMailboxNewCommand</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_BA_HardwareMailboxStatusAvailableP</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">))</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">DAC960_BA_ReadCommandStatus</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="n">DAC960_BA_AcknowledgeHardwareMailboxInterrupt</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="n">DAC960_BA_AcknowledgeHardwareMailboxStatus</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_LP_Controller</span>:
      <span class="k">while</span> <span class="p">(</span><span class="n">DAC960_LP_HardwareMailboxFullP</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">))</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">DAC960_LP_WriteHardwareMailbox</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">,</span> <span class="n">CommandMailboxDMA</span><span class="p">);</span>
      <span class="n">DAC960_LP_HardwareMailboxNewCommand</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_LP_HardwareMailboxStatusAvailableP</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">))</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">DAC960_LP_ReadCommandStatus</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="n">DAC960_LP_AcknowledgeHardwareMailboxInterrupt</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="n">DAC960_LP_AcknowledgeHardwareMailboxStatus</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;Unknown Controller Type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">DAC960_V2_AbormalCompletion</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_CommandMailbox_T</span><span class="p">),</span>
					<span class="n">CommandMailbox</span><span class="p">,</span> <span class="n">CommandMailboxDMA</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V1_ReadControllerConfiguration reads the Configuration Information</span>
<span class="cm">  from DAC960 V1 Firmware Controllers and initializes the Controller structure.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V1_ReadControllerConfiguration</span><span class="p">(</span><span class="n">DAC960_Controller_T</span>
						     <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_V1_Enquiry2_T</span> <span class="o">*</span><span class="n">Enquiry2</span><span class="p">;</span>
  <span class="n">dma_addr_t</span> <span class="n">Enquiry2DMA</span><span class="p">;</span>
  <span class="n">DAC960_V1_Config2_T</span> <span class="o">*</span><span class="n">Config2</span><span class="p">;</span>
  <span class="n">dma_addr_t</span> <span class="n">Config2DMA</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">LogicalDriveNumber</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">dma_loaf</span> <span class="n">local_dma</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init_dma_loaf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_dma</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_Enquiry2_T</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_Config2_T</span><span class="p">)))</span>
	<span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;LOGICAL DEVICE ALLOCATION&quot;</span><span class="p">);</span>

  <span class="n">Enquiry2</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_dma</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_Enquiry2_T</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">Enquiry2DMA</span><span class="p">);</span>
  <span class="n">Config2</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_dma</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_Config2_T</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">Config2DMA</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V1_ExecuteType3</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">DAC960_V1_Enquiry</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewEnquiryDMA</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">free_dma_loaf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_dma</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;ENQUIRY&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">Enquiry</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewEnquiry</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_Enquiry_T</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V1_ExecuteType3</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">DAC960_V1_Enquiry2</span><span class="p">,</span> <span class="n">Enquiry2DMA</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">free_dma_loaf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_dma</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;ENQUIRY2&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V1_ExecuteType3</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">DAC960_V1_ReadConfig2</span><span class="p">,</span> <span class="n">Config2DMA</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">free_dma_loaf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_dma</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;READ CONFIG2&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V1_ExecuteType3</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">DAC960_V1_GetLogicalDriveInformation</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewLogicalDriveInformationDMA</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">free_dma_loaf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_dma</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;GET LOGICAL DRIVE INFORMATION&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LogicalDriveInformation</span><span class="p">,</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewLogicalDriveInformation</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_LogicalDriveInformationArray_T</span><span class="p">));</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">Channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">Channel</span> <span class="o">&lt;</span> <span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">ActualChannels</span><span class="p">;</span> <span class="n">Channel</span><span class="o">++</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">MaxTargets</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V1_ExecuteType3D</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">DAC960_V1_GetDeviceState</span><span class="p">,</span>
				   <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
				   <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewDeviceStateDMA</span><span class="p">))</span> <span class="p">{</span>
    		<span class="n">free_dma_loaf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_dma</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;GET DEVICE STATE&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceState</span><span class="p">[</span><span class="n">Channel</span><span class="p">][</span><span class="n">TargetID</span><span class="p">],</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewDeviceState</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_DeviceState_T</span><span class="p">));</span>
     <span class="p">}</span>
  <span class="cm">/*</span>
<span class="cm">    Initialize the Controller Model Name and Full Model Name fields.</span>
<span class="cm">  */</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">HardwareID</span><span class="p">.</span><span class="n">SubModel</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">DAC960_V1_P_PD_PU</span>:
      <span class="k">if</span> <span class="p">(</span><span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">SCSICapability</span><span class="p">.</span><span class="n">BusSpeed</span> <span class="o">==</span> <span class="n">DAC960_V1_Ultra</span><span class="p">)</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span> <span class="s">&quot;DAC960PU&quot;</span><span class="p">);</span>
      <span class="k">else</span> <span class="n">strcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span> <span class="s">&quot;DAC960PD&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_PL</span>:
      <span class="n">strcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span> <span class="s">&quot;DAC960PL&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_PG</span>:
      <span class="n">strcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span> <span class="s">&quot;DAC960PG&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_PJ</span>:
      <span class="n">strcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span> <span class="s">&quot;DAC960PJ&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_PR</span>:
      <span class="n">strcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span> <span class="s">&quot;DAC960PR&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_PT</span>:
      <span class="n">strcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span> <span class="s">&quot;DAC960PT&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_PTL0</span>:
      <span class="n">strcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span> <span class="s">&quot;DAC960PTL0&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_PRL</span>:
      <span class="n">strcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span> <span class="s">&quot;DAC960PRL&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_PTL1</span>:
      <span class="n">strcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span> <span class="s">&quot;DAC960PTL1&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_1164P</span>:
      <span class="n">strcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span> <span class="s">&quot;DAC1164P&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">free_dma_loaf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_dma</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;MODEL VERIFICATION&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">,</span> <span class="s">&quot;Mylex &quot;</span><span class="p">);</span>
  <span class="n">strcat</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">);</span>
  <span class="cm">/*</span>
<span class="cm">    Initialize the Controller Firmware Version field and verify that it</span>
<span class="cm">    is a supported firmware version.  The supported firmware versions are:</span>

<span class="cm">    DAC1164P		    5.06 and above</span>
<span class="cm">    DAC960PTL/PRL/PJ/PG	    4.06 and above</span>
<span class="cm">    DAC960PU/PD/PL	    3.51 and above</span>
<span class="cm">    DAC960PU/PD/PL/P	    2.73 and above</span>
<span class="cm">  */</span>
<span class="cp">#if defined(CONFIG_ALPHA)</span>
  <span class="cm">/*</span>
<span class="cm">    DEC Alpha machines were often equipped with DAC960 cards that were</span>
<span class="cm">    OEMed from Mylex, and had their own custom firmware. Version 2.70,</span>
<span class="cm">    the last custom FW revision to be released by DEC for these older</span>
<span class="cm">    controllers, appears to work quite well with this driver.</span>

<span class="cm">    Cards tested successfully were several versions each of the PD and</span>
<span class="cm">    PU, called by DEC the KZPSC and KZPAC, respectively, and having</span>
<span class="cm">    the Manufacturer Numbers (from Mylex), usually on a sticker on the</span>
<span class="cm">    back of the board, of:</span>

<span class="cm">    KZPSC:  D040347 (1-channel) or D040348 (2-channel) or D040349 (3-channel)</span>
<span class="cm">    KZPAC:  D040395 (1-channel) or D040396 (2-channel) or D040397 (3-channel)</span>
<span class="cm">  */</span>
<span class="cp"># define FIRMWARE_27X	&quot;2.70&quot;</span>
<span class="cp">#else</span>
<span class="cp"># define FIRMWARE_27X	&quot;2.73&quot;</span>
<span class="cp">#endif</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">FirmwareID</span><span class="p">.</span><span class="n">MajorVersion</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">FirmwareID</span><span class="p">.</span><span class="n">MajorVersion</span> <span class="o">=</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">Enquiry</span><span class="p">.</span><span class="n">MajorFirmwareVersion</span><span class="p">;</span>
      <span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">FirmwareID</span><span class="p">.</span><span class="n">MinorVersion</span> <span class="o">=</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">Enquiry</span><span class="p">.</span><span class="n">MinorFirmwareVersion</span><span class="p">;</span>
      <span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">FirmwareID</span><span class="p">.</span><span class="n">FirmwareType</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
      <span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">FirmwareID</span><span class="p">.</span><span class="n">TurnID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="s">&quot;%d.%02d-%c-%02d&quot;</span><span class="p">,</span>
	  <span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">FirmwareID</span><span class="p">.</span><span class="n">MajorVersion</span><span class="p">,</span> <span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">FirmwareID</span><span class="p">.</span><span class="n">MinorVersion</span><span class="p">,</span>
	  <span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">FirmwareID</span><span class="p">.</span><span class="n">FirmwareType</span><span class="p">,</span> <span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">FirmwareID</span><span class="p">.</span><span class="n">TurnID</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;5&#39;</span> <span class="o">&amp;&amp;</span>
	 <span class="n">strcmp</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="s">&quot;5.06&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	<span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;4&#39;</span> <span class="o">&amp;&amp;</span>
	 <span class="n">strcmp</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="s">&quot;4.06&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	<span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;3&#39;</span> <span class="o">&amp;&amp;</span>
	 <span class="n">strcmp</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="s">&quot;3.51&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	<span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;2&#39;</span> <span class="o">&amp;&amp;</span>
	 <span class="n">strcmp</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="n">FIRMWARE_27X</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="p">{</span>
      <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;FIRMWARE VERSION VERIFICATION&quot;</span><span class="p">);</span>
      <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Firmware Version = &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		   <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">);</span>
      <span class="n">free_dma_loaf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_dma</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="cm">/*</span>
<span class="cm">    Initialize the Controller Channels, Targets, Memory Size, and SAF-TE</span>
<span class="cm">    Enclosure Management Enabled fields.</span>
<span class="cm">  */</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Channels</span> <span class="o">=</span> <span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">ActualChannels</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Targets</span> <span class="o">=</span> <span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">MaxTargets</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MemorySize</span> <span class="o">=</span> <span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">MemorySize</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">SAFTE_EnclosureManagementEnabled</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">FaultManagementType</span> <span class="o">==</span> <span class="n">DAC960_V1_SAFTE</span><span class="p">);</span>
  <span class="cm">/*</span>
<span class="cm">    Initialize the Controller Queue Depth, Driver Queue Depth, Logical Drive</span>
<span class="cm">    Count, Maximum Blocks per Command, Controller Scatter/Gather Limit, and</span>
<span class="cm">    Driver Scatter/Gather Limit.  The Driver Queue Depth must be at most one</span>
<span class="cm">    less than the Controller Queue Depth to allow for an automatic drive</span>
<span class="cm">    rebuild operation.</span>
<span class="cm">  */</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerQueueDepth</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">Enquiry</span><span class="p">.</span><span class="n">MaxCommands</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerQueueDepth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span> <span class="o">&gt;</span> <span class="n">DAC960_MaxDriverQueueDepth</span><span class="p">)</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span> <span class="o">=</span> <span class="n">DAC960_MaxDriverQueueDepth</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LogicalDriveCount</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">Enquiry</span><span class="p">.</span><span class="n">NumberOfLogicalDrives</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MaxBlocksPerCommand</span> <span class="o">=</span> <span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">MaxBlocksPerCommand</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerScatterGatherLimit</span> <span class="o">=</span> <span class="n">Enquiry2</span><span class="o">-&gt;</span><span class="n">MaxScatterGatherEntries</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverScatterGatherLimit</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerScatterGatherLimit</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverScatterGatherLimit</span> <span class="o">&gt;</span> <span class="n">DAC960_V1_ScatterGatherLimit</span><span class="p">)</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverScatterGatherLimit</span> <span class="o">=</span> <span class="n">DAC960_V1_ScatterGatherLimit</span><span class="p">;</span>
  <span class="cm">/*</span>
<span class="cm">    Initialize the Stripe Size, Segment Size, and Geometry Translation.</span>
<span class="cm">  */</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">StripeSize</span> <span class="o">=</span> <span class="n">Config2</span><span class="o">-&gt;</span><span class="n">BlocksPerStripe</span> <span class="o">*</span> <span class="n">Config2</span><span class="o">-&gt;</span><span class="n">BlockFactor</span>
			      <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="n">DAC960_BlockSizeBits</span><span class="p">);</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">SegmentSize</span> <span class="o">=</span> <span class="n">Config2</span><span class="o">-&gt;</span><span class="n">BlocksPerCacheLine</span> <span class="o">*</span> <span class="n">Config2</span><span class="o">-&gt;</span><span class="n">BlockFactor</span>
			       <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="n">DAC960_BlockSizeBits</span><span class="p">);</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Config2</span><span class="o">-&gt;</span><span class="n">DriveGeometry</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">DAC960_V1_Geometry_128_32</span>:
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">GeometryTranslationHeads</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">GeometryTranslationSectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_Geometry_255_63</span>:
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">GeometryTranslationHeads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">GeometryTranslationSectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">free_dma_loaf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_dma</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;CONFIG2 DRIVE GEOMETRY&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="cm">/*</span>
<span class="cm">    Initialize the Background Initialization Status.</span>
<span class="cm">  */</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;4&#39;</span> <span class="o">&amp;&amp;</span>
      <span class="n">strcmp</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="s">&quot;4.08&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
      <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;5&#39;</span> <span class="o">&amp;&amp;</span>
       <span class="n">strcmp</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="s">&quot;5.08&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatusSupported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">DAC960_V1_ExecuteType3B</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span>
			      <span class="n">DAC960_V1_BackgroundInitializationControl</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="o">-&gt;</span>
			       <span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatusDMA</span><span class="p">);</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastBackgroundInitializationStatus</span><span class="p">,</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatus</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_BackgroundInitializationStatus_T</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="cm">/*</span>
<span class="cm">    Initialize the Logical Drive Initially Accessible flag.</span>
<span class="cm">  */</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">LogicalDriveNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
       <span class="n">LogicalDriveNumber</span> <span class="o">&lt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LogicalDriveCount</span><span class="p">;</span>
       <span class="n">LogicalDriveNumber</span><span class="o">++</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LogicalDriveInformation</span>
		       <span class="p">[</span><span class="n">LogicalDriveNumber</span><span class="p">].</span><span class="n">LogicalDriveState</span> <span class="o">!=</span>
	<span class="n">DAC960_V1_LogicalDrive_Offline</span><span class="p">)</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LogicalDriveInitiallyAccessible</span><span class="p">[</span><span class="n">LogicalDriveNumber</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastRebuildStatus</span> <span class="o">=</span> <span class="n">DAC960_V1_NoRebuildOrCheckInProgress</span><span class="p">;</span>
  <span class="n">free_dma_loaf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_dma</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_ReadControllerConfiguration reads the Configuration Information</span>
<span class="cm">  from DAC960 V2 Firmware Controllers and initializes the Controller structure.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V2_ReadControllerConfiguration</span><span class="p">(</span><span class="n">DAC960_Controller_T</span>
						     <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_V2_ControllerInfo_T</span> <span class="o">*</span><span class="n">ControllerInfo</span> <span class="o">=</span>
    		<span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">ControllerInformation</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">LogicalDeviceNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ModelNameLength</span><span class="p">;</span>

  <span class="cm">/* Get data into dma-able area, then copy into permanent location */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V2_NewControllerInfo</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;GET CONTROLLER INFO&quot;</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">ControllerInfo</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewControllerInformation</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_ControllerInfo_T</span><span class="p">));</span>
	 
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V2_GeneralInfo</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;GET HEALTH STATUS&quot;</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">    Initialize the Controller Model Name and Full Model Name fields.</span>
<span class="cm">  */</span>
  <span class="n">ModelNameLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">ControllerName</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ModelNameLength</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ModelNameLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">,</span> <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">ControllerName</span><span class="p">,</span>
	 <span class="n">ModelNameLength</span><span class="p">);</span>
  <span class="n">ModelNameLength</span><span class="o">--</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">[</span><span class="n">ModelNameLength</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span>
	 <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">[</span><span class="n">ModelNameLength</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
    <span class="n">ModelNameLength</span><span class="o">--</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">[</span><span class="o">++</span><span class="n">ModelNameLength</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">,</span> <span class="s">&quot;Mylex &quot;</span><span class="p">);</span>
  <span class="n">strcat</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">);</span>
  <span class="cm">/*</span>
<span class="cm">    Initialize the Controller Firmware Version field.</span>
<span class="cm">  */</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="s">&quot;%d.%02d-%02d&quot;</span><span class="p">,</span>
	  <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">FirmwareMajorVersion</span><span class="p">,</span>
	  <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">FirmwareMinorVersion</span><span class="p">,</span>
	  <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">FirmwareTurnNumber</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">FirmwareMajorVersion</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span>
      <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">FirmwareMinorVersion</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
      <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">FirmwareTurnNumber</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;FIRMWARE VERSION %s DOES NOT PROVIDE THE CONTROLLER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">);</span>
      <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;STATUS MONITORING FUNCTIONALITY NEEDED BY THIS DRIVER.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">Controller</span><span class="p">);</span>
      <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;PLEASE UPGRADE TO VERSION 6.00-01 OR ABOVE.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">Controller</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="cm">/*</span>
<span class="cm">    Initialize the Controller Channels, Targets, and Memory Size.</span>
<span class="cm">  */</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Channels</span> <span class="o">=</span> <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">NumberOfPhysicalChannelsPresent</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Targets</span> <span class="o">=</span>
    <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">MaximumTargetsPerChannel</span>
		    <span class="p">[</span><span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">NumberOfPhysicalChannelsPresent</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MemorySize</span> <span class="o">=</span> <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">MemorySizeMB</span><span class="p">;</span>
  <span class="cm">/*</span>
<span class="cm">    Initialize the Controller Queue Depth, Driver Queue Depth, Logical Drive</span>
<span class="cm">    Count, Maximum Blocks per Command, Controller Scatter/Gather Limit, and</span>
<span class="cm">    Driver Scatter/Gather Limit.  The Driver Queue Depth must be at most one</span>
<span class="cm">    less than the Controller Queue Depth to allow for an automatic drive</span>
<span class="cm">    rebuild operation.</span>
<span class="cm">  */</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerQueueDepth</span> <span class="o">=</span> <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">MaximumParallelCommands</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerQueueDepth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span> <span class="o">&gt;</span> <span class="n">DAC960_MaxDriverQueueDepth</span><span class="p">)</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span> <span class="o">=</span> <span class="n">DAC960_MaxDriverQueueDepth</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LogicalDriveCount</span> <span class="o">=</span> <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">LogicalDevicesPresent</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MaxBlocksPerCommand</span> <span class="o">=</span>
    <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">MaximumDataTransferSizeInBlocks</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerScatterGatherLimit</span> <span class="o">=</span>
    <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">MaximumScatterGatherEntries</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverScatterGatherLimit</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerScatterGatherLimit</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverScatterGatherLimit</span> <span class="o">&gt;</span> <span class="n">DAC960_V2_ScatterGatherLimit</span><span class="p">)</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverScatterGatherLimit</span> <span class="o">=</span> <span class="n">DAC960_V2_ScatterGatherLimit</span><span class="p">;</span>
  <span class="cm">/*</span>
<span class="cm">    Initialize the Logical Device Information.</span>
<span class="cm">  */</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_V2_LogicalDeviceInfo_T</span> <span class="o">*</span><span class="n">NewLogicalDeviceInfo</span> <span class="o">=</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewLogicalDeviceInformation</span><span class="p">;</span>
      <span class="n">DAC960_V2_LogicalDeviceInfo_T</span> <span class="o">*</span><span class="n">LogicalDeviceInfo</span><span class="p">;</span>
      <span class="n">DAC960_V2_PhysicalDevice_T</span> <span class="n">PhysicalDevice</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V2_NewLogicalDeviceInfo</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">LogicalDeviceNumber</span><span class="p">))</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="n">LogicalDeviceNumber</span> <span class="o">=</span> <span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceNumber</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">LogicalDeviceNumber</span> <span class="o">&gt;=</span> <span class="n">DAC960_MaxLogicalDrives</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;DAC960: Logical Drive Number %d not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">Controller</span><span class="p">,</span> <span class="n">LogicalDeviceNumber</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">DeviceBlockSizeInBytes</span> <span class="o">!=</span> <span class="n">DAC960_BlockSize</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;DAC960: Logical Drive Block Size %d not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">Controller</span><span class="p">,</span> <span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">DeviceBlockSizeInBytes</span><span class="p">);</span>
        <span class="n">LogicalDeviceNumber</span><span class="o">++</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">Controller</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">Channel</span> <span class="o">=</span> <span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">;</span>
      <span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">;</span>
      <span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">LogicalUnit</span> <span class="o">=</span> <span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span><span class="p">;</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDriveToVirtualDevice</span><span class="p">[</span><span class="n">LogicalDeviceNumber</span><span class="p">]</span> <span class="o">=</span>
	<span class="n">PhysicalDevice</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceState</span> <span class="o">!=</span>
	  <span class="n">DAC960_V2_LogicalDevice_Offline</span><span class="p">)</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LogicalDriveInitiallyAccessible</span><span class="p">[</span><span class="n">LogicalDeviceNumber</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">LogicalDeviceInfo</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_LogicalDeviceInfo_T</span><span class="p">),</span>
				   <span class="n">GFP_ATOMIC</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;LOGICAL DEVICE ALLOCATION&quot;</span><span class="p">);</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDeviceInformation</span><span class="p">[</span><span class="n">LogicalDeviceNumber</span><span class="p">]</span> <span class="o">=</span>
	<span class="n">LogicalDeviceInfo</span><span class="p">;</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="p">,</span> <span class="n">NewLogicalDeviceInfo</span><span class="p">,</span>
	     <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_LogicalDeviceInfo_T</span><span class="p">));</span>
      <span class="n">LogicalDeviceNumber</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_ReportControllerConfiguration reports the Configuration Information</span>
<span class="cm">  for Controller.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_ReportControllerConfiguration</span><span class="p">(</span><span class="n">DAC960_Controller_T</span>
						    <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;Configuring Mylex %s PCI RAID Controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">);</span>
  <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;  Firmware Version: %s, Channels: %d, Memory Size: %dMB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">,</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MemorySize</span><span class="p">);</span>
  <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;  PCI Bus: %d, Device: %d, Function: %d, I/O Address: &quot;</span><span class="p">,</span>
	      <span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Device</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Function</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;Unassigned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
  <span class="k">else</span> <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">);</span>
  <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;  PCI Address: 0x%X mapped at 0x%lX, IRQ Channel: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCI_Address</span><span class="p">,</span>
	      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">,</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span><span class="p">);</span>
  <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;  Controller Queue Depth: %d, &quot;</span>
	      <span class="s">&quot;Maximum Blocks per Command: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerQueueDepth</span><span class="p">,</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MaxBlocksPerCommand</span><span class="p">);</span>
  <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;  Driver Queue Depth: %d, &quot;</span>
	      <span class="s">&quot;Scatter/Gather Limit: %d of %d Segments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverQueueDepth</span><span class="p">,</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverScatterGatherLimit</span><span class="p">,</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerScatterGatherLimit</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">==</span> <span class="n">DAC960_V1_Controller</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;  Stripe Size: %dKB, Segment Size: %dKB, &quot;</span>
		  <span class="s">&quot;BIOS Geometry: %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">StripeSize</span><span class="p">,</span>
		  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">SegmentSize</span><span class="p">,</span>
		  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">GeometryTranslationHeads</span><span class="p">,</span>
		  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">GeometryTranslationSectors</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">SAFTE_EnclosureManagementEnabled</span><span class="p">)</span>
	<span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;  SAF-TE Enclosure Management Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V1_ReadDeviceConfiguration reads the Device Configuration Information</span>
<span class="cm">  for DAC960 V1 Firmware Controllers by requesting the SCSI Inquiry and SCSI</span>
<span class="cm">  Inquiry Unit Serial Number information for each device connected to</span>
<span class="cm">  Controller.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V1_ReadDeviceConfiguration</span><span class="p">(</span><span class="n">DAC960_Controller_T</span>
						 <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">dma_loaf</span> <span class="n">local_dma</span><span class="p">;</span>

  <span class="n">dma_addr_t</span> <span class="n">DCDBs_dma</span><span class="p">[</span><span class="n">DAC960_V1_MaxChannels</span><span class="p">];</span>
  <span class="n">DAC960_V1_DCDB_T</span> <span class="o">*</span><span class="n">DCDBs_cpu</span><span class="p">[</span><span class="n">DAC960_V1_MaxChannels</span><span class="p">];</span>

  <span class="n">dma_addr_t</span> <span class="n">SCSI_Inquiry_dma</span><span class="p">[</span><span class="n">DAC960_V1_MaxChannels</span><span class="p">];</span>
  <span class="n">DAC960_SCSI_Inquiry_T</span> <span class="o">*</span><span class="n">SCSI_Inquiry_cpu</span><span class="p">[</span><span class="n">DAC960_V1_MaxChannels</span><span class="p">];</span>

  <span class="n">dma_addr_t</span> <span class="n">SCSI_NewInquiryUnitSerialNumberDMA</span><span class="p">[</span><span class="n">DAC960_V1_MaxChannels</span><span class="p">];</span>
  <span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span> <span class="o">*</span><span class="n">SCSI_NewInquiryUnitSerialNumberCPU</span><span class="p">[</span><span class="n">DAC960_V1_MaxChannels</span><span class="p">];</span>

  <span class="k">struct</span> <span class="n">completion</span> <span class="n">Completions</span><span class="p">[</span><span class="n">DAC960_V1_MaxChannels</span><span class="p">];</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init_dma_loaf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_dma</span><span class="p">,</span> 
		<span class="n">DAC960_V1_MaxChannels</span><span class="o">*</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_DCDB_T</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_T</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">))))</span>
     <span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span>
                        <span class="s">&quot;DMA ALLOCATION FAILED IN ReadDeviceConfiguration&quot;</span><span class="p">);</span> 
   
  <span class="k">for</span> <span class="p">(</span><span class="n">Channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">Channel</span> <span class="o">&lt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">;</span> <span class="n">Channel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">DCDBs_cpu</span><span class="p">[</span><span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_dma</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_DCDB_T</span><span class="p">),</span> <span class="n">DCDBs_dma</span> <span class="o">+</span> <span class="n">Channel</span><span class="p">);</span>
	<span class="n">SCSI_Inquiry_cpu</span><span class="p">[</span><span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_dma</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_T</span><span class="p">),</span>
			<span class="n">SCSI_Inquiry_dma</span> <span class="o">+</span> <span class="n">Channel</span><span class="p">);</span>
	<span class="n">SCSI_NewInquiryUnitSerialNumberCPU</span><span class="p">[</span><span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">slice_dma_loaf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_dma</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">),</span>
			<span class="n">SCSI_NewInquiryUnitSerialNumberDMA</span> <span class="o">+</span> <span class="n">Channel</span><span class="p">);</span>
  <span class="p">}</span>
		
  <span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Targets</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">       * For each channel, submit a probe for a device on that channel.</span>
<span class="cm">       * The timeout interval for a device that is present is 10 seconds.</span>
<span class="cm">       * With this approach, the timeout periods can elapse in parallel</span>
<span class="cm">       * on each channel.</span>
<span class="cm">       */</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">Channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">Channel</span> <span class="o">&lt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">;</span> <span class="n">Channel</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">dma_addr_t</span> <span class="n">NewInquiryStandardDataDMA</span> <span class="o">=</span> <span class="n">SCSI_Inquiry_dma</span><span class="p">[</span><span class="n">Channel</span><span class="p">];</span>
  	  <span class="n">DAC960_V1_DCDB_T</span> <span class="o">*</span><span class="n">DCDB</span> <span class="o">=</span> <span class="n">DCDBs_cpu</span><span class="p">[</span><span class="n">Channel</span><span class="p">];</span>
  	  <span class="n">dma_addr_t</span> <span class="n">DCDB_dma</span> <span class="o">=</span> <span class="n">DCDBs_dma</span><span class="p">[</span><span class="n">Channel</span><span class="p">];</span>
	  <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Commands</span><span class="p">[</span><span class="n">Channel</span><span class="p">];</span>
          <span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">Completion</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Completions</span><span class="p">[</span><span class="n">Channel</span><span class="p">];</span>

	  <span class="n">init_completion</span><span class="p">(</span><span class="n">Completion</span><span class="p">);</span>
	  <span class="n">DAC960_V1_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Completion</span> <span class="o">=</span> <span class="n">Completion</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_DCDB</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span> <span class="n">DCDB_dma</span><span class="p">;</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">Channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">;</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">TargetID</span><span class="p">;</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">DAC960_V1_DCDB_DataTransferDeviceToSystem</span><span class="p">;</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">EarlyStatus</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="n">DAC960_V1_DCDB_Timeout_10_seconds</span><span class="p">;</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">NoAutomaticRequestSense</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">DisconnectPermitted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">TransferLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_T</span><span class="p">);</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">BusAddress</span> <span class="o">=</span> <span class="n">NewInquiryStandardDataDMA</span><span class="p">;</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDBLength</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">TransferLengthHigh4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">SenseLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">SenseData</span><span class="p">);</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span> <span class="cm">/* INQUIRY */</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* EVPD = 0 */</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Page Code */</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Reserved */</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_T</span><span class="p">);</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Control */</span>

	  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
      <span class="cm">/*</span>
<span class="cm">       * Wait for the problems submitted in the previous loop</span>
<span class="cm">       * to complete.  On the probes that are successful, </span>
<span class="cm">       * get the serial number of the device that was found.</span>
<span class="cm">       */</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">Channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">Channel</span> <span class="o">&lt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">;</span> <span class="n">Channel</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">DAC960_SCSI_Inquiry_T</span> <span class="o">*</span><span class="n">InquiryStandardData</span> <span class="o">=</span>
	    <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">InquiryStandardData</span><span class="p">[</span><span class="n">Channel</span><span class="p">][</span><span class="n">TargetID</span><span class="p">];</span>
	  <span class="n">DAC960_SCSI_Inquiry_T</span> <span class="o">*</span><span class="n">NewInquiryStandardData</span> <span class="o">=</span> <span class="n">SCSI_Inquiry_cpu</span><span class="p">[</span><span class="n">Channel</span><span class="p">];</span>
	  <span class="n">dma_addr_t</span> <span class="n">NewInquiryUnitSerialNumberDMA</span> <span class="o">=</span>
			<span class="n">SCSI_NewInquiryUnitSerialNumberDMA</span><span class="p">[</span><span class="n">Channel</span><span class="p">];</span>
	  <span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span> <span class="o">*</span><span class="n">NewInquiryUnitSerialNumber</span> <span class="o">=</span>
	    		<span class="n">SCSI_NewInquiryUnitSerialNumberCPU</span><span class="p">[</span><span class="n">Channel</span><span class="p">];</span>
	  <span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span> <span class="o">*</span><span class="n">InquiryUnitSerialNumber</span> <span class="o">=</span>
	    <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span><span class="p">[</span><span class="n">Channel</span><span class="p">][</span><span class="n">TargetID</span><span class="p">];</span>
	  <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Commands</span><span class="p">[</span><span class="n">Channel</span><span class="p">];</span>
  	  <span class="n">DAC960_V1_DCDB_T</span> <span class="o">*</span><span class="n">DCDB</span> <span class="o">=</span> <span class="n">DCDBs_cpu</span><span class="p">[</span><span class="n">Channel</span><span class="p">];</span>
          <span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">Completion</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Completions</span><span class="p">[</span><span class="n">Channel</span><span class="p">];</span>

	  <span class="n">wait_for_completion</span><span class="p">(</span><span class="n">Completion</span><span class="p">);</span>

	  <span class="k">if</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span> <span class="o">!=</span> <span class="n">DAC960_V1_NormalCompletion</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">memset</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_T</span><span class="p">));</span>
	    <span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">PeripheralDeviceType</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
	    <span class="k">continue</span><span class="p">;</span>
	  <span class="p">}</span> <span class="k">else</span>
	    <span class="n">memcpy</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="p">,</span> <span class="n">NewInquiryStandardData</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_T</span><span class="p">));</span>
	
	  <span class="cm">/* Preserve Channel and TargetID values from the previous loop */</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Completion</span> <span class="o">=</span> <span class="n">Completion</span><span class="p">;</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">TransferLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">);</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">BusAddress</span> <span class="o">=</span> <span class="n">NewInquiryUnitSerialNumberDMA</span><span class="p">;</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">SenseLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">SenseData</span><span class="p">);</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span> <span class="cm">/* INQUIRY */</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* EVPD = 1 */</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* Page Code */</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Reserved */</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">);</span>
	  <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Control */</span>

	  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	  <span class="n">wait_for_completion</span><span class="p">(</span><span class="n">Completion</span><span class="p">);</span>

	  <span class="k">if</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span> <span class="o">!=</span> <span class="n">DAC960_V1_NormalCompletion</span><span class="p">)</span> <span class="p">{</span>
	  	<span class="n">memset</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">));</span>
	  	<span class="n">InquiryUnitSerialNumber</span><span class="o">-&gt;</span><span class="n">PeripheralDeviceType</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
	  <span class="p">}</span> <span class="k">else</span>
	  	<span class="n">memcpy</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="p">,</span> <span class="n">NewInquiryUnitSerialNumber</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">));</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="n">free_dma_loaf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_dma</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_ReadDeviceConfiguration reads the Device Configuration Information</span>
<span class="cm">  for DAC960 V2 Firmware Controllers by requesting the Physical Device</span>
<span class="cm">  Information and SCSI Inquiry Unit Serial Number information for each</span>
<span class="cm">  device connected to Controller.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V2_ReadDeviceConfiguration</span><span class="p">(</span><span class="n">DAC960_Controller_T</span>
						 <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LogicalUnit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">PhysicalDeviceIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_V2_PhysicalDeviceInfo_T</span> <span class="o">*</span><span class="n">NewPhysicalDeviceInfo</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewPhysicalDeviceInformation</span><span class="p">;</span>
      <span class="n">DAC960_V2_PhysicalDeviceInfo_T</span> <span class="o">*</span><span class="n">PhysicalDeviceInfo</span><span class="p">;</span>
      <span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span> <span class="o">*</span><span class="n">NewInquiryUnitSerialNumber</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewInquiryUnitSerialNumber</span><span class="p">;</span>
      <span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span> <span class="o">*</span><span class="n">InquiryUnitSerialNumber</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V2_NewPhysicalDeviceInfo</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span> <span class="n">LogicalUnit</span><span class="p">))</span>
	  <span class="k">break</span><span class="p">;</span>

      <span class="n">PhysicalDeviceInfo</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_PhysicalDeviceInfo_T</span><span class="p">),</span>
				    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">PhysicalDeviceInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;PHYSICAL DEVICE ALLOCATION&quot;</span><span class="p">);</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceInformation</span><span class="p">[</span><span class="n">PhysicalDeviceIndex</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">PhysicalDeviceInfo</span><span class="p">;</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">PhysicalDeviceInfo</span><span class="p">,</span> <span class="n">NewPhysicalDeviceInfo</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_PhysicalDeviceInfo_T</span><span class="p">));</span>

      <span class="n">InquiryUnitSerialNumber</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span>
	      <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">InquiryUnitSerialNumber</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">PhysicalDeviceInfo</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">DAC960_Failure</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="s">&quot;SERIAL NUMBER ALLOCATION&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span><span class="p">[</span><span class="n">PhysicalDeviceIndex</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">InquiryUnitSerialNumber</span><span class="p">;</span>

      <span class="n">Channel</span> <span class="o">=</span> <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">;</span>
      <span class="n">TargetID</span> <span class="o">=</span> <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">;</span>
      <span class="n">LogicalUnit</span> <span class="o">=</span> <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span><span class="p">;</span>

      <span class="cm">/*</span>
<span class="cm">	 Some devices do NOT have Unit Serial Numbers.</span>
<span class="cm">	 This command fails for them.  But, we still want to</span>
<span class="cm">	 remember those devices are there.  Construct a</span>
<span class="cm">	 UnitSerialNumber structure for the failure case.</span>
<span class="cm">      */</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V2_NewInquiryUnitSerialNumber</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span> <span class="n">LogicalUnit</span><span class="p">))</span> <span class="p">{</span>
      	<span class="n">memset</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
             <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">));</span>
     	<span class="n">InquiryUnitSerialNumber</span><span class="o">-&gt;</span><span class="n">PeripheralDeviceType</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span>
      	<span class="n">memcpy</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="p">,</span> <span class="n">NewInquiryUnitSerialNumber</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">));</span>

      <span class="n">PhysicalDeviceIndex</span><span class="o">++</span><span class="p">;</span>
      <span class="n">LogicalUnit</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_SanitizeInquiryData sanitizes the Vendor, Model, Revision, and</span>
<span class="cm">  Product Serial Number fields of the Inquiry Standard Data and Inquiry</span>
<span class="cm">  Unit Serial Number structures.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_SanitizeInquiryData</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_T</span>
					 <span class="o">*</span><span class="n">InquiryStandardData</span><span class="p">,</span>
				       <span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span>
					 <span class="o">*</span><span class="n">InquiryUnitSerialNumber</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Vendor</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Model</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Revision</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">SerialNumber</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">SerialNumberLength</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">PeripheralDeviceType</span> <span class="o">==</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">VendorIdentification</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">VendorCharacter</span> <span class="o">=</span>
	<span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">VendorIdentification</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">Vendor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">VendorCharacter</span> <span class="o">&gt;=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="n">VendorCharacter</span> <span class="o">&lt;=</span> <span class="sc">&#39;~&#39;</span>
		   <span class="o">?</span> <span class="n">VendorCharacter</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">Vendor</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">VendorIdentification</span><span class="p">)]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">ProductIdentification</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ModelCharacter</span> <span class="o">=</span>
	<span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">ProductIdentification</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">Model</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ModelCharacter</span> <span class="o">&gt;=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ModelCharacter</span> <span class="o">&lt;=</span> <span class="sc">&#39;~&#39;</span>
		  <span class="o">?</span> <span class="n">ModelCharacter</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">Model</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">ProductIdentification</span><span class="p">)]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">ProductRevisionLevel</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RevisionCharacter</span> <span class="o">=</span>
	<span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">ProductRevisionLevel</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">Revision</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">RevisionCharacter</span> <span class="o">&gt;=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="n">RevisionCharacter</span> <span class="o">&lt;=</span> <span class="sc">&#39;~&#39;</span>
		     <span class="o">?</span> <span class="n">RevisionCharacter</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">Revision</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">ProductRevisionLevel</span><span class="p">)]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="o">-&gt;</span><span class="n">PeripheralDeviceType</span> <span class="o">==</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">SerialNumberLength</span> <span class="o">=</span> <span class="n">InquiryUnitSerialNumber</span><span class="o">-&gt;</span><span class="n">PageLength</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SerialNumberLength</span> <span class="o">&gt;</span>
      <span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="o">-&gt;</span><span class="n">ProductSerialNumber</span><span class="p">))</span>
    <span class="n">SerialNumberLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="o">-&gt;</span><span class="n">ProductSerialNumber</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SerialNumberLength</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SerialNumberCharacter</span> <span class="o">=</span>
	<span class="n">InquiryUnitSerialNumber</span><span class="o">-&gt;</span><span class="n">ProductSerialNumber</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">SerialNumber</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">(</span><span class="n">SerialNumberCharacter</span> <span class="o">&gt;=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="n">SerialNumberCharacter</span> <span class="o">&lt;=</span> <span class="sc">&#39;~&#39;</span>
	 <span class="o">?</span> <span class="n">SerialNumberCharacter</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">SerialNumber</span><span class="p">[</span><span class="n">SerialNumberLength</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V1_ReportDeviceConfiguration reports the Device Configuration</span>
<span class="cm">  Information for DAC960 V1 Firmware Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V1_ReportDeviceConfiguration</span><span class="p">(</span><span class="n">DAC960_Controller_T</span>
						   <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">LogicalDriveNumber</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">;</span>
  <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;  Physical Devices:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">Channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">Channel</span> <span class="o">&lt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">;</span> <span class="n">Channel</span><span class="o">++</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Targets</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span>
	<span class="n">DAC960_SCSI_Inquiry_T</span> <span class="o">*</span><span class="n">InquiryStandardData</span> <span class="o">=</span>
	  <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">InquiryStandardData</span><span class="p">[</span><span class="n">Channel</span><span class="p">][</span><span class="n">TargetID</span><span class="p">];</span>
	<span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span> <span class="o">*</span><span class="n">InquiryUnitSerialNumber</span> <span class="o">=</span>
	  <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span><span class="p">[</span><span class="n">Channel</span><span class="p">][</span><span class="n">TargetID</span><span class="p">];</span>
	<span class="n">DAC960_V1_DeviceState_T</span> <span class="o">*</span><span class="n">DeviceState</span> <span class="o">=</span>
	  <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceState</span><span class="p">[</span><span class="n">Channel</span><span class="p">][</span><span class="n">TargetID</span><span class="p">];</span>
	<span class="n">DAC960_V1_ErrorTableEntry_T</span> <span class="o">*</span><span class="n">ErrorEntry</span> <span class="o">=</span>
	  <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">ErrorTable</span><span class="p">.</span><span class="n">ErrorTableEntries</span><span class="p">[</span><span class="n">Channel</span><span class="p">][</span><span class="n">TargetID</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">Vendor</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">VendorIdentification</span><span class="p">)];</span>
	<span class="kt">char</span> <span class="n">Model</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">ProductIdentification</span><span class="p">)];</span>
	<span class="kt">char</span> <span class="n">Revision</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">ProductRevisionLevel</span><span class="p">)];</span>
	<span class="kt">char</span> <span class="n">SerialNumber</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span>
				   <span class="o">-&gt;</span><span class="n">ProductSerialNumber</span><span class="p">)];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">PeripheralDeviceType</span> <span class="o">==</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
	<span class="n">DAC960_SanitizeInquiryData</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="p">,</span> <span class="n">InquiryUnitSerialNumber</span><span class="p">,</span>
				   <span class="n">Vendor</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Revision</span><span class="p">,</span> <span class="n">SerialNumber</span><span class="p">);</span>
	<span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;    %d:%d%s Vendor: %s  Model: %s  Revision: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
		    <span class="n">Vendor</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Revision</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="o">-&gt;</span><span class="n">PeripheralDeviceType</span> <span class="o">!=</span> <span class="mh">0x1F</span><span class="p">)</span>
	  <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;         Serial Number: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">SerialNumber</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">Present</span> <span class="o">&amp;&amp;</span>
	    <span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">DeviceType</span> <span class="o">==</span> <span class="n">DAC960_V1_DiskType</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceResetCount</span><span class="p">[</span><span class="n">Channel</span><span class="p">][</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	      <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;         Disk Status: %s, %u blocks, %d resets</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">Controller</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span> <span class="o">==</span> <span class="n">DAC960_V1_Device_Dead</span>
			   <span class="o">?</span> <span class="s">&quot;Dead&quot;</span>
			   <span class="o">:</span> <span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span>
			     <span class="o">==</span> <span class="n">DAC960_V1_Device_WriteOnly</span>
			     <span class="o">?</span> <span class="s">&quot;Write-Only&quot;</span>
			     <span class="o">:</span> <span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span>
			       <span class="o">==</span> <span class="n">DAC960_V1_Device_Online</span>
			       <span class="o">?</span> <span class="s">&quot;Online&quot;</span> <span class="o">:</span> <span class="s">&quot;Standby&quot;</span><span class="p">),</span>
			  <span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">DiskSize</span><span class="p">,</span>
			  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceResetCount</span><span class="p">[</span><span class="n">Channel</span><span class="p">][</span><span class="n">TargetID</span><span class="p">]);</span>
	    <span class="k">else</span>
	      <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;         Disk Status: %s, %u blocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span> <span class="o">==</span> <span class="n">DAC960_V1_Device_Dead</span>
			   <span class="o">?</span> <span class="s">&quot;Dead&quot;</span>
			   <span class="o">:</span> <span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span>
			     <span class="o">==</span> <span class="n">DAC960_V1_Device_WriteOnly</span>
			     <span class="o">?</span> <span class="s">&quot;Write-Only&quot;</span>
			     <span class="o">:</span> <span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span>
			       <span class="o">==</span> <span class="n">DAC960_V1_Device_Online</span>
			       <span class="o">?</span> <span class="s">&quot;Online&quot;</span> <span class="o">:</span> <span class="s">&quot;Standby&quot;</span><span class="p">),</span>
			  <span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">DiskSize</span><span class="p">);</span>
	  <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ErrorEntry</span><span class="o">-&gt;</span><span class="n">ParityErrorCount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ErrorEntry</span><span class="o">-&gt;</span><span class="n">SoftErrorCount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ErrorEntry</span><span class="o">-&gt;</span><span class="n">HardErrorCount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ErrorEntry</span><span class="o">-&gt;</span><span class="n">MiscErrorCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;         Errors - Parity: %d, Soft: %d, &quot;</span>
		      <span class="s">&quot;Hard: %d, Misc: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		      <span class="n">ErrorEntry</span><span class="o">-&gt;</span><span class="n">ParityErrorCount</span><span class="p">,</span>
		      <span class="n">ErrorEntry</span><span class="o">-&gt;</span><span class="n">SoftErrorCount</span><span class="p">,</span>
		      <span class="n">ErrorEntry</span><span class="o">-&gt;</span><span class="n">HardErrorCount</span><span class="p">,</span>
		      <span class="n">ErrorEntry</span><span class="o">-&gt;</span><span class="n">MiscErrorCount</span><span class="p">);</span>
      <span class="p">}</span>
  <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;  Logical Drives:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">LogicalDriveNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
       <span class="n">LogicalDriveNumber</span> <span class="o">&lt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LogicalDriveCount</span><span class="p">;</span>
       <span class="n">LogicalDriveNumber</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_V1_LogicalDriveInformation_T</span> <span class="o">*</span><span class="n">LogicalDriveInformation</span> <span class="o">=</span>
	<span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LogicalDriveInformation</span><span class="p">[</span><span class="n">LogicalDriveNumber</span><span class="p">];</span>
      <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;    /dev/rd/c%dd%d: RAID-%d, %s, %u blocks, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span> <span class="n">LogicalDriveNumber</span><span class="p">,</span>
		  <span class="n">LogicalDriveInformation</span><span class="o">-&gt;</span><span class="n">RAIDLevel</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">LogicalDriveInformation</span><span class="o">-&gt;</span><span class="n">LogicalDriveState</span>
		   <span class="o">==</span> <span class="n">DAC960_V1_LogicalDrive_Online</span>
		   <span class="o">?</span> <span class="s">&quot;Online&quot;</span>
		   <span class="o">:</span> <span class="n">LogicalDriveInformation</span><span class="o">-&gt;</span><span class="n">LogicalDriveState</span>
		     <span class="o">==</span> <span class="n">DAC960_V1_LogicalDrive_Critical</span>
		     <span class="o">?</span> <span class="s">&quot;Critical&quot;</span> <span class="o">:</span> <span class="s">&quot;Offline&quot;</span><span class="p">),</span>
		  <span class="n">LogicalDriveInformation</span><span class="o">-&gt;</span><span class="n">LogicalDriveSize</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">LogicalDriveInformation</span><span class="o">-&gt;</span><span class="n">WriteBack</span>
		   <span class="o">?</span> <span class="s">&quot;Write Back&quot;</span> <span class="o">:</span> <span class="s">&quot;Write Thru&quot;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_ReportDeviceConfiguration reports the Device Configuration</span>
<span class="cm">  Information for DAC960 V2 Firmware Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V2_ReportDeviceConfiguration</span><span class="p">(</span><span class="n">DAC960_Controller_T</span>
						   <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">PhysicalDeviceIndex</span><span class="p">,</span> <span class="n">LogicalDriveNumber</span><span class="p">;</span>
  <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;  Physical Devices:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">PhysicalDeviceIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
       <span class="n">PhysicalDeviceIndex</span> <span class="o">&lt;</span> <span class="n">DAC960_V2_MaxPhysicalDevices</span><span class="p">;</span>
       <span class="n">PhysicalDeviceIndex</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_V2_PhysicalDeviceInfo_T</span> <span class="o">*</span><span class="n">PhysicalDeviceInfo</span> <span class="o">=</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceInformation</span><span class="p">[</span><span class="n">PhysicalDeviceIndex</span><span class="p">];</span>
      <span class="n">DAC960_SCSI_Inquiry_T</span> <span class="o">*</span><span class="n">InquiryStandardData</span> <span class="o">=</span>
	<span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_T</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">SCSI_InquiryData</span><span class="p">;</span>
      <span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span> <span class="o">*</span><span class="n">InquiryUnitSerialNumber</span> <span class="o">=</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span><span class="p">[</span><span class="n">PhysicalDeviceIndex</span><span class="p">];</span>
      <span class="kt">char</span> <span class="n">Vendor</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">VendorIdentification</span><span class="p">)];</span>
      <span class="kt">char</span> <span class="n">Model</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">ProductIdentification</span><span class="p">)];</span>
      <span class="kt">char</span> <span class="n">Revision</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">ProductRevisionLevel</span><span class="p">)];</span>
      <span class="kt">char</span> <span class="n">SerialNumber</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="o">-&gt;</span><span class="n">ProductSerialNumber</span><span class="p">)];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">PhysicalDeviceInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="n">DAC960_SanitizeInquiryData</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="p">,</span> <span class="n">InquiryUnitSerialNumber</span><span class="p">,</span>
				 <span class="n">Vendor</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Revision</span><span class="p">,</span> <span class="n">SerialNumber</span><span class="p">);</span>
      <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;    %d:%d%s Vendor: %s  Model: %s  Revision: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">Controller</span><span class="p">,</span>
		  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span>
		  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
		  <span class="n">Vendor</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Revision</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">NegotiatedSynchronousMegaTransfers</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;         %sAsynchronous</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">NegotiatedDataWidthBits</span> <span class="o">==</span> <span class="mi">16</span>
		     <span class="o">?</span> <span class="s">&quot;Wide &quot;</span> <span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">));</span>
      <span class="k">else</span>
	<span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;         %sSynchronous at %d MB/sec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">NegotiatedDataWidthBits</span> <span class="o">==</span> <span class="mi">16</span>
		     <span class="o">?</span> <span class="s">&quot;Wide &quot;</span> <span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">),</span>
		    <span class="p">(</span><span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">NegotiatedSynchronousMegaTransfers</span>
		     <span class="o">*</span> <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">NegotiatedDataWidthBits</span><span class="o">/</span><span class="mi">8</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="o">-&gt;</span><span class="n">PeripheralDeviceType</span> <span class="o">!=</span> <span class="mh">0x1F</span><span class="p">)</span>
	<span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;         Serial Number: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">SerialNumber</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span> <span class="o">==</span>
	  <span class="n">DAC960_V2_Device_Unconfigured</span><span class="p">)</span>
	<span class="k">continue</span><span class="p">;</span>
      <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;         Disk Status: %s, %u blocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
		   <span class="o">==</span> <span class="n">DAC960_V2_Device_Online</span>
		   <span class="o">?</span> <span class="s">&quot;Online&quot;</span>
		   <span class="o">:</span> <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
		     <span class="o">==</span> <span class="n">DAC960_V2_Device_Rebuild</span>
		     <span class="o">?</span> <span class="s">&quot;Rebuild&quot;</span>
		     <span class="o">:</span> <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
		       <span class="o">==</span> <span class="n">DAC960_V2_Device_Missing</span>
		       <span class="o">?</span> <span class="s">&quot;Missing&quot;</span>
		       <span class="o">:</span> <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
			 <span class="o">==</span> <span class="n">DAC960_V2_Device_Critical</span>
			 <span class="o">?</span> <span class="s">&quot;Critical&quot;</span>
			 <span class="o">:</span> <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
			   <span class="o">==</span> <span class="n">DAC960_V2_Device_Dead</span>
			   <span class="o">?</span> <span class="s">&quot;Dead&quot;</span>
			   <span class="o">:</span> <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
			     <span class="o">==</span> <span class="n">DAC960_V2_Device_SuspectedDead</span>
			     <span class="o">?</span> <span class="s">&quot;Suspected-Dead&quot;</span>
			     <span class="o">:</span> <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
			       <span class="o">==</span> <span class="n">DAC960_V2_Device_CommandedOffline</span>
			       <span class="o">?</span> <span class="s">&quot;Commanded-Offline&quot;</span>
			       <span class="o">:</span> <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
				 <span class="o">==</span> <span class="n">DAC960_V2_Device_Standby</span>
				 <span class="o">?</span> <span class="s">&quot;Standby&quot;</span> <span class="o">:</span> <span class="s">&quot;Unknown&quot;</span><span class="p">),</span>
		  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">ConfigurableDeviceSize</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">ParityErrors</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">SoftErrors</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">HardErrors</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">MiscellaneousErrors</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">CommandTimeouts</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Retries</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Aborts</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PredictedFailuresDetected</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">continue</span><span class="p">;</span>
      <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;         Errors - Parity: %d, Soft: %d, &quot;</span>
		  <span class="s">&quot;Hard: %d, Misc: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">ParityErrors</span><span class="p">,</span>
		  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">SoftErrors</span><span class="p">,</span>
		  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">HardErrors</span><span class="p">,</span>
		  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">MiscellaneousErrors</span><span class="p">);</span>
      <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;                  Timeouts: %d, Retries: %d, &quot;</span>
		  <span class="s">&quot;Aborts: %d, Predicted: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">CommandTimeouts</span><span class="p">,</span>
		  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Retries</span><span class="p">,</span>
		  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Aborts</span><span class="p">,</span>
		  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PredictedFailuresDetected</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;  Logical Drives:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">LogicalDriveNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
       <span class="n">LogicalDriveNumber</span> <span class="o">&lt;</span> <span class="n">DAC960_MaxLogicalDrives</span><span class="p">;</span>
       <span class="n">LogicalDriveNumber</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_V2_LogicalDeviceInfo_T</span> <span class="o">*</span><span class="n">LogicalDeviceInfo</span> <span class="o">=</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDeviceInformation</span><span class="p">[</span><span class="n">LogicalDriveNumber</span><span class="p">];</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ReadCacheStatus</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Read Cache Disabled&quot;</span><span class="p">,</span>
					   <span class="s">&quot;Read Cache Enabled&quot;</span><span class="p">,</span>
					   <span class="s">&quot;Read Ahead Enabled&quot;</span><span class="p">,</span>
					   <span class="s">&quot;Intelligent Read Ahead Enabled&quot;</span><span class="p">,</span>
					   <span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="s">&quot;-&quot;</span> <span class="p">};</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">WriteCacheStatus</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Write Cache Disabled&quot;</span><span class="p">,</span>
					    <span class="s">&quot;Logical Device Read Only&quot;</span><span class="p">,</span>
					    <span class="s">&quot;Write Cache Enabled&quot;</span><span class="p">,</span>
					    <span class="s">&quot;Intelligent Write Cache Enabled&quot;</span><span class="p">,</span>
					    <span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="s">&quot;-&quot;</span> <span class="p">};</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">GeometryTranslation</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">DriveGeometry</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">DAC960_V2_Geometry_128_32</span>:
	  <span class="n">GeometryTranslation</span> <span class="o">=</span> <span class="s">&quot;128/32&quot;</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_V2_Geometry_255_63</span>:
	  <span class="n">GeometryTranslation</span> <span class="o">=</span> <span class="s">&quot;255/63&quot;</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	  <span class="n">GeometryTranslation</span> <span class="o">=</span> <span class="s">&quot;Invalid&quot;</span><span class="p">;</span>
	  <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Illegal Logical Device Geometry %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">Controller</span><span class="p">,</span> <span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">DriveGeometry</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;    /dev/rd/c%dd%d: RAID-%d, %s, %u blocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span> <span class="n">LogicalDriveNumber</span><span class="p">,</span>
		  <span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">RAIDLevel</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceState</span>
		   <span class="o">==</span> <span class="n">DAC960_V2_LogicalDevice_Online</span>
		   <span class="o">?</span> <span class="s">&quot;Online&quot;</span>
		   <span class="o">:</span> <span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceState</span>
		     <span class="o">==</span> <span class="n">DAC960_V2_LogicalDevice_Critical</span>
		     <span class="o">?</span> <span class="s">&quot;Critical&quot;</span> <span class="o">:</span> <span class="s">&quot;Offline&quot;</span><span class="p">),</span>
		  <span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">ConfigurableDeviceSize</span><span class="p">);</span>
      <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;                  Logical Device %s, BIOS Geometry: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">Controller</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceControl</span>
				     <span class="p">.</span><span class="n">LogicalDeviceInitialized</span>
		   <span class="o">?</span> <span class="s">&quot;Initialized&quot;</span> <span class="o">:</span> <span class="s">&quot;Uninitialized&quot;</span><span class="p">),</span>
		  <span class="n">GeometryTranslation</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">StripeSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">CacheLineSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;                  Stripe Size: N/A, &quot;</span>
			<span class="s">&quot;Segment Size: N/A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	  <span class="k">else</span>
	    <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;                  Stripe Size: N/A, &quot;</span>
			<span class="s">&quot;Segment Size: %dKB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">CacheLineSize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>
      <span class="k">else</span>
	<span class="p">{</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">CacheLineSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;                  Stripe Size: %dKB, &quot;</span>
			<span class="s">&quot;Segment Size: N/A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">StripeSize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">));</span>
	  <span class="k">else</span>
	    <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;                  Stripe Size: %dKB, &quot;</span>
			<span class="s">&quot;Segment Size: %dKB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">StripeSize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">CacheLineSize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>
      <span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;                  %s, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		  <span class="n">ReadCacheStatus</span><span class="p">[</span>
		    <span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceControl</span><span class="p">.</span><span class="n">ReadCache</span><span class="p">],</span>
		  <span class="n">WriteCacheStatus</span><span class="p">[</span>
		    <span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceControl</span><span class="p">.</span><span class="n">WriteCache</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">SoftErrors</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	  <span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">CommandsFailed</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	  <span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">DeferredWriteErrors</span><span class="p">)</span>
	<span class="n">DAC960_Info</span><span class="p">(</span><span class="s">&quot;                  Errors - Soft: %d, Failed: %d, &quot;</span>
		    <span class="s">&quot;Deferred Write: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		    <span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">SoftErrors</span><span class="p">,</span>
		    <span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">CommandsFailed</span><span class="p">,</span>
		    <span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">DeferredWriteErrors</span><span class="p">);</span>

    <span class="p">}</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  DAC960_RegisterBlockDevice registers the Block Device structures</span>
<span class="cm">  associated with Controller.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_RegisterBlockDevice</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">MajorNumber</span> <span class="o">=</span> <span class="n">DAC960_MAJOR</span> <span class="o">+</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">    Register the Block Device Major Number for this DAC960 Controller.</span>
<span class="cm">  */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">register_blkdev</span><span class="p">(</span><span class="n">MajorNumber</span><span class="p">,</span> <span class="s">&quot;dac960&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">DAC960_MaxLogicalDrives</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
  	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">RequestQueue</span><span class="p">;</span>

	<span class="cm">/* for now, let all request queues share controller&#39;s lock */</span>
  	<span class="n">RequestQueue</span> <span class="o">=</span> <span class="n">blk_init_queue</span><span class="p">(</span><span class="n">DAC960_RequestFunction</span><span class="p">,</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
  	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RequestQueue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DAC960: failure to allocate request queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">continue</span><span class="p">;</span>
  	<span class="p">}</span>
  	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">RequestQueue</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">RequestQueue</span><span class="p">;</span>
  	<span class="n">blk_queue_bounce_limit</span><span class="p">(</span><span class="n">RequestQueue</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BounceBufferLimit</span><span class="p">);</span>
  	<span class="n">RequestQueue</span><span class="o">-&gt;</span><span class="n">queuedata</span> <span class="o">=</span> <span class="n">Controller</span><span class="p">;</span>
	<span class="n">blk_queue_max_segments</span><span class="p">(</span><span class="n">RequestQueue</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriverScatterGatherLimit</span><span class="p">);</span>
	<span class="n">blk_queue_max_hw_sectors</span><span class="p">(</span><span class="n">RequestQueue</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MaxBlocksPerCommand</span><span class="p">);</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">RequestQueue</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="s">&quot;rd/c%dd%d&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">MajorNumber</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="n">DAC960_MaxPartitionsBits</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DAC960_BlockDeviceOperations</span><span class="p">;</span>
   <span class="p">}</span>
  <span class="cm">/*</span>
<span class="cm">    Indicate the Block Device Registration completed successfully,</span>
<span class="cm">  */</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_UnregisterBlockDevice unregisters the Block Device structures</span>
<span class="cm">  associated with Controller.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_UnregisterBlockDevice</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">MajorNumber</span> <span class="o">=</span> <span class="n">DAC960_MAJOR</span> <span class="o">+</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">disk</span><span class="p">;</span>

  <span class="cm">/* does order matter when deleting gendisk and cleanup in request queue? */</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">disk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">disk</span> <span class="o">&lt;</span> <span class="n">DAC960_MaxLogicalDrives</span><span class="p">;</span> <span class="n">disk</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">del_gendisk</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">disk</span><span class="p">]);</span>
	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">RequestQueue</span><span class="p">[</span><span class="n">disk</span><span class="p">]);</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">RequestQueue</span><span class="p">[</span><span class="n">disk</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">    Unregister the Block Device Major Number for this DAC960 Controller.</span>
<span class="cm">  */</span>
  <span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">MajorNumber</span><span class="p">,</span> <span class="s">&quot;dac960&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  DAC960_ComputeGenericDiskInfo computes the values for the Generic Disk</span>
<span class="cm">  Information Partition Sector Counts and Block Sizes.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_ComputeGenericDiskInfo</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">disk</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">disk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">disk</span> <span class="o">&lt;</span> <span class="n">DAC960_MaxLogicalDrives</span><span class="p">;</span> <span class="n">disk</span><span class="o">++</span><span class="p">)</span>
		<span class="n">set_capacity</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">disk</span><span class="p">],</span> <span class="n">disk_size</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">disk</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  DAC960_ReportErrorStatus reports Controller BIOS Messages passed through</span>
<span class="cm">  the Error Status Register when the driver performs the BIOS handshaking.</span>
<span class="cm">  It returns true for fatal errors and false otherwise.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_ReportErrorStatus</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ErrorStatus</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Parameter0</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Parameter1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">ErrorStatus</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="mh">0x00</span>:
      <span class="n">DAC960_Notice</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d Not Responding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">Controller</span><span class="p">,</span> <span class="n">Parameter1</span><span class="p">,</span> <span class="n">Parameter0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x08</span>:
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriveSpinUpMessageDisplayed</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="n">DAC960_Notice</span><span class="p">(</span><span class="s">&quot;Spinning Up Drives</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DriveSpinUpMessageDisplayed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x30</span>:
      <span class="n">DAC960_Notice</span><span class="p">(</span><span class="s">&quot;Configuration Checksum Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x60</span>:
      <span class="n">DAC960_Notice</span><span class="p">(</span><span class="s">&quot;Mirror Race Recovery Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x70</span>:
      <span class="n">DAC960_Notice</span><span class="p">(</span><span class="s">&quot;Mirror Race Recovery In Progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x90</span>:
      <span class="n">DAC960_Notice</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d COD Mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">Controller</span><span class="p">,</span> <span class="n">Parameter1</span><span class="p">,</span> <span class="n">Parameter0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0xA0</span>:
      <span class="n">DAC960_Notice</span><span class="p">(</span><span class="s">&quot;Logical Drive Installation Aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0xB0</span>:
      <span class="n">DAC960_Notice</span><span class="p">(</span><span class="s">&quot;Mirror Race On A Critical Logical Drive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0xD0</span>:
      <span class="n">DAC960_Notice</span><span class="p">(</span><span class="s">&quot;New Controller Configuration Found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0xF0</span>:
      <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Fatal Memory Parity Error for Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Unknown Initialization Error %02X for Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">Controller</span><span class="p">,</span> <span class="n">ErrorStatus</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * DAC960_DetectCleanup releases the resources that were allocated</span>
<span class="cm"> * during DAC960_DetectController().  DAC960_DetectController can</span>
<span class="cm"> * has several internal failure points, so not ALL resources may </span>
<span class="cm"> * have been allocated.  It&#39;s important to free only</span>
<span class="cm"> * resources that HAVE been allocated.  The code below always</span>
<span class="cm"> * tests that the resource has been allocated before attempting to</span>
<span class="cm"> * free it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_DetectCleanup</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

  <span class="cm">/* Free the memory mailbox, status, and related structures */</span>
  <span class="n">free_dma_loaf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">DmaPages</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MemoryMappedAddress</span><span class="p">)</span> <span class="p">{</span>
  	<span class="k">switch</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">HardwareType</span><span class="p">)</span>
  	<span class="p">{</span>
		<span class="k">case</span> <span class="n">DAC960_GEM_Controller</span>:
			<span class="n">DAC960_GEM_DisableInterrupts</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DAC960_BA_Controller</span>:
			<span class="n">DAC960_BA_DisableInterrupts</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DAC960_LP_Controller</span>:
			<span class="n">DAC960_LP_DisableInterrupts</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DAC960_LA_Controller</span>:
			<span class="n">DAC960_LA_DisableInterrupts</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DAC960_PG_Controller</span>:
			<span class="n">DAC960_PG_DisableInterrupts</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DAC960_PD_Controller</span>:
			<span class="n">DAC960_PD_DisableInterrupts</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DAC960_P_Controller</span>:
			<span class="n">DAC960_PD_DisableInterrupts</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
  	<span class="p">}</span>
  	<span class="n">iounmap</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MemoryMappedAddress</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span><span class="p">)</span>
  	<span class="n">free_irq</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">)</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
  <span class="n">pci_disable_device</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">DAC960_MaxLogicalDrives</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
       <span class="n">put_disk</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="n">DAC960_Controllers</span><span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">kfree</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_DetectController detects Mylex DAC960/AcceleRAID/eXtremeRAID</span>
<span class="cm">  PCI RAID Controllers by interrogating the PCI Configuration Space for</span>
<span class="cm">  Controller Type.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">DAC960_Controller_T</span> <span class="o">*</span> 
<span class="nf">DAC960_DetectController</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">PCI_Device</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">DAC960_privdata</span> <span class="o">*</span><span class="n">privdata</span> <span class="o">=</span>
	  	<span class="p">(</span><span class="k">struct</span> <span class="n">DAC960_privdata</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
  <span class="n">irq_handler_t</span> <span class="n">InterruptHandler</span> <span class="o">=</span> <span class="n">privdata</span><span class="o">-&gt;</span><span class="n">InterruptHandler</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MemoryWindowSize</span> <span class="o">=</span> <span class="n">privdata</span><span class="o">-&gt;</span><span class="n">MemoryWindowSize</span><span class="p">;</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">DeviceFunction</span> <span class="o">=</span> <span class="n">PCI_Device</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ErrorStatus</span><span class="p">,</span> <span class="n">Parameter0</span><span class="p">,</span> <span class="n">Parameter1</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">IRQ_Channel</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

  <span class="n">Controller</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_Controller_T</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Unable to allocate Controller structure for &quot;</span>
                       <span class="s">&quot;Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span> <span class="o">=</span> <span class="n">DAC960_ControllerCount</span><span class="p">;</span>
  <span class="n">DAC960_Controllers</span><span class="p">[</span><span class="n">DAC960_ControllerCount</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">Controller</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">=</span> <span class="n">PCI_Device</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">=</span> <span class="n">privdata</span><span class="o">-&gt;</span><span class="n">FirmwareType</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">HardwareType</span> <span class="o">=</span> <span class="n">privdata</span><span class="o">-&gt;</span><span class="n">HardwareType</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Device</span> <span class="o">=</span> <span class="n">DeviceFunction</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">DeviceFunction</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span> <span class="o">=</span> <span class="n">PCI_Device</span><span class="p">;</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">,</span> <span class="s">&quot;DAC960&quot;</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">))</span>
	<span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">HardwareType</span><span class="p">)</span>
  <span class="p">{</span>
	<span class="k">case</span> <span class="n">DAC960_GEM_Controller</span>:
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCI_Address</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_BA_Controller</span>:
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCI_Address</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_LP_Controller</span>:
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCI_Address</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_LA_Controller</span>:
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCI_Address</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_PG_Controller</span>:
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCI_Address</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_PD_Controller</span>:
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCI_Address</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_P_Controller</span>:
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCI_Address</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">));</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DAC960_MaxLogicalDrives</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">DAC960_MaxPartitionsBits</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">i</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CommandWaitQueue</span><span class="p">);</span>
  <span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">HealthStatusWaitQueue</span><span class="p">);</span>
  <span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
  <span class="n">DAC960_AnnounceDriver</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="cm">/*</span>
<span class="cm">    Map the Controller Register Window.</span>
<span class="cm">  */</span>
 <span class="k">if</span> <span class="p">(</span><span class="n">MemoryWindowSize</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
	<span class="n">MemoryWindowSize</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MemoryMappedAddress</span> <span class="o">=</span>
	<span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCI_Address</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">,</span> <span class="n">MemoryWindowSize</span><span class="p">);</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span> <span class="o">=</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MemoryMappedAddress</span> <span class="o">+</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCI_Address</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MemoryMappedAddress</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
	  <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Unable to map Controller Register Window for &quot;</span>
		       <span class="s">&quot;Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	  <span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">BaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">HardwareType</span><span class="p">)</span>
  <span class="p">{</span>
	<span class="k">case</span> <span class="n">DAC960_GEM_Controller</span>:
	  <span class="n">DAC960_GEM_DisableInterrupts</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">DAC960_GEM_AcknowledgeHardwareMailboxStatus</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	  <span class="k">while</span> <span class="p">(</span><span class="n">DAC960_GEM_InitializationInProgressP</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">DAC960_GEM_ReadErrorStatus</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ErrorStatus</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">Parameter0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Parameter1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="n">DAC960_ReportErrorStatus</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">ErrorStatus</span><span class="p">,</span>
					   <span class="n">Parameter0</span><span class="p">,</span> <span class="n">Parameter1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	      <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V2_EnableMemoryMailboxInterface</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Unable to Enable Memory Mailbox Interface &quot;</span>
			   <span class="s">&quot;for Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	      <span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">DAC960_GEM_EnableInterrupts</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueCommand</span> <span class="o">=</span> <span class="n">DAC960_GEM_QueueCommand</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReadControllerConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_ReadControllerConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReadDeviceConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_ReadDeviceConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReportDeviceConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_ReportDeviceConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueReadWriteCommand</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_QueueReadWriteCommand</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_BA_Controller</span>:
	  <span class="n">DAC960_BA_DisableInterrupts</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">DAC960_BA_AcknowledgeHardwareMailboxStatus</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	  <span class="k">while</span> <span class="p">(</span><span class="n">DAC960_BA_InitializationInProgressP</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">DAC960_BA_ReadErrorStatus</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ErrorStatus</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">Parameter0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Parameter1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="n">DAC960_ReportErrorStatus</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">ErrorStatus</span><span class="p">,</span>
					   <span class="n">Parameter0</span><span class="p">,</span> <span class="n">Parameter1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	      <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V2_EnableMemoryMailboxInterface</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Unable to Enable Memory Mailbox Interface &quot;</span>
			   <span class="s">&quot;for Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	      <span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">DAC960_BA_EnableInterrupts</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueCommand</span> <span class="o">=</span> <span class="n">DAC960_BA_QueueCommand</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReadControllerConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_ReadControllerConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReadDeviceConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_ReadDeviceConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReportDeviceConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_ReportDeviceConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueReadWriteCommand</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_QueueReadWriteCommand</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_LP_Controller</span>:
	  <span class="n">DAC960_LP_DisableInterrupts</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">DAC960_LP_AcknowledgeHardwareMailboxStatus</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	  <span class="k">while</span> <span class="p">(</span><span class="n">DAC960_LP_InitializationInProgressP</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">DAC960_LP_ReadErrorStatus</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ErrorStatus</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">Parameter0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Parameter1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="n">DAC960_ReportErrorStatus</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">ErrorStatus</span><span class="p">,</span>
					   <span class="n">Parameter0</span><span class="p">,</span> <span class="n">Parameter1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	      <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V2_EnableMemoryMailboxInterface</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Unable to Enable Memory Mailbox Interface &quot;</span>
			   <span class="s">&quot;for Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	      <span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">DAC960_LP_EnableInterrupts</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueCommand</span> <span class="o">=</span> <span class="n">DAC960_LP_QueueCommand</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReadControllerConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_ReadControllerConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReadDeviceConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_ReadDeviceConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReportDeviceConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_ReportDeviceConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueReadWriteCommand</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_QueueReadWriteCommand</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_LA_Controller</span>:
	  <span class="n">DAC960_LA_DisableInterrupts</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">DAC960_LA_AcknowledgeHardwareMailboxStatus</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	  <span class="k">while</span> <span class="p">(</span><span class="n">DAC960_LA_InitializationInProgressP</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">DAC960_LA_ReadErrorStatus</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ErrorStatus</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">Parameter0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Parameter1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="n">DAC960_ReportErrorStatus</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">ErrorStatus</span><span class="p">,</span>
					   <span class="n">Parameter0</span><span class="p">,</span> <span class="n">Parameter1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	      <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V1_EnableMemoryMailboxInterface</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Unable to Enable Memory Mailbox Interface &quot;</span>
			   <span class="s">&quot;for Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	      <span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">DAC960_LA_EnableInterrupts</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DualModeMemoryMailboxInterface</span><span class="p">)</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueCommand</span> <span class="o">=</span> <span class="n">DAC960_LA_QueueCommandDualMode</span><span class="p">;</span>
	  <span class="k">else</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueCommand</span> <span class="o">=</span> <span class="n">DAC960_LA_QueueCommandSingleMode</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReadControllerConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_ReadControllerConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReadDeviceConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_ReadDeviceConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReportDeviceConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_ReportDeviceConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueReadWriteCommand</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_QueueReadWriteCommand</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_PG_Controller</span>:
	  <span class="n">DAC960_PG_DisableInterrupts</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">DAC960_PG_AcknowledgeHardwareMailboxStatus</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	  <span class="k">while</span> <span class="p">(</span><span class="n">DAC960_PG_InitializationInProgressP</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">DAC960_PG_ReadErrorStatus</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ErrorStatus</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">Parameter0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Parameter1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="n">DAC960_ReportErrorStatus</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">ErrorStatus</span><span class="p">,</span>
					   <span class="n">Parameter0</span><span class="p">,</span> <span class="n">Parameter1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	      <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V1_EnableMemoryMailboxInterface</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Unable to Enable Memory Mailbox Interface &quot;</span>
			   <span class="s">&quot;for Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	      <span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">DAC960_PG_EnableInterrupts</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DualModeMemoryMailboxInterface</span><span class="p">)</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueCommand</span> <span class="o">=</span> <span class="n">DAC960_PG_QueueCommandDualMode</span><span class="p">;</span>
	  <span class="k">else</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueCommand</span> <span class="o">=</span> <span class="n">DAC960_PG_QueueCommandSingleMode</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReadControllerConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_ReadControllerConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReadDeviceConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_ReadDeviceConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReportDeviceConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_ReportDeviceConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueReadWriteCommand</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_QueueReadWriteCommand</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_PD_Controller</span>:
	  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;IO port 0x%d busy for Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	  <span class="p">}</span>
	  <span class="n">DAC960_PD_DisableInterrupts</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">DAC960_PD_AcknowledgeStatus</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	  <span class="k">while</span> <span class="p">(</span><span class="n">DAC960_PD_InitializationInProgressP</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">DAC960_PD_ReadErrorStatus</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ErrorStatus</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">Parameter0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Parameter1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="n">DAC960_ReportErrorStatus</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">ErrorStatus</span><span class="p">,</span>
					   <span class="n">Parameter0</span><span class="p">,</span> <span class="n">Parameter1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	      <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V1_EnableMemoryMailboxInterface</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Unable to allocate DMA mapped memory &quot;</span>
			   <span class="s">&quot;for Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	      <span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">DAC960_PD_EnableInterrupts</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueCommand</span> <span class="o">=</span> <span class="n">DAC960_PD_QueueCommand</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReadControllerConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_ReadControllerConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReadDeviceConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_ReadDeviceConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReportDeviceConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_ReportDeviceConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueReadWriteCommand</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_QueueReadWriteCommand</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_P_Controller</span>:
	  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">)){</span>
		<span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;IO port 0x%d busy for Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   	     <span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	  <span class="p">}</span>
	  <span class="n">DAC960_PD_DisableInterrupts</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">DAC960_PD_AcknowledgeStatus</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	  <span class="k">while</span> <span class="p">(</span><span class="n">DAC960_PD_InitializationInProgressP</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">DAC960_PD_ReadErrorStatus</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ErrorStatus</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">Parameter0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Parameter1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="n">DAC960_ReportErrorStatus</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">ErrorStatus</span><span class="p">,</span>
					   <span class="n">Parameter0</span><span class="p">,</span> <span class="n">Parameter1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	      <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_V1_EnableMemoryMailboxInterface</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Unable to allocate DMA mapped memory&quot;</span>
			   <span class="s">&quot;for Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	      <span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">DAC960_PD_EnableInterrupts</span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">);</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueCommand</span> <span class="o">=</span> <span class="n">DAC960_P_QueueCommand</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReadControllerConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_ReadControllerConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReadDeviceConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_ReadDeviceConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ReportDeviceConfiguration</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_ReportDeviceConfiguration</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">QueueReadWriteCommand</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_QueueReadWriteCommand</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="cm">/*</span>
<span class="cm">     Acquire shared access to the IRQ Channel.</span>
<span class="cm">  */</span>
  <span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="n">PCI_Device</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_Channel</span><span class="p">,</span> <span class="n">InterruptHandler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
		      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FullModelName</span><span class="p">,</span> <span class="n">Controller</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
	<span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Unable to acquire IRQ Channel %d for Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">Failure</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="n">IRQ_Channel</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">InitialCommand</span><span class="p">.</span><span class="n">CommandIdentifier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">InitialCommand</span><span class="p">.</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Controller</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Commands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">InitialCommand</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FreeCommands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">InitialCommand</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">Controller</span><span class="p">;</span>
      
<span class="nl">Failure:</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IO_Address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;PCI Bus %d Device %d Function %d I/O Address N/A &quot;</span>
		     <span class="s">&quot;PCI Address 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		     <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Device</span><span class="p">,</span>
		     <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Function</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCI_Address</span><span class="p">);</span>
  <span class="k">else</span>
	<span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;PCI Bus %d Device %d Function %d I/O Address &quot;</span>
			<span class="s">&quot;0x%X PCI Address 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Device</span><span class="p">,</span>
			<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Function</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span>
			<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCI_Address</span><span class="p">);</span>
  <span class="n">DAC960_DetectCleanup</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">DAC960_ControllerCount</span><span class="o">--</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  DAC960_InitializeController initializes Controller.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> 
<span class="nf">DAC960_InitializeController</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">DAC960_ReadControllerConfiguration</span><span class="p">(</span><span class="n">Controller</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="n">DAC960_ReportControllerConfiguration</span><span class="p">(</span><span class="n">Controller</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="n">DAC960_CreateAuxiliaryStructures</span><span class="p">(</span><span class="n">Controller</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="n">DAC960_ReadDeviceConfiguration</span><span class="p">(</span><span class="n">Controller</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="n">DAC960_ReportDeviceConfiguration</span><span class="p">(</span><span class="n">Controller</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="n">DAC960_RegisterBlockDevice</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">	Initialize the Monitoring Timer.</span>
<span class="cm">      */</span>
      <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimer</span><span class="p">);</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
	<span class="n">jiffies</span> <span class="o">+</span> <span class="n">DAC960_MonitoringTimerInterval</span><span class="p">;</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">Controller</span><span class="p">;</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">DAC960_MonitoringTimerFunction</span><span class="p">;</span>
      <span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimer</span><span class="p">);</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerInitialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_FinalizeController finalizes Controller.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_FinalizeController</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerInitialized</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

      <span class="cm">/*</span>
<span class="cm">       * Acquiring and releasing lock here eliminates</span>
<span class="cm">       * a very low probability race.</span>
<span class="cm">       *</span>
<span class="cm">       * The code below allocates controller command structures</span>
<span class="cm">       * from the free list without holding the controller lock.</span>
<span class="cm">       * This is safe assuming there is no other activity on</span>
<span class="cm">       * the controller at the time.</span>
<span class="cm">       * </span>
<span class="cm">       * But, there might be a monitoring command still</span>
<span class="cm">       * in progress.  Setting the Shutdown flag while holding</span>
<span class="cm">       * the lock ensures that there is no monitoring command</span>
<span class="cm">       * in the interrupt handler currently, and any monitoring</span>
<span class="cm">       * commands that complete from this time on will NOT return</span>
<span class="cm">       * their command structure to the free list.</span>
<span class="cm">       */</span>

      <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ShutdownMonitoringTimer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

      <span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimer</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">==</span> <span class="n">DAC960_V1_Controller</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">DAC960_Notice</span><span class="p">(</span><span class="s">&quot;Flushing Cache...&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	  <span class="n">DAC960_V1_ExecuteType3</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">DAC960_V1_Flush</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	  <span class="n">DAC960_Notice</span><span class="p">(</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>

	  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">HardwareType</span> <span class="o">==</span> <span class="n">DAC960_PD_Controller</span><span class="p">)</span>
	      <span class="n">release_region</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IO_Address</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="p">}</span>
      <span class="k">else</span>
	<span class="p">{</span>
	  <span class="n">DAC960_Notice</span><span class="p">(</span><span class="s">&quot;Flushing Cache...&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	  <span class="n">DAC960_V2_DeviceOperation</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">DAC960_V2_PauseDevice</span><span class="p">,</span>
				    <span class="n">DAC960_V2_RAID_Controller</span><span class="p">);</span>
	  <span class="n">DAC960_Notice</span><span class="p">(</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
  <span class="n">DAC960_UnregisterBlockDevice</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">DAC960_DestroyAuxiliaryStructures</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">DAC960_DestroyProcEntries</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">DAC960_DetectCleanup</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_Probe verifies controller&#39;s existence and</span>
<span class="cm">  initializes the DAC960 Driver for that controller.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">DAC960_Probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">disk</span><span class="p">;</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">DAC960_ControllerCount</span> <span class="o">==</span> <span class="n">DAC960_MaxControllers</span><span class="p">)</span>
  <span class="p">{</span>
	<span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;More than %d DAC960 Controllers detected - &quot;</span>
                       <span class="s">&quot;ignoring from Controller at</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                       <span class="nb">NULL</span><span class="p">,</span> <span class="n">DAC960_MaxControllers</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">Controller</span> <span class="o">=</span> <span class="n">DAC960_DetectController</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Controller</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_InitializeController</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span> <span class="p">{</span>
  	<span class="n">DAC960_FinalizeController</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">disk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">disk</span> <span class="o">&lt;</span> <span class="n">DAC960_MaxLogicalDrives</span><span class="p">;</span> <span class="n">disk</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">set_capacity</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">disk</span><span class="p">],</span> <span class="n">disk_size</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">disk</span><span class="p">));</span>
        <span class="n">add_disk</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">disks</span><span class="p">[</span><span class="n">disk</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">DAC960_CreateProcEntries</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_Finalize finalizes the DAC960 Driver.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_Remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">PCI_Device</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">Controller_Number</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">PCI_Device</span><span class="p">);</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">DAC960_Controllers</span><span class="p">[</span><span class="n">Controller_Number</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
      <span class="n">DAC960_FinalizeController</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V1_QueueReadWriteCommand prepares and queues a Read/Write Command for</span>
<span class="cm">  DAC960 V1 Firmware Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_V1_QueueReadWriteCommand</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V1_ScatterGatherSegment_T</span> <span class="o">*</span><span class="n">ScatterGatherList</span> <span class="o">=</span>
					<span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">ScatterGatherList</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">ScatterList</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">ScatterList</span><span class="p">;</span>

  <span class="n">DAC960_V1_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">SegmentCount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">DmaDirection</span> <span class="o">==</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">)</span>
	<span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type5</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_Read</span><span class="p">;</span>
      <span class="k">else</span> 
        <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type5</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_Write</span><span class="p">;</span>

      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type5</span><span class="p">.</span><span class="n">LD</span><span class="p">.</span><span class="n">TransferLength</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockCount</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type5</span><span class="p">.</span><span class="n">LD</span><span class="p">.</span><span class="n">LogicalDriveNumber</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">LogicalDriveNumber</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type5</span><span class="p">.</span><span class="n">LogicalBlockAddress</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockNumber</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type5</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">DAC960_BusAddress32_T</span><span class="p">)</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">ScatterList</span><span class="p">);</span>	
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span>
      <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">DmaDirection</span> <span class="o">==</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">)</span>
	<span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type5</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_ReadWithScatterGather</span><span class="p">;</span>
      <span class="k">else</span>
	<span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type5</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_WriteWithScatterGather</span><span class="p">;</span>

      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type5</span><span class="p">.</span><span class="n">LD</span><span class="p">.</span><span class="n">TransferLength</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockCount</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type5</span><span class="p">.</span><span class="n">LD</span><span class="p">.</span><span class="n">LogicalDriveNumber</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">LogicalDriveNumber</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type5</span><span class="p">.</span><span class="n">LogicalBlockAddress</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockNumber</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type5</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">ScatterGatherListDMA</span><span class="p">;</span>

      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type5</span><span class="p">.</span><span class="n">ScatterGatherCount</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">SegmentCount</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">SegmentCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ScatterList</span><span class="o">++</span><span class="p">,</span> <span class="n">ScatterGatherList</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ScatterGatherList</span><span class="o">-&gt;</span><span class="n">SegmentDataPointer</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">DAC960_BusAddress32_T</span><span class="p">)</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">ScatterList</span><span class="p">);</span>
		<span class="n">ScatterGatherList</span><span class="o">-&gt;</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">DAC960_ByteCount32_T</span><span class="p">)</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">ScatterList</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_QueueReadWriteCommand prepares and queues a Read/Write Command for</span>
<span class="cm">  DAC960 V2 Firmware Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_V2_QueueReadWriteCommand</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">ScatterList</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">ScatterList</span><span class="p">;</span>

  <span class="n">DAC960_V2_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>

  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V2_SCSI_10</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">CommandControlBits</span><span class="p">.</span><span class="n">DataTransferControllerToHost</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">DmaDirection</span> <span class="o">==</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">DataTransferSize</span> <span class="o">=</span>
    <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockCount</span> <span class="o">&lt;&lt;</span> <span class="n">DAC960_BlockSizeBits</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">RequestSenseBusAddress</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSenseDMA</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">PhysicalDevice</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDriveToVirtualDevice</span><span class="p">[</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">LogicalDriveNumber</span><span class="p">];</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">RequestSenseSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_RequestSense_T</span><span class="p">);</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">CDBLength</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">SCSI_CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">DmaDirection</span> <span class="o">==</span> <span class="n">PCI_DMA_FROMDEVICE</span> <span class="o">?</span> <span class="mh">0x28</span> <span class="o">:</span> <span class="mh">0x2A</span><span class="p">);</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">SCSI_CDB</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockNumber</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">SCSI_CDB</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockNumber</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">SCSI_CDB</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockNumber</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">SCSI_CDB</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockNumber</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">SCSI_CDB</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockCount</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">SCSI_CDB</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockCount</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">SegmentCount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
			     <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			     <span class="p">.</span><span class="n">SegmentDataPointer</span> <span class="o">=</span>
	<span class="p">(</span><span class="n">DAC960_BusAddress64_T</span><span class="p">)</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">ScatterList</span><span class="p">);</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
			     <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			     <span class="p">.</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
	<span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">DataTransferSize</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">DAC960_V2_ScatterGatherSegment_T</span> <span class="o">*</span><span class="n">ScatterGatherList</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">SegmentCount</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
	<span class="p">{</span>
          <span class="n">ScatterGatherList</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">ScatterGatherList</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">CommandControlBits</span>
			 <span class="p">.</span><span class="n">AdditionalScatterGatherListMemory</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
		<span class="p">.</span><span class="n">ExtendedScatterGather</span><span class="p">.</span><span class="n">ScatterGatherList0Length</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">SegmentCount</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
			 <span class="p">.</span><span class="n">ExtendedScatterGather</span><span class="p">.</span><span class="n">ScatterGatherList0Address</span> <span class="o">=</span>
	    <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">ScatterGatherListDMA</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">else</span>
	<span class="n">ScatterGatherList</span> <span class="o">=</span> <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
				 <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">SegmentCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ScatterList</span><span class="o">++</span><span class="p">,</span> <span class="n">ScatterGatherList</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ScatterGatherList</span><span class="o">-&gt;</span><span class="n">SegmentDataPointer</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">DAC960_BusAddress64_T</span><span class="p">)</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">ScatterList</span><span class="p">);</span>
		<span class="n">ScatterGatherList</span><span class="o">-&gt;</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">DAC960_ByteCount64_T</span><span class="p">)</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">ScatterList</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">DAC960_process_queue</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">req_q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">Request</span><span class="p">;</span>
	<span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">;</span>

   <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">Request</span> <span class="o">=</span> <span class="n">blk_peek_request</span><span class="p">(</span><span class="n">req_q</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Request</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Command</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">Request</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Command</span><span class="o">-&gt;</span><span class="n">DmaDirection</span> <span class="o">=</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">;</span>
		<span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ReadCommand</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">Command</span><span class="o">-&gt;</span><span class="n">DmaDirection</span> <span class="o">=</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">;</span>
		<span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_WriteCommand</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">Command</span><span class="o">-&gt;</span><span class="n">Completion</span> <span class="o">=</span> <span class="n">Request</span><span class="o">-&gt;</span><span class="n">end_io_data</span><span class="p">;</span>
	<span class="n">Command</span><span class="o">-&gt;</span><span class="n">LogicalDriveNumber</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">Request</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockNumber</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">Request</span><span class="p">);</span>
	<span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockCount</span> <span class="o">=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">Request</span><span class="p">);</span>
	<span class="n">Command</span><span class="o">-&gt;</span><span class="n">Request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">;</span>
	<span class="n">blk_start_request</span><span class="p">(</span><span class="n">Request</span><span class="p">);</span>
	<span class="n">Command</span><span class="o">-&gt;</span><span class="n">SegmentCount</span> <span class="o">=</span> <span class="n">blk_rq_map_sg</span><span class="p">(</span><span class="n">req_q</span><span class="p">,</span>
		  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">cmd_sglist</span><span class="p">);</span>
	<span class="cm">/* pci_map_sg MAY change the value of SegCount */</span>
	<span class="n">Command</span><span class="o">-&gt;</span><span class="n">SegmentCount</span> <span class="o">=</span> <span class="n">pci_map_sg</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">cmd_sglist</span><span class="p">,</span>
		 <span class="n">Command</span><span class="o">-&gt;</span><span class="n">SegmentCount</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">DmaDirection</span><span class="p">);</span>

	<span class="n">DAC960_QueueReadWriteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  DAC960_ProcessRequest attempts to remove one I/O Request from Controller&#39;s</span>
<span class="cm">  I/O Request Queue and queues it to the Controller.  WaitForCommand is true if</span>
<span class="cm">  this function should wait for a Command to become available if necessary.</span>
<span class="cm">  This function returns true if an I/O Request was queued and false otherwise.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_ProcessRequest</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">controller</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">ControllerInitialized</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Do this better later! */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">controller</span><span class="o">-&gt;</span><span class="n">req_q_index</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DAC960_MaxLogicalDrives</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">req_q</span> <span class="o">=</span> <span class="n">controller</span><span class="o">-&gt;</span><span class="n">RequestQueue</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req_q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_process_queue</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">req_q</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">controller</span><span class="o">-&gt;</span><span class="n">req_q_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">req_q_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">controller</span><span class="o">-&gt;</span><span class="n">req_q_index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">req_q</span> <span class="o">=</span> <span class="n">controller</span><span class="o">-&gt;</span><span class="n">RequestQueue</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req_q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_process_queue</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">req_q</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">controller</span><span class="o">-&gt;</span><span class="n">req_q_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_queue_partial_rw extracts one bio from the request already</span>
<span class="cm">  associated with argument command, and construct a new command block to retry I/O</span>
<span class="cm">  only on that bio.  Queue that command to the controller.</span>

<span class="cm">  This function re-uses a previously-allocated Command,</span>
<span class="cm">  	there is no failure mode from trying to allocate a command.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_queue_partial_rw</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">Request</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">req_q</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">RequestQueue</span><span class="p">[</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">LogicalDriveNumber</span><span class="p">];</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">DmaDirection</span> <span class="o">==</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">)</span>
    <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ReadRetryCommand</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_WriteRetryCommand</span><span class="p">;</span>

  <span class="cm">/*</span>
<span class="cm">   * We could be more efficient with these mapping requests</span>
<span class="cm">   * and map only the portions that we need.  But since this</span>
<span class="cm">   * code should almost never be called, just go with a</span>
<span class="cm">   * simple coding.</span>
<span class="cm">   */</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">blk_rq_map_sg</span><span class="p">(</span><span class="n">req_q</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">cmd_sglist</span><span class="p">);</span>

  <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">pci_map_sg</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">cmd_sglist</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">DmaDirection</span><span class="p">);</span>
  <span class="cm">/*</span>
<span class="cm">   * Resubmitting the request sector at a time is really tedious.</span>
<span class="cm">   * But, this should almost never happen.  So, we&#39;re willing to pay</span>
<span class="cm">   * this price so that in the end, as much of the transfer is completed</span>
<span class="cm">   * successfully as possible.</span>
<span class="cm">   */</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">SegmentCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockNumber</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">Request</span><span class="p">);</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">DAC960_QueueReadWriteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  DAC960_RequestFunction is the I/O Request Function for DAC960 Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_RequestFunction</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">RequestQueue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DAC960_ProcessRequest</span><span class="p">(</span><span class="n">RequestQueue</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  DAC960_ProcessCompletedBuffer performs completion processing for an</span>
<span class="cm">  individual Buffer.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">DAC960_ProcessCompletedRequest</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">,</span>
						 <span class="n">bool</span> <span class="n">SuccessfulIO</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">Request</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">Error</span> <span class="o">=</span> <span class="n">SuccessfulIO</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">pci_unmap_sg</span><span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">cmd_sglist</span><span class="p">,</span>
		<span class="n">Command</span><span class="o">-&gt;</span><span class="n">SegmentCount</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">DmaDirection</span><span class="p">);</span>

	 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__blk_end_request</span><span class="p">(</span><span class="n">Request</span><span class="p">,</span> <span class="n">Error</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockCount</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">Completion</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">complete</span><span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">Completion</span><span class="p">);</span>
			<span class="n">Command</span><span class="o">-&gt;</span><span class="n">Completion</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  DAC960_V1_ReadWriteError prints an appropriate error message for Command</span>
<span class="cm">  when an error occurs on a Read or Write operation.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_V1_ReadWriteError</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">CommandName</span> <span class="o">=</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">DAC960_ReadCommand</span>:
    <span class="k">case</span> <span class="n">DAC960_ReadRetryCommand</span>:
      <span class="n">CommandName</span> <span class="o">=</span> <span class="s">&quot;READ&quot;</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_WriteCommand</span>:
    <span class="k">case</span> <span class="n">DAC960_WriteRetryCommand</span>:
      <span class="n">CommandName</span> <span class="o">=</span> <span class="s">&quot;WRITE&quot;</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_MonitoringCommand</span>:
    <span class="k">case</span> <span class="n">DAC960_ImmediateCommand</span>:
    <span class="k">case</span> <span class="n">DAC960_QueuedCommand</span>:
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">DAC960_V1_IrrecoverableDataError</span>:
      <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Irrecoverable Data Error on %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">Controller</span><span class="p">,</span> <span class="n">CommandName</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_LogicalDriveNonexistentOrOffline</span>:
      <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Logical Drive Nonexistent or Offline on %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">Controller</span><span class="p">,</span> <span class="n">CommandName</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_AccessBeyondEndOfLogicalDrive</span>:
      <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Attempt to Access Beyond End of Logical Drive &quot;</span>
		   <span class="s">&quot;on %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">CommandName</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_BadDataEncountered</span>:
      <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Bad Data Encountered on %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">CommandName</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Unexpected Error Status %04X on %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">Controller</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">,</span> <span class="n">CommandName</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;  /dev/rd/c%dd%d:   absolute blocks %u..%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
	       <span class="n">Command</span><span class="o">-&gt;</span><span class="n">LogicalDriveNumber</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockNumber</span><span class="p">,</span>
	       <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockNumber</span> <span class="o">+</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V1_ProcessCompletedCommand performs completion processing for Command</span>
<span class="cm">  for DAC960 V1 Firmware Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_V1_ProcessCompletedCommand</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="n">DAC960_CommandType_T</span> <span class="n">CommandType</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandOpcode_T</span> <span class="n">CommandOpcode</span> <span class="o">=</span>
    <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandStatus_T</span> <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">CommandType</span> <span class="o">==</span> <span class="n">DAC960_ReadCommand</span> <span class="o">||</span>
      <span class="n">CommandType</span> <span class="o">==</span> <span class="n">DAC960_WriteCommand</span><span class="p">)</span>
    <span class="p">{</span>

<span class="cp">#ifdef FORCE_RETRY_DEBUG</span>
      <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">DAC960_V1_IrrecoverableDataError</span><span class="p">;</span>
<span class="cp">#endif</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V1_NormalCompletion</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_ProcessCompletedRequest</span><span class="p">(</span><span class="n">Command</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="n">BUG</span><span class="p">();</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V1_IrrecoverableDataError</span> <span class="o">||</span>
		<span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V1_BadDataEncountered</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="cm">/*</span>
<span class="cm">	   * break the command down into pieces and resubmit each</span>
<span class="cm">	   * piece, hoping that some of them will succeed.</span>
<span class="cm">	   */</span>
	   <span class="n">DAC960_queue_partial_rw</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	   <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">else</span>
	<span class="p">{</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">!=</span> <span class="n">DAC960_V1_LogicalDriveNonexistentOrOffline</span><span class="p">)</span>
	    <span class="n">DAC960_V1_ReadWriteError</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>

	 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_ProcessCompletedRequest</span><span class="p">(</span><span class="n">Command</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CommandType</span> <span class="o">==</span> <span class="n">DAC960_ReadRetryCommand</span> <span class="o">||</span>
	   <span class="n">CommandType</span> <span class="o">==</span> <span class="n">DAC960_WriteRetryCommand</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">bool</span> <span class="n">normal_completion</span><span class="p">;</span>
<span class="cp">#ifdef FORCE_RETRY_FAILURE_DEBUG</span>
      <span class="k">static</span> <span class="kt">int</span> <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
      <span class="cm">/*</span>
<span class="cm">        Perform completion processing for the portion that was</span>
<span class="cm">        retried, and submit the next portion, if any.</span>
<span class="cm">      */</span>
      <span class="n">normal_completion</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">!=</span> <span class="n">DAC960_V1_NormalCompletion</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">normal_completion</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">!=</span> <span class="n">DAC960_V1_LogicalDriveNonexistentOrOffline</span><span class="p">)</span>
            <span class="n">DAC960_V1_ReadWriteError</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="p">}</span>

<span class="cp">#ifdef FORCE_RETRY_FAILURE_DEBUG</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">++</span><span class="n">retry_count</span> <span class="o">%</span> <span class="mi">10000</span><span class="p">))</span> <span class="p">{</span>
	      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;V1 error retry failure test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	      <span class="n">normal_completion</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
              <span class="n">DAC960_V1_ReadWriteError</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="p">}</span>
<span class="cp">#endif</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_ProcessCompletedRequest</span><span class="p">(</span><span class="n">Command</span><span class="p">,</span> <span class="n">normal_completion</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">DAC960_queue_partial_rw</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CommandType</span> <span class="o">==</span> <span class="n">DAC960_MonitoringCommand</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ShutdownMonitoringTimer</span><span class="p">)</span>
	      <span class="k">return</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">CommandOpcode</span> <span class="o">==</span> <span class="n">DAC960_V1_Enquiry</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">DAC960_V1_Enquiry_T</span> <span class="o">*</span><span class="n">OldEnquiry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">Enquiry</span><span class="p">;</span>
	  <span class="n">DAC960_V1_Enquiry_T</span> <span class="o">*</span><span class="n">NewEnquiry</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewEnquiry</span><span class="p">;</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">OldCriticalLogicalDriveCount</span> <span class="o">=</span>
	    <span class="n">OldEnquiry</span><span class="o">-&gt;</span><span class="n">CriticalLogicalDriveCount</span><span class="p">;</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">NewCriticalLogicalDriveCount</span> <span class="o">=</span>
	    <span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">CriticalLogicalDriveCount</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">NumberOfLogicalDrives</span> <span class="o">&gt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LogicalDriveCount</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="kt">int</span> <span class="n">LogicalDriveNumber</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LogicalDriveCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">LogicalDriveNumber</span> <span class="o">&lt;</span> <span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">NumberOfLogicalDrives</span><span class="p">)</span>
		<span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Logical Drive %d (/dev/rd/c%dd%d) &quot;</span>
				<span class="s">&quot;Now Exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
				<span class="n">LogicalDriveNumber</span><span class="p">,</span>
				<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
				<span class="n">LogicalDriveNumber</span><span class="p">);</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LogicalDriveCount</span> <span class="o">=</span> <span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">NumberOfLogicalDrives</span><span class="p">;</span>
	      <span class="n">DAC960_ComputeGenericDiskInfo</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">NumberOfLogicalDrives</span> <span class="o">&lt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LogicalDriveCount</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="kt">int</span> <span class="n">LogicalDriveNumber</span> <span class="o">=</span> <span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">NumberOfLogicalDrives</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">LogicalDriveNumber</span> <span class="o">&lt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LogicalDriveCount</span><span class="p">)</span>
		<span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Logical Drive %d (/dev/rd/c%dd%d) &quot;</span>
				<span class="s">&quot;No Longer Exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
				<span class="n">LogicalDriveNumber</span><span class="p">,</span>
				<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
				<span class="n">LogicalDriveNumber</span><span class="p">);</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LogicalDriveCount</span> <span class="o">=</span> <span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">NumberOfLogicalDrives</span><span class="p">;</span>
	      <span class="n">DAC960_ComputeGenericDiskInfo</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">StatusFlags</span><span class="p">.</span><span class="n">DeferredWriteError</span> <span class="o">!=</span>
	      <span class="n">OldEnquiry</span><span class="o">-&gt;</span><span class="n">StatusFlags</span><span class="p">.</span><span class="n">DeferredWriteError</span><span class="p">)</span>
	    <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Deferred Write Error Flag is now %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">StatusFlags</span><span class="p">.</span><span class="n">DeferredWriteError</span>
			     <span class="o">?</span> <span class="s">&quot;TRUE&quot;</span> <span class="o">:</span> <span class="s">&quot;FALSE&quot;</span><span class="p">));</span>
	  <span class="k">if</span> <span class="p">((</span><span class="n">NewCriticalLogicalDriveCount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	       <span class="n">NewCriticalLogicalDriveCount</span> <span class="o">!=</span> <span class="n">OldCriticalLogicalDriveCount</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">OfflineLogicalDriveCount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	       <span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">OfflineLogicalDriveCount</span> <span class="o">!=</span>
	       <span class="n">OldEnquiry</span><span class="o">-&gt;</span><span class="n">OfflineLogicalDriveCount</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">DeadDriveCount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	       <span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">DeadDriveCount</span> <span class="o">!=</span>
	       <span class="n">OldEnquiry</span><span class="o">-&gt;</span><span class="n">DeadDriveCount</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">EventLogSequenceNumber</span> <span class="o">!=</span>
	       <span class="n">OldEnquiry</span><span class="o">-&gt;</span><span class="n">EventLogSequenceNumber</span><span class="p">)</span> <span class="o">||</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimerCount</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	      <span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">SecondaryMonitoringTime</span>
	       <span class="o">+</span> <span class="n">DAC960_SecondaryMonitoringInterval</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedLogicalDriveInformation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewEventLogSequenceNumber</span> <span class="o">=</span>
		<span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">EventLogSequenceNumber</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedErrorTableInformation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedDeviceStateInformation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">StartDeviceStateScan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedBackgroundInitializationStatus</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatusSupported</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">SecondaryMonitoringTime</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">RebuildFlag</span> <span class="o">==</span> <span class="n">DAC960_V1_StandbyRebuildInProgress</span> <span class="o">||</span>
	      <span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">RebuildFlag</span>
	      <span class="o">==</span> <span class="n">DAC960_V1_BackgroundRebuildInProgress</span> <span class="o">||</span>
	      <span class="n">OldEnquiry</span><span class="o">-&gt;</span><span class="n">RebuildFlag</span> <span class="o">==</span> <span class="n">DAC960_V1_StandbyRebuildInProgress</span> <span class="o">||</span>
	      <span class="n">OldEnquiry</span><span class="o">-&gt;</span><span class="n">RebuildFlag</span> <span class="o">==</span> <span class="n">DAC960_V1_BackgroundRebuildInProgress</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedRebuildProgress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildProgressFirst</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">CriticalLogicalDriveCount</span> <span class="o">&lt;</span>
		 <span class="n">OldEnquiry</span><span class="o">-&gt;</span><span class="n">CriticalLogicalDriveCount</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">OldEnquiry</span><span class="o">-&gt;</span><span class="n">RebuildFlag</span> <span class="o">==</span> <span class="n">DAC960_V1_BackgroundCheckInProgress</span><span class="p">)</span>
	    <span class="k">switch</span> <span class="p">(</span><span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">RebuildFlag</span><span class="p">)</span>
	      <span class="p">{</span>
	      <span class="k">case</span> <span class="n">DAC960_V1_NoStandbyRebuildOrCheckInProgress</span>:
		<span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Consistency Check Completed Successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">Controller</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">DAC960_V1_StandbyRebuildInProgress</span>:
	      <span class="k">case</span> <span class="n">DAC960_V1_BackgroundRebuildInProgress</span>:
		<span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">DAC960_V1_BackgroundCheckInProgress</span>:
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedConsistencyCheckProgress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">DAC960_V1_StandbyRebuildCompletedWithError</span>:
		<span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Consistency Check Completed with Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">Controller</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">DAC960_V1_BackgroundRebuildOrCheckFailed_DriveFailed</span>:
		<span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Consistency Check Failed - &quot;</span>
				<span class="s">&quot;Physical Device Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">DAC960_V1_BackgroundRebuildOrCheckFailed_LogicalDriveFailed</span>:
		<span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Consistency Check Failed - &quot;</span>
				<span class="s">&quot;Logical Drive Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">DAC960_V1_BackgroundRebuildOrCheckFailed_OtherCauses</span>:
		<span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Consistency Check Failed - Other Causes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">Controller</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="n">DAC960_V1_BackgroundRebuildOrCheckSuccessfullyTerminated</span>:
		<span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Consistency Check Successfully Terminated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">Controller</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	      <span class="p">}</span>
	  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">RebuildFlag</span>
		   <span class="o">==</span> <span class="n">DAC960_V1_BackgroundCheckInProgress</span><span class="p">)</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedConsistencyCheckProgress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringAlertMode</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">CriticalLogicalDriveCount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	     <span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">OfflineLogicalDriveCount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	     <span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">DeadDriveCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">RebuildFlag</span> <span class="o">&gt;</span> <span class="n">DAC960_V1_BackgroundCheckInProgress</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PendingRebuildFlag</span> <span class="o">=</span> <span class="n">NewEnquiry</span><span class="o">-&gt;</span><span class="n">RebuildFlag</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildFlagPending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">Enquiry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewEnquiry</span><span class="p">,</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_Enquiry_T</span><span class="p">));</span>
	<span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CommandOpcode</span> <span class="o">==</span> <span class="n">DAC960_V1_PerformEventLogOperation</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="k">static</span> <span class="kt">char</span>
	    <span class="o">*</span><span class="n">DAC960_EventMessages</span><span class="p">[]</span> <span class="o">=</span>
	       <span class="p">{</span> <span class="s">&quot;killed because write recovery failed&quot;</span><span class="p">,</span>
		 <span class="s">&quot;killed because of SCSI bus reset failure&quot;</span><span class="p">,</span>
		 <span class="s">&quot;killed because of double check condition&quot;</span><span class="p">,</span>
		 <span class="s">&quot;killed because it was removed&quot;</span><span class="p">,</span>
		 <span class="s">&quot;killed because of gross error on SCSI chip&quot;</span><span class="p">,</span>
		 <span class="s">&quot;killed because of bad tag returned from drive&quot;</span><span class="p">,</span>
		 <span class="s">&quot;killed because of timeout on SCSI command&quot;</span><span class="p">,</span>
		 <span class="s">&quot;killed because of reset SCSI command issued from system&quot;</span><span class="p">,</span>
		 <span class="s">&quot;killed because busy or parity error count exceeded limit&quot;</span><span class="p">,</span>
		 <span class="s">&quot;killed because of &#39;kill drive&#39; command from system&quot;</span><span class="p">,</span>
		 <span class="s">&quot;killed because of selection timeout&quot;</span><span class="p">,</span>
		 <span class="s">&quot;killed due to SCSI phase sequence error&quot;</span><span class="p">,</span>
		 <span class="s">&quot;killed due to unknown status&quot;</span> <span class="p">};</span>
	  <span class="n">DAC960_V1_EventLogEntry_T</span> <span class="o">*</span><span class="n">EventLogEntry</span> <span class="o">=</span>
	    	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">EventLogEntry</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">SequenceNumber</span> <span class="o">==</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">OldEventLogSequenceNumber</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SenseKey</span> <span class="o">=</span> <span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">SenseKey</span><span class="p">;</span>
	      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">AdditionalSenseCode</span> <span class="o">=</span>
		<span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCode</span><span class="p">;</span>
	      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">AdditionalSenseCodeQualifier</span> <span class="o">=</span>
		<span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCodeQualifier</span><span class="p">;</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">SenseKey</span> <span class="o">==</span> <span class="n">DAC960_SenseKey_VendorSpecific</span> <span class="o">&amp;&amp;</span>
		  <span class="n">AdditionalSenseCode</span> <span class="o">==</span> <span class="mh">0x80</span> <span class="o">&amp;&amp;</span>
		  <span class="n">AdditionalSenseCodeQualifier</span> <span class="o">&lt;</span>
		  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">DAC960_EventMessages</span><span class="p">))</span>
		<span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
				<span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span>
				<span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span>
				<span class="n">DAC960_EventMessages</span><span class="p">[</span>
				  <span class="n">AdditionalSenseCodeQualifier</span><span class="p">]);</span>
	      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SenseKey</span> <span class="o">==</span> <span class="n">DAC960_SenseKey_UnitAttention</span> <span class="o">&amp;&amp;</span>
		       <span class="n">AdditionalSenseCode</span> <span class="o">==</span> <span class="mh">0x29</span><span class="p">)</span>
		<span class="p">{</span>
		  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimerCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceResetCount</span><span class="p">[</span><span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">]</span>
						   <span class="p">[</span><span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SenseKey</span> <span class="o">==</span> <span class="n">DAC960_SenseKey_NoSense</span> <span class="o">||</span>
			 <span class="p">(</span><span class="n">SenseKey</span> <span class="o">==</span> <span class="n">DAC960_SenseKey_NotReady</span> <span class="o">&amp;&amp;</span>
			  <span class="n">AdditionalSenseCode</span> <span class="o">==</span> <span class="mh">0x04</span> <span class="o">&amp;&amp;</span>
			  <span class="p">(</span><span class="n">AdditionalSenseCodeQualifier</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="o">||</span>
			   <span class="n">AdditionalSenseCodeQualifier</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">))))</span>
		<span class="p">{</span>
		  <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d Error Log: &quot;</span>
				  <span class="s">&quot;Sense Key = %X, ASC = %02X, ASCQ = %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">Controller</span><span class="p">,</span>
				  <span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span>
				  <span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span>
				  <span class="n">SenseKey</span><span class="p">,</span>
				  <span class="n">AdditionalSenseCode</span><span class="p">,</span>
				  <span class="n">AdditionalSenseCodeQualifier</span><span class="p">);</span>
		  <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d Error Log: &quot;</span>
				  <span class="s">&quot;Information = %02X%02X%02X%02X &quot;</span>
				  <span class="s">&quot;%02X%02X%02X%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">Controller</span><span class="p">,</span>
				  <span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span>
				  <span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span>
				  <span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">Information</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				  <span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">Information</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				  <span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">Information</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				  <span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">Information</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
				  <span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">CommandSpecificInformation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				  <span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">CommandSpecificInformation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				  <span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">CommandSpecificInformation</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				  <span class="n">EventLogEntry</span><span class="o">-&gt;</span><span class="n">CommandSpecificInformation</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">OldEventLogSequenceNumber</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CommandOpcode</span> <span class="o">==</span> <span class="n">DAC960_V1_GetErrorTable</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">DAC960_V1_ErrorTable_T</span> <span class="o">*</span><span class="n">OldErrorTable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">ErrorTable</span><span class="p">;</span>
	  <span class="n">DAC960_V1_ErrorTable_T</span> <span class="o">*</span><span class="n">NewErrorTable</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewErrorTable</span><span class="p">;</span>
	  <span class="kt">int</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">;</span>
	  <span class="k">for</span> <span class="p">(</span><span class="n">Channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">Channel</span> <span class="o">&lt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">;</span> <span class="n">Channel</span><span class="o">++</span><span class="p">)</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">TargetID</span> <span class="o">&lt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Targets</span><span class="p">;</span> <span class="n">TargetID</span><span class="o">++</span><span class="p">)</span>
	      <span class="p">{</span>
		<span class="n">DAC960_V1_ErrorTableEntry_T</span> <span class="o">*</span><span class="n">NewErrorEntry</span> <span class="o">=</span>
		  <span class="o">&amp;</span><span class="n">NewErrorTable</span><span class="o">-&gt;</span><span class="n">ErrorTableEntries</span><span class="p">[</span><span class="n">Channel</span><span class="p">][</span><span class="n">TargetID</span><span class="p">];</span>
		<span class="n">DAC960_V1_ErrorTableEntry_T</span> <span class="o">*</span><span class="n">OldErrorEntry</span> <span class="o">=</span>
		  <span class="o">&amp;</span><span class="n">OldErrorTable</span><span class="o">-&gt;</span><span class="n">ErrorTableEntries</span><span class="p">[</span><span class="n">Channel</span><span class="p">][</span><span class="n">TargetID</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">NewErrorEntry</span><span class="o">-&gt;</span><span class="n">ParityErrorCount</span> <span class="o">!=</span>
		     <span class="n">OldErrorEntry</span><span class="o">-&gt;</span><span class="n">ParityErrorCount</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">NewErrorEntry</span><span class="o">-&gt;</span><span class="n">SoftErrorCount</span> <span class="o">!=</span>
		     <span class="n">OldErrorEntry</span><span class="o">-&gt;</span><span class="n">SoftErrorCount</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">NewErrorEntry</span><span class="o">-&gt;</span><span class="n">HardErrorCount</span> <span class="o">!=</span>
		     <span class="n">OldErrorEntry</span><span class="o">-&gt;</span><span class="n">HardErrorCount</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">NewErrorEntry</span><span class="o">-&gt;</span><span class="n">MiscErrorCount</span> <span class="o">!=</span>
		     <span class="n">OldErrorEntry</span><span class="o">-&gt;</span><span class="n">MiscErrorCount</span><span class="p">))</span>
		  <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d Errors: &quot;</span>
				  <span class="s">&quot;Parity = %d, Soft = %d, &quot;</span>
				  <span class="s">&quot;Hard = %d, Misc = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
				  <span class="n">NewErrorEntry</span><span class="o">-&gt;</span><span class="n">ParityErrorCount</span><span class="p">,</span>
				  <span class="n">NewErrorEntry</span><span class="o">-&gt;</span><span class="n">SoftErrorCount</span><span class="p">,</span>
				  <span class="n">NewErrorEntry</span><span class="o">-&gt;</span><span class="n">HardErrorCount</span><span class="p">,</span>
				  <span class="n">NewErrorEntry</span><span class="o">-&gt;</span><span class="n">MiscErrorCount</span><span class="p">);</span>
	      <span class="p">}</span>
	  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">ErrorTable</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewErrorTable</span><span class="p">,</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_ErrorTable_T</span><span class="p">));</span>
	<span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CommandOpcode</span> <span class="o">==</span> <span class="n">DAC960_V1_GetDeviceState</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">DAC960_V1_DeviceState_T</span> <span class="o">*</span><span class="n">OldDeviceState</span> <span class="o">=</span>
	    <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceState</span><span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateChannel</span><span class="p">]</span>
				       <span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateTargetID</span><span class="p">];</span>
	  <span class="n">DAC960_V1_DeviceState_T</span> <span class="o">*</span><span class="n">NewDeviceState</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewDeviceState</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">NewDeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span> <span class="o">!=</span> <span class="n">OldDeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span><span class="p">)</span>
	    <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d is now %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateChannel</span><span class="p">,</span>
			    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateTargetID</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">NewDeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span>
			     <span class="o">==</span> <span class="n">DAC960_V1_Device_Dead</span>
			     <span class="o">?</span> <span class="s">&quot;DEAD&quot;</span>
			     <span class="o">:</span> <span class="n">NewDeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span>
			       <span class="o">==</span> <span class="n">DAC960_V1_Device_WriteOnly</span>
			       <span class="o">?</span> <span class="s">&quot;WRITE-ONLY&quot;</span>
			       <span class="o">:</span> <span class="n">NewDeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span>
				 <span class="o">==</span> <span class="n">DAC960_V1_Device_Online</span>
				 <span class="o">?</span> <span class="s">&quot;ONLINE&quot;</span> <span class="o">:</span> <span class="s">&quot;STANDBY&quot;</span><span class="p">));</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">OldDeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span> <span class="o">==</span> <span class="n">DAC960_V1_Device_Dead</span> <span class="o">&amp;&amp;</span>
	      <span class="n">NewDeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span> <span class="o">!=</span> <span class="n">DAC960_V1_Device_Dead</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedDeviceInquiryInformation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedDeviceSerialNumberInformation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceResetCount</span>
			     <span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateChannel</span><span class="p">]</span>
			     <span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateTargetID</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">memcpy</span><span class="p">(</span><span class="n">OldDeviceState</span><span class="p">,</span> <span class="n">NewDeviceState</span><span class="p">,</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_DeviceState_T</span><span class="p">));</span>
	<span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CommandOpcode</span> <span class="o">==</span> <span class="n">DAC960_V1_GetLogicalDriveInformation</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="kt">int</span> <span class="n">LogicalDriveNumber</span><span class="p">;</span>
	  <span class="k">for</span> <span class="p">(</span><span class="n">LogicalDriveNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	       <span class="n">LogicalDriveNumber</span> <span class="o">&lt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LogicalDriveCount</span><span class="p">;</span>
	       <span class="n">LogicalDriveNumber</span><span class="o">++</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_V1_LogicalDriveInformation_T</span> <span class="o">*</span><span class="n">OldLogicalDriveInformation</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LogicalDriveInformation</span><span class="p">[</span><span class="n">LogicalDriveNumber</span><span class="p">];</span>
	      <span class="n">DAC960_V1_LogicalDriveInformation_T</span> <span class="o">*</span><span class="n">NewLogicalDriveInformation</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewLogicalDriveInformation</span><span class="p">)[</span><span class="n">LogicalDriveNumber</span><span class="p">];</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">NewLogicalDriveInformation</span><span class="o">-&gt;</span><span class="n">LogicalDriveState</span> <span class="o">!=</span>
		  <span class="n">OldLogicalDriveInformation</span><span class="o">-&gt;</span><span class="n">LogicalDriveState</span><span class="p">)</span>
		<span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Logical Drive %d (/dev/rd/c%dd%d) &quot;</span>
				<span class="s">&quot;is now %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
				<span class="n">LogicalDriveNumber</span><span class="p">,</span>
				<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
				<span class="n">LogicalDriveNumber</span><span class="p">,</span>
				<span class="p">(</span><span class="n">NewLogicalDriveInformation</span><span class="o">-&gt;</span><span class="n">LogicalDriveState</span>
				 <span class="o">==</span> <span class="n">DAC960_V1_LogicalDrive_Online</span>
				 <span class="o">?</span> <span class="s">&quot;ONLINE&quot;</span>
				 <span class="o">:</span> <span class="n">NewLogicalDriveInformation</span><span class="o">-&gt;</span><span class="n">LogicalDriveState</span>
				   <span class="o">==</span> <span class="n">DAC960_V1_LogicalDrive_Critical</span>
				   <span class="o">?</span> <span class="s">&quot;CRITICAL&quot;</span> <span class="o">:</span> <span class="s">&quot;OFFLINE&quot;</span><span class="p">));</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">NewLogicalDriveInformation</span><span class="o">-&gt;</span><span class="n">WriteBack</span> <span class="o">!=</span>
		  <span class="n">OldLogicalDriveInformation</span><span class="o">-&gt;</span><span class="n">WriteBack</span><span class="p">)</span>
		<span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Logical Drive %d (/dev/rd/c%dd%d) &quot;</span>
				<span class="s">&quot;is now %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
				<span class="n">LogicalDriveNumber</span><span class="p">,</span>
				<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
				<span class="n">LogicalDriveNumber</span><span class="p">,</span>
				<span class="p">(</span><span class="n">NewLogicalDriveInformation</span><span class="o">-&gt;</span><span class="n">WriteBack</span>
				 <span class="o">?</span> <span class="s">&quot;WRITE BACK&quot;</span> <span class="o">:</span> <span class="s">&quot;WRITE THRU&quot;</span><span class="p">));</span>
	    <span class="p">}</span>
	  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LogicalDriveInformation</span><span class="p">,</span>
		 <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewLogicalDriveInformation</span><span class="p">,</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_LogicalDriveInformationArray_T</span><span class="p">));</span>
	<span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CommandOpcode</span> <span class="o">==</span> <span class="n">DAC960_V1_GetRebuildProgress</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">LogicalDriveNumber</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildProgress</span><span class="o">-&gt;</span><span class="n">LogicalDriveNumber</span><span class="p">;</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">LogicalDriveSize</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildProgress</span><span class="o">-&gt;</span><span class="n">LogicalDriveSize</span><span class="p">;</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">BlocksCompleted</span> <span class="o">=</span>
	    <span class="n">LogicalDriveSize</span> <span class="o">-</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildProgress</span><span class="o">-&gt;</span><span class="n">RemainingBlocks</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V1_NoRebuildOrCheckInProgress</span> <span class="o">&amp;&amp;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastRebuildStatus</span> <span class="o">==</span> <span class="n">DAC960_V1_NormalCompletion</span><span class="p">)</span>
	    <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">DAC960_V1_RebuildSuccessful</span><span class="p">;</span>
	  <span class="k">switch</span> <span class="p">(</span><span class="n">CommandStatus</span><span class="p">)</span>
	    <span class="p">{</span>
	    <span class="k">case</span> <span class="n">DAC960_V1_NormalCompletion</span>:
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">EphemeralProgressMessage</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	      <span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Rebuild in Progress: &quot;</span>
			      <span class="s">&quot;Logical Drive %d (/dev/rd/c%dd%d) &quot;</span>
			      <span class="s">&quot;%d%% completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">,</span> <span class="n">LogicalDriveNumber</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
			      <span class="n">LogicalDriveNumber</span><span class="p">,</span>
			      <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">BlocksCompleted</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">))</span>
			      <span class="o">/</span> <span class="p">(</span><span class="n">LogicalDriveSize</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">));</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">EphemeralProgressMessage</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">DAC960_V1_RebuildFailed_LogicalDriveFailure</span>:
	      <span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Rebuild Failed due to &quot;</span>
			      <span class="s">&quot;Logical Drive Failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">DAC960_V1_RebuildFailed_BadBlocksOnOther</span>:
	      <span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Rebuild Failed due to &quot;</span>
			      <span class="s">&quot;Bad Blocks on Other Drives</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">DAC960_V1_RebuildFailed_NewDriveFailed</span>:
	      <span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Rebuild Failed due to &quot;</span>
			      <span class="s">&quot;Failure of Drive Being Rebuilt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">DAC960_V1_NoRebuildOrCheckInProgress</span>:
	      <span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">DAC960_V1_RebuildSuccessful</span>:
	      <span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Rebuild Completed Successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">DAC960_V1_RebuildSuccessfullyTerminated</span>:
	      <span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Rebuild Successfully Terminated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastRebuildStatus</span> <span class="o">=</span> <span class="n">CommandStatus</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">CommandType</span> <span class="o">!=</span> <span class="n">DAC960_MonitoringCommand</span> <span class="o">&amp;&amp;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildStatusPending</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PendingRebuildStatus</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildStatusPending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CommandType</span> <span class="o">==</span> <span class="n">DAC960_MonitoringCommand</span> <span class="o">&amp;&amp;</span>
		   <span class="n">CommandStatus</span> <span class="o">!=</span> <span class="n">DAC960_V1_NormalCompletion</span> <span class="o">&amp;&amp;</span>
		   <span class="n">CommandStatus</span> <span class="o">!=</span> <span class="n">DAC960_V1_NoRebuildOrCheckInProgress</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">PendingRebuildStatus</span> <span class="o">=</span> <span class="n">CommandStatus</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildStatusPending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CommandOpcode</span> <span class="o">==</span> <span class="n">DAC960_V1_RebuildStat</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">LogicalDriveNumber</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildProgress</span><span class="o">-&gt;</span><span class="n">LogicalDriveNumber</span><span class="p">;</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">LogicalDriveSize</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildProgress</span><span class="o">-&gt;</span><span class="n">LogicalDriveSize</span><span class="p">;</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">BlocksCompleted</span> <span class="o">=</span>
	    <span class="n">LogicalDriveSize</span> <span class="o">-</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildProgress</span><span class="o">-&gt;</span><span class="n">RemainingBlocks</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V1_NormalCompletion</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">EphemeralProgressMessage</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	      <span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Consistency Check in Progress: &quot;</span>
			      <span class="s">&quot;Logical Drive %d (/dev/rd/c%dd%d) &quot;</span>
			      <span class="s">&quot;%d%% completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">,</span> <span class="n">LogicalDriveNumber</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
			      <span class="n">LogicalDriveNumber</span><span class="p">,</span>
			      <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">BlocksCompleted</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">))</span>
			      <span class="o">/</span> <span class="p">(</span><span class="n">LogicalDriveSize</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">));</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">EphemeralProgressMessage</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CommandOpcode</span> <span class="o">==</span> <span class="n">DAC960_V1_BackgroundInitializationControl</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">LogicalDriveNumber</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatus</span><span class="o">-&gt;</span><span class="n">LogicalDriveNumber</span><span class="p">;</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">LogicalDriveSize</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatus</span><span class="o">-&gt;</span><span class="n">LogicalDriveSize</span><span class="p">;</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">BlocksCompleted</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatus</span><span class="o">-&gt;</span><span class="n">BlocksCompleted</span><span class="p">;</span>
	  <span class="k">switch</span> <span class="p">(</span><span class="n">CommandStatus</span><span class="p">)</span>
	    <span class="p">{</span>
	    <span class="k">case</span> <span class="n">DAC960_V1_NormalCompletion</span>:
	      <span class="k">switch</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatus</span><span class="o">-&gt;</span><span class="n">Status</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">DAC960_V1_BackgroundInitializationInvalid</span>:
		  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DAC960_V1_BackgroundInitializationStarted</span>:
		  <span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Background Initialization Started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">Controller</span><span class="p">);</span>
		  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DAC960_V1_BackgroundInitializationInProgress</span>:
		  <span class="k">if</span> <span class="p">(</span><span class="n">BlocksCompleted</span> <span class="o">==</span>
		      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastBackgroundInitializationStatus</span><span class="p">.</span>
				<span class="n">BlocksCompleted</span> <span class="o">&amp;&amp;</span>
		      <span class="n">LogicalDriveNumber</span> <span class="o">==</span>
		      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastBackgroundInitializationStatus</span><span class="p">.</span>
				<span class="n">LogicalDriveNumber</span><span class="p">)</span>
		    <span class="k">break</span><span class="p">;</span>
		  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">EphemeralProgressMessage</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		  <span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Background Initialization in Progress: &quot;</span>
				  <span class="s">&quot;Logical Drive %d (/dev/rd/c%dd%d) &quot;</span>
				  <span class="s">&quot;%d%% completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">Controller</span><span class="p">,</span> <span class="n">LogicalDriveNumber</span><span class="p">,</span>
				  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
				  <span class="n">LogicalDriveNumber</span><span class="p">,</span>
				  <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">BlocksCompleted</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">))</span>
				  <span class="o">/</span> <span class="p">(</span><span class="n">LogicalDriveSize</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">));</span>
		  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">EphemeralProgressMessage</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DAC960_V1_BackgroundInitializationSuspended</span>:
		  <span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Background Initialization Suspended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">Controller</span><span class="p">);</span>
		  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DAC960_V1_BackgroundInitializationCancelled</span>:
		  <span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Background Initialization Cancelled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">Controller</span><span class="p">);</span>
		  <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	      <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastBackgroundInitializationStatus</span><span class="p">,</span>
		     <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatus</span><span class="p">,</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_BackgroundInitializationStatus_T</span><span class="p">));</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">DAC960_V1_BackgroundInitSuccessful</span>:
	      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatus</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span>
		  <span class="n">DAC960_V1_BackgroundInitializationInProgress</span><span class="p">)</span>
		<span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Background Initialization &quot;</span>
				<span class="s">&quot;Completed Successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatus</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">=</span>
		<span class="n">DAC960_V1_BackgroundInitializationInvalid</span><span class="p">;</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">DAC960_V1_BackgroundInitAborted</span>:
	      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatus</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">==</span>
		  <span class="n">DAC960_V1_BackgroundInitializationInProgress</span><span class="p">)</span>
		<span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Background Initialization Aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">Controller</span><span class="p">);</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatus</span><span class="o">-&gt;</span><span class="n">Status</span> <span class="o">=</span>
		<span class="n">DAC960_V1_BackgroundInitializationInvalid</span><span class="p">;</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">DAC960_V1_NoBackgroundInitInProgress</span>:
	      <span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span> 
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CommandOpcode</span> <span class="o">==</span> <span class="n">DAC960_V1_DCDB</span><span class="p">)</span>
	<span class="p">{</span>
	   <span class="cm">/*</span>
<span class="cm">	     This is a bit ugly.</span>

<span class="cm">	     The InquiryStandardData and </span>
<span class="cm">	     the InquiryUntitSerialNumber information</span>
<span class="cm">	     retrieval operations BOTH use the DAC960_V1_DCDB</span>
<span class="cm">	     commands.  the test above can&#39;t distinguish between</span>
<span class="cm">	     these two cases.</span>

<span class="cm">	     Instead, we rely on the order of code later in this</span>
<span class="cm">             function to ensure that DeviceInquiryInformation commands</span>
<span class="cm">             are submitted before DeviceSerialNumber commands.</span>
<span class="cm">	   */</span>
	   <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedDeviceInquiryInformation</span><span class="p">)</span>
	     <span class="p">{</span>
	        <span class="n">DAC960_SCSI_Inquiry_T</span> <span class="o">*</span><span class="n">InquiryStandardData</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">InquiryStandardData</span>
				<span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateChannel</span><span class="p">]</span>
				<span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateTargetID</span><span class="p">];</span>
	        <span class="k">if</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">!=</span> <span class="n">DAC960_V1_NormalCompletion</span><span class="p">)</span>
		   <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_T</span><span class="p">));</span>
	      		<span class="n">InquiryStandardData</span><span class="o">-&gt;</span><span class="n">PeripheralDeviceType</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
		    <span class="p">}</span>
	         <span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">InquiryStandardData</span><span class="p">,</span> 
				<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewInquiryStandardData</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_T</span><span class="p">));</span>
	         <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedDeviceInquiryInformation</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
              <span class="p">}</span>
	   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedDeviceSerialNumberInformation</span><span class="p">)</span> 
              <span class="p">{</span>
	        <span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span> <span class="o">*</span><span class="n">InquiryUnitSerialNumber</span> <span class="o">=</span>
		  <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span>
				<span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateChannel</span><span class="p">]</span>
				<span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateTargetID</span><span class="p">];</span>
	         <span class="k">if</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">!=</span> <span class="n">DAC960_V1_NormalCompletion</span><span class="p">)</span>
		   <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">));</span>
	      		<span class="n">InquiryUnitSerialNumber</span><span class="o">-&gt;</span><span class="n">PeripheralDeviceType</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
		    <span class="p">}</span>
	          <span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="p">,</span> 
				<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewInquiryUnitSerialNumber</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">));</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedDeviceSerialNumberInformation</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	     <span class="p">}</span>
	<span class="p">}</span>
      <span class="cm">/*</span>
<span class="cm">        Begin submitting new monitoring commands.</span>
<span class="cm">       */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewEventLogSequenceNumber</span>
	  <span class="o">-</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">OldEventLogSequenceNumber</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3E</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_PerformEventLogOperation</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3E</span><span class="p">.</span><span class="n">OperationType</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_GetEventLogEntry</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3E</span><span class="p">.</span><span class="n">OperationQualifier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3E</span><span class="p">.</span><span class="n">SequenceNumber</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">OldEventLogSequenceNumber</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3E</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span>
	    	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">EventLogEntryDMA</span><span class="p">;</span>
	  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedErrorTableInformation</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedErrorTableInformation</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_GetErrorTable</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span>
	    	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewErrorTableDMA</span><span class="p">;</span>
	  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedRebuildProgress</span> <span class="o">&amp;&amp;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildProgressFirst</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedRebuildProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_GetRebuildProgress</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildProgressDMA</span><span class="p">;</span>
	  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedDeviceStateInformation</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedDeviceInquiryInformation</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_V1_DCDB_T</span> <span class="o">*</span><span class="n">DCDB</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">MonitoringDCDB</span><span class="p">;</span>
	      <span class="n">dma_addr_t</span> <span class="n">DCDB_DMA</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">MonitoringDCDB_DMA</span><span class="p">;</span>

	      <span class="n">dma_addr_t</span> <span class="n">NewInquiryStandardDataDMA</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewInquiryStandardDataDMA</span><span class="p">;</span>

	      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_DCDB</span><span class="p">;</span>
	      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span> <span class="n">DCDB_DMA</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">Channel</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateChannel</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateTargetID</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">DAC960_V1_DCDB_DataTransferDeviceToSystem</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">EarlyStatus</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="n">DAC960_V1_DCDB_Timeout_10_seconds</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">NoAutomaticRequestSense</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">DisconnectPermitted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">TransferLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_T</span><span class="p">);</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">BusAddress</span> <span class="o">=</span> <span class="n">NewInquiryStandardDataDMA</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDBLength</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">TransferLengthHigh4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">SenseLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">SenseData</span><span class="p">);</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span> <span class="cm">/* INQUIRY */</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* EVPD = 0 */</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Page Code */</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Reserved */</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_T</span><span class="p">);</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Control */</span>
	      <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	      <span class="k">return</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedDeviceSerialNumberInformation</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_V1_DCDB_T</span> <span class="o">*</span><span class="n">DCDB</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">MonitoringDCDB</span><span class="p">;</span>
	      <span class="n">dma_addr_t</span> <span class="n">DCDB_DMA</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">MonitoringDCDB_DMA</span><span class="p">;</span>
	      <span class="n">dma_addr_t</span> <span class="n">NewInquiryUnitSerialNumberDMA</span> <span class="o">=</span> 
			<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewInquiryUnitSerialNumberDMA</span><span class="p">;</span>

	      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_DCDB</span><span class="p">;</span>
	      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span> <span class="n">DCDB_DMA</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">Channel</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateChannel</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateTargetID</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">DAC960_V1_DCDB_DataTransferDeviceToSystem</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">EarlyStatus</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">Timeout</span> <span class="o">=</span> <span class="n">DAC960_V1_DCDB_Timeout_10_seconds</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">NoAutomaticRequestSense</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">DisconnectPermitted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">TransferLength</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">);</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">BusAddress</span> <span class="o">=</span> <span class="n">NewInquiryUnitSerialNumberDMA</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDBLength</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">TransferLengthHigh4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">SenseLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">SenseData</span><span class="p">);</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span> <span class="cm">/* INQUIRY */</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* EVPD = 1 */</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* Page Code */</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Reserved */</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">);</span>
	      <span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Control */</span>
	      <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	      <span class="k">return</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">StartDeviceStateScan</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateChannel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateTargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">StartDeviceStateScan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateTargetID</span> <span class="o">==</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Targets</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateChannel</span><span class="o">++</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateTargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateChannel</span> <span class="o">&lt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewDeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span> <span class="o">=</span>
		<span class="n">DAC960_V1_Device_Dead</span><span class="p">;</span>
	      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3D</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span>
		<span class="n">DAC960_V1_GetDeviceState</span><span class="p">;</span>
	      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3D</span><span class="p">.</span><span class="n">Channel</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateChannel</span><span class="p">;</span>
	      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3D</span><span class="p">.</span><span class="n">TargetID</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceStateTargetID</span><span class="p">;</span>
	      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3D</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewDeviceStateDMA</span><span class="p">;</span>
	      <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	      <span class="k">return</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedDeviceStateInformation</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedLogicalDriveInformation</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedLogicalDriveInformation</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_GetLogicalDriveInformation</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewLogicalDriveInformationDMA</span><span class="p">;</span>
	  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedRebuildProgress</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedRebuildProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_GetRebuildProgress</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span>
	    	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildProgressDMA</span><span class="p">;</span>
	  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedConsistencyCheckProgress</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedConsistencyCheckProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_RebuildStat</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">RebuildProgressDMA</span><span class="p">;</span>
	  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedBackgroundInitializationStatus</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NeedBackgroundInitializationStatus</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3B</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_BackgroundInitializationControl</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3B</span><span class="p">.</span><span class="n">CommandOpcode2</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3B</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">BackgroundInitializationStatusDMA</span><span class="p">;</span>
	  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimerCount</span><span class="o">++</span><span class="p">;</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
	<span class="n">jiffies</span> <span class="o">+</span> <span class="n">DAC960_MonitoringTimerInterval</span><span class="p">;</span>
      	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimer</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">CommandType</span> <span class="o">==</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">complete</span><span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">Completion</span><span class="p">);</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Completion</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">CommandType</span> <span class="o">==</span> <span class="n">DAC960_QueuedCommand</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_V1_KernelCommand_T</span> <span class="o">*</span><span class="n">KernelCommand</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">KernelCommand</span><span class="p">;</span>
      <span class="n">KernelCommand</span><span class="o">-&gt;</span><span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">KernelCommand</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">CommandOpcode</span> <span class="o">==</span> <span class="n">DAC960_V1_DCDB</span><span class="p">)</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DirectCommandActive</span><span class="p">[</span><span class="n">KernelCommand</span><span class="o">-&gt;</span><span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">]</span>
					  <span class="p">[</span><span class="n">KernelCommand</span><span class="o">-&gt;</span><span class="n">DCDB</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span>
	  <span class="nb">false</span><span class="p">;</span>
      <span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="n">KernelCommand</span><span class="o">-&gt;</span><span class="n">CompletionFunction</span><span class="p">(</span><span class="n">KernelCommand</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="cm">/*</span>
<span class="cm">    Queue a Status Monitoring Command to the Controller using the just</span>
<span class="cm">    completed Command if one was deferred previously due to lack of a</span>
<span class="cm">    free Command when the Monitoring Timer Function was called.</span>
<span class="cm">  */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringCommandDeferred</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringCommandDeferred</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="n">DAC960_V1_QueueMonitoringCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="cm">/*</span>
<span class="cm">    Deallocate the Command.</span>
<span class="cm">  */</span>
  <span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="cm">/*</span>
<span class="cm">    Wake up any processes waiting on a free Command.</span>
<span class="cm">  */</span>
  <span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CommandWaitQueue</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_ReadWriteError prints an appropriate error message for Command</span>
<span class="cm">  when an error occurs on a Read or Write operation.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_V2_ReadWriteError</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">SenseErrors</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;NO SENSE&quot;</span><span class="p">,</span> <span class="s">&quot;RECOVERED ERROR&quot;</span><span class="p">,</span>
				   <span class="s">&quot;NOT READY&quot;</span><span class="p">,</span> <span class="s">&quot;MEDIUM ERROR&quot;</span><span class="p">,</span>
				   <span class="s">&quot;HARDWARE ERROR&quot;</span><span class="p">,</span> <span class="s">&quot;ILLEGAL REQUEST&quot;</span><span class="p">,</span>
				   <span class="s">&quot;UNIT ATTENTION&quot;</span><span class="p">,</span> <span class="s">&quot;DATA PROTECT&quot;</span><span class="p">,</span>
				   <span class="s">&quot;BLANK CHECK&quot;</span><span class="p">,</span> <span class="s">&quot;VENDOR-SPECIFIC&quot;</span><span class="p">,</span>
				   <span class="s">&quot;COPY ABORTED&quot;</span><span class="p">,</span> <span class="s">&quot;ABORTED COMMAND&quot;</span><span class="p">,</span>
				   <span class="s">&quot;EQUAL&quot;</span><span class="p">,</span> <span class="s">&quot;VOLUME OVERFLOW&quot;</span><span class="p">,</span>
				   <span class="s">&quot;MISCOMPARE&quot;</span><span class="p">,</span> <span class="s">&quot;RESERVED&quot;</span> <span class="p">};</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">CommandName</span> <span class="o">=</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">DAC960_ReadCommand</span>:
    <span class="k">case</span> <span class="n">DAC960_ReadRetryCommand</span>:
      <span class="n">CommandName</span> <span class="o">=</span> <span class="s">&quot;READ&quot;</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_WriteCommand</span>:
    <span class="k">case</span> <span class="n">DAC960_WriteRetryCommand</span>:
      <span class="n">CommandName</span> <span class="o">=</span> <span class="s">&quot;WRITE&quot;</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_MonitoringCommand</span>:
    <span class="k">case</span> <span class="n">DAC960_ImmediateCommand</span>:
    <span class="k">case</span> <span class="n">DAC960_QueuedCommand</span>:
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;Error Condition %s on %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
	       <span class="n">SenseErrors</span><span class="p">[</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">SenseKey</span><span class="p">],</span> <span class="n">CommandName</span><span class="p">);</span>
  <span class="n">DAC960_Error</span><span class="p">(</span><span class="s">&quot;  /dev/rd/c%dd%d:   absolute blocks %u..%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
	       <span class="n">Command</span><span class="o">-&gt;</span><span class="n">LogicalDriveNumber</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockNumber</span><span class="p">,</span>
	       <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockNumber</span> <span class="o">+</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">BlockCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_ReportEvent prints an appropriate message when a Controller Event</span>
<span class="cm">  occurs.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_V2_ReportEvent</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
				  <span class="n">DAC960_V2_Event_T</span> <span class="o">*</span><span class="n">Event</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_SCSI_RequestSense_T</span> <span class="o">*</span><span class="n">RequestSense</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">DAC960_SCSI_RequestSense_T</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">Event</span><span class="o">-&gt;</span><span class="n">RequestSenseData</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">MessageBuffer</span><span class="p">[</span><span class="n">DAC960_LineBufferSize</span><span class="p">];</span>
  <span class="k">static</span> <span class="k">struct</span> <span class="p">{</span> <span class="kt">int</span> <span class="n">EventCode</span><span class="p">;</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">EventMessage</span><span class="p">;</span> <span class="p">}</span> <span class="n">EventList</span><span class="p">[]</span> <span class="o">=</span>
    <span class="p">{</span> <span class="cm">/* Physical Device Events (0x0000 - 0x007F) */</span>
      <span class="p">{</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="s">&quot;P Online&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="s">&quot;P Standby&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="s">&quot;P Automatic Rebuild Started&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="s">&quot;P Manual Rebuild Started&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0007</span><span class="p">,</span> <span class="s">&quot;P Rebuild Completed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="s">&quot;P Rebuild Cancelled&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="s">&quot;P Rebuild Failed for Unknown Reasons&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x000A</span><span class="p">,</span> <span class="s">&quot;P Rebuild Failed due to New Physical Device&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x000B</span><span class="p">,</span> <span class="s">&quot;P Rebuild Failed due to Logical Drive Failure&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x000C</span><span class="p">,</span> <span class="s">&quot;S Offline&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x000D</span><span class="p">,</span> <span class="s">&quot;P Found&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x000E</span><span class="p">,</span> <span class="s">&quot;P Removed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x000F</span><span class="p">,</span> <span class="s">&quot;P Unconfigured&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="s">&quot;P Expand Capacity Started&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0011</span><span class="p">,</span> <span class="s">&quot;P Expand Capacity Completed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="s">&quot;P Expand Capacity Failed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0013</span><span class="p">,</span> <span class="s">&quot;P Command Timed Out&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="s">&quot;P Command Aborted&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="s">&quot;P Command Retried&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0016</span><span class="p">,</span> <span class="s">&quot;P Parity Error&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0017</span><span class="p">,</span> <span class="s">&quot;P Soft Error&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0018</span><span class="p">,</span> <span class="s">&quot;P Miscellaneous Error&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0019</span><span class="p">,</span> <span class="s">&quot;P Reset&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x001A</span><span class="p">,</span> <span class="s">&quot;P Active Spare Found&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x001B</span><span class="p">,</span> <span class="s">&quot;P Warm Spare Found&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x001C</span><span class="p">,</span> <span class="s">&quot;S Sense Data Received&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x001D</span><span class="p">,</span> <span class="s">&quot;P Initialization Started&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x001E</span><span class="p">,</span> <span class="s">&quot;P Initialization Completed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x001F</span><span class="p">,</span> <span class="s">&quot;P Initialization Failed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="s">&quot;P Initialization Cancelled&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0021</span><span class="p">,</span> <span class="s">&quot;P Failed because Write Recovery Failed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0022</span><span class="p">,</span> <span class="s">&quot;P Failed because SCSI Bus Reset Failed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0023</span><span class="p">,</span> <span class="s">&quot;P Failed because of Double Check Condition&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0024</span><span class="p">,</span> <span class="s">&quot;P Failed because Device Cannot Be Accessed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0025</span><span class="p">,</span> <span class="s">&quot;P Failed because of Gross Error on SCSI Processor&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0026</span><span class="p">,</span> <span class="s">&quot;P Failed because of Bad Tag from Device&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0027</span><span class="p">,</span> <span class="s">&quot;P Failed because of Command Timeout&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0028</span><span class="p">,</span> <span class="s">&quot;P Failed because of System Reset&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0029</span><span class="p">,</span> <span class="s">&quot;P Failed because of Busy Status or Parity Error&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x002A</span><span class="p">,</span> <span class="s">&quot;P Failed because Host Set Device to Failed State&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x002B</span><span class="p">,</span> <span class="s">&quot;P Failed because of Selection Timeout&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x002C</span><span class="p">,</span> <span class="s">&quot;P Failed because of SCSI Bus Phase Error&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x002D</span><span class="p">,</span> <span class="s">&quot;P Failed because Device Returned Unknown Status&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x002E</span><span class="p">,</span> <span class="s">&quot;P Failed because Device Not Ready&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x002F</span><span class="p">,</span> <span class="s">&quot;P Failed because Device Not Found at Startup&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0030</span><span class="p">,</span> <span class="s">&quot;P Failed because COD Write Operation Failed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0031</span><span class="p">,</span> <span class="s">&quot;P Failed because BDT Write Operation Failed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0039</span><span class="p">,</span> <span class="s">&quot;P Missing at Startup&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x003A</span><span class="p">,</span> <span class="s">&quot;P Start Rebuild Failed due to Physical Drive Too Small&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x003C</span><span class="p">,</span> <span class="s">&quot;P Temporarily Offline Device Automatically Made Online&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x003D</span><span class="p">,</span> <span class="s">&quot;P Standby Rebuild Started&quot;</span> <span class="p">},</span>
      <span class="cm">/* Logical Device Events (0x0080 - 0x00FF) */</span>
      <span class="p">{</span> <span class="mh">0x0080</span><span class="p">,</span> <span class="s">&quot;M Consistency Check Started&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0081</span><span class="p">,</span> <span class="s">&quot;M Consistency Check Completed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0082</span><span class="p">,</span> <span class="s">&quot;M Consistency Check Cancelled&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0083</span><span class="p">,</span> <span class="s">&quot;M Consistency Check Completed With Errors&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0084</span><span class="p">,</span> <span class="s">&quot;M Consistency Check Failed due to Logical Drive Failure&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0085</span><span class="p">,</span> <span class="s">&quot;M Consistency Check Failed due to Physical Device Failure&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0086</span><span class="p">,</span> <span class="s">&quot;L Offline&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0087</span><span class="p">,</span> <span class="s">&quot;L Critical&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0088</span><span class="p">,</span> <span class="s">&quot;L Online&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0089</span><span class="p">,</span> <span class="s">&quot;M Automatic Rebuild Started&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x008A</span><span class="p">,</span> <span class="s">&quot;M Manual Rebuild Started&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x008B</span><span class="p">,</span> <span class="s">&quot;M Rebuild Completed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x008C</span><span class="p">,</span> <span class="s">&quot;M Rebuild Cancelled&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x008D</span><span class="p">,</span> <span class="s">&quot;M Rebuild Failed for Unknown Reasons&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x008E</span><span class="p">,</span> <span class="s">&quot;M Rebuild Failed due to New Physical Device&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x008F</span><span class="p">,</span> <span class="s">&quot;M Rebuild Failed due to Logical Drive Failure&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0090</span><span class="p">,</span> <span class="s">&quot;M Initialization Started&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0091</span><span class="p">,</span> <span class="s">&quot;M Initialization Completed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0092</span><span class="p">,</span> <span class="s">&quot;M Initialization Cancelled&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0093</span><span class="p">,</span> <span class="s">&quot;M Initialization Failed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0094</span><span class="p">,</span> <span class="s">&quot;L Found&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0095</span><span class="p">,</span> <span class="s">&quot;L Deleted&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0096</span><span class="p">,</span> <span class="s">&quot;M Expand Capacity Started&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0097</span><span class="p">,</span> <span class="s">&quot;M Expand Capacity Completed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0098</span><span class="p">,</span> <span class="s">&quot;M Expand Capacity Failed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0099</span><span class="p">,</span> <span class="s">&quot;L Bad Block Found&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x009A</span><span class="p">,</span> <span class="s">&quot;L Size Changed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x009B</span><span class="p">,</span> <span class="s">&quot;L Type Changed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x009C</span><span class="p">,</span> <span class="s">&quot;L Bad Data Block Found&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x009E</span><span class="p">,</span> <span class="s">&quot;L Read of Data Block in BDT&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x009F</span><span class="p">,</span> <span class="s">&quot;L Write Back Data for Disk Block Lost&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x00A0</span><span class="p">,</span> <span class="s">&quot;L Temporarily Offline RAID-5/3 Drive Made Online&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x00A1</span><span class="p">,</span> <span class="s">&quot;L Temporarily Offline RAID-6/1/0/7 Drive Made Online&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x00A2</span><span class="p">,</span> <span class="s">&quot;L Standby Rebuild Started&quot;</span> <span class="p">},</span>
      <span class="cm">/* Fault Management Events (0x0100 - 0x017F) */</span>
      <span class="p">{</span> <span class="mh">0x0140</span><span class="p">,</span> <span class="s">&quot;E Fan %d Failed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0141</span><span class="p">,</span> <span class="s">&quot;E Fan %d OK&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0142</span><span class="p">,</span> <span class="s">&quot;E Fan %d Not Present&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0143</span><span class="p">,</span> <span class="s">&quot;E Power Supply %d Failed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0144</span><span class="p">,</span> <span class="s">&quot;E Power Supply %d OK&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0145</span><span class="p">,</span> <span class="s">&quot;E Power Supply %d Not Present&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0146</span><span class="p">,</span> <span class="s">&quot;E Temperature Sensor %d Temperature Exceeds Safe Limit&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0147</span><span class="p">,</span> <span class="s">&quot;E Temperature Sensor %d Temperature Exceeds Working Limit&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0148</span><span class="p">,</span> <span class="s">&quot;E Temperature Sensor %d Temperature Normal&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0149</span><span class="p">,</span> <span class="s">&quot;E Temperature Sensor %d Not Present&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x014A</span><span class="p">,</span> <span class="s">&quot;E Enclosure Management Unit %d Access Critical&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x014B</span><span class="p">,</span> <span class="s">&quot;E Enclosure Management Unit %d Access OK&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x014C</span><span class="p">,</span> <span class="s">&quot;E Enclosure Management Unit %d Access Offline&quot;</span> <span class="p">},</span>
      <span class="cm">/* Controller Events (0x0180 - 0x01FF) */</span>
      <span class="p">{</span> <span class="mh">0x0181</span><span class="p">,</span> <span class="s">&quot;C Cache Write Back Error&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0188</span><span class="p">,</span> <span class="s">&quot;C Battery Backup Unit Found&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0189</span><span class="p">,</span> <span class="s">&quot;C Battery Backup Unit Charge Level Low&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x018A</span><span class="p">,</span> <span class="s">&quot;C Battery Backup Unit Charge Level OK&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0193</span><span class="p">,</span> <span class="s">&quot;C Installation Aborted&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0195</span><span class="p">,</span> <span class="s">&quot;C Battery Backup Unit Physically Removed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0196</span><span class="p">,</span> <span class="s">&quot;C Memory Error During Warm Boot&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x019E</span><span class="p">,</span> <span class="s">&quot;C Memory Soft ECC Error Corrected&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x019F</span><span class="p">,</span> <span class="s">&quot;C Memory Hard ECC Error Corrected&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x01A2</span><span class="p">,</span> <span class="s">&quot;C Battery Backup Unit Failed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x01AB</span><span class="p">,</span> <span class="s">&quot;C Mirror Race Recovery Failed&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x01AC</span><span class="p">,</span> <span class="s">&quot;C Mirror Race on Critical Drive&quot;</span> <span class="p">},</span>
      <span class="cm">/* Controller Internal Processor Events */</span>
      <span class="p">{</span> <span class="mh">0x0380</span><span class="p">,</span> <span class="s">&quot;C Internal Controller Hung&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0381</span><span class="p">,</span> <span class="s">&quot;C Internal Controller Firmware Breakpoint&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x0390</span><span class="p">,</span> <span class="s">&quot;C Internal Controller i960 Processor Specific Error&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mh">0x03A0</span><span class="p">,</span> <span class="s">&quot;C Internal Controller StrongARM Processor Specific Error&quot;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">}</span> <span class="p">};</span>
  <span class="kt">int</span> <span class="n">EventListIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EventCode</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">EventType</span><span class="p">,</span> <span class="o">*</span><span class="n">EventMessage</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Event</span><span class="o">-&gt;</span><span class="n">EventCode</span> <span class="o">==</span> <span class="mh">0x1C</span> <span class="o">&amp;&amp;</span>
      <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">SenseKey</span> <span class="o">==</span> <span class="n">DAC960_SenseKey_VendorSpecific</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCode</span> <span class="o">==</span> <span class="mh">0x80</span> <span class="o">||</span>
       <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCode</span> <span class="o">==</span> <span class="mh">0x81</span><span class="p">))</span>
    <span class="n">Event</span><span class="o">-&gt;</span><span class="n">EventCode</span> <span class="o">=</span> <span class="p">((</span><span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCode</span> <span class="o">-</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCodeQualifier</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">EventCode</span> <span class="o">=</span> <span class="n">EventList</span><span class="p">[</span><span class="n">EventListIndex</span><span class="p">].</span><span class="n">EventCode</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">EventCode</span> <span class="o">==</span> <span class="n">Event</span><span class="o">-&gt;</span><span class="n">EventCode</span> <span class="o">||</span> <span class="n">EventCode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="n">EventListIndex</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">EventType</span> <span class="o">=</span> <span class="n">EventList</span><span class="p">[</span><span class="n">EventListIndex</span><span class="p">].</span><span class="n">EventMessage</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">EventMessage</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">EventList</span><span class="p">[</span><span class="n">EventListIndex</span><span class="p">].</span><span class="n">EventMessage</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">EventCode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Unknown Controller Event Code %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">Controller</span><span class="p">,</span> <span class="n">Event</span><span class="o">-&gt;</span><span class="n">EventCode</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">EventType</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="sc">&#39;P&#39;</span>:
      <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		      <span class="n">Event</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span> <span class="n">Event</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span> <span class="n">EventMessage</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="sc">&#39;L&#39;</span>:
      <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Logical Drive %d (/dev/rd/c%dd%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		      <span class="n">Event</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
		      <span class="n">Event</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span><span class="p">,</span> <span class="n">EventMessage</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="sc">&#39;M&#39;</span>:
      <span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Logical Drive %d (/dev/rd/c%dd%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		      <span class="n">Event</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
		      <span class="n">Event</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span><span class="p">,</span> <span class="n">EventMessage</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="sc">&#39;S&#39;</span>:
      <span class="k">if</span> <span class="p">(</span><span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">SenseKey</span> <span class="o">==</span> <span class="n">DAC960_SenseKey_NoSense</span> <span class="o">||</span>
	  <span class="p">(</span><span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">SenseKey</span> <span class="o">==</span> <span class="n">DAC960_SenseKey_NotReady</span> <span class="o">&amp;&amp;</span>
	   <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCode</span> <span class="o">==</span> <span class="mh">0x04</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCodeQualifier</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="o">||</span>
	    <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCodeQualifier</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)))</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		      <span class="n">Event</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span> <span class="n">Event</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span> <span class="n">EventMessage</span><span class="p">);</span>
      <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d Request Sense: &quot;</span>
		      <span class="s">&quot;Sense Key = %X, ASC = %02X, ASCQ = %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">Controller</span><span class="p">,</span>
		      <span class="n">Event</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span>
		      <span class="n">Event</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span>
		      <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">SenseKey</span><span class="p">,</span>
		      <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCode</span><span class="p">,</span>
		      <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">AdditionalSenseCodeQualifier</span><span class="p">);</span>
      <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d Request Sense: &quot;</span>
		      <span class="s">&quot;Information = %02X%02X%02X%02X &quot;</span>
		      <span class="s">&quot;%02X%02X%02X%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">Controller</span><span class="p">,</span>
		      <span class="n">Event</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span>
		      <span class="n">Event</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span>
		      <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">Information</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		      <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">Information</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		      <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">Information</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		      <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">Information</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		      <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">CommandSpecificInformation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		      <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">CommandSpecificInformation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		      <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">CommandSpecificInformation</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		      <span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">CommandSpecificInformation</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="sc">&#39;E&#39;</span>:
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">SuppressEnclosureMessages</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="n">sprintf</span><span class="p">(</span><span class="n">MessageBuffer</span><span class="p">,</span> <span class="n">EventMessage</span><span class="p">,</span> <span class="n">Event</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span><span class="p">);</span>
      <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Enclosure %d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		      <span class="n">Event</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span> <span class="n">MessageBuffer</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="sc">&#39;C&#39;</span>:
      <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Controller %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">EventMessage</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Unknown Controller Event Code %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">Controller</span><span class="p">,</span> <span class="n">Event</span><span class="o">-&gt;</span><span class="n">EventCode</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_ReportProgress prints an appropriate progress message for</span>
<span class="cm">  Logical Device Long Operations.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_V2_ReportProgress</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">MessageString</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">LogicalDeviceNumber</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">BlocksCompleted</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">LogicalDeviceSize</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">EphemeralProgressMessage</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;%s in Progress: Logical Drive %d (/dev/rd/c%dd%d) &quot;</span>
		  <span class="s">&quot;%d%% completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		  <span class="n">MessageString</span><span class="p">,</span>
		  <span class="n">LogicalDeviceNumber</span><span class="p">,</span>
		  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
		  <span class="n">LogicalDeviceNumber</span><span class="p">,</span>
		  <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">BlocksCompleted</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">LogicalDeviceSize</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">));</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">EphemeralProgressMessage</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_ProcessCompletedCommand performs completion processing for Command</span>
<span class="cm">  for DAC960 V2 Firmware Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_V2_ProcessCompletedCommand</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="n">DAC960_CommandType_T</span> <span class="n">CommandType</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V2_IOCTL_Opcode_T</span> <span class="n">IOCTLOpcode</span> <span class="o">=</span> <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">IOCTL_Opcode</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandOpcode_T</span> <span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SCSI_10</span><span class="p">.</span><span class="n">CommandOpcode</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandStatus_T</span> <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">CommandType</span> <span class="o">==</span> <span class="n">DAC960_ReadCommand</span> <span class="o">||</span>
      <span class="n">CommandType</span> <span class="o">==</span> <span class="n">DAC960_WriteCommand</span><span class="p">)</span>
    <span class="p">{</span>

<span class="cp">#ifdef FORCE_RETRY_DEBUG</span>
      <span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">DAC960_V2_AbormalCompletion</span><span class="p">;</span>
<span class="cp">#endif</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">SenseKey</span> <span class="o">=</span> <span class="n">DAC960_SenseKey_MediumError</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_ProcessCompletedRequest</span><span class="p">(</span><span class="n">Command</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="n">BUG</span><span class="p">();</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">SenseKey</span> <span class="o">==</span> <span class="n">DAC960_SenseKey_MediumError</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="cm">/*</span>
<span class="cm">	   * break the command down into pieces and resubmit each</span>
<span class="cm">	   * piece, hoping that some of them will succeed.</span>
<span class="cm">	   */</span>
	   <span class="n">DAC960_queue_partial_rw</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	   <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">else</span>
	<span class="p">{</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">SenseKey</span> <span class="o">!=</span> <span class="n">DAC960_SenseKey_NotReady</span><span class="p">)</span>
	    <span class="n">DAC960_V2_ReadWriteError</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	  <span class="cm">/*</span>
<span class="cm">	    Perform completion processing for all buffers in this I/O Request.</span>
<span class="cm">	  */</span>
          <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">DAC960_ProcessCompletedRequest</span><span class="p">(</span><span class="n">Command</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CommandType</span> <span class="o">==</span> <span class="n">DAC960_ReadRetryCommand</span> <span class="o">||</span>
	   <span class="n">CommandType</span> <span class="o">==</span> <span class="n">DAC960_WriteRetryCommand</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">bool</span> <span class="n">normal_completion</span><span class="p">;</span>

<span class="cp">#ifdef FORCE_RETRY_FAILURE_DEBUG</span>
      <span class="k">static</span> <span class="kt">int</span> <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
      <span class="cm">/*</span>
<span class="cm">        Perform completion processing for the portion that was</span>
<span class="cm">	retried, and submit the next portion, if any.</span>
<span class="cm">      */</span>
      <span class="n">normal_completion</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">!=</span> <span class="n">DAC960_V2_NormalCompletion</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">normal_completion</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSense</span><span class="o">-&gt;</span><span class="n">SenseKey</span> <span class="o">!=</span> <span class="n">DAC960_SenseKey_NotReady</span><span class="p">)</span>
	    <span class="n">DAC960_V2_ReadWriteError</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="p">}</span>

<span class="cp">#ifdef FORCE_RETRY_FAILURE_DEBUG</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">++</span><span class="n">retry_count</span> <span class="o">%</span> <span class="mi">10000</span><span class="p">))</span> <span class="p">{</span>
	      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;V2 error retry failure test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	      <span class="n">normal_completion</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	      <span class="n">DAC960_V2_ReadWriteError</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="p">}</span>
<span class="cp">#endif</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DAC960_ProcessCompletedRequest</span><span class="p">(</span><span class="n">Command</span><span class="p">,</span> <span class="n">normal_completion</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DAC960_queue_partial_rw</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
        	<span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CommandType</span> <span class="o">==</span> <span class="n">DAC960_MonitoringCommand</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ShutdownMonitoringTimer</span><span class="p">)</span>
	      <span class="k">return</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">IOCTLOpcode</span> <span class="o">==</span> <span class="n">DAC960_V2_GetControllerInfo</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">DAC960_V2_ControllerInfo_T</span> <span class="o">*</span><span class="n">NewControllerInfo</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewControllerInformation</span><span class="p">;</span>
	  <span class="n">DAC960_V2_ControllerInfo_T</span> <span class="o">*</span><span class="n">ControllerInfo</span> <span class="o">=</span>
	    <span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">ControllerInformation</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LogicalDriveCount</span> <span class="o">=</span>
	    <span class="n">NewControllerInfo</span><span class="o">-&gt;</span><span class="n">LogicalDevicesPresent</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NeedLogicalDeviceInformation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NeedPhysicalDeviceInformation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">StartLogicalDeviceInformationScan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">StartPhysicalDeviceInformationScan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringAlertMode</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">NewControllerInfo</span><span class="o">-&gt;</span><span class="n">LogicalDevicesCritical</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	     <span class="n">NewControllerInfo</span><span class="o">-&gt;</span><span class="n">LogicalDevicesOffline</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	     <span class="n">NewControllerInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDisksCritical</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	     <span class="n">NewControllerInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDisksOffline</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	  <span class="n">memcpy</span><span class="p">(</span><span class="n">ControllerInfo</span><span class="p">,</span> <span class="n">NewControllerInfo</span><span class="p">,</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_ControllerInfo_T</span><span class="p">));</span>
	<span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IOCTLOpcode</span> <span class="o">==</span> <span class="n">DAC960_V2_GetEvent</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">DAC960_V2_ReportEvent</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">Event</span><span class="p">);</span>
	  <span class="p">}</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextEventSequenceNumber</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IOCTLOpcode</span> <span class="o">==</span> <span class="n">DAC960_V2_GetPhysicalDeviceInfoValid</span> <span class="o">&amp;&amp;</span>
	       <span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">DAC960_V2_PhysicalDeviceInfo_T</span> <span class="o">*</span><span class="n">NewPhysicalDeviceInfo</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewPhysicalDeviceInformation</span><span class="p">;</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">PhysicalDeviceIndex</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceIndex</span><span class="p">;</span>
	  <span class="n">DAC960_V2_PhysicalDeviceInfo_T</span> <span class="o">*</span><span class="n">PhysicalDeviceInfo</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceInformation</span><span class="p">[</span><span class="n">PhysicalDeviceIndex</span><span class="p">];</span>
	  <span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span> <span class="o">*</span><span class="n">InquiryUnitSerialNumber</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span><span class="p">[</span><span class="n">PhysicalDeviceIndex</span><span class="p">];</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DeviceIndex</span><span class="p">;</span>
	  <span class="k">while</span> <span class="p">(</span><span class="n">PhysicalDeviceInfo</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span> <span class="o">&gt;</span>
		  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span> <span class="o">==</span>
		   <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">&gt;</span>
		    <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">==</span>
		    <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">&amp;&amp;</span>
		    <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span> <span class="o">&gt;</span>
		    <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span><span class="p">)))))</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d No Longer Exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">,</span>
			      <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span>
			      <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">);</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceInformation</span>
			     <span class="p">[</span><span class="n">PhysicalDeviceIndex</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span>
			     <span class="p">[</span><span class="n">PhysicalDeviceIndex</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	      <span class="n">kfree</span><span class="p">(</span><span class="n">PhysicalDeviceInfo</span><span class="p">);</span>
	      <span class="n">kfree</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="p">);</span>
	      <span class="k">for</span> <span class="p">(</span><span class="n">DeviceIndex</span> <span class="o">=</span> <span class="n">PhysicalDeviceIndex</span><span class="p">;</span>
		   <span class="n">DeviceIndex</span> <span class="o">&lt;</span> <span class="n">DAC960_V2_MaxPhysicalDevices</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		   <span class="n">DeviceIndex</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
		  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceInformation</span><span class="p">[</span><span class="n">DeviceIndex</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceInformation</span><span class="p">[</span><span class="n">DeviceIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
		  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span><span class="p">[</span><span class="n">DeviceIndex</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span><span class="p">[</span><span class="n">DeviceIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceInformation</span>
			     <span class="p">[</span><span class="n">DAC960_V2_MaxPhysicalDevices</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span>
			     <span class="p">[</span><span class="n">DAC960_V2_MaxPhysicalDevices</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	      <span class="n">PhysicalDeviceInfo</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceInformation</span><span class="p">[</span><span class="n">PhysicalDeviceIndex</span><span class="p">];</span>
	      <span class="n">InquiryUnitSerialNumber</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span><span class="p">[</span><span class="n">PhysicalDeviceIndex</span><span class="p">];</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">PhysicalDeviceInfo</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span> <span class="o">!=</span>
	       <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">!=</span>
	       <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span> <span class="o">!=</span>
	       <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="n">PhysicalDeviceInfo</span> <span class="o">=</span>
		<span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_PhysicalDeviceInfo_T</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	      <span class="n">InquiryUnitSerialNumber</span> <span class="o">=</span>
		  <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">),</span>
			  <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">InquiryUnitSerialNumber</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		  <span class="n">PhysicalDeviceInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="p">{</span>
		  <span class="n">kfree</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="p">);</span>
		  <span class="n">InquiryUnitSerialNumber</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		  <span class="n">kfree</span><span class="p">(</span><span class="n">PhysicalDeviceInfo</span><span class="p">);</span>
		  <span class="n">PhysicalDeviceInfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	      <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d Now Exists%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">,</span>
			      <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span>
			      <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">PhysicalDeviceInfo</span> <span class="o">!=</span> <span class="nb">NULL</span>
			       <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; - Allocation Failed&quot;</span><span class="p">));</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">PhysicalDeviceInfo</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="p">{</span>
		  <span class="n">memset</span><span class="p">(</span><span class="n">PhysicalDeviceInfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_PhysicalDeviceInfo_T</span><span class="p">));</span>
		  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span> <span class="o">=</span>
		    <span class="n">DAC960_V2_Device_InvalidState</span><span class="p">;</span>
		  <span class="n">memset</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">));</span>
		  <span class="n">InquiryUnitSerialNumber</span><span class="o">-&gt;</span><span class="n">PeripheralDeviceType</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
		  <span class="k">for</span> <span class="p">(</span><span class="n">DeviceIndex</span> <span class="o">=</span> <span class="n">DAC960_V2_MaxPhysicalDevices</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		       <span class="n">DeviceIndex</span> <span class="o">&gt;</span> <span class="n">PhysicalDeviceIndex</span><span class="p">;</span>
		       <span class="n">DeviceIndex</span><span class="o">--</span><span class="p">)</span>
		    <span class="p">{</span>
		      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceInformation</span><span class="p">[</span><span class="n">DeviceIndex</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceInformation</span><span class="p">[</span><span class="n">DeviceIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
		      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span><span class="p">[</span><span class="n">DeviceIndex</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span><span class="p">[</span><span class="n">DeviceIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
		    <span class="p">}</span>
		  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceInformation</span>
				 <span class="p">[</span><span class="n">PhysicalDeviceIndex</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">PhysicalDeviceInfo</span><span class="p">;</span>
		  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span>
				 <span class="p">[</span><span class="n">PhysicalDeviceIndex</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">InquiryUnitSerialNumber</span><span class="p">;</span>
		  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NeedDeviceSerialNumberInformation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">PhysicalDeviceInfo</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span> <span class="o">!=</span>
		  <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span><span class="p">)</span>
		<span class="n">DAC960_Critical</span><span class="p">(</span>
		  <span class="s">&quot;Physical Device %d:%d is now %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
		  <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span>
		  <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
		   <span class="o">==</span> <span class="n">DAC960_V2_Device_Online</span>
		   <span class="o">?</span> <span class="s">&quot;ONLINE&quot;</span>
		   <span class="o">:</span> <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
		     <span class="o">==</span> <span class="n">DAC960_V2_Device_Rebuild</span>
		     <span class="o">?</span> <span class="s">&quot;REBUILD&quot;</span>
		     <span class="o">:</span> <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
		       <span class="o">==</span> <span class="n">DAC960_V2_Device_Missing</span>
		       <span class="o">?</span> <span class="s">&quot;MISSING&quot;</span>
		       <span class="o">:</span> <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
			 <span class="o">==</span> <span class="n">DAC960_V2_Device_Critical</span>
			 <span class="o">?</span> <span class="s">&quot;CRITICAL&quot;</span>
			 <span class="o">:</span> <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
			   <span class="o">==</span> <span class="n">DAC960_V2_Device_Dead</span>
			   <span class="o">?</span> <span class="s">&quot;DEAD&quot;</span>
			   <span class="o">:</span> <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
			     <span class="o">==</span> <span class="n">DAC960_V2_Device_SuspectedDead</span>
			     <span class="o">?</span> <span class="s">&quot;SUSPECTED-DEAD&quot;</span>
			     <span class="o">:</span> <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
			       <span class="o">==</span> <span class="n">DAC960_V2_Device_CommandedOffline</span>
			       <span class="o">?</span> <span class="s">&quot;COMMANDED-OFFLINE&quot;</span>
			       <span class="o">:</span> <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
				 <span class="o">==</span> <span class="n">DAC960_V2_Device_Standby</span>
				 <span class="o">?</span> <span class="s">&quot;STANDBY&quot;</span> <span class="o">:</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">));</span>
	      <span class="k">if</span> <span class="p">((</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">ParityErrors</span> <span class="o">!=</span>
		   <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">ParityErrors</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">SoftErrors</span> <span class="o">!=</span>
		   <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">SoftErrors</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">HardErrors</span> <span class="o">!=</span>
		   <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">HardErrors</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">MiscellaneousErrors</span> <span class="o">!=</span>
		   <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">MiscellaneousErrors</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">CommandTimeouts</span> <span class="o">!=</span>
		   <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">CommandTimeouts</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Retries</span> <span class="o">!=</span>
		   <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Retries</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Aborts</span> <span class="o">!=</span>
		   <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Aborts</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PredictedFailuresDetected</span> <span class="o">!=</span>
		   <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PredictedFailuresDetected</span><span class="p">))</span>
		<span class="p">{</span>
		  <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d Errors: &quot;</span>
				  <span class="s">&quot;Parity = %d, Soft = %d, &quot;</span>
				  <span class="s">&quot;Hard = %d, Misc = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">Controller</span><span class="p">,</span>
				  <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span>
				  <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span>
				  <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">ParityErrors</span><span class="p">,</span>
				  <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">SoftErrors</span><span class="p">,</span>
				  <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">HardErrors</span><span class="p">,</span>
				  <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">MiscellaneousErrors</span><span class="p">);</span>
		  <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d Errors: &quot;</span>
				  <span class="s">&quot;Timeouts = %d, Retries = %d, &quot;</span>
				  <span class="s">&quot;Aborts = %d, Predicted = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">Controller</span><span class="p">,</span>
				  <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span>
				  <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span>
				  <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">CommandTimeouts</span><span class="p">,</span>
				  <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Retries</span><span class="p">,</span>
				  <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Aborts</span><span class="p">,</span>
				  <span class="n">NewPhysicalDeviceInfo</span>
				  <span class="o">-&gt;</span><span class="n">PredictedFailuresDetected</span><span class="p">);</span>
		<span class="p">}</span>
	      <span class="k">if</span> <span class="p">((</span><span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
		   <span class="o">==</span> <span class="n">DAC960_V2_Device_Dead</span> <span class="o">||</span>
		   <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
		   <span class="o">==</span> <span class="n">DAC960_V2_Device_InvalidState</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceState</span>
		  <span class="o">!=</span> <span class="n">DAC960_V2_Device_Dead</span><span class="p">)</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NeedDeviceSerialNumberInformation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	      <span class="n">memcpy</span><span class="p">(</span><span class="n">PhysicalDeviceInfo</span><span class="p">,</span> <span class="n">NewPhysicalDeviceInfo</span><span class="p">,</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_PhysicalDeviceInfo_T</span><span class="p">));</span>
	    <span class="p">}</span>
	  <span class="n">NewPhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span><span class="o">++</span><span class="p">;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceIndex</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IOCTLOpcode</span> <span class="o">==</span> <span class="n">DAC960_V2_GetPhysicalDeviceInfoValid</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DeviceIndex</span><span class="p">;</span>
	  <span class="k">for</span> <span class="p">(</span><span class="n">DeviceIndex</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceIndex</span><span class="p">;</span>
	       <span class="n">DeviceIndex</span> <span class="o">&lt;</span> <span class="n">DAC960_V2_MaxPhysicalDevices</span><span class="p">;</span>
	       <span class="n">DeviceIndex</span><span class="o">++</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_V2_PhysicalDeviceInfo_T</span> <span class="o">*</span><span class="n">PhysicalDeviceInfo</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceInformation</span><span class="p">[</span><span class="n">DeviceIndex</span><span class="p">];</span>
	      <span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span> <span class="o">*</span><span class="n">InquiryUnitSerialNumber</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span><span class="p">[</span><span class="n">DeviceIndex</span><span class="p">];</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">PhysicalDeviceInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
	      <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Physical Device %d:%d No Longer Exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">,</span>
			      <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span>
			      <span class="n">PhysicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">);</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceInformation</span><span class="p">[</span><span class="n">DeviceIndex</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span><span class="p">[</span><span class="n">DeviceIndex</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	      <span class="n">kfree</span><span class="p">(</span><span class="n">PhysicalDeviceInfo</span><span class="p">);</span>
	      <span class="n">kfree</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NeedPhysicalDeviceInformation</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IOCTLOpcode</span> <span class="o">==</span> <span class="n">DAC960_V2_GetLogicalDeviceInfoValid</span> <span class="o">&amp;&amp;</span>
	       <span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">DAC960_V2_LogicalDeviceInfo_T</span> <span class="o">*</span><span class="n">NewLogicalDeviceInfo</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewLogicalDeviceInformation</span><span class="p">;</span>
	  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">LogicalDeviceNumber</span> <span class="o">=</span>
	    <span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceNumber</span><span class="p">;</span>
	  <span class="n">DAC960_V2_LogicalDeviceInfo_T</span> <span class="o">*</span><span class="n">LogicalDeviceInfo</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDeviceInformation</span><span class="p">[</span><span class="n">LogicalDeviceNumber</span><span class="p">];</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_V2_PhysicalDevice_T</span> <span class="n">PhysicalDevice</span><span class="p">;</span>
	      <span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">Controller</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	      <span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">Channel</span> <span class="o">=</span> <span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">;</span>
	      <span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">;</span>
	      <span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">LogicalUnit</span> <span class="o">=</span> <span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDriveToVirtualDevice</span><span class="p">[</span><span class="n">LogicalDeviceNumber</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">PhysicalDevice</span><span class="p">;</span>
	      <span class="n">LogicalDeviceInfo</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_LogicalDeviceInfo_T</span><span class="p">),</span>
					  <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDeviceInformation</span><span class="p">[</span><span class="n">LogicalDeviceNumber</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">LogicalDeviceInfo</span><span class="p">;</span>
	      <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Logical Drive %d (/dev/rd/c%dd%d) &quot;</span>
			      <span class="s">&quot;Now Exists%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			      <span class="n">LogicalDeviceNumber</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
			      <span class="n">LogicalDeviceNumber</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">LogicalDeviceInfo</span> <span class="o">!=</span> <span class="nb">NULL</span>
			       <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; - Allocation Failed&quot;</span><span class="p">));</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="p">{</span>
		  <span class="n">memset</span><span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_LogicalDeviceInfo_T</span><span class="p">));</span>
		  <span class="n">DAC960_ComputeGenericDiskInfo</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">LogicalDeviceSize</span> <span class="o">=</span>
		<span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">ConfigurableDeviceSize</span><span class="p">;</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceState</span> <span class="o">!=</span>
		  <span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceState</span><span class="p">)</span>
		<span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Logical Drive %d (/dev/rd/c%dd%d) &quot;</span>
				<span class="s">&quot;is now %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
				<span class="n">LogicalDeviceNumber</span><span class="p">,</span>
				<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
				<span class="n">LogicalDeviceNumber</span><span class="p">,</span>
				<span class="p">(</span><span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceState</span>
				 <span class="o">==</span> <span class="n">DAC960_V2_LogicalDevice_Online</span>
				 <span class="o">?</span> <span class="s">&quot;ONLINE&quot;</span>
				 <span class="o">:</span> <span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceState</span>
				   <span class="o">==</span> <span class="n">DAC960_V2_LogicalDevice_Critical</span>
				   <span class="o">?</span> <span class="s">&quot;CRITICAL&quot;</span> <span class="o">:</span> <span class="s">&quot;OFFLINE&quot;</span><span class="p">));</span>
	      <span class="k">if</span> <span class="p">((</span><span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">SoftErrors</span> <span class="o">!=</span>
		   <span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">SoftErrors</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">CommandsFailed</span> <span class="o">!=</span>
		   <span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">CommandsFailed</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">DeferredWriteErrors</span> <span class="o">!=</span>
		   <span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">DeferredWriteErrors</span><span class="p">))</span>
		<span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Logical Drive %d (/dev/rd/c%dd%d) Errors: &quot;</span>
				<span class="s">&quot;Soft = %d, Failed = %d, Deferred Write = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">Controller</span><span class="p">,</span> <span class="n">LogicalDeviceNumber</span><span class="p">,</span>
				<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
				<span class="n">LogicalDeviceNumber</span><span class="p">,</span>
				<span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">SoftErrors</span><span class="p">,</span>
				<span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">CommandsFailed</span><span class="p">,</span>
				<span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">DeferredWriteErrors</span><span class="p">);</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">ConsistencyCheckInProgress</span><span class="p">)</span>
		<span class="n">DAC960_V2_ReportProgress</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span>
					 <span class="s">&quot;Consistency Check&quot;</span><span class="p">,</span>
					 <span class="n">LogicalDeviceNumber</span><span class="p">,</span>
					 <span class="n">NewLogicalDeviceInfo</span>
					 <span class="o">-&gt;</span><span class="n">ConsistencyCheckBlockNumber</span><span class="p">,</span>
					 <span class="n">LogicalDeviceSize</span><span class="p">);</span>
	      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">RebuildInProgress</span><span class="p">)</span>
		<span class="n">DAC960_V2_ReportProgress</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span>
					 <span class="s">&quot;Rebuild&quot;</span><span class="p">,</span>
					 <span class="n">LogicalDeviceNumber</span><span class="p">,</span>
					 <span class="n">NewLogicalDeviceInfo</span>
					 <span class="o">-&gt;</span><span class="n">RebuildBlockNumber</span><span class="p">,</span>
					 <span class="n">LogicalDeviceSize</span><span class="p">);</span>
	      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">BackgroundInitializationInProgress</span><span class="p">)</span>
		<span class="n">DAC960_V2_ReportProgress</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span>
					 <span class="s">&quot;Background Initialization&quot;</span><span class="p">,</span>
					 <span class="n">LogicalDeviceNumber</span><span class="p">,</span>
					 <span class="n">NewLogicalDeviceInfo</span>
					 <span class="o">-&gt;</span><span class="n">BackgroundInitializationBlockNumber</span><span class="p">,</span>
					 <span class="n">LogicalDeviceSize</span><span class="p">);</span>
	      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">ForegroundInitializationInProgress</span><span class="p">)</span>
		<span class="n">DAC960_V2_ReportProgress</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span>
					 <span class="s">&quot;Foreground Initialization&quot;</span><span class="p">,</span>
					 <span class="n">LogicalDeviceNumber</span><span class="p">,</span>
					 <span class="n">NewLogicalDeviceInfo</span>
					 <span class="o">-&gt;</span><span class="n">ForegroundInitializationBlockNumber</span><span class="p">,</span>
					 <span class="n">LogicalDeviceSize</span><span class="p">);</span>
	      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">DataMigrationInProgress</span><span class="p">)</span>
		<span class="n">DAC960_V2_ReportProgress</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span>
					 <span class="s">&quot;Data Migration&quot;</span><span class="p">,</span>
					 <span class="n">LogicalDeviceNumber</span><span class="p">,</span>
					 <span class="n">NewLogicalDeviceInfo</span>
					 <span class="o">-&gt;</span><span class="n">DataMigrationBlockNumber</span><span class="p">,</span>
					 <span class="n">LogicalDeviceSize</span><span class="p">);</span>
	      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">PatrolOperationInProgress</span><span class="p">)</span>
		<span class="n">DAC960_V2_ReportProgress</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span>
					 <span class="s">&quot;Patrol Operation&quot;</span><span class="p">,</span>
					 <span class="n">LogicalDeviceNumber</span><span class="p">,</span>
					 <span class="n">NewLogicalDeviceInfo</span>
					 <span class="o">-&gt;</span><span class="n">PatrolOperationBlockNumber</span><span class="p">,</span>
					 <span class="n">LogicalDeviceSize</span><span class="p">);</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">BackgroundInitializationInProgress</span> <span class="o">&amp;&amp;</span>
		  <span class="o">!</span><span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">BackgroundInitializationInProgress</span><span class="p">)</span>
		<span class="n">DAC960_Progress</span><span class="p">(</span><span class="s">&quot;Logical Drive %d (/dev/rd/c%dd%d) &quot;</span>
				<span class="s">&quot;Background Initialization %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">Controller</span><span class="p">,</span>
				<span class="n">LogicalDeviceNumber</span><span class="p">,</span>
				<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
				<span class="n">LogicalDeviceNumber</span><span class="p">,</span>
				<span class="p">(</span><span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceControl</span>
						      <span class="p">.</span><span class="n">LogicalDeviceInitialized</span>
				 <span class="o">?</span> <span class="s">&quot;Completed&quot;</span> <span class="o">:</span> <span class="s">&quot;Failed&quot;</span><span class="p">));</span>
	      <span class="n">memcpy</span><span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="p">,</span> <span class="n">NewLogicalDeviceInfo</span><span class="p">,</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_LogicalDeviceInfo_T</span><span class="p">));</span>
	    <span class="p">}</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDriveFoundDuringScan</span>
			 <span class="p">[</span><span class="n">LogicalDeviceNumber</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	  <span class="n">NewLogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceNumber</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IOCTLOpcode</span> <span class="o">==</span> <span class="n">DAC960_V2_GetLogicalDeviceInfoValid</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="kt">int</span> <span class="n">LogicalDriveNumber</span><span class="p">;</span>
	  <span class="k">for</span> <span class="p">(</span><span class="n">LogicalDriveNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	       <span class="n">LogicalDriveNumber</span> <span class="o">&lt;</span> <span class="n">DAC960_MaxLogicalDrives</span><span class="p">;</span>
	       <span class="n">LogicalDriveNumber</span><span class="o">++</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_V2_LogicalDeviceInfo_T</span> <span class="o">*</span><span class="n">LogicalDeviceInfo</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDeviceInformation</span><span class="p">[</span><span class="n">LogicalDriveNumber</span><span class="p">];</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDriveFoundDuringScan</span>
				 <span class="p">[</span><span class="n">LogicalDriveNumber</span><span class="p">])</span>
		<span class="k">continue</span><span class="p">;</span>
	      <span class="n">DAC960_Critical</span><span class="p">(</span><span class="s">&quot;Logical Drive %d (/dev/rd/c%dd%d) &quot;</span>
			      <span class="s">&quot;No Longer Exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			      <span class="n">LogicalDriveNumber</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
			      <span class="n">LogicalDriveNumber</span><span class="p">);</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDeviceInformation</span>
			     <span class="p">[</span><span class="n">LogicalDriveNumber</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	      <span class="n">kfree</span><span class="p">(</span><span class="n">LogicalDeviceInfo</span><span class="p">);</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LogicalDriveInitiallyAccessible</span>
			  <span class="p">[</span><span class="n">LogicalDriveNumber</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	      <span class="n">DAC960_ComputeGenericDiskInfo</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NeedLogicalDeviceInformation</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CommandOpcode</span> <span class="o">==</span> <span class="n">DAC960_V2_SCSI_10_Passthru</span><span class="p">)</span>
        <span class="p">{</span>
	    <span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span> <span class="o">*</span><span class="n">InquiryUnitSerialNumber</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">InquiryUnitSerialNumber</span><span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">CommandStatus</span> <span class="o">!=</span> <span class="n">DAC960_V2_NormalCompletion</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">));</span>
		<span class="n">InquiryUnitSerialNumber</span><span class="o">-&gt;</span><span class="n">PeripheralDeviceType</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span>
	  	<span class="n">memcpy</span><span class="p">(</span><span class="n">InquiryUnitSerialNumber</span><span class="p">,</span>
			<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewInquiryUnitSerialNumber</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span><span class="p">));</span>

	     <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NeedDeviceSerialNumberInformation</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">HealthStatusBuffer</span><span class="o">-&gt;</span><span class="n">NextEventSequenceNumber</span>
	  <span class="o">-</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextEventSequenceNumber</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">GetEvent</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V2_IOCTL</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">GetEvent</span><span class="p">.</span><span class="n">DataTransferSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_Event_T</span><span class="p">);</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">GetEvent</span><span class="p">.</span><span class="n">EventSequenceNumberHigh16</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextEventSequenceNumber</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">GetEvent</span><span class="p">.</span><span class="n">ControllerNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">GetEvent</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_GetEvent</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">GetEvent</span><span class="p">.</span><span class="n">EventSequenceNumberLow16</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextEventSequenceNumber</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">GetEvent</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
				  <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				  <span class="p">.</span><span class="n">SegmentDataPointer</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">EventDMA</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">GetEvent</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
				  <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				  <span class="p">.</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
	    <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">GetEvent</span><span class="p">.</span><span class="n">DataTransferSize</span><span class="p">;</span>
	  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NeedPhysicalDeviceInformation</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NeedDeviceSerialNumberInformation</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_SCSI_Inquiry_UnitSerialNumber_T</span> <span class="o">*</span><span class="n">InquiryUnitSerialNumber</span> <span class="o">=</span>
                <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewInquiryUnitSerialNumber</span><span class="p">;</span>
	      <span class="n">InquiryUnitSerialNumber</span><span class="o">-&gt;</span><span class="n">PeripheralDeviceType</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>

	      <span class="n">DAC960_V2_ConstructNewUnitSerialNumber</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">CommandMailbox</span><span class="p">,</span>
			<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewPhysicalDeviceInformation</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">,</span>
			<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewPhysicalDeviceInformation</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewPhysicalDeviceInformation</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>


	      <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	      <span class="k">return</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">StartPhysicalDeviceInformationScan</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalDeviceIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewPhysicalDeviceInformation</span><span class="o">-&gt;</span><span class="n">Channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewPhysicalDeviceInformation</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewPhysicalDeviceInformation</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">StartPhysicalDeviceInformationScan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V2_IOCTL</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferSize</span> <span class="o">=</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_PhysicalDeviceInfo_T</span><span class="p">);</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">LogicalUnit</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewPhysicalDeviceInformation</span><span class="o">-&gt;</span><span class="n">LogicalUnit</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">TargetID</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewPhysicalDeviceInformation</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">Channel</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewPhysicalDeviceInformation</span><span class="o">-&gt;</span><span class="n">Channel</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_GetPhysicalDeviceInfoValid</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
					    <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
					    <span class="p">.</span><span class="n">SegmentDataPointer</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewPhysicalDeviceInformationDMA</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
					    <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
					    <span class="p">.</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
	    <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferSize</span><span class="p">;</span>
	  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NeedLogicalDeviceInformation</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">StartLogicalDeviceInformationScan</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="kt">int</span> <span class="n">LogicalDriveNumber</span><span class="p">;</span>
	      <span class="k">for</span> <span class="p">(</span><span class="n">LogicalDriveNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		   <span class="n">LogicalDriveNumber</span> <span class="o">&lt;</span> <span class="n">DAC960_MaxLogicalDrives</span><span class="p">;</span>
		   <span class="n">LogicalDriveNumber</span><span class="o">++</span><span class="p">)</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDriveFoundDuringScan</span>
			       <span class="p">[</span><span class="n">LogicalDriveNumber</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewLogicalDeviceInformation</span><span class="o">-&gt;</span><span class="n">LogicalDeviceNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">StartLogicalDeviceInformationScan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V2_IOCTL</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferSize</span> <span class="o">=</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_LogicalDeviceInfo_T</span><span class="p">);</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">LogicalDevice</span><span class="p">.</span><span class="n">LogicalDeviceNumber</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewLogicalDeviceInformation</span><span class="o">-&gt;</span><span class="n">LogicalDeviceNumber</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_GetLogicalDeviceInfoValid</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
					   <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
					   <span class="p">.</span><span class="n">SegmentDataPointer</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewLogicalDeviceInformationDMA</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
					   <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
					   <span class="p">.</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
	    <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferSize</span><span class="p">;</span>
	  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimerCount</span><span class="o">++</span><span class="p">;</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
	<span class="n">jiffies</span> <span class="o">+</span> <span class="n">DAC960_HealthStatusMonitoringInterval</span><span class="p">;</span>
      	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimer</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">CommandType</span> <span class="o">==</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">complete</span><span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">Completion</span><span class="p">);</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Completion</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">CommandType</span> <span class="o">==</span> <span class="n">DAC960_QueuedCommand</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_V2_KernelCommand_T</span> <span class="o">*</span><span class="n">KernelCommand</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">KernelCommand</span><span class="p">;</span>
      <span class="n">KernelCommand</span><span class="o">-&gt;</span><span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">CommandStatus</span><span class="p">;</span>
      <span class="n">KernelCommand</span><span class="o">-&gt;</span><span class="n">RequestSenseLength</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSenseLength</span><span class="p">;</span>
      <span class="n">KernelCommand</span><span class="o">-&gt;</span><span class="n">DataTransferLength</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">DataTransferResidue</span><span class="p">;</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">KernelCommand</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="n">KernelCommand</span><span class="o">-&gt;</span><span class="n">CompletionFunction</span><span class="p">(</span><span class="n">KernelCommand</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="cm">/*</span>
<span class="cm">    Queue a Status Monitoring Command to the Controller using the just</span>
<span class="cm">    completed Command if one was deferred previously due to lack of a</span>
<span class="cm">    free Command when the Monitoring Timer Function was called.</span>
<span class="cm">  */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringCommandDeferred</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringCommandDeferred</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="n">DAC960_V2_QueueMonitoringCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="cm">/*</span>
<span class="cm">    Deallocate the Command.</span>
<span class="cm">  */</span>
  <span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="cm">/*</span>
<span class="cm">    Wake up any processes waiting on a free Command.</span>
<span class="cm">  */</span>
  <span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CommandWaitQueue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  DAC960_GEM_InterruptHandler handles hardware interrupts from DAC960 GEM Series</span>
<span class="cm">  Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">DAC960_GEM_InterruptHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">IRQ_Channel</span><span class="p">,</span>
				       <span class="kt">void</span> <span class="o">*</span><span class="n">DeviceIdentifier</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">DeviceIdentifier</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">DAC960_V2_StatusMailbox_T</span> <span class="o">*</span><span class="n">NextStatusMailbox</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="n">DAC960_GEM_AcknowledgeInterrupt</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
  <span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextStatusMailbox</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">CommandIdentifier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
       <span class="n">DAC960_V2_CommandIdentifier_T</span> <span class="n">CommandIdentifier</span> <span class="o">=</span>
           <span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">CommandIdentifier</span><span class="p">;</span>
       <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Commands</span><span class="p">[</span><span class="n">CommandIdentifier</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
       <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
       <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSenseLength</span> <span class="o">=</span>
           <span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">RequestSenseLength</span><span class="p">;</span>
       <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">DataTransferResidue</span> <span class="o">=</span>
           <span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">DataTransferResidue</span><span class="p">;</span>
       <span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">NextStatusMailbox</span> <span class="o">&gt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LastStatusMailbox</span><span class="p">)</span>
           <span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">FirstStatusMailbox</span><span class="p">;</span>
       <span class="n">DAC960_V2_ProcessCompletedCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">NextStatusMailbox</span><span class="p">;</span>
  <span class="cm">/*</span>
<span class="cm">    Attempt to remove additional I/O Requests from the Controller&#39;s</span>
<span class="cm">    I/O Request Queue and queue them to the Controller.</span>
<span class="cm">  */</span>
  <span class="n">DAC960_ProcessRequest</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  DAC960_BA_InterruptHandler handles hardware interrupts from DAC960 BA Series</span>
<span class="cm">  Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">DAC960_BA_InterruptHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">IRQ_Channel</span><span class="p">,</span>
				       <span class="kt">void</span> <span class="o">*</span><span class="n">DeviceIdentifier</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">DeviceIdentifier</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">DAC960_V2_StatusMailbox_T</span> <span class="o">*</span><span class="n">NextStatusMailbox</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="n">DAC960_BA_AcknowledgeInterrupt</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
  <span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextStatusMailbox</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">CommandIdentifier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_V2_CommandIdentifier_T</span> <span class="n">CommandIdentifier</span> <span class="o">=</span>
	<span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">CommandIdentifier</span><span class="p">;</span>
      <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Commands</span><span class="p">[</span><span class="n">CommandIdentifier</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSenseLength</span> <span class="o">=</span>
	<span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">RequestSenseLength</span><span class="p">;</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">DataTransferResidue</span> <span class="o">=</span>
	<span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">DataTransferResidue</span><span class="p">;</span>
      <span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">NextStatusMailbox</span> <span class="o">&gt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LastStatusMailbox</span><span class="p">)</span>
	<span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">FirstStatusMailbox</span><span class="p">;</span>
      <span class="n">DAC960_V2_ProcessCompletedCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">NextStatusMailbox</span><span class="p">;</span>
  <span class="cm">/*</span>
<span class="cm">    Attempt to remove additional I/O Requests from the Controller&#39;s</span>
<span class="cm">    I/O Request Queue and queue them to the Controller.</span>
<span class="cm">  */</span>
  <span class="n">DAC960_ProcessRequest</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_LP_InterruptHandler handles hardware interrupts from DAC960 LP Series</span>
<span class="cm">  Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">DAC960_LP_InterruptHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">IRQ_Channel</span><span class="p">,</span>
				       <span class="kt">void</span> <span class="o">*</span><span class="n">DeviceIdentifier</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">DeviceIdentifier</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">DAC960_V2_StatusMailbox_T</span> <span class="o">*</span><span class="n">NextStatusMailbox</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="n">DAC960_LP_AcknowledgeInterrupt</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
  <span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextStatusMailbox</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">CommandIdentifier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_V2_CommandIdentifier_T</span> <span class="n">CommandIdentifier</span> <span class="o">=</span>
	<span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">CommandIdentifier</span><span class="p">;</span>
      <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Commands</span><span class="p">[</span><span class="n">CommandIdentifier</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSenseLength</span> <span class="o">=</span>
	<span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">RequestSenseLength</span><span class="p">;</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">DataTransferResidue</span> <span class="o">=</span>
	<span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">DataTransferResidue</span><span class="p">;</span>
      <span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">NextStatusMailbox</span> <span class="o">&gt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LastStatusMailbox</span><span class="p">)</span>
	<span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">FirstStatusMailbox</span><span class="p">;</span>
      <span class="n">DAC960_V2_ProcessCompletedCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">NextStatusMailbox</span><span class="p">;</span>
  <span class="cm">/*</span>
<span class="cm">    Attempt to remove additional I/O Requests from the Controller&#39;s</span>
<span class="cm">    I/O Request Queue and queue them to the Controller.</span>
<span class="cm">  */</span>
  <span class="n">DAC960_ProcessRequest</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_LA_InterruptHandler handles hardware interrupts from DAC960 LA Series</span>
<span class="cm">  Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">DAC960_LA_InterruptHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">IRQ_Channel</span><span class="p">,</span>
				       <span class="kt">void</span> <span class="o">*</span><span class="n">DeviceIdentifier</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">DeviceIdentifier</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">DAC960_V1_StatusMailbox_T</span> <span class="o">*</span><span class="n">NextStatusMailbox</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="n">DAC960_LA_AcknowledgeInterrupt</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
  <span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NextStatusMailbox</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Valid</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_V1_CommandIdentifier_T</span> <span class="n">CommandIdentifier</span> <span class="o">=</span>
	<span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">CommandIdentifier</span><span class="p">;</span>
      <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Commands</span><span class="p">[</span><span class="n">CommandIdentifier</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
      <span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">NextStatusMailbox</span> <span class="o">&gt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastStatusMailbox</span><span class="p">)</span>
	<span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">FirstStatusMailbox</span><span class="p">;</span>
      <span class="n">DAC960_V1_ProcessCompletedCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">NextStatusMailbox</span><span class="p">;</span>
  <span class="cm">/*</span>
<span class="cm">    Attempt to remove additional I/O Requests from the Controller&#39;s</span>
<span class="cm">    I/O Request Queue and queue them to the Controller.</span>
<span class="cm">  */</span>
  <span class="n">DAC960_ProcessRequest</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_PG_InterruptHandler handles hardware interrupts from DAC960 PG Series</span>
<span class="cm">  Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">DAC960_PG_InterruptHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">IRQ_Channel</span><span class="p">,</span>
				       <span class="kt">void</span> <span class="o">*</span><span class="n">DeviceIdentifier</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">DeviceIdentifier</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">DAC960_V1_StatusMailbox_T</span> <span class="o">*</span><span class="n">NextStatusMailbox</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="n">DAC960_PG_AcknowledgeInterrupt</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
  <span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NextStatusMailbox</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Valid</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_V1_CommandIdentifier_T</span> <span class="n">CommandIdentifier</span> <span class="o">=</span>
	<span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">CommandIdentifier</span><span class="p">;</span>
      <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Commands</span><span class="p">[</span><span class="n">CommandIdentifier</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
      <span class="n">NextStatusMailbox</span><span class="o">-&gt;</span><span class="n">Word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">NextStatusMailbox</span> <span class="o">&gt;</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">LastStatusMailbox</span><span class="p">)</span>
	<span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">FirstStatusMailbox</span><span class="p">;</span>
      <span class="n">DAC960_V1_ProcessCompletedCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NextStatusMailbox</span> <span class="o">=</span> <span class="n">NextStatusMailbox</span><span class="p">;</span>
  <span class="cm">/*</span>
<span class="cm">    Attempt to remove additional I/O Requests from the Controller&#39;s</span>
<span class="cm">    I/O Request Queue and queue them to the Controller.</span>
<span class="cm">  */</span>
  <span class="n">DAC960_ProcessRequest</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_PD_InterruptHandler handles hardware interrupts from DAC960 PD Series</span>
<span class="cm">  Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">DAC960_PD_InterruptHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">IRQ_Channel</span><span class="p">,</span>
				       <span class="kt">void</span> <span class="o">*</span><span class="n">DeviceIdentifier</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">DeviceIdentifier</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">DAC960_PD_StatusAvailableP</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">DAC960_V1_CommandIdentifier_T</span> <span class="n">CommandIdentifier</span> <span class="o">=</span>
	<span class="n">DAC960_PD_ReadStatusCommandIdentifier</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Commands</span><span class="p">[</span><span class="n">CommandIdentifier</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span> <span class="o">=</span>
	<span class="n">DAC960_PD_ReadStatusRegister</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="n">DAC960_PD_AcknowledgeInterrupt</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="n">DAC960_PD_AcknowledgeStatus</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="n">DAC960_V1_ProcessCompletedCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="cm">/*</span>
<span class="cm">    Attempt to remove additional I/O Requests from the Controller&#39;s</span>
<span class="cm">    I/O Request Queue and queue them to the Controller.</span>
<span class="cm">  */</span>
  <span class="n">DAC960_ProcessRequest</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_P_InterruptHandler handles hardware interrupts from DAC960 P Series</span>
<span class="cm">  Controllers.</span>

<span class="cm">  Translations of DAC960_V1_Enquiry and DAC960_V1_GetDeviceState rely</span>
<span class="cm">  on the data having been placed into DAC960_Controller_T, rather than</span>
<span class="cm">  an arbitrary buffer.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">DAC960_P_InterruptHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">IRQ_Channel</span><span class="p">,</span>
				      <span class="kt">void</span> <span class="o">*</span><span class="n">DeviceIdentifier</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">DeviceIdentifier</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ControllerBaseAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">BaseAddress</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">DAC960_PD_StatusAvailableP</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">DAC960_V1_CommandIdentifier_T</span> <span class="n">CommandIdentifier</span> <span class="o">=</span>
	<span class="n">DAC960_PD_ReadStatusCommandIdentifier</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Commands</span><span class="p">[</span><span class="n">CommandIdentifier</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
      <span class="n">DAC960_V1_CommandOpcode_T</span> <span class="n">CommandOpcode</span> <span class="o">=</span>
	<span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span><span class="p">;</span>
      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span> <span class="o">=</span>
	<span class="n">DAC960_PD_ReadStatusRegister</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="n">DAC960_PD_AcknowledgeInterrupt</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="n">DAC960_PD_AcknowledgeStatus</span><span class="p">(</span><span class="n">ControllerBaseAddress</span><span class="p">);</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">CommandOpcode</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">DAC960_V1_Enquiry_Old</span>:
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_Enquiry</span><span class="p">;</span>
	  <span class="n">DAC960_P_To_PD_TranslateEnquiry</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewEnquiry</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_V1_GetDeviceState_Old</span>:
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span>
	    					<span class="n">DAC960_V1_GetDeviceState</span><span class="p">;</span>
	  <span class="n">DAC960_P_To_PD_TranslateDeviceState</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewDeviceState</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_V1_Read_Old</span>:
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_Read</span><span class="p">;</span>
	  <span class="n">DAC960_P_To_PD_TranslateReadWriteCommand</span><span class="p">(</span><span class="n">CommandMailbox</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_V1_Write_Old</span>:
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_Write</span><span class="p">;</span>
	  <span class="n">DAC960_P_To_PD_TranslateReadWriteCommand</span><span class="p">(</span><span class="n">CommandMailbox</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_V1_ReadWithScatterGather_Old</span>:
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_ReadWithScatterGather</span><span class="p">;</span>
	  <span class="n">DAC960_P_To_PD_TranslateReadWriteCommand</span><span class="p">(</span><span class="n">CommandMailbox</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_V1_WriteWithScatterGather_Old</span>:
	  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span>
	    <span class="n">DAC960_V1_WriteWithScatterGather</span><span class="p">;</span>
	  <span class="n">DAC960_P_To_PD_TranslateReadWriteCommand</span><span class="p">(</span><span class="n">CommandMailbox</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="n">DAC960_V1_ProcessCompletedCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="cm">/*</span>
<span class="cm">    Attempt to remove additional I/O Requests from the Controller&#39;s</span>
<span class="cm">    I/O Request Queue and queue them to the Controller.</span>
<span class="cm">  */</span>
  <span class="n">DAC960_ProcessRequest</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V1_QueueMonitoringCommand queues a Monitoring Command to DAC960 V1</span>
<span class="cm">  Firmware Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_V1_QueueMonitoringCommand</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V1_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_MonitoringCommand</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_Enquiry</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">NewEnquiryDMA</span><span class="p">;</span>
  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_QueueMonitoringCommand queues a Monitoring Command to DAC960 V2</span>
<span class="cm">  Firmware Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_V2_QueueMonitoringCommand</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_V2_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_MonitoringCommand</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V2_IOCTL</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">CommandControlBits</span>
				<span class="p">.</span><span class="n">DataTransferControllerToHost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">CommandControlBits</span>
				<span class="p">.</span><span class="n">NoAutoRequestSense</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">DataTransferSize</span> <span class="o">=</span>
    <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_ControllerInfo_T</span><span class="p">);</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">ControllerNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span> <span class="n">DAC960_V2_GetControllerInfo</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
				<span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="p">.</span><span class="n">SegmentDataPointer</span> <span class="o">=</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewControllerInformationDMA</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
				<span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="p">.</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
    <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">DataTransferSize</span><span class="p">;</span>
  <span class="n">DAC960_QueueCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_MonitoringTimerFunction is the timer function for monitoring</span>
<span class="cm">  the status of DAC960 Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_MonitoringTimerFunction</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">TimerData</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="p">)</span> <span class="n">TimerData</span><span class="p">;</span>
  <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">==</span> <span class="n">DAC960_V1_Controller</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
      <span class="cm">/*</span>
<span class="cm">	Queue a Status Monitoring Command to Controller.</span>
<span class="cm">      */</span>
      <span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Command</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="n">DAC960_V1_QueueMonitoringCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="k">else</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringCommandDeferred</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">DAC960_V2_ControllerInfo_T</span> <span class="o">*</span><span class="n">ControllerInfo</span> <span class="o">=</span>
	<span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">ControllerInformation</span><span class="p">;</span>
      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">StatusChangeCounter</span> <span class="o">=</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">HealthStatusBuffer</span><span class="o">-&gt;</span><span class="n">StatusChangeCounter</span><span class="p">;</span>
      <span class="n">bool</span> <span class="n">ForceMonitoringCommand</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">SecondaryMonitoringTime</span>
	  <span class="o">+</span> <span class="n">DAC960_SecondaryMonitoringInterval</span><span class="p">))</span>
	<span class="p">{</span>
	  <span class="kt">int</span> <span class="n">LogicalDriveNumber</span><span class="p">;</span>
	  <span class="k">for</span> <span class="p">(</span><span class="n">LogicalDriveNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	       <span class="n">LogicalDriveNumber</span> <span class="o">&lt;</span> <span class="n">DAC960_MaxLogicalDrives</span><span class="p">;</span>
	       <span class="n">LogicalDriveNumber</span><span class="o">++</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_V2_LogicalDeviceInfo_T</span> <span class="o">*</span><span class="n">LogicalDeviceInfo</span> <span class="o">=</span>
		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">LogicalDeviceInformation</span><span class="p">[</span><span class="n">LogicalDriveNumber</span><span class="p">];</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">LogicalDeviceInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
	      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">LogicalDeviceInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceControl</span>
				     <span class="p">.</span><span class="n">LogicalDeviceInitialized</span><span class="p">)</span>
		<span class="p">{</span>
		  <span class="n">ForceMonitoringCommand</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		  <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">SecondaryMonitoringTime</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">StatusChangeCounter</span> <span class="o">==</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">StatusChangeCounter</span> <span class="o">&amp;&amp;</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">HealthStatusBuffer</span><span class="o">-&gt;</span><span class="n">NextEventSequenceNumber</span>
	  <span class="o">==</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NextEventSequenceNumber</span> <span class="o">&amp;&amp;</span>
	  <span class="p">(</span><span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">BackgroundInitializationsActive</span> <span class="o">+</span>
	   <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInitializationsActive</span> <span class="o">+</span>
	   <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInitializationsActive</span> <span class="o">+</span>
	   <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">ConsistencyChecksActive</span> <span class="o">+</span>
	   <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">RebuildsActive</span> <span class="o">+</span>
	   <span class="n">ControllerInfo</span><span class="o">-&gt;</span><span class="n">OnlineExpansionsActive</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	   <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PrimaryMonitoringTime</span>
	   <span class="o">+</span> <span class="n">DAC960_MonitoringTimerInterval</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	  <span class="o">!</span><span class="n">ForceMonitoringCommand</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
	    <span class="n">jiffies</span> <span class="o">+</span> <span class="n">DAC960_HealthStatusMonitoringInterval</span><span class="p">;</span>
	    <span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringTimer</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">StatusChangeCounter</span> <span class="o">=</span> <span class="n">StatusChangeCounter</span><span class="p">;</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PrimaryMonitoringTime</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

      <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
      <span class="cm">/*</span>
<span class="cm">	Queue a Status Monitoring Command to Controller.</span>
<span class="cm">      */</span>
      <span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Command</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="n">DAC960_V2_QueueMonitoringCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="k">else</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringCommandDeferred</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
      <span class="cm">/*</span>
<span class="cm">	Wake up any processes waiting on a Health Status Buffer change.</span>
<span class="cm">      */</span>
      <span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">HealthStatusWaitQueue</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  DAC960_CheckStatusBuffer verifies that there is room to hold ByteCount</span>
<span class="cm">  additional bytes in the Combined Status Buffer and grows the buffer if</span>
<span class="cm">  necessary.  It returns true if there is enough room and false otherwise.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_CheckStatusBuffer</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ByteCount</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">NewStatusBuffer</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">InitialStatusLength</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusLength</span> <span class="o">+</span> <span class="n">ByteCount</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBufferLength</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBufferLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">NewStatusBufferLength</span> <span class="o">=</span> <span class="n">DAC960_InitialStatusBufferSize</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">NewStatusBufferLength</span> <span class="o">&lt;</span> <span class="n">ByteCount</span><span class="p">)</span>
	<span class="n">NewStatusBufferLength</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBuffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">NewStatusBufferLength</span><span class="p">,</span>
						  <span class="n">GFP_ATOMIC</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBufferLength</span> <span class="o">=</span> <span class="n">NewStatusBufferLength</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">NewStatusBuffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBufferLength</span><span class="p">,</span>
			     <span class="n">GFP_ATOMIC</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">NewStatusBuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_Warning</span><span class="p">(</span><span class="s">&quot;Unable to expand Combined Status Buffer - Truncating</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">Controller</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">NewStatusBuffer</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBuffer</span><span class="p">,</span>
	 <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBufferLength</span><span class="p">);</span>
  <span class="n">kfree</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBuffer</span><span class="p">);</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBuffer</span> <span class="o">=</span> <span class="n">NewStatusBuffer</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBufferLength</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusBuffer</span> <span class="o">=</span>
    <span class="o">&amp;</span><span class="n">NewStatusBuffer</span><span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">InitialStatusLength</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_Message prints Driver Messages.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_Message</span><span class="p">(</span><span class="n">DAC960_MessageLevel_T</span> <span class="n">MessageLevel</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Format</span><span class="p">,</span>
			   <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
			   <span class="p">...)</span>
<span class="p">{</span>
  <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Buffer</span><span class="p">[</span><span class="n">DAC960_LineBufferSize</span><span class="p">];</span>
  <span class="k">static</span> <span class="n">bool</span> <span class="n">BeginningOfLine</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="kt">va_list</span> <span class="n">Arguments</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">Length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">va_start</span><span class="p">(</span><span class="n">Arguments</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
  <span class="n">Length</span> <span class="o">=</span> <span class="n">vsprintf</span><span class="p">(</span><span class="n">Buffer</span><span class="p">,</span> <span class="n">Format</span><span class="p">,</span> <span class="n">Arguments</span><span class="p">);</span>
  <span class="n">va_end</span><span class="p">(</span><span class="n">Arguments</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sDAC960#%d: %s&quot;</span><span class="p">,</span> <span class="n">DAC960_MessageLevelMap</span><span class="p">[</span><span class="n">MessageLevel</span><span class="p">],</span>
	   <span class="n">DAC960_ControllerCount</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">);</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">MessageLevel</span> <span class="o">==</span> <span class="n">DAC960_AnnounceLevel</span> <span class="o">||</span>
	   <span class="n">MessageLevel</span> <span class="o">==</span> <span class="n">DAC960_InfoLevel</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerInitialized</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">DAC960_CheckStatusBuffer</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">Length</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="n">strcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBuffer</span>
				  <span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">InitialStatusLength</span><span class="p">],</span>
		     <span class="n">Buffer</span><span class="p">);</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">InitialStatusLength</span> <span class="o">+=</span> <span class="n">Length</span><span class="p">;</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusBuffer</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBuffer</span>
			     <span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">InitialStatusLength</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	    <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">MessageLevel</span> <span class="o">==</span> <span class="n">DAC960_AnnounceLevel</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="k">static</span> <span class="kt">int</span> <span class="n">AnnouncementLines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	      <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">AnnouncementLines</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sDAC960: %s&quot;</span><span class="p">,</span> <span class="n">DAC960_MessageLevelMap</span><span class="p">[</span><span class="n">MessageLevel</span><span class="p">],</span>
		       <span class="n">Buffer</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="k">else</span>
	    <span class="p">{</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">BeginningOfLine</span><span class="p">)</span>
		<span class="p">{</span>
		  <span class="k">if</span> <span class="p">(</span><span class="n">Buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="o">||</span> <span class="n">Length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sDAC960#%d: %s&quot;</span><span class="p">,</span>
			   <span class="n">DAC960_MessageLevelMap</span><span class="p">[</span><span class="n">MessageLevel</span><span class="p">],</span>
			   <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">);</span>
		<span class="p">}</span>
	      <span class="k">else</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">);</span>
	    <span class="p">}</span>
	<span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">DAC960_CheckStatusBuffer</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">Length</span><span class="p">))</span>
	<span class="p">{</span>
	  <span class="n">strcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusBuffer</span><span class="p">[</span>
		    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusLength</span><span class="p">],</span> <span class="n">Buffer</span><span class="p">);</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusLength</span> <span class="o">+=</span> <span class="n">Length</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">MessageLevel</span> <span class="o">==</span> <span class="n">DAC960_ProgressLevel</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">strcpy</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ProgressBuffer</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">);</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ProgressBufferLength</span> <span class="o">=</span> <span class="n">Length</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">EphemeralProgressMessage</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LastProgressReportTime</span>
	      <span class="o">+</span> <span class="n">DAC960_ProgressReportingInterval</span><span class="p">))</span>
	    <span class="p">{</span>
	      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sDAC960#%d: %s&quot;</span><span class="p">,</span> <span class="n">DAC960_MessageLevelMap</span><span class="p">[</span><span class="n">MessageLevel</span><span class="p">],</span>
		     <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">);</span>
	      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LastProgressReportTime</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
      <span class="k">else</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sDAC960#%d: %s&quot;</span><span class="p">,</span> <span class="n">DAC960_MessageLevelMap</span><span class="p">[</span><span class="n">MessageLevel</span><span class="p">],</span>
		  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">MessageLevel</span> <span class="o">==</span> <span class="n">DAC960_UserCriticalLevel</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">strcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">UserStatusBuffer</span><span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">UserStatusLength</span><span class="p">],</span>
	     <span class="n">Buffer</span><span class="p">);</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">UserStatusLength</span> <span class="o">+=</span> <span class="n">Length</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="o">||</span> <span class="n">Length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sDAC960#%d: %s&quot;</span><span class="p">,</span> <span class="n">DAC960_MessageLevelMap</span><span class="p">[</span><span class="n">MessageLevel</span><span class="p">],</span>
	       <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">BeginningOfLine</span><span class="p">)</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sDAC960#%d: %s&quot;</span><span class="p">,</span> <span class="n">DAC960_MessageLevelMap</span><span class="p">[</span><span class="n">MessageLevel</span><span class="p">],</span>
	       <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">);</span>
      <span class="k">else</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">BeginningOfLine</span> <span class="o">=</span> <span class="p">(</span><span class="n">Buffer</span><span class="p">[</span><span class="n">Length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_ParsePhysicalDevice parses spaces followed by a Physical Device</span>
<span class="cm">  Channel:TargetID specification from a User Command string.  It updates</span>
<span class="cm">  Channel and TargetID and returns true on success and false on failure.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_ParsePhysicalDevice</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
					  <span class="kt">char</span> <span class="o">*</span><span class="n">UserCommandString</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Channel</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">TargetID</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">NewUserCommandString</span> <span class="o">=</span> <span class="n">UserCommandString</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">XChannel</span><span class="p">,</span> <span class="n">XTargetID</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">UserCommandString</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="n">UserCommandString</span><span class="o">++</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">UserCommandString</span> <span class="o">==</span> <span class="n">NewUserCommandString</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">XChannel</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">UserCommandString</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">NewUserCommandString</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">NewUserCommandString</span> <span class="o">==</span> <span class="n">UserCommandString</span> <span class="o">||</span>
      <span class="o">*</span><span class="n">NewUserCommandString</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span> <span class="o">||</span>
      <span class="n">XChannel</span> <span class="o">&gt;=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">UserCommandString</span> <span class="o">=</span> <span class="o">++</span><span class="n">NewUserCommandString</span><span class="p">;</span>
  <span class="n">XTargetID</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">UserCommandString</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">NewUserCommandString</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">NewUserCommandString</span> <span class="o">==</span> <span class="n">UserCommandString</span> <span class="o">||</span>
      <span class="o">*</span><span class="n">NewUserCommandString</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">||</span>
      <span class="n">XTargetID</span> <span class="o">&gt;=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Targets</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="o">*</span><span class="n">Channel</span> <span class="o">=</span> <span class="n">XChannel</span><span class="p">;</span>
  <span class="o">*</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">XTargetID</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_ParseLogicalDrive parses spaces followed by a Logical Drive Number</span>
<span class="cm">  specification from a User Command string.  It updates LogicalDriveNumber and</span>
<span class="cm">  returns true on success and false on failure.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_ParseLogicalDrive</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">UserCommandString</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">LogicalDriveNumber</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">NewUserCommandString</span> <span class="o">=</span> <span class="n">UserCommandString</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">XLogicalDriveNumber</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">UserCommandString</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="n">UserCommandString</span><span class="o">++</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">UserCommandString</span> <span class="o">==</span> <span class="n">NewUserCommandString</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">XLogicalDriveNumber</span> <span class="o">=</span>
    <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">UserCommandString</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">NewUserCommandString</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">NewUserCommandString</span> <span class="o">==</span> <span class="n">UserCommandString</span> <span class="o">||</span>
      <span class="o">*</span><span class="n">NewUserCommandString</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">||</span>
      <span class="n">XLogicalDriveNumber</span> <span class="o">&gt;</span> <span class="n">DAC960_MaxLogicalDrives</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="o">*</span><span class="n">LogicalDriveNumber</span> <span class="o">=</span> <span class="n">XLogicalDriveNumber</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V1_SetDeviceState sets the Device State for a Physical Device for</span>
<span class="cm">  DAC960 V1 Firmware Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_V1_SetDeviceState</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
				     <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Channel</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TargetID</span><span class="p">,</span>
				     <span class="n">DAC960_V1_PhysicalDeviceState_T</span>
				       <span class="n">DeviceState</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">DeviceStateString</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3D</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_StartDevice</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3D</span><span class="p">.</span><span class="n">Channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3D</span><span class="p">.</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">TargetID</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3D</span><span class="p">.</span><span class="n">DeviceState</span> <span class="o">=</span> <span class="n">DeviceState</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3D</span><span class="p">.</span><span class="n">Modifier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">DAC960_V1_NormalCompletion</span>:
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;%s of Physical Device %d:%d Succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			  <span class="n">DeviceStateString</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_UnableToStartDevice</span>:
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;%s of Physical Device %d:%d Failed - &quot;</span>
			  <span class="s">&quot;Unable to Start Device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			  <span class="n">DeviceStateString</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_NoDeviceAtAddress</span>:
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;%s of Physical Device %d:%d Failed - &quot;</span>
			  <span class="s">&quot;No Device at Address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			  <span class="n">DeviceStateString</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_InvalidChannelOrTargetOrModifier</span>:
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;%s of Physical Device %d:%d Failed - &quot;</span>
			  <span class="s">&quot;Invalid Channel or Target or Modifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">Controller</span><span class="p">,</span> <span class="n">DeviceStateString</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_V1_ChannelBusy</span>:
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;%s of Physical Device %d:%d Failed - &quot;</span>
			  <span class="s">&quot;Channel Busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			  <span class="n">DeviceStateString</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;%s of Physical Device %d:%d Failed - &quot;</span>
			  <span class="s">&quot;Unexpected Status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			  <span class="n">DeviceStateString</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
			  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V1_ExecuteUserCommand executes a User Command for DAC960 V1 Firmware</span>
<span class="cm">  Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V1_ExecuteUserCommand</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">UserCommand</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">;</span>
  <span class="n">DAC960_V1_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span> <span class="n">LogicalDriveNumber</span><span class="p">;</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">DAC960_WaitForCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">UserStatusLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">DAC960_V1_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">;</span>
  <span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;flush-cache&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_Flush</span><span class="p">;</span>
      <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Cache Flush Completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;kill&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_ParsePhysicalDevice</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
				      <span class="o">&amp;</span><span class="n">Channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TargetID</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">DAC960_V1_DeviceState_T</span> <span class="o">*</span><span class="n">DeviceState</span> <span class="o">=</span>
	<span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceState</span><span class="p">[</span><span class="n">Channel</span><span class="p">][</span><span class="n">TargetID</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">Present</span> <span class="o">&amp;&amp;</span>
	  <span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">DeviceType</span> <span class="o">==</span> <span class="n">DAC960_V1_DiskType</span> <span class="o">&amp;&amp;</span>
	  <span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span> <span class="o">!=</span> <span class="n">DAC960_V1_Device_Dead</span><span class="p">)</span>
	<span class="n">DAC960_V1_SetDeviceState</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">Command</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
				 <span class="n">DAC960_V1_Device_Dead</span><span class="p">,</span> <span class="s">&quot;Kill&quot;</span><span class="p">);</span>
      <span class="k">else</span> <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Kill of Physical Device %d:%d Illegal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;make-online&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_ParsePhysicalDevice</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
				      <span class="o">&amp;</span><span class="n">Channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TargetID</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">DAC960_V1_DeviceState_T</span> <span class="o">*</span><span class="n">DeviceState</span> <span class="o">=</span>
	<span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceState</span><span class="p">[</span><span class="n">Channel</span><span class="p">][</span><span class="n">TargetID</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">Present</span> <span class="o">&amp;&amp;</span>
	  <span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">DeviceType</span> <span class="o">==</span> <span class="n">DAC960_V1_DiskType</span> <span class="o">&amp;&amp;</span>
	  <span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span> <span class="o">==</span> <span class="n">DAC960_V1_Device_Dead</span><span class="p">)</span>
	<span class="n">DAC960_V1_SetDeviceState</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">Command</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
				 <span class="n">DAC960_V1_Device_Online</span><span class="p">,</span> <span class="s">&quot;Make Online&quot;</span><span class="p">);</span>
      <span class="k">else</span> <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Make Online of Physical Device %d:%d Illegal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>

    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;make-standby&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_ParsePhysicalDevice</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span>
				      <span class="o">&amp;</span><span class="n">Channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TargetID</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">DAC960_V1_DeviceState_T</span> <span class="o">*</span><span class="n">DeviceState</span> <span class="o">=</span>
	<span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DeviceState</span><span class="p">[</span><span class="n">Channel</span><span class="p">][</span><span class="n">TargetID</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">Present</span> <span class="o">&amp;&amp;</span>
	  <span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">DeviceType</span> <span class="o">==</span> <span class="n">DAC960_V1_DiskType</span> <span class="o">&amp;&amp;</span>
	  <span class="n">DeviceState</span><span class="o">-&gt;</span><span class="n">DeviceState</span> <span class="o">==</span> <span class="n">DAC960_V1_Device_Dead</span><span class="p">)</span>
	<span class="n">DAC960_V1_SetDeviceState</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">Command</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
				 <span class="n">DAC960_V1_Device_Standby</span><span class="p">,</span> <span class="s">&quot;Make Standby&quot;</span><span class="p">);</span>
      <span class="k">else</span> <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Make Standby of Physical &quot;</span>
			       <span class="s">&quot;Device %d:%d Illegal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;rebuild&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_ParsePhysicalDevice</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
				      <span class="o">&amp;</span><span class="n">Channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TargetID</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3D</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_RebuildAsync</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3D</span><span class="p">.</span><span class="n">Channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3D</span><span class="p">.</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">TargetID</span><span class="p">;</span>
      <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">DAC960_V1_NormalCompletion</span>:
	  <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Rebuild of Physical Device %d:%d Initiated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_V1_AttemptToRebuildOnlineDrive</span>:
	  <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Rebuild of Physical Device %d:%d Failed - &quot;</span>
			      <span class="s">&quot;Attempt to Rebuild Online or &quot;</span>
			      <span class="s">&quot;Unresponsive Drive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_V1_NewDiskFailedDuringRebuild</span>:
	  <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Rebuild of Physical Device %d:%d Failed - &quot;</span>
			      <span class="s">&quot;New Disk Failed During Rebuild</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_V1_InvalidDeviceAddress</span>:
	  <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Rebuild of Physical Device %d:%d Failed - &quot;</span>
			      <span class="s">&quot;Invalid Device Address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_V1_RebuildOrCheckAlreadyInProgress</span>:
	  <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Rebuild of Physical Device %d:%d Failed - &quot;</span>
			      <span class="s">&quot;Rebuild or Consistency Check Already &quot;</span>
			      <span class="s">&quot;in Progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	  <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Rebuild of Physical Device %d:%d Failed - &quot;</span>
			      <span class="s">&quot;Unexpected Status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			      <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;check-consistency&quot;</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_ParseLogicalDrive</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span>
				    <span class="o">&amp;</span><span class="n">LogicalDriveNumber</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3C</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_CheckConsistencyAsync</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3C</span><span class="p">.</span><span class="n">LogicalDriveNumber</span> <span class="o">=</span> <span class="n">LogicalDriveNumber</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3C</span><span class="p">.</span><span class="n">AutoRestore</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">DAC960_V1_NormalCompletion</span>:
	  <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Consistency Check of Logical Drive %d &quot;</span>
			      <span class="s">&quot;(/dev/rd/c%dd%d) Initiated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">,</span> <span class="n">LogicalDriveNumber</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
			      <span class="n">LogicalDriveNumber</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_V1_DependentDiskIsDead</span>:
	  <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Consistency Check of Logical Drive %d &quot;</span>
			      <span class="s">&quot;(/dev/rd/c%dd%d) Failed - &quot;</span>
			      <span class="s">&quot;Dependent Physical Device is DEAD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">,</span> <span class="n">LogicalDriveNumber</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
			      <span class="n">LogicalDriveNumber</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_V1_InvalidOrNonredundantLogicalDrive</span>:
	  <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Consistency Check of Logical Drive %d &quot;</span>
			      <span class="s">&quot;(/dev/rd/c%dd%d) Failed - &quot;</span>
			      <span class="s">&quot;Invalid or Nonredundant Logical Drive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">,</span> <span class="n">LogicalDriveNumber</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
			      <span class="n">LogicalDriveNumber</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DAC960_V1_RebuildOrCheckAlreadyInProgress</span>:
	  <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Consistency Check of Logical Drive %d &quot;</span>
			      <span class="s">&quot;(/dev/rd/c%dd%d) Failed - Rebuild or &quot;</span>
			      <span class="s">&quot;Consistency Check Already in Progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">,</span> <span class="n">LogicalDriveNumber</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
			      <span class="n">LogicalDriveNumber</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	  <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Consistency Check of Logical Drive %d &quot;</span>
			      <span class="s">&quot;(/dev/rd/c%dd%d) Failed - &quot;</span>
			      <span class="s">&quot;Unexpected Status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">,</span> <span class="n">LogicalDriveNumber</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
			      <span class="n">LogicalDriveNumber</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;cancel-rebuild&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	   <span class="n">strcmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;cancel-consistency-check&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">        the OldRebuildRateConstant is never actually used</span>
<span class="cm">        once its value is retrieved from the controller.</span>
<span class="cm">       */</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">OldRebuildRateConstant</span><span class="p">;</span>
      <span class="n">dma_addr_t</span> <span class="n">OldRebuildRateConstantDMA</span><span class="p">;</span>

      <span class="n">OldRebuildRateConstant</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">OldRebuildRateConstantDMA</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">OldRebuildRateConstant</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Cancellation of Rebuild or &quot;</span>
			     <span class="s">&quot;Consistency Check Failed - &quot;</span>
			     <span class="s">&quot;Out of Memory&quot;</span><span class="p">,</span>
                             <span class="n">Controller</span><span class="p">);</span>
	 <span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3R</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V1_RebuildControl</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3R</span><span class="p">.</span><span class="n">RebuildRateConstant</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Type3R</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span> <span class="n">OldRebuildRateConstantDMA</span><span class="p">;</span>
      <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">DAC960_V1_NormalCompletion</span>:
	  <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Rebuild or Consistency Check Cancelled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	  <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Cancellation of Rebuild or &quot;</span>
			      <span class="s">&quot;Consistency Check Failed - &quot;</span>
			      <span class="s">&quot;Unexpected Status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">Controller</span><span class="p">,</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">failure:</span>
  	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span>
		<span class="n">OldRebuildRateConstant</span><span class="p">,</span> <span class="n">OldRebuildRateConstantDMA</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Illegal User Command: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">Controller</span><span class="p">,</span> <span class="n">UserCommand</span><span class="p">);</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_TranslatePhysicalDevice translates a Physical Device Channel and</span>
<span class="cm">  TargetID into a Logical Device.  It returns true on success and false</span>
<span class="cm">  on failure.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V2_TranslatePhysicalDevice</span><span class="p">(</span><span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">,</span>
						 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Channel</span><span class="p">,</span>
						 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TargetID</span><span class="p">,</span>
						 <span class="kt">unsigned</span> <span class="kt">short</span>
						   <span class="o">*</span><span class="n">LogicalDeviceNumber</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="n">SavedCommandMailbox</span><span class="p">,</span> <span class="o">*</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span>  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">;</span>

  <span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SavedCommandMailbox</span><span class="p">,</span> <span class="n">CommandMailbox</span><span class="p">,</span>
	 <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_CommandMailbox_T</span><span class="p">));</span>

  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V2_IOCTL</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">CommandControlBits</span>
				    <span class="p">.</span><span class="n">DataTransferControllerToHost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">CommandControlBits</span>
				    <span class="p">.</span><span class="n">NoAutoRequestSense</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">DataTransferSize</span> <span class="o">=</span>
    <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_PhysicalToLogicalDevice_T</span><span class="p">);</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">TargetID</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">PhysicalDevice</span><span class="p">.</span><span class="n">Channel</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">PhysicalDeviceInfo</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span>
    <span class="n">DAC960_V2_TranslatePhysicalToLogicalDevice</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
			<span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="p">.</span><span class="n">SegmentDataPointer</span> <span class="o">=</span>
    		<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalToLogicalDeviceDMA</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
			<span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="p">.</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
    		<span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">DataTransferSize</span><span class="p">;</span>

  <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="o">*</span><span class="n">LogicalDeviceNumber</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">PhysicalToLogicalDevice</span><span class="o">-&gt;</span><span class="n">LogicalDeviceNumber</span><span class="p">;</span>

  <span class="n">memcpy</span><span class="p">(</span><span class="n">CommandMailbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SavedCommandMailbox</span><span class="p">,</span>
	 <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_CommandMailbox_T</span><span class="p">));</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_V2_ExecuteUserCommand executes a User Command for DAC960 V2 Firmware</span>
<span class="cm">  Controllers.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">DAC960_V2_ExecuteUserCommand</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">UserCommand</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span><span class="p">;</span>
  <span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span> <span class="n">LogicalDriveNumber</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">LogicalDeviceNumber</span><span class="p">;</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">DAC960_WaitForCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">UserStatusLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">DAC960_V2_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">;</span>
  <span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V2_IOCTL</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandControlBits</span><span class="p">.</span><span class="n">DataTransferControllerToHost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandControlBits</span><span class="p">.</span><span class="n">NoAutoRequestSense</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;flush-cache&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">DeviceOperation</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span> <span class="n">DAC960_V2_PauseDevice</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">DeviceOperation</span><span class="p">.</span><span class="n">OperationDevice</span> <span class="o">=</span>
	<span class="n">DAC960_V2_RAID_Controller</span><span class="p">;</span>
      <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Cache Flush Completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;kill&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_ParsePhysicalDevice</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
				      <span class="o">&amp;</span><span class="n">Channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TargetID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_V2_TranslatePhysicalDevice</span><span class="p">(</span><span class="n">Command</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">LogicalDeviceNumber</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetDeviceState</span><span class="p">.</span><span class="n">LogicalDevice</span><span class="p">.</span><span class="n">LogicalDeviceNumber</span> <span class="o">=</span>
	<span class="n">LogicalDeviceNumber</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetDeviceState</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span>
	<span class="n">DAC960_V2_SetDeviceState</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetDeviceState</span><span class="p">.</span><span class="n">DeviceState</span><span class="p">.</span><span class="n">PhysicalDeviceState</span> <span class="o">=</span>
	<span class="n">DAC960_V2_Device_Dead</span><span class="p">;</span>
      <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Kill of Physical Device %d:%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span>
			   <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span>
			   <span class="o">?</span> <span class="s">&quot;Succeeded&quot;</span> <span class="o">:</span> <span class="s">&quot;Failed&quot;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;make-online&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_ParsePhysicalDevice</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
				      <span class="o">&amp;</span><span class="n">Channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TargetID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_V2_TranslatePhysicalDevice</span><span class="p">(</span><span class="n">Command</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">LogicalDeviceNumber</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetDeviceState</span><span class="p">.</span><span class="n">LogicalDevice</span><span class="p">.</span><span class="n">LogicalDeviceNumber</span> <span class="o">=</span>
	<span class="n">LogicalDeviceNumber</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetDeviceState</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span>
	<span class="n">DAC960_V2_SetDeviceState</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetDeviceState</span><span class="p">.</span><span class="n">DeviceState</span><span class="p">.</span><span class="n">PhysicalDeviceState</span> <span class="o">=</span>
	<span class="n">DAC960_V2_Device_Online</span><span class="p">;</span>
      <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Make Online of Physical Device %d:%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span>
			   <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span>
			   <span class="o">?</span> <span class="s">&quot;Succeeded&quot;</span> <span class="o">:</span> <span class="s">&quot;Failed&quot;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;make-standby&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_ParsePhysicalDevice</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span>
				      <span class="o">&amp;</span><span class="n">Channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TargetID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_V2_TranslatePhysicalDevice</span><span class="p">(</span><span class="n">Command</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">LogicalDeviceNumber</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetDeviceState</span><span class="p">.</span><span class="n">LogicalDevice</span><span class="p">.</span><span class="n">LogicalDeviceNumber</span> <span class="o">=</span>
	<span class="n">LogicalDeviceNumber</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetDeviceState</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span>
	<span class="n">DAC960_V2_SetDeviceState</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">SetDeviceState</span><span class="p">.</span><span class="n">DeviceState</span><span class="p">.</span><span class="n">PhysicalDeviceState</span> <span class="o">=</span>
	<span class="n">DAC960_V2_Device_Standby</span><span class="p">;</span>
      <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Make Standby of Physical Device %d:%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span>
			   <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span>
			   <span class="o">?</span> <span class="s">&quot;Succeeded&quot;</span> <span class="o">:</span> <span class="s">&quot;Failed&quot;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;rebuild&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_ParsePhysicalDevice</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
				      <span class="o">&amp;</span><span class="n">Channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TargetID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_V2_TranslatePhysicalDevice</span><span class="p">(</span><span class="n">Command</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">LogicalDeviceNumber</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">LogicalDevice</span><span class="p">.</span><span class="n">LogicalDeviceNumber</span> <span class="o">=</span>
	<span class="n">LogicalDeviceNumber</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span>
	<span class="n">DAC960_V2_RebuildDeviceStart</span><span class="p">;</span>
      <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Rebuild of Physical Device %d:%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span>
			   <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span>
			   <span class="o">?</span> <span class="s">&quot;Initiated&quot;</span> <span class="o">:</span> <span class="s">&quot;Not Initiated&quot;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;cancel-rebuild&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_ParsePhysicalDevice</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span>
				      <span class="o">&amp;</span><span class="n">Channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TargetID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_V2_TranslatePhysicalDevice</span><span class="p">(</span><span class="n">Command</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">LogicalDeviceNumber</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">LogicalDevice</span><span class="p">.</span><span class="n">LogicalDeviceNumber</span> <span class="o">=</span>
	<span class="n">LogicalDeviceNumber</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">LogicalDeviceInfo</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span>
	<span class="n">DAC960_V2_RebuildDeviceStop</span><span class="p">;</span>
      <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Rebuild of Physical Device %d:%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">Controller</span><span class="p">,</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">TargetID</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span>
			   <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span>
			   <span class="o">?</span> <span class="s">&quot;Cancelled&quot;</span> <span class="o">:</span> <span class="s">&quot;Not Cancelled&quot;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;check-consistency&quot;</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_ParseLogicalDrive</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span>
				    <span class="o">&amp;</span><span class="n">LogicalDriveNumber</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ConsistencyCheck</span><span class="p">.</span><span class="n">LogicalDevice</span><span class="p">.</span><span class="n">LogicalDeviceNumber</span> <span class="o">=</span>
	<span class="n">LogicalDriveNumber</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ConsistencyCheck</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span>
	<span class="n">DAC960_V2_ConsistencyCheckStart</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ConsistencyCheck</span><span class="p">.</span><span class="n">RestoreConsistency</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ConsistencyCheck</span><span class="p">.</span><span class="n">InitializedAreaOnly</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Consistency Check of Logical Drive %d &quot;</span>
			  <span class="s">&quot;(/dev/rd/c%dd%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">Controller</span><span class="p">,</span> <span class="n">LogicalDriveNumber</span><span class="p">,</span>
			  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
			  <span class="n">LogicalDriveNumber</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span>
			   <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span>
			   <span class="o">?</span> <span class="s">&quot;Initiated&quot;</span> <span class="o">:</span> <span class="s">&quot;Not Initiated&quot;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;cancel-consistency-check&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	   <span class="n">DAC960_ParseLogicalDrive</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span>
				    <span class="o">&amp;</span><span class="n">LogicalDriveNumber</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ConsistencyCheck</span><span class="p">.</span><span class="n">LogicalDevice</span><span class="p">.</span><span class="n">LogicalDeviceNumber</span> <span class="o">=</span>
	<span class="n">LogicalDriveNumber</span><span class="p">;</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ConsistencyCheck</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span>
	<span class="n">DAC960_V2_ConsistencyCheckStop</span><span class="p">;</span>
      <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Consistency Check of Logical Drive %d &quot;</span>
			  <span class="s">&quot;(/dev/rd/c%dd%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">Controller</span><span class="p">,</span> <span class="n">LogicalDriveNumber</span><span class="p">,</span>
			  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">,</span>
			  <span class="n">LogicalDriveNumber</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span>
			   <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span>
			   <span class="o">?</span> <span class="s">&quot;Cancelled&quot;</span> <span class="o">:</span> <span class="s">&quot;Not Cancelled&quot;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;perform-discovery&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span> <span class="n">DAC960_V2_StartDiscovery</span><span class="p">;</span>
      <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
      <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Discovery %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span>
			   <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span>
			   <span class="o">?</span> <span class="s">&quot;Initiated&quot;</span> <span class="o">:</span> <span class="s">&quot;Not Initiated&quot;</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">DAC960_V2_NormalCompletion</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">DAC960_V2_IOCTL</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">CommandControlBits</span>
					<span class="p">.</span><span class="n">DataTransferControllerToHost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">CommandControlBits</span>
					<span class="p">.</span><span class="n">NoAutoRequestSense</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">DataTransferSize</span> <span class="o">=</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_ControllerInfo_T</span><span class="p">);</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">ControllerNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">IOCTL_Opcode</span> <span class="o">=</span>
	    <span class="n">DAC960_V2_GetControllerInfo</span><span class="p">;</span>
	  <span class="cm">/*</span>
<span class="cm">	   * How does this NOT race with the queued Monitoring</span>
<span class="cm">	   * usage of this structure?</span>
<span class="cm">	   */</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
					<span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
					<span class="p">.</span><span class="n">SegmentDataPointer</span> <span class="o">=</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewControllerInformationDMA</span><span class="p">;</span>
	  <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
					<span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
					<span class="p">.</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
	    <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">DataTransferSize</span><span class="p">;</span>
	  <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	  <span class="k">while</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">NewControllerInformation</span><span class="o">-&gt;</span><span class="n">PhysicalScanActive</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	      <span class="n">sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CommandWaitQueue</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Discovery Completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
 	<span class="p">}</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">,</span> <span class="s">&quot;suppress-enclosure-messages&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">SuppressEnclosureMessages</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">else</span> <span class="n">DAC960_UserCritical</span><span class="p">(</span><span class="s">&quot;Illegal User Command: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">Controller</span><span class="p">,</span> <span class="n">UserCommand</span><span class="p">);</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dac960_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">StatusMessage</span> <span class="o">=</span> <span class="s">&quot;OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ControllerNumber</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ControllerNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
       <span class="n">ControllerNumber</span> <span class="o">&lt;</span> <span class="n">DAC960_ControllerCount</span><span class="p">;</span>
       <span class="n">ControllerNumber</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">DAC960_Controllers</span><span class="p">[</span><span class="n">ControllerNumber</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">MonitoringAlertMode</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">StatusMessage</span> <span class="o">=</span> <span class="s">&quot;ALERT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
  <span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">StatusMessage</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dac960_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dac960_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dac960_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">dac960_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dac960_initial_status_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%.*s&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">InitialStatusLength</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CombinedStatusBuffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dac960_initial_status_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dac960_initial_status_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dac960_initial_status_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">dac960_initial_status_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dac960_current_status_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">StatusMessage</span> <span class="o">=</span>
    <span class="s">&quot;No Rebuild or Consistency Check in Progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ProgressMessageLength</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">StatusMessage</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">!=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LastCurrentStatusTime</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">DAC960_AnnounceDriver</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
      <span class="n">DAC960_ReportControllerConfiguration</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
      <span class="n">DAC960_ReportDeviceConfiguration</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ProgressBufferLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">ProgressMessageLength</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ProgressBufferLength</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">DAC960_CheckStatusBuffer</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ProgressMessageLength</span><span class="p">))</span>
	<span class="p">{</span>
	  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">CurrentStatusBuffer</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusBuffer</span><span class="p">;</span>
	  <span class="n">CurrentStatusBuffer</span><span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusLength</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	  <span class="n">CurrentStatusBuffer</span><span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusLength</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ProgressBufferLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="n">strcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CurrentStatusBuffer</span><span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusLength</span><span class="p">],</span>
		   <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ProgressBuffer</span><span class="p">);</span>
	  <span class="k">else</span>
	    <span class="n">strcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CurrentStatusBuffer</span><span class="p">[</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusLength</span><span class="p">],</span>
		   <span class="n">StatusMessage</span><span class="p">);</span>
	  <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusLength</span> <span class="o">+=</span> <span class="n">ProgressMessageLength</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">LastCurrentStatusTime</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
    <span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%.*s&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusLength</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CurrentStatusBuffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dac960_current_status_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dac960_current_status_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dac960_current_status_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">dac960_current_status_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dac960_user_command_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%.*s&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">UserStatusLength</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">UserStatusBuffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dac960_user_command_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dac960_user_command_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dac960_user_command_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">Buffer</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">Count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="p">)</span> <span class="n">PDE</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">CommandBuffer</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">Length</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Count</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CommandBuffer</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">CommandBuffer</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">,</span> <span class="n">Count</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
  <span class="n">CommandBuffer</span><span class="p">[</span><span class="n">Count</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
  <span class="n">Length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">CommandBuffer</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">CommandBuffer</span><span class="p">[</span><span class="n">Length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
    <span class="n">CommandBuffer</span><span class="p">[</span><span class="o">--</span><span class="n">Length</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">==</span> <span class="n">DAC960_V1_Controller</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">DAC960_V1_ExecuteUserCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">CommandBuffer</span><span class="p">)</span>
	    <span class="o">?</span> <span class="n">Count</span> <span class="o">:</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">DAC960_V2_ExecuteUserCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">,</span> <span class="n">CommandBuffer</span><span class="p">)</span>
	    <span class="o">?</span> <span class="n">Count</span> <span class="o">:</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dac960_user_command_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">dac960_user_command_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">dac960_user_command_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">  DAC960_CreateProcEntries creates the /proc/rd/... entries for the</span>
<span class="cm">  DAC960 Driver.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_CreateProcEntries</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">ControllerProcEntry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DAC960_ProcDirectoryEntry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DAC960_ProcDirectoryEntry</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;rd&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DAC960_ProcDirectoryEntry</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">dac960_proc_fops</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerName</span><span class="p">,</span> <span class="s">&quot;c%d&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">);</span>
	<span class="n">ControllerProcEntry</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerName</span><span class="p">,</span>
					 <span class="n">DAC960_ProcDirectoryEntry</span><span class="p">);</span>
	<span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;initial_status&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ControllerProcEntry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dac960_initial_status_proc_fops</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	<span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;current_status&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ControllerProcEntry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dac960_current_status_proc_fops</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	<span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;user_command&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">ControllerProcEntry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dac960_user_command_proc_fops</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
	<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerProcEntry</span> <span class="o">=</span> <span class="n">ControllerProcEntry</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  DAC960_DestroyProcEntries destroys the /proc/rd/... entries for the</span>
<span class="cm">  DAC960 Driver.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_DestroyProcEntries</span><span class="p">(</span><span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerProcEntry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	      <span class="k">return</span><span class="p">;</span>
      <span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;initial_status&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerProcEntry</span><span class="p">);</span>
      <span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;current_status&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerProcEntry</span><span class="p">);</span>
      <span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;user_command&quot;</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerProcEntry</span><span class="p">);</span>
      <span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerName</span><span class="p">,</span> <span class="n">DAC960_ProcDirectoryEntry</span><span class="p">);</span>
      <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ControllerProcEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DAC960_GAM_MINOR</span>

<span class="cm">/*</span>
<span class="cm"> * DAC960_gam_ioctl is the ioctl function for performing RAID operations.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">DAC960_gam_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Request</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">Argument</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">long</span> <span class="n">ErrorCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

  <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAC960_mutex</span><span class="p">);</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Request</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">DAC960_IOCTL_GET_CONTROLLER_COUNT</span>:
      <span class="n">ErrorCode</span> <span class="o">=</span> <span class="n">DAC960_ControllerCount</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DAC960_IOCTL_GET_CONTROLLER_INFO</span>:
      <span class="p">{</span>
	<span class="n">DAC960_ControllerInfo_T</span> <span class="n">__user</span> <span class="o">*</span><span class="n">UserSpaceControllerInfo</span> <span class="o">=</span>
	  <span class="p">(</span><span class="n">DAC960_ControllerInfo_T</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">Argument</span><span class="p">;</span>
	<span class="n">DAC960_ControllerInfo_T</span> <span class="n">ControllerInfo</span><span class="p">;</span>
	<span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ControllerNumber</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UserSpaceControllerInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="n">ErrorCode</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">ControllerNumber</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">UserSpaceControllerInfo</span><span class="o">-&gt;</span><span class="n">ControllerNumber</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ErrorCode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ControllerNumber</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ControllerNumber</span> <span class="o">&gt;</span> <span class="n">DAC960_ControllerCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">Controller</span> <span class="o">=</span> <span class="n">DAC960_Controllers</span><span class="p">[</span><span class="n">ControllerNumber</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Controller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ControllerInfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_ControllerInfo_T</span><span class="p">));</span>
	<span class="n">ControllerInfo</span><span class="p">.</span><span class="n">ControllerNumber</span> <span class="o">=</span> <span class="n">ControllerNumber</span><span class="p">;</span>
	<span class="n">ControllerInfo</span><span class="p">.</span><span class="n">FirmwareType</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareType</span><span class="p">;</span>
	<span class="n">ControllerInfo</span><span class="p">.</span><span class="n">Channels</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">;</span>
	<span class="n">ControllerInfo</span><span class="p">.</span><span class="n">Targets</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Targets</span><span class="p">;</span>
	<span class="n">ControllerInfo</span><span class="p">.</span><span class="n">PCI_Bus</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">;</span>
	<span class="n">ControllerInfo</span><span class="p">.</span><span class="n">PCI_Device</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Device</span><span class="p">;</span>
	<span class="n">ControllerInfo</span><span class="p">.</span><span class="n">PCI_Function</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">Function</span><span class="p">;</span>
	<span class="n">ControllerInfo</span><span class="p">.</span><span class="n">IRQ_Channel</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">IRQ_Channel</span><span class="p">;</span>
	<span class="n">ControllerInfo</span><span class="p">.</span><span class="n">PCI_Address</span> <span class="o">=</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCI_Address</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">ModelName</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">ModelName</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">ControllerInfo</span><span class="p">.</span><span class="n">FirmwareVersion</span><span class="p">,</span> <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareVersion</span><span class="p">);</span>
	<span class="n">ErrorCode</span> <span class="o">=</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">UserSpaceControllerInfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ControllerInfo</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_ControllerInfo_T</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="k">case</span> <span class="n">DAC960_IOCTL_V1_EXECUTE_COMMAND</span>:
      <span class="p">{</span>
	<span class="n">DAC960_V1_UserCommand_T</span> <span class="n">__user</span> <span class="o">*</span><span class="n">UserSpaceUserCommand</span> <span class="o">=</span>
	  <span class="p">(</span><span class="n">DAC960_V1_UserCommand_T</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">Argument</span><span class="p">;</span>
	<span class="n">DAC960_V1_UserCommand_T</span> <span class="n">UserCommand</span><span class="p">;</span>
	<span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">;</span>
	<span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">DAC960_V1_CommandOpcode_T</span> <span class="n">CommandOpcode</span><span class="p">;</span>
	<span class="n">DAC960_V1_CommandStatus_T</span> <span class="n">CommandStatus</span><span class="p">;</span>
	<span class="n">DAC960_V1_DCDB_T</span> <span class="n">DCDB</span><span class="p">;</span>
	<span class="n">DAC960_V1_DCDB_T</span> <span class="o">*</span><span class="n">DCDB_IOBUF</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">DCDB_IOBUFDMA</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ControllerNumber</span><span class="p">,</span> <span class="n">DataTransferLength</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">DataTransferBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">DataTransferBufferDMA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UserSpaceUserCommand</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">,</span> <span class="n">UserSpaceUserCommand</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_UserCommand_T</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ControllerNumber</span> <span class="o">=</span> <span class="n">UserCommand</span><span class="p">.</span><span class="n">ControllerNumber</span><span class="p">;</span>
    	<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ControllerNumber</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ControllerNumber</span> <span class="o">&gt;</span> <span class="n">DAC960_ControllerCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
	    	<span class="k">break</span><span class="p">;</span>
	<span class="n">Controller</span> <span class="o">=</span> <span class="n">DAC960_Controllers</span><span class="p">[</span><span class="n">ControllerNumber</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Controller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">!=</span> <span class="n">DAC960_V1_Controller</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="n">CommandOpcode</span> <span class="o">=</span> <span class="n">UserCommand</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandOpcode</span><span class="p">;</span>
	<span class="n">DataTransferLength</span> <span class="o">=</span> <span class="n">UserCommand</span><span class="p">.</span><span class="n">DataTransferLength</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CommandOpcode</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CommandOpcode</span> <span class="o">==</span> <span class="n">DAC960_V1_DCDB</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DCDB</span><span class="p">,</span> <span class="n">UserCommand</span><span class="p">.</span><span class="n">DCDB</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_DCDB_T</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">DCDB</span><span class="p">.</span><span class="n">Channel</span> <span class="o">&gt;=</span> <span class="n">DAC960_V1_MaxChannels</span><span class="p">)</span>
	    		<span class="k">break</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">DataTransferLength</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		   <span class="n">DCDB</span><span class="p">.</span><span class="n">Direction</span>
		   <span class="o">==</span> <span class="n">DAC960_V1_DCDB_NoDataTransfer</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">DataTransferLength</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		   <span class="n">DCDB</span><span class="p">.</span><span class="n">Direction</span>
		   <span class="o">==</span> <span class="n">DAC960_V1_DCDB_DataTransferDeviceToSystem</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">DataTransferLength</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		   <span class="n">DCDB</span><span class="p">.</span><span class="n">Direction</span>
		   <span class="o">==</span> <span class="n">DAC960_V1_DCDB_DataTransferSystemToDevice</span><span class="p">)))</span>
		   	<span class="k">break</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(((</span><span class="n">DCDB</span><span class="p">.</span><span class="n">TransferLengthHigh4</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">DCDB</span><span class="p">.</span><span class="n">TransferLength</span><span class="p">)</span>
		<span class="o">!=</span> <span class="n">abs</span><span class="p">(</span><span class="n">DataTransferLength</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	    <span class="n">DCDB_IOBUF</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_DCDB_T</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">DCDB_IOBUFDMA</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">DCDB_IOBUF</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	    		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	  <span class="p">}</span>
	<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DataTransferLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="n">DataTransferBuffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span>
				<span class="n">DataTransferLength</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DataTransferBufferDMA</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">DataTransferBuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	    	<span class="k">break</span><span class="p">;</span>
	    <span class="n">memset</span><span class="p">(</span><span class="n">DataTransferBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DataTransferLength</span><span class="p">);</span>
	  <span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">DataTransferLength</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="n">DataTransferBuffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span>
				<span class="o">-</span><span class="n">DataTransferLength</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DataTransferBufferDMA</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">DataTransferBuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	    	<span class="k">break</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">DataTransferBuffer</span><span class="p">,</span>
			       <span class="n">UserCommand</span><span class="p">.</span><span class="n">DataTransferBuffer</span><span class="p">,</span>
			       <span class="o">-</span><span class="n">DataTransferLength</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CommandOpcode</span> <span class="o">==</span> <span class="n">DAC960_V1_DCDB</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	    <span class="k">while</span> <span class="p">((</span><span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	      <span class="n">DAC960_WaitForCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
	    <span class="k">while</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DirectCommandActive</span><span class="p">[</span><span class="n">DCDB</span><span class="p">.</span><span class="n">Channel</span><span class="p">]</span>
						     <span class="p">[</span><span class="n">DCDB</span><span class="p">.</span><span class="n">TargetID</span><span class="p">])</span>
	      <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
		<span class="n">__wait_event</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">CommandWaitQueue</span><span class="p">,</span>
			     <span class="o">!</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DirectCommandActive</span>
					     <span class="p">[</span><span class="n">DCDB</span><span class="p">.</span><span class="n">Channel</span><span class="p">][</span><span class="n">DCDB</span><span class="p">.</span><span class="n">TargetID</span><span class="p">]);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	      <span class="p">}</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DirectCommandActive</span><span class="p">[</span><span class="n">DCDB</span><span class="p">.</span><span class="n">Channel</span><span class="p">]</span>
					      <span class="p">[</span><span class="n">DCDB</span><span class="p">.</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	    <span class="n">DAC960_V1_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	    <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">;</span>
	    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">,</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_CommandMailbox_T</span><span class="p">));</span>
	    <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span> <span class="n">DCDB_IOBUFDMA</span><span class="p">;</span>
	    <span class="n">DCDB</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span> <span class="n">DataTransferBufferDMA</span><span class="p">;</span>
	    <span class="n">memcpy</span><span class="p">(</span><span class="n">DCDB_IOBUF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DCDB</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_DCDB_T</span><span class="p">));</span>
	  <span class="p">}</span>
	<span class="k">else</span>
	  <span class="p">{</span>
	    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	    <span class="k">while</span> <span class="p">((</span><span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	      <span class="n">DAC960_WaitForCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
	    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	    <span class="n">DAC960_V1_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	    <span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">;</span>
	    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">,</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_CommandMailbox_T</span><span class="p">));</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">DataTransferBuffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	      <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">.</span><span class="n">Type3</span><span class="p">.</span><span class="n">BusAddress</span> <span class="o">=</span>
		<span class="n">DataTransferBufferDMA</span><span class="p">;</span>
	  <span class="p">}</span>
	<span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	<span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DataTransferLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">.</span><span class="n">DataTransferBuffer</span><span class="p">,</span>
			     <span class="n">DataTransferBuffer</span><span class="p">,</span> <span class="n">DataTransferLength</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Failure1</span><span class="p">;</span>
            <span class="p">}</span>
	  <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CommandOpcode</span> <span class="o">==</span> <span class="n">DAC960_V1_DCDB</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="cm">/*</span>
<span class="cm">	      I don&#39;t believe Target or Channel in the DCDB_IOBUF</span>
<span class="cm">	      should be any different from the contents of DCDB.</span>
<span class="cm">	     */</span>
	    <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V1</span><span class="p">.</span><span class="n">DirectCommandActive</span><span class="p">[</span><span class="n">DCDB</span><span class="p">.</span><span class="n">Channel</span><span class="p">]</span>
					      <span class="p">[</span><span class="n">DCDB</span><span class="p">.</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">.</span><span class="n">DCDB</span><span class="p">,</span> <span class="n">DCDB_IOBUF</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_DCDB_T</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Failure1</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="p">}</span>
	<span class="n">ErrorCode</span> <span class="o">=</span> <span class="n">CommandStatus</span><span class="p">;</span>
      <span class="nl">Failure1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DataTransferBuffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	  <span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="n">abs</span><span class="p">(</span><span class="n">DataTransferLength</span><span class="p">),</span>
			<span class="n">DataTransferBuffer</span><span class="p">,</span> <span class="n">DataTransferBufferDMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DCDB_IOBUF</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	  <span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V1_DCDB_T</span><span class="p">),</span>
			<span class="n">DCDB_IOBUF</span><span class="p">,</span> <span class="n">DCDB_IOBUFDMA</span><span class="p">);</span>
      	<span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="k">case</span> <span class="n">DAC960_IOCTL_V2_EXECUTE_COMMAND</span>:
      <span class="p">{</span>
	<span class="n">DAC960_V2_UserCommand_T</span> <span class="n">__user</span> <span class="o">*</span><span class="n">UserSpaceUserCommand</span> <span class="o">=</span>
	  <span class="p">(</span><span class="n">DAC960_V2_UserCommand_T</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">Argument</span><span class="p">;</span>
	<span class="n">DAC960_V2_UserCommand_T</span> <span class="n">UserCommand</span><span class="p">;</span>
	<span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">;</span>
	<span class="n">DAC960_Command_T</span> <span class="o">*</span><span class="n">Command</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">DAC960_V2_CommandMailbox_T</span> <span class="o">*</span><span class="n">CommandMailbox</span><span class="p">;</span>
	<span class="n">DAC960_V2_CommandStatus_T</span> <span class="n">CommandStatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ControllerNumber</span><span class="p">,</span> <span class="n">DataTransferLength</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">DataTransferResidue</span><span class="p">,</span> <span class="n">RequestSenseLength</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">DataTransferBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">DataTransferBufferDMA</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">RequestSenseBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">RequestSenseBufferDMA</span><span class="p">;</span>

	<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UserSpaceUserCommand</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">,</span> <span class="n">UserSpaceUserCommand</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_UserCommand_T</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">ControllerNumber</span> <span class="o">=</span> <span class="n">UserCommand</span><span class="p">.</span><span class="n">ControllerNumber</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ControllerNumber</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ControllerNumber</span> <span class="o">&gt;</span> <span class="n">DAC960_ControllerCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
	    	<span class="k">break</span><span class="p">;</span>
	<span class="n">Controller</span> <span class="o">=</span> <span class="n">DAC960_Controllers</span><span class="p">[</span><span class="n">ControllerNumber</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Controller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">!=</span> <span class="n">DAC960_V2_Controller</span><span class="p">){</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DataTransferLength</span> <span class="o">=</span> <span class="n">UserCommand</span><span class="p">.</span><span class="n">DataTransferLength</span><span class="p">;</span>
    	<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DataTransferLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="n">DataTransferBuffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span>
				<span class="n">DataTransferLength</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DataTransferBufferDMA</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">DataTransferBuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	    	<span class="k">break</span><span class="p">;</span>
	    <span class="n">memset</span><span class="p">(</span><span class="n">DataTransferBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DataTransferLength</span><span class="p">);</span>
	  <span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">DataTransferLength</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="n">DataTransferBuffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span>
				<span class="o">-</span><span class="n">DataTransferLength</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DataTransferBufferDMA</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">DataTransferBuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	    	<span class="k">break</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">DataTransferBuffer</span><span class="p">,</span>
			       <span class="n">UserCommand</span><span class="p">.</span><span class="n">DataTransferBuffer</span><span class="p">,</span>
			       <span class="o">-</span><span class="n">DataTransferLength</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Failure2</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="p">}</span>
	<span class="n">RequestSenseLength</span> <span class="o">=</span> <span class="n">UserCommand</span><span class="p">.</span><span class="n">RequestSenseLength</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RequestSenseLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="n">RequestSenseBuffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span>
			<span class="n">RequestSenseLength</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RequestSenseBufferDMA</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">RequestSenseBuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	      <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Failure2</span><span class="p">;</span>
	      <span class="p">}</span>
	    <span class="n">memset</span><span class="p">(</span><span class="n">RequestSenseBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RequestSenseLength</span><span class="p">);</span>
	  <span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">Command</span> <span class="o">=</span> <span class="n">DAC960_AllocateCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	  <span class="n">DAC960_WaitForCommand</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">DAC960_V2_ClearCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	<span class="n">Command</span><span class="o">-&gt;</span><span class="n">CommandType</span> <span class="o">=</span> <span class="n">DAC960_ImmediateCommand</span><span class="p">;</span>
	<span class="n">CommandMailbox</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">CommandMailbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserCommand</span><span class="p">.</span><span class="n">CommandMailbox</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_CommandMailbox_T</span><span class="p">));</span>
	<span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandControlBits</span>
			      <span class="p">.</span><span class="n">AdditionalScatterGatherListMemory</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandControlBits</span>
			      <span class="p">.</span><span class="n">NoAutoRequestSense</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">DataTransferSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">DataTransferPageNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_DataTransferMemoryAddress_T</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DataTransferLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">DataTransferLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	      <span class="p">{</span>
		<span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandControlBits</span>
				      <span class="p">.</span><span class="n">DataTransferControllerToHost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">DataTransferSize</span> <span class="o">=</span> <span class="n">DataTransferLength</span><span class="p">;</span>
	      <span class="p">}</span>
	    <span class="k">else</span>
	      <span class="p">{</span>
		<span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandControlBits</span>
				      <span class="p">.</span><span class="n">DataTransferControllerToHost</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">DataTransferSize</span> <span class="o">=</span> <span class="o">-</span><span class="n">DataTransferLength</span><span class="p">;</span>
	      <span class="p">}</span>
	    <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
				  <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				  <span class="p">.</span><span class="n">SegmentDataPointer</span> <span class="o">=</span> <span class="n">DataTransferBufferDMA</span><span class="p">;</span>
	    <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">DataTransferMemoryAddress</span>
				  <span class="p">.</span><span class="n">ScatterGatherSegments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				  <span class="p">.</span><span class="n">SegmentByteCount</span> <span class="o">=</span>
	      <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">DataTransferSize</span><span class="p">;</span>
	  <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RequestSenseLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">CommandControlBits</span>
				  <span class="p">.</span><span class="n">NoAutoRequestSense</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	    <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">RequestSenseSize</span> <span class="o">=</span> <span class="n">RequestSenseLength</span><span class="p">;</span>
	    <span class="n">CommandMailbox</span><span class="o">-&gt;</span><span class="n">Common</span><span class="p">.</span><span class="n">RequestSenseBusAddress</span> <span class="o">=</span>
	      						<span class="n">RequestSenseBufferDMA</span><span class="p">;</span>
	  <span class="p">}</span>
	<span class="n">DAC960_ExecuteCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	<span class="n">CommandStatus</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">CommandStatus</span><span class="p">;</span>
	<span class="n">RequestSenseLength</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">RequestSenseLength</span><span class="p">;</span>
	<span class="n">DataTransferResidue</span> <span class="o">=</span> <span class="n">Command</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">DataTransferResidue</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">DAC960_DeallocateCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RequestSenseLength</span> <span class="o">&gt;</span> <span class="n">UserCommand</span><span class="p">.</span><span class="n">RequestSenseLength</span><span class="p">)</span>
	  <span class="n">RequestSenseLength</span> <span class="o">=</span> <span class="n">UserCommand</span><span class="p">.</span><span class="n">RequestSenseLength</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">UserSpaceUserCommand</span><span class="o">-&gt;</span><span class="n">DataTransferLength</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">DataTransferResidue</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">DataTransferResidue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Failure2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">UserSpaceUserCommand</span><span class="o">-&gt;</span><span class="n">RequestSenseLength</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">RequestSenseLength</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RequestSenseLength</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Failure2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DataTransferLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">.</span><span class="n">DataTransferBuffer</span><span class="p">,</span>
			     <span class="n">DataTransferBuffer</span><span class="p">,</span> <span class="n">DataTransferLength</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Failure2</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RequestSenseLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">UserCommand</span><span class="p">.</span><span class="n">RequestSenseBuffer</span><span class="p">,</span>
			     <span class="n">RequestSenseBuffer</span><span class="p">,</span> <span class="n">RequestSenseLength</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Failure2</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="p">}</span>
	<span class="n">ErrorCode</span> <span class="o">=</span> <span class="n">CommandStatus</span><span class="p">;</span>
      <span class="nl">Failure2:</span>
	  <span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="n">abs</span><span class="p">(</span><span class="n">DataTransferLength</span><span class="p">),</span>
		<span class="n">DataTransferBuffer</span><span class="p">,</span> <span class="n">DataTransferBufferDMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RequestSenseBuffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	  <span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">PCIDevice</span><span class="p">,</span> <span class="n">RequestSenseLength</span><span class="p">,</span>
		<span class="n">RequestSenseBuffer</span><span class="p">,</span> <span class="n">RequestSenseBufferDMA</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="k">case</span> <span class="n">DAC960_IOCTL_V2_GET_HEALTH_STATUS</span>:
      <span class="p">{</span>
	<span class="n">DAC960_V2_GetHealthStatus_T</span> <span class="n">__user</span> <span class="o">*</span><span class="n">UserSpaceGetHealthStatus</span> <span class="o">=</span>
	  <span class="p">(</span><span class="n">DAC960_V2_GetHealthStatus_T</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">Argument</span><span class="p">;</span>
	<span class="n">DAC960_V2_GetHealthStatus_T</span> <span class="n">GetHealthStatus</span><span class="p">;</span>
	<span class="n">DAC960_V2_HealthStatusBuffer_T</span> <span class="n">HealthStatusBuffer</span><span class="p">;</span>
	<span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ControllerNumber</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UserSpaceGetHealthStatus</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GetHealthStatus</span><span class="p">,</span> <span class="n">UserSpaceGetHealthStatus</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_GetHealthStatus_T</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">ControllerNumber</span> <span class="o">=</span> <span class="n">GetHealthStatus</span><span class="p">.</span><span class="n">ControllerNumber</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ControllerNumber</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ControllerNumber</span> <span class="o">&gt;</span> <span class="n">DAC960_ControllerCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		    <span class="k">break</span><span class="p">;</span>
	<span class="n">Controller</span> <span class="o">=</span> <span class="n">DAC960_Controllers</span><span class="p">[</span><span class="n">ControllerNumber</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Controller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">FirmwareType</span> <span class="o">!=</span> <span class="n">DAC960_V2_Controller</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HealthStatusBuffer</span><span class="p">,</span>
			   <span class="n">GetHealthStatus</span><span class="p">.</span><span class="n">HealthStatusBuffer</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_HealthStatusBuffer_T</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">HealthStatusBuffer</span><span class="o">-&gt;</span><span class="n">StatusChangeCounter</span>
	       <span class="o">==</span> <span class="n">HealthStatusBuffer</span><span class="p">.</span><span class="n">StatusChangeCounter</span> <span class="o">&amp;&amp;</span>
	       <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">HealthStatusBuffer</span><span class="o">-&gt;</span><span class="n">NextEventSequenceNumber</span>
	       <span class="o">==</span> <span class="n">HealthStatusBuffer</span><span class="p">.</span><span class="n">NextEventSequenceNumber</span><span class="p">)</span>
	  <span class="p">{</span>
	    <span class="n">interruptible_sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">HealthStatusWaitQueue</span><span class="p">,</span>
					   <span class="n">DAC960_MonitoringTimerInterval</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
	    	<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	    	<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">GetHealthStatus</span><span class="p">.</span><span class="n">HealthStatusBuffer</span><span class="p">,</span>
			 <span class="n">Controller</span><span class="o">-&gt;</span><span class="n">V2</span><span class="p">.</span><span class="n">HealthStatusBuffer</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">DAC960_V2_HealthStatusBuffer_T</span><span class="p">)))</span>
		<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ErrorCode</span> <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nl">default:</span>
	<span class="n">ErrorCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAC960_mutex</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ErrorCode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">DAC960_gam_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">DAC960_gam_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">DAC960_gam_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DAC960_GAM_MINOR</span><span class="p">,</span>
	<span class="s">&quot;dac960_gam&quot;</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">DAC960_gam_fops</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DAC960_gam_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAC960_gam_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DAC960_gam: can&#39;t misc_register on minor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DAC960_GAM_MINOR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DAC960_gam_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAC960_gam_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* DAC960_GAM_MINOR */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">DAC960_privdata</span> <span class="n">DAC960_GEM_privdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">HardwareType</span> <span class="o">=</span>		<span class="n">DAC960_GEM_Controller</span><span class="p">,</span>
	<span class="p">.</span><span class="n">FirmwareType</span> 	<span class="o">=</span>	<span class="n">DAC960_V2_Controller</span><span class="p">,</span>
	<span class="p">.</span><span class="n">InterruptHandler</span> <span class="o">=</span>	<span class="n">DAC960_GEM_InterruptHandler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">MemoryWindowSize</span> <span class="o">=</span>	<span class="n">DAC960_GEM_RegisterWindowSize</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">DAC960_privdata</span> <span class="n">DAC960_BA_privdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">HardwareType</span> <span class="o">=</span>		<span class="n">DAC960_BA_Controller</span><span class="p">,</span>
	<span class="p">.</span><span class="n">FirmwareType</span> 	<span class="o">=</span>	<span class="n">DAC960_V2_Controller</span><span class="p">,</span>
	<span class="p">.</span><span class="n">InterruptHandler</span> <span class="o">=</span>	<span class="n">DAC960_BA_InterruptHandler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">MemoryWindowSize</span> <span class="o">=</span>	<span class="n">DAC960_BA_RegisterWindowSize</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">DAC960_privdata</span> <span class="n">DAC960_LP_privdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">HardwareType</span> <span class="o">=</span>		<span class="n">DAC960_LP_Controller</span><span class="p">,</span>
	<span class="p">.</span><span class="n">FirmwareType</span> 	<span class="o">=</span>	<span class="n">DAC960_V2_Controller</span><span class="p">,</span>
	<span class="p">.</span><span class="n">InterruptHandler</span> <span class="o">=</span>	<span class="n">DAC960_LP_InterruptHandler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">MemoryWindowSize</span> <span class="o">=</span>	<span class="n">DAC960_LP_RegisterWindowSize</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">DAC960_privdata</span> <span class="n">DAC960_LA_privdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">HardwareType</span> <span class="o">=</span>		<span class="n">DAC960_LA_Controller</span><span class="p">,</span>
	<span class="p">.</span><span class="n">FirmwareType</span> 	<span class="o">=</span>	<span class="n">DAC960_V1_Controller</span><span class="p">,</span>
	<span class="p">.</span><span class="n">InterruptHandler</span> <span class="o">=</span>	<span class="n">DAC960_LA_InterruptHandler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">MemoryWindowSize</span> <span class="o">=</span>	<span class="n">DAC960_LA_RegisterWindowSize</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">DAC960_privdata</span> <span class="n">DAC960_PG_privdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">HardwareType</span> <span class="o">=</span>		<span class="n">DAC960_PG_Controller</span><span class="p">,</span>
	<span class="p">.</span><span class="n">FirmwareType</span> 	<span class="o">=</span>	<span class="n">DAC960_V1_Controller</span><span class="p">,</span>
	<span class="p">.</span><span class="n">InterruptHandler</span> <span class="o">=</span>	<span class="n">DAC960_PG_InterruptHandler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">MemoryWindowSize</span> <span class="o">=</span>	<span class="n">DAC960_PG_RegisterWindowSize</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">DAC960_privdata</span> <span class="n">DAC960_PD_privdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">HardwareType</span> <span class="o">=</span>		<span class="n">DAC960_PD_Controller</span><span class="p">,</span>
	<span class="p">.</span><span class="n">FirmwareType</span> 	<span class="o">=</span>	<span class="n">DAC960_V1_Controller</span><span class="p">,</span>
	<span class="p">.</span><span class="n">InterruptHandler</span> <span class="o">=</span>	<span class="n">DAC960_PD_InterruptHandler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">MemoryWindowSize</span> <span class="o">=</span>	<span class="n">DAC960_PD_RegisterWindowSize</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">DAC960_privdata</span> <span class="n">DAC960_P_privdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">HardwareType</span> <span class="o">=</span>		<span class="n">DAC960_P_Controller</span><span class="p">,</span>
	<span class="p">.</span><span class="n">FirmwareType</span> 	<span class="o">=</span>	<span class="n">DAC960_V1_Controller</span><span class="p">,</span>
	<span class="p">.</span><span class="n">InterruptHandler</span> <span class="o">=</span>	<span class="n">DAC960_P_InterruptHandler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">MemoryWindowSize</span> <span class="o">=</span>	<span class="n">DAC960_PD_RegisterWindowSize</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">DAC960_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> 	<span class="o">=</span> <span class="n">PCI_VENDOR_ID_MYLEX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_MYLEX_DAC960_GEM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_VENDOR_ID_MYLEX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">DAC960_GEM_privdata</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> 	<span class="o">=</span> <span class="n">PCI_VENDOR_ID_MYLEX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_MYLEX_DAC960_BA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">DAC960_BA_privdata</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> 	<span class="o">=</span> <span class="n">PCI_VENDOR_ID_MYLEX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_MYLEX_DAC960_LP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">DAC960_LP_privdata</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> 	<span class="o">=</span> <span class="n">PCI_VENDOR_ID_DEC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_DEC_21285</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_VENDOR_ID_MYLEX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_DEVICE_ID_MYLEX_DAC960_LA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">DAC960_LA_privdata</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> 	<span class="o">=</span> <span class="n">PCI_VENDOR_ID_MYLEX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_MYLEX_DAC960_PG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">DAC960_PG_privdata</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> 	<span class="o">=</span> <span class="n">PCI_VENDOR_ID_MYLEX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_MYLEX_DAC960_PD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">DAC960_PD_privdata</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> 	<span class="o">=</span> <span class="n">PCI_VENDOR_ID_MYLEX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_MYLEX_DAC960_P</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">DAC960_P_privdata</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DAC960_id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">DAC960_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;DAC960&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">DAC960_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">DAC960_Probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">DAC960_Remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">DAC960_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span>  <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAC960_pci_driver</span><span class="p">);</span>
<span class="cp">#ifdef DAC960_GAM_MINOR</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">DAC960_gam_init</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">DAC960_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef DAC960_GAM_MINOR</span>
	<span class="n">DAC960_gam_cleanup</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DAC960_ControllerCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DAC960_Controller_T</span> <span class="o">*</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">DAC960_Controllers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Controller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">DAC960_FinalizeController</span><span class="p">(</span><span class="n">Controller</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DAC960_ProcDirectoryEntry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
  		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;rd/status&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;rd&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DAC960_ControllerCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAC960_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">DAC960_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">DAC960_cleanup_module</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
