<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › cciss.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>cciss.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *    Disk Array driver for HP Smart Array controllers.</span>
<span class="cm"> *    (C) Copyright 2000, 2007 Hewlett-Packard Development Company, L.P.</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *    it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *    the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
<span class="cm"> *    General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *    You should have received a copy of the GNU General Public License</span>
<span class="cm"> *    along with this program; if not, write to the Free Software</span>
<span class="cm"> *    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="cm"> *    02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *    Questions/Comments/Bugfixes to iss_storagedev@hp.com</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pci-aspm.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/bio.h&gt;</span>
<span class="cp">#include &lt;linux/blkpg.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/genhd.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/sg.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/cdrom.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>

<span class="cp">#define CCISS_DRIVER_VERSION(maj,min,submin) ((maj&lt;&lt;16)|(min&lt;&lt;8)|(submin))</span>
<span class="cp">#define DRIVER_NAME &quot;HP CISS Driver (v 3.6.26)&quot;</span>
<span class="cp">#define DRIVER_VERSION CCISS_DRIVER_VERSION(3, 6, 26)</span>

<span class="cm">/* Embedded module documentation macros - see modules.h */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Hewlett-Packard Company&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for HP Smart Array Controllers&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;HP Smart Array Controllers&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;3.6.26&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_tape_cmds</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cciss_tape_cmds</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cciss_tape_cmds</span><span class="p">,</span>
	<span class="s">&quot;number of commands to allocate for tape devices (default: 6)&quot;</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_simple_mode</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cciss_simple_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cciss_simple_mode</span><span class="p">,</span>
	<span class="s">&quot;Use &#39;simple mode&#39; rather than &#39;performant mode&#39;&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">cciss_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">proc_cciss</span><span class="p">;</span>

<span class="cp">#include &quot;cciss_cmd.h&quot;</span>
<span class="cp">#include &quot;cciss.h&quot;</span>
<span class="cp">#include &lt;linux/cciss_ioctl.h&gt;</span>

<span class="cm">/* define the PCI info for the cards we can control */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">cciss_pci_device_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_CISS</span><span class="p">,</span>  <span class="mh">0x0E11</span><span class="p">,</span> <span class="mh">0x4070</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_CISSB</span><span class="p">,</span> <span class="mh">0x0E11</span><span class="p">,</span> <span class="mh">0x4080</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_CISSB</span><span class="p">,</span> <span class="mh">0x0E11</span><span class="p">,</span> <span class="mh">0x4082</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_CISSB</span><span class="p">,</span> <span class="mh">0x0E11</span><span class="p">,</span> <span class="mh">0x4083</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_CISSC</span><span class="p">,</span> <span class="mh">0x0E11</span><span class="p">,</span> <span class="mh">0x4091</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_CISSC</span><span class="p">,</span> <span class="mh">0x0E11</span><span class="p">,</span> <span class="mh">0x409A</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_CISSC</span><span class="p">,</span> <span class="mh">0x0E11</span><span class="p">,</span> <span class="mh">0x409B</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_CISSC</span><span class="p">,</span> <span class="mh">0x0E11</span><span class="p">,</span> <span class="mh">0x409C</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_COMPAQ</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPAQ_CISSC</span><span class="p">,</span> <span class="mh">0x0E11</span><span class="p">,</span> <span class="mh">0x409D</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_HP</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_HP_CISSA</span><span class="p">,</span>     <span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x3225</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_HP</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_HP_CISSC</span><span class="p">,</span>     <span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x3223</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_HP</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_HP_CISSC</span><span class="p">,</span>     <span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x3234</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_HP</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_HP_CISSC</span><span class="p">,</span>     <span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x3235</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_HP</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_HP_CISSD</span><span class="p">,</span>     <span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x3211</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_HP</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_HP_CISSD</span><span class="p">,</span>     <span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x3212</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_HP</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_HP_CISSD</span><span class="p">,</span>     <span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x3213</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_HP</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_HP_CISSD</span><span class="p">,</span>     <span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x3214</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_HP</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_HP_CISSD</span><span class="p">,</span>     <span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x3215</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_HP</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_HP_CISSC</span><span class="p">,</span>     <span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x3237</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_HP</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_HP_CISSC</span><span class="p">,</span>     <span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x323D</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">cciss_pci_device_id</span><span class="p">);</span>

<span class="cm">/*  board_id = Subsystem Device ID &amp; Vendor ID</span>
<span class="cm"> *  product = Marketing Name for the board</span>
<span class="cm"> *  access = Address of the struct of function pointers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">board_type</span> <span class="n">products</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x40700E11</span><span class="p">,</span> <span class="s">&quot;Smart Array 5300&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x40800E11</span><span class="p">,</span> <span class="s">&quot;Smart Array 5i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5B_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x40820E11</span><span class="p">,</span> <span class="s">&quot;Smart Array 532&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5B_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x40830E11</span><span class="p">,</span> <span class="s">&quot;Smart Array 5312&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5B_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x409A0E11</span><span class="p">,</span> <span class="s">&quot;Smart Array 641&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x409B0E11</span><span class="p">,</span> <span class="s">&quot;Smart Array 642&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x409C0E11</span><span class="p">,</span> <span class="s">&quot;Smart Array 6400&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x409D0E11</span><span class="p">,</span> <span class="s">&quot;Smart Array 6400 EM&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x40910E11</span><span class="p">,</span> <span class="s">&quot;Smart Array 6i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x3225103C</span><span class="p">,</span> <span class="s">&quot;Smart Array P600&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x3223103C</span><span class="p">,</span> <span class="s">&quot;Smart Array P800&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x3234103C</span><span class="p">,</span> <span class="s">&quot;Smart Array P400&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x3235103C</span><span class="p">,</span> <span class="s">&quot;Smart Array P400i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x3211103C</span><span class="p">,</span> <span class="s">&quot;Smart Array E200i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x3212103C</span><span class="p">,</span> <span class="s">&quot;Smart Array E200&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x3213103C</span><span class="p">,</span> <span class="s">&quot;Smart Array E200i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x3214103C</span><span class="p">,</span> <span class="s">&quot;Smart Array E200i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x3215103C</span><span class="p">,</span> <span class="s">&quot;Smart Array E200i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x3237103C</span><span class="p">,</span> <span class="s">&quot;Smart Array E500&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x3223103C</span><span class="p">,</span> <span class="s">&quot;Smart Array P800&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x3234103C</span><span class="p">,</span> <span class="s">&quot;Smart Array P400&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x323D103C</span><span class="p">,</span> <span class="s">&quot;Smart Array P700m&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SA5_access</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* How long to wait (in milliseconds) for board to go into simple mode */</span>
<span class="cp">#define MAX_CONFIG_WAIT 30000</span>
<span class="cp">#define MAX_IOCTL_CONFIG_WAIT 1000</span>

<span class="cm">/*define how many times we will try a command because of bus resets */</span>
<span class="cp">#define MAX_CMD_RETRIES 3</span>

<span class="cp">#define MAX_CTLR	32</span>

<span class="cm">/* Originally cciss driver only supports 8 major numbers */</span>
<span class="cp">#define MAX_CTLR_ORIG 	8</span>

<span class="k">static</span> <span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">hba</span><span class="p">[</span><span class="n">MAX_CTLR</span><span class="p">];</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">cciss_scan_thread</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">scan_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">scan_q</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">do_cciss_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">do_cciss_intx</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">do_cciss_msix_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_unlocked_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_revalidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rebuild_lun_table</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first_time</span><span class="p">,</span> <span class="kt">int</span> <span class="n">via_ioctl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">deregister_disk</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">drv_index</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">clear_all</span><span class="p">,</span> <span class="kt">int</span> <span class="n">via_ioctl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cciss_read_capacity</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">logvol</span><span class="p">,</span>
			<span class="n">sector_t</span> <span class="o">*</span><span class="n">total_size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">block_size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cciss_read_capacity_16</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">logvol</span><span class="p">,</span>
			<span class="n">sector_t</span> <span class="o">*</span><span class="n">total_size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">block_size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cciss_geometry_inquiry</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">logvol</span><span class="p">,</span>
			<span class="n">sector_t</span> <span class="n">total_size</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">InquiryData_struct</span> <span class="o">*</span><span class="n">inq_buff</span><span class="p">,</span>
				   <span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="n">cciss_interrupt_mode</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">cciss_enter_simple_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">start_io</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sendcmd_withirq</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			<span class="n">__u8</span> <span class="n">page_code</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsi3addr</span><span class="p">[],</span>
			<span class="kt">int</span> <span class="n">cmd_type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sendcmd_withirq_core</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">attempt_retry</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">process_sendcmd_error</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">add_to_scan_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scan_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">check_for_unit_attention</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cciss_hba_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cciss_device_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cciss_free_gendisk</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">drv_index</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cciss_free_drive_info</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">drv_index</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="n">next_command</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">cciss_find_cfg_addrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">cfg_base_addr</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">cfg_base_addr_index</span><span class="p">,</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">cfg_offset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">cciss_pci_find_memory_BAR</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">memory_bar</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="n">cciss_tag_discard_error_bits</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tag</span><span class="p">);</span>
<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="n">write_driver_ver_to_cfgtable</span><span class="p">(</span>
	<span class="n">CfgTable_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cfgtable</span><span class="p">);</span>

<span class="cm">/* performant mode helper functions */</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">calc_bucket_map</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">bucket</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_buckets</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nsgs</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">bucket_map</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cciss_put_controller_into_performant_mode</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cciss_procinit</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_procinit</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">fmode_t</span><span class="p">,</span>
			      <span class="kt">unsigned</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">cciss_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">cciss_unlocked_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">cciss_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">do_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getgeo</span> <span class="o">=</span> <span class="n">cciss_getgeo</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">cciss_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">revalidate_disk</span> <span class="o">=</span> <span class="n">cciss_revalidate</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* set_performant_mode: Modify the tag for cciss performant</span>
<span class="cm"> * set bit 0 for pull model, bits 3-1 for block fetch</span>
<span class="cm"> * register number</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_performant_mode</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transMethod</span> <span class="o">&amp;</span> <span class="n">CFGTBL_Trans_Performant</span><span class="p">))</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">|</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">blockFetchTable</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGList</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enqueuing and dequeuing functions for cmdlists.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">addQ</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">removeQ</span><span class="p">(</span><span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * After kexec/dump some commands might still</span>
<span class="cm">	 * be in flight, which the firmware will try</span>
<span class="cm">	 * to complete. Resetting the firmware doesn&#39;t work</span>
<span class="cm">	 * with old fw revisions, so we have to mark</span>
<span class="cm">	 * them off as &#39;stale&#39; to prevent the driver from</span>
<span class="cm">	 * falling over.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">CMD_MSG_STALE</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enqueue_cmd_and_start_io</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">set_performant_mode</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">addQ</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reqQ</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">Qdepth</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">Qdepth</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxQsinceinit</span><span class="p">)</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">maxQsinceinit</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">Qdepth</span><span class="p">;</span>
	<span class="n">start_io</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_free_sg_chain_blocks</span><span class="p">(</span><span class="n">SGDescriptor_struct</span> <span class="o">**</span><span class="n">cmd_sg_list</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">nr_cmds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_sg_list</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_cmds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmd_sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">cmd_sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd_sg_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SGDescriptor_struct</span> <span class="o">**</span><span class="nf">cciss_allocate_sg_chain_blocks</span><span class="p">(</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chainsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_cmds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">SGDescriptor_struct</span> <span class="o">**</span><span class="n">cmd_sg_list</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chainsize</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cmd_sg_list</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd_sg_list</span><span class="p">)</span> <span class="o">*</span> <span class="n">nr_cmds</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_sg_list</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Build up chain blocks for each command */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nr_cmds</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Need a block of chainsized s/g elements. */</span>
		<span class="n">cmd_sg_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">chainsize</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd_sg_list</span><span class="p">[</span><span class="n">j</span><span class="p">])),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_sg_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot get memory &quot;</span>
				<span class="s">&quot;for s/g chains.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">clean</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cmd_sg_list</span><span class="p">;</span>
<span class="nl">clean:</span>
	<span class="n">cciss_free_sg_chain_blocks</span><span class="p">(</span><span class="n">cmd_sg_list</span><span class="p">,</span> <span class="n">nr_cmds</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_unmap_sg_chain_block</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SGDescriptor_struct</span> <span class="o">*</span><span class="n">chain_sg</span><span class="p">;</span>
	<span class="n">u64bit</span> <span class="n">temp64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGTotal</span> <span class="o">&lt;=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_cmd_sgentries</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">chain_sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">max_cmd_sgentries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">chain_sg</span><span class="o">-&gt;</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span><span class="p">;</span>
	<span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">chain_sg</span><span class="o">-&gt;</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span><span class="p">;</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">chain_sg</span><span class="o">-&gt;</span><span class="n">Len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_map_sg_chain_block</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
	<span class="n">SGDescriptor_struct</span> <span class="o">*</span><span class="n">chain_block</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SGDescriptor_struct</span> <span class="o">*</span><span class="n">chain_sg</span><span class="p">;</span>
	<span class="n">u64bit</span> <span class="n">temp64</span><span class="p">;</span>

	<span class="n">chain_sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">max_cmd_sgentries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">chain_sg</span><span class="o">-&gt;</span><span class="n">Ext</span> <span class="o">=</span> <span class="n">CCISS_SG_CHAIN</span><span class="p">;</span>
	<span class="n">chain_sg</span><span class="o">-&gt;</span><span class="n">Len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">temp64</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">chain_block</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">chain_sg</span><span class="o">-&gt;</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">lower</span><span class="p">;</span>
	<span class="n">chain_sg</span><span class="o">-&gt;</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">upper</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#include &quot;cciss_scsi.c&quot;		</span><span class="cm">/* For SCSI tape support */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">raid_label</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="s">&quot;4&quot;</span><span class="p">,</span> <span class="s">&quot;1(1+0)&quot;</span><span class="p">,</span> <span class="s">&quot;5&quot;</span><span class="p">,</span> <span class="s">&quot;5+1&quot;</span><span class="p">,</span> <span class="s">&quot;ADG&quot;</span><span class="p">,</span>
	<span class="s">&quot;UNKNOWN&quot;</span>
<span class="p">};</span>
<span class="cp">#define RAID_UNKNOWN (ARRAY_SIZE(raid_label)-1)</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>

<span class="cm">/*</span>
<span class="cm"> * Report information about this controller.</span>
<span class="cm"> */</span>
<span class="cp">#define ENG_GIG 1000000000</span>
<span class="cp">#define ENG_GIG_FACTOR (ENG_GIG/512)</span>
<span class="cp">#define ENGAGE_SCSI	&quot;engage scsi&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_seq_show_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%s: HP %s Controller</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;Board ID: 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;Firmware Version: %c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;IRQ: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;Logical drives: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;Current Q depth: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;Current # commands on controller: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;Max Q depth since init: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;Max # commands on controller since init: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;Max SG entries since init: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">product_name</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">firm_ver</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">firm_ver</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">firm_ver</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">firm_ver</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr_mode</span><span class="p">],</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">num_luns</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">Qdepth</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">commands_outstanding</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">maxQsinceinit</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_outstanding</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxSG</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_CISS_SCSI_TAPE</span>
	<span class="n">cciss_seq_tape_report</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_CISS_SCSI_TAPE */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">cciss_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* prevent displaying bogus info during configuration</span>
<span class="cm">	 * or deconfiguration of a logical volume</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_configuring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_configuring</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cciss_seq_show_header</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">vol_sz</span><span class="p">,</span> <span class="n">vol_sz_frac</span><span class="p">;</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ctlr</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="o">*</span><span class="n">pos</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">highest_lun</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="cm">/* it&#39;s possible for h-&gt;drv[] to have holes. */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vol_sz</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">nr_blocks</span><span class="p">;</span>
	<span class="n">vol_sz_frac</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">vol_sz</span><span class="p">,</span> <span class="n">ENG_GIG_FACTOR</span><span class="p">);</span>
	<span class="n">vol_sz_frac</span> <span class="o">*=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">vol_sz_frac</span><span class="p">,</span> <span class="n">ENG_GIG_FACTOR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">raid_level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">raid_level</span> <span class="o">&gt;</span> <span class="n">RAID_UNKNOWN</span><span class="p">)</span>
		<span class="n">drv</span><span class="o">-&gt;</span><span class="n">raid_level</span> <span class="o">=</span> <span class="n">RAID_UNKNOWN</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;cciss/c%dd%d:&quot;</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">%4u.%02uGB</span><span class="se">\t</span><span class="s">RAID %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ctlr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">vol_sz</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">vol_sz_frac</span><span class="p">,</span>
			<span class="n">raid_label</span><span class="p">[</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">raid_level</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">cciss_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">highest_lun</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="cm">/* Only reset h-&gt;busy_configuring if we succeeded in setting</span>
<span class="cm">	 * it during cciss_seq_start. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_configuring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">cciss_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">cciss_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>  <span class="o">=</span> <span class="n">cciss_seq_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>  <span class="o">=</span> <span class="n">cciss_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>  <span class="o">=</span> <span class="n">cciss_seq_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cciss_seq_ops</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">cciss_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		 <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_CISS_SCSI_TAPE</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span> <span class="o">||</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_CISS_SCSI_TAPE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">ENGAGE_SCSI</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">ENGAGE_SCSI</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">cciss_engage_scsi</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_CISS_SCSI_TAPE */</span><span class="cp"></span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* might be nice to have &quot;disengage&quot; too, but it&#39;s not</span>
<span class="cm">	   safely possible. (only 1 module use count, lock issues.) */</span>

<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">cciss_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">cciss_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">seq_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	 <span class="o">=</span> <span class="n">cciss_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">cciss_procinit</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">pde</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">proc_cciss</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">proc_cciss</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;driver/cciss&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc_cciss</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pde</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IRGRP</span> <span class="o">|</span>
					<span class="n">S_IROTH</span><span class="p">,</span> <span class="n">proc_cciss</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">cciss_proc_fops</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="cp">#define MAX_PRODUCT_NAME_LEN 19</span>

<span class="cp">#define to_hba(n) container_of(n, struct ctlr_info, dev)</span>
<span class="cp">#define to_drv(n) container_of(n, drive_info_struct, dev)</span>

<span class="cm">/* List of controllers which cannot be hard reset on kexec with reset_devices */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">unresettable_controller</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x324a103C</span><span class="p">,</span> <span class="cm">/* Smart Array P712m */</span>
	<span class="mh">0x324b103C</span><span class="p">,</span> <span class="cm">/* SmartArray P711m */</span>
	<span class="mh">0x3223103C</span><span class="p">,</span> <span class="cm">/* Smart Array P800 */</span>
	<span class="mh">0x3234103C</span><span class="p">,</span> <span class="cm">/* Smart Array P400 */</span>
	<span class="mh">0x3235103C</span><span class="p">,</span> <span class="cm">/* Smart Array P400i */</span>
	<span class="mh">0x3211103C</span><span class="p">,</span> <span class="cm">/* Smart Array E200i */</span>
	<span class="mh">0x3212103C</span><span class="p">,</span> <span class="cm">/* Smart Array E200 */</span>
	<span class="mh">0x3213103C</span><span class="p">,</span> <span class="cm">/* Smart Array E200i */</span>
	<span class="mh">0x3214103C</span><span class="p">,</span> <span class="cm">/* Smart Array E200i */</span>
	<span class="mh">0x3215103C</span><span class="p">,</span> <span class="cm">/* Smart Array E200i */</span>
	<span class="mh">0x3237103C</span><span class="p">,</span> <span class="cm">/* Smart Array E500 */</span>
	<span class="mh">0x323D103C</span><span class="p">,</span> <span class="cm">/* Smart Array P700m */</span>
	<span class="mh">0x409C0E11</span><span class="p">,</span> <span class="cm">/* Smart Array 6400 */</span>
	<span class="mh">0x409D0E11</span><span class="p">,</span> <span class="cm">/* Smart Array 6400 EM */</span>
<span class="p">};</span>

<span class="cm">/* List of controllers which cannot even be soft reset */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">soft_unresettable_controller</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x409C0E11</span><span class="p">,</span> <span class="cm">/* Smart Array 6400 */</span>
	<span class="mh">0x409D0E11</span><span class="p">,</span> <span class="cm">/* Smart Array 6400 EM */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctlr_is_hard_resettable</span><span class="p">(</span><span class="n">u32</span> <span class="n">board_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">unresettable_controller</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unresettable_controller</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">board_id</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctlr_is_soft_resettable</span><span class="p">(</span><span class="n">u32</span> <span class="n">board_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">soft_unresettable_controller</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">soft_unresettable_controller</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">board_id</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctlr_is_resettable</span><span class="p">(</span><span class="n">u32</span> <span class="n">board_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ctlr_is_hard_resettable</span><span class="p">(</span><span class="n">board_id</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">ctlr_is_soft_resettable</span><span class="p">(</span><span class="n">board_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">host_show_resettable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">to_hba</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctlr_is_resettable</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">resettable</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">host_show_resettable</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">host_store_rescan</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">to_hba</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">add_to_scan_list</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">wake_up_process</span><span class="p">(</span><span class="n">cciss_scan_thread</span><span class="p">);</span>
	<span class="n">wait_for_completion_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scan_wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">rescan</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">host_store_rescan</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">host_show_transport_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">to_hba</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">transMethod</span> <span class="o">&amp;</span> <span class="n">CFGTBL_Trans_Performant</span> <span class="o">?</span>
			<span class="s">&quot;performant&quot;</span> <span class="o">:</span> <span class="s">&quot;simple&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">transport_mode</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">host_show_transport_mode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dev_show_unique_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">to_drv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">to_hba</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">__u8</span> <span class="n">sn</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_configuring</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">serial_no</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sn</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
				<span class="s">&quot;%02X%02X%02X%02X%02X%02X%02X%02X&quot;</span>
				<span class="s">&quot;%02X%02X%02X%02X%02X%02X%02X%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sn</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sn</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
				<span class="n">sn</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">sn</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">sn</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">sn</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
				<span class="n">sn</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">sn</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">sn</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">sn</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
				<span class="n">sn</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">sn</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">sn</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">sn</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">dev_show_unique_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dev_show_vendor</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">to_drv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">to_hba</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">vendor</span><span class="p">[</span><span class="n">VENDOR_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_configuring</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">vendor</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">VENDOR_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vendor</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">vendor</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">dev_show_vendor</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dev_show_model</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">to_drv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">to_hba</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">model</span><span class="p">[</span><span class="n">MODEL_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_configuring</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">MODEL_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">dev_show_model</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dev_show_rev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">to_drv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">to_hba</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">rev</span><span class="p">[</span><span class="n">REV_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_configuring</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">,</span> <span class="n">REV_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">dev_show_rev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cciss_show_lunid</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">to_drv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">to_hba</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lunid</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_configuring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">lunid</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lunid</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s">&quot;0x%02x%02x%02x%02x%02x%02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">lunid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lunid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lunid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">lunid</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		<span class="n">lunid</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">lunid</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">lunid</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">lunid</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">lunid</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">cciss_show_lunid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cciss_show_raid_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">to_drv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">to_hba</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">raid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_configuring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">raid</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">raid_level</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raid</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">raid</span> <span class="o">&gt;</span> <span class="n">RAID_UNKNOWN</span><span class="p">)</span>
		<span class="n">raid</span> <span class="o">=</span> <span class="n">RAID_UNKNOWN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">raid_label</span><span class="p">[</span><span class="n">raid</span><span class="p">])</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;RAID %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">raid_label</span><span class="p">[</span><span class="n">raid</span><span class="p">]);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">raid_level</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">cciss_show_raid_level</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cciss_show_usage_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">to_drv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">to_hba</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_configuring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">usage_count</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">usage_count</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">cciss_show_usage_count</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">cciss_host_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rescan</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_resettable</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_transport_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">cciss_host_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">cciss_host_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">cciss_host_attr_groups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">cciss_host_attr_group</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_type</span> <span class="n">cciss_host_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cciss_host&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">groups</span>		<span class="o">=</span> <span class="n">cciss_host_attr_groups</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">cciss_hba_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">cciss_dev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_unique_id</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_model</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_vendor</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rev</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_lunid</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_raid_level</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_usage_count</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">cciss_dev_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">cciss_dev_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">cciss_dev_attr_groups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">cciss_dev_attr_group</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_type</span> <span class="n">cciss_dev_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cciss_device&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">groups</span>		<span class="o">=</span> <span class="n">cciss_dev_attr_groups</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">cciss_device_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_type</span> <span class="n">cciss_bus_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cciss&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * cciss_hba_release is called when the reference count</span>
<span class="cm"> * of h-&gt;dev goes to zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_hba_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * nothing to do, but need this to avoid a warning</span>
<span class="cm">	 * about not having a release handler from lib/kref.c.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize sysfs entry for each controller.  This sets up and registers</span>
<span class="cm"> * the &#39;cciss#&#39; directory for each individual controller under</span>
<span class="cm"> * /sys/bus/pci/devices/&lt;dev&gt;/.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_create_hba_sysfs_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cciss_host_type</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cciss_bus_type</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove sysfs entries for an hba.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_destroy_hba_sysfs_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span> <span class="cm">/* final put. */</span>
<span class="p">}</span>

<span class="cm">/* cciss_device_release is called when the reference count</span>
<span class="cm"> * of h-&gt;drv[x]dev goes to zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_device_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">to_drv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize sysfs for each logical drive.  This sets up and registers</span>
<span class="cm"> * the &#39;c#d#&#39; directory for each individual logical drive under</span>
<span class="cm"> * /sys/bus/pci/devices/&lt;dev/ccis#/. We also create a link from</span>
<span class="cm"> * /sys/block/cciss!c#d# to this entry.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">cciss_create_ld_sysfs_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">drv_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device_initialized</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">device_initialize</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cciss_dev_type</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cciss_bus_type</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;c%dd%d&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">device_initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">device_add</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove sysfs entries for a logical drive.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_destroy_ld_sysfs_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">drv_index</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">ctlr_exiting</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* special case for c*d0, we only destroy it on controller exit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drv_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ctlr_exiting</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">device_del</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="cm">/* the &quot;final&quot; put. */</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * For operations that cannot sleep, a command block is allocated at init,</span>
<span class="cm"> * and managed by cmd_alloc() and cmd_free() using a simple bitmap to track</span>
<span class="cm"> * which ones are free or in use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="nf">cmd_alloc</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64bit</span> <span class="n">temp64</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">cmd_dma_handle</span><span class="p">,</span> <span class="n">err_dma_handle</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool_bits</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
		  <span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool_bits</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">BITS_PER_LONG</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CommandList_struct</span><span class="p">));</span>
	<span class="n">cmd_dma_handle</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool_dhandle</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CommandList_struct</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">errinfo_pool</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ErrorInfo_struct</span><span class="p">));</span>
	<span class="n">err_dma_handle</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">errinfo_pool_dhandle</span>
	    <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ErrorInfo_struct</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_allocs</span><span class="o">++</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmdindex</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">cmd_dma_handle</span><span class="p">;</span>
	<span class="n">temp64</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span> <span class="n">err_dma_handle</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ErrDesc</span><span class="p">.</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">lower</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ErrDesc</span><span class="p">.</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">upper</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ErrDesc</span><span class="p">.</span><span class="n">Len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ErrorInfo_struct</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* allocate a command using pci_alloc_consistent, used for ioctls,</span>
<span class="cm"> * etc., not for the main i/o path.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="nf">cmd_special_alloc</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="n">u64bit</span> <span class="n">temp64</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">cmd_dma_handle</span><span class="p">,</span> <span class="n">err_dma_handle</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">CommandList_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">CommandList_struct</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cmd_dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CommandList_struct</span><span class="p">));</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmdindex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">ErrorInfo_struct</span> <span class="o">*</span><span class="p">)</span>
	    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ErrorInfo_struct</span><span class="p">),</span>
		    <span class="o">&amp;</span><span class="n">err_dma_handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">CommandList_struct</span><span class="p">),</span> <span class="n">c</span><span class="p">,</span> <span class="n">cmd_dma_handle</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ErrorInfo_struct</span><span class="p">));</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">cmd_dma_handle</span><span class="p">;</span>
	<span class="n">temp64</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span> <span class="n">err_dma_handle</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ErrDesc</span><span class="p">.</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">lower</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ErrDesc</span><span class="p">.</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">upper</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ErrDesc</span><span class="p">.</span><span class="n">Len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ErrorInfo_struct</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cmd_free</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BITS_PER_LONG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
		  <span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool_bits</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">BITS_PER_LONG</span><span class="p">));</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_frees</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cmd_special_free</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64bit</span> <span class="n">temp64</span><span class="p">;</span>

	<span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">ErrDesc</span><span class="p">.</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span><span class="p">;</span>
	<span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">ErrDesc</span><span class="p">.</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span><span class="p">;</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ErrorInfo_struct</span><span class="p">),</span>
			    <span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="p">,</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CommandList_struct</span><span class="p">),</span> <span class="n">c</span><span class="p">,</span>
		<span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="n">cciss_tag_discard_error_bits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ctlr_info_t</span> <span class="o">*</span><span class="nf">get_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">drive_info_struct</span> <span class="o">*</span><span class="nf">get_drv</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Open.  Make sure the device is really there.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">get_host</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">);</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">get_drv</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cciss_open %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">busy_configuring</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Root is allowed to open raw volume zero even if it&#39;s not configured</span>
<span class="cm">	 * so array config can still work. Root is also allowed to open any</span>
<span class="cm">	 * volume that has a LUN ID, so it can issue IOCTL to reread the</span>
<span class="cm">	 * disk information.  I don&#39;t think I really like this</span>
<span class="cm">	 * but I&#39;m already using way to many device nodes to claim another one</span>
<span class="cm">	 * for &quot;raw controller&quot;.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MINOR</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* not node 0? */</span>
			<span class="cm">/* if not node 0 make sure it is a partition = 0 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">MINOR</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
				<span class="cm">/* if it is, make sure we have a LUN ID */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">,</span> <span class="n">CTLR_LUNID</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">usage_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">usage_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_unlocked_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cciss_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cciss_open</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cciss_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Close.  Sync first.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cciss_mutex</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">get_host</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
	<span class="n">drv</span> <span class="o">=</span> <span class="n">get_drv</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cciss_release %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">);</span>
	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">usage_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">usage_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cciss_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cciss_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cciss_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cciss_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_ioctl32_passthru</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_ioctl32_big_passthru</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CCISS_GETPCIINFO</span>:
	<span class="k">case</span> <span class="n">CCISS_GETINTINFO</span>:
	<span class="k">case</span> <span class="n">CCISS_SETINTINFO</span>:
	<span class="k">case</span> <span class="n">CCISS_GETNODENAME</span>:
	<span class="k">case</span> <span class="n">CCISS_SETNODENAME</span>:
	<span class="k">case</span> <span class="n">CCISS_GETHEARTBEAT</span>:
	<span class="k">case</span> <span class="n">CCISS_GETBUSTYPES</span>:
	<span class="k">case</span> <span class="n">CCISS_GETFIRMVER</span>:
	<span class="k">case</span> <span class="n">CCISS_GETDRIVVER</span>:
	<span class="k">case</span> <span class="n">CCISS_REVALIDVOLS</span>:
	<span class="k">case</span> <span class="n">CCISS_DEREGDISK</span>:
	<span class="k">case</span> <span class="n">CCISS_REGNEWDISK</span>:
	<span class="k">case</span> <span class="n">CCISS_REGNEWD</span>:
	<span class="k">case</span> <span class="n">CCISS_RESCANDISK</span>:
	<span class="k">case</span> <span class="n">CCISS_GETLUNINFO</span>:
		<span class="k">return</span> <span class="n">do_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">CCISS_PASSTHRU32</span>:
		<span class="k">return</span> <span class="n">cciss_ioctl32_passthru</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CCISS_BIG_PASSTHRU32</span>:
		<span class="k">return</span> <span class="n">cciss_ioctl32_big_passthru</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_ioctl32_passthru</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IOCTL32_Command_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg32</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">IOCTL32_Command_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">IOCTL_Command_struct</span> <span class="n">arg64</span><span class="p">;</span>
	<span class="n">IOCTL_Command_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">arg64</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">|=</span>
	    <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg64</span><span class="p">.</span><span class="n">LUN_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg32</span><span class="o">-&gt;</span><span class="n">LUN_info</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">arg64</span><span class="p">.</span><span class="n">LUN_info</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">|=</span>
	    <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg64</span><span class="p">.</span><span class="n">Request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg32</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">arg64</span><span class="p">.</span><span class="n">Request</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">|=</span>
	    <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg64</span><span class="p">.</span><span class="n">error_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg32</span><span class="o">-&gt;</span><span class="n">error_info</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">arg64</span><span class="p">.</span><span class="n">error_info</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">arg64</span><span class="p">.</span><span class="n">buf_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg32</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg32</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">arg64</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg64</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arg64</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">do_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">CCISS_PASSTHRU</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">|=</span>
	    <span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg32</span><span class="o">-&gt;</span><span class="n">error_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">error_info</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">arg32</span><span class="o">-&gt;</span><span class="n">error_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_ioctl32_big_passthru</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BIG_IOCTL32_Command_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg32</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">BIG_IOCTL32_Command_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">BIG_IOCTL_Command_struct</span> <span class="n">arg64</span><span class="p">;</span>
	<span class="n">BIG_IOCTL_Command_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span>
	    <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">arg64</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cp</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arg64</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">|=</span>
	    <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg64</span><span class="p">.</span><span class="n">LUN_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg32</span><span class="o">-&gt;</span><span class="n">LUN_info</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">arg64</span><span class="p">.</span><span class="n">LUN_info</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">|=</span>
	    <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg64</span><span class="p">.</span><span class="n">Request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg32</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">arg64</span><span class="p">.</span><span class="n">Request</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">|=</span>
	    <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg64</span><span class="p">.</span><span class="n">error_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg32</span><span class="o">-&gt;</span><span class="n">error_info</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">arg64</span><span class="p">.</span><span class="n">error_info</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">arg64</span><span class="p">.</span><span class="n">buf_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg32</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">arg64</span><span class="p">.</span><span class="n">malloc_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg32</span><span class="o">-&gt;</span><span class="n">malloc_size</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg32</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">arg64</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg64</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arg64</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">do_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">CCISS_BIG_PASSTHRU</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">|=</span>
	    <span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg32</span><span class="o">-&gt;</span><span class="n">error_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">error_info</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">arg32</span><span class="o">-&gt;</span><span class="n">error_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">get_drv</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">cylinders</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">cylinders</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_ioctl_unit_attention</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">CMD_TARGET_STATUS</span> <span class="o">&amp;&amp;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">ScsiStatus</span> <span class="o">!=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">check_for_unit_attention</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_getpciinfo</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cciss_pci_info_struct</span> <span class="n">pciinfo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pciinfo</span><span class="p">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">pciinfo</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">pciinfo</span><span class="p">.</span><span class="n">dev_fn</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>
	<span class="n">pciinfo</span><span class="p">.</span><span class="n">board_id</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pciinfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cciss_pci_info_struct</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_getintinfo</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cciss_coalint_struct</span> <span class="n">intinfo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">intinfo</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">HostWrite</span><span class="p">.</span><span class="n">CoalIntDelay</span><span class="p">);</span>
	<span class="n">intinfo</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">HostWrite</span><span class="p">.</span><span class="n">CoalIntCount</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span>
	    <span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intinfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cciss_coalint_struct</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_setintinfo</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cciss_coalint_struct</span> <span class="n">intinfo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intinfo</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">intinfo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">intinfo</span><span class="p">.</span><span class="n">delay</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">intinfo</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Update the field, and then ring the doorbell */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">intinfo</span><span class="p">.</span><span class="n">delay</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">HostWrite</span><span class="p">.</span><span class="n">CoalIntDelay</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">intinfo</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">HostWrite</span><span class="p">.</span><span class="n">CoalIntCount</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">CFGTBL_ChangeReq</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">SA5_DOORBELL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_IOCTL_CONFIG_WAIT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">SA5_DOORBELL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CFGTBL_ChangeReq</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> <span class="cm">/* delay and try again */</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAX_IOCTL_CONFIG_WAIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_getnodename</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NodeName_type</span> <span class="n">NodeName</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">NodeName</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">ServerName</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">NodeName_type</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_setnodename</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NodeName_type</span> <span class="n">NodeName</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">NodeName_type</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Update the field, and then ring the doorbell */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">NodeName</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">ServerName</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">CFGTBL_ChangeReq</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">SA5_DOORBELL</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_IOCTL_CONFIG_WAIT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">SA5_DOORBELL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CFGTBL_ChangeReq</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> <span class="cm">/* delay and try again */</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAX_IOCTL_CONFIG_WAIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_getheartbeat</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Heartbeat_type</span> <span class="n">heartbeat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">heartbeat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">HeartBeat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">heartbeat</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Heartbeat_type</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_getbustypes</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BusTypes_type</span> <span class="n">BusTypes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">BusTypes</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">BusTypes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BusTypes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BusTypes_type</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_getfirmver</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FirmwareVer_type</span> <span class="n">firmware</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">firmware</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">firm_ver</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span>
	    <span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">firmware</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FirmwareVer_type</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_getdrivver</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DriverVer_type</span> <span class="n">DriverVer</span> <span class="o">=</span> <span class="n">DRIVER_VERSION</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DriverVer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DriverVer_type</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_getluninfo</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LogvolInfo_struct</span> <span class="n">luninfo</span><span class="p">;</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">get_drv</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">luninfo</span><span class="p">.</span><span class="n">LunID</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">luninfo</span><span class="p">.</span><span class="n">LunID</span><span class="p">));</span>
	<span class="n">luninfo</span><span class="p">.</span><span class="n">num_opens</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">usage_count</span><span class="p">;</span>
	<span class="n">luninfo</span><span class="p">.</span><span class="n">num_parts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">luninfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LogvolInfo_struct</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_passthru</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IOCTL_Command_struct</span> <span class="n">iocommand</span><span class="p">;</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64bit</span> <span class="n">temp64</span><span class="p">;</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span>
	    <span class="p">(</span><span class="o">&amp;</span><span class="n">iocommand</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_Command_struct</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">iocommand</span><span class="p">.</span><span class="n">buf_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">iocommand</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">!=</span> <span class="n">XFER_NONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iocommand</span><span class="p">.</span><span class="n">buf_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">iocommand</span><span class="p">.</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buff</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iocommand</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">==</span> <span class="n">XFER_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Copy the data into the buffer we created */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">iocommand</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">iocommand</span><span class="p">.</span><span class="n">buf_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iocommand</span><span class="p">.</span><span class="n">buf_size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">cmd_special_alloc</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Fill in the command type */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">CMD_IOCTL_PEND</span><span class="p">;</span>
	<span class="cm">/* Fill in Command Header */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">ReplyQueue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="cm">/* unused in simple mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iocommand</span><span class="p">.</span><span class="n">buf_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* buffer to fill */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGList</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGTotal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* no buffers to fill */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGList</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGTotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">LUN</span> <span class="o">=</span> <span class="n">iocommand</span><span class="p">.</span><span class="n">LUN_info</span><span class="p">;</span>
	<span class="cm">/* use the kernel address the cmd block for tag */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">Tag</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">;</span>

	<span class="cm">/* Fill in Request block */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span> <span class="o">=</span> <span class="n">iocommand</span><span class="p">.</span><span class="n">Request</span><span class="p">;</span>

	<span class="cm">/* Fill in the scatter gather information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iocommand</span><span class="p">.</span><span class="n">buf_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp64</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span>
			<span class="n">iocommand</span><span class="p">.</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">lower</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">upper</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Len</span> <span class="o">=</span> <span class="n">iocommand</span><span class="p">.</span><span class="n">buf_size</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* we are not chaining */</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">;</span>

	<span class="n">enqueue_cmd_and_start_io</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="cm">/* unlock the buffers from DMA */</span>
	<span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span><span class="p">;</span>
	<span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span><span class="p">;</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">iocommand</span><span class="p">.</span><span class="n">buf_size</span><span class="p">,</span>
			 <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="n">check_ioctl_unit_attention</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="cm">/* Copy the error information out */</span>
	<span class="n">iocommand</span><span class="p">.</span><span class="n">error_info</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocommand</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCTL_Command_struct</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
		<span class="n">cmd_special_free</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iocommand</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">==</span> <span class="n">XFER_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Copy the data out of the buffer we created */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">iocommand</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">iocommand</span><span class="p">.</span><span class="n">buf_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
			<span class="n">cmd_special_free</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
	<span class="n">cmd_special_free</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_bigpassthru</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BIG_IOCTL_Command_struct</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">buff_size</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64bit</span> <span class="n">temp64</span><span class="p">;</span>
	<span class="n">BYTE</span> <span class="n">sg_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">__u32</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">BYTE</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">ioc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ioc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ioc</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">!=</span> <span class="n">XFER_NONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Check kmalloc limits  using all SGs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">malloc_size</span> <span class="o">&gt;</span> <span class="n">MAX_KMALLOC_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">&gt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">malloc_size</span> <span class="o">*</span> <span class="n">MAXSGENTRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buff</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">MAXSGENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buff_size</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAXSGENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buff_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>
	<span class="n">data_ptr</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">malloc_size</span><span class="p">)</span> <span class="o">?</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">malloc_size</span> <span class="o">:</span> <span class="n">left</span><span class="p">;</span>
		<span class="n">buff_size</span><span class="p">[</span><span class="n">sg_used</span><span class="p">]</span> <span class="o">=</span> <span class="n">sz</span><span class="p">;</span>
		<span class="n">buff</span><span class="p">[</span><span class="n">sg_used</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="n">sg_used</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">cleanup1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">==</span> <span class="n">XFER_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="n">sg_used</span><span class="p">],</span> <span class="n">data_ptr</span><span class="p">,</span> <span class="n">sz</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">cleanup1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="n">sg_used</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">left</span> <span class="o">-=</span> <span class="n">sz</span><span class="p">;</span>
		<span class="n">data_ptr</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>
		<span class="n">sg_used</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">cmd_special_alloc</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">CMD_IOCTL_PEND</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">ReplyQueue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGList</span> <span class="o">=</span> <span class="n">sg_used</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGTotal</span> <span class="o">=</span> <span class="n">sg_used</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">LUN</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">LUN_info</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">Tag</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sg_used</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp64</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">buff_size</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				    <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">lower</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">upper</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Len</span> <span class="o">=</span> <span class="n">buff_size</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* we are not chaining */</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">;</span>
	<span class="n">enqueue_cmd_and_start_io</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="cm">/* unlock the buffers from DMA */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sg_used</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span><span class="p">;</span>
		<span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span><span class="p">;</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">buff_size</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">check_ioctl_unit_attention</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="cm">/* Copy the error information out */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">error_info</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ioc</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">cmd_special_free</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">==</span> <span class="n">XFER_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Copy the data out of the buffer we created */</span>
		<span class="n">BYTE</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sg_used</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">buff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">buff_size</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">cmd_special_free</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">cleanup1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">buff_size</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cmd_special_free</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">cleanup1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sg_used</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buff_size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">;</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">get_host</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cciss_ioctl: Called with cmd=%x %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CCISS_GETPCIINFO</span>:
		<span class="k">return</span> <span class="n">cciss_getpciinfo</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CCISS_GETINTINFO</span>:
		<span class="k">return</span> <span class="n">cciss_getintinfo</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CCISS_SETINTINFO</span>:
		<span class="k">return</span> <span class="n">cciss_setintinfo</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CCISS_GETNODENAME</span>:
		<span class="k">return</span> <span class="n">cciss_getnodename</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CCISS_SETNODENAME</span>:
		<span class="k">return</span> <span class="n">cciss_setnodename</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CCISS_GETHEARTBEAT</span>:
		<span class="k">return</span> <span class="n">cciss_getheartbeat</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CCISS_GETBUSTYPES</span>:
		<span class="k">return</span> <span class="n">cciss_getbustypes</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CCISS_GETFIRMVER</span>:
		<span class="k">return</span> <span class="n">cciss_getfirmver</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CCISS_GETDRIVVER</span>:
		<span class="k">return</span> <span class="n">cciss_getdrivver</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CCISS_DEREGDISK</span>:
	<span class="k">case</span> <span class="n">CCISS_REGNEWD</span>:
	<span class="k">case</span> <span class="n">CCISS_REVALIDVOLS</span>:
		<span class="k">return</span> <span class="n">rebuild_lun_table</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CCISS_GETLUNINFO</span>:
		<span class="k">return</span> <span class="n">cciss_getluninfo</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CCISS_PASSTHRU</span>:
		<span class="k">return</span> <span class="n">cciss_passthru</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CCISS_BIG_PASSTHRU</span>:
		<span class="k">return</span> <span class="n">cciss_bigpassthru</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	<span class="cm">/* scsi_cmd_blk_ioctl handles these, below, though some are not */</span>
	<span class="cm">/* very meaningful for cciss.  SG_IO is the main one people want. */</span>

	<span class="k">case</span> <span class="n">SG_GET_VERSION_NUM</span>:
	<span class="k">case</span> <span class="n">SG_SET_TIMEOUT</span>:
	<span class="k">case</span> <span class="n">SG_GET_TIMEOUT</span>:
	<span class="k">case</span> <span class="n">SG_GET_RESERVED_SIZE</span>:
	<span class="k">case</span> <span class="n">SG_SET_RESERVED_SIZE</span>:
	<span class="k">case</span> <span class="n">SG_EMULATED_HOST</span>:
	<span class="k">case</span> <span class="n">SG_IO</span>:
	<span class="k">case</span> <span class="n">SCSI_IOCTL_SEND_COMMAND</span>:
		<span class="k">return</span> <span class="n">scsi_cmd_blk_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>

	<span class="cm">/* scsi_cmd_blk_ioctl would normally handle these, below, but */</span>
	<span class="cm">/* they aren&#39;t a good fit for cciss, as CD-ROMs are */</span>
	<span class="cm">/* not supported, and we don&#39;t have any bus/target/lun */</span>
	<span class="cm">/* which we present to the kernel. */</span>

	<span class="k">case</span> <span class="n">CDROM_SEND_PACKET</span>:
	<span class="k">case</span> <span class="n">CDROMCLOSETRAY</span>:
	<span class="k">case</span> <span class="n">CDROMEJECT</span>:
	<span class="k">case</span> <span class="n">SCSI_IOCTL_GET_IDLUN</span>:
	<span class="k">case</span> <span class="n">SCSI_IOCTL_GET_BUS_NUMBER</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_check_queues</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">start_queue</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">next_to_run</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* check to see if we have maxed out the number of commands that can</span>
<span class="cm">	 * be placed on the queue.  If so then exit.  We do this check here</span>
<span class="cm">	 * in case the interrupt we serviced was from an ioctl and did not</span>
<span class="cm">	 * free any new commands.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool_bits</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">))</span> <span class="o">==</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We have room on the queue for more commands.  Now we need to queue</span>
<span class="cm">	 * them up.  We will also keep track of the next queue to run so</span>
<span class="cm">	 * that every queue gets a chance to be started first.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">highest_lun</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">curr_queue</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_queue</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">highest_lun</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* make sure the disk has been added and the drive is real</span>
<span class="cm">		 * because this can be called from the middle of init_one.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">curr_queue</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">curr_queue</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">||</span>
			<span class="o">!</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">curr_queue</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">blk_start_queue</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="n">curr_queue</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

		<span class="cm">/* check to see if we have maxed out the number of commands</span>
<span class="cm">		 * that can be placed on the queue.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool_bits</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">))</span> <span class="o">==</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">curr_queue</span> <span class="o">==</span> <span class="n">start_queue</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">next_to_run</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">start_queue</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">highest_lun</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">next_to_run</span> <span class="o">=</span> <span class="n">curr_queue</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_softirq_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">completion_data</span><span class="p">;</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">hba</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">];</span>
	<span class="n">SGDescriptor_struct</span> <span class="o">*</span><span class="n">curr_sg</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">;</span>
	<span class="n">u64bit</span> <span class="n">temp64</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ddir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">==</span> <span class="n">XFER_READ</span><span class="p">)</span>
		<span class="n">ddir</span> <span class="o">=</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ddir</span> <span class="o">=</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">;</span>

	<span class="cm">/* command did not need to be retried */</span>
	<span class="cm">/* unmap the DMA mapping for all the scatter gather elements */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGList</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curr_sg</span><span class="p">[</span><span class="n">sg_index</span><span class="p">].</span><span class="n">Ext</span> <span class="o">==</span> <span class="n">CCISS_SG_CHAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cciss_unmap_sg_chain_block</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="cm">/* Point to the next block */</span>
			<span class="n">curr_sg</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_sg_list</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cmdindex</span><span class="p">];</span>
			<span class="n">sg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">curr_sg</span><span class="p">[</span><span class="n">sg_index</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span><span class="p">;</span>
		<span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">curr_sg</span><span class="p">[</span><span class="n">sg_index</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span><span class="p">;</span>
		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">curr_sg</span><span class="p">[</span><span class="n">sg_index</span><span class="p">].</span><span class="n">Len</span><span class="p">,</span>
				<span class="n">ddir</span><span class="p">);</span>
		<span class="o">++</span><span class="n">sg_index</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Done with %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>

	<span class="cm">/* set the residual count for pc requests */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">ResidualCnt</span><span class="p">;</span>

	<span class="n">blk_end_request_all</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cmd_free</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">cciss_check_queues</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">log_unit_to_scsi3addr</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsi3addr</span><span class="p">[],</span> <span class="kt">uint32_t</span> <span class="n">log_unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">scsi3addr</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">log_unit</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">log_unit</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* This function gets the SCSI vendor, model, and revision of a logical drive</span>
<span class="cm"> * via the inquiry page 0.  Model, vendor, and rev are set to empty strings if</span>
<span class="cm"> * they cannot be read.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_get_device_descr</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">logvol</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">vendor</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">InquiryData_struct</span> <span class="o">*</span><span class="n">inq_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsi3addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="o">*</span><span class="n">vendor</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rev</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">inq_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryData_struct</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inq_buf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">log_unit_to_scsi3addr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span> <span class="n">logvol</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sendcmd_withirq</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CISS_INQUIRY</span><span class="p">,</span> <span class="n">inq_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">inq_buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">scsi3addr</span><span class="p">,</span> <span class="n">TYPE_CMD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IO_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">vendor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inq_buf</span><span class="o">-&gt;</span><span class="n">data_byte</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">VENDOR_LEN</span><span class="p">);</span>
		<span class="n">vendor</span><span class="p">[</span><span class="n">VENDOR_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inq_buf</span><span class="o">-&gt;</span><span class="n">data_byte</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">MODEL_LEN</span><span class="p">);</span>
		<span class="n">model</span><span class="p">[</span><span class="n">MODEL_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inq_buf</span><span class="o">-&gt;</span><span class="n">data_byte</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">REV_LEN</span><span class="p">);</span>
		<span class="n">rev</span><span class="p">[</span><span class="n">REV_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">inq_buf</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function gets the serial number of a logical drive via</span>
<span class="cm"> * inquiry page 0x83.  Serial no. is 16 bytes.  If the serial</span>
<span class="cm"> * number cannot be had, for whatever reason, 16 bytes of 0xff</span>
<span class="cm"> * are returned instead.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_get_serial_no</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">logvol</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">serial_no</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define PAGE_83_INQ_BYTES 64</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsi3addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">buflen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">serial_no</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">PAGE_83_INQ_BYTES</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">serial_no</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">log_unit_to_scsi3addr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span> <span class="n">logvol</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sendcmd_withirq</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CISS_INQUIRY</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
		<span class="n">PAGE_83_INQ_BYTES</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span> <span class="n">TYPE_CMD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">IO_OK</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">serial_no</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cciss_add_disk sets up the block device queue for a logical drive</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_add_disk</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">drv_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">blk_init_queue</span><span class="p">(</span><span class="n">do_cciss_request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_queue_failure</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="s">&quot;cciss/c%dd%d&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">);</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="n">drv_index</span> <span class="o">&lt;&lt;</span> <span class="n">NWD_SHIFT</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cciss_fops</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cciss_create_ld_sysfs_entry</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">cleanup_queue</span><span class="p">;</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">];</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">driverfs_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Set up queue information */</span>
	<span class="n">blk_queue_bounce_limit</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">);</span>

	<span class="cm">/* This is a hardware imposed limit. */</span>
	<span class="n">blk_queue_max_segments</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxsgentries</span><span class="p">);</span>

	<span class="n">blk_queue_max_hw_sectors</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">cciss_max_sectors</span><span class="p">);</span>

	<span class="n">blk_queue_softirq_done</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">cciss_softirq_done</span><span class="p">);</span>

	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">queuedata</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>

	<span class="n">blk_queue_logical_block_size</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span>
				     <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>

	<span class="cm">/* Make sure all queue data is written out before */</span>
	<span class="cm">/* setting h-&gt;drv[drv_index]-&gt;queue, as setting this */</span>
	<span class="cm">/* allows the interrupt handler to start the queue */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">add_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cleanup_queue:</span>
	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">init_queue_failure:</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function will check the usage_count of the drive to be updated/added.</span>
<span class="cm"> * If the usage_count is zero and it is a heretofore unknown drive, or,</span>
<span class="cm"> * the drive&#39;s capacity, geometry, or serial number has changed,</span>
<span class="cm"> * then the drive information will be updated and the disk will be</span>
<span class="cm"> * re-registered with the kernel.  If these conditions don&#39;t hold,</span>
<span class="cm"> * then it will be left alone for the next reboot.  The exception to this</span>
<span class="cm"> * is disk 0 which will always be left registered with the kernel since it</span>
<span class="cm"> * is also the controller node.  Any changes to disk 0 will show up on</span>
<span class="cm"> * the next reboot.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_update_drive_info</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">drv_index</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">first_time</span><span class="p">,</span> <span class="kt">int</span> <span class="n">via_ioctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>
	<span class="n">InquiryData_struct</span> <span class="o">*</span><span class="n">inq_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">total_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drvinfo</span><span class="p">;</span>

	<span class="cm">/* Get information about the disk and modify the driver structure */</span>
	<span class="n">inq_buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryData_struct</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">drvinfo</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">drvinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inq_buff</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">drvinfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mem_msg</span><span class="p">;</span>

	<span class="cm">/* testing to see if 16-byte CDBs are already being used */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cciss_read</span> <span class="o">==</span> <span class="n">CCISS_READ_16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cciss_read_capacity_16</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">total_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_size</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cciss_read_capacity</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">total_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_size</span><span class="p">);</span>
		<span class="cm">/* if read_capacity returns all F&#39;s this volume is &gt;2TB */</span>
		<span class="cm">/* in size so we switch to 16-byte CDB&#39;s for all */</span>
		<span class="cm">/* read/write ops */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total_size</span> <span class="o">==</span> <span class="mh">0xFFFFFFFFULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cciss_read_capacity_16</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">total_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_size</span><span class="p">);</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">cciss_read</span> <span class="o">=</span> <span class="n">CCISS_READ_16</span><span class="p">;</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">cciss_write</span> <span class="o">=</span> <span class="n">CCISS_WRITE_16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">cciss_read</span> <span class="o">=</span> <span class="n">CCISS_READ_10</span><span class="p">;</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">cciss_write</span> <span class="o">=</span> <span class="n">CCISS_WRITE_10</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cciss_geometry_inquiry</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">,</span> <span class="n">total_size</span><span class="p">,</span> <span class="n">block_size</span><span class="p">,</span>
			       <span class="n">inq_buff</span><span class="p">,</span> <span class="n">drvinfo</span><span class="p">);</span>
	<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">block_size</span><span class="p">;</span>
	<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">nr_blocks</span> <span class="o">=</span> <span class="n">total_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cciss_get_device_descr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">,</span> <span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span>
				<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">);</span>
	<span class="n">cciss_get_serial_no</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">,</span> <span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">serial_no</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">serial_no</span><span class="p">));</span>
	<span class="cm">/* Save the lunid in case we deregister the disk, below. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">));</span>

	<span class="cm">/* Is it the same disk we already know, and nothing&#39;s changed? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">raid_level</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">memcmp</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">serial_no</span><span class="p">,</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">serial_no</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">==</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">&amp;&amp;</span>
		<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">nr_blocks</span> <span class="o">==</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">nr_blocks</span> <span class="o">&amp;&amp;</span>
		<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">==</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">&amp;&amp;</span>
		<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">==</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">&amp;&amp;</span>
		<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">==</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cylinders</span><span class="p">))</span>
			<span class="cm">/* The disk is unchanged, nothing to update */</span>
			<span class="k">goto</span> <span class="n">freeret</span><span class="p">;</span>

	<span class="cm">/* If we get here it&#39;s not the same disk, or something&#39;s changed,</span>
<span class="cm">	 * so we need to * deregister it, and re-register it, if it&#39;s not</span>
<span class="cm">	 * in use.</span>
<span class="cm">	 * If the disk already exists then deregister it before proceeding</span>
<span class="cm">	 * (unless it&#39;s the first disk (for the controller node).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">raid_level</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">drv_index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disk %d has changed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">busy_configuring</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* deregister_disk sets h-&gt;drv[drv_index]-&gt;queue = NULL</span>
<span class="cm">		 * which keeps the interrupt handler from starting</span>
<span class="cm">		 * the queue.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">deregister_disk</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">via_ioctl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If the disk is in use return */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">freeret</span><span class="p">;</span>

	<span class="cm">/* Save the new information from cciss_geometry_inquiry</span>
<span class="cm">	 * and serial number inquiry.  If the disk was deregistered</span>
<span class="cm">	 * above, then h-&gt;drv[drv_index] will be NULL.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">device_initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">drvinfo</span><span class="p">;</span>
		<span class="n">drvinfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* so it won&#39;t be freed below. */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* special case for cxd0 */</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">nr_blocks</span> <span class="o">=</span> <span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">nr_blocks</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">cylinders</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">raid_level</span> <span class="o">=</span> <span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">raid_level</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">serial_no</span><span class="p">,</span> <span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">serial_no</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span>
			<span class="n">VENDOR_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">MODEL_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">,</span> <span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">,</span> <span class="n">REV_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">++</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_luns</span><span class="p">;</span>
	<span class="n">disk</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="n">drv_index</span><span class="p">];</span>
	<span class="n">set_capacity</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">nr_blocks</span><span class="p">);</span>

	<span class="cm">/* If it&#39;s not disk 0 (drv_index != 0)</span>
<span class="cm">	 * or if it was disk 0, but there was previously</span>
<span class="cm">	 * no actual corresponding configured logical drive</span>
<span class="cm">	 * (raid_leve == -1) then we want to update the</span>
<span class="cm">	 * logical drive&#39;s information.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drv_index</span> <span class="o">||</span> <span class="n">first_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cciss_add_disk</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cciss_free_gendisk</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">);</span>
			<span class="n">cciss_free_drive_info</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not update disk %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">drv_index</span><span class="p">);</span>
			<span class="o">--</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_luns</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">freeret:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">inq_buff</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">drvinfo</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">mem_msg:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">freeret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function will find the first index of the controllers drive array</span>
<span class="cm"> * that has a null drv pointer and allocate the drive info struct and</span>
<span class="cm"> * will return that index   This is where new drives will be added.</span>
<span class="cm"> * If the index to be returned is greater than the highest_lun index for</span>
<span class="cm"> * the controller then highest_lun is set * to this new index.</span>
<span class="cm"> * If there are no available indexes or if tha allocation fails, then -1</span>
<span class="cm"> * is returned.  * &quot;controller_node&quot; is used to know if this is a real</span>
<span class="cm"> * logical drive, or just the controller node, which determines if this</span>
<span class="cm"> * counts towards highest_lun.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_alloc_drive_info</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">controller_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>

	<span class="cm">/* Search for an empty slot for our drive info */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CISS_MAX_LUN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* if not cxd0 case, and it&#39;s occupied, skip it. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If it&#39;s cxd0 case, and drv is alloc&#39;ed already, and a</span>
<span class="cm">		 * disk is configured there, skip it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">raid_level</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * We&#39;ve found an empty slot.  Update highest_lun</span>
<span class="cm">		 * provided this isn&#39;t just the fake cxd0 controller node.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">highest_lun</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">controller_node</span><span class="p">)</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">highest_lun</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* If adding a real disk at cxd0, and it&#39;s already alloc&#39;ed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Found an empty slot, not already alloc&#39;ed.  Allocate it.</span>
<span class="cm">		 * Mark it with raid_level == -1, so we know it&#39;s new later on.</span>
<span class="cm">		 */</span>
		<span class="n">drv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">drv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drv</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">drv</span><span class="o">-&gt;</span><span class="n">raid_level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* so we know it&#39;s new */</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">drv</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_free_drive_info</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">drv_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_free_gendisk</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">drv_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">put_disk</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* cciss_add_gendisk finds a free hba[]-&gt;drv structure</span>
<span class="cm"> * and allocates a gendisk if needed, and sets the lunid</span>
<span class="cm"> * in the drvinfo structure.   It returns the index into</span>
<span class="cm"> * the -&gt;drv[] array, or -1 if none are free.</span>
<span class="cm"> * is_controller_node indicates whether highest_lun should</span>
<span class="cm"> * count this disk, or if it&#39;s only being added to provide</span>
<span class="cm"> * a means to talk to the controller in case no logical</span>
<span class="cm"> * drives have yet been configured.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_add_gendisk</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lunid</span><span class="p">[],</span>
	<span class="kt">int</span> <span class="n">controller_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drv_index</span><span class="p">;</span>

	<span class="n">drv_index</span> <span class="o">=</span> <span class="n">cciss_alloc_drive_info</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">controller_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drv_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*Check if the gendisk needs to be allocated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="n">drv_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">alloc_disk</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NWD_SHIFT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="n">drv_index</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;could not allocate a new disk %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">drv_index</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_free_drive_info</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">,</span> <span class="n">lunid</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cciss_create_ld_sysfs_entry</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_free_disk</span><span class="p">;</span>
	<span class="cm">/* Don&#39;t need to mark this busy because nobody */</span>
	<span class="cm">/* else knows about this disk yet to contend */</span>
	<span class="cm">/* for access to it. */</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">busy_configuring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">drv_index</span><span class="p">;</span>

<span class="nl">err_free_disk:</span>
	<span class="n">cciss_free_gendisk</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">);</span>
<span class="nl">err_free_drive_info:</span>
	<span class="n">cciss_free_drive_info</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This is for the special case of a controller which</span>
<span class="cm"> * has no logical drives.  In this case, we still need</span>
<span class="cm"> * to register a disk so the controller can be accessed</span>
<span class="cm"> * by the Array Config Utility.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_add_controller_node</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drv_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="cm">/* already did this? Then bail. */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">drv_index</span> <span class="o">=</span> <span class="n">cciss_add_gendisk</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CTLR_LUNID</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drv_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">nr_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">raid_level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">serial_no</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">disk</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="n">drv_index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cciss_add_disk</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cciss_free_gendisk</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">);</span>
	<span class="n">cciss_free_drive_info</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not add disk 0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function will add and remove logical drives from the Logical</span>
<span class="cm"> * drive array of the controller and maintain persistency of ordering</span>
<span class="cm"> * so that mount points are preserved until the next reboot.  This allows</span>
<span class="cm"> * for the removal of logical drives in the middle of the drive array</span>
<span class="cm"> * without a re-ordering of those drives.</span>
<span class="cm"> * INPUT</span>
<span class="cm"> * h		= The controller to perform the operations on</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rebuild_lun_table</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first_time</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">via_ioctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_luns</span><span class="p">;</span>
	<span class="n">ReportLunData_struct</span> <span class="o">*</span><span class="n">ld_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">return_code</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">listlength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drv_found</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drv_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lunid</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">CTLR_LUNID</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* Set busy_configuring flag for this operation */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_configuring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_configuring</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ld_buff</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ReportLunData_struct</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ld_buff</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mem_msg</span><span class="p">;</span>

	<span class="n">return_code</span> <span class="o">=</span> <span class="n">sendcmd_withirq</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CISS_REPORT_LOG</span><span class="p">,</span> <span class="n">ld_buff</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="n">ReportLunData_struct</span><span class="p">),</span>
				      <span class="mi">0</span><span class="p">,</span> <span class="n">CTLR_LUNID</span><span class="p">,</span> <span class="n">TYPE_CMD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">return_code</span> <span class="o">==</span> <span class="n">IO_OK</span><span class="p">)</span>
		<span class="n">listlength</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="n">ld_buff</span><span class="o">-&gt;</span><span class="n">LUNListLength</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>	<span class="cm">/* reading number of logical volumes failed */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;report logical volume command failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">listlength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">freeret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">num_luns</span> <span class="o">=</span> <span class="n">listlength</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* 8 bytes per entry */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_luns</span> <span class="o">&gt;</span> <span class="n">CISS_MAX_LUN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_luns</span> <span class="o">=</span> <span class="n">CISS_MAX_LUN</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;more luns configured&quot;</span>
		       <span class="s">&quot; on controller than can be handled by&quot;</span>
		       <span class="s">&quot; this driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_luns</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cciss_add_controller_node</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>

	<span class="cm">/* Compare controller drive array to driver&#39;s drive array</span>
<span class="cm">	 * to see if any drives are missing on the controller due</span>
<span class="cm">	 * to action of Array Config Utility (user deletes drive)</span>
<span class="cm">	 * and deregister logical drives which have disappeared.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">highest_lun</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">drv_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* skip holes in the array from already deleted drives */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">num_luns</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">lunid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ld_buff</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lunid</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">,</span> <span class="n">lunid</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">lunid</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">drv_found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drv_found</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Deregister it from the OS, it&#39;s gone. */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">busy_configuring</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">return_code</span> <span class="o">=</span> <span class="n">deregister_disk</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">via_ioctl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">busy_configuring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Compare controller drive array to driver&#39;s drive array.</span>
<span class="cm">	 * Check for updates in the drive information and any new drives</span>
<span class="cm">	 * on the controller due to ACU adding logical drives, or changing</span>
<span class="cm">	 * a logical drive&#39;s size, etc.  Reregister any new/changed drives</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_luns</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

		<span class="n">drv_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">lunid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ld_buff</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lunid</span><span class="p">));</span>
		<span class="cm">/* Find if the LUN is already in the drive array</span>
<span class="cm">		 * of the driver.  If so then update its info</span>
<span class="cm">		 * if not in use.  If it does not exist then find</span>
<span class="cm">		 * the first free index and add it.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">highest_lun</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
				<span class="n">memcmp</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">,</span> <span class="n">lunid</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">drv_index</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
				<span class="n">drv_found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* check if the drive was found already in the array */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drv_found</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drv_index</span> <span class="o">=</span> <span class="n">cciss_add_gendisk</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">lunid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">drv_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">freeret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cciss_update_drive_info</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">,</span> <span class="n">first_time</span><span class="p">,</span> <span class="n">via_ioctl</span><span class="p">);</span>
	<span class="p">}</span>		<span class="cm">/* end for */</span>

<span class="nl">freeret:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ld_buff</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_configuring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* We return -1 here to tell the ACU that we have registered/updated</span>
<span class="cm">	 * all of the drives that we can and to keep it from calling us</span>
<span class="cm">	 * additional times.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="nl">mem_msg:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_configuring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">freeret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_clear_drive_info</span><span class="p">(</span><span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drive_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* zero out the disk size info */</span>
	<span class="n">drive_info</span><span class="o">-&gt;</span><span class="n">nr_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drive_info</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drive_info</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drive_info</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drive_info</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drive_info</span><span class="o">-&gt;</span><span class="n">raid_level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">drive_info</span><span class="o">-&gt;</span><span class="n">serial_no</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drive_info</span><span class="o">-&gt;</span><span class="n">serial_no</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">drive_info</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drive_info</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">drive_info</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drive_info</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">drive_info</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drive_info</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * don&#39;t clear the LUNID though, we need to remember which</span>
<span class="cm">	 * one this one is.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cm">/* This function will deregister the disk and it&#39;s queue from the</span>
<span class="cm"> * kernel.  It must be called with the controller lock held and the</span>
<span class="cm"> * drv structures busy_configuring flag set.  It&#39;s parameters are:</span>
<span class="cm"> *</span>
<span class="cm"> * disk = This is the disk to be deregistered</span>
<span class="cm"> * drv  = This is the drive_info_struct associated with the disk to be</span>
<span class="cm"> *        deregistered.  It contains information about the disk used</span>
<span class="cm"> *        by the driver.</span>
<span class="cm"> * clear_all = This flag determines whether or not the disk information</span>
<span class="cm"> *             is going to be completely cleared out and the highest_lun</span>
<span class="cm"> *             reset.  Sometimes we want to clear out information about</span>
<span class="cm"> *             the disk in preparation for re-adding it.  In this case</span>
<span class="cm"> *             the highest_lun should be left unchanged and the LunID</span>
<span class="cm"> *             should not be cleared.</span>
<span class="cm"> * via_ioctl</span>
<span class="cm"> *    This indicates whether we&#39;ve reached this path via ioctl.</span>
<span class="cm"> *    This affects the maximum usage count allowed for c0d0 to be messed with.</span>
<span class="cm"> *    If this path is reached via ioctl(), then the max_usage_count will</span>
<span class="cm"> *    be 1, as the process calling ioctl() has got to have the device open.</span>
<span class="cm"> *    If we get here via sysfs, then the max usage count will be zero.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">deregister_disk</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">drv_index</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">clear_all</span><span class="p">,</span> <span class="kt">int</span> <span class="n">via_ioctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recalculate_highest_lun</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">drv</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drv_index</span><span class="p">];</span>
	<span class="n">disk</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="n">drv_index</span><span class="p">];</span>

	<span class="cm">/* make sure logical volume is NOT is use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear_all</span> <span class="o">||</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">disk</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">usage_count</span> <span class="o">&gt;</span> <span class="n">via_ioctl</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">usage_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">recalculate_highest_lun</span> <span class="o">=</span> <span class="p">(</span><span class="n">drv</span> <span class="o">==</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">highest_lun</span><span class="p">]);</span>

	<span class="cm">/* invalidate the devices and deregister the disk.  If it is disk</span>
<span class="cm">	 * zero do not deregister it but just zero out it&#39;s values.  This</span>
<span class="cm">	 * allows us to delete disk zero but keep the controller registered.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">disk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GENHD_FL_UP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cciss_destroy_ld_sysfs_entry</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">drv_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">del_gendisk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">)</span>
			<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="cm">/* If clear_all is set then we are deleting the logical</span>
<span class="cm">		 * drive, not just refreshing its info.  For drives</span>
<span class="cm">		 * other than disk 0 we will call put_disk.  We do not</span>
<span class="cm">		 * do this for disk 0 as we need it to be able to</span>
<span class="cm">		 * configure the controller.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clear_all</span><span class="p">){</span>
			<span class="cm">/* This isn&#39;t pretty, but we need to find the</span>
<span class="cm">			 * disk in our array and NULL our the pointer.</span>
<span class="cm">			 * This is so that we will call alloc_disk if</span>
<span class="cm">			 * this index is used again later.</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CISS_MAX_LUN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">disk</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">put_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_capacity</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cciss_clear_drive_info</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">--</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_luns</span><span class="p">;</span>

	<span class="cm">/* if it was the last disk, find the new hightest lun */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear_all</span> <span class="o">&amp;&amp;</span> <span class="n">recalculate_highest_lun</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">newhighest</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">highest_lun</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* if the disk has size &gt; 0, it is available */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">heads</span><span class="p">)</span>
				<span class="n">newhighest</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">highest_lun</span> <span class="o">=</span> <span class="n">newhighest</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fill_cmd</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">page_code</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scsi3addr</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">cmd_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64bit</span> <span class="n">buff_dma_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">IO_OK</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">CMD_IOCTL_PEND</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">ReplyQueue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buff</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGList</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGTotal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGList</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGTotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">Tag</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">LUN</span><span class="p">.</span><span class="n">LunAddrBytes</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">cmd_type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">TYPE_CMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CISS_INQUIRY</span>:
			<span class="cm">/* are we trying to read a vital product page */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">page_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_code</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDBLen</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Attribute</span> <span class="o">=</span> <span class="n">ATTR_SIMPLE</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">XFER_READ</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CISS_INQUIRY</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CISS_REPORT_LOG</span>:
		<span class="k">case</span> <span class="n">CISS_REPORT_PHYS</span>:
			<span class="cm">/* Talking to controller so It&#39;s a physical command</span>
<span class="cm">			   mode = 00 target = 0.  Nothing to write.</span>
<span class="cm">			 */</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDBLen</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Attribute</span> <span class="o">=</span> <span class="n">ATTR_SIMPLE</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">XFER_READ</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="cm">/* MSB */</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CCISS_READ_CAPACITY</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDBLen</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Attribute</span> <span class="o">=</span> <span class="n">ATTR_SIMPLE</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">XFER_READ</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCISS_READ_CAPACITY_16</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDBLen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Attribute</span> <span class="o">=</span> <span class="n">ATTR_SIMPLE</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">XFER_READ</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCISS_CACHE_FLUSH</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDBLen</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Attribute</span> <span class="o">=</span> <span class="n">ATTR_SIMPLE</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">XFER_WRITE</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BMIC_WRITE</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">BMIC_CACHE_FLUSH</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDBLen</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Attribute</span> <span class="o">=</span> <span class="n">ATTR_SIMPLE</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">XFER_NONE</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown Command 0x%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IO_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">TYPE_MSG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CCISS_ABORT_MSG</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDBLen</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Attribute</span> <span class="o">=</span> <span class="n">ATTR_SIMPLE</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">XFER_WRITE</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>	<span class="cm">/* abort */</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* abort a command */</span>
			<span class="cm">/* buff contains the tag of the command to abort */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">buff</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCISS_RESET_MSG</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDBLen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Attribute</span> <span class="o">=</span> <span class="n">ATTR_SIMPLE</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">XFER_NONE</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">));</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>	<span class="cm">/* reset */</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CCISS_RESET_TYPE_TARGET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCISS_NOOP_MSG</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDBLen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Attribute</span> <span class="o">=</span> <span class="n">ATTR_SIMPLE</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">XFER_WRITE</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;unknown message type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IO_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown command type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IO_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Fill in the scatter gather information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buff_dma_handle</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							     <span class="n">buff</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
							     <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">buff_dma_handle</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">lower</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">buff_dma_handle</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">upper</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* we are not chaining */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cciss_send_reset</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scsi3addr</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">reset_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">return_status</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">cmd_alloc</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">return_status</span> <span class="o">=</span> <span class="n">fill_cmd</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">CCISS_RESET_MSG</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CTLR_LUNID</span><span class="p">,</span> <span class="n">TYPE_MSG</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reset_type</span><span class="p">;</span> <span class="cm">/* fill_cmd defaults to target reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">return_status</span> <span class="o">!=</span> <span class="n">IO_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_special_free</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">return_status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">enqueue_cmd_and_start_io</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="cm">/* Don&#39;t wait for completion, the reset won&#39;t complete.  Don&#39;t free</span>
<span class="cm">	 * the command either.  This is the last command we will send before</span>
<span class="cm">	 * re-initializing everything, so it doesn&#39;t matter and won&#39;t leak.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_target_status</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">ScsiStatus</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SAM_STAT_GOOD</span>:
		<span class="k">return</span> <span class="n">IO_OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAM_STAT_CHECK_CONDITION</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="mh">0xf</span> <span class="o">&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">SenseInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="k">return</span> <span class="n">IO_OK</span><span class="p">;</span> <span class="cm">/* no sense */</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="k">return</span> <span class="n">IO_OK</span><span class="p">;</span> <span class="cm">/* recovered error */</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_for_unit_attention</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">IO_NEEDS_RETRY</span><span class="p">;</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd 0x%02x &quot;</span>
				<span class="s">&quot;check condition, sense key = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">SenseInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd 0x%02x&quot;</span>
			<span class="s">&quot;scsi status = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">ScsiStatus</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IO_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_sendcmd_error</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">return_status</span> <span class="o">=</span> <span class="n">IO_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">CMD_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IO_OK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CMD_TARGET_STATUS</span>:
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">check_target_status</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_DATA_UNDERRUN</span>:
	<span class="k">case</span> <span class="n">CMD_DATA_OVERRUN</span>:
		<span class="cm">/* expected for inquiry and report lun commands */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_INVALID</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd 0x%02x is &quot;</span>
		       <span class="s">&quot;reported invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">IO_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_PROTOCOL_ERR</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd 0x%02x has &quot;</span>
		       <span class="s">&quot;protocol error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">IO_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_HARDWARE_ERR</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd 0x%02x had &quot;</span>
		       <span class="s">&quot; hardware error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">IO_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_CONNECTION_LOST</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd 0x%02x had &quot;</span>
		       <span class="s">&quot;connection lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">IO_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_ABORTED</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd 0x%02x was &quot;</span>
		       <span class="s">&quot;aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">IO_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_ABORT_FAILED</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd 0x%02x reports &quot;</span>
		       <span class="s">&quot;abort failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">IO_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_UNSOLICITED_ABORT</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unsolicited abort 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">IO_NEEDS_RETRY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_UNABORTABLE</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd unabortable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">IO_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd 0x%02x returned &quot;</span>
		       <span class="s">&quot;unknown status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		       <span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">);</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">IO_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">return_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sendcmd_withirq_core</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">attempt_retry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">u64bit</span> <span class="n">buff_dma_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">return_status</span> <span class="o">=</span> <span class="n">IO_OK</span><span class="p">;</span>

<span class="nl">resend_cmd2:</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">;</span>
	<span class="n">enqueue_cmd_and_start_io</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">attempt_retry</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">command_done</span><span class="p">;</span>

	<span class="n">return_status</span> <span class="o">=</span> <span class="n">process_sendcmd_error</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">return_status</span> <span class="o">==</span> <span class="n">IO_NEEDS_RETRY</span> <span class="o">&amp;&amp;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">&lt;</span> <span class="n">MAX_CMD_RETRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;retrying 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">retry_count</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* erase the old error information */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ErrorInfo_struct</span><span class="p">));</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">IO_OK</span><span class="p">;</span>
		<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">resend_cmd2</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">command_done:</span>
	<span class="cm">/* unlock the buffers from DMA */</span>
	<span class="n">buff_dma_handle</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span><span class="p">;</span>
	<span class="n">buff_dma_handle</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span><span class="p">;</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="n">buff_dma_handle</span><span class="p">.</span><span class="n">val</span><span class="p">,</span>
			 <span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Len</span><span class="p">,</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">return_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sendcmd_withirq</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
			   <span class="n">__u8</span> <span class="n">page_code</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsi3addr</span><span class="p">[],</span>
			<span class="kt">int</span> <span class="n">cmd_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">return_status</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">cmd_special_alloc</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">return_status</span> <span class="o">=</span> <span class="n">fill_cmd</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">page_code</span><span class="p">,</span>
		<span class="n">scsi3addr</span><span class="p">,</span> <span class="n">cmd_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">return_status</span> <span class="o">==</span> <span class="n">IO_OK</span><span class="p">)</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">sendcmd_withirq_core</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">cmd_special_free</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">return_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_geometry_inquiry</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">logvol</span><span class="p">,</span>
				   <span class="n">sector_t</span> <span class="n">total_size</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">,</span>
				   <span class="n">InquiryData_struct</span> <span class="o">*</span><span class="n">inq_buff</span><span class="p">,</span>
				   <span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">return_code</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsi3addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">inq_buff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryData_struct</span><span class="p">));</span>
	<span class="n">log_unit_to_scsi3addr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span> <span class="n">logvol</span><span class="p">);</span>
	<span class="n">return_code</span> <span class="o">=</span> <span class="n">sendcmd_withirq</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CISS_INQUIRY</span><span class="p">,</span> <span class="n">inq_buff</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">inq_buff</span><span class="p">),</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span> <span class="n">TYPE_CMD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">return_code</span> <span class="o">==</span> <span class="n">IO_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inq_buff</span><span class="o">-&gt;</span><span class="n">data_byte</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			       <span class="s">&quot;reading geometry failed, volume &quot;</span>
			       <span class="s">&quot;does not support reading geometry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>	<span class="cm">/* Sectors per track */</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">total_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">raid_level</span> <span class="o">=</span> <span class="n">RAID_UNKNOWN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="n">inq_buff</span><span class="o">-&gt;</span><span class="n">data_byte</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">inq_buff</span><span class="o">-&gt;</span><span class="n">data_byte</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="p">(</span><span class="n">inq_buff</span><span class="o">-&gt;</span><span class="n">data_byte</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">+=</span> <span class="n">inq_buff</span><span class="o">-&gt;</span><span class="n">data_byte</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">raid_level</span> <span class="o">=</span> <span class="n">inq_buff</span><span class="o">-&gt;</span><span class="n">data_byte</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">drv</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">block_size</span><span class="p">;</span>
		<span class="n">drv</span><span class="o">-&gt;</span><span class="n">nr_blocks</span> <span class="o">=</span> <span class="n">total_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">*</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sector_t</span> <span class="n">real_size</span> <span class="o">=</span> <span class="n">total_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rem</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">real_size</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rem</span><span class="p">)</span>
				<span class="n">real_size</span><span class="o">++</span><span class="p">;</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">real_size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* Get geometry failed */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reading geometry failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cciss_read_capacity</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">logvol</span><span class="p">,</span> <span class="n">sector_t</span> <span class="o">*</span><span class="n">total_size</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">block_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ReadCapdata_struct</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">return_code</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsi3addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ReadCapdata_struct</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">log_unit_to_scsi3addr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span> <span class="n">logvol</span><span class="p">);</span>
	<span class="n">return_code</span> <span class="o">=</span> <span class="n">sendcmd_withirq</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CCISS_READ_CAPACITY</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">ReadCapdata_struct</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span> <span class="n">TYPE_CMD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">return_code</span> <span class="o">==</span> <span class="n">IO_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">total_size</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">total_size</span><span class="p">);</span>
		<span class="o">*</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* read capacity command failed */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;read capacity failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">BLOCK_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_read_capacity_16</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">logvol</span><span class="p">,</span>
	<span class="n">sector_t</span> <span class="o">*</span><span class="n">total_size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">block_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ReadCapdata_struct_16</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">return_code</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsi3addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ReadCapdata_struct_16</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">log_unit_to_scsi3addr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span> <span class="n">logvol</span><span class="p">);</span>
	<span class="n">return_code</span> <span class="o">=</span> <span class="n">sendcmd_withirq</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CCISS_READ_CAPACITY_16</span><span class="p">,</span>
		<span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ReadCapdata_struct_16</span><span class="p">),</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span> <span class="n">TYPE_CMD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">return_code</span> <span class="o">==</span> <span class="n">IO_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">total_size</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be64</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">total_size</span><span class="p">);</span>
		<span class="o">*</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* read capacity command failed */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;read capacity failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">BLOCK_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;      blocks= %llu block_size= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">total_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">block_size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_revalidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">get_host</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">get_drv</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">logvol</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">FOUND</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">total_size</span><span class="p">;</span>
	<span class="n">InquiryData_struct</span> <span class="o">*</span><span class="n">inq_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">logvol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">logvol</span> <span class="o">&lt;=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">highest_lun</span><span class="p">;</span> <span class="n">logvol</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">logvol</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">logvol</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FOUND</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FOUND</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">inq_buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryData_struct</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inq_buff</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cciss_read</span> <span class="o">==</span> <span class="n">CCISS_READ_10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cciss_read_capacity</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">logvol</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">total_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cciss_read_capacity_16</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">logvol</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">total_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cciss_geometry_inquiry</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">logvol</span><span class="p">,</span> <span class="n">total_size</span><span class="p">,</span> <span class="n">block_size</span><span class="p">,</span>
			       <span class="n">inq_buff</span><span class="p">,</span> <span class="n">drv</span><span class="p">);</span>

	<span class="n">blk_queue_logical_block_size</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
	<span class="n">set_capacity</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">nr_blocks</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">inq_buff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Map (physical) PCI mem into (virtual) kernel space</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">remap_pci_mem</span><span class="p">(</span><span class="n">ulong</span> <span class="n">base</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">page_base</span> <span class="o">=</span> <span class="p">((</span><span class="n">ulong</span><span class="p">)</span> <span class="n">base</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">page_offs</span> <span class="o">=</span> <span class="p">((</span><span class="n">ulong</span><span class="p">)</span> <span class="n">base</span><span class="p">)</span> <span class="o">-</span> <span class="n">page_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">page_remapped</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">page_base</span><span class="p">,</span> <span class="n">page_offs</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">page_remapped</span> <span class="o">?</span> <span class="p">(</span><span class="n">page_remapped</span> <span class="o">+</span> <span class="n">page_offs</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Takes jobs of the Q and sends them to the hardware, then puts it on</span>
<span class="cm"> * the Q to wait for completion.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_io</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reqQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reqQ</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">CommandList_struct</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="cm">/* can&#39;t do anything if fifo is full */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">.</span><span class="n">fifo_full</span><span class="p">(</span><span class="n">h</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fifo full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Get the first entry from the Request Q */</span>
		<span class="n">removeQ</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">Qdepth</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/* Tell the controller execute command */</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">.</span><span class="n">submit_command</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

		<span class="cm">/* Put job onto the completed Q */</span>
		<span class="n">addQ</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmpQ</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Assumes that h-&gt;lock is held. */</span>
<span class="cm">/* Zeros out the error record and then resends the command back */</span>
<span class="cm">/* to the controller */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">resend_cciss_cmd</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* erase the old error information */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ErrorInfo_struct</span><span class="p">));</span>

	<span class="cm">/* add it to software queue and then send it to the controller */</span>
	<span class="n">addQ</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reqQ</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">Qdepth</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">Qdepth</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxQsinceinit</span><span class="p">)</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">maxQsinceinit</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">Qdepth</span><span class="p">;</span>

	<span class="n">start_io</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">make_status_bytes</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scsi_status_byte</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msg_byte</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">host_byte</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">driver_byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* inverse of macros in scsi.h */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">scsi_status_byte</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">msg_byte</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">host_byte</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">driver_byte</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">evaluate_target_status</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
			<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">retry_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sense_key</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status_byte</span><span class="p">,</span> <span class="n">msg_byte</span><span class="p">,</span> <span class="n">host_byte</span><span class="p">,</span> <span class="n">driver_byte</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error_value</span><span class="p">;</span>

	<span class="o">*</span><span class="n">retry_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* If we get in here, it means we got &quot;target status&quot;, that is, scsi status */</span>
	<span class="n">status_byte</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">ScsiStatus</span><span class="p">;</span>
	<span class="n">driver_byte</span> <span class="o">=</span> <span class="n">DRIVER_OK</span><span class="p">;</span>
	<span class="n">msg_byte</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">;</span> <span class="cm">/* correct?  seems too device specific */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span>
		<span class="n">host_byte</span> <span class="o">=</span> <span class="n">DID_PASSTHROUGH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">host_byte</span> <span class="o">=</span> <span class="n">DID_OK</span><span class="p">;</span>

	<span class="n">error_value</span> <span class="o">=</span> <span class="n">make_status_bytes</span><span class="p">(</span><span class="n">status_byte</span><span class="p">,</span> <span class="n">msg_byte</span><span class="p">,</span>
		<span class="n">host_byte</span><span class="p">,</span> <span class="n">driver_byte</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">ScsiStatus</span> <span class="o">!=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd %p &quot;</span>
			       <span class="s">&quot;has SCSI Status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">ScsiStatus</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error_value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check the sense key */</span>
	<span class="n">sense_key</span> <span class="o">=</span> <span class="mh">0xf</span> <span class="o">&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">SenseInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="cm">/* no status or recovered error */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">sense_key</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sense_key</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">))</span>
		<span class="n">error_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_for_unit_attention</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">retry_cmd</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Not SG_IO or similar? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error_value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd %p has CHECK CONDITION&quot;</span>
			       <span class="s">&quot; sense key = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">sense_key</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error_value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* SG_IO or similar, copy sense data back */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">&gt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">SenseLen</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">SenseLen</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">SenseInfo</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">error_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* checks the status of the job and calls complete buffers to mark all</span>
<span class="cm"> * buffers for the completed job. Note that this function does not need</span>
<span class="cm"> * to hold the hba/queue lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">complete_command</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retry_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>

	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">make_status_bytes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DRIVER_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* no error has occurred */</span>
		<span class="k">goto</span> <span class="n">after_error_processing</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CMD_TARGET_STATUS</span>:
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">evaluate_target_status</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retry_cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_DATA_UNDERRUN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd %p has&quot;</span>
			       <span class="s">&quot; completed with data underrun &quot;</span>
			       <span class="s">&quot;reported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">ResidualCnt</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_DATA_OVERRUN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cciss: cmd %p has&quot;</span>
			       <span class="s">&quot; completed with data overrun &quot;</span>
			       <span class="s">&quot;reported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_INVALID</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cciss: cmd %p is &quot;</span>
		       <span class="s">&quot;reported invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">make_status_bytes</span><span class="p">(</span><span class="n">SAM_STAT_GOOD</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">,</span> <span class="n">DRIVER_OK</span><span class="p">,</span>
			<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">DID_PASSTHROUGH</span> <span class="o">:</span> <span class="n">DID_ERROR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_PROTOCOL_ERR</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cciss: cmd %p has &quot;</span>
		       <span class="s">&quot;protocol error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">make_status_bytes</span><span class="p">(</span><span class="n">SAM_STAT_GOOD</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">,</span> <span class="n">DRIVER_OK</span><span class="p">,</span>
			<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">DID_PASSTHROUGH</span> <span class="o">:</span> <span class="n">DID_ERROR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_HARDWARE_ERR</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cciss: cmd %p had &quot;</span>
		       <span class="s">&quot; hardware error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">make_status_bytes</span><span class="p">(</span><span class="n">SAM_STAT_GOOD</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">,</span> <span class="n">DRIVER_OK</span><span class="p">,</span>
			<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">DID_PASSTHROUGH</span> <span class="o">:</span> <span class="n">DID_ERROR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_CONNECTION_LOST</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cciss: cmd %p had &quot;</span>
		       <span class="s">&quot;connection lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">make_status_bytes</span><span class="p">(</span><span class="n">SAM_STAT_GOOD</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">,</span> <span class="n">DRIVER_OK</span><span class="p">,</span>
			<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">DID_PASSTHROUGH</span> <span class="o">:</span> <span class="n">DID_ERROR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_ABORTED</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cciss: cmd %p was &quot;</span>
		       <span class="s">&quot;aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">make_status_bytes</span><span class="p">(</span><span class="n">SAM_STAT_GOOD</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">,</span> <span class="n">DRIVER_OK</span><span class="p">,</span>
			<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">DID_PASSTHROUGH</span> <span class="o">:</span> <span class="n">DID_ABORT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_ABORT_FAILED</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cciss: cmd %p reports &quot;</span>
		       <span class="s">&quot;abort failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">make_status_bytes</span><span class="p">(</span><span class="n">SAM_STAT_GOOD</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">,</span> <span class="n">DRIVER_OK</span><span class="p">,</span>
			<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">DID_PASSTHROUGH</span> <span class="o">:</span> <span class="n">DID_ERROR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_UNSOLICITED_ABORT</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cciss%d: unsolicited &quot;</span>
		       <span class="s">&quot;abort %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">&lt;</span> <span class="n">MAX_CMD_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retry_cmd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;retrying %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">retry_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%p retried too many times</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">make_status_bytes</span><span class="p">(</span><span class="n">SAM_STAT_GOOD</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">,</span> <span class="n">DRIVER_OK</span><span class="p">,</span>
			<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">DID_PASSTHROUGH</span> <span class="o">:</span> <span class="n">DID_ABORT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_TIMEOUT</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd %p timedout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">make_status_bytes</span><span class="p">(</span><span class="n">SAM_STAT_GOOD</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">,</span> <span class="n">DRIVER_OK</span><span class="p">,</span>
			<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">DID_PASSTHROUGH</span> <span class="o">:</span> <span class="n">DID_ERROR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CMD_UNABORTABLE</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd %p unabortable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">make_status_bytes</span><span class="p">(</span><span class="n">SAM_STAT_GOOD</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">,</span> <span class="n">DRIVER_OK</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span> <span class="o">?</span>
				<span class="n">DID_PASSTHROUGH</span> <span class="o">:</span> <span class="n">DID_ERROR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd %p returned &quot;</span>
		       <span class="s">&quot;unknown status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
		       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">);</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">make_status_bytes</span><span class="p">(</span><span class="n">SAM_STAT_GOOD</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">,</span> <span class="n">DRIVER_OK</span><span class="p">,</span>
			<span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">DID_PASSTHROUGH</span> <span class="o">:</span> <span class="n">DID_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">after_error_processing:</span>

	<span class="cm">/* We need to return this command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retry_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resend_cciss_cmd</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">completion_data</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">blk_complete_request</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">cciss_tag_contains_index</span><span class="p">(</span><span class="n">u32</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define DIRECT_LOOKUP_BIT 0x10</span>
	<span class="k">return</span> <span class="n">tag</span> <span class="o">&amp;</span> <span class="n">DIRECT_LOOKUP_BIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">cciss_tag_to_index</span><span class="p">(</span><span class="n">u32</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define DIRECT_LOOKUP_SHIFT 5</span>
	<span class="k">return</span> <span class="n">tag</span> <span class="o">&gt;&gt;</span> <span class="n">DIRECT_LOOKUP_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">cciss_tag_discard_error_bits</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define CCISS_PERF_ERROR_BITS ((1 &lt;&lt; DIRECT_LOOKUP_SHIFT) - 1)</span>
<span class="cp">#define CCISS_SIMPLE_ERROR_BITS 0x03</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transMethod</span> <span class="o">&amp;</span> <span class="n">CFGTBL_Trans_Performant</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">tag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CCISS_PERF_ERROR_BITS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CCISS_SIMPLE_ERROR_BITS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cciss_mark_tag_indexed</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">tag</span> <span class="o">|=</span> <span class="n">DIRECT_LOOKUP_BIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cciss_set_tag_index</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">tag</span> <span class="o">|=</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">DIRECT_LOOKUP_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get a request and submit it to the controller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_cciss_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">queuedata</span><span class="p">;</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="n">sector_t</span> <span class="n">start_blk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">seg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">creq</span><span class="p">;</span>
	<span class="n">u64bit</span> <span class="n">temp64</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">tmp_sg</span><span class="p">;</span>
	<span class="n">SGDescriptor_struct</span> <span class="o">*</span><span class="n">curr_sg</span><span class="p">;</span>
	<span class="n">drive_info_struct</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">dir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chained</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">queue:</span>
	<span class="n">creq</span> <span class="o">=</span> <span class="n">blk_peek_request</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">creq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">startio</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">creq</span><span class="o">-&gt;</span><span class="n">nr_phys_segments</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxsgentries</span><span class="p">);</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">cmd_alloc</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">full</span><span class="p">;</span>

	<span class="n">blk_start_request</span><span class="p">(</span><span class="n">creq</span><span class="p">);</span>

	<span class="n">tmp_sg</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">scatter_list</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cmdindex</span><span class="p">];</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">CMD_RWREQ</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">=</span> <span class="n">creq</span><span class="p">;</span>

	<span class="cm">/* fill in the request */</span>
	<span class="n">drv</span> <span class="o">=</span> <span class="n">creq</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">ReplyQueue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* unused in simple mode */</span>
	<span class="cm">/* got command from pool, so use the command block index instead */</span>
	<span class="cm">/* for direct lookups. */</span>
	<span class="cm">/* The first 2 bits are reserved for controller error reporting. */</span>
	<span class="n">cciss_set_tag_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">Tag</span><span class="p">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">cmdindex</span><span class="p">);</span>
	<span class="n">cciss_mark_tag_indexed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">Tag</span><span class="p">.</span><span class="n">lower</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">LUN</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">LunID</span><span class="p">));</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDBLen</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* 12 byte commands not in FW yet; */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">TYPE_CMD</span><span class="p">;</span>	<span class="cm">/* It is a command. */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Attribute</span> <span class="o">=</span> <span class="n">ATTR_SIMPLE</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">creq</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span> <span class="o">?</span> <span class="n">XFER_READ</span> <span class="o">:</span> <span class="n">XFER_WRITE</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Don&#39;t time out */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">creq</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span> <span class="o">?</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">cciss_read</span> <span class="o">:</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">cciss_write</span><span class="p">;</span>
	<span class="n">start_blk</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">creq</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sector =%d nr_sectors=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">creq</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">creq</span><span class="p">));</span>
	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">tmp_sg</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxsgentries</span><span class="p">);</span>
	<span class="n">seg</span> <span class="o">=</span> <span class="n">blk_rq_map_sg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">creq</span><span class="p">,</span> <span class="n">tmp_sg</span><span class="p">);</span>

	<span class="cm">/* get the DMA records for the setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">==</span> <span class="n">XFER_READ</span><span class="p">)</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">;</span>

	<span class="n">curr_sg</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">;</span>
	<span class="n">sg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chained</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">seg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">sg_index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">max_cmd_sgentries</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">chained</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">seg</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Point to next chain block. */</span>
			<span class="n">curr_sg</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_sg_list</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cmdindex</span><span class="p">];</span>
			<span class="n">sg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">chained</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">curr_sg</span><span class="p">[</span><span class="n">sg_index</span><span class="p">].</span><span class="n">Len</span> <span class="o">=</span> <span class="n">tmp_sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		<span class="n">temp64</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_sg</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
						<span class="n">tmp_sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span>
						<span class="n">tmp_sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
		<span class="n">curr_sg</span><span class="p">[</span><span class="n">sg_index</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">lower</span><span class="p">;</span>
		<span class="n">curr_sg</span><span class="p">[</span><span class="n">sg_index</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">upper</span><span class="p">;</span>
		<span class="n">curr_sg</span><span class="p">[</span><span class="n">sg_index</span><span class="p">].</span><span class="n">Ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* we are not chaining */</span>
		<span class="o">++</span><span class="n">sg_index</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chained</span><span class="p">)</span>
		<span class="n">cciss_map_sg_chain_block</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_sg_list</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cmdindex</span><span class="p">],</span>
			<span class="p">(</span><span class="n">seg</span> <span class="o">-</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">max_cmd_sgentries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">SGDescriptor_struct</span><span class="p">));</span>

	<span class="cm">/* track how many SG entries we are using */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seg</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxSG</span><span class="p">)</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">maxSG</span> <span class="o">=</span> <span class="n">seg</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Submitting %u sectors in %d segments &quot;</span>
			<span class="s">&quot;chained[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">creq</span><span class="p">),</span> <span class="n">seg</span><span class="p">,</span> <span class="n">chained</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGTotal</span> <span class="o">=</span> <span class="n">seg</span> <span class="o">+</span> <span class="n">chained</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seg</span> <span class="o">&lt;=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_cmd_sgentries</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGList</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGTotal</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGList</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_cmd_sgentries</span><span class="p">;</span>
	<span class="n">set_performant_mode</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">creq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_FS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cciss_read</span> <span class="o">==</span> <span class="n">CCISS_READ_10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* MSB */</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_blk</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* (sect &gt;&gt; 24) &amp; 0xff; MSB */</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">creq</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">creq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">upper32</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">start_blk</span><span class="p">);</span>

			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDBLen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">upper32</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* MSB */</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">upper32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">upper32</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span> <span class="n">upper32</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">start_blk</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">=</span> <span class="n">start_blk</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">creq</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">creq</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">creq</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">creq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">creq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDBLen</span> <span class="o">=</span> <span class="n">creq</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">,</span> <span class="n">creq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">BLK_MAX_CDB</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad request type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">creq</span><span class="o">-&gt;</span><span class="n">cmd_type</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>

	<span class="n">addQ</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reqQ</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">Qdepth</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">Qdepth</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxQsinceinit</span><span class="p">)</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">maxQsinceinit</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">Qdepth</span><span class="p">;</span>

	<span class="k">goto</span> <span class="n">queue</span><span class="p">;</span>
<span class="nl">full:</span>
	<span class="n">blk_stop_queue</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="nl">startio:</span>
	<span class="cm">/* We will already have the driver lock here so not need</span>
<span class="cm">	 * to lock it.</span>
<span class="cm">	 */</span>
	<span class="n">start_io</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">get_next_completion</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">.</span><span class="n">command_completed</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">interrupt_pending</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">.</span><span class="n">intr_pending</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span> <span class="nf">interrupt_not_for_us</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">.</span><span class="n">intr_pending</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">interrupts_enabled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bad_tag</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tag_index</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">raw_tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tag_index</span> <span class="o">&gt;=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad tag 0x%08x ignored.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_tag</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">finish_cmd</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">raw_tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">removeQ</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">CMD_RWREQ</span><span class="p">))</span>
		<span class="n">complete_command</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">CMD_IOCTL_PEND</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">waiting</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_CISS_SCSI_TAPE</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">CMD_SCSI</span><span class="p">)</span>
		<span class="n">complete_scsi_command</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">raw_tag</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">next_command</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">a</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transMethod</span> <span class="o">&amp;</span> <span class="n">CFGTBL_Trans_Performant</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">.</span><span class="n">command_completed</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool_head</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool_wraparound</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">a</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool_head</span><span class="p">);</span> <span class="cm">/* Next cmd in ring buffer */</span>
		<span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool_head</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">commands_outstanding</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">FIFO_EMPTY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Check for wraparound */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool_head</span> <span class="o">==</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool</span> <span class="o">+</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool_head</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool_wraparound</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* process completion of an indexed (&quot;direct lookup&quot;) command */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">process_indexed_cmd</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">u32</span> <span class="n">raw_tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tag_index</span><span class="p">;</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">tag_index</span> <span class="o">=</span> <span class="n">cciss_tag_to_index</span><span class="p">(</span><span class="n">raw_tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bad_tag</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">tag_index</span><span class="p">,</span> <span class="n">raw_tag</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">next_command</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool</span> <span class="o">+</span> <span class="n">tag_index</span><span class="p">;</span>
	<span class="n">finish_cmd</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">raw_tag</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">next_command</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* process completion of a non-indexed command */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">process_nonindexed_cmd</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">u32</span> <span class="n">raw_tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">busaddr_masked</span><span class="p">,</span> <span class="n">tag_masked</span><span class="p">;</span>

	<span class="n">tag_masked</span> <span class="o">=</span> <span class="n">cciss_tag_discard_error_bits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">raw_tag</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmpQ</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">busaddr_masked</span> <span class="o">=</span> <span class="n">cciss_tag_discard_error_bits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">busaddr_masked</span> <span class="o">==</span> <span class="n">tag_masked</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">finish_cmd</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">raw_tag</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">next_command</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">bad_tag</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">raw_tag</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">next_command</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Some controllers, like p400, will give us one interrupt</span>
<span class="cm"> * after a soft reset, even if we turned interrupts off.</span>
<span class="cm"> * Only need to check for this in the cciss_xxx_discard_completions</span>
<span class="cm"> * functions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ignore_bogus_interrupt</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">reset_devices</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">interrupts_enabled</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Received interrupt while interrupts disabled &quot;</span>
		<span class="s">&quot;(known firmware bug.)  Ignoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">cciss_intx_discard_completions</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">raw_tag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ignore_bogus_interrupt</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interrupt_not_for_us</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">interrupt_pending</span><span class="p">(</span><span class="n">h</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">raw_tag</span> <span class="o">=</span> <span class="n">get_next_completion</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">raw_tag</span> <span class="o">!=</span> <span class="n">FIFO_EMPTY</span><span class="p">)</span>
			<span class="n">raw_tag</span> <span class="o">=</span> <span class="n">next_command</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">cciss_msix_discard_completions</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">raw_tag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ignore_bogus_interrupt</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">raw_tag</span> <span class="o">=</span> <span class="n">get_next_completion</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">raw_tag</span> <span class="o">!=</span> <span class="n">FIFO_EMPTY</span><span class="p">)</span>
		<span class="n">raw_tag</span> <span class="o">=</span> <span class="n">next_command</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">do_cciss_intx</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">raw_tag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interrupt_not_for_us</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">interrupt_pending</span><span class="p">(</span><span class="n">h</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">raw_tag</span> <span class="o">=</span> <span class="n">get_next_completion</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">raw_tag</span> <span class="o">!=</span> <span class="n">FIFO_EMPTY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cciss_tag_contains_index</span><span class="p">(</span><span class="n">raw_tag</span><span class="p">))</span>
				<span class="n">raw_tag</span> <span class="o">=</span> <span class="n">process_indexed_cmd</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">raw_tag</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">raw_tag</span> <span class="o">=</span> <span class="n">process_nonindexed_cmd</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">raw_tag</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Add a second interrupt handler for MSI/MSI-X mode. In this mode we never</span>
<span class="cm"> * check the interrupt pending register because it is not set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">do_cciss_msix_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">raw_tag</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">raw_tag</span> <span class="o">=</span> <span class="n">get_next_completion</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">raw_tag</span> <span class="o">!=</span> <span class="n">FIFO_EMPTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cciss_tag_contains_index</span><span class="p">(</span><span class="n">raw_tag</span><span class="p">))</span>
			<span class="n">raw_tag</span> <span class="o">=</span> <span class="n">process_indexed_cmd</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">raw_tag</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">raw_tag</span> <span class="o">=</span> <span class="n">process_nonindexed_cmd</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">raw_tag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * add_to_scan_list() - add controller to rescan queue</span>
<span class="cm"> * @h:		      Pointer to the controller.</span>
<span class="cm"> *</span>
<span class="cm"> * Adds the controller to the rescan queue if not already on the queue.</span>
<span class="cm"> *</span>
<span class="cm"> * returns 1 if added to the queue, 0 if skipped (could be on the</span>
<span class="cm"> * queue already, or the controller could be initializing or shutting</span>
<span class="cm"> * down).</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_to_scan_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">test_h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_initializing</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_shutting_down</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">test_h</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_q</span><span class="p">,</span> <span class="n">scan_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_h</span> <span class="o">==</span> <span class="n">h</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_scanning</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scan_wait</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scan_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_q</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_shutting_down</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * remove_from_scan_list() - remove controller from rescan queue</span>
<span class="cm"> * @h:			   Pointer to the controller.</span>
<span class="cm"> *</span>
<span class="cm"> * Removes the controller from the rescan queue if present. Blocks if</span>
<span class="cm"> * the controller is currently conducting a rescan.  The controller</span>
<span class="cm"> * can be in one of three states:</span>
<span class="cm"> * 1. Doesn&#39;t need a scan</span>
<span class="cm"> * 2. On the scan list, but not scanning yet (we remove it)</span>
<span class="cm"> * 3. Busy scanning (and not on the list). In this case we want to wait for</span>
<span class="cm"> *    the scan to complete to make sure the scanning thread for this</span>
<span class="cm"> *    controller is completely idle.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_from_scan_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">test_h</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_h</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">test_h</span><span class="p">,</span> <span class="n">tmp_h</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_q</span><span class="p">,</span> <span class="n">scan_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_h</span> <span class="o">==</span> <span class="n">h</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* state 2. */</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scan_list</span><span class="p">);</span>
			<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scan_wait</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_mutex</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_scanning</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* state 3. */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_mutex</span><span class="p">);</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scan_wait</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* state 1, nothing to do. */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * scan_thread() - kernel thread used to rescan controllers</span>
<span class="cm"> * @data:	 Ignored.</span>
<span class="cm"> *</span>
<span class="cm"> * A kernel thread used scan for drive topology changes on</span>
<span class="cm"> * controllers. The thread processes only one controller at a time</span>
<span class="cm"> * using a queue.  Controllers are added to the queue using</span>
<span class="cm"> * add_to_scan_list() and removed from the queue either after done</span>
<span class="cm"> * processing or using remove_from_scan_list().</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scan_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_mutex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_q</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_mutex</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">h</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">scan_q</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ctlr_info</span><span class="p">,</span>
				       <span class="n">scan_list</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scan_list</span><span class="p">);</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_scanning</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_mutex</span><span class="p">);</span>

			<span class="n">rebuild_lun_table</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scan_wait</span><span class="p">);</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_mutex</span><span class="p">);</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_scanning</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_mutex</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_for_unit_attention</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">SenseInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">UNIT_ATTENTION</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">SenseInfo</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STATE_CHANGED</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;a state change &quot;</span>
			<span class="s">&quot;detected, command retried</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LUN_FAILED</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;LUN failure &quot;</span>
			<span class="s">&quot;detected, action required</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_LUNS_CHANGED</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;report LUN data changed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Here, we could call add_to_scan_list and wake up the scan thread,</span>
<span class="cm">	 * except that it&#39;s quite likely that we will get more than one</span>
<span class="cm">	 * REPORT_LUNS_CHANGED condition in quick succession, which means</span>
<span class="cm">	 * that those which occur after the first one will likely happen</span>
<span class="cm">	 * *during* the scan_thread&#39;s rescan.  And the rescan code is not</span>
<span class="cm">	 * robust enough to restart in the middle, undoing what it has already</span>
<span class="cm">	 * done, and it&#39;s not clear that it&#39;s even possible to do this, since</span>
<span class="cm">	 * part of what it does is notify the block layer, which starts</span>
<span class="cm">	 * doing it&#39;s own i/o to read partition tables and so on, and the</span>
<span class="cm">	 * driver doesn&#39;t have visibility to know what might need undoing.</span>
<span class="cm">	 * In any event, if possible, it is horribly complicated to get right</span>
<span class="cm">	 * so we just don&#39;t do it for now.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: this REPORT_LUNS_CHANGED condition only occurs on the MSA2012.</span>
<span class="cm">	 */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_OR_RESET</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;a power on or device reset detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UNIT_ATTENTION_CLEARED</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;unit attention cleared by another initiator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown unit attention detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  We cannot read the structure directly, for portability we must use</span>
<span class="cm"> *   the io functions.</span>
<span class="cm"> *   This is for debug only.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_cfg_table</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">temp_name</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
	<span class="n">CfgTable_struct</span> <span class="o">*</span><span class="n">tb</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Controller Configuration information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">temp_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="n">temp_name</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;   Signature = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp_name</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;   Spec Number = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">SpecValence</span><span class="p">)));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;   Transport methods supported = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">TransportSupport</span><span class="p">)));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;   Transport methods active = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">TransportActive</span><span class="p">)));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;   Requested transport Method = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">HostWrite</span><span class="p">.</span><span class="n">TransportRequest</span><span class="p">)));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;   Coalesce Interrupt Delay = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">HostWrite</span><span class="p">.</span><span class="n">CoalIntDelay</span><span class="p">)));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;   Coalesce Interrupt Count = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">HostWrite</span><span class="p">.</span><span class="n">CoalIntCount</span><span class="p">)));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;   Max outstanding commands = 0x%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">CmdsOutMax</span><span class="p">)));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;   Bus Types = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">BusTypes</span><span class="p">)));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">temp_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">ServerName</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="n">temp_name</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;   Server Name = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp_name</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;   Heartbeat Counter = 0x%x</span><span class="se">\n\n\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">HeartBeat</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_PCI_BAR_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pci_bar_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">mem_type</span><span class="p">,</span> <span class="n">bar_type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_bar_addr</span> <span class="o">==</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">)</span>	<span class="cm">/* looking for BAR zero? */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DEVICE_COUNT_RESOURCE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bar_type</span> <span class="o">=</span> <span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_SPACE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bar_type</span> <span class="o">==</span> <span class="n">PCI_BASE_ADDRESS_SPACE_IO</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">mem_type</span> <span class="o">=</span> <span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_MASK</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">mem_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_32</span>:
			<span class="k">case</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_1M</span>:
				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* 32 bit */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span>:
				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>	<span class="cm">/* reserved in PCI 2.2 */</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				       <span class="s">&quot;Base address is invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="n">pci_bar_addr</span> <span class="o">-</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Fill in bucket_map[], given nsgs (the max number of</span>
<span class="cm"> * scatter gather elements supported) and bucket[],</span>
<span class="cm"> * which is an array of 8 integers.  The bucket[] array</span>
<span class="cm"> * contains 8 different DMA transfer sizes (in 16</span>
<span class="cm"> * byte increments) which the controller uses to fetch</span>
<span class="cm"> * commands.  This function fills in bucket_map[], which</span>
<span class="cm"> * maps a given number of scatter gather elements to one of</span>
<span class="cm"> * the 8 DMA transfer sizes.  The point of it is to allow the</span>
<span class="cm"> * controller to only do as much DMA as needed to fetch the</span>
<span class="cm"> * command, with the DMA transfer size encoded in the lower</span>
<span class="cm"> * bits of the command address.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="nf">calc_bucket_map</span><span class="p">(</span><span class="kt">int</span> <span class="n">bucket</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num_buckets</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">nsgs</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bucket_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* even a command with 0 SGs requires 4 blocks */</span>
<span class="cp">#define MINIMUM_TRANSFER_BLOCKS 4</span>
<span class="cp">#define NUM_BUCKETS 8</span>
	<span class="cm">/* Note, bucket_map must have nsgs+1 entries. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">nsgs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Compute size of a command with i SG entries */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">MINIMUM_TRANSFER_BLOCKS</span><span class="p">;</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">num_buckets</span><span class="p">;</span> <span class="cm">/* Assume the biggest bucket */</span>
		<span class="cm">/* Find the bucket that is just big enough */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bucket</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* for a command with i SG entries, use bucket b. */</span>
		<span class="n">bucket_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">cciss_wait_for_mode_change_ack</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* under certain very rare conditions, this can take awhile.</span>
<span class="cm">	 * (e.g.: hot replace a failed 144GB drive in a RAID 5 set right</span>
<span class="cm">	 * as we enter this code.) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CONFIG_WAIT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">SA5_DOORBELL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CFGTBL_ChangeReq</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">void</span> <span class="nf">cciss_enter_performant_mode</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">use_short_tags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is a bit complicated.  There are 8 registers on</span>
<span class="cm">	 * the controller which we write to to tell it 8 different</span>
<span class="cm">	 * sizes of commands which there may be.  It&#39;s a way of</span>
<span class="cm">	 * reducing the DMA done to fetch each command.  Encoded into</span>
<span class="cm">	 * each command&#39;s tag are 3 bits which communicate to the controller</span>
<span class="cm">	 * which of the eight sizes that command fits within.  The size of</span>
<span class="cm">	 * each command depends on how many scatter gather entries there are.</span>
<span class="cm">	 * Each SG entry requires 16 bytes.  The eight registers are programmed</span>
<span class="cm">	 * with the number of 16-byte blocks a command of that size requires.</span>
<span class="cm">	 * The smallest command possible requires 5 such 16 byte blocks.</span>
<span class="cm">	 * the largest command possible requires MAXSGENTRIES + 4 16-byte</span>
<span class="cm">	 * blocks.  Note, this only extends to the SG entries contained</span>
<span class="cm">	 * within the command block, and does not extend to chained blocks</span>
<span class="cm">	 * of SG elements.   bft[] contains the eight values we write to</span>
<span class="cm">	 * the registers.  They are not evenly distributed, but have more</span>
<span class="cm">	 * sizes for small commands, and fewer sizes for larger commands.</span>
<span class="cm">	 */</span>
	<span class="n">__u32</span> <span class="n">trans_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bft</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="n">MAXSGENTRIES</span> <span class="o">+</span> <span class="mi">4</span><span class="p">};</span>
			<span class="cm">/*</span>
<span class="cm">			 *  5 = 1 s/g entry or 4k</span>
<span class="cm">			 *  6 = 2 s/g entry or 8k</span>
<span class="cm">			 *  8 = 4 s/g entry or 16k</span>
<span class="cm">			 * 10 = 6 s/g entry or 24k</span>
<span class="cm">			 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">register_value</span><span class="p">;</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="mi">28</span> <span class="o">&gt;</span> <span class="n">MAXSGENTRIES</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool_wraparound</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* spec: init to 1 */</span>

	<span class="cm">/* Controller spec: zero out this buffer. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u64</span><span class="p">));</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool_head</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool</span><span class="p">;</span>

	<span class="n">trans_offset</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">TransMethodOffset</span><span class="p">));</span>
	<span class="n">calc_bucket_map</span><span class="p">(</span><span class="n">bft</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bft</span><span class="p">),</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxsgentries</span><span class="p">,</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">blockFetchTable</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">bft</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="o">-&gt;</span><span class="n">BlockFetch0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">bft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="o">-&gt;</span><span class="n">BlockFetch1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">bft</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="o">-&gt;</span><span class="n">BlockFetch2</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">bft</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="o">-&gt;</span><span class="n">BlockFetch3</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">bft</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="o">-&gt;</span><span class="n">BlockFetch4</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">bft</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="o">-&gt;</span><span class="n">BlockFetch5</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">bft</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="o">-&gt;</span><span class="n">BlockFetch6</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">bft</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="o">-&gt;</span><span class="n">BlockFetch7</span><span class="p">);</span>

	<span class="cm">/* size of controller ring buffer */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="o">-&gt;</span><span class="n">RepQSize</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="o">-&gt;</span><span class="n">RepQCount</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="o">-&gt;</span><span class="n">RepQCtrAddrLow32</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="o">-&gt;</span><span class="n">RepQCtrAddrHigh32</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool_dhandle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="o">-&gt;</span><span class="n">RepQAddr0Low32</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="o">-&gt;</span><span class="n">RepQAddr0High32</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">CFGTBL_Trans_Performant</span> <span class="o">|</span> <span class="n">use_short_tags</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">HostWrite</span><span class="p">.</span><span class="n">TransportRequest</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">CFGTBL_ChangeReq</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">SA5_DOORBELL</span><span class="p">);</span>
	<span class="n">cciss_wait_for_mode_change_ack</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">register_value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">TransportActive</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">register_value</span> <span class="o">&amp;</span> <span class="n">CFGTBL_Trans_Performant</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cciss: unable to get board into&quot;</span>
					<span class="s">&quot; performant mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">cciss_put_controller_into_performant_mode</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">trans_support</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cciss_simple_mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Trying to put board into Performant mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Attempt to put controller into performant mode if supported */</span>
	<span class="cm">/* Does board support performant mode? */</span>
	<span class="n">trans_support</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">TransportSupport</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">trans_support</span> <span class="o">&amp;</span> <span class="n">PERFORMANT_MODE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Placing controller into performant mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Performant mode demands commands on a 32 byte boundary</span>
<span class="cm">	 * pci_alloc_consistent aligns on page boundarys already.</span>
<span class="cm">	 * Just need to check if divisible by 32</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">CommandList_struct</span><span class="p">)</span> <span class="o">%</span> <span class="mi">32</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;cciss info: command size[&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">CommandList_struct</span><span class="p">),</span>
			<span class="s">&quot;] not divisible by 32, no performant mode..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Performant mode ring buffer and supporting data structures */</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_alloc_consistent</span><span class="p">(</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u64</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool_dhandle</span><span class="p">));</span>

	<span class="cm">/* Need a block fetch table for performant mode */</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">blockFetchTable</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(((</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">maxsgentries</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">)),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">blockFetchTable</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clean_up</span><span class="p">;</span>

	<span class="n">cciss_enter_performant_mode</span><span class="p">(</span><span class="n">h</span><span class="p">,</span>
		<span class="n">trans_support</span> <span class="o">&amp;</span> <span class="n">CFGTBL_Trans_use_short_tags</span><span class="p">);</span>

	<span class="cm">/* Change the access methods to the performant access methods */</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">access</span> <span class="o">=</span> <span class="n">SA5_performant_access</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">transMethod</span> <span class="o">=</span> <span class="n">CFGTBL_Trans_Performant</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="nl">clean_up:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">blockFetchTable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u64</span><span class="p">),</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool</span><span class="p">,</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool_dhandle</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span> <span class="cm">/* cciss_put_controller_into_performant_mode */</span>

<span class="cm">/* If MSI/MSI-X is supported by the kernel we will try to enable it on</span>
<span class="cm"> * controllers that are capable. If not, we use IO-APIC mode.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">cciss_interrupt_mode</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="n">cciss_msix_entries</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="cm">/* Some boards advertise MSI but don&#39;t really support it */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">board_id</span> <span class="o">==</span> <span class="mh">0x40700E11</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">board_id</span> <span class="o">==</span> <span class="mh">0x40800E11</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">board_id</span> <span class="o">==</span> <span class="mh">0x40820E11</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">board_id</span> <span class="o">==</span> <span class="mh">0x40830E11</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">default_int_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_find_capability</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cciss_msix_entries</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cciss_msix_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cciss_msix_entries</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cciss_msix_entries</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cciss_msix_entries</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">msix_vector</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;only %d MSI-X vectors available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">default_int_mode</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;MSI-X init failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">default_int_mode</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_find_capability</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSI</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">msi_vector</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MSI init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">default_int_mode:</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>
	<span class="cm">/* if we get here we&#39;re going to use the default interrupt mode */</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr_mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cciss_lookup_board_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">board_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">subsystem_vendor_id</span><span class="p">,</span> <span class="n">subsystem_device_id</span><span class="p">;</span>

	<span class="n">subsystem_vendor_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>
	<span class="n">subsystem_device_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="o">*</span><span class="n">board_id</span> <span class="o">=</span> <span class="p">((</span><span class="n">subsystem_device_id</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">subsystem_vendor_id</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">products</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">board_id</span> <span class="o">==</span> <span class="n">products</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">board_id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unrecognized board ID: 0x%08x, ignoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">*</span><span class="n">board_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">cciss_board_disabled</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">command</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_MEMORY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cciss_pci_find_memory_BAR</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">memory_bar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DEVICE_COUNT_RESOURCE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* addressing mode bits already removed */</span>
			<span class="o">*</span><span class="n">memory_bar</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;memory BAR = %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="o">*</span><span class="n">memory_bar</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no memory BAR found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">cciss_wait_for_board_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait_for_ready</span><span class="p">)</span>
<span class="cp">#define BOARD_READY 1</span>
<span class="cp">#define BOARD_NOT_READY 0</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">iterations</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scratchpad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_ready</span><span class="p">)</span>
		<span class="n">iterations</span> <span class="o">=</span> <span class="n">CCISS_BOARD_READY_ITERATIONS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">iterations</span> <span class="o">=</span> <span class="n">CCISS_BOARD_NOT_READY_ITERATIONS</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iterations</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scratchpad</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">SA5_SCRATCHPAD_OFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_ready</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scratchpad</span> <span class="o">==</span> <span class="n">CCISS_FIRMWARE_READY</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scratchpad</span> <span class="o">!=</span> <span class="n">CCISS_FIRMWARE_READY</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">CCISS_BOARD_READY_POLL_INTERVAL_MSECS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;board not ready, timed out.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">cciss_find_cfg_addrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">cfg_base_addr</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">cfg_base_addr_index</span><span class="p">,</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">cfg_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">cfg_base_addr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">SA5_CTCFG_OFFSET</span><span class="p">);</span>
	<span class="o">*</span><span class="n">cfg_offset</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">SA5_CTMEM_OFFSET</span><span class="p">);</span>
	<span class="o">*</span><span class="n">cfg_base_addr</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cfg_base_addr_index</span> <span class="o">=</span> <span class="n">find_PCI_BAR_index</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">*</span><span class="n">cfg_base_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cfg_base_addr_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot find cfg_base_addr_index, &quot;</span>
			<span class="s">&quot;*cfg_base_addr = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">cfg_base_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">cciss_find_cfgtables</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">cfg_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg_base_addr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cfg_base_addr_index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">trans_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cciss_find_cfg_addrs</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_base_addr</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">cfg_base_addr_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span> <span class="o">=</span> <span class="n">remap_pci_mem</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
		<span class="n">cfg_base_addr_index</span><span class="p">)</span> <span class="o">+</span> <span class="n">cfg_offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">write_driver_ver_to_cfgtable</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* Find performant mode table. */</span>
	<span class="n">trans_offset</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">TransMethodOffset</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span> <span class="o">=</span> <span class="n">remap_pci_mem</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">cfg_base_addr_index</span><span class="p">)</span><span class="o">+</span><span class="n">cfg_offset</span><span class="o">+</span><span class="n">trans_offset</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="n">cciss_get_max_perf_mode_cmds</span><span class="p">(</span><span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">MaxPerformantModeCommands</span><span class="p">));</span>

	<span class="cm">/* Limit commands in memory limited kdump scenario. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset_devices</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Controller reports &quot;</span>
			<span class="s">&quot;max supported commands of %d, an obvious lie. &quot;</span>
			<span class="s">&quot;Using 16.  Ensure that firmware is up to date.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span><span class="p">);</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Interrogate the hardware for some limits:</span>
<span class="cm"> * max commands, max SG elements without chaining, and with chaining,</span>
<span class="cm"> * SG chain block size, etc.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="n">cciss_find_board_params</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cciss_get_max_perf_mode_cmds</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">cciss_tape_cmds</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">maxsgentries</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">MaxSGElements</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * Limit in-command s/g elements to 32 save dma&#39;able memory.</span>
<span class="cm">	 * Howvever spec says if 0, use 31</span>
<span class="cm">	 */</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">max_cmd_sgentries</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">maxsgentries</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">max_cmd_sgentries</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">chainsize</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxsgentries</span> <span class="o">-</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_cmd_sgentries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">maxsgentries</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* save one for chain pointer */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">maxsgentries</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span> <span class="cm">/* default to traditional values */</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">chainsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="n">CISS_signature_present</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="sc">&#39;S&#39;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">Signature</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">!=</span> <span class="sc">&#39;S&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;not a valid CISS config table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Need to enable prefetch in the SCSI core for 6400 in x86 */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">cciss_enable_scsi_prefetch</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_X86</span>
	<span class="n">u32</span> <span class="n">prefetch</span><span class="p">;</span>

	<span class="n">prefetch</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">SCSI_Prefetch</span><span class="p">));</span>
	<span class="n">prefetch</span> <span class="o">|=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">prefetch</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">SCSI_Prefetch</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* Disable DMA prefetch for the P600.  Otherwise an ASIC bug may result</span>
<span class="cm"> * in a prefetch beyond physical memory.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">cciss_p600_dma_prefetch_quirk</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dma_prefetch</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">dma_refetch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">board_id</span> <span class="o">!=</span> <span class="mh">0x3225103C</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dma_prefetch</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">I2O_DMA1_CFG</span><span class="p">);</span>
	<span class="n">dma_prefetch</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">dma_prefetch</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">I2O_DMA1_CFG</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND_PARITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_refetch</span><span class="p">);</span>
	<span class="n">dma_refetch</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND_PARITY</span><span class="p">,</span> <span class="n">dma_refetch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">cciss_pci_init</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">prod_index</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">prod_index</span> <span class="o">=</span> <span class="n">cciss_lookup_board_id</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prod_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">product_name</span> <span class="o">=</span> <span class="n">products</span><span class="p">[</span><span class="n">prod_index</span><span class="p">].</span><span class="n">product_name</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">access</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">products</span><span class="p">[</span><span class="n">prod_index</span><span class="p">].</span><span class="n">access</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cciss_board_disabled</span><span class="p">(</span><span class="n">h</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller appears to be disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_disable_link_state</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCIE_LINK_STATE_L0S</span> <span class="o">|</span>
				<span class="n">PCIE_LINK_STATE_L1</span> <span class="o">|</span> <span class="n">PCIE_LINK_STATE_CLKPM</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to Enable PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;cciss&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Cannot obtain PCI resources, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;board_id = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">board_id</span><span class="p">);</span>

<span class="cm">/* If the kernel supports MSI/MSI-X we will try to enable that functionality,</span>
<span class="cm"> * else we use the IO-APIC interrupt assigned to us by system ROM.</span>
<span class="cm"> */</span>
	<span class="n">cciss_interrupt_mode</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cciss_pci_find_memory_BAR</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">remap_pci_mem</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">,</span> <span class="mh">0x250</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cciss_wait_for_board_state</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">BOARD_READY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cciss_find_cfgtables</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="n">print_cfg_table</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">cciss_find_board_params</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CISS_signature_present</span><span class="p">(</span><span class="n">h</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cciss_enable_scsi_prefetch</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">cciss_p600_dma_prefetch_quirk</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cciss_enter_simple_mode</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="n">cciss_put_controller_into_performant_mode</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_free_res:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Deliberately omit pci_disable_device(): it does something nasty to</span>
<span class="cm">	 * Smart Array controllers that pci_enable_device does not undo</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Function to find the first free pointer into our hba[] array</span>
<span class="cm"> * Returns -1 if no free entries are left.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">alloc_cciss_hba</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CTLR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>

			<span class="n">h</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ctlr_info_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>
			<span class="n">hba</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;This driver supports a maximum&quot;</span>
	       <span class="s">&quot; of %d controllers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MAX_CTLR</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="nl">Enomem:</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">free_hba</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">hba</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">highest_lun</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">put_disk</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Send a message CDB to the firmware. */</span>
<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="n">cciss_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">opcode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="n">CommandListHeader_struct</span> <span class="n">CommandHeader</span><span class="p">;</span>
		<span class="n">RequestBlock_struct</span> <span class="n">Request</span><span class="p">;</span>
		<span class="n">ErrDescriptor_struct</span> <span class="n">ErrorDescriptor</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">Command</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">cmd_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Command</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ErrorInfo_struct</span><span class="p">);</span>
	<span class="n">Command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">paddr64</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">paddr32</span><span class="p">,</span> <span class="n">tag</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">vaddr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vaddr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* The Inbound Post Queue only accepts 32-bit physical addresses for the</span>
<span class="cm">	   CCISS commands, so they must be allocated from the lower 4GiB of</span>
<span class="cm">	   memory. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">vaddr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cmd_sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">paddr64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">vaddr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This must fit, because of the 32-bit consistent DMA mask.  Also,</span>
<span class="cm">	   although there&#39;s no guarantee, we assume that the address is at</span>
<span class="cm">	   least 4-byte aligned (most likely, it&#39;s page-aligned). */</span>
	<span class="n">paddr32</span> <span class="o">=</span> <span class="n">paddr64</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">CommandHeader</span><span class="p">.</span><span class="n">ReplyQueue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">CommandHeader</span><span class="p">.</span><span class="n">SGList</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">CommandHeader</span><span class="p">.</span><span class="n">SGTotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">CommandHeader</span><span class="p">.</span><span class="n">Tag</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">paddr32</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">CommandHeader</span><span class="p">.</span><span class="n">Tag</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">CommandHeader</span><span class="p">.</span><span class="n">LUN</span><span class="p">.</span><span class="n">LunAddrBytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDBLen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">TYPE_MSG</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Attribute</span> <span class="o">=</span> <span class="n">ATTR_HEADOFQUEUE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">XFER_NONE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Don&#39;t time out */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span> <span class="cm">/* the rest of the CDB is reserved */</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ErrorDescriptor</span><span class="p">.</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">paddr32</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Command</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ErrorDescriptor</span><span class="p">.</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ErrorDescriptor</span><span class="p">.</span><span class="n">Len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ErrorInfo_struct</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">paddr32</span><span class="p">,</span> <span class="n">vaddr</span> <span class="o">+</span> <span class="n">SA5_REQUEST_PORT_OFFSET</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">SA5_REPLY_PORT_OFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="n">paddr32</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">CCISS_POST_RESET_NOOP_TIMEOUT_MSECS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">vaddr</span><span class="p">);</span>

	<span class="cm">/* we leak the DMA buffer here ... no choice since the controller could</span>
<span class="cm">	   still complete the command. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;controller message %02x:%02x timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">opcode</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cmd_sz</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">paddr64</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller message %02x:%02x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">opcode</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller message %02x:%02x succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">opcode</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define cciss_noop(p) cciss_message(p, 3, 0)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_controller_hard_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span> <span class="n">__iomem</span> <span class="n">vaddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">use_doorbell</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">pmcsr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_doorbell</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* For everything after the P600, the PCI power state method</span>
<span class="cm">		 * of resetting the controller doesn&#39;t work, so we have this</span>
<span class="cm">		 * other way using the doorbell register.</span>
<span class="cm">		 */</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using doorbell to reset controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">use_doorbell</span><span class="p">,</span> <span class="n">vaddr</span> <span class="o">+</span> <span class="n">SA5_DOORBELL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Try to do it the PCI power state way */</span>

		<span class="cm">/* Quoting from the Open CISS Specification: &quot;The Power</span>
<span class="cm">		 * Management Control/Status Register (CSR) controls the power</span>
<span class="cm">		 * state of the device.  The normal operating state is D0,</span>
<span class="cm">		 * CSR=00h.  The software off state is D3, CSR=03h.  To reset</span>
<span class="cm">		 * the controller, place the interface device in D3 then to D0,</span>
<span class="cm">		 * this causes a secondary PCI reset which will reset the</span>
<span class="cm">		 * controller.&quot; */</span>

		<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_PM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;cciss_controller_hard_reset: &quot;</span>
				<span class="s">&quot;PCI PM not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using PCI PM to reset controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* enter the D3hot power management state */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PM_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmcsr</span><span class="p">);</span>
		<span class="n">pmcsr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_PM_CTRL_STATE_MASK</span><span class="p">;</span>
		<span class="n">pmcsr</span> <span class="o">|=</span> <span class="n">PCI_D3hot</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PM_CTRL</span><span class="p">,</span> <span class="n">pmcsr</span><span class="p">);</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

		<span class="cm">/* enter the D0 power management state */</span>
		<span class="n">pmcsr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_PM_CTRL_STATE_MASK</span><span class="p">;</span>
		<span class="n">pmcsr</span> <span class="o">|=</span> <span class="n">PCI_D0</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_PM_CTRL</span><span class="p">,</span> <span class="n">pmcsr</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The P600 requires a small delay when changing states.</span>
<span class="cm">		 * Otherwise we may think the board did not reset and we bail.</span>
<span class="cm">		 * This for kdump only and is particular to the P600.</span>
<span class="cm">		 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">void</span> <span class="n">init_driver_version</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">driver_version</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">driver_version</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">driver_version</span><span class="p">,</span> <span class="s">&quot;cciss &quot;</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="n">write_driver_ver_to_cfgtable</span><span class="p">(</span>
	<span class="n">CfgTable_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cfgtable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">driver_version</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">driver_version</span><span class="p">);</span>

	<span class="n">driver_version</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver_version</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">init_driver_version</span><span class="p">(</span><span class="n">driver_version</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">driver_version</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">driver_version</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">driver_version</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">void</span> <span class="n">read_driver_ver_from_cfgtable</span><span class="p">(</span>
	<span class="n">CfgTable_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cfgtable</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">driver_ver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">driver_version</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">driver_ver</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">driver_version</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="n">controller_reset_failed</span><span class="p">(</span>
	<span class="n">CfgTable_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cfgtable</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">driver_ver</span><span class="p">,</span> <span class="o">*</span><span class="n">old_driver_ver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">driver_version</span><span class="p">);</span>

	<span class="n">old_driver_ver</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_driver_ver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">driver_ver</span> <span class="o">=</span> <span class="n">old_driver_ver</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* After a reset, the 32 bytes of &quot;driver version&quot; in the cfgtable</span>
<span class="cm">	 * should have been changed, otherwise we know the reset failed.</span>
<span class="cm">	 */</span>
	<span class="n">init_driver_version</span><span class="p">(</span><span class="n">old_driver_ver</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">read_driver_ver_from_cfgtable</span><span class="p">(</span><span class="n">cfgtable</span><span class="p">,</span> <span class="n">driver_ver</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">driver_ver</span><span class="p">,</span> <span class="n">old_driver_ver</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">old_driver_ver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This does a hard reset of the controller using PCI power management</span>
<span class="cm"> * states or using the doorbell register. */</span>
<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="n">cciss_kdump_hard_reset_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">cfg_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg_base_addr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">cfg_base_addr_index</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">paddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">misc_fw_support</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">CfgTable_struct</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cfgtable</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">use_doorbell</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">board_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">command_register</span><span class="p">;</span>

	<span class="cm">/* For controllers as old a the p600, this is very nearly</span>
<span class="cm">	 * the same thing as</span>
<span class="cm">	 *</span>
<span class="cm">	 * pci_save_state(pci_dev);</span>
<span class="cm">	 * pci_set_power_state(pci_dev, PCI_D3hot);</span>
<span class="cm">	 * pci_set_power_state(pci_dev, PCI_D0);</span>
<span class="cm">	 * pci_restore_state(pci_dev);</span>
<span class="cm">	 *</span>
<span class="cm">	 * For controllers newer than the P600, the pci power state</span>
<span class="cm">	 * method of resetting doesn&#39;t work so we have another way</span>
<span class="cm">	 * using the doorbell register.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Exclude 640x boards.  These are two pci devices in one slot</span>
<span class="cm">	 * which share a battery backed cache module.  One controls the</span>
<span class="cm">	 * cache, the other accesses the cache through the one that controls</span>
<span class="cm">	 * it.  If we reset the one controlling the cache, the other will</span>
<span class="cm">	 * likely not be happy.  Just forbid resetting this conjoined mess.</span>
<span class="cm">	 */</span>
	<span class="n">cciss_lookup_board_id</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">board_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctlr_is_resettable</span><span class="p">(</span><span class="n">board_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot reset Smart Array 640x &quot;</span>
				<span class="s">&quot;due to shared cache module.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if controller is soft- but not hard resettable... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctlr_is_hard_resettable</span><span class="p">(</span><span class="n">board_id</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span> <span class="cm">/* try soft reset later. */</span>

	<span class="cm">/* Save the PCI command register */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command_register</span><span class="p">);</span>
	<span class="cm">/* Turn the board off.  This is so that later pci_restore_state()</span>
<span class="cm">	 * won&#39;t turn the board on before the rest of config space is ready.</span>
<span class="cm">	 */</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* find the first memory BAR, so we can find the cfg table */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cciss_pci_find_memory_BAR</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">paddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">vaddr</span> <span class="o">=</span> <span class="n">remap_pci_mem</span><span class="p">(</span><span class="n">paddr</span><span class="p">,</span> <span class="mh">0x250</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* find cfgtable in order to check if reset via doorbell is supported */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cciss_find_cfg_addrs</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_base_addr</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">cfg_base_addr_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unmap_vaddr</span><span class="p">;</span>
	<span class="n">cfgtable</span> <span class="o">=</span> <span class="n">remap_pci_mem</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
		       <span class="n">cfg_base_addr_index</span><span class="p">)</span> <span class="o">+</span> <span class="n">cfg_offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cfgtable</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfgtable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unmap_vaddr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">write_driver_ver_to_cfgtable</span><span class="p">(</span><span class="n">cfgtable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unmap_vaddr</span><span class="p">;</span>

	<span class="cm">/* If reset via doorbell register is supported, use that.</span>
<span class="cm">	 * There are two such methods.  Favor the newest method.</span>
<span class="cm">	 */</span>
	<span class="n">misc_fw_support</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">misc_fw_support</span><span class="p">);</span>
	<span class="n">use_doorbell</span> <span class="o">=</span> <span class="n">misc_fw_support</span> <span class="o">&amp;</span> <span class="n">MISC_FW_DOORBELL_RESET2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_doorbell</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">use_doorbell</span> <span class="o">=</span> <span class="n">DOORBELL_CTLR_RESET2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">use_doorbell</span> <span class="o">=</span> <span class="n">misc_fw_support</span> <span class="o">&amp;</span> <span class="n">MISC_FW_DOORBELL_RESET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">use_doorbell</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Controller claims that &quot;</span>
				<span class="s">&quot;&#39;Bit 2 doorbell reset&#39; is &quot;</span>
				<span class="s">&quot;supported, but not &#39;bit 5 doorbell reset&#39;.  &quot;</span>
				<span class="s">&quot;Firmware update is recommended.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span> <span class="cm">/* use the soft reset */</span>
			<span class="k">goto</span> <span class="n">unmap_cfgtable</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cciss_controller_hard_reset</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">,</span> <span class="n">use_doorbell</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unmap_cfgtable</span><span class="p">;</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to enable device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unmap_cfgtable</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">command_register</span><span class="p">);</span>

	<span class="cm">/* Some devices (notably the HP Smart Array 5i Controller)</span>
<span class="cm">	   need a little pause here */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">CCISS_POST_RESET_PAUSE_MSECS</span><span class="p">);</span>

	<span class="cm">/* Wait for board to become not ready, then ready. */</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Waiting for board to reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cciss_wait_for_board_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">,</span> <span class="n">BOARD_NOT_READY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed waiting for board to hard reset.&quot;</span>
				<span class="s">&quot;  Will try soft reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span> <span class="cm">/* Not expected, but try soft reset later */</span>
		<span class="k">goto</span> <span class="n">unmap_cfgtable</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cciss_wait_for_board_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">,</span> <span class="n">BOARD_READY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;failed waiting for board to become ready &quot;</span>
			<span class="s">&quot;after hard reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unmap_cfgtable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">controller_reset_failed</span><span class="p">(</span><span class="n">vaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unmap_cfgtable</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to successfully hard reset &quot;</span>
			<span class="s">&quot;controller. Will try soft reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span> <span class="cm">/* Not expected, but try soft reset later */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Board ready after hard reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unmap_cfgtable:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">cfgtable</span><span class="p">);</span>

<span class="nl">unmap_vaddr:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">vaddr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="n">cciss_init_reset_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reset_devices</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Reset the controller with a PCI power-cycle or via doorbell */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cciss_kdump_hard_reset_controller</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* -ENOTSUPP here means we cannot reset the controller</span>
<span class="cm">	 * but it&#39;s already (and still) up and running in</span>
<span class="cm">	 * &quot;performant mode&quot;.  Or, it might be 640x, which can&#39;t reset</span>
<span class="cm">	 * due to concerns about shared bbwc between 6402/6404 pair.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span> <span class="cm">/* just try to do the kdump anyhow. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Now try to get the controller to respond to a no-op */</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Waiting for controller to respond to no-op</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CCISS_POST_RESET_NOOP_RETRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cciss_noop</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no-op failed%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">CCISS_POST_RESET_NOOP_RETRIES</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">?</span>
					<span class="s">&quot;; re-trying&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">CCISS_POST_RESET_NOOP_INTERVAL_MSECS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="n">cciss_allocate_cmd_pool</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool_bits</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span>
		<span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">,</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span> <span class="o">*</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CommandList_struct</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool_dhandle</span><span class="p">));</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">errinfo_pool</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ErrorInfo_struct</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">errinfo_pool_dhandle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool_bits</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">errinfo_pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="n">cciss_allocate_scatterlists</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* zero it, so that on free we need not know how many were alloc&#39;ed */</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">scatter_list</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scatter_list</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">scatter_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span><span class="p">)</span> <span class="o">*</span>
						<span class="n">h</span><span class="o">-&gt;</span><span class="n">maxsgentries</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scatter_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not allocate &quot;</span>
				<span class="s">&quot;s/g lists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cciss_free_scatterlists</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scatter_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scatter_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scatter_list</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cciss_free_cmd_pool</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool_bits</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CommandList_struct</span><span class="p">),</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool_dhandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">errinfo_pool</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ErrorInfo_struct</span><span class="p">),</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">errinfo_pool</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">errinfo_pool_dhandle</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_request_irq</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
	<span class="n">irqreturn_t</span> <span class="p">(</span><span class="o">*</span><span class="n">msixhandler</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
	<span class="n">irqreturn_t</span> <span class="p">(</span><span class="o">*</span><span class="n">intxhandler</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">msix_vector</span> <span class="o">||</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">msi_vector</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_irq</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr_mode</span><span class="p">],</span> <span class="n">msixhandler</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to get msi irq %d&quot;</span>
			<span class="s">&quot; for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr_mode</span><span class="p">],</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_irq</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr_mode</span><span class="p">],</span> <span class="n">intxhandler</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to get irq %d for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr_mode</span><span class="p">],</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">cciss_kdump_soft_reset</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cciss_send_reset</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CTLR_LUNID</span><span class="p">,</span> <span class="n">CCISS_RESET_TYPE_CONTROLLER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Resetting array controller failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Waiting for board to soft reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cciss_wait_for_board_state</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">BOARD_NOT_READY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Soft reset had no effect.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Board reset, awaiting READY status.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cciss_wait_for_board_state</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">BOARD_READY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Board failed to become ready &quot;</span>
			<span class="s">&quot;after soft reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cciss_undo_allocations_after_kdump_soft_reset</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ctlr</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr_mode</span><span class="p">],</span> <span class="n">h</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">msix_vector</span><span class="p">)</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">msi_vector</span><span class="p">)</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>
	<span class="n">cciss_free_sg_chain_blocks</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_sg_list</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">);</span>
	<span class="n">cciss_free_scatterlists</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">cciss_free_cmd_pool</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">blockFetchTable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u64</span><span class="p">),</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool_dhandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">);</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
	<span class="n">cciss_destroy_hba_sysfs_entry</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">hba</span><span class="p">[</span><span class="n">ctlr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  This is it.  Find all the controllers and register them.  I really hate</span>
<span class="cm"> *  stealing all these major device numbers.</span>
<span class="cm"> *  returns the number of block devices registered.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">cciss_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">try_soft_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dac</span><span class="p">,</span> <span class="n">return_code</span><span class="p">;</span>
	<span class="n">InquiryData_struct</span> <span class="o">*</span><span class="n">inq_buff</span><span class="p">;</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cciss_init_reset_devices</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="cm">/* If the reset fails in a particular way (it has no way to do</span>
<span class="cm">		 * a proper hard reset, so returns -ENOTSUPP) we can try to do</span>
<span class="cm">		 * a soft reset once we get the controller configured up to the</span>
<span class="cm">		 * point that it can accept a command.</span>
<span class="cm">		 */</span>
		<span class="n">try_soft_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">reinit_after_soft_reset:</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">alloc_cciss_hba</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">h</span> <span class="o">=</span> <span class="n">hba</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_initializing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">intr_mode</span> <span class="o">=</span> <span class="n">cciss_simple_mode</span> <span class="o">?</span> <span class="n">SIMPLE_MODE_INT</span> <span class="o">:</span> <span class="n">PERF_MODE_INT</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmpQ</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reqQ</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_shutting_down</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cciss_pci_init</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clean_no_release_regions</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="s">&quot;cciss%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cciss_tape_cmds</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">cciss_tape_cmds</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cciss_tape_cmds</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">cciss_tape_cmds</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scan_wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cciss_create_hba_sysfs_entry</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clean0</span><span class="p">;</span>

	<span class="cm">/* configure PCI DMA stuff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span>
		<span class="n">dac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span>
		<span class="n">dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no suitable DMA available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * register with the major number, or get a dynamic major number</span>
<span class="cm">	 * by passing 0 as argument.  This is done for greater than</span>
<span class="cm">	 * 8 controller support.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CTLR_ORIG</span><span class="p">)</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">COMPAQ_CISS_MAJOR</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_blkdev</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		       <span class="s">&quot;Unable to get major number %d for %s &quot;</span>
		       <span class="s">&quot;on hba %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAX_CTLR_ORIG</span><span class="p">)</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make sure the board interrupts are off */</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">.</span><span class="n">set_intr_mask</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CCISS_INTR_OFF</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cciss_request_irq</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">do_cciss_msix_intr</span><span class="p">,</span> <span class="n">do_cciss_intx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clean2</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: &lt;0x%x&gt; at PCI %s IRQ %d%s using DAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">h</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span>
	       <span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr_mode</span><span class="p">],</span> <span class="n">dac</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; not&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cciss_allocate_cmd_pool</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clean4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cciss_allocate_scatterlists</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">clean4</span><span class="p">;</span>

	<span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_sg_list</span> <span class="o">=</span> <span class="n">cciss_allocate_sg_chain_blocks</span><span class="p">(</span><span class="n">h</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">chainsize</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_sg_list</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">chainsize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">clean4</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Initialize the pdev driver private data.</span>
<span class="cm">	   have it point to h.  */</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
	<span class="cm">/* command and error info recs zeroed out before</span>
<span class="cm">	   they are used */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_pool_bits</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">,</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span>
			<span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>

	<span class="n">h</span><span class="o">-&gt;</span><span class="n">num_luns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">highest_lun</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">CISS_MAX_LUN</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* At this point, the controller is ready to take commands.</span>
<span class="cm">	 * Now, if reset_devices and the hard reset didn&#39;t work, try</span>
<span class="cm">	 * the soft reset and see if that works.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">try_soft_reset</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* This is kind of gross.  We may or may not get a completion</span>
<span class="cm">		 * from the soft reset command, and if we do, then the value</span>
<span class="cm">		 * from the fifo may or may not be valid.  So, we wait 10 secs</span>
<span class="cm">		 * after the reset throwing away any completions we get during</span>
<span class="cm">		 * that time.  Unregister the interrupt handler and register</span>
<span class="cm">		 * fake ones to scoop up any residual completions.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">.</span><span class="n">set_intr_mask</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CCISS_INTR_OFF</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr_mode</span><span class="p">],</span> <span class="n">h</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">cciss_request_irq</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">cciss_msix_discard_completions</span><span class="p">,</span>
					<span class="n">cciss_intx_discard_completions</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to request_irq after &quot;</span>
				<span class="s">&quot;soft reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">clean4</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">cciss_kdump_soft_reset</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Soft reset failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">clean4</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Board READY.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Waiting for stale completions to drain.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">.</span><span class="n">set_intr_mask</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CCISS_INTR_ON</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">.</span><span class="n">set_intr_mask</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CCISS_INTR_OFF</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">controller_reset_failed</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Soft reset appears to have failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* since the controller&#39;s reset, we have to go back and re-init</span>
<span class="cm">		 * everything.  Easiest to just forget what we&#39;ve done and do it</span>
<span class="cm">		 * all over again.</span>
<span class="cm">		 */</span>
		<span class="n">cciss_undo_allocations_after_kdump_soft_reset</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
		<span class="n">try_soft_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="cm">/* don&#39;t go to clean4, we already unallocated */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

		<span class="k">goto</span> <span class="n">reinit_after_soft_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cciss_scsi_setup</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>

	<span class="cm">/* Turn the interrupts on so we can service requests */</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">.</span><span class="n">set_intr_mask</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CCISS_INTR_ON</span><span class="p">);</span>

	<span class="cm">/* Get the firmware version */</span>
	<span class="n">inq_buff</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryData_struct</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inq_buff</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clean4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">return_code</span> <span class="o">=</span> <span class="n">sendcmd_withirq</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CISS_INQUIRY</span><span class="p">,</span> <span class="n">inq_buff</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">InquiryData_struct</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CTLR_LUNID</span><span class="p">,</span> <span class="n">TYPE_CMD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">return_code</span> <span class="o">==</span> <span class="n">IO_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">firm_ver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inq_buff</span><span class="o">-&gt;</span><span class="n">data_byte</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">firm_ver</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inq_buff</span><span class="o">-&gt;</span><span class="n">data_byte</span><span class="p">[</span><span class="mi">33</span><span class="p">];</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">firm_ver</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">inq_buff</span><span class="o">-&gt;</span><span class="n">data_byte</span><span class="p">[</span><span class="mi">34</span><span class="p">];</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">firm_ver</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inq_buff</span><span class="o">-&gt;</span><span class="n">data_byte</span><span class="p">[</span><span class="mi">35</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	 <span class="cm">/* send command failed */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to determine firmware&quot;</span>
			<span class="s">&quot; version of controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">inq_buff</span><span class="p">);</span>

	<span class="n">cciss_procinit</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>

	<span class="n">h</span><span class="o">-&gt;</span><span class="n">cciss_max_sectors</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>

	<span class="n">rebuild_lun_table</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cciss_engage_scsi</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_initializing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">clean4:</span>
	<span class="n">cciss_free_cmd_pool</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">cciss_free_scatterlists</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">cciss_free_sg_chain_blocks</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_sg_list</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr_mode</span><span class="p">],</span> <span class="n">h</span><span class="p">);</span>
<span class="nl">clean2:</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
<span class="nl">clean1:</span>
	<span class="n">cciss_destroy_hba_sysfs_entry</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
<span class="nl">clean0:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">clean_no_release_regions:</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_initializing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Deliberately omit pci_disable_device(): it does something nasty to</span>
<span class="cm">	 * Smart Array controllers that pci_enable_device does not undo</span>
<span class="cm">	 */</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_hba</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cciss_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">flush_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">return_code</span><span class="p">;</span>

	<span class="n">h</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">flush_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flush_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cache not flushed, out of memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* write all data in the battery backed cache to disk */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">flush_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">return_code</span> <span class="o">=</span> <span class="n">sendcmd_withirq</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CCISS_CACHE_FLUSH</span><span class="p">,</span> <span class="n">flush_buf</span><span class="p">,</span>
		<span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CTLR_LUNID</span><span class="p">,</span> <span class="n">TYPE_CMD</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">flush_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">return_code</span> <span class="o">!=</span> <span class="n">IO_OK</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error flushing cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">.</span><span class="n">set_intr_mask</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CCISS_INTR_OFF</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">intr_mode</span><span class="p">],</span> <span class="n">h</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">cciss_enter_simple_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">trans_support</span><span class="p">;</span>

	<span class="n">trans_support</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">TransportSupport</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">trans_support</span> <span class="o">&amp;</span> <span class="n">SIMPLE_MODE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">CmdsOutMax</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">CFGTBL_Trans_Simple</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">HostWrite</span><span class="p">.</span><span class="n">TransportRequest</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">CFGTBL_ChangeReq</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">SA5_DOORBELL</span><span class="p">);</span>
	<span class="n">cciss_wait_for_mode_change_ack</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">print_cfg_table</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="o">-&gt;</span><span class="n">TransportActive</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">CFGTBL_Trans_Simple</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to get board into simple mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">transMethod</span> <span class="o">=</span> <span class="n">CFGTBL_Trans_Simple</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">cciss_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to remove device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">h</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;device appears to already be removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_shutting_down</span><span class="p">);</span>

	<span class="n">remove_from_scan_list</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">proc_cciss</span><span class="p">);</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>

	<span class="cm">/* remove it from the disk list */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">CISS_MAX_LUN</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">gendisk</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GENHD_FL_UP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cciss_destroy_ld_sysfs_entry</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">del_gendisk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">)</span>
				<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CISS_SCSI_TAPE</span>
	<span class="n">cciss_unregister_scsi</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>	<span class="cm">/* unhook from SCSI subsystem */</span>
<span class="cp">#endif</span>

	<span class="n">cciss_shutdown</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">msix_vector</span><span class="p">)</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">msi_vector</span><span class="p">)</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">transtable</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cfgtable</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">);</span>

	<span class="n">cciss_free_cmd_pool</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="cm">/* Free up sg elements */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scatter_list</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">scatter_list</span><span class="p">);</span>
	<span class="n">cciss_free_sg_chain_blocks</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">cmd_sg_list</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nr_cmds</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">blockFetchTable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_commands</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u64</span><span class="p">),</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">reply_pool_dhandle</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Deliberately omit pci_disable_device(): it does something nasty to</span>
<span class="cm">	 * Smart Array controllers that pci_enable_device does not undo</span>
<span class="cm">	 */</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">cciss_destroy_hba_sysfs_entry</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">busy_shutting_down</span><span class="p">);</span>
	<span class="n">free_hba</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">cciss_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cciss&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">cciss_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">cciss_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">cciss_pci_device_id</span><span class="p">,</span>	<span class="cm">/* id_table */</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">cciss_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  This is it.  Register the PCI driver information for the cards we control</span>
<span class="cm"> *  the OS will call our registered routines when it finds one of our cards.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cciss_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The hardware requires that commands are aligned on a 64-bit</span>
<span class="cm">	 * boundary. Given that we use pci_alloc_consistent() to allocate an</span>
<span class="cm">	 * array of them, the size must be a multiple of 8 bytes.</span>
<span class="cm">	 */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">CommandList_struct</span><span class="p">)</span> <span class="o">%</span> <span class="n">COMMANDLIST_ALIGNMENT</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cciss_bus_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Start the scan thread */</span>
	<span class="n">cciss_scan_thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">scan_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;cciss_scan&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cciss_scan_thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cciss_scan_thread</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_bus_unregister</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register for our PCI devices */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cciss_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_thread_stop</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_thread_stop:</span>
	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">cciss_scan_thread</span><span class="p">);</span>
<span class="nl">err_bus_unregister:</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cciss_bus_type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cciss_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cciss_pci_driver</span><span class="p">);</span>
	<span class="cm">/* double check that all controller entrys have been removed */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CTLR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hba</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;had to remove controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">cciss_remove_one</span><span class="p">(</span><span class="n">hba</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">cciss_scan_thread</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proc_cciss</span><span class="p">)</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;driver/cciss&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cciss_bus_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">cciss_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cciss_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
