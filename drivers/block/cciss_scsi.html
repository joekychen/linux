<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › cciss_scsi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>cciss_scsi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *    Disk Array driver for HP Smart Array controllers, SCSI Tape module.</span>
<span class="cm"> *    (C) Copyright 2001, 2007 Hewlett-Packard Development Company, L.P.</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *    it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *    the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
<span class="cm"> *    General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *    You should have received a copy of the GNU General Public License</span>
<span class="cm"> *    along with this program; if not, write to the Free Software</span>
<span class="cm"> *    Foundation, Inc., 59 Temple Place, Suite 300, Boston, MA</span>
<span class="cm"> *    02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *    Questions/Comments/Bugfixes to iss_storagedev@hp.com</span>
<span class="cm"> *    </span>
<span class="cm"> *    Author: Stephen M. Cameron</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_CISS_SCSI_TAPE</span>

<span class="cm">/* Here we have code to present the driver as a scsi driver </span>
<span class="cm">   as it is simultaneously presented as a block driver.  The </span>
<span class="cm">   reason for doing this is to allow access to SCSI tape drives</span>
<span class="cm">   through the array controller.  Note in particular, neither </span>
<span class="cm">   physical nor logical disks are presented through the scsi layer. */</span>

<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>

<span class="cp">#include &lt;linux/atomic.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt; </span>

<span class="cp">#include &quot;cciss_scsi.h&quot;</span>

<span class="cp">#define CCISS_ABORT_MSG 0x00</span>
<span class="cp">#define CCISS_RESET_MSG 0x01</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fill_cmd</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
	<span class="n">__u8</span> <span class="n">page_code</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scsi3addr</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">cmd_type</span><span class="p">);</span>

<span class="k">static</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">cmd_alloc</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">);</span>
<span class="k">static</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">cmd_special_alloc</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cmd_free</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cmd_special_free</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_scsi_proc_info</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="cm">/* data buffer */</span>
		<span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> 	   <span class="cm">/* where data in buffer starts */</span>
		<span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span>	   <span class="cm">/* offset from start of imaginary file */</span>
		<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> 	   <span class="cm">/* length of data in buffer */</span>
		<span class="kt">int</span> <span class="n">func</span><span class="p">);</span>	   <span class="cm">/* 0 == read, 1 == write */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_scsi_queue_command</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_eh_device_reset_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cciss_eh_abort_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cciss_scsi_hba_t</span> <span class="n">ccissscsi</span><span class="p">[</span><span class="n">MAX_CTLR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cciss0&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ndevices</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cciss1&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ndevices</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cciss2&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ndevices</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cciss3&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ndevices</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cciss4&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ndevices</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cciss5&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ndevices</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cciss6&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ndevices</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cciss7&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">ndevices</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">cciss_driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;cciss&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>		<span class="o">=</span> <span class="s">&quot;cciss&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_info</span>		<span class="o">=</span> <span class="n">cciss_scsi_proc_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">cciss_scsi_queue_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">DISABLE_CLUSTERING</span><span class="p">,</span>
	<span class="cm">/* Can&#39;t have eh_bus_reset_handler or eh_host_reset_handler for cciss */</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span><span class="o">=</span> <span class="n">cciss_eh_device_reset_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>	<span class="o">=</span> <span class="n">cciss_eh_abort_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#pragma pack(1)</span>

<span class="cp">#define SCSI_PAD_32 8</span>
<span class="cp">#define SCSI_PAD_64 8</span>

<span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_elem_t</span> <span class="p">{</span>
	<span class="n">CommandList_struct</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">ErrorInfo_struct</span> <span class="n">Err</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">busaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmdindex</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pad</span><span class="p">[</span><span class="n">IS_32_BIT</span> <span class="o">*</span> <span class="n">SCSI_PAD_32</span> <span class="o">+</span> <span class="n">IS_64_BIT</span> <span class="o">*</span> <span class="n">SCSI_PAD_64</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#pragma pack()</span>

<span class="cp">#pragma pack(1)</span>
<span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_t</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_elem_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_elem_t</span> <span class="o">**</span><span class="n">elem</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">cmd_pool_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">top</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nelems</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#pragma pack()</span>

<span class="k">struct</span> <span class="n">cciss_scsi_adapter_data_t</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">scsi_host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_t</span> <span class="n">cmd_stack</span><span class="p">;</span>
	<span class="n">SGDescriptor_struct</span> <span class="o">**</span><span class="n">cmd_sg_list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">registered</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span> <span class="c1">// to protect ccissscsi[ctlr]; </span>
<span class="p">};</span>

<span class="cp">#define CPQ_TAPE_LOCK(h, flags) spin_lock_irqsave( \</span>
<span class="cp">	&amp;h-&gt;scsi_ctlr-&gt;lock, flags);</span>
<span class="cp">#define CPQ_TAPE_UNLOCK(h, flags) spin_unlock_irqrestore( \</span>
<span class="cp">	&amp;h-&gt;scsi_ctlr-&gt;lock, flags);</span>

<span class="k">static</span> <span class="n">CommandList_struct</span> <span class="o">*</span>
<span class="nf">scsi_cmd_alloc</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* assume only one process in here at a time, locking done by caller. */</span>
	<span class="cm">/* use h-&gt;lock */</span>
	<span class="cm">/* might be better to rewrite how we allocate scsi commands in a way that */</span>
	<span class="cm">/* needs no locking at all. */</span>

	<span class="cm">/* take the top memory chunk off the stack and return it, if any. */</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_elem_t</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_adapter_data_t</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_t</span> <span class="o">*</span><span class="n">stk</span><span class="p">;</span>
	<span class="n">u64bit</span> <span class="n">temp64</span><span class="p">;</span>

	<span class="n">sa</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">scsi_ctlr</span><span class="p">;</span>
	<span class="n">stk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">cmd_stack</span><span class="p">;</span> 

	<span class="k">if</span> <span class="p">(</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">];</span> 	
	<span class="cm">/* memset(c, 0, sizeof(*c)); */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Err</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Err</span><span class="p">));</span>
	<span class="cm">/* set physical addr of cmd and addr of scsi parameters */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">busaddr</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">;</span> 
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmdindex</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">cmdindex</span><span class="p">;</span>
	<span class="cm">/* (__u32) (stk-&gt;cmd_pool_handle + </span>
<span class="cm">		(sizeof(struct cciss_scsi_cmd_stack_elem_t)*stk-&gt;top)); */</span>

	<span class="n">temp64</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CommandList_struct</span><span class="p">));</span>
	<span class="cm">/* (__u64) (stk-&gt;cmd_pool_handle + </span>
<span class="cm">		(sizeof(struct cciss_scsi_cmd_stack_elem_t)*stk-&gt;top) +</span>
<span class="cm">		 sizeof(CommandList_struct)); */</span>
	<span class="n">stk</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">--</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ErrDesc</span><span class="p">.</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">lower</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ErrDesc</span><span class="p">.</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">temp64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">upper</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ErrDesc</span><span class="p">.</span><span class="n">Len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ErrorInfo_struct</span><span class="p">);</span>
	
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">err_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Err</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">CommandList_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">scsi_cmd_free</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* assume only one process in here at a time, locking done by caller. */</span>
	<span class="cm">/* use h-&gt;lock */</span>
	<span class="cm">/* drop the free memory chunk on top of the stack. */</span>

	<span class="k">struct</span> <span class="n">cciss_scsi_adapter_data_t</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_t</span> <span class="o">*</span><span class="n">stk</span><span class="p">;</span>

	<span class="n">sa</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">scsi_ctlr</span><span class="p">;</span>
	<span class="n">stk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">cmd_stack</span><span class="p">;</span> 
	<span class="n">stk</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">&gt;=</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">nelems</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;scsi_cmd_free called too many times.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">stk</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_elem_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">scsi_cmd_stack_setup</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cciss_scsi_adapter_data_t</span> <span class="o">*</span><span class="n">sa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_t</span> <span class="o">*</span><span class="n">stk</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">stk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">cmd_stack</span><span class="p">;</span>
	<span class="n">stk</span><span class="o">-&gt;</span><span class="n">nelems</span> <span class="o">=</span> <span class="n">cciss_tape_cmds</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">cmd_sg_list</span> <span class="o">=</span> <span class="n">cciss_allocate_sg_chain_blocks</span><span class="p">(</span><span class="n">h</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">chainsize</span><span class="p">,</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">nelems</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">cmd_sg_list</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">chainsize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_elem_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">nelems</span><span class="p">;</span>

	<span class="cm">/* Check alignment, see cciss_cmd.h near CommandList_struct def. */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">)</span> <span class="o">%</span> <span class="n">COMMANDLIST_ALIGNMENT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* pci_alloc_consistent guarantees 32-bit DMA address will be used */</span>
	<span class="n">stk</span><span class="o">-&gt;</span><span class="n">pool</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_elem_t</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">cmd_pool_handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cciss_free_sg_chain_blocks</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">cmd_sg_list</span><span class="p">,</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">nelems</span><span class="p">);</span>
		<span class="n">sa</span><span class="o">-&gt;</span><span class="n">cmd_sg_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">stk</span><span class="o">-&gt;</span><span class="n">elem</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">nelems</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span>
		<span class="n">stk</span><span class="o">-&gt;</span><span class="n">cmd_pool_handle</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">nelems</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stk</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">stk</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="p">(</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">cmd_pool_handle</span> <span class="o">+</span> 
			<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_elem_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
		<span class="n">stk</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cmdindex</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">stk</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">nelems</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">scsi_cmd_stack_free</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_adapter_data_t</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_t</span> <span class="o">*</span><span class="n">stk</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">sa</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">scsi_ctlr</span><span class="p">;</span>
	<span class="n">stk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">cmd_stack</span><span class="p">;</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">!=</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">nelems</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;bug: %d scsi commands are still outstanding.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">stk</span><span class="o">-&gt;</span><span class="n">nelems</span> <span class="o">-</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_elem_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">nelems</span><span class="p">;</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">cmd_pool_handle</span><span class="p">);</span>
	<span class="n">stk</span><span class="o">-&gt;</span><span class="n">pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cciss_free_sg_chain_blocks</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">cmd_sg_list</span><span class="p">,</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">nelems</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">stk</span><span class="o">-&gt;</span><span class="n">elem</span><span class="p">);</span>
	<span class="n">stk</span><span class="o">-&gt;</span><span class="n">elem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int xmargin=8;</span>
<span class="c">static int amargin=60;</span>

<span class="c">static void</span>
<span class="c">print_bytes (unsigned char *c, int len, int hex, int ascii)</span>
<span class="c">{</span>

<span class="c">	int i;</span>
<span class="c">	unsigned char *x;</span>

<span class="c">	if (hex)</span>
<span class="c">	{</span>
<span class="c">		x = c;</span>
<span class="c">		for (i=0;i&lt;len;i++)</span>
<span class="c">		{</span>
<span class="c">			if ((i % xmargin) == 0 &amp;&amp; i&gt;0) printk(&quot;\n&quot;);</span>
<span class="c">			if ((i % xmargin) == 0) printk(&quot;0x%04x:&quot;, i);</span>
<span class="c">			printk(&quot; %02x&quot;, *x);</span>
<span class="c">			x++;</span>
<span class="c">		}</span>
<span class="c">		printk(&quot;\n&quot;);</span>
<span class="c">	}</span>
<span class="c">	if (ascii)</span>
<span class="c">	{</span>
<span class="c">		x = c;</span>
<span class="c">		for (i=0;i&lt;len;i++)</span>
<span class="c">		{</span>
<span class="c">			if ((i % amargin) == 0 &amp;&amp; i&gt;0) printk(&quot;\n&quot;);</span>
<span class="c">			if ((i % amargin) == 0) printk(&quot;0x%04x:&quot;, i);</span>
<span class="c">			if (*x &gt; 26 &amp;&amp; *x &lt; 128) printk(&quot;%c&quot;, *x);</span>
<span class="c">			else printk(&quot;.&quot;);</span>
<span class="c">			x++;</span>
<span class="c">		}</span>
<span class="c">		printk(&quot;\n&quot;);</span>
<span class="c">	}</span>
<span class="c">}</span>

<span class="c">static void</span>
<span class="c">print_cmd(CommandList_struct *cp)</span>
<span class="c">{</span>
<span class="c">	printk(&quot;queue:%d\n&quot;, cp-&gt;Header.ReplyQueue);</span>
<span class="c">	printk(&quot;sglist:%d\n&quot;, cp-&gt;Header.SGList);</span>
<span class="c">	printk(&quot;sgtot:%d\n&quot;, cp-&gt;Header.SGTotal);</span>
<span class="c">	printk(&quot;Tag:0x%08x/0x%08x\n&quot;, cp-&gt;Header.Tag.upper, </span>
<span class="c">			cp-&gt;Header.Tag.lower);</span>
<span class="c">	printk(&quot;LUN:0x%02x%02x%02x%02x%02x%02x%02x%02x\n&quot;,</span>
<span class="c">		cp-&gt;Header.LUN.LunAddrBytes[0],</span>
<span class="c">		cp-&gt;Header.LUN.LunAddrBytes[1],</span>
<span class="c">		cp-&gt;Header.LUN.LunAddrBytes[2],</span>
<span class="c">		cp-&gt;Header.LUN.LunAddrBytes[3],</span>
<span class="c">		cp-&gt;Header.LUN.LunAddrBytes[4],</span>
<span class="c">		cp-&gt;Header.LUN.LunAddrBytes[5],</span>
<span class="c">		cp-&gt;Header.LUN.LunAddrBytes[6],</span>
<span class="c">		cp-&gt;Header.LUN.LunAddrBytes[7]);</span>
<span class="c">	printk(&quot;CDBLen:%d\n&quot;, cp-&gt;Request.CDBLen);</span>
<span class="c">	printk(&quot;Type:%d\n&quot;,cp-&gt;Request.Type.Type);</span>
<span class="c">	printk(&quot;Attr:%d\n&quot;,cp-&gt;Request.Type.Attribute);</span>
<span class="c">	printk(&quot; Dir:%d\n&quot;,cp-&gt;Request.Type.Direction);</span>
<span class="c">	printk(&quot;Timeout:%d\n&quot;,cp-&gt;Request.Timeout);</span>
<span class="c">	printk( &quot;CDB: %02x %02x %02x %02x %02x %02x %02x %02x&quot;</span>
<span class="c">		&quot; %02x %02x %02x %02x %02x %02x %02x %02x\n&quot;,</span>
<span class="c">		cp-&gt;Request.CDB[0], cp-&gt;Request.CDB[1],</span>
<span class="c">		cp-&gt;Request.CDB[2], cp-&gt;Request.CDB[3],</span>
<span class="c">		cp-&gt;Request.CDB[4], cp-&gt;Request.CDB[5],</span>
<span class="c">		cp-&gt;Request.CDB[6], cp-&gt;Request.CDB[7],</span>
<span class="c">		cp-&gt;Request.CDB[8], cp-&gt;Request.CDB[9],</span>
<span class="c">		cp-&gt;Request.CDB[10], cp-&gt;Request.CDB[11],</span>
<span class="c">		cp-&gt;Request.CDB[12], cp-&gt;Request.CDB[13],</span>
<span class="c">		cp-&gt;Request.CDB[14], cp-&gt;Request.CDB[15]),</span>
<span class="c">	printk(&quot;edesc.Addr: 0x%08x/0%08x, Len  = %d\n&quot;, </span>
<span class="c">		cp-&gt;ErrDesc.Addr.upper, cp-&gt;ErrDesc.Addr.lower, </span>
<span class="c">			cp-&gt;ErrDesc.Len);</span>
<span class="c">	printk(&quot;sgs..........Errorinfo:\n&quot;);</span>
<span class="c">	printk(&quot;scsistatus:%d\n&quot;, cp-&gt;err_info-&gt;ScsiStatus);</span>
<span class="c">	printk(&quot;senselen:%d\n&quot;, cp-&gt;err_info-&gt;SenseLen);</span>
<span class="c">	printk(&quot;cmd status:%d\n&quot;, cp-&gt;err_info-&gt;CommandStatus);</span>
<span class="c">	printk(&quot;resid cnt:%d\n&quot;, cp-&gt;err_info-&gt;ResidualCnt);</span>
<span class="c">	printk(&quot;offense size:%d\n&quot;, cp-&gt;err_info-&gt;MoreErrInfo.Invalid_Cmd.offense_size);</span>
<span class="c">	printk(&quot;offense byte:%d\n&quot;, cp-&gt;err_info-&gt;MoreErrInfo.Invalid_Cmd.offense_num);</span>
<span class="c">	printk(&quot;offense value:%d\n&quot;, cp-&gt;err_info-&gt;MoreErrInfo.Invalid_Cmd.offense_value);</span>
<span class="c">			</span>
<span class="c">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">find_bus_target_lun</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* finds an unused bus, target, lun for a new device */</span>
	<span class="cm">/* assumes h-&gt;scsi_ctlr-&gt;lock is held */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">target_taken</span><span class="p">[</span><span class="n">CCISS_MAX_SCSI_DEVS_PER_HBA</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target_taken</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CCISS_MAX_SCSI_DEVS_PER_HBA</span><span class="p">);</span>

	<span class="n">target_taken</span><span class="p">[</span><span class="n">SELF_SCSI_ID</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">ndevices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">target_taken</span><span class="p">[</span><span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CCISS_MAX_SCSI_DEVS_PER_HBA</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target_taken</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">*</span><span class="n">target</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="o">*</span><span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">found</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">);</span>	
<span class="p">}</span>
<span class="k">struct</span> <span class="n">scsi2map</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">scsi3addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">cciss_scsi_add_entry</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hostno</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cciss_scsi_dev_t</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">scsi2map</span> <span class="o">*</span><span class="n">added</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nadded</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* assumes h-&gt;scsi_ctlr-&gt;lock is held */</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">ndevices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_dev_t</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr1</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">addr2</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">CCISS_MAX_SCSI_DEVS_PER_HBA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Too many devices, &quot;</span>
			<span class="s">&quot;some will be inaccessible.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">target</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Is this device a non-zero lun of a multi-lun device */</span>
	<span class="cm">/* byte 4 of the 8-byte LUN addr will contain the logical unit no. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Search through our list and find the device which */</span>
		<span class="cm">/* has the same 8 byte LUN address, excepting byte 4. */</span>
		<span class="cm">/* Assign the same bus and target for this new LUN. */</span>
		<span class="cm">/* Use the logical unit number from the firmware. */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">addr1</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">addr1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">addr2</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">addr2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* differ only in byte 4? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">addr1</span><span class="p">,</span> <span class="n">addr2</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bus</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
				<span class="n">target</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">;</span>
				<span class="n">lun</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">dev</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lun</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">find_bus_target_lun</span><span class="p">(</span><span class="n">h</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
		<span class="n">sd</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">lun</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">added</span><span class="p">[</span><span class="o">*</span><span class="n">nadded</span><span class="p">].</span><span class="n">bus</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">added</span><span class="p">[</span><span class="o">*</span><span class="n">nadded</span><span class="p">].</span><span class="n">target</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">;</span>
	<span class="n">added</span><span class="p">[</span><span class="o">*</span><span class="n">nadded</span><span class="p">].</span><span class="n">lun</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">nadded</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">));</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">devtype</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">devtype</span><span class="p">;</span>

	<span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">ndevices</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* initially, (before registering with scsi layer) we don&#39;t </span>
<span class="cm">	   know our hostno and we don&#39;t want to print anything first </span>
<span class="cm">	   time anyway (the scsi layer&#39;s inquiries will show that info) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostno</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s device c%db%dt%dl%d added.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">scsi_device_type</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">devtype</span><span class="p">),</span> <span class="n">hostno</span><span class="p">,</span>
			<span class="n">sd</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cciss_scsi_remove_entry</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hostno</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">scsi2map</span> <span class="o">*</span><span class="n">removed</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nremoved</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* assumes h-&gt;ctlr]-&gt;scsi_ctlr-&gt;lock is held */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_dev_t</span> <span class="n">sd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">entry</span> <span class="o">&gt;=</span> <span class="n">CCISS_MAX_SCSI_DEVS_PER_HBA</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">sd</span> <span class="o">=</span> <span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">dev</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
	<span class="n">removed</span><span class="p">[</span><span class="o">*</span><span class="n">nremoved</span><span class="p">].</span><span class="n">bus</span>    <span class="o">=</span> <span class="n">sd</span><span class="p">.</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">removed</span><span class="p">[</span><span class="o">*</span><span class="n">nremoved</span><span class="p">].</span><span class="n">target</span> <span class="o">=</span> <span class="n">sd</span><span class="p">.</span><span class="n">target</span><span class="p">;</span>
	<span class="n">removed</span><span class="p">[</span><span class="o">*</span><span class="n">nremoved</span><span class="p">].</span><span class="n">lun</span>    <span class="o">=</span> <span class="n">sd</span><span class="p">.</span><span class="n">lun</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">nremoved</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">ndevices</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">ndevices</span><span class="o">--</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s device c%db%dt%dl%d removed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">scsi_device_type</span><span class="p">(</span><span class="n">sd</span><span class="p">.</span><span class="n">devtype</span><span class="p">),</span> <span class="n">hostno</span><span class="p">,</span>
			<span class="n">sd</span><span class="p">.</span><span class="n">bus</span><span class="p">,</span> <span class="n">sd</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="n">sd</span><span class="p">.</span><span class="n">lun</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define SCSI3ADDR_EQ(a,b) ( \</span>
<span class="cp">	(a)[7] == (b)[7] &amp;&amp; \</span>
<span class="cp">	(a)[6] == (b)[6] &amp;&amp; \</span>
<span class="cp">	(a)[5] == (b)[5] &amp;&amp; \</span>
<span class="cp">	(a)[4] == (b)[4] &amp;&amp; \</span>
<span class="cp">	(a)[3] == (b)[3] &amp;&amp; \</span>
<span class="cp">	(a)[2] == (b)[2] &amp;&amp; \</span>
<span class="cp">	(a)[1] == (b)[1] &amp;&amp; \</span>
<span class="cp">	(a)[0] == (b)[0])</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fixup_botched_add</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scsi3addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* called when scsi_add_device fails in order to re-adjust */</span>
	<span class="cm">/* ccissscsi[] to match the mid layer&#39;s view. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">CPQ_TAPE_LOCK</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">ndevices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">scsi3addr</span><span class="p">,</span>
				<span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scsi3addr</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">ndevices</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">dev</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">dev</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">ndevices</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">CPQ_TAPE_UNLOCK</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">device_is_the_same</span><span class="p">(</span><span class="k">struct</span> <span class="n">cciss_scsi_dev_t</span> <span class="o">*</span><span class="n">dev1</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_dev_t</span> <span class="o">*</span><span class="n">dev2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dev1</span><span class="o">-&gt;</span><span class="n">devtype</span> <span class="o">==</span> <span class="n">dev2</span><span class="o">-&gt;</span><span class="n">devtype</span> <span class="o">&amp;&amp;</span>
		<span class="n">memcmp</span><span class="p">(</span><span class="n">dev1</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">,</span> <span class="n">dev2</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">dev1</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="n">memcmp</span><span class="p">(</span><span class="n">dev1</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="n">dev2</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">dev1</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="n">memcmp</span><span class="p">(</span><span class="n">dev1</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">dev2</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">dev1</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="n">memcmp</span><span class="p">(</span><span class="n">dev1</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">dev2</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">dev1</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="n">memcmp</span><span class="p">(</span><span class="n">dev1</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">dev2</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">dev1</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">adjust_cciss_scsi_table</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hostno</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_dev_t</span> <span class="n">sd</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">nsds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* sd contains scsi3 addresses and devtypes, but</span>
<span class="cm">	   bus target and lun are not filled in.  This funciton</span>
<span class="cm">	   takes what&#39;s in sd to be the current and adjusts</span>
<span class="cm">	   ccissscsi[] to be in line with what&#39;s in sd. */</span> 

	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_dev_t</span> <span class="o">*</span><span class="n">csd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi2map</span> <span class="o">*</span><span class="n">added</span><span class="p">,</span> <span class="o">*</span><span class="n">removed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nadded</span><span class="p">,</span> <span class="n">nremoved</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">sh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">added</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">added</span><span class="p">)</span> <span class="o">*</span> <span class="n">CCISS_MAX_SCSI_DEVS_PER_HBA</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">removed</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">removed</span><span class="p">)</span> <span class="o">*</span> <span class="n">CCISS_MAX_SCSI_DEVS_PER_HBA</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">added</span> <span class="o">||</span> <span class="o">!</span><span class="n">removed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Out of memory in adjust_cciss_scsi_table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_and_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">CPQ_TAPE_LOCK</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostno</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="cm">/* if it&#39;s not the first time... */</span>
		<span class="n">sh</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">scsi_ctlr</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">;</span>

	<span class="cm">/* find any devices in ccissscsi[] that are not in </span>
<span class="cm">	   sd[] and remove them from ccissscsi[] */</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nremoved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nadded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">ndevices</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">found</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">nsds</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SCSI3ADDR_EQ</span><span class="p">(</span><span class="n">sd</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">scsi3addr</span><span class="p">,</span>
				<span class="n">csd</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">device_is_the_same</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">csd</span><span class="p">))</span>
					<span class="n">found</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">found</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* device no longer present. */</span> 
			<span class="n">changes</span><span class="o">++</span><span class="p">;</span>
			<span class="n">cciss_scsi_remove_entry</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">hostno</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">removed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nremoved</span><span class="p">);</span>
			<span class="cm">/* remove ^^^, hence i not incremented */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* device is different in some way */</span>
			<span class="n">changes</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;device c%db%dt%dl%d has changed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hostno</span><span class="p">,</span> <span class="n">csd</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">csd</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">csd</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
			<span class="n">cciss_scsi_remove_entry</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">hostno</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">removed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nremoved</span><span class="p">);</span>
			<span class="cm">/* remove ^^^, hence i not incremented */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cciss_scsi_add_entry</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">hostno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
				<span class="n">added</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nadded</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/* we just removed one, so add can&#39;t fail. */</span>
					<span class="n">BUG</span><span class="p">();</span>
			<span class="n">csd</span><span class="o">-&gt;</span><span class="n">devtype</span> <span class="o">=</span> <span class="n">sd</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">devtype</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">csd</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="n">sd</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">device_id</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">csd</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">csd</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">sd</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">vendor</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">csd</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">csd</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="n">sd</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">model</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">csd</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">csd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">sd</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">revision</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">csd</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> 		<span class="cm">/* device is same as it ever was, */</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* so just move along. */</span>
	<span class="p">}</span>

	<span class="cm">/* Now, make sure every device listed in sd[] is also</span>
<span class="cm"> 	   listed in ccissscsi[], adding them if they aren&#39;t found */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">nsds</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">found</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">ndevices</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">csd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">dev</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SCSI3ADDR_EQ</span><span class="p">(</span><span class="n">sd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scsi3addr</span><span class="p">,</span>
				<span class="n">csd</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">device_is_the_same</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">csd</span><span class="p">))</span>
					<span class="n">found</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>	<span class="cm">/* found device */</span>
				<span class="k">else</span>
					<span class="n">found</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> 	<span class="cm">/* found a bug. */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">changes</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cciss_scsi_add_entry</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">hostno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">added</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nadded</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* should never happen... */</span>
			<span class="n">changes</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;device unexpectedly changed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* but if it does happen, we just ignore that device */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">CPQ_TAPE_UNLOCK</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t notify scsi mid layer of any changes the first time through */</span>
	<span class="cm">/* (or if there are no changes) scsi_scan_host will do it later the */</span>
	<span class="cm">/* first time through. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostno</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="o">!</span><span class="n">changes</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_and_out</span><span class="p">;</span>

	<span class="cm">/* Notify scsi mid layer of any removed devices */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nremoved</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span>
			<span class="n">scsi_device_lookup</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">removed</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus</span><span class="p">,</span>
				<span class="n">removed</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target</span><span class="p">,</span> <span class="n">removed</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lun</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scsi_remove_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
			<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* We don&#39;t expect to get here. */</span>
			<span class="cm">/* future cmds to this device will get selection */</span>
			<span class="cm">/* timeout as if the device was gone. */</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;didn&#39;t find &quot;</span>
				<span class="s">&quot;c%db%dt%dl%d</span><span class="se">\n</span><span class="s"> for removal.&quot;</span><span class="p">,</span>
				<span class="n">hostno</span><span class="p">,</span> <span class="n">removed</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus</span><span class="p">,</span>
				<span class="n">removed</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target</span><span class="p">,</span> <span class="n">removed</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lun</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Notify scsi mid layer of any added devices */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nadded</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">scsi_add_device</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">added</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus</span><span class="p">,</span>
			<span class="n">added</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target</span><span class="p">,</span> <span class="n">added</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lun</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;scsi_add_device &quot;</span>
			<span class="s">&quot;c%db%dt%dl%d failed, device not added.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hostno</span><span class="p">,</span> <span class="n">added</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus</span><span class="p">,</span> <span class="n">added</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target</span><span class="p">,</span> <span class="n">added</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lun</span><span class="p">);</span>
		<span class="cm">/* now we have to remove it from ccissscsi, */</span>
		<span class="cm">/* since it didn&#39;t get added to scsi mid layer */</span>
		<span class="n">fixup_botched_add</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">added</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scsi3addr</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">free_and_out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">added</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">removed</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lookup_scsi3addr</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scsi3addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_dev_t</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">CPQ_TAPE_LOCK</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">ndevices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">bus</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sd</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">==</span> <span class="n">target</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sd</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">==</span> <span class="n">lun</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">scsi3addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">CPQ_TAPE_UNLOCK</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">CPQ_TAPE_UNLOCK</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">cciss_scsi_setup</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_adapter_data_t</span> <span class="o">*</span> <span class="n">shba</span><span class="p">;</span>

	<span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">ndevices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">shba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cciss_scsi_adapter_data_t</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">shba</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>	
	<span class="k">if</span> <span class="p">(</span><span class="n">shba</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">shba</span><span class="o">-&gt;</span><span class="n">scsi_host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shba</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">shba</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_cmd_stack_setup</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">shba</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">shba</span><span class="p">);</span>
		<span class="n">shba</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">scsi_ctlr</span> <span class="o">=</span> <span class="n">shba</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">complete_scsi_command</span><span class="p">(</span><span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span>
	<span class="n">__u32</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="n">ErrorInfo_struct</span> <span class="o">*</span><span class="n">ei</span><span class="p">;</span>

	<span class="n">ei</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="p">;</span>

	<span class="cm">/* First, see if it was a message rather than a command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">TYPE_MSG</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">CMD_MSG_DONE</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span><span class="p">;</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">hba</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">];</span>

	<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGTotal</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_cmd_sgentries</span><span class="p">)</span>
		<span class="n">cciss_unmap_sg_chain_block</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span> 		<span class="cm">/* host byte */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">COMMAND_COMPLETE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>	<span class="cm">/* msg byte */</span>
	<span class="cm">/* cmd-&gt;result |= (GOOD &lt; 1); */</span>		<span class="cm">/* status byte */</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">ScsiStatus</span><span class="p">);</span>
	<span class="cm">/* printk(&quot;Scsistatus is 0x%02x\n&quot;, ei-&gt;ScsiStatus);  */</span>

	<span class="cm">/* copy the sense data whether we need to or not. */</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">ei</span><span class="o">-&gt;</span><span class="n">SenseInfo</span><span class="p">,</span> 
		<span class="n">ei</span><span class="o">-&gt;</span><span class="n">SenseLen</span> <span class="o">&gt;</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span> <span class="o">?</span>
			<span class="n">SCSI_SENSE_BUFFERSIZE</span> <span class="o">:</span> 
			<span class="n">ei</span><span class="o">-&gt;</span><span class="n">SenseLen</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">ei</span><span class="o">-&gt;</span><span class="n">ResidualCnt</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">CommandStatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> 
	<span class="p">{</span> <span class="cm">/* an error has occurred */</span> 
		<span class="k">switch</span><span class="p">(</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">case</span> <span class="n">CMD_TARGET_STATUS</span>:
				<span class="cm">/* Pass it up to the upper layers... */</span>
				<span class="k">if</span><span class="p">(</span> <span class="n">ei</span><span class="o">-&gt;</span><span class="n">ScsiStatus</span><span class="p">)</span>
                		<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">                    			printk(KERN_WARNING &quot;cciss: cmd %p &quot;</span>
<span class="c">						&quot;has SCSI Status = %x\n&quot;,</span>
<span class="c">						c, ei-&gt;ScsiStatus);</span>
<span class="cp">#endif</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">ScsiStatus</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
                		<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>  <span class="cm">/* scsi status is zero??? How??? */</span>
					
	<span class="cm">/* Ordinarily, this case should never happen, but there is a bug</span>
<span class="cm">	   in some released firmware revisions that allows it to happen</span>
<span class="cm">	   if, for example, a 4100 backplane loses power and the tape</span>
<span class="cm">	   drive is in it.  We assume that it&#39;s a fatal error of some</span>
<span class="cm">	   kind because we can&#39;t show that it wasn&#39;t. We will make it</span>
<span class="cm">	   look like selection timeout since that is the most common</span>
<span class="cm">	   reason for this to occur, and it&#39;s severe enough. */</span>

					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMD_DATA_UNDERRUN</span>: <span class="cm">/* let mid layer handle it. */</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMD_DATA_OVERRUN</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%p has&quot;</span>
					<span class="s">&quot; completed with data overrun &quot;</span>
					<span class="s">&quot;reported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMD_INVALID</span>: <span class="p">{</span>
				<span class="cm">/* print_bytes(c, sizeof(*c), 1, 0);</span>
<span class="cm">				print_cmd(c); */</span>
     <span class="cm">/* We get CMD_INVALID if you address a non-existent tape drive instead</span>
<span class="cm">	of a selection timeout (no response).  You will see this if you yank </span>
<span class="cm">	out a tape drive, then try to access it. This is kind of a shame</span>
<span class="cm">	because it means that any other CMD_INVALID (e.g. driver bug) will</span>
<span class="cm">	get interpreted as a missing target. */</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMD_PROTOCOL_ERR</span>:
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%p has protocol error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMD_HARDWARE_ERR</span>:
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%p had hardware error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMD_CONNECTION_LOST</span>:
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%p had connection lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMD_ABORTED</span>:
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%p was aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMD_ABORT_FAILED</span>:
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%p reports abort failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMD_UNSOLICITED_ABORT</span>:
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%p aborted due to an &quot;</span>
					<span class="s">&quot;unsolicited abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMD_TIMEOUT</span>:
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_TIME_OUT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%p timedout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CMD_UNABORTABLE</span>:
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;c %p command &quot;</span>
					<span class="s">&quot;unabortable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%p returned unknown status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span>
						<span class="n">ei</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">);</span> 
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">scsi_cmd_free</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cciss_scsi_detect</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">sh</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cciss_driver_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ctlr_info</span> <span class="o">*</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">// good enough?  FIXME, </span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">// I don&#39;t think we use these two...</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="n">SELF_SCSI_ID</span><span class="p">;</span>  
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">cciss_tape_cmds</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxsgentries</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">cciss_max_sectors</span><span class="p">;</span>

	<span class="p">((</span><span class="k">struct</span> <span class="n">cciss_scsi_adapter_data_t</span> <span class="o">*</span><span class="p">)</span> 
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">scsi_ctlr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scsi_host</span> <span class="o">=</span> <span class="n">sh</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">h</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">SIMPLE_MODE_INT</span><span class="p">];</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_host_put</span><span class="p">;</span>
	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

 <span class="nl">fail_host_put:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
 <span class="nl">fail:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cciss_unmap_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">buflen</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">data_direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64bit</span> <span class="n">addr64</span><span class="p">;</span>

	<span class="n">addr64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span><span class="p">;</span>
	<span class="n">addr64</span><span class="p">.</span><span class="n">val32</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span><span class="p">;</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="n">addr64</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">data_direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cciss_map_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">buflen</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">data_direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u64</span> <span class="n">addr64</span><span class="p">;</span>

	<span class="n">addr64</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">data_direction</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span>
	  <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="p">(</span><span class="n">addr64</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span> <span class="mh">0x00000000FFFFFFFF</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span>
	  <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="p">((</span><span class="n">addr64</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span> <span class="mh">0x00000000FFFFFFFF</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Len</span> <span class="o">=</span> <span class="n">buflen</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGList</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span>   <span class="cm">/* no. SGs contig in this cmd */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGTotal</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* total sgs in this cmd list */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cciss_scsi_do_simple_cmd</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
			<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scsi3addr</span><span class="p">,</span> 
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cdb</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cdblen</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufsize</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">CMD_IOCTL_PEND</span><span class="p">;</span> <span class="cm">/* treat this like an ioctl */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">ReplyQueue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* unused in simple mode */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">LUN</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">LUN</span><span class="p">));</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">Tag</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">;</span>  <span class="cm">/* Use k. address of cmd as tag */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Fill in the request block...</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* printk(&quot;Using scsi3addr 0x%02x%0x2%0x2%0x2%0x2%0x2%0x2%0x2\n&quot;, </span>
<span class="cm">		scsi3addr[0], scsi3addr[1], scsi3addr[2], scsi3addr[3],</span>
<span class="cm">		scsi3addr[4], scsi3addr[5], scsi3addr[6], scsi3addr[7]); */</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">,</span> <span class="n">cdb</span><span class="p">,</span> <span class="n">cdblen</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDBLen</span> <span class="o">=</span> <span class="n">cdblen</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">TYPE_CMD</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Attribute</span> <span class="o">=</span> <span class="n">ATTR_SIMPLE</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">direction</span><span class="p">;</span>

	<span class="cm">/* Fill in the SG list and do dma mapping */</span>
	<span class="n">cciss_map_one</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span>
			<span class="n">bufsize</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span> 

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">;</span>
	<span class="n">enqueue_cmd_and_start_io</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="cm">/* undo the dma mapping */</span>
	<span class="n">cciss_unmap_one</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">cciss_scsi_interpret_error</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ErrorInfo_struct</span> <span class="o">*</span><span class="n">ei</span><span class="p">;</span>

	<span class="n">ei</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">CMD_TARGET_STATUS</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;cmd %p has completed with errors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;cmd %p has SCSI Status = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">c</span><span class="p">,</span> <span class="n">ei</span><span class="o">-&gt;</span><span class="n">ScsiStatus</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">ScsiStatus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;SCSI status is abnormally zero.  &quot;</span>
				<span class="s">&quot;(probably indicates selection timeout &quot;</span>
				<span class="s">&quot;reported incorrectly due to a known &quot;</span>
				<span class="s">&quot;firmware bug, circa July, 2001.)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMD_DATA_UNDERRUN</span>: <span class="cm">/* let mid layer handle it. */</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;UNDERRUN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMD_DATA_OVERRUN</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%p has&quot;</span>
				<span class="s">&quot; completed with data overrun &quot;</span>
				<span class="s">&quot;reported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMD_INVALID</span>: <span class="p">{</span>
			<span class="cm">/* controller unfortunately reports SCSI passthru&#39;s */</span>
			<span class="cm">/* to non-existent targets as invalid commands. */</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%p is reported invalid (probably means &quot;</span>
				<span class="s">&quot;target device no longer present)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="cm">/* print_bytes((unsigned char *) c, sizeof(*c), 1, 0);</span>
<span class="cm">			print_cmd(c);  */</span>
			<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMD_PROTOCOL_ERR</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%p has protocol error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMD_HARDWARE_ERR</span>:
			<span class="cm">/* cmd-&gt;result = DID_ERROR &lt;&lt; 16; */</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%p had hardware error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMD_CONNECTION_LOST</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%p had connection lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMD_ABORTED</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%p was aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMD_ABORT_FAILED</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%p reports abort failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMD_UNSOLICITED_ABORT</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%p aborted due to an unsolicited abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMD_TIMEOUT</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%p timedout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CMD_UNABORTABLE</span>:
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%p unabortable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%p returned unknown status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">c</span><span class="p">,</span> <span class="n">ei</span><span class="o">-&gt;</span><span class="n">CommandStatus</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cciss_scsi_do_inquiry</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scsi3addr</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">page</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bufsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">ErrorInfo_struct</span> <span class="o">*</span><span class="n">ei</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">scsi_cmd_alloc</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* trouble... */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cmd_alloc returned NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ei</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="p">;</span>

	<span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CISS_INQUIRY</span><span class="p">;</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">bufsize</span><span class="p">;</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cciss_scsi_do_simple_cmd</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span> <span class="n">cdb</span><span class="p">,</span>
				<span class="mi">6</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span> <span class="n">XFER_READ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span> <span class="cm">/* something went wrong */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">CommandStatus</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> 
	    <span class="n">ei</span><span class="o">-&gt;</span><span class="n">CommandStatus</span> <span class="o">!=</span> <span class="n">CMD_DATA_UNDERRUN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cciss_scsi_interpret_error</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">scsi_cmd_free</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>	
<span class="p">}</span>

<span class="cm">/* Get the device id from inquiry page 0x83 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_scsi_get_device_id</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scsi3addr</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">device_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">buflen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">cciss_scsi_do_inquiry</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">device_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cciss_scsi_do_report_phys_luns</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
		<span class="n">ReportLunData_struct</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsi3addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> 
	<span class="n">ErrorInfo_struct</span> <span class="o">*</span><span class="n">ei</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">scsi_cmd_alloc</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* trouble... */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cmd_alloc returned NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scsi3addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span> <span class="cm">/* address the controller */</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CISS_REPORT_PHYS</span><span class="p">;</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bufsize</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>  <span class="c1">//MSB</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bufsize</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bufsize</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">bufsize</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">cciss_scsi_do_simple_cmd</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span>
				<span class="n">cdb</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> 
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span> 
				<span class="n">bufsize</span><span class="p">,</span> <span class="n">XFER_READ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span> <span class="cm">/* something went wrong */</span>

	<span class="n">ei</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">CommandStatus</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> 
	    <span class="n">ei</span><span class="o">-&gt;</span><span class="n">CommandStatus</span> <span class="o">!=</span> <span class="n">CMD_DATA_UNDERRUN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cciss_scsi_interpret_error</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">scsi_cmd_free</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>	
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cciss_update_non_disk_devices</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hostno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* the idea here is we could get notified from /proc</span>
<span class="cm">	   that some devices have changed, so we do a report </span>
<span class="cm">	   physical luns cmd, and adjust our list of devices </span>
<span class="cm">	   accordingly.  (We can&#39;t rely on the scsi-mid layer just</span>
<span class="cm">	   doing inquiries, because the &quot;busses&quot; that the scsi </span>
<span class="cm">	   mid-layer probes are totally fabricated by this driver,</span>
<span class="cm">	   so new devices wouldn&#39;t show up.</span>

<span class="cm">	   the scsi3addr&#39;s of devices won&#39;t change so long as the </span>
<span class="cm">	   adapter is not reset.  That means we can rescan and </span>
<span class="cm">	   tell which devices we already know about, vs. new </span>
<span class="cm">	   devices, vs.  disappearing devices.</span>

<span class="cm">	   Also, if you yank out a tape drive, then put in a disk</span>
<span class="cm">	   in it&#39;s place, (say, a configured volume from another </span>
<span class="cm">	   array controller for instance)  _don&#39;t_ poke this driver </span>
<span class="cm">           (so it thinks it&#39;s still a tape, but _do_ poke the scsi </span>
<span class="cm">           mid layer, so it does an inquiry... the scsi mid layer </span>
<span class="cm">           will see the physical disk.  This would be bad.  Need to</span>
<span class="cm">	   think about how to prevent that.  One idea would be to </span>
<span class="cm">	   snoop all scsi responses and if an inquiry repsonse comes</span>
<span class="cm">	   back that reports a disk, chuck it an return selection</span>
<span class="cm">	   timeout instead and adjust our table...  Not sure i like</span>
<span class="cm">	   that though.  </span>

<span class="cm">	 */</span>
<span class="cp">#define OBDR_TAPE_INQ_SIZE 49</span>
<span class="cp">#define OBDR_TAPE_SIG &quot;$DR-10&quot;</span>
	<span class="n">ReportLunData_struct</span> <span class="o">*</span><span class="n">ld_buff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">inq_buff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsi3addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">__u32</span> <span class="n">num_luns</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_dev_t</span> <span class="o">*</span><span class="n">currentsd</span><span class="p">,</span> <span class="o">*</span><span class="n">this_device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ncurrent</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reportlunsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ld_buff</span><span class="p">)</span> <span class="o">+</span> <span class="n">CISS_MAX_PHYS_LUN</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ld_buff</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">reportlunsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">inq_buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">OBDR_TAPE_INQ_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">currentsd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">currentsd</span><span class="p">)</span> <span class="o">*</span>
			<span class="p">(</span><span class="n">CCISS_MAX_SCSI_DEVS_PER_HBA</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ld_buff</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">inq_buff</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">currentsd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cciss: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">this_device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">currentsd</span><span class="p">[</span><span class="n">CCISS_MAX_SCSI_DEVS_PER_HBA</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cciss_scsi_do_report_phys_luns</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">ld_buff</span><span class="p">,</span> <span class="n">reportlunsize</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ld_buff</span><span class="o">-&gt;</span><span class="n">LUNListLength</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">num_luns</span> <span class="o">=</span> <span class="p">((</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ch</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_luns</span> <span class="o">&gt;</span> <span class="n">CISS_MAX_PHYS_LUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
				<span class="s">&quot;cciss: Maximum physical LUNs (%d) exceeded.  &quot;</span>
				<span class="s">&quot;%d LUNs ignored.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CISS_MAX_PHYS_LUN</span><span class="p">,</span> 
				<span class="n">num_luns</span> <span class="o">-</span> <span class="n">CISS_MAX_PHYS_LUN</span><span class="p">);</span>
			<span class="n">num_luns</span> <span class="o">=</span> <span class="n">CISS_MAX_PHYS_LUN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>  <span class="s">&quot;cciss: Report physical LUNs failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* adjust our table of devices */</span>	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_luns</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for each physical lun, do an inquiry */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ld_buff</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">inq_buff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OBDR_TAPE_INQ_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scsi3addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ld_buff</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cciss_scsi_do_inquiry</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inq_buff</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">OBDR_TAPE_INQ_SIZE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* Inquiry failed (msg printed already) */</span>
			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* so we will skip this device. */</span>

		<span class="n">this_device</span><span class="o">-&gt;</span><span class="n">devtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">inq_buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">this_device</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">this_device</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">this_device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">this_device</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">this_device</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inq_buff</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">this_device</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">this_device</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inq_buff</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">this_device</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">this_device</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inq_buff</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">this_device</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">this_device</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">this_device</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">));</span>
		<span class="n">cciss_scsi_get_device_id</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">,</span>
			<span class="n">this_device</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">this_device</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">));</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">this_device</span><span class="o">-&gt;</span><span class="n">devtype</span><span class="p">)</span>
		<span class="p">{</span>
		  <span class="k">case</span> <span class="mh">0x05</span>: <span class="cm">/* CD-ROM */</span> <span class="p">{</span>

			<span class="cm">/* We don&#39;t *really* support actual CD-ROM devices,</span>
<span class="cm">			 * just this &quot;One Button Disaster Recovery&quot; tape drive</span>
<span class="cm">			 * which temporarily pretends to be a CD-ROM drive.</span>
<span class="cm">			 * So we check that the device is really an OBDR tape</span>
<span class="cm">			 * device by checking for &quot;$DR-10&quot; in bytes 43-48 of</span>
<span class="cm">			 * the inquiry data.</span>
<span class="cm">			 */</span>
				<span class="kt">char</span> <span class="n">obdr_sig</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

				<span class="n">strncpy</span><span class="p">(</span><span class="n">obdr_sig</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inq_buff</span><span class="p">[</span><span class="mi">43</span><span class="p">],</span> <span class="mi">6</span><span class="p">);</span>
				<span class="n">obdr_sig</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">obdr_sig</span><span class="p">,</span> <span class="n">OBDR_TAPE_SIG</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="cm">/* Not OBDR device, ignore it. */</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* fall through . . . */</span>
		  <span class="k">case</span> <span class="mh">0x01</span>: <span class="cm">/* sequential access, (tape) */</span>
		  <span class="k">case</span> <span class="mh">0x08</span>: <span class="cm">/* medium changer */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ncurrent</span> <span class="o">&gt;=</span> <span class="n">CCISS_MAX_SCSI_DEVS_PER_HBA</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cciss%d: %s ignored, &quot;</span>
					<span class="s">&quot;too many devices.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">,</span>
					<span class="n">scsi_device_type</span><span class="p">(</span><span class="n">this_device</span><span class="o">-&gt;</span><span class="n">devtype</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">currentsd</span><span class="p">[</span><span class="n">ncurrent</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">this_device</span><span class="p">;</span>
			<span class="n">ncurrent</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		  <span class="nl">default:</span> 
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">adjust_cciss_scsi_table</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">hostno</span><span class="p">,</span> <span class="n">currentsd</span><span class="p">,</span> <span class="n">ncurrent</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">inq_buff</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ld_buff</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">currentsd</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">is_keyword</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">verb</span><span class="p">)</span>  <span class="c1">// Thanks to ncr53c8xx.c</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">verb_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">verb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">verb_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span><span class="n">ptr</span><span class="p">,</span><span class="n">verb_len</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">verb_len</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cciss_scsi_user_command</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hostno</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">arg_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">arg_len</span> <span class="o">=</span> <span class="n">is_keyword</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="s">&quot;rescan&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cciss_update_non_disk_devices</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">hostno</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cciss_scsi_proc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="cm">/* data buffer */</span>
		<span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> 	   <span class="cm">/* where data in buffer starts */</span>
		<span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span>	   <span class="cm">/* offset from start of imaginary file */</span>
		<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> 	   <span class="cm">/* length of data in buffer */</span>
		<span class="kt">int</span> <span class="n">func</span><span class="p">)</span>	   <span class="cm">/* 0 == read, 1 == write */</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">datalen</span><span class="p">;</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>  <span class="cm">/* This really shouldn&#39;t ever happen. */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* User is reading from /proc/scsi/ciss*?/?*  */</span>
		<span class="n">buflen</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;cciss%d: SCSI host: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>

		<span class="cm">/* this information is needed by apps to know which cciss</span>
<span class="cm">		   device corresponds to which scsi host number without</span>
<span class="cm">		   having to open a scsi target device node.  The device</span>
<span class="cm">		   information is not a duplicate of /proc/scsi/scsi because</span>
<span class="cm">		   the two may be out of sync due to scsi hotplug, rather</span>
<span class="cm">		   this info is for an app to be able to use to know how to</span>
<span class="cm">		   get them back in sync. */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">ndevices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">cciss_scsi_dev_t</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">buflen</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">buflen</span><span class="p">],</span> <span class="s">&quot;c%db%dt%dl%d %02d &quot;</span>
				<span class="s">&quot;0x%02x%02x%02x%02x%02x%02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sh</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
				<span class="n">sd</span><span class="o">-&gt;</span><span class="n">devtype</span><span class="p">,</span>
				<span class="n">sd</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				<span class="n">sd</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
				<span class="n">sd</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
				<span class="n">sd</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">scsi3addr</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">datalen</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">datalen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> 	<span class="cm">/* they&#39;re reading past EOF. */</span>
			<span class="n">datalen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">+</span><span class="n">buflen</span><span class="p">;</span>	
		<span class="p">}</span> <span class="k">else</span>
			<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="k">return</span><span class="p">(</span><span class="n">datalen</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> 	<span class="cm">/* User is writing to /proc/scsi/cciss*?/?*  ... */</span>
		<span class="k">return</span> <span class="n">cciss_scsi_user_command</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
			<span class="n">buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>	
<span class="p">}</span> 

<span class="cm">/* cciss_scatter_gather takes a struct scsi_cmnd, (cmd), and does the pci </span>
<span class="cm">   dma mapping  and fills in the scatter gather entries of the </span>
<span class="cm">   cciss command, c. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cciss_scatter_gather</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">addr64</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">request_nsgs</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">chained</span><span class="p">,</span> <span class="n">sg_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_adapter_data_t</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">scsi_ctlr</span><span class="p">;</span>
	<span class="n">SGDescriptor_struct</span> <span class="o">*</span><span class="n">curr_sg</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxsgentries</span><span class="p">);</span>

	<span class="n">chained</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">curr_sg</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">SG</span><span class="p">;</span>
	<span class="n">request_nsgs</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_nsgs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">request_nsgs</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sg_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_cmd_sgentries</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">chained</span> <span class="o">&amp;&amp;</span> <span class="n">request_nsgs</span> <span class="o">-</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chained</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">sg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">curr_sg</span> <span class="o">=</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">cmd_sg_list</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cmdindex</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="n">addr64</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">len</span>  <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">curr_sg</span><span class="p">[</span><span class="n">sg_index</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="p">(</span><span class="n">addr64</span> <span class="o">&amp;</span> <span class="mh">0x0FFFFFFFFULL</span><span class="p">);</span>
			<span class="n">curr_sg</span><span class="p">[</span><span class="n">sg_index</span><span class="p">].</span><span class="n">Addr</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="p">((</span><span class="n">addr64</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0FFFFFFFFULL</span><span class="p">);</span>
			<span class="n">curr_sg</span><span class="p">[</span><span class="n">sg_index</span><span class="p">].</span><span class="n">Len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">curr_sg</span><span class="p">[</span><span class="n">sg_index</span><span class="p">].</span><span class="n">Ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">++</span><span class="n">sg_index</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chained</span><span class="p">)</span>
			<span class="n">cciss_map_sg_chain_block</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span>
				<span class="n">sa</span><span class="o">-&gt;</span><span class="n">cmd_sg_list</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cmdindex</span><span class="p">],</span>
				<span class="p">(</span><span class="n">request_nsgs</span> <span class="o">-</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">max_cmd_sgentries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">SGDescriptor_struct</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* track how many SG entries we are using */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_nsgs</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">maxSG</span><span class="p">)</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">maxSG</span> <span class="o">=</span> <span class="n">request_nsgs</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGTotal</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">request_nsgs</span> <span class="o">+</span> <span class="n">chained</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_nsgs</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_cmd_sgentries</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGList</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">max_cmd_sgentries</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGList</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">SGTotal</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cciss_scsi_queue_command_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsi3addr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Get the ptr to our adapter structure (hba[i]) out of cmd->host.
We violate cmd->host privacy here.  (Is there another way?)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">lookup_scsi3addr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">scsi3addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* the scsi nexus does not match any that we presented... */</span>
		<span class="cm">/* pretend to mid layer that we got selection timeout */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="cm">/* we might want to think about registering controller itself</span>
<span class="cm">		   as a processor device on the bus so sg binds to it. */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ok, we have a reasonable scsi nexus, so send the cmd down, and</span>
<span class="cm">           see what the device thinks of it. */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">scsi_cmd_alloc</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* trouble... */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;scsi_cmd_alloc returned NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* FIXME: next 3 lines are -&gt; BAD! &lt;- */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Fill in the command list header</p></td><td class="code"><div class="highlight"><pre>	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>    <span class="c1">// save this for use by completion code </span>

	<span class="cm">/* save c in case we have to abort it */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">CMD_SCSI</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">scsi_cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">ReplyQueue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* unused in simple mode */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">LUN</span><span class="p">.</span><span class="n">LunAddrBytes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">scsi3addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">Tag</span><span class="p">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">;</span>  <span class="cm">/* Use k. address of cmd as tag */</span>
	</pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Fill in the request block...</p></td><td class="code"><div class="highlight"><pre>	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">));</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDBLen</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">CDB</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">TYPE_CMD</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Attribute</span> <span class="o">=</span> <span class="n">ATTR_SIMPLE</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="k">case</span> <span class="n">DMA_TO_DEVICE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">XFER_WRITE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	  <span class="k">case</span> <span class="n">DMA_FROM_DEVICE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">XFER_READ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	  <span class="k">case</span> <span class="n">DMA_NONE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">XFER_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	  <span class="k">case</span> <span class="n">DMA_BIDIRECTIONAL</span>:</pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>This can happen if a buggy application does a scsi passthru
and sets both inlen and outlen to non-zero. ( see
../scsi/scsi<em>ioctl.c:scsi</em>ioctl<em>send</em>command() )</p></td><td class="code"><div class="highlight"><pre>		<span class="n">c</span><span class="o">-&gt;</span><span class="n">Request</span><span class="p">.</span><span class="n">Type</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">XFER_RSVD</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>This is technically wrong, and cciss controllers should
reject it with CMD_INVALID, which is the most correct 
response, but non-fibre backends appear to let it 
slide by, and give the same results as if this field
were set correctly.  Either way is acceptable for
our purposes here.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">break</span><span class="p">;</span>

	  <span class="nl">default:</span> 
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown data direction: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cciss_scatter_gather</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">enqueue_cmd_and_start_io</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="cm">/* the cmd&#39;ll come back via intr handler in complete_scsi_command()  */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">cciss_scsi_queue_command</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cciss_unregister_scsi</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_adapter_data_t</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_t</span> <span class="o">*</span><span class="n">stk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* we are being forcibly unloaded, and may not refuse. */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sa</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">scsi_ctlr</span><span class="p">;</span>
	<span class="n">stk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">cmd_stack</span><span class="p">;</span> 

	<span class="cm">/* if we weren&#39;t ever actually registered, don&#39;t unregister */</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">);</span>
		<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set scsi_host to NULL so our detect routine will </span>
<span class="cm">	   find us on register */</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">scsi_host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">scsi_cmd_stack_free</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_engage_scsi</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_adapter_data_t</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cciss_scsi_cmd_stack_t</span> <span class="o">*</span><span class="n">stk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sa</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">scsi_ctlr</span><span class="p">;</span>
	<span class="n">stk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">cmd_stack</span><span class="p">;</span> 

	<span class="k">if</span> <span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SCSI subsystem already engaged.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sa</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cciss_update_non_disk_devices</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">cciss_scsi_detect</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cciss_seq_tape_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">CPQ_TAPE_LOCK</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
		<span class="s">&quot;Sequential access devices: %d</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ccissscsi</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ctlr</span><span class="p">].</span><span class="n">ndevices</span><span class="p">);</span>
	<span class="n">CPQ_TAPE_UNLOCK</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_for_device_to_become_ready</span><span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lunaddr</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">waittime</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">cmd_alloc</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory in &quot;</span>
			<span class="s">&quot;wait_for_device_to_become_ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IO_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send test unit ready until device ready, or give up. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Wait for a bit.  do this first, because if we send</span>
<span class="cm">		 * the TUR right away, the reset will just abort it.</span>
<span class="cm">		 */</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">waittime</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Increase wait time with each try, up to a point. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">waittime</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">30</span><span class="p">))</span>
			<span class="n">waittime</span> <span class="o">=</span> <span class="n">waittime</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/* Send the Test Unit Ready */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fill_cmd</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">TEST_UNIT_READY</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">lunaddr</span><span class="p">,</span> <span class="n">TYPE_CMD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">sendcmd_withirq_core</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">process_sendcmd_error</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">retry_tur</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">CMD_SUCCESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">CommandStatus</span> <span class="o">==</span> <span class="n">CMD_TARGET_STATUS</span> <span class="o">&amp;&amp;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">ScsiStatus</span> <span class="o">==</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">SenseInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">NO_SENSE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">SenseInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">UNIT_ATTENTION</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">asc</span><span class="p">;</span>
				<span class="n">asc</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">err_info</span><span class="o">-&gt;</span><span class="n">SenseInfo</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
				<span class="n">check_for_unit_attention</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">asc</span> <span class="o">==</span> <span class="n">POWER_OR_RESET</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="nl">retry_tur:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Waiting %d secs &quot;</span>
			<span class="s">&quot;for device to become ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">waittime</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* device not ready. */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;giving up on device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;device is ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cmd_free</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Need at least one of these error handlers to keep ../scsi/hosts.c from </span>
<span class="cm"> * complaining.  Doing a host- or bus-reset can&#39;t do anything good here. </span>
<span class="cm"> * Despite what it might say in scsi_error.c, there may well be commands</span>
<span class="cm"> * on the controller, as the cciss driver registers twice, once as a block</span>
<span class="cm"> * device for the logical drives, and once as a scsi device, for any tape</span>
<span class="cm"> * drives.  So we know there are no commands out on the tape drives, but we</span>
<span class="cm"> * don&#39;t know there are no commands on the controller, and it is likely </span>
<span class="cm"> * that there probably are, as the cciss block device is most commonly used</span>
<span class="cm"> * as a boot device (embedded controller on HP/Compaq systems.)</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cciss_eh_device_reset_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">cmd_in_trouble</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lunaddr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>

	<span class="cm">/* find the controller to which the command to be aborted was sent */</span>
	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="cm">/* paranoia */</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resetting tape drive or medium changer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* find the command that&#39;s giving us trouble */</span>
	<span class="n">cmd_in_trouble</span> <span class="o">=</span> <span class="p">(</span><span class="n">CommandList_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_in_trouble</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="cm">/* paranoia */</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">lunaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd_in_trouble</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">LUN</span><span class="p">.</span><span class="n">LunAddrBytes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* send a reset to the SCSI LUN which the command was sent to */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sendcmd_withirq</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CCISS_RESET_MSG</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lunaddr</span><span class="p">,</span>
		<span class="n">TYPE_MSG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">wait_for_device_to_become_ready</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">lunaddr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resetting device failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="nf">cciss_eh_abort_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scsicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">CommandList_struct</span> <span class="o">*</span><span class="n">cmd_to_abort</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lunaddr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">ctlr_info_t</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>

	<span class="cm">/* find the controller to which the command to be aborted was sent */</span>
	<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctlr_info_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="cm">/* paranoia */</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;aborting tardy SCSI cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* find the command to be aborted */</span>
	<span class="n">cmd_to_abort</span> <span class="o">=</span> <span class="p">(</span><span class="n">CommandList_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_to_abort</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="cm">/* paranoia */</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">lunaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd_to_abort</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">LUN</span><span class="p">.</span><span class="n">LunAddrBytes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sendcmd_withirq</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">CCISS_ABORT_MSG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd_to_abort</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">Tag</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lunaddr</span><span class="p">,</span> <span class="n">TYPE_MSG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>

<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* no CONFIG_CISS_SCSI_TAPE */</span><span class="cp"></span>

<span class="cm">/* If no tape support, then these become defined out of existence */</span>

<span class="cp">#define cciss_scsi_setup(cntl_num)</span>
<span class="cp">#define cciss_engage_scsi(h)</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_CISS_SCSI_TAPE */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
