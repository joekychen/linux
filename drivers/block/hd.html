<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › block › hd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>hd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 1991, 1992  Linus Torvalds</span>
<span class="cm"> *</span>
<span class="cm"> * This is the low-level hd interrupt support. It traverses the</span>
<span class="cm"> * request-list, using interrupts to jump between functions. As</span>
<span class="cm"> * all the functions are called within interrupts, we may not</span>
<span class="cm"> * sleep. Special care is recommended.</span>
<span class="cm"> *</span>
<span class="cm"> *  modified by Drew Eckhardt to check nr of hd&#39;s from the CMOS.</span>
<span class="cm"> *</span>
<span class="cm"> *  Thanks to Branko Lankester, lankeste@fwi.uva.nl, who found a bug</span>
<span class="cm"> *  in the early extended-partition checks and added DM partitions</span>
<span class="cm"> *</span>
<span class="cm"> *  IRQ-unmask, drive-id, multiple-mode, support for &quot;&gt;16 heads&quot;,</span>
<span class="cm"> *  and general streamlining by Mark Lord.</span>
<span class="cm"> *</span>
<span class="cm"> *  Removed 99% of above. Use Mark&#39;s ide driver for those options.</span>
<span class="cm"> *  This is now a lightweight ST-506 driver. (Paul Gortmaker)</span>
<span class="cm"> *</span>
<span class="cm"> *  Modified 1995 Russell King for ARM processor.</span>
<span class="cm"> *</span>
<span class="cm"> *  Bugfix: max_sectors must be &lt;= 255 or the wheels tend to come</span>
<span class="cm"> *  off in a hurry once you queue things up - Paul G. 02/2001</span>
<span class="cm"> */</span>

<span class="cm">/* Uncomment the following if you want verbose error reports. */</span>
<span class="cm">/* #define VERBOSE_ERRORS */</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/genhd.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/blkpg.h&gt;</span>
<span class="cp">#include &lt;linux/ata.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>

<span class="cp">#define HD_IRQ 14</span>

<span class="cp">#define REALLY_SLOW_IO</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#ifdef __arm__</span>
<span class="cp">#undef  HD_IRQ</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#ifdef __arm__</span>
<span class="cp">#define HD_IRQ IRQ_HARDDISK</span>
<span class="cp">#endif</span>

<span class="cm">/* Hd controller regster ports */</span>

<span class="cp">#define HD_DATA		0x1f0		</span><span class="cm">/* _CTL when writing */</span><span class="cp"></span>
<span class="cp">#define HD_ERROR	0x1f1		</span><span class="cm">/* see err-bits */</span><span class="cp"></span>
<span class="cp">#define HD_NSECTOR	0x1f2		</span><span class="cm">/* nr of sectors to read/write */</span><span class="cp"></span>
<span class="cp">#define HD_SECTOR	0x1f3		</span><span class="cm">/* starting sector */</span><span class="cp"></span>
<span class="cp">#define HD_LCYL		0x1f4		</span><span class="cm">/* starting cylinder */</span><span class="cp"></span>
<span class="cp">#define HD_HCYL		0x1f5		</span><span class="cm">/* high byte of starting cyl */</span><span class="cp"></span>
<span class="cp">#define HD_CURRENT	0x1f6		</span><span class="cm">/* 101dhhhh , d=drive, hhhh=head */</span><span class="cp"></span>
<span class="cp">#define HD_STATUS	0x1f7		</span><span class="cm">/* see status-bits */</span><span class="cp"></span>
<span class="cp">#define HD_FEATURE	HD_ERROR	</span><span class="cm">/* same io address, read=error, write=feature */</span><span class="cp"></span>
<span class="cp">#define HD_PRECOMP	HD_FEATURE	</span><span class="cm">/* obsolete use of this port - predates IDE */</span><span class="cp"></span>
<span class="cp">#define HD_COMMAND	HD_STATUS	</span><span class="cm">/* same io address, read=status, write=cmd */</span><span class="cp"></span>

<span class="cp">#define HD_CMD		0x3f6		</span><span class="cm">/* used for resets */</span><span class="cp"></span>
<span class="cp">#define HD_ALTSTATUS	0x3f6		</span><span class="cm">/* same as HD_STATUS but doesn&#39;t clear irq */</span><span class="cp"></span>

<span class="cm">/* Bits of HD_STATUS */</span>
<span class="cp">#define ERR_STAT		0x01</span>
<span class="cp">#define INDEX_STAT		0x02</span>
<span class="cp">#define ECC_STAT		0x04	</span><span class="cm">/* Corrected error */</span><span class="cp"></span>
<span class="cp">#define DRQ_STAT		0x08</span>
<span class="cp">#define SEEK_STAT		0x10</span>
<span class="cp">#define SERVICE_STAT		SEEK_STAT</span>
<span class="cp">#define WRERR_STAT		0x20</span>
<span class="cp">#define READY_STAT		0x40</span>
<span class="cp">#define BUSY_STAT		0x80</span>

<span class="cm">/* Bits for HD_ERROR */</span>
<span class="cp">#define MARK_ERR		0x01	</span><span class="cm">/* Bad address mark */</span><span class="cp"></span>
<span class="cp">#define TRK0_ERR		0x02	</span><span class="cm">/* couldn&#39;t find track 0 */</span><span class="cp"></span>
<span class="cp">#define ABRT_ERR		0x04	</span><span class="cm">/* Command aborted */</span><span class="cp"></span>
<span class="cp">#define MCR_ERR			0x08	</span><span class="cm">/* media change request */</span><span class="cp"></span>
<span class="cp">#define ID_ERR			0x10	</span><span class="cm">/* ID field not found */</span><span class="cp"></span>
<span class="cp">#define MC_ERR			0x20	</span><span class="cm">/* media changed */</span><span class="cp"></span>
<span class="cp">#define ECC_ERR			0x40	</span><span class="cm">/* Uncorrectable ECC error */</span><span class="cp"></span>
<span class="cp">#define BBD_ERR			0x80	</span><span class="cm">/* pre-EIDE meaning:  block marked bad */</span><span class="cp"></span>
<span class="cp">#define ICRC_ERR		0x80	</span><span class="cm">/* new meaning:  CRC error during transfer */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">hd_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">hd_queue</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">hd_req</span><span class="p">;</span>

<span class="cp">#define TIMEOUT_VALUE	(6*HZ)</span>
<span class="cp">#define	HD_DELAY	0</span>

<span class="cp">#define MAX_ERRORS     16	</span><span class="cm">/* Max read/write errors/sector */</span><span class="cp"></span>
<span class="cp">#define RESET_FREQ      8	</span><span class="cm">/* Reset controller every 8th retry */</span><span class="cp"></span>
<span class="cp">#define RECAL_FREQ      4	</span><span class="cm">/* Recalibrate every 4th retry */</span><span class="cp"></span>
<span class="cp">#define MAX_HD		2</span>

<span class="cp">#define STAT_OK		(READY_STAT|SEEK_STAT)</span>
<span class="cp">#define OK_STATUS(s)	(((s)&amp;(STAT_OK|(BUSY_STAT|WRERR_STAT|ERR_STAT)))==STAT_OK)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">recal_intr</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bad_rw_intr</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">reset</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hd_error</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> *  This struct defines the HD&#39;s and their types.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">hd_i_struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span> <span class="n">sect</span><span class="p">,</span> <span class="n">cyl</span><span class="p">,</span> <span class="n">wpcom</span><span class="p">,</span> <span class="n">lzone</span><span class="p">,</span> <span class="n">ctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recalibrate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">special_op</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#ifdef HD_TYPE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hd_i_struct</span> <span class="n">hd_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">HD_TYPE</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">NR_HD</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hd_info</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hd_i_struct</span> <span class="n">hd_info</span><span class="p">[</span><span class="n">MAX_HD</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">NR_HD</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">hd_gendisk</span><span class="p">[</span><span class="n">MAX_HD</span><span class="p">];</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">device_timer</span><span class="p">;</span>

<span class="cp">#define TIMEOUT_VALUE (6*HZ)</span>

<span class="cp">#define SET_TIMER							\</span>
<span class="cp">	do {								\</span>
<span class="cp">		mod_timer(&amp;device_timer, jiffies + TIMEOUT_VALUE);	\</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">do_hd</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#define SET_HANDLER(x) \</span>
<span class="cp">if ((do_hd = (x)) != NULL) \</span>
<span class="cp">	SET_TIMER; \</span>
<span class="cp">else \</span>
<span class="cp">	del_timer(&amp;device_timer);</span>


<span class="cp">#if (HD_DELAY &gt; 0)</span>

<span class="cp">#include &lt;linux/i8253.h&gt;</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_req</span><span class="p">;</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">read_timer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i8253_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">*</span> <span class="mi">11932</span><span class="p">;</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="mh">0x40</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">|=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x40</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i8253_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">hd_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hdind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hd_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">head</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hdind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hd_info</span><span class="p">[</span><span class="n">hdind</span><span class="p">].</span><span class="n">head</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">hd_info</span><span class="p">[</span><span class="n">hdind</span><span class="p">].</span><span class="n">sect</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">hd_info</span><span class="p">[</span><span class="n">hdind</span><span class="p">].</span><span class="n">cyl</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">hd_info</span><span class="p">[</span><span class="n">hdind</span><span class="p">].</span><span class="n">wpcom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hd_info</span><span class="p">[</span><span class="n">hdind</span><span class="p">].</span><span class="n">lzone</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">hd_info</span><span class="p">[</span><span class="n">hdind</span><span class="p">].</span><span class="n">ctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">NR_HD</span> <span class="o">=</span> <span class="n">hdind</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">hd_end_request</span><span class="p">(</span><span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__blk_end_request</span><span class="p">(</span><span class="n">hd_req</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">bytes</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">hd_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">hd_end_request_cur</span><span class="p">(</span><span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hd_end_request</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">blk_rq_cur_bytes</span><span class="p">(</span><span class="n">hd_req</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_status</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hd?&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hd_req</span><span class="p">)</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">hd_req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">;</span>

<span class="cp">#ifdef VERBOSE_ERRORS</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %s: status=0x%02x { &quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">BUSY_STAT</span><span class="p">)</span>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Busy &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">READY_STAT</span><span class="p">)</span>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DriveReady &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">WRERR_STAT</span><span class="p">)</span>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;WriteFault &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SEEK_STAT</span><span class="p">)</span>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SeekComplete &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DRQ_STAT</span><span class="p">)</span>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DataRequest &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ECC_STAT</span><span class="p">)</span>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CorrectedError &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">INDEX_STAT</span><span class="p">)</span>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Index &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ERR_STAT</span><span class="p">)</span>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Error &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ERR_STAT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hd_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hd_error</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">HD_ERROR</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %s: error=0x%02x { &quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">hd_error</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hd_error</span> <span class="o">&amp;</span> <span class="n">BBD_ERR</span><span class="p">)</span>		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;BadSector &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hd_error</span> <span class="o">&amp;</span> <span class="n">ECC_ERR</span><span class="p">)</span>		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;UncorrectableError &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hd_error</span> <span class="o">&amp;</span> <span class="n">ID_ERR</span><span class="p">)</span>		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SectorIdNotFound &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hd_error</span> <span class="o">&amp;</span> <span class="n">ABRT_ERR</span><span class="p">)</span>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DriveStatusError &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hd_error</span> <span class="o">&amp;</span> <span class="n">TRK0_ERR</span><span class="p">)</span>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TrackZeroNotFound &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hd_error</span> <span class="o">&amp;</span> <span class="n">MARK_ERR</span><span class="p">)</span>	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;AddrMarkNotFound &quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;}&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hd_error</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BBD_ERR</span><span class="o">|</span><span class="n">ECC_ERR</span><span class="o">|</span><span class="n">ID_ERR</span><span class="o">|</span><span class="n">MARK_ERR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, CHS=%d/%d/%d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">HD_HCYL</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">inb</span><span class="p">(</span><span class="n">HD_LCYL</span><span class="p">),</span>
				<span class="n">inb</span><span class="p">(</span><span class="n">HD_CURRENT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">HD_SECTOR</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hd_req</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, sector=%ld&quot;</span><span class="p">,</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">hd_req</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %s: status=0x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ERR_STAT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hd_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hd_error</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">HD_ERROR</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %s: error=0x%02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">hd_error</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">HD_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OK_STATUS</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dump_status</span><span class="p">(</span><span class="s">&quot;check_status&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">bad_rw_intr</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">controller_busy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">HD_STATUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BUSY_STAT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">retries</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">status_ok</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">HD_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BUSY_STAT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Ancient, but does it make sense??? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">WRERR_STAT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">READY_STAT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SEEK_STAT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">controller_ready</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">drive</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">controller_busy</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">BUSY_STAT</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">outb_p</span><span class="p">(</span><span class="mh">0xA0</span> <span class="o">|</span> <span class="p">(</span><span class="n">drive</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">head</span><span class="p">,</span> <span class="n">HD_CURRENT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status_ok</span><span class="p">())</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">retry</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hd_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">hd_i_struct</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nsect</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sect</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cyl</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		   <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">intr_addr</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span><span class="p">;</span>

<span class="cp">#if (HD_DELAY &gt; 0)</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">read_timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_req</span> <span class="o">&lt;</span> <span class="n">HD_DELAY</span><span class="p">)</span>
		<span class="cm">/* nothing */</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">controller_ready</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">SET_HANDLER</span><span class="p">(</span><span class="n">intr_addr</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">HD_CMD</span><span class="p">);</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">HD_DATA</span><span class="p">;</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">wpcom</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="o">++</span><span class="n">port</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">nsect</span><span class="p">,</span> <span class="o">++</span><span class="n">port</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">sect</span><span class="p">,</span> <span class="o">++</span><span class="n">port</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">cyl</span><span class="p">,</span> <span class="o">++</span><span class="n">port</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">cyl</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="o">++</span><span class="n">port</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0xA0</span> <span class="o">|</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">head</span><span class="p">,</span> <span class="o">++</span><span class="n">port</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">++</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hd_request</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drive_busy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">500000</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">HD_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BUSY_STAT</span> <span class="o">|</span> <span class="n">READY_STAT</span> <span class="o">|</span> <span class="n">SEEK_STAT</span><span class="p">))</span> <span class="o">==</span> <span class="n">STAT_OK</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dump_status</span><span class="p">(</span><span class="s">&quot;reset timed out&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_controller</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="n">outb_p</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">HD_CMD</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">barrier</span><span class="p">();</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">hd_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">HD_CMD</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">barrier</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drive_busy</span><span class="p">())</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hd: controller still busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">hd_error</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">HD_ERROR</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hd: controller reset failed: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hd_error</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_hd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="nl">repeat:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">reset_controller</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">check_status</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_HD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hd_i_struct</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hd_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">special_op</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">recalibrate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hd_out</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">,</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">,</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">disk</span><span class="o">-&gt;</span><span class="n">cyl</span><span class="p">,</span> <span class="n">ATA_CMD_INIT_DEV_PARAMS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reset_hd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">hd_request</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Ok, don&#39;t know what to do with the unexpected interrupts: on some machines</span>
<span class="cm"> * doing a reset and a retry seems to result in an eternal loop. Right now I</span>
<span class="cm"> * ignore it, and just set the timeout.</span>
<span class="cm"> *</span>
<span class="cm"> * On laptops (and &quot;green&quot; PCs), an unexpected interrupt occurs whenever the</span>
<span class="cm"> * drive enters &quot;idle&quot;, &quot;standby&quot;, or &quot;sleep&quot; mode, so if the status looks</span>
<span class="cm"> * &quot;good&quot;, we just ignore the interrupt completely.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">unexpected_hd_interrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">HD_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BUSY_STAT</span><span class="o">|</span><span class="n">DRQ_STAT</span><span class="o">|</span><span class="n">ECC_STAT</span><span class="o">|</span><span class="n">ERR_STAT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dump_status</span><span class="p">(</span><span class="s">&quot;unexpected interrupt&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="n">SET_TIMER</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bad_rw_intr() now tries to be a bit smarter and does things</span>
<span class="cm"> * according to the error returned by the controller.</span>
<span class="cm"> * -Mika Liljeberg (liljeber@cs.Helsinki.FI)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bad_rw_intr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">hd_req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hd_i_struct</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">&gt;=</span> <span class="n">MAX_ERRORS</span> <span class="o">||</span> <span class="p">(</span><span class="n">hd_error</span> <span class="o">&amp;</span> <span class="n">BBD_ERR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hd_end_request_cur</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="n">disk</span><span class="o">-&gt;</span><span class="n">special_op</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">recalibrate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">%</span> <span class="n">RESET_FREQ</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">hd_error</span> <span class="o">&amp;</span> <span class="n">TRK0_ERR</span><span class="p">)</span> <span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">%</span> <span class="n">RECAL_FREQ</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">disk</span><span class="o">-&gt;</span><span class="n">special_op</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">recalibrate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Otherwise just retry */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wait_DRQ</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retries</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="n">retries</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">HD_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DRQ_STAT</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dump_status</span><span class="p">(</span><span class="s">&quot;wait_DRQ&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_intr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">HD_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">BUSY_STAT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OK_STATUS</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">DRQ_STAT</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ok_to_read</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dump_status</span><span class="p">(</span><span class="s">&quot;read_intr&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">bad_rw_intr</span><span class="p">();</span>
	<span class="n">hd_request</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">ok_to_read:</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">hd_req</span><span class="p">;</span>
	<span class="n">insw</span><span class="p">(</span><span class="n">HD_DATA</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: read: sector %ld, remaining = %u, buffer=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="o">+</span><span class="mi">512</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hd_end_request</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">512</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SET_HANDLER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">read_intr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">HD_STATUS</span><span class="p">);</span>
<span class="cp">#if (HD_DELAY &gt; 0)</span>
	<span class="n">last_req</span> <span class="o">=</span> <span class="n">read_timer</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="n">hd_request</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_intr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">hd_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">HD_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">BUSY_STAT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OK_STATUS</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">DRQ_STAT</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">ok_to_write</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dump_status</span><span class="p">(</span><span class="s">&quot;write_intr&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">bad_rw_intr</span><span class="p">();</span>
	<span class="n">hd_request</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">ok_to_write:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hd_end_request</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">512</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SET_HANDLER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_intr</span><span class="p">);</span>
		<span class="n">outsw</span><span class="p">(</span><span class="n">HD_DATA</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if (HD_DELAY &gt; 0)</span>
	<span class="n">last_req</span> <span class="o">=</span> <span class="n">read_timer</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="n">hd_request</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">recal_intr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">check_status</span><span class="p">();</span>
<span class="cp">#if (HD_DELAY &gt; 0)</span>
	<span class="n">last_req</span> <span class="o">=</span> <span class="n">read_timer</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="n">hd_request</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is another of the error-routines I don&#39;t know what to do with. The</span>
<span class="cm"> * best idea seems to just set reset, and start all over again.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hd_times_out</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">do_hd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hd_req</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="n">hd_queue</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">hd_req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">hd_req</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">&gt;=</span> <span class="n">MAX_ERRORS</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: too many errors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">hd_end_request_cur</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hd_request</span><span class="p">();</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="n">hd_queue</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_special_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">hd_i_struct</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">recalibrate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">recalibrate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hd_out</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATA_CMD_RESTORE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recal_intr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">reset</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: cannot handle device with more than 16 heads - giving up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">);</span>
		<span class="n">hd_end_request_cur</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">disk</span><span class="o">-&gt;</span><span class="n">special_op</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The driver enables interrupts as much as possible.  In order to do this,</span>
<span class="cm"> * (a) the device-interrupt is disabled before entering hd_request(),</span>
<span class="cm"> * and (b) the timeout-interrupt is disabled before the sti().</span>
<span class="cm"> *</span>
<span class="cm"> * Interrupts are still masked (by default) whenever we are exchanging</span>
<span class="cm"> * data/cmds with a drive, because some drives seem to have very poor</span>
<span class="cm"> * tolerance for latency during I/O. The IDE driver has support to unmask</span>
<span class="cm"> * interrupts for non-broken hardware, so use that driver if required.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hd_request</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block</span><span class="p">,</span> <span class="n">nsect</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="n">track</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">cyl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hd_i_struct</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_hd</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="nl">repeat:</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hd_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hd_req</span> <span class="o">=</span> <span class="n">blk_fetch_request</span><span class="p">(</span><span class="n">hd_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hd_req</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">do_hd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">hd_req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_hd</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">disk</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">block</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">nsect</span> <span class="o">=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="o">&gt;=</span> <span class="n">get_capacity</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">block</span><span class="o">+</span><span class="n">nsect</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">get_capacity</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: bad access: block=%d, count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">nsect</span><span class="p">);</span>
		<span class="n">hd_end_request_cur</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">special_op</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_special_op</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sec</span>   <span class="o">=</span> <span class="n">block</span> <span class="o">%</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">track</span> <span class="o">=</span> <span class="n">block</span> <span class="o">/</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">;</span>
	<span class="n">head</span>  <span class="o">=</span> <span class="n">track</span> <span class="o">%</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">cyl</span>   <span class="o">=</span> <span class="n">track</span> <span class="o">/</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %sing: CHS=%d/%d/%d, sectors=%d, buffer=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span>
		<span class="n">req_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span> <span class="o">?</span> <span class="s">&quot;read&quot;</span> <span class="o">:</span> <span class="s">&quot;writ&quot;</span><span class="p">,</span>
		<span class="n">cyl</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="n">nsect</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">READ</span>:
			<span class="n">hd_out</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">nsect</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">cyl</span><span class="p">,</span> <span class="n">ATA_CMD_PIO_READ</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">read_intr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WRITE</span>:
			<span class="n">hd_out</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">nsect</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">cyl</span><span class="p">,</span> <span class="n">ATA_CMD_PIO_WRITE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">write_intr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_DRQ</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">bad_rw_intr</span><span class="p">();</span>
				<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">outsw</span><span class="p">(</span><span class="n">HD_DATA</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;unknown hd-command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">hd_end_request_cur</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_hd_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hd_request</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hd_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hd_i_struct</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">cyl</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Releasing a block device means we sync() it, so that it can safely</span>
<span class="cm"> * be forgotten about...</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">hd_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="n">do_hd</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="n">hd_queue</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>

	<span class="n">do_hd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handler</span><span class="p">)</span>
		<span class="n">handler</span> <span class="o">=</span> <span class="n">unexpected_hd_interrupt</span><span class="p">;</span>
	<span class="n">handler</span><span class="p">();</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">hd_queue</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">hd_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">getgeo</span> <span class="o">=</span>	<span class="n">hd_getgeo</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This is the hard disk IRQ description. The IRQF_DISABLED in sa_flags</span>
<span class="cm"> * means we run the IRQ-handler with interrupts disabled:  this is bad for</span>
<span class="cm"> * interrupt latency, but anything else has led to problems on some</span>
<span class="cm"> * machines.</span>
<span class="cm"> *</span>
<span class="cm"> * We enable interrupts in some of the routines after making sure it&#39;s</span>
<span class="cm"> * safe.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">drive</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_blkdev</span><span class="p">(</span><span class="n">HD_MAJOR</span><span class="p">,</span> <span class="s">&quot;hd&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">hd_queue</span> <span class="o">=</span> <span class="n">blk_init_queue</span><span class="p">(</span><span class="n">do_hd_request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hd_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hd_queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">HD_MAJOR</span><span class="p">,</span> <span class="s">&quot;hd&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">blk_queue_max_hw_sectors</span><span class="p">(</span><span class="n">hd_queue</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_timer</span><span class="p">);</span>
	<span class="n">device_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">hd_times_out</span><span class="p">;</span>
	<span class="n">blk_queue_logical_block_size</span><span class="p">(</span><span class="n">hd_queue</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NR_HD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We don&#39;t know anything about the drive.  This means</span>
<span class="cm">		 * that you *MUST* specify the drive parameters to the</span>
<span class="cm">		 * kernel yourself.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If we were on an i386, we used to read this info from</span>
<span class="cm">		 * the BIOS or CMOS.  This doesn&#39;t work all that well,</span>
<span class="cm">		 * since this assumes that this is a primary or secondary</span>
<span class="cm">		 * drive, and if we&#39;re using this legacy driver, it&#39;s</span>
<span class="cm">		 * probably an auxiliary controller added to recover</span>
<span class="cm">		 * legacy data off an ST-506 drive.  Either way, it&#39;s</span>
<span class="cm">		 * definitely safest to have the user explicitly specify</span>
<span class="cm">		 * the information.</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hd: no drives specified - use hd=cyl,head,sectors&quot;</span>
			<span class="s">&quot; on kernel command line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">drive</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">drive</span> <span class="o">&lt;</span> <span class="n">NR_HD</span> <span class="p">;</span> <span class="n">drive</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">hd_i_struct</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hd_info</span><span class="p">[</span><span class="n">drive</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">Enomem</span><span class="p">;</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">HD_MAJOR</span><span class="p">;</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="n">drive</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hd_fops</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="s">&quot;hd%c&quot;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="o">+</span><span class="n">drive</span><span class="p">);</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">set_capacity</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">*</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sect</span> <span class="o">*</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cyl</span><span class="p">);</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">hd_queue</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="n">drive</span><span class="p">;</span>
		<span class="n">hd_gendisk</span><span class="p">[</span><span class="n">drive</span><span class="p">]</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %luMB, CHS=%d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">get_capacity</span><span class="p">(</span><span class="n">disk</span><span class="p">)</span><span class="o">/</span><span class="mi">2048</span><span class="p">,</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">cyl</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">HD_IRQ</span><span class="p">,</span> <span class="n">hd_interrupt</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="s">&quot;hd&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hd: unable to get IRQ%d for the hard disk driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">HD_IRQ</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">HD_DATA</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;hd&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;hd: port 0x%x busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HD_DATA</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">HD_CMD</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;hd(cmd)&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;hd: port 0x%x busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HD_CMD</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Let them fly */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">drive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">drive</span> <span class="o">&lt;</span> <span class="n">NR_HD</span><span class="p">;</span> <span class="n">drive</span><span class="o">++</span><span class="p">)</span>
		<span class="n">add_disk</span><span class="p">(</span><span class="n">hd_gendisk</span><span class="p">[</span><span class="n">drive</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out3:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">HD_DATA</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="nl">out2:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">HD_IRQ</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">out1:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">drive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">drive</span> <span class="o">&lt;</span> <span class="n">NR_HD</span><span class="p">;</span> <span class="n">drive</span><span class="o">++</span><span class="p">)</span>
		<span class="n">put_disk</span><span class="p">(</span><span class="n">hd_gendisk</span><span class="p">[</span><span class="n">drive</span><span class="p">]);</span>
	<span class="n">NR_HD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_timer</span><span class="p">);</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">HD_MAJOR</span><span class="p">,</span> <span class="s">&quot;hd&quot;</span><span class="p">);</span>
	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">hd_queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="nl">Enomem:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">drive</span><span class="o">--</span><span class="p">)</span>
		<span class="n">put_disk</span><span class="p">(</span><span class="n">hd_gendisk</span><span class="p">[</span><span class="n">drive</span><span class="p">]);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parse_hd_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">get_options</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>
	<span class="n">hd_setup</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ints</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;hd=&quot;</span><span class="p">,</span> <span class="n">parse_hd_setup</span><span class="p">);</span>

<span class="n">late_initcall</span><span class="p">(</span><span class="n">hd_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
